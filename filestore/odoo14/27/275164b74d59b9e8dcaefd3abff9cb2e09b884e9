
/* /base/static/tests/base_settings_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('base.settings_tests',function(require){"use strict";var testUtils=require('web.test_utils');var view_registry=require('web.view_registry');var createView=testUtils.createView;var BaseSettingsView=view_registry.get('base_settings');var createActionManager=testUtils.createActionManager;QUnit.module('base_settings_tests',{beforeEach:function(){this.data={project:{fields:{foo:{string:"Foo",type:"boolean"},bar:{string:"Bar",type:"boolean"},},},};}},function(){QUnit.module('BaseSetting');QUnit.test('change setting on nav bar click in base settings',async function(assert){assert.expect(5);var form=await createView({View:BaseSettingsView,model:'project',data:this.data,arch:'<form string="Settings" class="oe_form_configuration o_base_settings">'+'<div class="o_panel">'+'<div class="setting_search">'+'<input type="text" class="searchInput" placeholder="Search..."/>'+'</div> '+'</div> '+'<header>'+'<button string="Save" type="object" name="execute" class="oe_highlight" />'+'<button string="Cancel" type="object" name="cancel" class="oe_link" />'+'</header>'+'<div class="o_setting_container">'+'<div class="settings_tab"/>'+'<div class="settings">'+'<div class="notFound o_hidden">No Record Found</div>'+'<div class="app_settings_block" string="CRM" data-key="crm">'+'<div class="row mt16 o_settings_container">'+'<div class="col-12 col-lg-6 o_setting_box">'+'<div class="o_setting_left_pane">'+'<field name="bar"/>'+'</div>'+'<div class="o_setting_right_pane">'+'<label for="bar"/>'+'<div class="text-muted">'+'this is bar'+'</div>'+'</div>'+'</div>'+'<div class="col-12 col-lg-6 o_setting_box">'+'<div class="o_setting_left_pane">'+'<field name="foo"/>'+'</div>'+'<div class="o_setting_right_pane">'+'<span class="o_form_label">Foo</span>'+'<div class="text-muted">'+'this is foo'+'</div>'+'</div>'+'</div>'+'</div>'+'</div>'+'</div>'+'</div>'+'</form>',});assert.hasAttrValue(form.$('.selected'),'data-key',"crm","crm setting selected");assert.isVisible(form.$(".settings .app_settings_block"),"project settings show");await testUtils.fields.editAndTrigger(form.$('.searchInput'),'b','keyup');assert.strictEqual(form.$('.highlighter').html(),"B","b word highlighted");await testUtils.fields.editAndTrigger(form.$('.searchInput'),'bx','keyup');assert.isVisible(form.$('.notFound'),"record not found message shown");form.$('.searchInput').val('f').trigger('keyup');assert.strictEqual(form.$('span.o_form_label .highlighter').html(),"F","F word highlighted");form.destroy();});QUnit.test('settings views does not read existing id when coming back in breadcrumbs',async function(assert){assert.expect(8);var actions=[{id:1,name:'Settings view',res_model:'project',type:'ir.actions.act_window',views:[[1,'form']],},{id:4,name:'Other action',res_model:'project',type:'ir.actions.act_window',views:[[2,'list']],}];var archs={'project,1,form':'<form string="Settings" js_class="base_settings">'+'<div class="app_settings_block" string="CRM" data-key="crm">'+'<button name="4" string="Execute action" type="action"/>'+'</div>'+'</form>','project,2,list':'<tree><field name="foo"/></tree>','project,false,search':'<search></search>',};var actionManager=await createActionManager({actions:actions,archs:archs,data:this.data,mockRPC:function(route,args){if(args.method){assert.step(args.method);}
return this._super.apply(this,arguments);},});await actionManager.doAction(1);await testUtils.nextTick();await testUtils.dom.click(actionManager.$('button[name="4"]'));await testUtils.dom.click($('.o_control_panel .breadcrumb-item a'));assert.hasClass(actionManager.$('.o_form_view'),'o_form_editable');assert.verifySteps(['load_views','onchange','create','read','load_views','onchange',]);actionManager.destroy();});QUnit.test('clicking on any button in setting should show discard warning if setting form is dirty',async function(assert){assert.expect(11);var actions=[{id:1,name:'Settings view',res_model:'project',type:'ir.actions.act_window',views:[[1,'form']],},{id:4,name:'Other action',res_model:'project',type:'ir.actions.act_window',views:[[2,'list']],}];var archs={'project,1,form':'<form string="Settings" js_class="base_settings">'+'<header>'+'<button string="Save" type="object" name="execute" class="oe_highlight" />'+'<button string="Cancel" type="object" name="cancel" class="oe_link" />'+'</header>'+'<div class="app_settings_block" string="CRM" data-key="crm">'+'<div class="row mt16 o_settings_container">'+'<div class="col-12 col-lg-6 o_setting_box">'+'<div class="o_setting_left_pane">'+'<field name="foo"/>'+'</div>'+'<div class="o_setting_right_pane">'+'<span class="o_form_label">Foo</span>'+'<div class="text-muted">'+'this is foo'+'</div>'+'</div>'+'</div>'+'</div>'+'<button name="4" string="Execute action" type="action"/>'+'</div>'+'</form>','project,2,list':'<tree><field name="foo"/></tree>','project,false,search':'<search></search>',};var actionManager=await createActionManager({actions:actions,archs:archs,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/call_button'){if(args.method==="execute"){assert.ok("execute method called");return Promise.resolve(true);}
if(args.method==="cancel"){assert.ok("cancel method called");return Promise.resolve(true);}}
return this._super.apply(this,arguments);},});await actionManager.doAction(1);assert.containsNone(actionManager,'.o_field_boolean input:checked',"checkbox should not be checked");await testUtils.dom.click(actionManager.$("input[type='checkbox']"));assert.containsOnce(actionManager,'.o_field_boolean input:checked',"checkbox should be checked");await testUtils.dom.click(actionManager.$('button[name="4"]'));assert.containsOnce(document.body,'.modal',"should open a warning dialog");await testUtils.dom.click($('.modal button:contains(Ok)'));assert.containsOnce(actionManager,'.o_list_view',"should be open list view");await testUtils.dom.click($('.o_control_panel .breadcrumb-item a'));assert.containsNone(actionManager,'.o_field_boolean input:checked',"checkbox should not be checked");await testUtils.dom.click(actionManager.$("input[type='checkbox']"));await testUtils.dom.click(actionManager.$('button[name="4"]'));assert.containsOnce(document.body,'.modal',"should open a warning dialog");await testUtils.dom.click($('.modal button:contains(Cancel)'));assert.containsOnce(actionManager,'.o_form_view',"should be remain on form view");await testUtils.dom.click(actionManager.$("button[name='execute']"));assert.containsNone(document.body,'.modal',"should not open a warning dialog");await testUtils.dom.click(actionManager.$("input[type='checkbox']"));await testUtils.dom.click(actionManager.$("button[name='cancel']"));assert.containsNone(document.body,'.modal',"should not open a warning dialog");actionManager.destroy();});QUnit.test('settings view does not display other settings after reload',async function(assert){assert.expect(2);var form=await createView({View:BaseSettingsView,model:'project',data:this.data,arch:'<form string="Settings" class="oe_form_configuration o_base_settings">'+'<div class="o_panel">'+'<div class="setting_search">'+'<input type="text" class="searchInput" placeholder="Search..."/>'+'</div> '+'</div> '+'<header>'+'<button string="Save" type="object" name="execute" class="oe_highlight" />'+'<button string="Cancel" type="object" name="cancel" class="oe_link" />'+'</header>'+'<div class="o_setting_container">'+'<div class="settings_tab"/>'+'<div class="settings">'+'<div class="notFound o_hidden">No Record Found</div>'+'<div class="app_settings_block" string="CRM" data-key="crm">'+'crm tab'+'</div>'+'<div class="app_settings_block o_not_app" string="Other App" data-key="otherapp">'+'other app tab'+'</div>'+'</div>'+'</div>'+'</form>',});assert.strictEqual(form.$('.app_settings_block').text().replace(/\s/g,''),'CRMcrmtab');await form.reload();assert.strictEqual(form.$('.app_settings_block').text().replace(/\s/g,''),'CRMcrmtab');form.destroy();});QUnit.test('settings view shows a message if there are changes',async function(assert){assert.expect(5);var form=await createView({View:BaseSettingsView,model:'project',data:this.data,arch:'<form string="Settings" class="oe_form_configuration o_base_settings">'+'<header>'+'<button string="Save" type="object" name="execute" class="oe_highlight" />'+'<button string="Discard" type="object" name="cancel" special="cancel" />'+'</header>'+'<div class="o_setting_container">'+'<div class="settings_tab"/>'+'<div class="settings">'+'<div class="notFound o_hidden">No Record Found</div>'+'<div class="app_settings_block" string="Base Setting" data-key="base-setting">'+'<field name="bar"/>Make Changes'+'</div>'+'</div>'+'</div>'+'</form>',});testUtils.mock.intercept(form,"field_changed",function(event){assert.ok(true,"field changed");},true);assert.containsNone(form,'.o_field_boolean input:checked',"checkbox should not be checked");assert.containsNone(form,".o_dirty_warning","warning message should not be shown");await testUtils.dom.click(form.$("input[type='checkbox']"));assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should be checked");assert.containsOnce(form,".o_dirty_warning","warning message should be shown");form.destroy();});QUnit.test('settings view shows a message if there are changes even if the save failed',async function(assert){assert.expect(3);var self=this;self.alreadySavedOnce=false;var form=await createView({View:BaseSettingsView,model:'project',data:this.data,mockRPC:function(route,args){if(args.method==="create"&&!self.alreadySavedOnce){self.alreadySavedOnce=true;return Promise.reject({});}
return this._super.apply(this,arguments);},arch:'<form string="Settings" class="oe_form_configuration o_base_settings">'+'<header>'+'<button string="Save" type="object" name="execute" class="oe_highlight" />'+'<button string="Discard" type="object" name="cancel" special="cancel" />'+'</header>'+'<div class="o_setting_container">'+'<div class="settings_tab"/>'+'<div class="settings">'+'<div class="notFound o_hidden">No Record Found</div>'+'<div class="app_settings_block" string="Base Setting" data-key="base-setting">'+'<field name="bar"/>Make Changes'+'</div>'+'</div>'+'</div>'+'</form>',});await testUtils.dom.click(form.$("input[type='checkbox']"));assert.containsOnce(form,".o_dirty_warning","warning message should be shown");await testUtils.form.clickSave(form);assert.containsOnce(form,".o_dirty_warning","warning message should be shown");await testUtils.form.clickSave(form);assert.containsNone(form,".o_dirty_warning","warning message should be shown");form.destroy();});QUnit.test('execute action from settings view with several actions in the breadcrumb',async function(assert){assert.expect(4);const actions=[{id:1,name:'First action',res_model:'project',type:'ir.actions.act_window',views:[[1,'list']],},{id:2,name:'Settings view',res_model:'project',type:'ir.actions.act_window',views:[[2,'form']],},{id:3,name:'Other action',res_model:'project',type:'ir.actions.act_window',views:[[3,'list']],}];const archs={'project,1,list':'<tree><field name="foo"/></tree>','project,2,form':`
                <form string="Settings" js_class="base_settings">
                    <div class="app_settings_block" string="CRM" data-key="crm">
                        <button name="3" string="Execute action" type="action"/>
                    </div>
                </form>`,'project,3,list':'<tree><field name="foo"/></tree>','project,false,search':'<search></search>',};let loadViewsDef;const actionManager=await createActionManager({actions:actions,archs:archs,data:this.data,async mockRPC(route,args){const _super=this._super.bind(this);if(args.method==='read'){await Promise.resolve(loadViewsDef);}
return _super(route,args);},});await actionManager.doAction(1);assert.strictEqual(actionManager.$('.breadcrumb').text(),'First action');await actionManager.doAction(2);assert.strictEqual(actionManager.$('.breadcrumb').text(),'First actionNew');loadViewsDef=testUtils.makeTestPromise();await testUtils.dom.click(actionManager.$('button[name="3"]'));assert.strictEqual(actionManager.$('.breadcrumb').text(),'First actionNew');loadViewsDef.resolve();await testUtils.nextTick();assert.strictEqual(actionManager.$('.breadcrumb').text(),'First actionNewOther action');actionManager.destroy();});});});;

/* /web/static/tests/qweb_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.qweb_tests',function(require){"use strict";var qwebPath='/web/static/lib/qweb/';function trim(s){return s.replace(/(^\s+|\s+$)/g,'');}
function loadTest(assert,template,context){var done=assert.async();assert.expect(1);var qweb=new window.QWeb2.Engine();var prom=new Promise(function(resolve,reject){qweb.add_template(qwebPath+template,function(error,doc){if(error){return reject(error);}
resolve({qweb:qweb,doc:doc});});});prom.then(function(r){var qweb=r.qweb;var doc=r.doc;assert.expect(doc.querySelectorAll('result').length);var templates=qweb.templates;for(var template in templates){try{if(!templates.hasOwnProperty(template)){continue;}
if(/^_/.test(template)){continue;}
var params=doc.querySelector('params#'+template);var args=params?JSON.parse(params.textContent):(context?_.clone(context):{});var results=doc.querySelector('result#'+template);assert.equal(trim(qweb.render(template,args)),trim(results.textContent.replace(new RegExp(String.fromCharCode(13),'g'),'')),template);}catch(error){assert.notOk(error.stack||error,'Rendering error');}}
done();});return prom;}
QUnit.module('QWeb',{},function(){QUnit.test('Output',function(assert){loadTest(assert,'qweb-test-output.xml');});QUnit.test('Context-setting',function(assert){loadTest(assert,'qweb-test-set.xml');});QUnit.test('Conditionals',function(assert){loadTest(assert,'qweb-test-conditionals.xml');});QUnit.test('Attributes manipulation',function(assert){loadTest(assert,'qweb-test-attributes.xml');});QUnit.test('Template calling (to the faraway pages)',function(assert){loadTest(assert,'qweb-test-call.xml',{True:true});});QUnit.test('Foreach',function(assert){loadTest(assert,'qweb-test-foreach.xml');});QUnit.test('Global',function(assert){var WORD_REPLACEMENT=window.QWeb2.WORD_REPLACEMENT;window.QWeb2.WORD_REPLACEMENT=_.extend({not:'!',None:'undefined'},WORD_REPLACEMENT);loadTest(assert,'qweb-test-global.xml',{bool:function(v){return!!v?'True':'False';}}).then(function(){window.QWeb2.WORD_REPLACEMENT=WORD_REPLACEMENT;},function(){window.QWeb2.WORD_REPLACEMENT=WORD_REPLACEMENT;});});QUnit.test('Template inheritance',function(assert){loadTest(assert,'qweb-test-extend.xml');});});});;

/* /web/static/tests/mockserver_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.mockserver_tests',function(require){"use strict";const MockServer=require("web.MockServer");QUnit.module("MockServer",{beforeEach(){this.data={"res.partner":{fields:{name:{string:"Name",type:"string",},email:{string:"Email",type:"string",},},records:[{id:1,name:"Jean-Michel",email:"jean.michel@example.com"}],},};},},function(){QUnit.test("performRpc: search_read with an empty array of fields",async function(assert){assert.expect(1);const server=new MockServer(this.data,{});const result=await server.performRpc("",{model:"res.partner",method:"search_read",args:[],kwargs:{fields:[],},});const expectedFields=["id","email","name","display_name"];assert.strictEqual(_.difference(expectedFields,Object.keys(result[0])).length,0,"should contains all the fields");});QUnit.test("performRpc: search_read without fields",async function(assert){assert.expect(1);const server=new MockServer(this.data,{});const result=await server.performRpc("",{model:"res.partner",method:"search_read",args:[],kwargs:{},});const expectedFields=["id","email","name","display_name"];assert.strictEqual(_.difference(expectedFields,Object.keys(result[0])).length,0,"should contains all the fields");});QUnit.test("performRpc: name_get with no args",async function(assert){assert.expect(2);const server=new MockServer(this.data,{});try{await server.performRpc("",{model:"res.partner",method:"name_get",args:[],kwargs:{},});}catch(error){assert.step("name_get failed")}
assert.verifySteps(["name_get failed"])});QUnit.test("performRpc: name_get with undefined arg",async function(assert){assert.expect(1);const server=new MockServer(this.data,{});const result=await server.performRpc("",{model:"res.partner",method:"name_get",args:[undefined],kwargs:{},});assert.deepEqual(result,[])});QUnit.test("performRpc: name_get with a single id",async function(assert){assert.expect(1);const server=new MockServer(this.data,{});const result=await server.performRpc("",{model:"res.partner",method:"name_get",args:[1],kwargs:{},});assert.deepEqual(result,[[1,"Jean-Michel"]]);});QUnit.test("performRpc: name_get with array of ids",async function(assert){assert.expect(1);const server=new MockServer(this.data,{});const result=await server.performRpc("",{model:"res.partner",method:"name_get",args:[[1]],kwargs:{},});assert.deepEqual(result,[[1,"Jean-Michel"]]);});QUnit.test("performRpc: name_get with invalid id",async function(assert){assert.expect(2);const server=new MockServer(this.data,{});try{await server.performRpc("",{model:"res.partner",method:"name_get",args:[11111],kwargs:{},});}catch(error){assert.step("name_get failed")}
assert.verifySteps(["name_get failed"])});QUnit.test("performRpc: name_get with id and undefined id",async function(assert){assert.expect(1);const server=new MockServer(this.data,{});const result=await server.performRpc("",{model:"res.partner",method:"name_get",args:[[undefined,1]],kwargs:{},});assert.deepEqual(result,[[null,"False"],[1,"Jean-Michel"]]);});});});;

/* /web/static/tests/services/crash_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.crash_manager_tests',function(require){"use strict";const CrashManager=require('web.CrashManager').CrashManager;const Bus=require('web.Bus');const testUtils=require('web.test_utils');const core=require('web.core');const createActionManager=testUtils.createActionManager;QUnit.module('Services',{},function(){QUnit.module('CrashManager');QUnit.test("Execute an action and close the RedirectWarning when clicking on the primary button",async function(assert){assert.expect(4);var dummy_action_name="crash_manager_tests_dummy_action";var dummy_action=function(){assert.step('do_action');};core.action_registry.add(dummy_action_name,dummy_action);const bus=new Bus();bus.on('do-action',null,payload=>{const{action,options}=payload;actionManager.doAction(action,options);});var actionManager=await createActionManager({actions:[dummy_action],services:{crash_manager:CrashManager,},bus});actionManager.call('crash_manager','rpc_error',{code:200,data:{name:"odoo.exceptions.RedirectWarning",arguments:["crash_manager_tests_warning_modal_text",dummy_action_name,"crash_manager_tests_button_text",null,]}});await testUtils.nextTick();var modal_selector='div.modal:contains("crash_manager_tests_warning_modal_text")';assert.containsOnce($,modal_selector,"Warning Modal should be opened");await testUtils.dom.click($(modal_selector).find('button.btn-primary'));assert.containsNone($,modal_selector,"Warning Modal should be closed");assert.verifySteps(['do_action'],"Warning Modal Primary Button Action should be executed");actionManager.destroy();});});});;

/* /web/static/tests/services/data_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.data_manager_tests',function(require){"use strict";const config=require('web.config');const DataManager=require('web.DataManager');const MockServer=require('web.MockServer');const rpc=require('web.rpc');const testUtils=require('web.test_utils');function createDataManager({archs,data,isDebug,mockRPC}){const dataManager=new DataManager();const server=new MockServer(data,{archs});const serverMethods={async load_views({kwargs,model}){const{options,views}=kwargs;const fields=server.fieldsGet(model);const fields_views={};for(const[viewId,viewType]of views){const arch=archs[[model,viewId||false,viewType].join()];fields_views[viewType]=server.fieldsViewGet({arch,model,viewId});}
const result={fields,fields_views};if(options.load_filters){result.filters=data['ir.filters'].records.filter(r=>r.model_id===model);}
return result;},async get_filters({args,model}){return data[model].records.filter(r=>r.model_id===args[0]);},async create_or_replace({args}){const id=data['ir.filters'].records.reduce((i,r)=>Math.max(i,r.id),0)+1;const filter=Object.assign(args[0],{id});data['ir.filters'].records.push(filter);return id;},async unlink({args}){data['ir.filters'].records=data['ir.filters'].records.filter(r=>r.id!==args[0]);return true;},};testUtils.mock.patch(rpc,{async query({method}){this._super=serverMethods[method].bind(this,...arguments);return mockRPC.apply(this,arguments);},});testUtils.mock.patch(config,{isDebug});return dataManager;}
QUnit.module("Services",{beforeEach(){this.archs={'oui,10,kanban':'<kanban/>','oui,20,search':'<search/>',};this.data={oui:{fields:{},records:[]},'ir.filters':{fields:{context:{type:"Text",string:"Context"},domain:{type:"Text",string:"Domain"},model_id:{type:"Selection",string:"Model"},name:{type:"Char",string:"Name"},},records:[{id:2,context:'{}',domain:'[]',model_id:'oui',name:"Favorite",}]}};this.loadViewsParams={model:"oui",context:{},views_descr:[[10,'kanban'],[20,'search'],],};},afterEach(){testUtils.mock.unpatch(rpc);testUtils.mock.unpatch(config);},},function(){QUnit.module("Data manager");QUnit.test("Load views with filters (non-debug mode)",async function(assert){assert.expect(4);const dataManager=createDataManager({archs:this.archs,data:this.data,isDebug(){return false;},async mockRPC({method,model}){assert.step([model,method].join('.'));return this._super(...arguments);},});const firstLoad=await dataManager.load_views(this.loadViewsParams,{load_filters:true,});const secondLoad=await dataManager.load_views(this.loadViewsParams,{load_filters:true,});const filters=await dataManager.load_filters({modelName:'oui'});assert.deepEqual(firstLoad,secondLoad,"query with same params and options should yield the same results");assert.deepEqual(firstLoad.search.favoriteFilters,filters,"load filters should yield the same result as the first load_views' filters");assert.verifySteps(['oui.load_views'],"only load once when not in assets debugging");});QUnit.test("Load views with filters (debug mode)",async function(assert){assert.expect(6);const dataManager=createDataManager({archs:this.archs,data:this.data,isDebug(){return true;},async mockRPC({method,model}){assert.step([model,method].join('.'));return this._super(...arguments);},});const firstLoad=await dataManager.load_views(this.loadViewsParams,{load_filters:true,});const secondLoad=await dataManager.load_views(this.loadViewsParams,{load_filters:true,});const filters=await dataManager.load_filters({modelName:'oui'});assert.deepEqual(firstLoad,secondLoad,"query with same params and options should yield the same results");assert.deepEqual(firstLoad.search.favoriteFilters,filters,"load filters should yield the same result as the first load_views' filters");assert.verifySteps(['oui.load_views','oui.load_views','ir.filters.get_filters',],"reload each time when in assets debugging");});QUnit.test("Cache invalidation and filters addition/deletion",async function(assert){assert.expect(10);const dataManager=createDataManager({archs:this.archs,data:this.data,isDebug(){return false;},async mockRPC({method,model}){assert.step([model,method].join('.'));return this._super(...arguments);},});let filters;const firstLoad=await dataManager.load_views(this.loadViewsParams,{load_filters:true,});filters=await dataManager.load_filters({modelName:'oui'});assert.deepEqual(firstLoad.search.favoriteFilters,filters,"load_filters and load_views.search should return the same filters");const filterId=await dataManager.create_filter({context:"{}",domain:"[]",model_id:'oui',name:"Temp",});filters=await dataManager.load_filters({modelName:'oui'});filters=await dataManager.load_filters({modelName:'oui'});assert.strictEqual(filters.length,2,"A new filter should have been added");assert.ok(filters.find(f=>f.id===filterId)===filters[filters.length-1],"Create filter should return the id of the last created filter");await dataManager.delete_filter(filterId);const secondLoad=await dataManager.load_views(this.loadViewsParams,{load_filters:true,});filters=secondLoad.search.favoriteFilters;const expectedFilters=await dataManager.load_filters({modelName:'oui'});assert.deepEqual(filters,expectedFilters,"Filters loaded by the load_views should be equal to the result of a load_filters");assert.verifySteps(['oui.load_views','ir.filters.create_or_replace','ir.filters.get_filters','ir.filters.unlink','ir.filters.get_filters',],"server should have been called only when needed");});});});;

/* /web/static/tests/services/notification_service_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.notification_tests',function(require){"use strict";var AbstractView=require('web.AbstractView');var Notification=require('web.Notification');var NotificationService=require('web.NotificationService');var testUtils=require('web.test_utils');var createView=testUtils.createView;var waitCloseNotification=function(){return new Promise(function(resolve){setTimeout(resolve,1);});}
QUnit.module('Services',{beforeEach:function(){testUtils.mock.patch(Notification,{_autoCloseDelay:1,_animation:false,});this.viewParams={View:AbstractView,arch:'<fake/>',data:{fake_model:{fields:{},record:[],},},model:'fake_model',services:{notification:NotificationService,},};},afterEach:function(){$('.o_notification_manager').remove();testUtils.mock.unpatch(Notification);}},function(){QUnit.module('Notification');QUnit.test('Display a warning notification',async function(assert){assert.expect(4);var view=await createView(this.viewParams);view.call('notification','notify',{title:'a',message:'b',});await testUtils.nextMicrotaskTick();var $notification=$('body .o_notification_manager .o_notification');assert.strictEqual($notification.html().trim().replace(/\s+/g,' '),"<div class=\"toast-header\"> <span class=\"fa fa-2x mr-3 fa-lightbulb-o o_notification_icon\" role=\"img\" aria-label=\"Notification undefined\" title=\"Notification undefined\"></span> <div class=\"d-flex align-items-center mr-auto font-weight-bold o_notification_title\">a</div> <button type=\"button\" class=\"close o_notification_close\" data-dismiss=\"toast\" aria-label=\"Close\"> <span class=\"d-inline\" aria-hidden=\"true\">×</span> </button> </div> <div class=\"toast-body\"> <div class=\"mr-auto o_notification_content\">b</div> </div>","should display notification");assert.containsOnce($notification,'.o_notification_close');await waitCloseNotification();assert.strictEqual($notification.is(':hidden'),true,"should hide the notification");assert.strictEqual($('body .o_notification_manager .o_notification').length,0,"should destroy the notification");view.destroy();});QUnit.test('Display a danger notification',async function(assert){assert.expect(1);var view=await createView(this.viewParams);view.call('notification','notify',{title:'a',message:'b',type:'danger'});await testUtils.nextMicrotaskTick();var $notification=$('body .o_notification_manager .o_notification');assert.strictEqual($notification.html().trim().replace(/\s+/g,' '),"<div class=\"toast-header\"> <span class=\"fa fa-2x mr-3 fa-exclamation o_notification_icon\" role=\"img\" aria-label=\"Notification undefined\" title=\"Notification undefined\"></span> <div class=\"d-flex align-items-center mr-auto font-weight-bold o_notification_title\">a</div> <button type=\"button\" class=\"close o_notification_close\" data-dismiss=\"toast\" aria-label=\"Close\"> <span class=\"d-inline\" aria-hidden=\"true\">×</span> </button> </div> <div class=\"toast-body\"> <div class=\"mr-auto o_notification_content\">b</div> </div>","should display notification");view.destroy();});QUnit.test('Display a sticky notification',async function(assert){assert.expect(3);var view=await createView(this.viewParams);view.call('notification','notify',{title:'a',message:'b',sticky:true,});await testUtils.nextTick();var $notification=$('body .o_notification_manager .o_notification');assert.containsOnce($notification,'.o_notification_close',"should display the close button in notification");assert.strictEqual($notification.is(':hidden'),false,"should not hide the notification automatically");await testUtils.dom.click($notification.find('.o_notification_close'));assert.strictEqual($('body .o_notification_manager .o_notification').length,0,"should destroy the notification");view.destroy();});QUnit.test('Display a notification without title',async function(assert){assert.expect(3);const view=await createView(this.viewParams);view.call('notification','notify',{title:false,message:'b',sticky:true,});await testUtils.nextTick();const $notification=$('body .o_notification_manager .o_notification');assert.containsNone($notification,'.toast-header .o_notification_title');assert.containsNone($notification,'.o_notification_icon');assert.containsOnce($notification,'.toast-body .o_notification_close');view.destroy();});QUnit.skip('Display a simple notification with onClose callback when automatically close',async function(assert){assert.expect(2);var close=0;var view=await createView(this.viewParams);view.call('notification','notify',{title:'a',message:'b',onClose:function(){close++;}});await testUtils.nextMicrotaskTick();view.destroy();assert.strictEqual(close,0,"should wait to call onClose method once");await testUtils.nextTick();assert.strictEqual(close,1,"should call onClose method once");});QUnit.test('Display a sticky notification with onClose callback',async function(assert){assert.expect(2);testUtils.mock.unpatch(Notification);testUtils.mock.patch(Notification,{_autoCloseDelay:2500,_animation:false,});var view=await createView(this.viewParams);var close=0;view.call('notification','notify',{title:'a',message:'b',sticky:true,onClose:function(){close++;}});await testUtils.nextMicrotaskTick();assert.strictEqual(close,0,"should wait to call onClose method once");testUtils.dom.click($('body .o_notification_manager .o_notification .o_notification_close'));assert.strictEqual(close,1,"should call onClose method once");view.destroy();});QUnit.test('Display a question',async function(assert){assert.expect(8);var view=await createView(this.viewParams);function notification(inc){return{title:'a'+inc,message:'b'+inc,buttons:[{text:'accept'+inc,primary:true,click:function(){assert.step('accept'+inc);},},{text:'refuse'+inc,click:function(){assert.step('refuse'+inc);},}],onClose:function(){assert.step('close'+inc);}};};view.call('notification','notify',notification(0));view.call('notification','notify',notification(1));view.call('notification','notify',notification(2));await testUtils.nextTick();var $notification=$('body .o_notification_manager .o_notification');assert.containsOnce($notification.eq(0),'.o_notification_close',"should display the close button in notification");assert.strictEqual($notification.html().trim().replace(/\s+/g,' '),"<div class=\"toast-header\"> <span class=\"fa fa-2x mr-3 fa-question-circle-o o_notification_icon\" role=\"img\" aria-label=\"Notification undefined\" title=\"Notification undefined\"></span> <div class=\"d-flex align-items-center mr-auto font-weight-bold o_notification_title\">a0</div> <button type=\"button\" class=\"close o_notification_close\" data-dismiss=\"toast\" aria-label=\"Close\"> <span class=\"d-inline\" aria-hidden=\"true\">×</span> </button> </div> <div class=\"toast-body\"> <div class=\"mr-auto o_notification_content\">b0</div> <div class=\"mt-2 o_notification_buttons\"> <button type=\"button\" class=\"btn btn-sm btn-primary\"> <span>accept0</span> </button><button type=\"button\" class=\"btn btn-sm btn-secondary\"> <span>refuse0</span> </button> </div> </div>","should display notification");testUtils.dom.click($notification.find('.o_notification_buttons button:contains(accept0)'));testUtils.dom.click($notification.find('.o_notification_buttons button:contains(refuse1)'));testUtils.dom.click($notification.eq(2).find('.o_notification_close'));assert.strictEqual($notification.is(':hidden'),true,"should hide the notification");assert.strictEqual($('body .o_notification_manager .o_notification').length,0,"should destroy the notification");assert.verifySteps(['accept0','refuse1','close2']);view.destroy();});QUnit.test('call close notification service',async function(assert){assert.expect(2);testUtils.mock.unpatch(Notification);testUtils.mock.patch(Notification,{_autoCloseDelay:2500,_animation:false,});var view=await createView(this.viewParams);var close=0;var notificationId0=view.call('notification','notify',{title:'a',message:'b',onClose:function(){close++;}});var notificationId1=view.call('notification','notify',{title:'a',message:'b',sticky:true,onClose:function(){close++;}});await testUtils.nextTick();view.call('notification','close',notificationId0);view.call('notification','close',notificationId1);await testUtils.nextTick();assert.strictEqual($('body .o_notification_manager .o_notification').length,0,"should destroy the notifications");assert.strictEqual(close,2,"should call onClose method twice");view.destroy();});QUnit.test('Display a custom notification',async function(assert){assert.expect(3);var Custom=Notification.extend({init:function(parent,params){this._super.apply(this,arguments);assert.ok(params.customParams,'instantiate custom notification');},start:function(){var self=this;return this._super().then(function(){self.$el.html('Custom');});},});var view=await createView(this.viewParams);view.call('notification','notify',{Notification:Custom,customParams:true,});await testUtils.nextMicrotaskTick();assert.containsOnce($('body'),'.o_notification_manager .o_notification:contains(Custom)',"should display the notification");view.destroy();assert.containsNone($('body'),'.o_notification_manager .o_notification',"should destroy the notification");});});});;

/* /web/static/tests/fields/basic_fields_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.basic_fields_tests',function(require){"use strict";var ajax=require('web.ajax');var basicFields=require('web.basic_fields');var concurrency=require('web.concurrency');var config=require('web.config');var core=require('web.core');var FormView=require('web.FormView');var KanbanView=require('web.KanbanView');var ListView=require('web.ListView');var session=require('web.session');var testUtils=require('web.test_utils');var testUtilsDom=require('web.test_utils_dom');var field_registry=require('web.field_registry');var createView=testUtils.createView;var patchDate=testUtils.mock.patchDate;var DebouncedField=basicFields.DebouncedField;var JournalDashboardGraph=basicFields.JournalDashboardGraph;var _t=core._t;const MY_IMAGE='iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==';const PRODUCT_IMAGE='R0lGODlhDAAMAKIFAF5LAP/zxAAAANyuAP/gaP///wAAAAAAACH5BAEAAAUALAAAAAAMAAwAAAMlWLPcGjDKFYi9lxKBOaGcF35DhWHamZUW0K4mAbiwWtuf0uxFAgA7';const FR_FLAG_URL='/base/static/img/country_flags/fr.png';const EN_FLAG_URL='/base/static/img/country_flags/gb.png';QUnit.module('fields',{},function(){QUnit.module('basic_fields',{beforeEach:function(){this.data={partner:{fields:{date:{string:"A date",type:"date",searchable:true},datetime:{string:"A datetime",type:"datetime",searchable:true},display_name:{string:"Displayed name",type:"char",searchable:true},foo:{string:"Foo",type:"char",default:"My little Foo Value",searchable:true,trim:true},bar:{string:"Bar",type:"boolean",default:true,searchable:true},empty_string:{string:"Empty string",type:"char",default:false,searchable:true,trim:true},txt:{string:"txt",type:"text",default:"My little txt Value\nHo-ho-hoooo Merry Christmas"},int_field:{string:"int_field",type:"integer",sortable:true,searchable:true},qux:{string:"Qux",type:"float",digits:[16,1],searchable:true},p:{string:"one2many field",type:"one2many",relation:'partner',searchable:true},trululu:{string:"Trululu",type:"many2one",relation:'partner',searchable:true},timmy:{string:"pokemon",type:"many2many",relation:'partner_type',searchable:true},product_id:{string:"Product",type:"many2one",relation:'product',searchable:true},sequence:{type:"integer",string:"Sequence",searchable:true},currency_id:{string:"Currency",type:"many2one",relation:"currency",searchable:true},selection:{string:"Selection",type:"selection",searchable:true,selection:[['normal','Normal'],['blocked','Blocked'],['done','Done']]},document:{string:"Binary",type:"binary"},hex_color:{string:"hexadecimal color",type:"char"},},records:[{id:1,date:"2017-02-03",datetime:"2017-02-08 10:00:00",display_name:"first record",bar:true,foo:"yop",int_field:10,qux:0.44444,p:[],timmy:[],trululu:4,selection:'blocked',document:'coucou==\n',hex_color:'#ff0000',},{id:2,display_name:"second record",bar:true,foo:"blip",int_field:0,qux:0,p:[],timmy:[],trululu:1,sequence:4,currency_id:2,selection:'normal',},{id:4,display_name:"aaa",foo:"abc",sequence:9,int_field:false,qux:false,selection:'done',},{id:3,bar:true,foo:"gnap",int_field:80,qux:-3.89859},{id:5,bar:false,foo:"blop",int_field:-4,qux:9.1,currency_id:1}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char",searchable:true}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},partner_type:{fields:{name:{string:"Partner Type",type:"char",searchable:true},color:{string:"Color index",type:"integer",searchable:true},},records:[{id:12,display_name:"gold",color:2},{id:14,display_name:"silver",color:5},]},currency:{fields:{digits:{string:"Digits"},symbol:{string:"Currency Sumbol",type:"char",searchable:true},position:{string:"Currency Position",type:"char",searchable:true},},records:[{id:1,display_name:"$",symbol:"$",position:"before",},{id:2,display_name:"€",symbol:"€",position:"after",}]},"ir.translation":{fields:{lang_code:{type:"char"},value:{type:"char"},res_id:{type:"integer"}},records:[{id:99,res_id:37,value:'',lang_code:'en_US'}]},};}},function(){QUnit.module('DebouncedField');QUnit.test('debounced fields do not trigger call _setValue once destroyed',async function(assert){assert.expect(4);var def=testUtils.makeTestPromise();var _doAction=DebouncedField.prototype._doAction;DebouncedField.prototype._doAction=function(){_doAction.apply(this,arguments);def.resolve();};var _setValue=DebouncedField.prototype._setValue;DebouncedField.prototype._setValue=function(){assert.step('_setValue');_setValue.apply(this,arguments);};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,fieldDebounce:3,viewOptions:{mode:'edit',},});testUtils.fields.editInput(form.$('input[name=foo]'),'new value');assert.verifySteps([],"_setValue shouldn't have been called yet");await testUtils.form.clickSave(form);assert.verifySteps(['_setValue'],"_setValue should have been called once");def=testUtils.makeTestPromise();form.destroy();await testUtils.nextMicrotaskTick();assert.verifySteps([],"_setValue should not have been called after widget destruction");DebouncedField.prototype._doAction=_doAction;DebouncedField.prototype._setValue=_setValue;});QUnit.module('FieldBoolean');QUnit.test('boolean field in form view',async function(assert){assert.expect(13);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><label for="bar" string="Awesome checkbox"/><field name="bar"/></form>',res_id:1,});assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should be checked");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should still be checked");await testUtils.dom.click(form.$('.o_field_boolean input:checked'));assert.containsNone(form,'.o_field_boolean input:checked',"checkbox should no longer be checked");await testUtils.form.clickSave(form);assert.containsNone(form,'.o_field_boolean input:checked',"checkbox should still no longer be checked");await testUtils.form.clickEdit(form);assert.containsNone(form,'.o_field_boolean input:checked',"checkbox should still be unchecked");await testUtils.dom.click(form.$('.o_field_boolean input'));assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should now be checked");await testUtils.dom.click(form.$('.o_field_boolean input'));assert.containsNone(form,'.o_field_boolean input:checked',"checkbox should now be unchecked");await testUtils.dom.click(form.$('.o_form_view label:first'));assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should now be checked");await testUtils.dom.click(form.$('.o_form_view label:first'));assert.containsNone(form,'.o_field_boolean input:checked',"checkbox should now be unchecked");await testUtils.dom.triggerEvents(form.$('.o_field_boolean input'),["focusin",{type:"keydown",which:$.ui.keyCode.ENTER},{type:"keyup",which:$.ui.keyCode.ENTER}]);assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should now be checked");await testUtils.dom.triggerEvent(document.activeElement,"keydown",{which:$.ui.keyCode.ENTER});assert.containsNone(form,'.o_field_boolean input:checked',"checkbox should not be checked");await testUtils.nextTick();await testUtils.dom.triggerEvent(document.activeElement,"keydown",{which:$.ui.keyCode.ENTER});assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should still be checked");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_field_boolean input:checked',"checkbox should still be checked");form.destroy();});QUnit.test('boolean field in editable list view',async function(assert){assert.expect(11);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="bar"/></tree>',});assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input').length,5,"should have 5 checkboxes");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input:checked').length,4,"should have 4 checked input");var $cell=list.$('tr.o_data_row:has(.custom-checkbox input:checked) td:not(.o_list_record_selector)').first();assert.ok($cell.find('.custom-checkbox input:checked').prop('disabled'),"input should be disabled in readonly mode");await testUtils.dom.click($cell);assert.ok(!$cell.find('.custom-checkbox input:checked').prop('disabled'),"input should not have the disabled property in edit mode");await testUtils.dom.click($cell.find('.custom-checkbox input:checked'));await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));$cell=list.$('tr.o_data_row:has(.custom-checkbox input:not(:checked)) td:not(.o_list_record_selector)').first();assert.ok($cell.find('.custom-checkbox input:not(:checked)').prop('disabled'),"input should be disabled again");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input').length,5,"should still have 5 checkboxes");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input:checked').length,3,"should now have only 3 checked input");await testUtils.dom.click($cell);await testUtils.dom.click($cell.find('.custom-checkbox input'));await testUtils.dom.click($cell.find('.custom-checkbox input'));await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input').length,5,"should still have 5 checkboxes");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input:checked').length,3,"should still have only 3 checked input");$cell=list.$('tr.o_data_row:has(.custom-checkbox input:not(:checked)) td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell.find('.custom-checkbox .custom-control-label'));await testUtils.nextTick();assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input').length,5,"should still have 5 checkboxes");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) .custom-checkbox input:checked').length,4,"should now have 4 checked input back");list.destroy();});QUnit.module('FieldBooleanToggle');QUnit.test('use boolean toggle widget in form view',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="bar" widget="boolean_toggle"/></form>',res_id:2,});assert.containsOnce(form,".custom-checkbox.o_boolean_toggle","Boolean toggle widget applied to boolean field");form.destroy();});QUnit.module('FieldToggleButton');QUnit.test('use toggle_button in list view',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree>'+'<field name="bar" widget="toggle_button" '+'options="{&quot;active&quot;: &quot;Reported in last payslips&quot;, &quot;inactive&quot;: &quot;To Report in Payslip&quot;}"/>'+'</tree>',});assert.containsN(list,'button i.fa.fa-circle.o_toggle_button_success',4,"should have 4 green buttons");assert.containsOnce(list,'button i.fa.fa-circle.text-muted',"should have 1 muted button");assert.hasAttrValue(list.$('.o_list_view button').first(),'title',"Reported in last payslips","active buttons should have proper tooltip");assert.hasAttrValue(list.$('.o_list_view button').last(),'title',"To Report in Payslip","inactive buttons should have proper tooltip");await testUtils.dom.click(list.$('.o_list_view button').first());assert.containsN(list,'button i.fa.fa-circle.o_toggle_button_success',3,"should have 3 green buttons");await testUtils.dom.click(list.$('.o_list_view button').first());assert.containsN(list,'button i.fa.fa-circle.o_toggle_button_success',4,"should have 4 green buttons");list.destroy();});QUnit.test('toggle_button in form view (edit mode)',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar" widget="toggle_button" '+'options="{\'active\': \'Active value\', \'inactive\': \'Inactive value\'}"/>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){assert.step('write');}
return this._super.apply(this,arguments);},res_id:2,viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_field_widget[name=bar] i.o_toggle_button_success:not(.text-muted)').length,1,"should be green");await testUtils.dom.click(form.$('.o_field_widget[name=bar]'));assert.strictEqual(form.$('.o_field_widget[name=bar] i.text-muted:not(.o_toggle_button_success)').length,1,"should be gray");assert.verifySteps([]);await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget[name=bar] i.text-muted:not(.o_toggle_button_success)').length,1,"should still be gray");assert.verifySteps(['write']);form.destroy();});QUnit.test('toggle_button in form view (readonly mode)',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar" widget="toggle_button" '+'options="{\'active\': \'Active value\', \'inactive\': \'Inactive value\'}"/>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){assert.step('write');}
return this._super.apply(this,arguments);},res_id:2,});assert.strictEqual(form.$('.o_field_widget[name=bar] i.o_toggle_button_success:not(.text-muted)').length,1,"should be green");await testUtils.dom.click(form.$('.o_field_widget[name=bar]'));assert.strictEqual(form.$('.o_field_widget[name=bar] i.text-muted:not(.o_toggle_button_success)').length,1,"should be gray");assert.verifySteps(['write']);form.destroy();});QUnit.module('FieldFloat');QUnit.test('float field when unset',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" digits="[5,3]"/>'+'</sheet>'+'</form>',res_id:4,});assert.doesNotHaveClass(form.$('.o_field_widget'),'o_field_empty','Non-set float field should be considered as 0.');assert.strictEqual(form.$('.o_field_widget').text(),"0.000",'Non-set float field should be considered as 0.');form.destroy();});QUnit.test('float fields use correct digit precision',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="qux"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$('span.o_field_number:contains(0.4)').length,1,"should contain a number rounded to 1 decimal");form.destroy();});QUnit.test('float field in list view no widget',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" digits="[5,3]"/>'+'</sheet>'+'</form>',res_id:2,});assert.doesNotHaveClass(form.$('.o_field_widget'),'o_field_empty','Float field should be considered set for value 0.');assert.strictEqual(form.$('.o_field_widget').first().text(),'0.000','The value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=qux]').val(),'0.000','The value should be rendered with correct precision.');await testUtils.fields.editInput(form.$('input[name=qux]'),'108.2458938598598');assert.strictEqual(form.$('input[name=qux]').val(),'108.2458938598598','The value should not be formated yet.');await testUtils.fields.editInput(form.$('input[name=qux]'),'18.8958938598598');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'18.896','The new value should be rounded properly.');form.destroy();});QUnit.test('float field in form view',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="float" digits="[5,3]"/>'+'</sheet>'+'</form>',res_id:2,});assert.doesNotHaveClass(form.$('.o_field_widget'),'o_field_empty','Float field should be considered set for value 0.');assert.strictEqual(form.$('.o_field_widget').first().text(),'0.000','The value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=qux]').val(),'0.000','The value should be rendered with correct precision.');await testUtils.fields.editInput(form.$('input[name=qux]'),'108.2458938598598');assert.strictEqual(form.$('input[name=qux]').val(),'108.2458938598598','The value should not be formated yet.');await testUtils.fields.editInput(form.$('input[name=qux]'),'18.8958938598598');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'18.896','The new value should be rounded properly.');form.destroy();});QUnit.test('float field using formula in form view',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="float" digits="[5,3]"/>'+'</sheet>'+'</form>',res_id:2,});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=qux]'),'=20+3*2');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'26.000','The new value should be calculated properly.');await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=qux]'),'=2**3');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'8.000','The new value should be calculated properly.');await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=qux]'),'=2^3');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'8.000','The new value should be calculated properly.');await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=qux]'),'=100/3');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'33.333','The new value should be calculated properly.');form.destroy();});QUnit.test('float field using incorrect formula in form view',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="float" digits="[5,3]"/>'+'</sheet>'+'</form>',res_id:2,});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=qux]'),'=abc');await testUtils.form.clickSave(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable',"form view should still be editable");assert.hasClass(form.$('input[name=qux]'),'o_field_invalid',"fload field should be displayed as invalid");await testUtils.fields.editInput(form.$('input[name=qux]'),'=3:2?+4');await testUtils.form.clickSave(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable',"form view should still be editable");assert.hasClass(form.$('input[name=qux]'),'o_field_invalid',"float field should be displayed as invalid");form.destroy();});QUnit.test('float field in editable list view',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="qux" widget="float" digits="[5,3]"/>'+'</tree>',});var zeroValues=list.$('td.o_data_cell').filter(function(){return $(this).text()==='';});assert.strictEqual(zeroValues.length,1,'Unset float values should be rendered as empty strings.');var $cell=list.$('tr.o_data_row td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.containsOnce(list,'input[name="qux"]','The view should have 1 input for editable float.');await testUtils.fields.editInput(list.$('input[name="qux"]'),'108.2458938598598');assert.strictEqual(list.$('input[name="qux"]').val(),'108.2458938598598','The value should not be formated yet.');await testUtils.fields.editInput(list.$('input[name="qux"]'),'18.8958938598598');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('.o_field_widget').first().text(),'18.896','The new value should be rounded properly.');list.destroy();});QUnit.test('do not trigger a field_changed if they have not changed',async function(assert){assert.expect(2);this.data.partner.records[1].qux=false;this.data.partner.records[1].int_field=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="float" digits="[5,3]"/>'+'<field name="int_field"/>'+'</sheet>'+'</form>',res_id:2,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);}});await testUtils.form.clickEdit(form);await testUtils.form.clickSave(form);assert.verifySteps(['read']);form.destroy();});QUnit.test('float widget on monetary field',async function(assert){assert.expect(1);this.data.partner.fields.monetary={string:"Monetary",type:'monetary'};this.data.partner.records[0].monetary=9.99;this.data.partner.records[0].currency_id=1;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="monetary" widget="float"/>'+'<field name="currency_id" invisible="1"/>'+'</sheet>'+'</form>',res_id:1,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});assert.strictEqual(form.$('.o_field_widget[name=monetary]').text(),'9.99','value should be correctly formatted (with the float formatter)');form.destroy();});QUnit.test('float field with monetary widget and decimal precision',async function(assert){assert.expect(5);this.data.partner.records=[{id:1,qux:-8.89859,currency_id:1,}];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="monetary" options="{\'field_digits\': True}"/>'+'<field name="currency_id" invisible="1"/>'+'</sheet>'+'</form>',res_id:1,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});assert.strictEqual(form.$('.o_field_widget').first().text(),'$\u00a0-8.9','The value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'-8.9','The input should be rendered without the currency symbol.');assert.strictEqual(form.$('.o_field_widget[name=qux] input').parent().children().first().text(),'$','The input should be preceded by a span containing the currency symbol.');await testUtils.fields.editInput(form.$('.o_field_monetary input'),'109.2458938598598');assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'109.2458938598598','The value should not be formated yet.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'$\u00a0109.2','The new value should be rounded properly.');form.destroy();});QUnit.test('float field with type number option',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="qux" options="{\'type\': \'number\'}"/>'+'</form>',res_id:4,translateParameters:{thousands_sep:",",grouping:[3,0],},});await testUtils.form.clickEdit(form);assert.ok(form.$('.o_field_widget')[0].hasAttribute('type'),'Float field with option type must have a type attribute.');assert.hasAttrValue(form.$('.o_field_widget'),'type','number','Float field with option type must have a type attribute equals to "number".');await testUtils.fields.editInput(form.$('input[name=qux]'),'123456.7890');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget').val(),'123456.789','Float value must be not formatted if input type is number.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'123,456.8','Float value must be formatted in readonly view even if the input type is number.');form.destroy();});QUnit.test('float field with type number option and comma decimal separator',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="qux" options="{\'type\': \'number\'}"/>'+'</form>',res_id:4,translateParameters:{thousands_sep:".",decimal_point:",",grouping:[3,0],},});await testUtils.form.clickEdit(form);assert.ok(form.$('.o_field_widget')[0].hasAttribute('type'),'Float field with option type must have a type attribute.');assert.hasAttrValue(form.$('.o_field_widget'),'type','number','Float field with option type must have a type attribute equals to "number".');await testUtils.fields.editInput(form.$('input[name=qux]'),'123456.789');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget').val(),'123456.789','Float value must be not formatted if input type is number.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'123.456,8','Float value must be formatted in readonly view even if the input type is number.');form.destroy();});QUnit.test('float field without type number option',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="qux"/>'+'</form>',res_id:4,translateParameters:{thousands_sep:",",grouping:[3,0],},});await testUtils.form.clickEdit(form);assert.hasAttrValue(form.$('.o_field_widget'),'type','text','Float field with option type must have a text type (default type).');await testUtils.fields.editInput(form.$('input[name=qux]'),'123456.7890');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget').val(),'123,456.8','Float value must be formatted if input type isn\'t number.');form.destroy();});QUnit.module('Percentage');QUnit.test('percentage widget in form view',async function(assert){assert.expect(6);const form=await createView({View:FormView,model:'partner',data:this.data,arch:` <form string="Partners">
                        <field name="qux" widget="percentage"/>
                    </form>`,mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].qux,0.24,'the correct float value should be saved');}
return this._super(...arguments);},res_id:1,});assert.strictEqual(form.$('.o_field_widget').first().text(),'44.4%','The value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'44.4','The input should be rendered without the percentage symbol.');assert.strictEqual(form.$('.o_field_widget[name=qux] span').text(),'%','The input should be followed by a span containing the percentage symbol.');await testUtils.fields.editInput(form.$('.o_field_float_percentage input'),'24');assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'24','The value should not be formated yet.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'24%','The new value should be formatted properly.');form.destroy();});QUnit.module('FieldEmail');QUnit.test('email field in form view',async function(assert){assert.expect(7);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" widget="email"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});var $mailtoLink=form.$('a.o_form_uri.o_field_widget.o_text_overflow');assert.strictEqual($mailtoLink.length,1,"should have a anchor with correct classes");assert.strictEqual($mailtoLink.text(),'yop',"the value should be displayed properly");assert.hasAttrValue($mailtoLink,'href','mailto:yop',"should have proper mailto prefix");await testUtils.form.clickEdit(form);assert.containsOnce(form,'input[type="text"].o_field_widget',"should have an input for the email field");assert.strictEqual(form.$('input[type="text"].o_field_widget').val(),'yop',"input should contain field value in edit mode");await testUtils.fields.editInput(form.$('input[type="text"].o_field_widget'),'new');await testUtils.form.clickSave(form);$mailtoLink=form.$('a.o_form_uri.o_field_widget.o_text_overflow');assert.strictEqual($mailtoLink.text(),'new',"new value should be displayed properly");assert.hasAttrValue($mailtoLink,'href','mailto:new',"should still have proper mailto prefix");form.destroy();});QUnit.test('email field in editable list view',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="foo"  widget="email"/></tree>',});assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').length,5,"should have 5 cells");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').first().text(),'yop',"value should be displayed properly as text");var $mailtoLink=list.$('a.o_form_uri.o_field_widget.o_text_overflow');assert.strictEqual($mailtoLink.length,5,"should have anchors with correct classes");assert.hasAttrValue($mailtoLink.first(),'href','mailto:yop',"should have proper mailto prefix");var $cell=list.$('tbody td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.hasClass($cell.parent(),'o_selected_row','should be set as edit mode');assert.strictEqual($cell.find('input').val(),'yop','should have the corect value in internal input');await testUtils.fields.editInput($cell.find('input'),'new');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));$cell=list.$('tbody td:not(.o_list_record_selector)').first();assert.doesNotHaveClass($cell.parent(),'o_selected_row','should not be in edit mode anymore');assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').first().text(),'new',"value should be properly updated");$mailtoLink=list.$('a.o_form_uri.o_field_widget.o_text_overflow');assert.strictEqual($mailtoLink.length,5,"should still have anchors with correct classes");assert.hasAttrValue($mailtoLink.first(),'href','mailto:new',"should still have proper mailto prefix");list.destroy();});QUnit.test('email field with empty value',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="empty_string" widget="email"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});var $mailtoLink=form.$('a.o_form_uri.o_field_widget.o_text_overflow');assert.strictEqual($mailtoLink.text(),'',"the value should be displayed properly");form.destroy();});QUnit.test('email field trim user value',async function(assert){assert.expect(1);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="foo" widget="email"/></form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.fields.editInput(form.$('input[name="foo"]'),'  abc@abc.com  ');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name="foo"]').val(),'abc@abc.com',"Foo value should have been trimmed");form.destroy();});QUnit.module('FieldChar');QUnit.test('char widget isValid method works',async function(assert){assert.expect(1);this.data.partner.fields.foo.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,});var charField=_.find(form.renderer.allFieldWidgets)[0];assert.strictEqual(charField.isValid(),true);form.destroy();});QUnit.test('char field in form view',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_field_widget').text(),'yop',"the value should be displayed properly");await testUtils.form.clickEdit(form);assert.containsOnce(form,'input[type="text"].o_field_widget',"should have an input for the char field");assert.strictEqual(form.$('input[type="text"].o_field_widget').val(),'yop',"input should contain field value in edit mode");await testUtils.fields.editInput(form.$('input[type="text"].o_field_widget'),'limbo');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'limbo','the new value should be displayed');form.destroy();});QUnit.test('setting a char field to empty string is saved as a false value',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit'},mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].foo,false,'the foo value should be false');}
return this._super.apply(this,arguments);}});await testUtils.fields.editInput(form.$('input[type="text"].o_field_widget'),'');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('char field with size attribute',async function(assert){assert.expect(1);this.data.partner.fields.foo.size=5;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group><field name="foo"/></group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.hasAttrValue(form.$('input.o_field_widget'),'maxlength','5',"maxlength attribute should have been set correctly on the input");form.destroy();});QUnit.test('char field in editable list view',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',});assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').length,5,"should have 5 cells");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').first().text(),'yop',"value should be displayed properly as text");var $cell=list.$('tbody td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.hasClass($cell.parent(),'o_selected_row','should be set as edit mode');assert.strictEqual($cell.find('input').val(),'yop','should have the corect value in internal input');await testUtils.fields.editInput($cell.find('input'),'brolo');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));$cell=list.$('tbody td:not(.o_list_record_selector)').first();assert.doesNotHaveClass($cell.parent(),'o_selected_row','should not be in edit mode anymore');assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').first().text(),'brolo',"value should be properly updated");list.destroy();});QUnit.test('char field translatable',async function(assert){assert.expect(12);this.data.partner.fields.foo.translate=true;var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,session:{user_context:{lang:'en_US'},},mockRPC:function(route,args){if(route==="/web/dataset/call_button"&&args.method==='translate_fields'){assert.deepEqual(args.args,["partner",1,"foo"],'should call "call_button" route');return Promise.resolve({domain:[],context:{search_default_name:'partnes,foo'},});}
if(route==="/web/dataset/call_kw/res.lang/get_installed"){return Promise.resolve([["en_US","English"],["fr_BE","French (Belgium)"]]);}
if(args.method==="search_read"&&args.model=="ir.translation"){return Promise.resolve([{lang:'en_US',src:'yop',value:'yop',id:42},{lang:'fr_BE',src:'yop',value:'valeur français',id:43}]);}
if(args.method==="write"&&args.model=="ir.translation"){assert.deepEqual(args.args[1],{value:"english value"},"the new translation value should be written");return Promise.resolve();}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);var $button=form.$('input[type="text"].o_field_char + .o_field_translate');assert.strictEqual($button.length,1,"should have a translate button");assert.strictEqual($button.text(),'EN','the button should have as test the current language');await testUtils.dom.click($button);await testUtils.nextTick();assert.containsOnce($(document),'.modal','a translate modal should be visible');assert.containsN($('.modal .o_translation_dialog'),'.translation',2,'two rows should be visible');var $enField=$('.modal .o_translation_dialog .translation:first() input');assert.strictEqual($enField.val(),'yop','English translation should be filled');assert.strictEqual($('.modal .o_translation_dialog .translation:last() input').val(),'valeur français','French translation should be filled');await testUtils.fields.editInput($enField,"english value");await testUtils.dom.click($('.modal button.btn-primary'));await testUtils.nextTick();var $foo=form.$('input[type="text"].o_field_char');assert.strictEqual($foo.val(),"english value","the new translation was not transfered to modified record");await testUtils.fields.editInput($foo,"new english value");await testUtils.dom.click($button);await testUtils.nextTick();assert.strictEqual($('.modal .o_translation_dialog .translation:first() input').val(),'new english value','Modified value should be used instead of translation');assert.strictEqual($('.modal .o_translation_dialog .translation:last() input').val(),'valeur français','French translation should be filled');form.destroy();_t.database.multi_lang=multiLang;});QUnit.test('html field translatable',async function(assert){assert.expect(6);this.data.partner.fields.foo.translate=true;var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,session:{user_context:{lang:'en_US'},},mockRPC:function(route,args){if(route==="/web/dataset/call_button"&&args.method==='translate_fields'){assert.deepEqual(args.args,["partner",1,"foo"],'should call "call_button" route');return Promise.resolve({domain:[],context:{search_default_name:'partner,foo',translation_type:'char',translation_show_src:true,},});}
if(route==="/web/dataset/call_kw/res.lang/get_installed"){return Promise.resolve([["en_US","English"],["fr_BE","French (Belgium)"]]);}
if(args.method==="search_read"&&args.model=="ir.translation"){return Promise.resolve([{lang:'en_US',src:'first paragraph',value:'first paragraph',id:42},{lang:'en_US',src:'second paragraph',value:'second paragraph',id:43},{lang:'fr_BE',src:'first paragraph',value:'premier paragraphe',id:44},{lang:'fr_BE',src:'second paragraph',value:'deuxième paragraphe',id:45},]);}
if(args.method==="write"&&args.model=="ir.translation"){assert.deepEqual(args.args[1],{value:"first paragraph modified"},"Wrong update on translation");return Promise.resolve();}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);var $foo=form.$('input[type="text"].o_field_char');await testUtils.fields.editInput($foo,"<p>first paragraph</p><p>second paragraph</p>");var $button=form.$('input[type="text"].o_field_char + .o_field_translate');await testUtils.dom.click($button);await testUtils.nextTick();assert.containsOnce($(document),'.modal','a translate modal should be visible');assert.containsN($('.modal .o_translation_dialog'),'.translation',4,'four rows should be visible');var $enField=$('.modal .o_translation_dialog .translation:first() input');assert.strictEqual($enField.val(),'first paragraph','first part of english translation should be filled');await testUtils.fields.editInput($enField,"first paragraph modified");await testUtils.dom.click($('.modal button.btn-primary'));await testUtils.nextTick();assert.strictEqual($foo.val(),"<p>first paragraph</p><p>second paragraph</p>","the new partial translation should not be transfered");form.destroy();_t.database.multi_lang=multiLang;});QUnit.test('char field translatable in create mode',async function(assert){assert.expect(1);this.data.partner.fields.foo.translate=true;var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',});var $button=form.$('input[type="text"].o_field_char + .o_field_translate');assert.strictEqual($button.length,1,"should have a translate button in create mode");form.destroy();_t.database.multi_lang=multiLang;});QUnit.test('char field does not allow html injections',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.fields.editInput(form.$('input[name=foo]'),'<script>throw Error();</script>');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'<script>throw Error();</script>','the value should have been properly escaped');form.destroy();});QUnit.test('char field trim (or not) characters',async function(assert){assert.expect(2);this.data.partner.fields.foo2={string:"Foo2",type:"char",trim:false};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'<field name="foo2"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.fields.editInput(form.$('input[name="foo"]'),'  abc  ');await testUtils.fields.editInput(form.$('input[name="foo2"]'),'  def  ');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name="foo"]').val(),'abc','Foo value should have been trimmed');assert.strictEqual(form.$('input[name="foo2"]').val(),'  def  ','Foo2 value should not have been trimmed');form.destroy();});QUnit.test('input field: change value before pending onchange returns',async function(assert){assert.expect(3);this.data.partner.onchanges={product_id:function(){},};var def;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="product_id"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==="onchange"){return Promise.resolve(def).then(function(){return result;});}else{return result;}},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('input[name="foo"]').val(),'My little Foo Value','should contain the default value');def=testUtils.makeTestPromise();await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');await testUtils.fields.editInput(form.$('input[name="foo"]'),"tralala");assert.strictEqual(form.$('input[name="foo"]').val(),'tralala','input should contain tralala');def.resolve();await testUtils.nextTick();assert.strictEqual(form.$('input[name="foo"]').val(),'tralala','input should contain the same value as before onchange');form.destroy();});QUnit.test('input field: change value before pending onchange returns (with fieldDebounce)',async function(assert){assert.expect(5);this.data.partner.onchanges={product_id:function(obj){obj.int_field=obj.product_id?7:false;},};let def;const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="p">
                        <tree editable="bottom">
                            <field name="product_id"/>
                            <field name="foo"/>
                            <field name="int_field"/>
                        </tree>
                    </field>
                </form>`,async mockRPC(route,args){const result=this._super(...arguments);if(args.method==="onchange"){await Promise.resolve(def);}
return result;},fieldDebounce:5000,});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('input[name="foo"]').val(),'My little Foo Value','should contain the default value');def=testUtils.makeTestPromise();await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');await testUtils.fields.editInput(form.$('input[name="foo"]'),"tralala");assert.strictEqual(form.$('input[name="foo"]').val(),'tralala');assert.strictEqual(form.$('input[name="int_field"]').val(),'');def.resolve();await testUtils.nextTick();assert.strictEqual(form.$('input[name="foo"]').val(),'tralala','foo should contain the same value as before onchange');assert.strictEqual(form.$('input[name="int_field"]').val(),'7','int_field should contain the value returned by the onchange');form.destroy();});QUnit.test('input field: change value before pending onchange renaming',async function(assert){assert.expect(3);this.data.partner.onchanges={product_id:function(obj){obj.foo='on change value';},};var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="product_id"/>'+'<field name="foo"/>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==="onchange"){return def.then(function(){return result;});}else{return result;}},viewOptions:{mode:'edit',},});assert.strictEqual(form.$('input[name="foo"]').val(),'yop','should contain the correct value');await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');testUtils.fields.editInput(form.$('input[name="foo"]'),"tralala");assert.strictEqual(form.$('input[name="foo"]').val(),'tralala','input should contain tralala');def.resolve();assert.strictEqual(form.$('input[name="foo"]').val(),'tralala','input should contain the same value as before onchange');form.destroy();});QUnit.test('input field: change password value',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo" password="True"/>'+'</form>',res_id:1,});assert.notEqual(form.$('.o_field_char').text(),"yop","password field value should not be visible in read mode");assert.strictEqual(form.$('.o_field_char').text(),"***","password field value should be hidden with '*' in read mode");await testUtils.form.clickEdit(form);assert.hasAttrValue(form.$('input.o_field_char'),'type','password',"password field input should be with type 'password' in edit mode");assert.strictEqual(form.$('input.o_field_char').val(),'yop',"password field input value should be the (non-hidden) password value");form.destroy();});QUnit.test('input field: empty password',async function(assert){assert.expect(3);this.data.partner.records[0].foo=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo" password="True"/>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_field_char').text(),"","password field value should be empty in read mode");await testUtils.form.clickEdit(form);assert.hasAttrValue(form.$('input.o_field_char'),'type','password',"password field input should be with type 'password' in edit mode");assert.strictEqual(form.$('input.o_field_char').val(),'',"password field input value should be the (non-hidden, empty) password value");form.destroy();});QUnit.test('input field: set and remove value, then wait for onchange',async function(assert){assert.expect(2);this.data.partner.onchanges={product_id(obj){obj.foo=obj.product_id?"onchange value":false;},};let def;const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="p">
                        <tree editable="bottom">
                            <field name="product_id"/>
                            <field name="foo"/>
                        </tree>
                    </field>
                </form>`,async mockRPC(route,args){const result=this._super(...arguments);if(args.method==="onchange"){await Promise.resolve(def);}
return result;},fieldDebounce:1000,});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('input[name="foo"]').val(),"");await testUtils.fields.editInput(form.$('input[name="foo"]'),"test");await testUtils.fields.editInput(form.$('input[name="foo"]'),"");await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');assert.strictEqual(form.$('input[name="foo"]').val(),'onchange value','input should contain correct value after onchange');form.destroy();});QUnit.module('UrlWidget');QUnit.test('url widget in form view',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" widget="url"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'a.o_form_uri.o_field_widget.o_text_overflow',"should have a anchor with correct classes");assert.hasAttrValue(form.$('a.o_form_uri.o_field_widget.o_text_overflow'),'href','http://yop',"should have proper href link");assert.hasAttrValue(form.$('a.o_form_uri.o_field_widget.o_text_overflow'),'target','_blank',"should have target attribute set to _blank");assert.strictEqual(form.$('a.o_form_uri.o_field_widget.o_text_overflow').text(),'yop',"the value should be displayed properly");await testUtils.form.clickEdit(form);assert.containsOnce(form,'input[type="text"].o_field_widget',"should have an input for the char field");assert.strictEqual(form.$('input[type="text"].o_field_widget').val(),'yop',"input should contain field value in edit mode");testUtils.fields.editInput(form.$('input[type="text"].o_field_widget'),'limbo');await testUtils.form.clickSave(form);assert.containsOnce(form,'a.o_form_uri.o_field_widget.o_text_overflow',"should still have a anchor with correct classes");assert.hasAttrValue(form.$('a.o_form_uri.o_field_widget.o_text_overflow'),'href','http://limbo',"should have proper new href link");assert.strictEqual(form.$('a.o_form_uri.o_field_widget.o_text_overflow').text(),'limbo','the new value should be displayed');form.destroy();});QUnit.test('url widget takes text from proper attribute',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" widget="url" text="kebeclibre"/>'+'</form>',res_id:1,});assert.strictEqual(form.$('a[name="foo"]').text(),'kebeclibre',"url text should come from the text attribute");form.destroy();});QUnit.test('url widget: href attribute and website_path option',async function(assert){assert.expect(4);this.data.partner.fields.url1={string:"Url 1",type:"char",default:"www.url1.com"};this.data.partner.fields.url2={string:"Url 2",type:"char",default:"www.url2.com"};this.data.partner.fields.url3={string:"Url 3",type:"char",default:"http://www.url3.com"};this.data.partner.fields.url4={string:"Url 4",type:"char",default:"https://url4.com"};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="url1" widget="url"/>
                    <field name="url2" widget="url" options="{'website_path': True}"/>
                    <field name="url3" widget="url"/>
                    <field name="url4" widget="url"/>
                </form>`,res_id:1,});assert.strictEqual(form.$('a[name="url1"]').attr('href'),'http://www.url1.com');assert.strictEqual(form.$('a[name="url2"]').attr('href'),'www.url2.com');assert.strictEqual(form.$('a[name="url3"]').attr('href'),'http://www.url3.com');assert.strictEqual(form.$('a[name="url4"]').attr('href'),'https://url4.com');form.destroy();});QUnit.test('char field in editable list view',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="foo" widget="url"/></tree>',});assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').length,5,"should have 5 cells");assert.containsN(list,'a.o_form_uri.o_field_widget.o_text_overflow',5,"should have 5 anchors with correct classes");assert.hasAttrValue(list.$('a.o_form_uri.o_field_widget.o_text_overflow').first(),'href','http://yop',"should have proper href link");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').first().text(),'yop',"value should be displayed properly as text");var $cell=list.$('tbody td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.hasClass($cell.parent(),'o_selected_row','should be set as edit mode');assert.strictEqual($cell.find('input').val(),'yop','should have the corect value in internal input');await testUtils.fields.editInput($cell.find('input'),'brolo');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));$cell=list.$('tbody td:not(.o_list_record_selector)').first();assert.doesNotHaveClass($cell.parent(),'o_selected_row','should not be in edit mode anymore');assert.containsN(list,'a.o_form_uri.o_field_widget.o_text_overflow',5,"should still have 5 anchors with correct classes");assert.hasAttrValue(list.$('a.o_form_uri.o_field_widget.o_text_overflow').first(),'href','http://brolo',"should have proper new href link");assert.strictEqual(list.$('a.o_form_uri.o_field_widget.o_text_overflow').first().text(),'brolo',"value should be properly updated");list.destroy();});QUnit.module('CopyClipboard');QUnit.test('Char & Text Fields: Copy to clipboard button',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div>'+'<field name="txt" widget="CopyClipboardText"/>'+'<field name="foo" widget="CopyClipboardChar"/>'+'</div>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_clipboard_button.o_btn_text_copy',"Should have copy button on text type field");assert.containsOnce(form,'.o_clipboard_button.o_btn_char_copy',"Should have copy button on char type field");form.destroy();});QUnit.test('CopyClipboard widget on unset field',async function(assert){assert.expect(1);this.data.partner.records[0].foo=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="foo" widget="CopyClipboardChar" />'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsNone(form,'.o_field_copy[name="foo"] .o_clipboard_button',"foo (unset) should not contain a button");form.destroy();});QUnit.test('CopyClipboard widget on readonly unset fields in create mode',async function(assert){assert.expect(1);this.data.partner.fields.display_name.readonly=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="display_name" widget="CopyClipboardChar" />'+'</group>'+'</sheet>'+'</form>',});assert.containsNone(form,'.o_field_copy[name="display_name"] .o_clipboard_button',"the readonly unset field should not contain a button");form.destroy();});QUnit.module('FieldText');QUnit.test('text fields are correctly rendered',async function(assert){assert.expect(7);this.data.partner.fields.foo.type='text';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="foo"/>'+'</form>',res_id:1,});assert.ok(form.$('.o_field_text').length,"should have a text area");assert.strictEqual(form.$('.o_field_text').text(),'yop','should be "yop" in readonly');await testUtils.form.clickEdit(form);var $textarea=form.$('textarea.o_field_text');assert.ok($textarea.length,"should have a text area");assert.strictEqual($textarea.val(),'yop','should still be "yop" in edit');testUtils.fields.editInput($textarea,'hello');assert.strictEqual($textarea.val(),'hello','should be "hello" after first edition');testUtils.fields.editInput($textarea,'hello world');assert.strictEqual($textarea.val(),'hello world','should be "hello world" after second edition');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_text').text(),'hello world','should be "hello world" after save');form.destroy();});QUnit.test('text fields in edit mode have correct height',async function(assert){assert.expect(2);this.data.partner.fields.foo.type='text';this.data.partner.records[0].foo="f\nu\nc\nk\nm\ni\nl\ng\nr\no\nm";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,});var $field=form.$('.o_field_text');assert.strictEqual($field[0].offsetHeight,$field[0].scrollHeight,"text field should not have a scroll bar");await testUtils.form.clickEdit(form);var $textarea=form.$('textarea:first');assert.strictEqual($textarea[0].clientHeight,$textarea[0].scrollHeight,"textarea should not have a scroll bar");form.destroy();});QUnit.test('text fields in edit mode, no vertical resize',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="txt"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);var $textarea=form.$('textarea:first');assert.strictEqual($textarea.css('resize'),'none',"should not have vertical resize");form.destroy();});QUnit.test('text fields should have correct height after onchange',async function(assert){assert.expect(2);const damnLongText=`Lorem ipsum dolor sit amet, consectetur adipiscing elit.
            Donec est massa, gravida eget dapibus ac, eleifend eget libero.
            Suspendisse feugiat sed massa eleifend vestibulum. Sed tincidunt
            velit sed lacinia lacinia. Nunc in fermentum nunc. Vestibulum ante
            ipsum primis in faucibus orci luctus et ultrices posuere cubilia
            Curae; Nullam ut nisi a est ornare molestie non vulputate orci.
            Nunc pharetra porta semper. Mauris dictum eu nulla a pulvinar. Duis
            eleifend odio id ligula congue sollicitudin. Curabitur quis aliquet
            nunc, ut aliquet enim. Suspendisse malesuada felis non metus
            efficitur aliquet.`;this.data.partner.records[0].txt=damnLongText;this.data.partner.records[0].bar=false;this.data.partner.onchanges={bar:function(obj){obj.txt=damnLongText;},};const form=await createView({arch:`
                <form string="Partners">
                    <field name="bar"/>
                    <field name="txt" attrs="{'invisible': [('bar', '=', True)]}"/>
                </form>`,data:this.data,model:'partner',res_id:1,View:FormView,viewOptions:{mode:'edit'},});const textarea=form.el.querySelector('textarea[name="txt"]');const initialHeight=textarea.offsetHeight;await testUtils.fields.editInput($(textarea),'Short value');assert.ok(textarea.offsetHeight<initialHeight,"Textarea height should have shrank");await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));assert.strictEqual(textarea.offsetHeight,initialHeight,"Textarea height should be reset");form.destroy();});QUnit.test('text fields in editable list have correct height',async function(assert){assert.expect(2);this.data.partner.records[0].txt="a\nb\nc\nd\ne\nf";var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<list editable="top">'+'<field name="foo"/>'+'<field name="txt"/>'+'</list>',});await testUtils.dom.click(list.$('.o_data_cell:first'));var $textarea=list.$('textarea:first');assert.strictEqual($textarea.val(),this.data.partner.records[0].txt);assert.strictEqual($textarea[0].clientHeight,$textarea[0].scrollHeight,"textarea should not have a scroll bar");list.destroy();});QUnit.test('text fields in edit mode should resize on reset',async function(assert){assert.expect(1);this.data.partner.fields.foo.type='text';this.data.partner.onchanges={bar:function(obj){obj.foo='a\nb\nc\nd\ne\nf';},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="bar"/>'+'<field name="foo"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('div[name="bar"] input'));var $textarea=form.$('textarea:first');assert.strictEqual($textarea.innerHeight(),$textarea[0].scrollHeight,"textarea should not have a scroll bar");form.destroy();});QUnit.test('text field translatable',async function(assert){assert.expect(3);this.data.partner.fields.txt.translate=true;var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="txt"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==="/web/dataset/call_button"&&args.method==='translate_fields'){assert.deepEqual(args.args,["partner",1,"txt"],'should call "call_button" route');return Promise.resolve({domain:[],context:{search_default_name:'partnes,foo'},});}
if(route==="/web/dataset/call_kw/res.lang/get_installed"){return Promise.resolve([["en_US"],["fr_BE"]]);}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);var $button=form.$('textarea + .o_field_translate');assert.strictEqual($button.length,1,"should have a translate button");await testUtils.dom.click($button);assert.containsOnce($(document),'.modal','there should be a translation modal');form.destroy();_t.database.multi_lang=multiLang;});QUnit.test('text field translatable in create mode',async function(assert){assert.expect(1);this.data.partner.fields.txt.translate=true;var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="txt"/>'+'</group>'+'</sheet>'+'</form>',});var $button=form.$('textarea + .o_field_translate');assert.strictEqual($button.length,1,"should have a translate button in create mode");form.destroy();_t.database.multi_lang=multiLang;});QUnit.test('go to next line (and not the next row) when pressing enter',async function(assert){assert.expect(4);this.data.partner.fields.foo.type='text';var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<list editable="top">'+'<field name="int_field"/>'+'<field name="foo"/>'+'<field name="qux"/>'+'</list>',});await testUtils.dom.click(list.$('tbody tr:first .o_list_text'));var $textarea=list.$('textarea.o_field_text');assert.strictEqual($textarea.length,1,"should have a text area");assert.strictEqual($textarea.val(),'yop','should still be "yop" in edit');assert.strictEqual(list.$('textarea').get(0),document.activeElement,"text area should have the focus");list.$('textarea').trigger({type:"keydown",which:$.ui.keyCode.ENTER}).trigger({type:"keyup",which:$.ui.keyCode.ENTER});assert.strictEqual(list.$('textarea').first().get(0),document.activeElement,"text area should still have the focus");list.destroy();});QUnit.test('copying text fields in RO mode should preserve line breaks',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="txt"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$('[name="txt"]').prop("tagName").toLowerCase(),'span',"the field contents should be surrounded by a span tag");form.destroy();});QUnit.module('FieldBinary');QUnit.test('binary fields are correctly rendered',async function(assert){assert.expect(16);var oldGetFile=session.get_file;session.get_file=function(option){assert.strictEqual(option.data.field,'document',"we should download the field document");assert.strictEqual(option.data.data,'coucou==\n',"we should download the correct data");option.complete();return Promise.resolve();};this.data.partner.records[0].foo='coucou.txt';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="document" filename="foo"/>'+'<field name="foo"/>'+'</form>',res_id:1,});assert.containsOnce(form,'a.o_field_widget[name="document"] > .fa-download',"the binary field should be rendered as a downloadable link in readonly");assert.strictEqual(form.$('a.o_field_widget[name="document"]').text().trim(),'coucou.txt',"the binary field should display the name of the file in the link");assert.strictEqual(form.$('.o_field_char').text(),'coucou.txt',"the filename field should have the file name as value");await testUtils.dom.click(form.$('a.o_field_widget[name="document"]'));await testUtils.form.clickEdit(form);assert.containsNone(form,'a.o_field_widget[name="document"] > .fa-download',"the binary field should not be rendered as a downloadable link in edit");assert.strictEqual(form.$('div.o_field_binary_file[name="document"] > input').val(),'coucou.txt',"the binary field should display the file name in the input edit mode");assert.hasAttrValue(form.$('.o_field_binary_file > input'),'readonly','readonly',"the input should be readonly");assert.containsOnce(form,'.o_field_binary_file > .o_clear_file_button',"there shoud be a button to clear the file");assert.strictEqual(form.$('input.o_field_char').val(),'coucou.txt',"the filename field should have the file name as value");await testUtils.dom.click(form.$('.o_field_binary_file > .o_clear_file_button'));assert.isNotVisible(form.$('.o_field_binary_file > input'),"the input should be hidden");assert.strictEqual(form.$('.o_field_binary_file > .o_select_file_button:not(.o_hidden)').length,1,"there shoud be a button to upload the file");assert.strictEqual(form.$('input.o_field_char').val(),'',"the filename field should be empty since we removed the file");await testUtils.form.clickSave(form);assert.containsNone(form,'a.o_field_widget[name="document"] > .fa-download',"the binary field should not render as a downloadable link since we removed the file");assert.strictEqual(form.$('a.o_field_widget[name="document"]').text().trim(),'',"the binary field should not display a filename in the link since we removed the file");assert.strictEqual(form.$('.o_field_char').text().trim(),'',"the filename field should be empty since we removed the file");form.destroy();session.get_file=oldGetFile;});QUnit.test('binary fields: option accepted_file_extensions',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                      <field name="document" widget="binary" options="{'accepted_file_extensions': '.dat,.bin'}"/>
                   </form>`});assert.strictEqual(form.$('input.o_input_file').attr('accept'),'.dat,.bin',"the input should have the correct ``accept`` attribute");form.destroy();});QUnit.test('binary fields that are readonly in create mode do not download',async function(assert){assert.expect(2);var oldGetFile=session.get_file;session.get_file=function(option){assert.step('We shouldn\'t be getting the file.');return oldGetFile.bind(session)(option);};this.data.partner.onchanges={product_id:function(obj){obj.document="onchange==\n";},};this.data.partner.fields.document.readonly=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="product_id"/>'+'<field name="document" filename="\'yooo\'"/>'+'</form>',res_id:1,});await testUtils.form.clickCreate(form);await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');assert.containsOnce(form,'a.o_field_widget[name="document"] > .fa-download','The link to download the binary should be present');testUtils.dom.click(form.$('a.o_field_widget[name="document"]'));assert.verifySteps([]);form.destroy();session.get_file=oldGetFile;});QUnit.module('FieldPdfViewer');QUnit.test("pdf_viewer without data",async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="document" widget="pdf_viewer"/>'+'</form>',});assert.hasClass(form.$('.o_field_widget'),'o_field_pdfviewer');assert.strictEqual(form.$('.o_select_file_button:not(.o_hidden)').length,1,"there should be a visible 'Upload' button");assert.isNotVisible(form.$('.o_field_widget iframe.o_pdfview_iframe'),"there should be an invisible iframe");assert.containsOnce(form,'input[type="file"]',"there should be one input");form.destroy();});QUnit.test("pdf_viewer: basic rendering",async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,res_id:1,arch:'<form>'+'<field name="document" widget="pdf_viewer"/>'+'</form>',mockRPC:function(route){if(route.indexOf('/web/static/lib/pdfjs/web/viewer.html')!==-1){return Promise.resolve();}
return this._super.apply(this,arguments);}});assert.hasClass(form.$('.o_field_widget'),'o_field_pdfviewer');assert.strictEqual(form.$('.o_select_file_button:not(.o_hidden)').length,0,"there should not be a any visible 'Upload' button");assert.isVisible(form.$('.o_field_widget iframe.o_pdfview_iframe'),"there should be an visible iframe");assert.hasAttrValue(form.$('.o_field_widget iframe.o_pdfview_iframe'),'data-src','/web/static/lib/pdfjs/web/viewer.html?file=%2Fweb%2Fcontent%3Fmodel%3Dpartner%26field%3Ddocument%26id%3D1#page=1',"the src attribute should be correctly set on the iframe");form.destroy();});QUnit.test("pdf_viewer: upload rendering",async function(assert){assert.expect(6);testUtils.mock.patch(field_registry.map.pdf_viewer,{on_file_change:function(ev){ev.target={files:[new Blob()]};this._super.apply(this,arguments);},_getURI:function(fileURI){this._super.apply(this,arguments);assert.step('_getURI');assert.ok(_.str.startsWith(fileURI,'blob:'));this.PDFViewerApplication={open:function(URI){assert.step('open');assert.ok(_.str.startsWith(URI,'blob:'));},};return'about:blank';},});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="document" widget="pdf_viewer"/>'+'</form>',});form.$('input[type="file"]').trigger('change');assert.verifySteps(['_getURI']);form.$('input[type="file"]').trigger('change');assert.verifySteps(['open']);testUtils.mock.unpatch(field_registry.map.pdf_viewer);form.destroy();});QUnit.test('text field rendering in list view',async function(assert){assert.expect(1);var data={foo:{fields:{foo:{string:"F",type:"text"}},records:[{id:1,foo:"some text"}]},};var list=await createView({View:ListView,model:'foo',data:data,arch:'<tree><field name="foo"/></tree>',});assert.strictEqual(list.$('tbody td.o_list_text:contains(some text)').length,1,"should have a td with the .o_list_text class");list.destroy();});QUnit.test("binary fields input value is empty whean clearing after uploading",async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="document" filename="foo"/>'+'<field name="foo"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);form.$('.o_input_file').attr('type','text').val('coucou.txt');assert.strictEqual(form.$('.o_input_file').val(),'coucou.txt',"input value should be changed to \"coucou.txt\"");await testUtils.dom.click(form.$('.o_field_binary_file > .o_clear_file_button'));assert.strictEqual(form.$('.o_input_file').val(),'',"input value should be empty");form.destroy();});QUnit.test('field text in editable list view',async function(assert){assert.expect(1);this.data.partner.fields.foo.type='text';var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree string="Phonecalls" editable="top">'+'<field name="foo"/>'+'</tree>',});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.strictEqual(list.$('textarea').first().get(0),document.activeElement,"text area should have the focus");list.destroy();});QUnit.module('FieldImage');QUnit.test('image fields are correctly rendered',async function(assert){assert.expect(7);this.data.partner.records[0].__last_update='2017-02-08 10:00:00';this.data.partner.records[0].document=MY_IMAGE;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="document" widget="image" options="{\'size\': [90, 90]}"/> '+'</form>',res_id:1,async mockRPC(route,args){if(route==='/web/dataset/call_kw/partner/read'){assert.deepEqual(args.args[1],['document','__last_update','display_name'],"The fields document, display_name and __last_update should be present when reading an image");}
if(route===`data:image/png;base64,${MY_IMAGE}`){assert.ok(true,"should called the correct route");return'wow';}
return this._super.apply(this,arguments);},});assert.hasClass(form.$('div[name="document"]'),'o_field_image',"the widget should have the correct class");assert.containsOnce(form,'div[name="document"] > img',"the widget should contain an image");assert.hasClass(form.$('div[name="document"] > img'),'img-fluid',"the image should have the correct class");assert.hasAttrValue(form.$('div[name="document"] > img'),'width',"90","the image should correctly set its attributes");assert.strictEqual(form.$('div[name="document"] > img').css('max-width'),"90px","the image should correctly set its attributes");form.destroy();});QUnit.test('image fields are correctly replaced when given an incorrect value',async function(assert){assert.expect(7);this.data.partner.records[0].__last_update='2017-02-08 10:00:00';this.data.partner.records[0].document='incorrect_base64_value';testUtils.mock.patch(basicFields.FieldBinaryImage,{async _render(){const result=this._super.apply(this,arguments);await concurrency.delay(100);return result;},});const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form string="Partners">
                    <field name="document" widget="image" options="{'size': [90, 90]}"/>
                </form>`,res_id:1,async mockRPC(route,args){const _super=this._super;if(route==='/web/static/src/img/placeholder.png'){assert.step('call placeholder route');}
return _super.apply(this,arguments);},});assert.hasClass(form.$('div[name="document"]'),'o_field_image',"the widget should have the correct class");assert.containsOnce(form,'div[name="document"] > img',"the widget should contain an image");assert.hasClass(form.$('div[name="document"] > img'),'img-fluid',"the image should have the correct class");assert.hasAttrValue(form.$('div[name="document"] > img'),'width',"90","the image should correctly set its attributes");assert.strictEqual(form.$('div[name="document"] > img').css('max-width'),"90px","the image should correctly set its attributes");assert.verifySteps(['call placeholder route']);form.destroy();testUtils.mock.unpatch(basicFields.FieldBinaryImage);});QUnit.test('image: option accepted_file_extensions',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                      <field name="document" widget="image" options="{'accepted_file_extensions': '.png,.jpeg'}"/>
                   </form>`});assert.strictEqual(form.$('input.o_input_file').attr('accept'),'.png,.jpeg',"the input should have the correct ``accept`` attribute");form.destroy();var form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                      <field name="document" widget="image"/>
                   </form>`});assert.strictEqual(form.$('input.o_input_file').attr('accept'),'image/*','the default value for the attribute "accept" on the "image" widget must be "image/*"');form.destroy();});QUnit.test('image fields in subviews are loaded correctly',async function(assert){assert.expect(6);this.data.partner.records[0].__last_update='2017-02-08 10:00:00';this.data.partner.records[0].document=MY_IMAGE;this.data.partner_type.fields.image={name:'image',type:'binary'};this.data.partner_type.records[0].image=PRODUCT_IMAGE;this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="document" widget="image" options="{\'size\': [90, 90]}"/>'+'<field name="timmy" widget="many2many">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="image" widget="image"/>'+'</form>'+'</field>'+'</form>',res_id:1,async mockRPC(route){if(route===`data:image/png;base64,${MY_IMAGE}`){assert.step("The view's image should have been fetched");return'wow';}
if(route===`data:image/gif;base64,${PRODUCT_IMAGE}`){assert.step("The dialog's image should have been fetched");return;}
return this._super.apply(this,arguments);},});assert.verifySteps(["The view's image should have been fetched"]);assert.containsOnce(form,'tr.o_data_row','There should be one record in the many2many');await testUtils.dom.click(form.$('tbody td:contains(gold)'));assert.strictEqual($('.modal').length,1,'The modal should have opened');assert.verifySteps(["The dialog's image should have been fetched"]);form.destroy();});QUnit.test('image fields in x2many list are loaded correctly',async function(assert){assert.expect(2);this.data.partner_type.fields.image={name:'image',type:'binary'};this.data.partner_type.records[0].image=PRODUCT_IMAGE;this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many">'+'<tree>'+'<field name="image" widget="image"/>'+'</tree>'+'</field>'+'</form>',res_id:1,async mockRPC(route){if(route===`data:image/gif;base64,${PRODUCT_IMAGE}`){assert.ok(true,"The list's image should have been fetched");return;}
return this._super.apply(this,arguments);},});assert.containsOnce(form,'tr.o_data_row','There should be one record in the many2many');form.destroy();});QUnit.test('image fields with required attribute',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="document" required="1" widget="image"/>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){throw new Error("Should not do a create RPC with unset required image field");}
return this._super.apply(this,arguments);},});await testUtils.form.clickSave(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable',"form view should still be editable");assert.hasClass(form.$('.o_field_widget'),'o_field_invalid',"image field should be displayed as invalid");form.destroy();});QUnit.module('FieldChar-ImageUrlWidget',{beforeEach:function(){this.data.partner.records.push({id:6,bar:false,foo:FR_FLAG_URL,int_field:5,qux:0.0,timmy:[]});},});QUnit.test('image fields are correctly rendered',async function(assert){assert.expect(6);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" widget="image_url" options="{\'size\': [90, 90]}"/> '+'</form>',res_id:6,async mockRPC(route,args){if(route===FR_FLAG_URL){assert.ok(true,"the correct route should have been called.");}
return this._super.apply(this,arguments);},});assert.hasClass(form.$('div[name="foo"]'),'o_field_image',"the widget should have the correct class");assert.containsOnce(form,'div[name="foo"] > img',"the widget should contain an image");assert.hasClass(form.$('div[name="foo"] > img'),'img-fluid',"the image should have the correct class");assert.hasAttrValue(form.$('div[name="foo"] > img'),'width',"90","the image should correctly set its attributes");assert.strictEqual(form.$('div[name="foo"] > img').css('max-width'),"90px","the image should correctly set its attributes");form.destroy();});QUnit.test('image_url widget in subviews are loaded correctly',async function(assert){assert.expect(6);this.data.partner_type.fields.image={name:'image',type:'char'};this.data.partner_type.records[0].image=EN_FLAG_URL;this.data.partner.records[5].timmy=[12];const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" widget="image_url" options="{\'size\': [90, 90]}"/>'+'<field name="timmy" widget="many2many">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="image" widget="image_url"/>'+'</form>'+'</field>'+'</form>',res_id:6,async mockRPC(route){if(route===FR_FLAG_URL){assert.step("The view's image should have been fetched");return'wow';}
if(route===EN_FLAG_URL){assert.step("The dialog's image should have been fetched");return;}
return this._super.apply(this,arguments);},});assert.verifySteps(["The view's image should have been fetched"]);assert.containsOnce(form,'tr.o_data_row','There should be one record in the many2many');await testUtils.dom.click(form.$('tbody td:contains(gold)'));assert.strictEqual($('.modal').length,1,'The modal should have opened');assert.verifySteps(["The dialog's image should have been fetched"]);form.destroy();});QUnit.test('image fields in x2many list are loaded correctly',async function(assert){assert.expect(2);this.data.partner_type.fields.image={name:'image',type:'char'};this.data.partner_type.records[0].image=EN_FLAG_URL;this.data.partner.records[5].timmy=[12];const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many">'+'<tree>'+'<field name="image" widget="image_url"/>'+'</tree>'+'</field>'+'</form>',res_id:6,async mockRPC(route){if(route===EN_FLAG_URL){assert.ok(true,"The list's image should have been fetched");return;}
return this._super.apply(this,arguments);},});assert.containsOnce(form,'tr.o_data_row','There should be one record in the many2many');form.destroy();});QUnit.module('JournalDashboardGraph',{beforeEach:function(){_.extend(this.data.partner.fields,{graph_data:{string:"Graph Data",type:"text"},graph_type:{string:"Graph Type",type:"selection",selection:[['line','Line'],['bar','Bar']]},});this.data.partner.records[0].graph_type="bar";this.data.partner.records[1].graph_type="line";var graph_values=[{'value':300,'label':'5-11 Dec'},{'value':500,'label':'12-18 Dec'},{'value':100,'label':'19-25 Dec'},];this.data.partner.records[0].graph_data=JSON.stringify([{color:'red',title:'Partner 0',values:graph_values,key:'A key',area:true,}]);this.data.partner.records[1].graph_data=JSON.stringify([{color:'blue',title:'Partner 1',values:graph_values,key:'A key',area:true,}]);},});QUnit.test('graph dashboard widget attach/detach callbacks',async function(assert){var done=assert.async();assert.expect(6);testUtils.mock.patch(JournalDashboardGraph,{on_attach_callback:function(){assert.step('on_attach_callback');},on_detach_callback:function(){assert.step('on_detach_callback');},});createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="graph_type"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="graph_data" t-att-graph_type="record.graph_type.raw_value" widget="dashboard_graph"/>'+'</div>'+'</t>'+'</templates></kanban>',domain:[['id','in',[1,2]]],}).then(function(kanban){assert.verifySteps(['on_attach_callback','on_attach_callback']);kanban.on_detach_callback();assert.verifySteps(['on_detach_callback','on_detach_callback']);kanban.destroy();testUtils.mock.unpatch(JournalDashboardGraph);done();});});QUnit.test('graph dashboard widget is rendered correctly',async function(assert){var done=assert.async();assert.expect(3);createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="graph_type"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="graph_data" t-att-graph_type="record.graph_type.raw_value" widget="dashboard_graph"/>'+'</div>'+'</t>'+'</templates></kanban>',domain:[['id','in',[1,2]]],}).then(function(kanban){concurrency.delay(0).then(function(){assert.strictEqual(kanban.$('.o_kanban_record:first() .o_graph_barchart').length,1,"graph of first record should be a barchart");assert.strictEqual(kanban.$('.o_kanban_record:nth(1) .o_dashboard_graph').length,1,"graph of second record should be a linechart");var firstRecordState=kanban.model.get(kanban.handle).data[0];return kanban.renderer.updateRecord(firstRecordState);}).then(function(){return concurrency.delay(0);}).then(function(){assert.strictEqual(kanban.$('.o_kanban_record:first() canvas').length,1,"there should be only one rendered graph by record");kanban.destroy();done();});});});QUnit.test('rendering of a field with dashboard_graph widget in an updated kanban view (ungrouped)',async function(assert){var done=assert.async();assert.expect(2);createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="graph_type"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="graph_data" t-att-graph_type="record.graph_type.raw_value" widget="dashboard_graph"/>'+'</div>'+'</t>'+'</templates></kanban>',domain:[['id','in',[1,2]]],}).then(function(kanban){concurrency.delay(0).then(function(){assert.containsN(kanban,'.o_dashboard_graph canvas',2,"there should be two graph rendered");return kanban.update({});}).then(function(){return concurrency.delay(0);}).then(function(){assert.containsN(kanban,'.o_dashboard_graph canvas',2,"there should be one graph rendered");kanban.destroy();done();});});});QUnit.test('rendering of a field with dashboard_graph widget in an updated kanban view (grouped)',async function(assert){var done=assert.async();assert.expect(2);createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="graph_type"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="graph_data" t-att-graph_type="record.graph_type.raw_value" widget="dashboard_graph"/>'+'</div>'+'</t>'+'</templates></kanban>',domain:[['id','in',[1,2]]],}).then(function(kanban){concurrency.delay(0).then(function(){assert.containsN(kanban,'.o_dashboard_graph canvas',2,"there should be two graph rendered");return kanban.update({groupBy:['selection'],domain:[['int_field','=',10]]});}).then(function(){assert.containsOnce(kanban,'.o_dashboard_graph canvas',"there should be one graph rendered");kanban.destroy();done();});});});QUnit.module('AceEditor');QUnit.test('ace widget on text fields works',async function(assert){assert.expect(2);var done=assert.async();this.data.partner.fields.foo.type='text';testUtils.createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" widget="ace"/>'+'</form>',res_id:1,}).then(function(form){assert.ok('ace'in window,"the ace library should be loaded");assert.ok(form.$('div.ace_content').length,"should have rendered something with ace editor");form.destroy();done();});});QUnit.module('HandleWidget');QUnit.test('handle widget in x2m',async function(assert){assert.expect(6);this.data.partner.records[0].p=[2,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="sequence" widget="handle"/>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.strictEqual(form.$('td span.o_row_handle').text(),"","handle should not have any content");assert.notOk(form.$('td span.o_row_handle').is(':visible'),"handle should be invisible in readonly mode");assert.containsN(form,'span.o_row_handle',2,"should have 2 handles");await testUtils.form.clickEdit(form);assert.hasClass(form.$('td:first'),'o_handle_cell',"column widget should be displayed in css class");assert.ok(form.$('td span.o_row_handle').is(':visible'),"handle should be visible in readonly mode");testUtils.dom.click(form.$('td').eq(1));assert.containsOnce(form,'td:first span.o_row_handle',"content of the cell should have been replaced");form.destroy();});QUnit.test('handle widget with falsy values',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree>'+'<field name="sequence" widget="handle"/>'+'<field name="display_name"/>'+'</tree>',});assert.containsN(list,'.o_row_handle:visible',this.data.partner.records.length,'there should be a visible handle for each record');list.destroy();});QUnit.module('FieldDateRange');QUnit.test('Datetime field [REQUIRE FOCUS]',async function(assert){assert.expect(20);this.data.partner.fields.datetime_end={string:'Datetime End',type:'datetime'};this.data.partner.records[0].datetime_end='2017-03-13 00:00:00';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="datetime" widget="daterange" options="{\'related_end_date\': \'datetime_end\'}"/>'+'<field name="datetime_end" widget="daterange" options="{\'related_start_date\': \'datetime\'}"/>'+'</form>',res_id:1,session:{getTZOffset:function(){return 330;},},});assert.strictEqual(form.$('.o_field_date_range:first').text(),'02/08/2017 15:30:00',"the start date should be correctly displayed in readonly");assert.strictEqual(form.$('.o_field_date_range:last').text(),'03/13/2017 05:30:00',"the end date should be correctly displayed in readonly");await testUtils.form.clickEdit(form);assert.containsN(document.body,'.daterangepicker',2,"should initialize 2 date range picker");assert.strictEqual($('.daterangepicker:first').css('display'),'block',"date range picker should be opened initially");assert.strictEqual($('.daterangepicker:last').css('display'),'none',"date range picker should be closed initially");assert.strictEqual($('.daterangepicker:first .drp-calendar.left .active.start-date').text(),'8',"active start date should be '8' in date range picker");assert.strictEqual($('.daterangepicker:first .drp-calendar.left .hourselect').val(),'15',"active start date hour should be '15' in date range picker");assert.strictEqual($('.daterangepicker:first .drp-calendar.left .minuteselect').val(),'30',"active start date minute should be '30' in date range picker");assert.strictEqual($('.daterangepicker:first .drp-calendar.right .active.end-date').text(),'13',"active end date should be '13' in date range picker");assert.strictEqual($('.daterangepicker:first .drp-calendar.right .hourselect').val(),'5',"active end date hour should be '5' in date range picker");assert.strictEqual($('.daterangepicker:first .drp-calendar.right .minuteselect').val(),'30',"active end date minute should be '30' in date range picker");assert.containsN($('.daterangepicker:first .drp-calendar.left .minuteselect'),'option',12,"minute selection should contain 12 options (1 for each 5 minutes)");await testUtils.dom.click($('.daterangepicker:first .cancelBtn'));assert.strictEqual($('.daterangepicker:first').css('display'),'none',"date range picker should be closed");await testUtils.dom.click(form.$('.o_field_date_range:last'));assert.strictEqual($('.daterangepicker:last').css('display'),'block',"date range picker should be opened");assert.strictEqual($('.daterangepicker:last .drp-calendar.left .active.start-date').text(),'8',"active start date should be '8' in date range picker");assert.strictEqual($('.daterangepicker:last .drp-calendar.left .hourselect').val(),'15',"active start date hour should be '15' in date range picker");assert.strictEqual($('.daterangepicker:last .drp-calendar.left .minuteselect').val(),'30',"active start date minute should be '30' in date range picker");assert.strictEqual($('.daterangepicker:last .drp-calendar.right .active.end-date').text(),'13',"active end date should be '13' in date range picker");assert.strictEqual($('.daterangepicker:last .drp-calendar.right .hourselect').val(),'5',"active end date hour should be '5' in date range picker");assert.strictEqual($('.daterangepicker:last .drp-calendar.right .minuteselect').val(),'30',"active end date minute should be '30' in date range picker");form.destroy();});QUnit.test('Date field [REQUIRE FOCUS]',async function(assert){assert.expect(18);this.data.partner.fields.date_end={string:'Date End',type:'date'};this.data.partner.records[0].date_end='2017-02-08';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="date" widget="daterange" options="{\'related_end_date\': \'date_end\'}"/>'+'<field name="date_end" widget="daterange" options="{\'related_start_date\': \'date\'}"/>'+'</form>',res_id:1,session:{getTZOffset:function(){return 330;},},});assert.strictEqual(form.$('.o_field_date_range:first').text(),'02/03/2017',"the start date should be correctly displayed in readonly");assert.strictEqual(form.$('.o_field_date_range:last').text(),'02/08/2017',"the end date should be correctly displayed in readonly");await testUtils.form.clickEdit(form);assert.containsN(document.body,'.daterangepicker',2,"should initialize 2 date range picker");assert.strictEqual($('.daterangepicker:first').css('display'),'block',"date range picker should be opened initially");assert.strictEqual($('.daterangepicker:last').css('display'),'none',"date range picker should be closed initially");assert.strictEqual($('.daterangepicker:first .active.start-date').text(),'3',"active start date should be '3' in date range picker");assert.strictEqual($('.daterangepicker:first .active.end-date').text(),'8',"active end date should be '8' in date range picker");await testUtils.dom.triggerMouseEvent($('.daterangepicker:first .drp-calendar.left .available:contains("16")'),'mousedown');await testUtils.dom.triggerMouseEvent($('.daterangepicker:first .drp-calendar.right .available:contains("12")'),'mousedown');await testUtils.dom.click($('.daterangepicker:first .applyBtn'));assert.strictEqual($('.daterangepicker:first').css('display'),'none',"date range picker should be closed");assert.strictEqual(form.$('.o_field_date_range:first').val(),'02/16/2017',"the date should be '02/16/2017'");assert.strictEqual(form.$('.o_field_date_range:last').val(),'03/12/2017',"'the date should be '03/12/2017'");await testUtils.dom.click(form.$('.o_field_date_range:last'));assert.strictEqual($('.daterangepicker:last').css('display'),'block',"date range picker should be opened");assert.strictEqual($('.daterangepicker:last .active.start-date').text(),'16',"start date should be a 16 in date range picker");assert.strictEqual($('.daterangepicker:last .active.end-date').text(),'12',"end date should be a 12 in date range picker");await testUtils.dom.triggerMouseEvent($('.daterangepicker:last .drp-calendar.left .available:contains("13")'),'mousedown');await testUtils.dom.triggerMouseEvent($('.daterangepicker:last .drp-calendar.right .available:contains("18")'),'mousedown');await testUtils.dom.click($('.daterangepicker:last .applyBtn'));assert.strictEqual($('.daterangepicker:last').css('display'),'none',"date range picker should be closed");assert.strictEqual(form.$('.o_field_date_range:first').val(),'02/13/2017',"the start date should be '02/13/2017'");assert.strictEqual(form.$('.o_field_date_range:last').val(),'03/18/2017',"the end date should be '03/18/2017'");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_date_range:first').text(),'02/13/2017',"the start date should be '02/13/2017' after save");assert.strictEqual(form.$('.o_field_date_range:last').text(),'03/18/2017',"the end date should be '03/18/2017' after save");form.destroy();});QUnit.test('daterangepicker should disappear on scrolling outside of it',async function(assert){assert.expect(2);this.data.partner.fields.datetime_end={string:'Datetime End',type:'datetime'};this.data.partner.records[0].datetime_end='2017-03-13 00:00:00';const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="datetime" widget="daterange" options="{'related_end_date': 'datetime_end'}"/>
                    <field name="datetime_end" widget="daterange" options="{'related_start_date': 'datetime'}"/>
                </form>`,res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_date_range:first'));assert.isVisible($('.daterangepicker:first'),"date range picker should be opened");form.el.dispatchEvent(new Event('scroll'));assert.isNotVisible($('.daterangepicker:first'),"date range picker should be closed");form.destroy();});QUnit.test('Datetime field manually input value should send utc value to server',async function(assert){assert.expect(4);this.data.partner.fields.datetime_end={string:'Datetime End',type:'datetime'};this.data.partner.records[0].datetime_end='2017-03-13 00:00:00';const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="datetime" widget="daterange" options="{'related_end_date': 'datetime_end'}"/>
                    <field name="datetime_end" widget="daterange" options="{'related_start_date': 'datetime'}"/>
                </form>`,res_id:1,session:{getTZOffset:function(){return 330;},},mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{datetime:'2017-02-08 06:00:00'});}
return this._super(...arguments);},});assert.strictEqual(form.$('.o_field_date_range:first').text(),'02/08/2017 15:30:00',"the start date should be correctly displayed in readonly");assert.strictEqual(form.$('.o_field_date_range:last').text(),'03/13/2017 05:30:00',"the end date should be correctly displayed in readonly");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('.o_field_date_range:first'),'02/08/2017 11:30:00');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_date_range:first').text(),'02/08/2017 11:30:00',"the start date should be correctly displayed in readonly after manual update");form.destroy();});QUnit.module('FieldDate');QUnit.test('date field: toggle datepicker [REQUIRE FOCUS]',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="foo"/><field name="date"/></form>',translateParameters:{date_format:'%m/%d/%Y',},});assert.strictEqual($('.bootstrap-datetimepicker-widget:visible').length,0,"datepicker should be closed initially");await testUtils.dom.openDatepicker(form.$('.o_datepicker'));assert.strictEqual($('.bootstrap-datetimepicker-widget:visible').length,1,"datepicker should be opened");await testUtils.dom.click(form.$('.o_field_widget[name=foo]').focus().mouseenter());assert.strictEqual($('.bootstrap-datetimepicker-widget:visible').length,0,"datepicker should close itself when the user clicks outside");form.destroy();});QUnit.test('date field: toggle datepicker far in the future',async function(assert){assert.expect(3);this.data.partner.records=[{id:1,date:"9999-12-30",foo:"yop",}]
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="foo"/><field name="date"/></form>',translateParameters:{date_format:'%m/%d/%Y',},res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual($('.bootstrap-datetimepicker-widget:visible').length,0,"datepicker should be closed initially");testUtils.openDatepicker(form.$('.o_datepicker'));assert.strictEqual($('.bootstrap-datetimepicker-widget:visible').length,1,"datepicker should be opened");form.$('.o_field_widget[name=foo]').click().focus();assert.strictEqual($('.bootstrap-datetimepicker-widget:visible').length,0,"datepicker should close itself when the user clicks outside");form.destroy();});QUnit.test('date field is empty if no date is set',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:4,});var $span=form.$('span.o_field_widget');assert.strictEqual($span.length,1,"should have one span in the form view");assert.strictEqual($span.text(),"","and it should be empty");form.destroy();});QUnit.test('date field: set an invalid date when the field is already set',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:1,viewOptions:{mode:'edit',},});var $input=form.$('.o_field_widget[name=date] input');assert.strictEqual($input.val(),"02/03/2017");$input.val('mmmh').trigger('change');assert.strictEqual($input.val(),"02/03/2017","should have reset the original value");form.destroy();});QUnit.test('date field: set an invalid date when the field is not set yet',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:4,viewOptions:{mode:'edit',},});var $input=form.$('.o_field_widget[name=date] input');assert.strictEqual($input.text(),"");$input.val('mmmh').trigger('change');assert.strictEqual($input.text(),"","The date field should be empty");form.destroy();});QUnit.test('date field value should not set on first click',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:4,});await testUtils.form.clickEdit(form);testUtils.dom.openDatepicker(form.$('.o_datepicker'));assert.strictEqual(form.$('.o_datepicker_input').val(),'',"date field's input should be empty on first click");testUtils.dom.click($('.day:contains(22)'));testUtils.dom.openDatepicker(form.$('.o_datepicker'));assert.strictEqual($('.day.active').text(),'22',"datepicker should be highlight with 22nd day of month");form.destroy();});QUnit.test('date field in form view (with positive time zone offset)',async function(assert){assert.expect(8);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[1].date,'2017-02-22','the correct value should be saved');}
return this._super.apply(this,arguments);},translateParameters:{date_format:'%m/%d/%Y',},session:{getTZOffset:function(){return 120;},},});assert.strictEqual(form.$('.o_field_date').text(),'02/03/2017','the date should be correctly displayed in readonly');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_datepicker_input').val(),'02/03/2017','the date should be correct in edit mode');testUtils.dom.openDatepicker(form.$('.o_datepicker'));assert.ok($('.bootstrap-datetimepicker-widget').length,'datepicker should be open');assert.strictEqual($('.day.active').data('day'),'02/03/2017','datepicker should be highlight February 3');testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch').first());testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch:eq(1)').first());testUtils.dom.click($('.bootstrap-datetimepicker-widget .year:contains(2017)'));testUtils.dom.click($('.bootstrap-datetimepicker-widget .month').eq(1));testUtils.dom.click($('.day:contains(22)'));assert.ok(!$('.bootstrap-datetimepicker-widget').length,'datepicker should be closed');assert.strictEqual(form.$('.o_datepicker_input').val(),'02/22/2017','the selected date should be displayed in the input');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_date').text(),'02/22/2017','the selected date should be displayed after saving');form.destroy();});QUnit.test('date field in form view (with negative time zone offset)',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:1,translateParameters:{date_format:'%m/%d/%Y',},session:{getTZOffset:function(){return-120;},},});assert.strictEqual(form.$('.o_field_date').text(),'02/03/2017','the date should be correctly displayed in readonly');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_datepicker_input').val(),'02/03/2017','the date should be correct in edit mode');form.destroy();});QUnit.test('date field dropdown disappears on scroll',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div class="scrollable" style="height: 2000px;">'+'<field name="date"/>'+'</div>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.openDatepicker(form.$('.o_datepicker'));assert.containsOnce($('body'),'.bootstrap-datetimepicker-widget',"datepicker should be opened");form.el.dispatchEvent(new Event('wheel'));assert.containsNone($('body'),'.bootstrap-datetimepicker-widget',"datepicker should be closed");form.destroy();});QUnit.test('date field with warn_future option',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="date" options="{\'datepicker\': {\'warn_future\': true}}"/>'+'</form>',res_id:4,});await testUtils.form.clickEdit(form);await testUtils.dom.openDatepicker(form.$('.o_datepicker'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch').first());await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch:eq(1)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .year').eq(11));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .month').eq(11));await testUtils.dom.click($('.day:contains(31)'));var $warn=form.$('.o_datepicker_warning:visible');assert.strictEqual($warn.length,1,"should have a warning in the form view");await testUtils.fields.editSelect(form.$('.o_field_widget[name=date] input'),'');$warn=form.$('.o_datepicker_warning:visible');assert.strictEqual($warn.length,0,"the warning in the form view should be hidden");form.destroy();});QUnit.test('date field with warn_future option: do not overwrite datepicker option',async function(assert){assert.expect(2);this.data.partner.fields.date.default=undefined;this.data.partner.onchanges={};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" />'+'<field name="date" options="{\'datepicker\': {\'warn_future\': true}}"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name="date"]').val(),'02/03/2017','The existing record should have a value for the date field');await testUtils.form.clickSave(form);await testUtils.form.clickCreate(form);assert.notOk(form.$('input[name="date"]').val(),'The new record should not have a value that the framework would have set');form.destroy();});QUnit.test('date field in editable list view',async function(assert){assert.expect(8);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="date"/>'+'</tree>',translateParameters:{date_format:'%m/%d/%Y',},session:{getTZOffset:function(){return 0;},},});var $cell=list.$('tr.o_data_row td:not(.o_list_record_selector)').first();assert.strictEqual($cell.text(),'02/03/2017','the date should be displayed correctly in readonly');await testUtils.dom.click($cell);assert.containsOnce(list,'input.o_datepicker_input',"the view should have a date input for editable mode");assert.strictEqual(list.$('input.o_datepicker_input').get(0),document.activeElement,"date input should have the focus");assert.strictEqual(list.$('input.o_datepicker_input').val(),'02/03/2017','the date should be correct in edit mode');await testUtils.dom.openDatepicker(list.$('.o_datepicker'));assert.ok($('.bootstrap-datetimepicker-widget').length,'datepicker should be open');await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch').first());await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch:eq(1)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .year:contains(2017)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .month').eq(1));await testUtils.dom.click($('.day:contains(22)'));assert.ok(!$('.bootstrap-datetimepicker-widget').length,'datepicker should be closed');assert.strictEqual(list.$('.o_datepicker_input').val(),'02/22/2017','the selected date should be displayed in the input');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('tr.o_data_row td:not(.o_list_record_selector)').text(),'02/22/2017','the selected date should be displayed after saving');list.destroy();});QUnit.test('date field remove value',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[1].date,false,'the correct value should be saved');}
return this._super.apply(this,arguments);},translateParameters:{date_format:'%m/%d/%Y',},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_datepicker_input').val(),'02/03/2017','the date should be correct in edit mode');await testUtils.fields.editAndTrigger(form.$('.o_datepicker_input'),'',['input','change','focusout']);assert.strictEqual(form.$('.o_datepicker_input').val(),'','should have correctly removed the value');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_date').text(),'','the selected date should be displayed after saving');form.destroy();});QUnit.test('do not trigger a field_changed for datetime field with date widget',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="datetime" widget="date"/></form>',translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.o_datepicker_input').val(),'02/08/2017','the date should be correct');testUtils.fields.editAndTrigger(form.$('input[name="datetime"]'),'02/08/2017',['input','change','focusout']);await testUtils.form.clickSave(form);assert.verifySteps(['read']);form.destroy();});QUnit.test('field date should select its content onclick when there is one',async function(assert){assert.expect(2);var done=assert.async();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="date"/></form>',res_id:1,viewOptions:{mode:'edit',},});form.$el.on({'show.datetimepicker':function(){assert.ok($('.bootstrap-datetimepicker-widget').is(':visible'),'bootstrap-datetimepicker is visible');assert.strictEqual(window.getSelection().toString(),"02/03/2017",'The whole input of the date field should have been selected');done();}});testUtils.dom.openDatepicker(form.$('.o_datepicker'));form.destroy();});QUnit.test('date field support internalization',async function(assert){assert.expect(2);var originalLocale=moment.locale();var originalParameters=_.clone(core._t.database.parameters);_.extend(core._t.database.parameters,{date_format:'%d. %b %Y',time_format:'%H:%M:%S'});moment.defineLocale('norvegianForTest',{monthsShort:'jan._feb._mars_april_mai_juni_juli_aug._sep._okt._nov._des.'.split('_'),monthsParseExact:true,dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:'%d.',});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:1,});var dateViewForm=form.$('.o_field_date').text();await testUtils.dom.click(form.$buttons.find('.o_form_button_edit'));await testUtils.openDatepicker(form.$('.o_datepicker'));assert.strictEqual(form.$('.o_datepicker_input').val(),dateViewForm,"input date field should be the same as it was in the view form");await testUtils.dom.click($('.day:contains(30)'));var dateEditForm=form.$('.o_datepicker_input').val();await testUtils.dom.click(form.$buttons.find('.o_form_button_save'));assert.strictEqual(form.$('.o_field_date').text(),dateEditForm,"date field should be the same as the one selected in the view form");moment.locale(originalLocale);moment.updateLocale('norvegianForTest',null);core._t.database.parameters=originalParameters;form.destroy();});QUnit.test('date field: hit enter should update value',async function(assert){assert.expect(2);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"/></form>',res_id:1,translateParameters:{date_format:'%m/%d/%Y',},viewOptions:{mode:'edit',},});const year=(new Date()).getFullYear();await testUtils.fields.editInput(form.el.querySelector('input[name="date"]'),'01/08');await testUtils.fields.triggerKeydown(form.el.querySelector('input[name="date"]'),'enter');assert.strictEqual(form.el.querySelector('input[name="date"]').value,'01/08/'+year);await testUtils.fields.editInput(form.el.querySelector('input[name="date"]'),'08/01');await testUtils.fields.triggerKeydown(form.el.querySelector('input[name="date"]'),'enter');assert.strictEqual(form.el.querySelector('input[name="date"]').value,'08/01/'+year);form.destroy();});QUnit.module('FieldDatetime');QUnit.test('datetime field in form view',async function(assert){assert.expect(7);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="datetime"/></form>',res_id:1,translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},session:{getTZOffset:function(){return 120;},},});var expectedDateString="02/08/2017 12:00:00";assert.strictEqual(form.$('.o_field_date').text(),expectedDateString,'the datetime should be correctly displayed in readonly');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_datepicker_input').val(),expectedDateString,'the datetime should be correct in edit mode');assert.containsNone($('body'),'.bootstrap-datetimepicker-widget');testUtils.dom.openDatepicker(form.$('.o_datepicker'));assert.containsOnce($('body'),'.bootstrap-datetimepicker-widget');await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch').first());await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch:eq(1)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .year:contains(2017)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .month').eq(3));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .day:contains(22)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .fa-clock-o'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .hour:contains(08)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-minute'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .minute:contains(25)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-second'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .second:contains(35)'));assert.ok(!$('.bootstrap-datetimepicker-widget').length,'datepicker should be closed');var newExpectedDateString="04/22/2017 08:25:35";assert.strictEqual(form.$('.o_datepicker_input').val(),newExpectedDateString,'the selected date should be displayed in the input');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_date').text(),newExpectedDateString,'the selected date should be displayed after saving');form.destroy();});QUnit.test('datetime fields do not trigger fieldChange before datetime completly picked',async function(assert){assert.expect(6);this.data.partner.onchanges={datetime:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="datetime"/></form>',res_id:1,translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},session:{getTZOffset:function(){return 120;},},mockRPC:function(route,args){if(args.method==='onchange'){assert.step('onchange');}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});testUtils.dom.openDatepicker(form.$('.o_datepicker'));assert.containsOnce($('body'),'.bootstrap-datetimepicker-widget');await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch').first());await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch:eq(1)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .year:contains(2017)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .month').eq(3));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .day:contains(22)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .fa-clock-o'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .hour:contains(08)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-minute'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .minute:contains(25)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-second'));assert.verifySteps([],"should not have done any onchange yet");await testUtils.dom.click($('.bootstrap-datetimepicker-widget .second:contains(35)'));assert.containsNone($('body'),'.bootstrap-datetimepicker-widget');assert.strictEqual(form.$('.o_datepicker_input').val(),"04/22/2017 08:25:35");assert.verifySteps(['onchange'],"should have done only one onchange");form.destroy();});QUnit.test('datetime field not visible in form view should not capture the focus on keyboard navigation',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="txt"/>'+'<field name="datetime" invisible="True"/></form>',res_id:1,viewOptions:{mode:'edit',},});form.$el.find('textarea[name=txt]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,keyCode:$.ui.keyCode.TAB,}));assert.strictEqual(document.activeElement,form.$buttons.find('.o_form_button_save')[0],"the save button should be selected, because the datepicker did not capture the focus");form.destroy();});QUnit.test('datetime field with datetime formatted without second',async function(assert){assert.expect(2);this.data.partner.fields.datetime.default="2017-08-02 12:00:05";this.data.partner.fields.datetime.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="datetime"/></form>',translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M',},});var expectedDateString="08/02/2017 12:00";assert.strictEqual(form.$('.o_field_date input').val(),expectedDateString,'the datetime should be correctly displayed in readonly');await testUtils.form.clickDiscard(form);assert.strictEqual($('.modal').length,0,"there should not be a Warning dialog");form.destroy();});QUnit.test('datetime field in editable list view',async function(assert){assert.expect(9);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="datetime"/>'+'</tree>',translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},session:{getTZOffset:function(){return 120;},},});var expectedDateString="02/08/2017 12:00:00";var $cell=list.$('tr.o_data_row td:not(.o_list_record_selector)').first();assert.strictEqual($cell.text(),expectedDateString,'the datetime should be correctly displayed in readonly');await testUtils.dom.click($cell);assert.containsOnce(list,'input.o_datepicker_input',"the view should have a date input for editable mode");assert.strictEqual(list.$('input.o_datepicker_input').get(0),document.activeElement,"date input should have the focus");assert.strictEqual(list.$('input.o_datepicker_input').val(),expectedDateString,'the date should be correct in edit mode');assert.containsNone($('body'),'.bootstrap-datetimepicker-widget');testUtils.dom.openDatepicker(list.$('.o_datepicker'));assert.containsOnce($('body'),'.bootstrap-datetimepicker-widget');await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch').first());await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch:eq(1)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .year:contains(2017)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .month').eq(3));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .day:contains(22)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .fa-clock-o'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .hour:contains(08)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-minute'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .minute:contains(25)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-second'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .second:contains(35)'));assert.ok(!$('.bootstrap-datetimepicker-widget').length,'datepicker should be closed');var newExpectedDateString="04/22/2017 08:25:35";assert.strictEqual(list.$('.o_datepicker_input').val(),newExpectedDateString,'the selected datetime should be displayed in the input');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('tr.o_data_row td:not(.o_list_record_selector)').text(),newExpectedDateString,'the selected datetime should be displayed after saving');list.destroy();});QUnit.test('multi edition of datetime field in list view: edit date in input',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree multi_edit="1">'+'<field name="datetime"/>'+'</tree>',translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},session:{getTZOffset:function(){return 120;},},});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell'));assert.containsOnce(list,'input.o_datepicker_input');list.$('.o_datepicker_input').val("10/02/2019 09:00:00");await testUtils.dom.triggerEvents(list.$('.o_datepicker_input'),['change']);assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(list.$('.o_data_row:first .o_data_cell').text(),"10/02/2019 09:00:00");assert.strictEqual(list.$('.o_data_row:nth(1) .o_data_cell').text(),"10/02/2019 09:00:00");list.destroy();});QUnit.test('datetime field remove value',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="datetime"/></form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[1].datetime,false,'the correct value should be saved');}
return this._super.apply(this,arguments);},translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},session:{getTZOffset:function(){return 120;},},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_datepicker_input').val(),'02/08/2017 12:00:00','the date time should be correct in edit mode');await testUtils.fields.editAndTrigger($('.o_datepicker_input'),'',['input','change','focusout']);assert.strictEqual(form.$('.o_datepicker_input').val(),'',"should have an empty input");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_date').text(),'','the selected date should be displayed after saving');form.destroy();});QUnit.test('datetime field with date/datetime widget (with day change)',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2];this.data.partner.records[1].datetime="2017-02-08 02:00:00";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="datetime"/>'+'</tree>'+'<form>'+'<field name="datetime" widget="date"/>'+'</form>'+'</field>'+'</form>',res_id:1,translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},session:{getTZOffset:function(){return-240;},},});var expectedDateString="02/07/2017 22:00:00";assert.strictEqual(form.$('.o_field_widget[name=p] .o_data_cell').text(),expectedDateString,'the datetime (datetime widget) should be correctly displayed in tree view');await testUtils.dom.click(form.$('.o_field_widget[name=p] .o_data_row'));assert.strictEqual($('.modal .o_field_date[name=datetime]').text(),'02/07/2017','the datetime (date widget) should be correctly displayed in form view');form.destroy();});QUnit.test('datetime field with date/datetime widget (without day change)',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2];this.data.partner.records[1].datetime="2017-02-08 10:00:00";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="datetime"/>'+'</tree>'+'<form>'+'<field name="datetime" widget="date"/>'+'</form>'+'</field>'+'</form>',res_id:1,translateParameters:{date_format:'%m/%d/%Y',time_format:'%H:%M:%S',},session:{getTZOffset:function(){return-240;},},});var expectedDateString="02/08/2017 06:00:00";assert.strictEqual(form.$('.o_field_widget[name=p] .o_data_cell').text(),expectedDateString,'the datetime (datetime widget) should be correctly displayed in tree view');await testUtils.dom.click(form.$('.o_field_widget[name=p] .o_data_row'));assert.strictEqual($('.modal .o_field_date[name=datetime]').text(),'02/08/2017','the datetime (date widget) should be correctly displayed in form view');form.destroy();});QUnit.test('datepicker option: daysOfWeekDisabled',async function(assert){assert.expect(42);this.data.partner.fields.datetime.default="2017-08-02 12:00:05";this.data.partner.fields.datetime.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="datetime" '+'options=\'{"datepicker": {"daysOfWeekDisabled": [0, 6]}}\'/>'+'</form>',res_id:1,});await testUtils.form.clickCreate(form);testUtils.dom.openDatepicker(form.$('.o_datepicker'));$.each($('.day:last-child,.day:nth-child(2)'),function(index,value){assert.hasClass(value,'disabled','first and last days must be disabled');});$.each($('.day:not(:last-child):not(:nth-child(2))'),function(index,value){assert.doesNotHaveClass(value,'disabled','other days must stay clickable');});form.destroy();});QUnit.module('RemainingDays');QUnit.test('remaining_days widget on a date field in list view',async function(assert){assert.expect(16);const unpatchDate=patchDate(2017,9,8,15,35,11);this.data.partner.records=[{id:1,date:'2017-10-08'},{id:2,date:'2017-10-09'},{id:3,date:'2017-10-07'},{id:4,date:'2017-10-10'},{id:5,date:'2017-10-05'},{id:6,date:'2018-02-08'},{id:7,date:'2017-06-08'},{id:8,date:false},];const list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="date" widget="remaining_days"/></tree>',});assert.strictEqual(list.$('.o_data_cell:nth(0)').text(),'Today');assert.strictEqual(list.$('.o_data_cell:nth(1)').text(),'Tomorrow');assert.strictEqual(list.$('.o_data_cell:nth(2)').text(),'Yesterday');assert.strictEqual(list.$('.o_data_cell:nth(3)').text(),'In 2 days');assert.strictEqual(list.$('.o_data_cell:nth(4)').text(),'3 days ago');assert.strictEqual(list.$('.o_data_cell:nth(5)').text(),'02/08/2018');assert.strictEqual(list.$('.o_data_cell:nth(6)').text(),'06/08/2017');assert.strictEqual(list.$('.o_data_cell:nth(7)').text(),'');assert.strictEqual(list.$('.o_data_cell:nth(0) .o_field_widget').attr('title'),'10/08/2017');assert.hasClass(list.$('.o_data_cell:nth(0) div'),'text-bf text-warning');assert.doesNotHaveClass(list.$('.o_data_cell:nth(1) div'),'text-bf text-warning text-danger');assert.hasClass(list.$('.o_data_cell:nth(2) div'),'text-bf text-danger');assert.doesNotHaveClass(list.$('.o_data_cell:nth(3) div'),'text-bf text-warning text-danger');assert.hasClass(list.$('.o_data_cell:nth(4) div'),'text-bf text-danger');assert.doesNotHaveClass(list.$('.o_data_cell:nth(5) div'),'text-bf text-warning text-danger');assert.hasClass(list.$('.o_data_cell:nth(6) div'),'text-bf text-danger');list.destroy();unpatchDate();});QUnit.test('remaining_days widget on a date field in form view',async function(assert){assert.expect(4);const unpatchDate=patchDate(2017,9,8,15,35,11);this.data.partner.records=[{id:1,date:'2017-10-08'},];const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="date" widget="remaining_days"/></form>',res_id:1,});assert.strictEqual(form.$('.o_field_widget').text(),'Today');assert.hasClass(form.$('.o_field_widget'),'text-bf text-warning');await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.containsOnce(form,'div.o_field_widget[name=date]');form.destroy();unpatchDate();});QUnit.test('remaining_days widget on a datetime field in list view in UTC',async function(assert){assert.expect(16);const unpatchDate=patchDate(2017,9,8,15,35,11);this.data.partner.records=[{id:1,datetime:'2017-10-08 20:00:00'},{id:2,datetime:'2017-10-09 08:00:00'},{id:3,datetime:'2017-10-07 18:00:00'},{id:4,datetime:'2017-10-10 22:00:00'},{id:5,datetime:'2017-10-05 04:00:00'},{id:6,datetime:'2018-02-08 04:00:00'},{id:7,datetime:'2017-06-08 04:00:00'},{id:8,datetime:false},];const list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="datetime" widget="remaining_days"/></tree>',session:{getTZOffset:()=>0,},});assert.strictEqual(list.$('.o_data_cell:nth(0)').text(),'Today');assert.strictEqual(list.$('.o_data_cell:nth(1)').text(),'Tomorrow');assert.strictEqual(list.$('.o_data_cell:nth(2)').text(),'Yesterday');assert.strictEqual(list.$('.o_data_cell:nth(3)').text(),'In 2 days');assert.strictEqual(list.$('.o_data_cell:nth(4)').text(),'3 days ago');assert.strictEqual(list.$('.o_data_cell:nth(5)').text(),'02/08/2018');assert.strictEqual(list.$('.o_data_cell:nth(6)').text(),'06/08/2017');assert.strictEqual(list.$('.o_data_cell:nth(7)').text(),'');assert.strictEqual(list.$('.o_data_cell:nth(0) .o_field_widget').attr('title'),'10/08/2017');assert.hasClass(list.$('.o_data_cell:nth(0) div'),'text-bf text-warning');assert.doesNotHaveClass(list.$('.o_data_cell:nth(1) div'),'text-bf text-warning text-danger');assert.hasClass(list.$('.o_data_cell:nth(2) div'),'text-bf text-danger');assert.doesNotHaveClass(list.$('.o_data_cell:nth(3) div'),'text-bf text-warning text-danger');assert.hasClass(list.$('.o_data_cell:nth(4) div'),'text-bf text-danger');assert.doesNotHaveClass(list.$('.o_data_cell:nth(5) div'),'text-bf text-warning text-danger');assert.hasClass(list.$('.o_data_cell:nth(6) div'),'text-bf text-danger');list.destroy();unpatchDate();});QUnit.test('remaining_days widget on a datetime field in list view in UTC+6',async function(assert){assert.expect(6);const unpatchDate=patchDate(2017,9,8,15,35,11);this.data.partner.records=[{id:1,datetime:'2017-10-08 20:00:00'},{id:2,datetime:'2017-10-09 08:00:00'},{id:3,datetime:'2017-10-07 18:30:00'},{id:4,datetime:'2017-10-07 12:00:00'},{id:5,datetime:'2017-10-09 20:00:00'},];const list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="datetime" widget="remaining_days"/></tree>',session:{getTZOffset:()=>360,},});assert.strictEqual(list.$('.o_data_cell:nth(0)').text(),'Tomorrow');assert.strictEqual(list.$('.o_data_cell:nth(1)').text(),'Tomorrow');assert.strictEqual(list.$('.o_data_cell:nth(2)').text(),'Today');assert.strictEqual(list.$('.o_data_cell:nth(3)').text(),'Yesterday');assert.strictEqual(list.$('.o_data_cell:nth(4)').text(),'In 2 days');assert.strictEqual(list.$('.o_data_cell:nth(0) .o_field_widget').attr('title'),'10/09/2017');list.destroy();unpatchDate();});QUnit.test('remaining_days widget on a datetime field in list view in UTC-8',async function(assert){assert.expect(5);const unpatchDate=patchDate(2017,9,8,15,35,11);this.data.partner.records=[{id:1,datetime:'2017-10-08 20:00:00'},{id:2,datetime:'2017-10-09 07:00:00'},{id:3,datetime:'2017-10-09 10:00:00'},{id:4,datetime:'2017-10-08 06:00:00'},{id:5,datetime:'2017-10-07 02:00:00'},];const list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="datetime" widget="remaining_days"/></tree>',session:{getTZOffset:()=>-560,},});assert.strictEqual(list.$('.o_data_cell:nth(0)').text(),'Today');assert.strictEqual(list.$('.o_data_cell:nth(1)').text(),'Today');assert.strictEqual(list.$('.o_data_cell:nth(2)').text(),'Tomorrow');assert.strictEqual(list.$('.o_data_cell:nth(3)').text(),'Yesterday');assert.strictEqual(list.$('.o_data_cell:nth(4)').text(),'2 days ago');list.destroy();unpatchDate();});QUnit.module('FieldMonetary');QUnit.test('monetary field in form view',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</sheet>'+'</form>',res_id:5,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});assert.strictEqual(form.$('.o_field_widget').first().text(),'$\u00a09.10','The value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'9.10','The input should be rendered without the currency symbol.');assert.strictEqual(form.$('.o_field_widget[name=qux] input').parent().children().first().text(),'$','The input should be preceded by a span containing the currency symbol.');await testUtils.fields.editInput(form.$('.o_field_monetary input'),'108.2458938598598');assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'108.2458938598598','The value should not be formated yet.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'$\u00a0108.25','The new value should be rounded properly.');form.destroy();});QUnit.test('monetary field rounding using formula in form view',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</sheet>'+'</form>',res_id:5,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('.o_field_monetary input'),'=100/3');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'$\u00a033.33','The new value should be calculated and rounded properly.');form.destroy();});QUnit.test('monetary field with currency symbol after',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</sheet>'+'</form>',res_id:2,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});assert.strictEqual(form.$('.o_field_widget').first().text(),'0.00\u00a0€','The value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'0.00','The input should be rendered without the currency symbol.');assert.strictEqual(form.$('.o_field_widget[name=qux] input').parent().children().eq(1).text(),'€','The input should be followed by a span containing the currency symbol.');await testUtils.fields.editInput(form.$('.o_field_widget[name=qux] input'),'108.2458938598598');assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'108.2458938598598','The value should not be formated yet.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'108.25\u00a0€','The new value should be rounded properly.');form.destroy();});QUnit.test('monetary field with currency digits != 2',async function(assert){assert.expect(5);this.data.partner.records=[{id:1,bar:false,foo:"pouet",int_field:68,qux:99.1234,currency_id:1,}];this.data.currency.records=[{id:1,display_name:"VEF",symbol:"Bs.F",position:"after",digits:[16,4],}];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</sheet>'+'</form>',res_id:1,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});assert.strictEqual(form.$('.o_field_widget').first().text(),'99.1234\u00a0Bs.F','The value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'99.1234','The input should be rendered without the currency symbol.');assert.strictEqual(form.$('.o_field_widget[name=qux] input').parent().children().eq(1).text(),'Bs.F','The input should be followed by a span containing the currency symbol.');await testUtils.fields.editInput(form.$('.o_field_widget[name=qux] input'),'99.111111111');assert.strictEqual(form.$('.o_field_widget[name=qux] input').val(),'99.111111111','The value should not be formated yet.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'99.1111\u00a0Bs.F','The new value should be rounded properly.');form.destroy();});QUnit.test('monetary field in editable list view',async function(assert){assert.expect(9);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="qux" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</tree>',session:{currencies:_.indexBy(this.data.currency.records,'id'),},});var dollarValues=list.$('td').filter(function(){return _.str.include($(this).text(),'$');});assert.strictEqual(dollarValues.length,1,'Only one line has dollar as a currency.');var euroValues=list.$('td').filter(function(){return _.str.include($(this).text(),'€');});assert.strictEqual(euroValues.length,1,'One one line has euro as a currency.');var zeroValues=list.$('td.o_data_cell').filter(function(){return $(this).text()==='';});assert.strictEqual(zeroValues.length,1,'Unset float values should be rendered as empty strings.');var $cell=list.$('tr.o_data_row td:not(.o_list_record_selector):contains($)');await testUtils.dom.click($cell);assert.strictEqual($cell.children().length,1,'The cell td should only contain the special div of monetary widget.');assert.containsOnce(list,'[name="qux"] input','The view should have 1 input for editable monetary float.');assert.strictEqual(list.$('[name="qux"] input').val(),'9.10','The input should be rendered without the currency symbol.');assert.strictEqual(list.$('[name="qux"] input').parent().children().first().text(),'$','The input should be preceded by a span containing the currency symbol.');await testUtils.fields.editInput(list.$('[name="qux"] input'),'108.2458938598598');assert.strictEqual(list.$('[name="qux"] input').val(),'108.2458938598598','The typed value should be correctly displayed.');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('tr.o_data_row td:not(.o_list_record_selector):contains($)').text(),'$\u00a0108.25','The new value should be rounded properly.');list.destroy();});QUnit.test('monetary field with real monetary field in model',async function(assert){assert.expect(7);this.data.partner.fields.qux.type="monetary";this.data.partner.fields.quux={string:"Quux",type:"monetary",digits:[16,1],searchable:true,readonly:true,};(_.find(this.data.partner.records,function(record){return record.id===5;})).quux=4.2;this.data.partner.onchanges={bar:function(obj){obj.qux=obj.bar?100:obj.qux;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux"/>'+'<field name="quux"/>'+'<field name="currency_id"/>'+'<field name="bar"/>'+'</sheet>'+'</form>',res_id:5,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});assert.strictEqual(form.$('.o_field_monetary').first().html(),"$&nbsp;9.10","readonly value should contain the currency");assert.strictEqual(form.$('.o_field_monetary').first().next().html(),"$&nbsp;4.20","readonly value should contain the currency");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_monetary > input').val(),"9.10","input value in edition should only contain the value, without the currency");await testUtils.dom.click(form.$('input[type="checkbox"]'));assert.containsOnce(form,'.o_field_monetary > input',"After the onchange, the monetary <input/> should not have been duplicated");assert.containsOnce(form,'.o_field_monetary[name=quux]',"After the onchange, the monetary readonly field should not have been duplicated");await testUtils.fields.many2one.clickOpenDropdown('currency_id');await testUtils.fields.many2one.clickItem('currency_id','€');assert.strictEqual(form.$('.o_field_monetary > span').html(),"€","After currency change, the monetary field currency should have been updated");assert.strictEqual(form.$('.o_field_monetary').first().next().html(),"4.20&nbsp;€","readonly value should contain the updated currency");form.destroy();});QUnit.test('monetary field with monetary field given in options',async function(assert){assert.expect(1);this.data.partner.fields.qux.type="monetary";this.data.partner.fields.company_currency_id={string:"Company Currency",type:"many2one",relation:"currency",};this.data.partner.records[4].company_currency_id=2;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" options="{\'currency_field\': \'company_currency_id\'}"/>'+'<field name="company_currency_id"/>'+'</sheet>'+'</form>',res_id:5,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});assert.strictEqual(form.$('.o_field_monetary').html(),"9.10&nbsp;€","field monetary should be formatted with correct currency");form.destroy();});QUnit.test('should keep the focus when being edited in x2many lists',async function(assert){assert.expect(6);this.data.partner.fields.currency_id.default=1;this.data.partner.fields.m2m={string:"m2m",type:"many2many",relation:'partner',default:[[6,false,[2]]],};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p"/>'+'<field name="m2m"/>'+'</sheet>'+'</form>',archs:{'partner,false,list':'<tree editable="bottom">'+'<field name="qux" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</tree>',},session:{currencies:_.indexBy(this.data.currency.records,'id'),},});var $o2m=form.$('.o_field_widget[name=p]');await testUtils.dom.click($o2m.find('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput($o2m.find('.o_field_widget input'),"22");assert.strictEqual($o2m.find('.o_field_widget input').get(0),document.activeElement,"the focus should still be on the input");assert.strictEqual($o2m.find('.o_field_widget input').val(),"22","the value should not have been formatted yet");await testUtils.dom.click(form.$el);assert.strictEqual($o2m.find('.o_field_widget[name=qux]').html(),"$&nbsp;22.00","the value should have been formatted after losing the focus");var $m2m=form.$('.o_field_widget[name=m2m]');await testUtils.dom.click($m2m.find('.o_data_row td:first'));await testUtils.fields.editInput($m2m.find('.o_field_widget input'),"22");assert.strictEqual($m2m.find('.o_field_widget input').get(0),document.activeElement,"the focus should still be on the input");assert.strictEqual($m2m.find('.o_field_widget input').val(),"22","the value should not have been formatted yet");await testUtils.dom.click(form.$el);assert.strictEqual($m2m.find('.o_field_widget[name=qux]').html(),"22.00&nbsp;€","the value should have been formatted after losing the focus");form.destroy();});QUnit.test('monetary field with currency set by an onchange',async function(assert){assert.expect(8);this.data.partner.onchanges={int_field:function(obj){obj.currency_id=obj.int_field?2:null;},};var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="top">'+'<field name="int_field"/>'+'<field name="qux" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</tree>',session:{currencies:_.indexBy(this.data.currency.records,'id'),},});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsOnce(list,'div.o_field_widget[name=qux] input',"monetary field should have been rendered correctly (without currency)");assert.containsNone(list,'.o_field_widget[name=qux] span',"monetary field should have been rendered correctly (without currency)");await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),'7');assert.containsOnce(list,'div.o_field_widget[name=qux] input',"monetary field should have been re-rendered correctly (with currency)");assert.strictEqual(list.$('.o_field_widget[name=qux] span:contains(€)').length,1,"monetary field should have been re-rendered correctly (with currency)");var $quxInput=list.$('.o_field_widget[name=qux] input');await testUtils.dom.click($quxInput);assert.strictEqual(document.activeElement,$quxInput[0],"focus should be on the qux field's input");await testUtils.dom.click(list.$('.o_field_widget[name=int_field]'));await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),'0');$quxInput=list.$('div.o_field_widget[name=qux] input');assert.strictEqual($quxInput.length,1,"monetary field should have been re-rendered correctly (without currency)");assert.containsNone(list,'.o_field_widget[name=qux] span',"monetary field should have been re-rendered correctly (without currency)");await testUtils.dom.click($quxInput);assert.strictEqual(document.activeElement,$quxInput[0],"focus should be on the qux field's input");list.destroy();});QUnit.module('FieldInteger');QUnit.test('integer field when unset',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="int_field"/></form>',res_id:4,});assert.doesNotHaveClass(form.$('.o_field_widget'),'o_field_empty','Non-set integer field should be recognized as 0.');assert.strictEqual(form.$('.o_field_widget').text(),"0",'Non-set integer field should be recognized as 0.');form.destroy();});QUnit.test('integer field in form view',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="int_field"/></form>',res_id:2,});assert.doesNotHaveClass(form.$('.o_field_widget'),'o_field_empty','Integer field should be considered set for value 0.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=int_field]').val(),'0','The value should be rendered correctly in edit mode.');await testUtils.fields.editInput(form.$('input[name=int_field]'),'-18');assert.strictEqual(form.$('input[name=int_field]').val(),'-18','The value should be correctly displayed in the input.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'-18','The new value should be saved and displayed properly.');form.destroy();});QUnit.test('integer field rounding using formula in form view',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="int_field"/></form>',res_id:2,});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=int_field]'),'=100/3');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'33','The new value should be calculated properly.');form.destroy();});QUnit.test('integer field in form view with virtual id',async function(assert){assert.expect(1);var params={View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="id"/></form>',};params.res_id=this.data.partner.records[1].id="2-20170808020000";var form=await createView(params);assert.strictEqual(form.$('.o_field_widget').text(),"2-20170808020000","Should display virtual id");form.destroy();});QUnit.test('integer field in editable list view',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="int_field"/>'+'</tree>',});var zeroValues=list.$('td').filter(function(){return $(this).text()==='0';});assert.strictEqual(zeroValues.length,1,'Unset integer values should not be rendered as zeros.');var $cell=list.$('tr.o_data_row td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.containsOnce(list,'input[name="int_field"]','The view should have 1 input for editable integer.');await testUtils.fields.editInput(list.$('input[name="int_field"]'),'-28');assert.strictEqual(list.$('input[name="int_field"]').val(),'-28','The value should be displayed properly in the input.');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('td:not(.o_list_record_selector)').first().text(),'-28','The new value should be saved and displayed properly.');list.destroy();});QUnit.test('integer field with type number option',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field" options="{\'type\': \'number\'}"/>'+'</form>',res_id:4,translateParameters:{thousands_sep:",",grouping:[3,0],},});await testUtils.form.clickEdit(form);assert.ok(form.$('.o_field_widget')[0].hasAttribute('type'),'Integer field with option type must have a type attribute.');assert.hasAttrValue(form.$('.o_field_widget'),'type','number','Integer field with option type must have a type attribute equals to "number".');await testUtils.fields.editInput(form.$('input[name=int_field]'),'1234567890');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget').val(),'1234567890','Integer value must be not formatted if input type is number.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'1,234,567,890','Integer value must be formatted in readonly view even if the input type is number.');form.destroy();});QUnit.test('integer field without type number option',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'</form>',res_id:4,translateParameters:{thousands_sep:",",grouping:[3,0],},});await testUtils.form.clickEdit(form);assert.hasAttrValue(form.$('.o_field_widget'),'type','text','Integer field without option type must have a text type (default type).');await testUtils.fields.editInput(form.$('input[name=int_field]'),'1234567890');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget').val(),'1,234,567,890','Integer value must be formatted if input type isn\'t number.');form.destroy();});QUnit.test('integer field without formatting',async function(assert){assert.expect(3);this.data.partner.records=[{'id':999,'int_field':8069,}];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field" options="{\'format\': \'false\'}"/>'+'</form>',res_id:999,translateParameters:{thousands_sep:",",grouping:[3,0],},});assert.ok(form.$('.o_form_view').hasClass('o_form_readonly'),'Form in readonly mode');assert.strictEqual(form.$('.o_field_widget[name=int_field]').text(),'8069','Integer value must not be formatted');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget').val(),'8069','Integer value must not be formatted');form.destroy();});QUnit.test('integer field is formatted by default',async function(assert){assert.expect(3);this.data.partner.records=[{'id':999,'int_field':8069,}];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field" />'+'</form>',res_id:999,translateParameters:{thousands_sep:",",grouping:[3,0],},});assert.ok(form.$('.o_form_view').hasClass('o_form_readonly'),'Form in readonly mode');assert.strictEqual(form.$('.o_field_widget[name=int_field]').text(),'8,069','Integer value must be formatted by default');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget').val(),'8,069','Integer value must be formatted by default');form.destroy();});QUnit.module('FieldFloatTime');QUnit.test('float_time field in form view',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="float_time"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[1].qux,-11.8,'the correct float value should be saved');}
return this._super.apply(this,arguments);},res_id:5,});assert.strictEqual(form.$('.o_field_widget').first().text(),'09:06','The formatted time value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=qux]').val(),'09:06','The value should be rendered correctly in the input.');await testUtils.fields.editInput(form.$('input[name=qux]'),'-11:48');assert.strictEqual(form.$('input[name=qux]').val(),'-11:48','The new value should be displayed properly in the input.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'-11:48','The new value should be saved and displayed properly.');form.destroy();});QUnit.module('FieldFloatFactor');QUnit.test('float_factor field in form view',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="float_factor" options="{\'factor\': 0.5}" digits="[16,2]"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[1].qux,4.6,'the correct float value should be saved');}
return this._super.apply(this,arguments);},res_id:5,});assert.strictEqual(form.$('.o_field_widget').first().text(),'4.55','The formatted value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=qux]').val(),'4.55','The value should be rendered correctly in the input.');await testUtils.fields.editInput(form.$('input[name=qux]'),'2.3');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'2.30','The new value should be saved and displayed properly.');form.destroy();});QUnit.module('FieldFloatToggle');QUnit.test('float_toggle field in form view',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="qux" widget="float_toggle" options="{\'factor\': 0.125, \'range\': [0, 1, 0.75, 0.5, 0.25]}" digits="[5,3]"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[1].qux,8,'the correct float value should be saved');}
return this._super.apply(this,arguments);},res_id:1,});assert.strictEqual(form.$('.o_field_widget').first().text(),'0.056','The formatted time value should be displayed properly.');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('button.o_field_float_toggle').text(),'0.056','The value should be rendered correctly on the button.');await testUtils.dom.click(form.$('button.o_field_float_toggle'));assert.strictEqual(form.$('button.o_field_float_toggle').text(),'1.000','The value should be rendered correctly on the button.');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').first().text(),'1.000','The new value should be saved and displayed properly.');form.destroy();});QUnit.module('PhoneWidget');QUnit.test('phone field in form view on normal screens',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" widget="phone"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,config:{device:{size_class:config.device.SIZES.LG,},},});var $phone=form.$('a.o_field_widget.o_form_uri');assert.strictEqual($phone.length,1,"should have rendered the phone number as a link with correct classes");assert.strictEqual($phone.text(),'yop',"value should be displayed properly");await testUtils.form.clickEdit(form);assert.containsOnce(form,'input[type="text"].o_field_widget',"should have an input for the phone field");assert.strictEqual(form.$('input[type="text"].o_field_widget').val(),'yop',"input should contain field value in edit mode");await testUtils.fields.editInput(form.$('input[type="text"].o_field_widget'),'new');await testUtils.form.clickSave(form);assert.strictEqual(form.$('a.o_field_widget.o_form_uri').text(),'new',"new value should be displayed properly");form.destroy();});QUnit.test('phone field in editable list view on normal screens',async function(assert){assert.expect(8);var doActionCount=0;var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="foo" widget="phone"/></tree>',config:{device:{size_class:config.device.SIZES.LG,},},});assert.containsN(list,'tbody td:not(.o_list_record_selector)',5);assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) a').first().text(),'yop',"value should be displayed properly with a link to send SMS");assert.containsN(list,'a.o_field_widget.o_form_uri',5,"should have the correct classnames");var $cell=list.$('tbody td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.hasClass($cell.parent(),'o_selected_row','should be set as edit mode');assert.strictEqual($cell.find('input').val(),'yop','should have the corect value in internal input');await testUtils.fields.editInput($cell.find('input'),'new');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));$cell=list.$('tbody td:not(.o_list_record_selector)').first();assert.doesNotHaveClass($cell.parent(),'o_selected_row','should not be in edit mode anymore');assert.strictEqual(list.$('tbody td:not(.o_list_record_selector) a').first().text(),'new',"value should be properly updated");assert.containsN(list,'a.o_field_widget.o_form_uri',5,"should still have links with correct classes");list.destroy();});QUnit.test('use TAB to navigate to a phone field',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="display_name"/>'+'<field name="foo" widget="phone"/>'+'</group>'+'</sheet>'+'</form>',});testUtils.dom.click(form.$('input[name=display_name]'));assert.strictEqual(form.$('input[name="display_name"]')[0],document.activeElement,"display_name should be focused");form.$('input[name="display_name"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('input[name="foo"]')[0],document.activeElement,"foo should be focused");form.destroy();});QUnit.module('PriorityWidget');QUnit.test('priority widget when not set',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="selection" widget="priority"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,});assert.strictEqual(form.$('.o_field_widget.o_priority:not(.o_field_empty)').length,1,"widget should be considered set, even though there is no value for this field");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should have two stars for representing each possible value: no star, one star and two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,0,"should have no full star since there is no value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,2,"should have two empty stars since there is no value");form.destroy();});QUnit.test('priority widget in form view',async function(assert){assert.expect(22);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="selection" widget="priority"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_field_widget.o_priority:not(.o_field_empty)').length,1,"widget should be considered set");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should have two stars for representing each possible value: no star, one star and two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,1,"should have one full star since the value is the second value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,1,"should have one empty star since the value is the second value");form.$('.o_field_widget.o_priority a.o_priority_star.fa-star-o').last().trigger('mouseover');assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should have two stars for representing each possible value: no star, one star and two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,2,"should temporary have two full stars since we are hovering the third value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,0,"should temporary have no empty star since we are hovering the third value");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,1,"should still have one full star since the value is the second value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,1,"should still have one empty star since the value is the second value");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,1,"should still have one full star since the value is the second value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,1,"should still have one empty star since the value is the second value");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,1,"should still have one full star since the value is the second value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,1,"should still have one empty star since the value is the second value");await testUtils.dom.click(form.$('.o_field_widget.o_priority a.o_priority_star.fa-star-o').last());assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,2,"should now have two full stars since the value is the third value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,0,"should now have no empty star since the value is the third value");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star').length,2,"should now have two full stars since the value is the third value");assert.strictEqual(form.$('.o_field_widget.o_priority').find('a.o_priority_star.fa-star-o').length,0,"should now have no empty star since the value is the third value");form.destroy();});QUnit.test('priority widget in editable list view',async function(assert){assert.expect(25);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="selection" widget="priority"/></tree>',});assert.strictEqual(list.$('.o_data_row').first().find('.o_priority:not(.o_field_empty)').length,1,"widget should be considered set");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star').length,2,"should have two stars for representing each possible value: no star, one star and two stars");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star').length,1,"should have one full star since the value is the second value");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star-o').length,1,"should have one empty star since the value is the second value");var $cell=list.$('tbody td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star').length,2,"should have two stars for representing each possible value: no star, one star and two stars");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star').length,1,"should have one full star since the value is the second value");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star-o').length,1,"should have one empty star since the value is the second value");await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star').length,2,"should have two stars for representing each possible value: no star, one star and two stars");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star').length,1,"should have one full star since the value is the second value");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star-o').length,1,"should have one empty star since the value is the second value");list.$('.o_data_row .o_priority a.o_priority_star.fa-star-o').first().trigger('mouseenter');assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star').length,2,"should have two stars for representing each possible value: no star, one star and two stars");assert.strictEqual(list.$('.o_data_row').first().find('a.o_priority_star.fa-star').length,2,"should temporary have two full stars since we are hovering the third value");assert.strictEqual(list.$('.o_data_row').first().find('a.o_priority_star.fa-star-o').length,0,"should temporary have no empty star since we are hovering the third value");await testUtils.dom.click(list.$('.o_priority a.o_priority_star.fa-star').first());assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star').length,0,"should now have no full star since the value is the first value");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star-o').length,2,"should now have two empty stars since the value is the first value");$cell=list.$('tbody td:not(.o_list_record_selector)').first();await testUtils.dom.click($cell);assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star').length,0,"should now only have no full star since the value is the first value");assert.strictEqual(list.$('.o_data_row').first().find('.o_priority a.o_priority_star.fa-star-o').length,2,"should now have two empty stars since the value is the first value");await testUtils.dom.click(list.$('.o_priority a.o_priority_star.fa-star-o').last());assert.strictEqual(list.$('.o_data_row').last().find('.o_priority a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(list.$('.o_data_row').last().find('.o_priority a.o_priority_star.fa-star').length,2,"should now have two full stars since the value is the third value");assert.strictEqual(list.$('.o_data_row').last().find('.o_priority a.o_priority_star.fa-star-o').length,0,"should now have no empty star since the value is the third value");await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('.o_data_row').last().find('.o_priority a.o_priority_star').length,2,"should still have two stars");assert.strictEqual(list.$('.o_data_row').last().find('.o_priority a.o_priority_star.fa-star').length,2,"should now have two full stars since the value is the third value");assert.strictEqual(list.$('.o_data_row').last().find('.o_priority a.o_priority_star.fa-star-o').length,0,"should now have no empty star since the value is the third value");list.destroy();});QUnit.test('priority widget with readonly attribute',async function(assert){assert.expect(1);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="selection" widget="priority" readonly="1"/>
                </form>`,res_id:2,});assert.containsN(form,'.o_field_widget.o_priority span',2,"stars of priority widget should rendered with span tag if readonly");form.destroy();});QUnit.module('StateSelection Widget');QUnit.test('state_selection widget in form view',async function(assert){assert.expect(21);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="selection" widget="state_selection"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{disable_autofocus:true,},});assert.containsOnce(form,'.o_field_widget.o_selection > a span.o_status.o_status_red',"should have one red status since selection is the second, blocked state");assert.containsNone(form,'.o_field_widget.o_selection > a span.o_status.o_status_green',"should not have one green status since selection is the second, blocked state");assert.containsNone(form,'.dropdown-menu.state:visible',"there should not be a dropdown");await testUtils.dom.click(form.$('.o_field_widget.o_selection .o_status').first());assert.containsOnce(form,'.dropdown-menu.state:visible',"there should be a dropdown");assert.containsN(form,'.dropdown-menu.state:visible .dropdown-item',2,"there should be two options in the dropdown");await testUtils.dom.click(form.$('.dropdown-menu.state:visible .dropdown-item').first());assert.containsNone(form,'.dropdown-menu.state:visible',"there should not be a dropdown anymore");assert.containsNone(form,'.o_field_widget.o_selection > a span.o_status.o_status_red',"should not have one red status since selection is the first, normal state");assert.containsNone(form,'.o_field_widget.o_selection > a span.o_status.o_status_green',"should not have one green status since selection is the first, normal state");assert.containsOnce(form,'.o_field_widget.o_selection > a span.o_status',"should have one grey status since selection is the first, normal state");await testUtils.form.clickEdit(form);assert.containsNone(form,'.dropdown-menu.state:visible',"there should still not be a dropdown");assert.containsNone(form,'.o_field_widget.o_selection > a span.o_status.o_status_red',"should still not have one red status since selection is the first, normal state");assert.containsNone(form,'.o_field_widget.o_selection > a span.o_status.o_status_green',"should still not have one green status since selection is the first, normal state");assert.containsOnce(form,'.o_field_widget.o_selection > a span.o_status',"should still have one grey status since selection is the first, normal state");await testUtils.dom.click(form.$('.o_field_widget.o_selection .o_status').first());assert.containsOnce(form,'.dropdown-menu.state:visible',"there should be a dropdown");assert.containsN(form,'.dropdown-menu.state:visible .dropdown-item',2,"there should be two options in the dropdown");await testUtils.dom.click(form.$('.dropdown-menu.state:visible .dropdown-item').last());assert.containsNone(form,'.dropdown-menu.state:visible',"there should not be a dropdown anymore");assert.containsNone(form,'.o_field_widget.o_selection > a span.o_status.o_status_red',"should not have one red status since selection is the third, done state");assert.containsOnce(form,'.o_field_widget.o_selection > a span.o_status.o_status_green',"should have one green status since selection is the third, done state");await testUtils.form.clickSave(form);assert.containsNone(form,'.dropdown-menu.state:visible',"there should still not be a dropdown anymore");assert.containsNone(form,'.o_field_widget.o_selection > a span.o_status.o_status_red',"should still not have one red status since selection is the third, done state");assert.containsOnce(form,'.o_field_widget.o_selection > a span.o_status.o_status_green',"should still have one green status since selection is the third, done state");form.destroy();});QUnit.test('state_selection widget with readonly modifier',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="selection" widget="state_selection" readonly="1"/></form>',res_id:1,});assert.hasClass(form.$('.o_selection'),'o_readonly_modifier');assert.hasClass(form.$('.o_selection > a'),'disabled');assert.isNotVisible(form.$('.dropdown-menu.state'));await testUtils.dom.click(form.$('.o_selection > a'));assert.isNotVisible(form.$('.dropdown-menu.state'));form.destroy();});QUnit.test('state_selection widget in editable list view',async function(assert){assert.expect(32);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="selection" widget="state_selection"/>'+'</tree>',});assert.containsN(list,'.o_state_selection_cell .o_selection > a span.o_status',5,"should have five status selection widgets");assert.containsOnce(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_red',"should have one red status");assert.containsOnce(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_green',"should have one green status");assert.containsNone(list,'.dropdown-menu.state:visible',"there should not be a dropdown");var $cell=list.$('tbody td.o_state_selection_cell').first();await testUtils.dom.click(list.$('.o_state_selection_cell .o_selection > a span.o_status').first());assert.doesNotHaveClass($cell.parent(),'o_selected_row','should not be in edit mode since we clicked on the state selection widget');assert.containsOnce(list,'.dropdown-menu.state:visible',"there should be a dropdown");assert.containsN(list,'.dropdown-menu.state:visible .dropdown-item',2,"there should be two options in the dropdown");await testUtils.dom.click(list.$('.dropdown-menu.state:visible .dropdown-item').first());assert.containsN(list,'.o_state_selection_cell .o_selection > a span.o_status',5,"should still have five status selection widgets");assert.containsNone(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_red',"should now have no red status");assert.containsOnce(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_green',"should still have one green status");assert.containsNone(list,'.dropdown-menu.state:visible',"there should not be a dropdown");$cell=list.$('tbody td.o_state_selection_cell').first();await testUtils.dom.click($cell);assert.hasClass($cell.parent(),'o_selected_row','should now be in edit mode');assert.containsN(list,'.o_state_selection_cell .o_selection > a span.o_status',5,"should still have five status selection widgets");assert.containsNone(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_red',"should now have no red status");assert.containsOnce(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_green',"should still have one green status");assert.containsNone(list,'.dropdown-menu.state:visible',"there should not be a dropdown");await testUtils.dom.click(list.$('.o_state_selection_cell .o_selection > a span.o_status').first());assert.containsOnce(list,'.dropdown-menu.state:visible',"there should be a dropdown");assert.containsN(list,'.dropdown-menu.state:visible .dropdown-item',2,"there should be two options in the dropdown");var $lastCell=list.$('tbody td.o_state_selection_cell').last();await testUtils.dom.click($lastCell);assert.containsNone(list,'.dropdown-menu.state:visible',"there should not be a dropdown anymore");var $firstCell=list.$('tbody td.o_state_selection_cell').first();assert.doesNotHaveClass($firstCell.parent(),'o_selected_row','first row should not be in edit mode anymore');assert.hasClass($lastCell.parent(),'o_selected_row','last row should be in edit mode');await testUtils.dom.click(list.$('.o_state_selection_cell .o_selection > a span.o_status').last());assert.containsOnce(list,'.dropdown-menu.state:visible',"there should be a dropdown");assert.containsN(list,'.dropdown-menu.state:visible .dropdown-item',2,"there should be two options in the dropdown");await testUtils.dom.click(list.$('.dropdown-menu.state:visible .dropdown-item').last());assert.containsNone(list,'.dropdown-menu.state:visible',"there should not be a dropdown anymore");assert.containsN(list,'.o_state_selection_cell .o_selection > a span.o_status',5,"should still have five status selection widgets");assert.containsNone(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_red',"should still have no red status");assert.containsN(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_green',2,"should now have two green status");assert.containsNone(list,'.dropdown-menu.state:visible',"there should not be a dropdown");await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.containsN(list,'.o_state_selection_cell .o_selection > a span.o_status',5,"should have five status selection widgets");assert.containsNone(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_red',"should have no red status");assert.containsN(list,'.o_state_selection_cell .o_selection > a span.o_status.o_status_green',2,"should have two green status");assert.containsNone(list,'.dropdown-menu.state:visible',"there should not be a dropdown");list.destroy();});QUnit.module('FavoriteWidget');QUnit.test('favorite widget in kanban view',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<templates>'+'<t t-name="kanban-box">'+'<div>'+'<field name="bar" widget="boolean_favorite" />'+'</div>'+'</t>'+'</templates>'+'</kanban>',domain:[['id','=',1]],});assert.containsOnce(kanban,'.o_kanban_record .o_field_widget.o_favorite > a i.fa.fa-star','should be favorite');assert.strictEqual(kanban.$('.o_kanban_record .o_field_widget.o_favorite > a').text(),' Remove from Favorites','the label should say "Remove from Favorites"');await testUtils.dom.click(kanban.$('.o_field_widget.o_favorite'));assert.containsNone(kanban,'.o_kanban_record  .o_field_widget.o_favorite > a i.fa.fa-star','should not be favorite');assert.strictEqual(kanban.$('.o_kanban_record  .o_field_widget.o_favorite > a').text(),' Add to Favorites','the label should say "Add to Favorites"');kanban.destroy();});QUnit.test('favorite widget in form view',async function(assert){assert.expect(10);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="bar" widget="boolean_favorite" />'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_field_widget.o_favorite > a i.fa.fa-star','should be favorite');assert.strictEqual(form.$('.o_field_widget.o_favorite > a').text(),' Remove from Favorites','the label should say "Remove from Favorites"');await testUtils.dom.click(form.$('.o_field_widget.o_favorite'));assert.containsNone(form,'.o_field_widget.o_favorite > a i.fa.fa-star','should not be favorite');assert.strictEqual(form.$('.o_field_widget.o_favorite > a').text(),' Add to Favorites','the label should say "Add to Favorites"');await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_widget.o_favorite > a i.fa.fa-star-o','should not be favorite');assert.strictEqual(form.$('.o_field_widget.o_favorite > a').text(),' Add to Favorites','the label should say "Add to Favorites"');await testUtils.dom.click(form.$('.o_field_widget.o_favorite'));assert.containsOnce(form,'.o_field_widget.o_favorite > a i.fa.fa-star','should be favorite');assert.strictEqual(form.$('.o_field_widget.o_favorite > a').text(),' Remove from Favorites','the label should say "Remove from Favorites"');await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_field_widget.o_favorite > a i.fa.fa-star','should be favorite');assert.strictEqual(form.$('.o_field_widget.o_favorite > a').text(),' Remove from Favorites','the label should say "Remove from Favorites"');form.destroy();});QUnit.test('favorite widget in editable list view without label',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="bar" widget="boolean_favorite" nolabel="1" />'+'</tree>',});assert.containsOnce(list,'.o_data_row:first .o_field_widget.o_favorite > a i.fa.fa-star','should be favorite');await testUtils.dom.click(list.$('tbody td:not(.o_list_record_selector)').first());assert.containsOnce(list,'.o_data_row:first .o_field_widget.o_favorite > a i.fa.fa-star','should be favorite');await testUtils.dom.click(list.$('.o_data_row:first .o_field_widget.o_favorite'));assert.containsNone(list,'.o_data_row:first .o_field_widget.o_favorite > a i.fa.fa-star','should not be favorite');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.containsOnce(list,'.o_data_row:first .o_field_widget.o_favorite > a i.fa.fa-star-o','should not be favorite');list.destroy();});QUnit.module('LabelSelectionWidget');QUnit.test('label_selection widget in form view',async function(assert){assert.expect(12);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="selection" widget="label_selection" '+' options="{\'classes\': {\'normal\': \'secondary\', \'blocked\': \'warning\',\'done\': \'success\'}}"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_field_widget.badge.badge-warning',"should have a warning status label since selection is the second, blocked state");assert.containsNone(form,'.o_field_widget.badge.badge-secondary',"should not have a default status since selection is the second, blocked state");assert.containsNone(form,'.o_field_widget.badge.badge-success',"should not have a success status since selection is the second, blocked state");assert.strictEqual(form.$('.o_field_widget.badge.badge-warning').text(),'Blocked',"the label should say 'Blocked' since this is the label value for that state");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_widget.badge.badge-warning',"should have a warning status label since selection is the second, blocked state");assert.containsNone(form,'.o_field_widget.badge.badge-secondary',"should not have a default status since selection is the second, blocked state");assert.containsNone(form,'.o_field_widget.badge.badge-success',"should not have a success status since selection is the second, blocked state");assert.strictEqual(form.$('.o_field_widget.badge.badge-warning').text(),'Blocked',"the label should say 'Blocked' since this is the label value for that state");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_field_widget.badge.badge-warning',"should have a warning status label since selection is the second, blocked state");assert.containsNone(form,'.o_field_widget.badge.badge-secondary',"should not have a default status since selection is the second, blocked state");assert.containsNone(form,'.o_field_widget.badge.badge-success',"should not have a success status since selection is the second, blocked state");assert.strictEqual(form.$('.o_field_widget.badge.badge-warning').text(),'Blocked',"the label should say 'Blocked' since this is the label value for that state");form.destroy();});QUnit.test('label_selection widget in editable list view',async function(assert){assert.expect(21);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="selection" widget="label_selection"'+' options="{\'classes\': {\'normal\': \'secondary\', \'blocked\': \'warning\',\'done\': \'success\'}}"/>'+'</tree>',});assert.strictEqual(list.$('.o_field_widget.badge:not(:empty)').length,3,"should have three visible status labels");assert.containsOnce(list,'.o_field_widget.badge.badge-warning',"should have one warning status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-warning').text(),'Blocked',"the warning label should read 'Blocked'");assert.containsOnce(list,'.o_field_widget.badge.badge-secondary',"should have one default status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-secondary').text(),'Normal',"the default label should read 'Normal'");assert.containsOnce(list,'.o_field_widget.badge.badge-success',"should have one success status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-success').text(),'Done',"the success label should read 'Done'");await testUtils.dom.clickFirst(list.$('tbody td:not(.o_list_record_selector)'));assert.strictEqual(list.$('.o_field_widget.badge:not(:empty)').length,3,"should have three visible status labels");assert.containsOnce(list,'.o_field_widget.badge.badge-warning',"should have one warning status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-warning').text(),'Blocked',"the warning label should read 'Blocked'");assert.containsOnce(list,'.o_field_widget.badge.badge-secondary',"should have one default status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-secondary').text(),'Normal',"the default label should read 'Normal'");assert.containsOnce(list,'.o_field_widget.badge.badge-success',"should have one success status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-success').text(),'Done',"the success label should read 'Done'");await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('.o_field_widget.badge:not(:empty)').length,3,"should have three visible status labels");assert.containsOnce(list,'.o_field_widget.badge.badge-warning',"should have one warning status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-warning').text(),'Blocked',"the warning label should read 'Blocked'");assert.containsOnce(list,'.o_field_widget.badge.badge-secondary',"should have one default status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-secondary').text(),'Normal',"the default label should read 'Normal'");assert.containsOnce(list,'.o_field_widget.badge.badge-success',"should have one success status label");assert.strictEqual(list.$('.o_field_widget.badge.badge-success').text(),'Done',"the success label should read 'Done'");list.destroy();});QUnit.module('StatInfo');QUnit.test('statinfo widget formats decimal precision',async function(assert){assert.expect(2);this.data.partner.fields.monetary={string:"Monetary",type:'monetary'};this.data.partner.records[0].monetary=9.999999;this.data.partner.records[0].currency_id=1;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<button class="oe_stat_button" name="items" icon="fa-gear">'+'<field name="qux" widget="statinfo"/>'+'</button>'+'<button class="oe_stat_button" name="money" icon="fa-money">'+'<field name="monetary" widget="statinfo"/>'+'</button>'+'</form>',res_id:1,});assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').eq(0).text(),'0.4',"Default precision should be [16,1]");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').eq(1).text(),'10.00',"Currency decimal precision should be 2");form.destroy();});QUnit.test('statinfo widget in form view',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div class="oe_button_box" name="button_box">'+'<button class="oe_stat_button" name="items"  type="object" icon="fa-gear">'+'<field name="int_field" widget="statinfo"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'int_field',"should have 'int_field' as text");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should still have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should still have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'int_field',"should have 'int_field' as text");await testUtils.form.clickSave(form);assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'int_field',"should have 'int_field' as text");form.destroy();});QUnit.test('statinfo widget in form view with specific label_field',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div class="oe_button_box" name="button_box">'+'<button class="oe_stat_button" name="items"  type="object" icon="fa-gear">'+'<field string="Useful stat button" name="int_field" widget="statinfo" '+'options="{\'label_field\': \'foo\'}"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo" invisible="1"/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'yop',"should have 'yop' as text, since it is the value of field foo");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should still have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should still have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'yop',"should have 'yop' as text, since it is the value of field foo");await testUtils.form.clickSave(form);assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'yop',"should have 'yop' as text, since it is the value of field foo");form.destroy();});QUnit.test('statinfo widget in form view with no label',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div class="oe_button_box" name="button_box">'+'<button class="oe_stat_button" name="items"  type="object" icon="fa-gear">'+'<field string="Useful stat button" name="int_field" widget="statinfo" nolabel="1"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo" invisible="1"/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'',"should not have any label");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should still have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should still have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'',"should not have any label");await testUtils.form.clickSave(form);assert.containsOnce(form,'.oe_stat_button .o_field_widget.o_stat_info',"should have one stat button");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_value').text(),'10',"should have 10 as value");assert.strictEqual(form.$('.oe_stat_button .o_field_widget.o_stat_info .o_stat_text').text(),'',"should not have any label");form.destroy();});QUnit.module('PercentPie');QUnit.test('percentpie widget in form view with value < 50%',async function(assert){assert.expect(12);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="int_field" widget="percentpie"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_field_percent_pie.o_field_widget .o_pie',"should have a pie chart");assert.strictEqual(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_pie_value').text(),'10%',"should have 10% as pie value since int_field=10");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').first().attr('style'),'transform: rotate(180deg);'),"left mask should be covering the whole left side of the pie");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').last().attr('style'),'transform: rotate(36deg);'),"right mask should be rotated from 360*(10/100) = 36 degrees");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_percent_pie.o_field_widget .o_pie',"should have a pie chart");assert.strictEqual(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_pie_value').text(),'10%',"should have 10% as pie value since int_field=10");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').first().attr('style'),'transform: rotate(180deg);'),"left mask should be covering the whole left side of the pie");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').last().attr('style'),'transform: rotate(36deg);'),"right mask should be rotated from 360*(10/100) = 36 degrees");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_field_percent_pie.o_field_widget .o_pie',"should have a pie chart");assert.strictEqual(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_pie_value').text(),'10%',"should have 10% as pie value since int_field=10");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').first().attr('style'),'transform: rotate(180deg);'),"left mask should be covering the whole left side of the pie");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').last().attr('style'),'transform: rotate(36deg);'),"right mask should be rotated from 360*(10/100) = 36 degrees");form.destroy();});QUnit.test('percentpie widget in form view with value > 50%',async function(assert){assert.expect(12);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="int_field" widget="percentpie"/>'+'</group>'+'</sheet>'+'</form>',res_id:3,});assert.containsOnce(form,'.o_field_percent_pie.o_field_widget .o_pie',"should have a pie chart");assert.strictEqual(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_pie_value').text(),'80%',"should have 80% as pie value since int_field=80");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').first().attr('style'),'transform: rotate(288deg);'),"left mask should be rotated from 360*(80/100) = 288 degrees");assert.hasClass(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').last(),'o_full',"right mask should be hidden since the value > 50%");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_percent_pie.o_field_widget .o_pie',"should have a pie chart");assert.strictEqual(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_pie_value').text(),'80%',"should have 80% as pie value since int_field=80");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').first().attr('style'),'transform: rotate(288deg);'),"left mask should be rotated from 360*(80/100) = 288 degrees");assert.hasClass(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').last(),'o_full',"right mask should be hidden since the value > 50%");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_field_percent_pie.o_field_widget .o_pie',"should have a pie chart");assert.strictEqual(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_pie_value').text(),'80%',"should have 80% as pie value since int_field=80");assert.ok(_.str.include(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').first().attr('style'),'transform: rotate(288deg);'),"left mask should be rotated from 360*(80/100) = 288 degrees");assert.hasClass(form.$('.o_field_percent_pie.o_field_widget .o_pie .o_mask').last(),'o_full',"right mask should be hidden since the value > 50%");form.destroy();});QUnit.module('FieldDomain');QUnit.test('The domain editor should not crash the view when given a dynamic filter',async function(assert){assert.expect(1);this.data.partner.records[0].foo='[["int_field", "=", uid]]';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo" widget="domain" options="{\'model\': \'partner\'}"/>'+'<field name="int_field" invisible="1"/>'+'</form>',res_id:1,session:{user_context:{uid:14},},});assert.strictEqual(form.$('.o_read_mode').text(),"This domain is not supported.","The widget should not crash the view, but gracefully admit its failure.");form.destroy();});QUnit.test('basic domain field usage is ok',async function(assert){assert.expect(7);this.data.partner.records[0].foo="[]";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="foo" widget="domain" options="{\'model\': \'partner_type\'}"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);var $domain=form.$(".o_field_domain");var $domainAddFirstNodeButton=$domain.find(".o_domain_add_first_node_button");assert.equal($domainAddFirstNodeButton.length,1,"there should be a button to create first domain element");await testUtils.dom.click($domainAddFirstNodeButton);var $fieldSelector=$domain.find(".o_field_selector");assert.equal($fieldSelector.length,1,"there should be a field selector");await testUtils.dom.triggerEvents($fieldSelector,'focus');var $fieldSelectorPopover=$fieldSelector.find(".o_field_selector_popover");assert.ok($fieldSelectorPopover.is(":visible"),"field selector popover should be visible");assert.containsOnce($fieldSelectorPopover,'.o_field_selector_search input',"field selector popover should contain a search input");var $lis=$fieldSelectorPopover.find("li");var $colorIndex=$();$lis.each(function(){var $li=$(this);if($li.html().indexOf("Color index")>=0){$colorIndex=$li;}});assert.equal($colorIndex.length,1,"field selector popover should contain 'Color index' field");await testUtils.dom.click($colorIndex);await testUtils.fields.editAndTrigger($('.o_domain_leaf_value_input'),2,['change']);assert.equal($domain.find(".o_domain_show_selection_button").text().trim().substr(0,2),"1 ","changing color value to 2 should reveal only one record");await testUtils.form.clickSave(form);$domain=form.$(".o_field_domain");assert.ok($domain.html().indexOf("Color index")>=0,"field selector readonly value should now contain 'Color index'");form.destroy();});QUnit.test('domain field is correctly reset on every view change',async function(assert){assert.expect(7);this.data.partner.records[0].foo='[["id","=",1]]';this.data.partner.fields.bar.type="char";this.data.partner.records[0].bar="product";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="bar"/>'+'<field name="foo" widget="domain" options="{\'model\': \'bar\'}"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);var $domain=form.$(".o_field_domain");var $fieldSelector=$domain.find(".o_field_selector");assert.equal($fieldSelector.length,1,"there should be a field selector");await testUtils.dom.triggerEvents($fieldSelector,'focus');var $fieldSelectorPopover=$fieldSelector.find(".o_field_selector_popover");assert.ok($fieldSelectorPopover.is(":visible"),"field selector popover should be visible");var $lis=$fieldSelectorPopover.find("li");var $sampleLi=$();$lis.each(function(){var $li=$(this);if($li.html().indexOf("Product Name")>=0){$sampleLi=$li;}});assert.strictEqual($lis.length,1,"field selector popover should contain only one field");assert.strictEqual($sampleLi.length,1,"field selector popover should contain 'Product Name' field");await testUtils.dom.click(form.$("input.o_field_widget"));await testUtils.fields.editInput(form.$("input.o_field_widget"),"partner_type");$fieldSelector=form.$(".o_field_selector");$fieldSelector.trigger('focusin');$fieldSelectorPopover=$fieldSelector.find(".o_field_selector_popover");assert.ok($fieldSelectorPopover.is(":visible"),"field selector popover should be visible");$lis=$fieldSelectorPopover.find("li");$sampleLi=$();$lis.each(function(){var $li=$(this);if($li.html().indexOf("Color index")>=0){$sampleLi=$li;}});assert.strictEqual($lis.length,2,"field selector popover should contain two fields");assert.strictEqual($sampleLi.length,1,"field selector popover should contain 'Color index' field");form.destroy();});QUnit.test('domain field can be reset with a new domain (from onchange)',async function(assert){assert.expect(2);this.data.partner.records[0].foo='[]';this.data.partner.onchanges={display_name:function(obj){obj.foo='[["id", "=", 1]]';},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="display_name"/>'+'<field name="foo" widget="domain" options="{\'model\': \'partner\'}"/>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.equal(form.$('.o_domain_show_selection_button').text().trim(),'5 record(s)',"the domain being empty, there should be 5 records");await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'new value');assert.equal(form.$('.o_domain_show_selection_button').text().trim(),'1 record(s)',"the domain has changed, there should be only 1 record");form.destroy();});QUnit.test('domain field: handle false domain as []',async function(assert){assert.expect(3);this.data.partner.records[0].foo=false;this.data.partner.fields.bar.type="char";this.data.partner.records[0].bar="product";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="bar"/>'+'<field name="foo" widget="domain" options="{\'model\': \'bar\'}"/>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='search_count'){assert.deepEqual(args.args[0],[],"should send a valid domain");}
return this._super.apply(this,arguments);},res_id:1,});assert.strictEqual(form.$('.o_field_widget[name=foo]:not(.o_field_empty)').length,1,"there should be a domain field, not considered empty");await testUtils.form.clickEdit(form);var $warning=form.$('.o_field_widget[name=foo] .text-warning');assert.strictEqual($warning.length,0,"should not display that the domain is invalid");form.destroy();});QUnit.test('basic domain field: show the selection',async function(assert){assert.expect(2);this.data.partner.records[0].foo="[]";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="foo" widget="domain" options="{\'model\': \'partner_type\'}"/>'+'</group>'+'</sheet>'+'</form>',archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,search':'<search><field name="name" string="Name"/></search>',},res_id:1,});assert.equal(form.$(".o_domain_show_selection_button").text().trim().substr(0,2),"2 ","selection should contain 2 records");await testUtils.dom.click(form.$(".o_domain_show_selection_button"));assert.strictEqual($('.modal .o_list_view .o_data_row').length,2,"should have open a list view with 2 records in a dialog");await testUtils.dom.click($('.modal .o_list_view .o_data_row:first .o_data_cell'));form.destroy();});QUnit.test('field context is propagated when opening selection',async function(assert){assert.expect(1);this.data.partner.records[0].foo="[]";var form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="foo" widget="domain" options="{'model': 'partner_type'}" context="{'tree_view_ref': 3}"/>
                </form>
            `,archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,3,list':'<tree><field name="id"/></tree>','partner_type,false,search':'<search><field name="name" string="Name"/></search>',},res_id:1,});await testUtils.dom.click(form.$(".o_domain_show_selection_button"));assert.strictEqual($('.modal .o_data_row').text(),'1214',"should have picked the correct list view");form.destroy();});QUnit.module('FieldProgressBar');QUnit.test('Field ProgressBar: max_value should update',async function(assert){assert.expect(3);this.data.partner.records=this.data.partner.records.slice(0,1);this.data.partner.records[0].qux=2;this.data.partner.onchanges={display_name:function(obj){obj.int_field=999;obj.qux=5;}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="display_name" />'+'<field name="qux" invisible="1" />'+'<field name="int_field" widget="progressbar" options="{\'current_value\': \'int_field\', \'max_value\': \'qux\'}" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{int_field:999,qux:5,display_name:'new name'},'New value of progress bar saved');}
return this._super.apply(this,arguments);}});assert.strictEqual(form.$('.o_progressbar_value').text(),'10 / 2','The initial value of the progress bar should be correct');await testUtils.fields.editInput(form.$('.o_input[name=display_name]'),'new name');assert.strictEqual(form.$('.o_progressbar_value').text(),'999 / 5','The value of the progress bar should be correct after the update');await testUtilsDom.click(form.$buttons.find('.o_form_button_save'));form.destroy();});QUnit.test('Field ProgressBar: value should not update in readonly mode when sliding the bar',async function(assert){assert.expect(4);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field" widget="progressbar" options="{\'editable\': true}" />'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(route);return this._super.apply(this,arguments);}});var $view=$('#qunit-fixture').contents();$view.prependTo('body');assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','Initial value should be correct')
var $progressBarEl=form.$('.o_progress');var top=$progressBarEl.offset().top+5;var left=$progressBarEl.offset().left+5;try{testUtils.triggerPositionalMouseEvent(left,top,"click");}catch(e){form.destroy();$view.remove();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','New value should be different than initial after click');assert.verifySteps(["/web/dataset/call_kw/partner/read"]);form.destroy();$view.remove();});QUnit.test('Field ProgressBar: value should not update in edit mode when sliding the bar',async function(assert){assert.expect(6);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field" widget="progressbar" options="{\'editable\': true}" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){assert.step(route);return this._super.apply(this,arguments);}});var $view=$('#qunit-fixture').contents();$view.prependTo('body');assert.ok(form.$('.o_form_view').hasClass('o_form_editable'),'Form in edit mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','Initial value should be correct')
var $progressBarEl=form.$('.o_progress');var top=$progressBarEl.offset().top+5;var left=$progressBarEl.offset().left+5;try{testUtils.triggerPositionalMouseEvent(left,top,"click");}catch(e){form.destroy();$view.remove();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
assert.strictEqual(form.$('.o_progressbar_value.o_input').val(),"99",'Value of input is not changed');await testUtilsDom.click(form.$buttons.find('.o_form_button_save'));assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','New value should be different than initial after click');assert.verifySteps(["/web/dataset/call_kw/partner/read"]);form.destroy();$view.remove();});QUnit.test('Field ProgressBar: value should update in edit mode when typing in input',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field" widget="progressbar" options="{\'editable\': true}" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].int_field,69,'New value of progress bar saved');}
return this._super.apply(this,arguments);}});assert.ok(form.$('.o_form_view').hasClass('o_form_editable'),'Form in edit mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));var $valInput=form.$('.o_progressbar_value.o_input');assert.strictEqual($valInput.val(),'99','Initial value in input is correct');await testUtils.fields.editAndTrigger($valInput,'69',['input','blur']);await testUtilsDom.click(form.$buttons.find('.o_form_button_save'));assert.strictEqual(form.$('.o_progressbar_value').text(),'69%','New value should be different than initial after click');form.destroy();});QUnit.test('Field ProgressBar: value should update in edit mode when typing in input with field max value',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="qux" invisible="1" />'+'<field name="int_field" widget="progressbar" options="{\'editable\': true, \'max_value\': \'qux\'}" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].int_field,69,'New value of progress bar saved');}
return this._super.apply(this,arguments);}});assert.ok(form.$('.o_form_view').hasClass('o_form_editable'),'Form in edit mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99 / 0','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));var $valInput=form.$('.o_progressbar_value.o_input');assert.strictEqual($valInput.val(),'99','Initial value in input is correct');await testUtils.fields.editAndTrigger($valInput,'69',['input','blur']);await testUtilsDom.click(form.$buttons.find('.o_form_button_save'));assert.strictEqual(form.$('.o_progressbar_value').text(),'69 / 0','New value should be different than initial after click');form.destroy();});QUnit.test('Field ProgressBar: max value should update in edit mode when typing in input with field max value',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="qux" invisible="1" />'+'<field name="int_field" widget="progressbar" options="{\'editable\': true, \'max_value\': \'qux\', \'edit_max_value\': true}" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].qux,69,'New value of progress bar saved');}
return this._super.apply(this,arguments);}});assert.ok(form.$('.o_form_view').hasClass('o_form_editable'),'Form in edit mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99 / 0','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));var $valInput=form.$('.o_progressbar_value.o_input');assert.strictEqual($valInput.val(),"0.44444",'Initial value in input is correct');await testUtils.fields.editAndTrigger($valInput,'69',['input','blur']);await testUtilsDom.click(form.$buttons.find('.o_form_button_save'));assert.strictEqual(form.$('.o_progressbar_value').text(),'99 / 69','New value should be different than initial after click');form.destroy();});QUnit.test('Field ProgressBar: Standard readonly mode is readonly',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="qux" invisible="1" />'+'<field name="int_field" widget="progressbar" options="{\'editable\': true, \'max_value\': \'qux\', \'edit_max_value\': true}" />'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(route);return this._super.apply(this,arguments);}});assert.ok(form.$('.o_form_view').hasClass('o_form_readonly'),'Form in readonly mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99 / 0','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));assert.containsNone(form,'.o_progressbar_value.o_input','no input in readonly mode');assert.verifySteps(["/web/dataset/call_kw/partner/read"]);form.destroy();});QUnit.test('Field ProgressBar: max value should update in readonly mode with right parameter when typing in input with field max value',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="qux" invisible="1" />'+'<field name="int_field" widget="progressbar" options="{\'editable\': true, \'max_value\': \'qux\', \'edit_max_value\': true, \'editable_readonly\': true}" />'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].qux,69,'New value of progress bar saved');}
return this._super.apply(this,arguments);}});assert.ok(form.$('.o_form_view').hasClass('o_form_readonly'),'Form in readonly mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99 / 0','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));var $valInput=form.$('.o_progressbar_value.o_input');assert.strictEqual($valInput.val(),"0.44444",'Initial value in input is correct');await testUtils.fields.editAndTrigger($valInput,'69',['input','blur']);assert.strictEqual(form.$('.o_progressbar_value').text(),'99 / 69','New value should be different than initial after changing it');form.destroy();});QUnit.test('Field ProgressBar: value should update in readonly mode with right parameter when typing in input with field value',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field" widget="progressbar" options="{\'editable\': true, \'editable_readonly\': true}" />'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].int_field,69,'New value of progress bar saved');}
return this._super.apply(this,arguments);}});assert.ok(form.$('.o_form_view').hasClass('o_form_readonly'),'Form in readonly mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));var $valInput=form.$('.o_progressbar_value.o_input');assert.strictEqual($valInput.val(),"99",'Initial value in input is correct');await testUtils.fields.editAndTrigger($valInput,'69.6',['input','blur']);assert.strictEqual(form.$('.o_progressbar_value').text(),'69%','New value should be different than initial after changing it');form.destroy();});QUnit.test('Field ProgressBar: write float instead of int works, in locale',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field" widget="progressbar" options="{\'editable\': true}" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},translateParameters:{thousands_sep:"#",decimal_point:":",},mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].int_field,1037,'New value of progress bar saved');}
return this._super.apply(this,arguments);}});assert.ok(form.$('.o_form_view').hasClass('o_form_editable'),'Form in edit mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));var $valInput=form.$('.o_progressbar_value.o_input');assert.strictEqual($valInput.val(),'99','Initial value in input is correct');await testUtils.fields.editAndTrigger($valInput,'1#037:9',['input','blur']);await testUtilsDom.click(form.$buttons.find('.o_form_button_save'));assert.strictEqual(form.$('.o_progressbar_value').text(),'1k%','New value should be different than initial after click');form.destroy();});QUnit.test('Field ProgressBar: write gibbrish instead of int throws warning',async function(assert){assert.expect(5);this.data.partner.records[0].int_field=99;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field" widget="progressbar" options="{\'editable\': true}" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},interceptsPropagate:{call_service:function(ev){if(ev.data.service==='notification'){assert.strictEqual(ev.data.method,'notify');assert.strictEqual(ev.data.args[0].message,"Please enter a numerical value");}}},});assert.ok(form.$('.o_form_view').hasClass('o_form_editable'),'Form in edit mode');assert.strictEqual(form.$('.o_progressbar_value').text(),'99%','Initial value should be correct');await testUtilsDom.click(form.$('.o_progress'));var $valInput=form.$('.o_progressbar_value.o_input');assert.strictEqual($valInput.val(),'99','Initial value in input is correct');await testUtils.fields.editAndTrigger($valInput,'trente sept virgule neuf',['input']);form.destroy();});QUnit.module('FieldColor',{before:function(){return ajax.loadXML('/web/static/src/xml/colorpicker.xml',core.qweb);},});QUnit.test('Field Color: default widget state',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="hex_color" widget="color" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_color'));assert.containsOnce($,'.modal');assert.containsNone($('.modal'),'.o_opacity_slider',"Opacity slider should not be present");assert.containsNone($('.modal'),'.o_opacity_input',"Opacity input should not be present");await testUtils.dom.click($('.modal .btn:contains("Discard")'));assert.strictEqual(document.activeElement,form.$('.o_field_color')[0],"Focus should go back to the color field");form.destroy();});QUnit.test('Field Color: behaviour in different views',async function(assert){assert.expect(2);this.data.partner.records[0].p=[4,2];this.data.partner.records[1].hex_color='#ff0080';const form=await createView({arch:'<form>'+'<field name="hex_color" widget="color"/>'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name"/>'+'<field name="hex_color" widget="color"/>'+'</tree>'+'</field>'+'</form>',data:this.data,model:'partner',res_id:1,View:FormView,});await testUtils.dom.click(form.$('.o_field_color:first()'));assert.containsNone($(document.body),'.modal',"Color field in readonly shouldn't be editable");const rowInitialHeight=form.$('.o_data_row:first()').height();await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_row:first() .o_data_cell:first()'));assert.strictEqual(rowInitialHeight,form.$('.o_data_row:first()').height(),"Color field shouldn't change the color height when edited");form.destroy();});QUnit.test('Field Color: pick and reset colors',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="hex_color" widget="color" />'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual($('.o_field_color').css('backgroundColor'),'rgb(255, 0, 0)',"Background of the color field should be initially red");await testUtils.dom.click(form.$('.o_field_color'));await testUtils.fields.editAndTrigger($('.modal .o_hex_input'),'#00ff00',['change']);await testUtils.dom.click($('.modal .btn:contains("Choose")'));assert.strictEqual($('.o_field_color').css('backgroundColor'),'rgb(0, 255, 0)',"Background of the color field should be updated to green");form.destroy();});QUnit.module('FieldBadge');QUnit.test('FieldBadge component on a char field in list view',async function(assert){assert.expect(3);const list=await createView({View:ListView,model:'partner',data:this.data,arch:`<list><field name="display_name" widget="badge"/></list>`,});assert.containsOnce(list,'.o_field_badge[name="display_name"]:contains(first record)');assert.containsOnce(list,'.o_field_badge[name="display_name"]:contains(second record)');assert.containsOnce(list,'.o_field_badge[name="display_name"]:contains(aaa)');list.destroy();});QUnit.test('FieldBadge component on a selection field in list view',async function(assert){assert.expect(3);const list=await createView({View:ListView,model:'partner',data:this.data,arch:`<list><field name="selection" widget="badge"/></list>`,});assert.containsOnce(list,'.o_field_badge[name="selection"]:contains(Blocked)');assert.containsOnce(list,'.o_field_badge[name="selection"]:contains(Normal)');assert.containsOnce(list,'.o_field_badge[name="selection"]:contains(Done)');list.destroy();});QUnit.test('FieldBadge component on a many2one field in list view',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:'partner',data:this.data,arch:`<list><field name="trululu" widget="badge"/></list>`,});assert.containsOnce(list,'.o_field_badge[name="trululu"]:contains(first record)');assert.containsOnce(list,'.o_field_badge[name="trululu"]:contains(aaa)');list.destroy();});QUnit.test('FieldBadge component with decoration-xxx attributes',async function(assert){assert.expect(6);const list=await createView({View:ListView,model:'partner',data:this.data,arch:`
                <list>
                    <field name="selection"/>
                    <field name="foo" widget="badge" decoration-danger="selection == 'done'" decoration-warning="selection == 'blocked'"/>
                </list>`,});assert.containsN(list,'.o_field_badge[name="foo"]',5);assert.containsOnce(list,'.o_field_badge[name="foo"].bg-danger-light');assert.containsOnce(list,'.o_field_badge[name="foo"].bg-warning-light');await list.reload();assert.containsN(list,'.o_field_badge[name="foo"]',5);assert.containsOnce(list,'.o_field_badge[name="foo"].bg-danger-light');assert.containsOnce(list,'.o_field_badge[name="foo"].bg-warning-light');list.destroy();});});});});;

/* /web/static/tests/fields/field_utils_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.field_utils_tests',function(require){"use strict";var core=require('web.core');var session=require('web.session');var fieldUtils=require('web.field_utils');QUnit.module('fields',{},function(){QUnit.module('field_utils');QUnit.test('format integer',function(assert){assert.expect(5);var originalGrouping=core._t.database.parameters.grouping;core._t.database.parameters.grouping=[3,3,3,3];assert.strictEqual(fieldUtils.format.integer(1000000),'1,000,000');core._t.database.parameters.grouping=[3,2,-1];assert.strictEqual(fieldUtils.format.integer(106500),'1,06,500');core._t.database.parameters.grouping=[1,2,-1];assert.strictEqual(fieldUtils.format.integer(106500),'106,50,0');assert.strictEqual(fieldUtils.format.integer(0),"0");assert.strictEqual(fieldUtils.format.integer(false),"");core._t.database.parameters.grouping=originalGrouping;});QUnit.test('format float',function(assert){assert.expect(5);var originalParameters=$.extend(true,{},core._t.database.parameters);core._t.database.parameters.grouping=[3,3,3,3];assert.strictEqual(fieldUtils.format.float(1000000),'1,000,000.00');core._t.database.parameters.grouping=[3,2,-1];assert.strictEqual(fieldUtils.format.float(106500),'1,06,500.00');core._t.database.parameters.grouping=[1,2,-1];assert.strictEqual(fieldUtils.format.float(106500),'106,50,0.00');_.extend(core._t.database.parameters,{grouping:[3,0],decimal_point:',',thousands_sep:'.'});assert.strictEqual(fieldUtils.format.float(6000),'6.000,00');assert.strictEqual(fieldUtils.format.float(false),'');core._t.database.parameters=originalParameters;});QUnit.test("format_datetime",function(assert){assert.expect(1);var date_string="2009-05-04 12:34:23";var date=fieldUtils.parse.datetime(date_string,{},{timezone:false});var str=fieldUtils.format.datetime(date,{},{timezone:false});assert.strictEqual(str,moment(date).format("MM/DD/YYYY HH:mm:ss"));});QUnit.test("format_datetime (with different timezone offset)",function(assert){assert.expect(2);var dateFormat=core._t.database.parameters.date_format;core._t.database.parameters.date_format='%m/%d/%Y';session.getTZOffset=function(date){var startDate=new Date(2017,2,26);var endDate=new Date(2017,9,29);if(startDate<date&&date<endDate){return 120;}else{return 60;}};var str=fieldUtils.format.datetime(moment.utc('2017-01-01T10:00:00Z'));assert.strictEqual(str,'01/01/2017 11:00:00');str=fieldUtils.format.datetime(moment.utc('2017-06-01T10:00:00Z'));assert.strictEqual(str,'06/01/2017 12:00:00');core._t.database.parameters.date_format=dateFormat;});QUnit.test("format_many2one",function(assert){assert.expect(2);assert.strictEqual('',fieldUtils.format.many2one(null));assert.strictEqual('A M2O value',fieldUtils.format.many2one({data:{display_name:'A M2O value'},}));});QUnit.test('format monetary',function(assert){assert.expect(1);assert.strictEqual(fieldUtils.format.monetary(false),'');});QUnit.test('format char',function(assert){assert.expect(1);assert.strictEqual(fieldUtils.format.char(),'',"undefined char should be formatted as an empty string");});QUnit.test('format many2many',function(assert){assert.expect(3);assert.strictEqual(fieldUtils.format.many2many({data:[]}),'No records');assert.strictEqual(fieldUtils.format.many2many({data:[1]}),'1 record');assert.strictEqual(fieldUtils.format.many2many({data:[1,2]}),'2 records');});QUnit.test('format one2many',function(assert){assert.expect(3);assert.strictEqual(fieldUtils.format.one2many({data:[]}),'No records');assert.strictEqual(fieldUtils.format.one2many({data:[1]}),'1 record');assert.strictEqual(fieldUtils.format.one2many({data:[1,2]}),'2 records');});QUnit.test('format binary',function(assert){assert.expect(1);assert.strictEqual(fieldUtils.format.binary('Cg=='),'2.92 Bytes');});QUnit.test('format percentage',function(assert){assert.expect(12);var originalParameters=_.clone(core._t.database.parameters);assert.strictEqual(fieldUtils.format.percentage(0),'0%');assert.strictEqual(fieldUtils.format.percentage(0.5),'50%');assert.strictEqual(fieldUtils.format.percentage(1),'100%');assert.strictEqual(fieldUtils.format.percentage(-0.2),'-20%');assert.strictEqual(fieldUtils.format.percentage(2.5),'250%');assert.strictEqual(fieldUtils.format.percentage(0.125),'12.5%');assert.strictEqual(fieldUtils.format.percentage(0.666666),'66.67%');assert.strictEqual(fieldUtils.format.percentage(false),'0%');assert.strictEqual(fieldUtils.format.percentage(50,null,{humanReadable:function(val){return true;}}),'5k%');_.extend(core._t.database.parameters,{grouping:[3,0],decimal_point:',',thousands_sep:'.'});assert.strictEqual(fieldUtils.format.percentage(0.125),'12,5%');assert.strictEqual(fieldUtils.format.percentage(0.666666),'66,67%');assert.strictEqual(fieldUtils.format.percentage(0.5,null,{noSymbol:true}),'50');core._t.database.parameters=originalParameters;});QUnit.test('format float time',function(assert){assert.expect(7);assert.strictEqual(fieldUtils.format.float_time(2),'02:00');assert.strictEqual(fieldUtils.format.float_time(3.5),'03:30');assert.strictEqual(fieldUtils.format.float_time(0.25),'00:15');assert.strictEqual(fieldUtils.format.float_time(-0.5),'-00:30');const options={noLeadingZeroHour:true,};assert.strictEqual(fieldUtils.format.float_time(2,null,options),'2:00');assert.strictEqual(fieldUtils.format.float_time(3.5,null,options),'3:30');assert.strictEqual(fieldUtils.format.float_time(-0.5,null,options),'-0:30');});QUnit.test('parse float',function(assert){assert.expect(10);var originalParameters=_.clone(core._t.database.parameters);_.extend(core._t.database.parameters,{grouping:[3,0],decimal_point:'.',thousands_sep:','});assert.strictEqual(fieldUtils.parse.float(""),0);assert.strictEqual(fieldUtils.parse.float("0"),0);assert.strictEqual(fieldUtils.parse.float("100.00"),100);assert.strictEqual(fieldUtils.parse.float("-100.00"),-100);assert.strictEqual(fieldUtils.parse.float("1,000.00"),1000);assert.strictEqual(fieldUtils.parse.float("1,000,000.00"),1000000);assert.strictEqual(fieldUtils.parse.float('1,234.567'),1234.567);assert.throws(function(){fieldUtils.parse.float("1.000.000");},"Throw an exception if it's not a valid number");_.extend(core._t.database.parameters,{grouping:[3,0],decimal_point:',',thousands_sep:'.'});assert.strictEqual(fieldUtils.parse.float('1.234,567'),1234.567);assert.throws(function(){fieldUtils.parse.float("1,000,000");},"Throw an exception if it's not a valid number");_.extend(core._t.database.parameters,originalParameters);});QUnit.test('parse integer',function(assert){assert.expect(11);var originalParameters=_.clone(core._t.database.parameters);_.extend(core._t.database.parameters,{grouping:[3,0],decimal_point:'.',thousands_sep:','});assert.strictEqual(fieldUtils.parse.integer(""),0);assert.strictEqual(fieldUtils.parse.integer("0"),0);assert.strictEqual(fieldUtils.parse.integer("100"),100);assert.strictEqual(fieldUtils.parse.integer("-100"),-100);assert.strictEqual(fieldUtils.parse.integer("1,000"),1000);assert.strictEqual(fieldUtils.parse.integer("1,000,000"),1000000);assert.throws(function(){fieldUtils.parse.integer("1.000.000");},"Throw an exception if it's not a valid number");assert.throws(function(){fieldUtils.parse.integer("1,234.567");},"Throw an exception if the number is a float");_.extend(core._t.database.parameters,{grouping:[3,0],decimal_point:',',thousands_sep:'.'});assert.strictEqual(fieldUtils.parse.integer("1.000.000"),1000000);assert.throws(function(){fieldUtils.parse.integer("1,000,000");},"Throw an exception if it's not a valid number");assert.throws(function(){fieldUtils.parse.integer("1.234,567");},"Throw an exception if the number is a float");_.extend(core._t.database.parameters,originalParameters);});QUnit.test('parse monetary',function(assert){assert.expect(11);var originalCurrencies=session.currencies;session.currencies={1:{digits:[69,2],position:"after",symbol:"€"},3:{digits:[69,2],position:"before",symbol:"$"}};assert.strictEqual(fieldUtils.parse.monetary(""),0);assert.strictEqual(fieldUtils.parse.monetary("0"),0);assert.strictEqual(fieldUtils.parse.monetary("100.00"),100);assert.strictEqual(fieldUtils.parse.monetary("-100.00"),-100);assert.strictEqual(fieldUtils.parse.monetary("1,000.00"),1000);assert.strictEqual(fieldUtils.parse.monetary("1,000,000.00"),1000000);assert.strictEqual(fieldUtils.parse.monetary("$&nbsp;125.00",{},{currency_id:3}),125);assert.strictEqual(fieldUtils.parse.monetary("1,000.00&nbsp;€",{},{currency_id:1}),1000);assert.throws(function(){fieldUtils.parse.monetary("$ 12.00",{},{currency_id:3})},/is not a correct/);assert.throws(function(){fieldUtils.parse.monetary("$&nbsp;12.00",{},{currency_id:1})},/is not a correct/);assert.throws(function(){fieldUtils.parse.monetary("$&nbsp;12.00&nbsp;34",{},{currency_id:3})},/is not a correct/);session.currencies=originalCurrencies;});QUnit.test('parse percentage',function(assert){assert.expect(7);var originalParameters=_.clone(core._t.database.parameters);assert.strictEqual(fieldUtils.parse.percentage(""),0);assert.strictEqual(fieldUtils.parse.percentage("0"),0);assert.strictEqual(fieldUtils.parse.percentage("0.5"),0.005);assert.strictEqual(fieldUtils.parse.percentage("1"),0.01);assert.strictEqual(fieldUtils.parse.percentage("100"),1);_.extend(core._t.database.parameters,{grouping:[3,0],decimal_point:',',thousands_sep:'.'});assert.strictEqual(fieldUtils.parse.percentage("1.234,56"),12.3456);assert.strictEqual(fieldUtils.parse.percentage("6,02"),0.0602);core._t.database.parameters=originalParameters;});QUnit.test('parse datetime',function(assert){assert.expect(7);var originalParameters=_.clone(core._t.database.parameters);var originalLocale=moment.locale();var dateStr,date1,date2;moment.defineLocale('englishForTest',{dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10,output=(~~(number%100/10)===1)?'th':(b===1)?'st':(b===2)?'nd':(b===3)?'rd':'th';return number+output;},});moment.defineLocale('norvegianForTest',{monthsShort:'jan._feb._mars_april_mai_juni_juli_aug._sep._okt._nov._des.'.split('_'),monthsParseExact:true,dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:'%d.',});moment.locale('englishForTest');_.extend(core._t.database.parameters,{date_format:'%m/%d/%Y',time_format:'%H:%M:%S'});assert.throws(function(){fieldUtils.parse.datetime("13/01/2019 12:00:00",{},{});},/is not a correct/,"Wrongly formated dates should be invalid");assert.throws(function(){fieldUtils.parse.datetime("10000-01-01 12:00:00",{},{});},/is not a correct/,"Dates after 9999 should be invalid");assert.throws(function(){fieldUtils.parse.datetime("999-01-01 12:00:00",{},{});},/is not a correct/,"Dates before 1000 should be invalid");dateStr='01/13/2019 10:05:45';date1=fieldUtils.parse.datetime(dateStr);date2=moment.utc(dateStr,['MM/DD/YYYY HH:mm:ss'],true);assert.equal(date1.format(),date2.format(),"Date with leading 0");dateStr='1/14/2019 10:5:45';date1=fieldUtils.parse.datetime(dateStr);date2=moment.utc(dateStr,['M/D/YYYY H:m:s'],true);assert.equal(date1.format(),date2.format(),"Date without leading 0");dateStr='01/01/1000 10:15:45';date1=fieldUtils.parse.datetime(dateStr);date2=moment.utc(dateStr,['MM/DD/YYYY HH:mm:ss'],true);assert.equal(date1.format(),date2.format(),"can parse dates of year 1");moment.locale('norvegianForTest');_.extend(core._t.database.parameters,{date_format:'%d. %b %Y',time_format:'%H:%M:%S'});dateStr='16. jan. 2019 10:05:45';date1=fieldUtils.parse.datetime(dateStr);date2=moment.utc(dateStr,['DD. MMM YYYY HH:mm:ss'],true);assert.equal(date1.format(),date2.format(),"Day/month inverted + month i18n");moment.locale(originalLocale);moment.updateLocale("englishForTest",null);moment.updateLocale("norvegianForTest",null);core._t.database.parameters=originalParameters;});QUnit.test('parse date without separator',function(assert){assert.expect(8);var originalParameters=_.clone(core._t.database.parameters);_.extend(core._t.database.parameters,{date_format:'%d.%m/%Y'});var dateFormat="DD.MM/YYYY";assert.throws(function(){fieldUtils.parse.date("1197")},/is not a correct/,"Wrongly formated dates should be invalid");assert.throws(function(){fieldUtils.parse.date("0131")},/is not a correct/,"Wrongly formated dates should be invalid");assert.throws(function(){fieldUtils.parse.date("970131")},/is not a correct/,"Wrongly formated dates should be invalid");assert.equal(fieldUtils.parse.date("3101").format(dateFormat),"31.01/"+moment.utc().year());assert.equal(fieldUtils.parse.date("31.01").format(dateFormat),"31.01/"+moment.utc().year());assert.equal(fieldUtils.parse.date("310197").format(dateFormat),"31.01/1997");assert.equal(fieldUtils.parse.date("310117").format(dateFormat),"31.01/2017");assert.equal(fieldUtils.parse.date("31011985").format(dateFormat),"31.01/1985");core._t.database.parameters=originalParameters;});QUnit.test('parse datetime without separator',function(assert){assert.expect(3);var originalParameters=_.clone(core._t.database.parameters);_.extend(core._t.database.parameters,{date_format:'%d.%m/%Y',time_format:'%H:%M/%S'});var dateTimeFormat="DD.MM/YYYY HH:mm/ss";assert.equal(fieldUtils.parse.datetime("3101198508").format(dateTimeFormat),"31.01/1985 08:00/00");assert.equal(fieldUtils.parse.datetime("310119850833").format(dateTimeFormat),"31.01/1985 08:33/00");assert.equal(fieldUtils.parse.datetime("31/01/1985 08").format(dateTimeFormat),"31.01/1985 08:00/00");core._t.database.parameters=originalParameters;});});QUnit.test('parse smart date input',function(assert){assert.expect(10);const format="DD MM YYYY";assert.strictEqual(fieldUtils.parse.date("+1d").format(format),moment().add(1,'days').format(format));assert.strictEqual(fieldUtils.parse.datetime("+2w").format(format),moment().add(2,'weeks').format(format));assert.strictEqual(fieldUtils.parse.date("+3m").format(format),moment().add(3,'months').format(format));assert.strictEqual(fieldUtils.parse.datetime("+4y").format(format),moment().add(4,'years').format(format));assert.strictEqual(fieldUtils.parse.date("+5").format(format),moment().add(5,'days').format(format));assert.strictEqual(fieldUtils.parse.datetime("-5").format(format),moment().subtract(5,'days').format(format));assert.strictEqual(fieldUtils.parse.date("-4y").format(format),moment().subtract(4,'years').format(format));assert.strictEqual(fieldUtils.parse.datetime("-3m").format(format),moment().subtract(3,'months').format(format));assert.strictEqual(fieldUtils.parse.date("-2w").format(format),moment().subtract(2,'weeks').format(format));assert.strictEqual(fieldUtils.parse.datetime("-1d").format(format),moment().subtract(1,'days').format(format));});});;

/* /web/static/tests/fields/relational_fields_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.relational_fields_tests',function(require){"use strict";var AbstractStorageService=require('web.AbstractStorageService');var FormView=require('web.FormView');var ListView=require('web.ListView');var RamStorage=require('web.RamStorage');var relationalFields=require('web.relational_fields');var testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;QUnit.module('fields',{},function(){QUnit.module('relational_fields',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Displayed name",type:"char"},foo:{string:"Foo",type:"char",default:"My little Foo Value"},bar:{string:"Bar",type:"boolean",default:true},int_field:{string:"int_field",type:"integer",sortable:true},qux:{string:"Qux",type:"float",digits:[16,1]},p:{string:"one2many field",type:"one2many",relation:'partner',relation_field:'trululu'},turtles:{string:"one2many turtle field",type:"one2many",relation:'turtle',relation_field:'turtle_trululu'},trululu:{string:"Trululu",type:"many2one",relation:'partner'},timmy:{string:"pokemon",type:"many2many",relation:'partner_type'},product_id:{string:"Product",type:"many2one",relation:'product'},color:{type:"selection",selection:[['red',"Red"],['black',"Black"]],default:'red',string:"Color",},date:{string:"Some Date",type:"date"},datetime:{string:"Datetime Field",type:'datetime'},user_id:{string:"User",type:'many2one',relation:'user'},reference:{string:"Reference Field",type:'reference',selection:[["product","Product"],["partner_type","Partner Type"],["partner","Partner"]]},},records:[{id:1,display_name:"first record",bar:true,foo:"yop",int_field:10,qux:0.44,p:[],turtles:[2],timmy:[],trululu:4,user_id:17,reference:'product,37',},{id:2,display_name:"second record",bar:true,foo:"blip",int_field:9,qux:13,p:[],timmy:[],trululu:1,product_id:37,date:"2017-01-25",datetime:"2016-12-12 10:55:05",user_id:17,},{id:4,display_name:"aaa",bar:false,}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},partner_type:{fields:{name:{string:"Partner Type",type:"char"},color:{string:"Color index",type:"integer"},},records:[{id:12,display_name:"gold",color:2},{id:14,display_name:"silver",color:5},]},turtle:{fields:{display_name:{string:"Displayed name",type:"char"},turtle_foo:{string:"Foo",type:"char"},turtle_bar:{string:"Bar",type:"boolean",default:true},turtle_int:{string:"int",type:"integer",sortable:true},turtle_description:{string:"Description",type:"text"},turtle_trululu:{string:"Trululu",type:"many2one",relation:'partner'},turtle_ref:{string:"Reference",type:'reference',selection:[["product","Product"],["partner","Partner"]]},product_id:{string:"Product",type:"many2one",relation:'product',required:true},partner_ids:{string:"Partner",type:"many2many",relation:'partner'},},records:[{id:1,display_name:"leonardo",turtle_bar:true,turtle_foo:"yop",partner_ids:[],},{id:2,display_name:"donatello",turtle_bar:true,turtle_foo:"blip",turtle_int:9,partner_ids:[2,4],},{id:3,display_name:"raphael",product_id:37,turtle_bar:false,turtle_foo:"kawa",turtle_int:21,partner_ids:[],turtle_ref:'product,37',}],onchanges:{},},user:{fields:{name:{string:"Name",type:"char"},partner_ids:{string:"one2many partners field",type:"one2many",relation:'partner',relation_field:'user_id'},},records:[{id:17,name:"Aline",partner_ids:[1,2],},{id:19,name:"Christine",}]},};},},function(){QUnit.test('search more pager is reset when doing a new search',async function(assert){assert.expect(6);this.data.partner.records.push(...new Array(170).fill().map((_,i)=>({id:i+10,name:"Partner "+i})));this.data.partner.fields.datetime.searchable=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="trululu"/>'+'</group>'+'</sheet>'+'</form>',archs:{'partner,false,list':'<tree><field name="display_name"/></tree>','partner,false,search':'<search><field name="datetime"/><field name="display_name"/></search>',},res_id:1,});await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown('trululu');await testUtils.fields.many2one.clickItem('trululu','Search');await testUtils.dom.click($('.modal .o_pager_next'));assert.strictEqual($('.o_pager_limit').text(),"1173","there should be 173 records");assert.strictEqual($('.o_pager_value').text(),"181-160","should display the second page");assert.strictEqual($('tr.o_data_row').length,80,"should display 80 record");await cpHelpers.editSearch('.modal',"first");await cpHelpers.validateSearch('.modal');assert.strictEqual($('.o_pager_limit').text(),"11","there should be 1 record");assert.strictEqual($('.o_pager_value').text(),"11-1","should display the first page");assert.strictEqual($('tr.o_data_row').length,1,"should display 1 record");form.destroy();});QUnit.test('do not call name_get if display_name already known',async function(assert){assert.expect(4);this.data.partner.fields.product_id.default=37;this.data.partner.onchanges={trululu:function(obj){obj.trululu=1;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="trululu"/><field name="product_id"/></form>',mockRPC:function(route,args){assert.step(args.method+' on '+args.model);return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.o_field_widget[name=trululu] input').val(),'first record');assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'xphone');assert.verifySteps(['onchange on partner']);form.destroy();});QUnit.test('x2many default_order multiple fields',async function(assert){assert.expect(7);this.data.partner.records=[{int_field:10,id:1,display_name:"record1"},{int_field:12,id:2,display_name:"record2"},{int_field:11,id:3,display_name:"record3"},{int_field:12,id:4,display_name:"record4"},{int_field:10,id:5,display_name:"record5"},{int_field:10,id:6,display_name:"record6"},{int_field:11,id:7,display_name:"record7"},];this.data.partner.records[0].p=[1,7,4,5,2,6,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p" >'+'<tree default_order="int_field,id">'+'<field name="id"/>'+'<field name="int_field"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});var $recordList=form.$('.o_field_x2many_list .o_data_row');var expectedOrderId=['1','5','6','3','7','2','4'];_.each($recordList,function(record,index){var $record=$(record);assert.strictEqual($record.find('.o_data_cell').eq(0).text(),expectedOrderId[index],'The record should be the right place. Index: '+index);});form.destroy();});QUnit.test('focus when closing many2one modal in many2one modal',async function(assert){assert.expect(12);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="trululu"/>'+'</form>',res_id:2,archs:{'partner,false,form':'<form><field name="trululu"/></form>'},mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_external_button'));var $originalModal=$('.modal');var $focusedModal=$(document.activeElement).closest('.modal');assert.equal($originalModal.length,1,'There should be one modal');assert.equal($originalModal[0],$focusedModal[0],'Modal is focused');assert.ok($('body').hasClass('modal-open'),'Modal is said opened');await testUtils.dom.click($originalModal.find('.o_external_button'));var $modals=$('.modal');$focusedModal=$(document.activeElement).closest('.modal');assert.equal($modals.length,2,'There should be two modals');assert.equal($modals[1],$focusedModal[0],'Last modal is focused');assert.ok($('body').hasClass('modal-open'),'Modal is said opened');await testUtils.dom.click($modals.last().find('button[class="close"]'));var $modal=$('.modal');$focusedModal=$(document.activeElement).closest('.modal');assert.equal($modal.length,1,'There should be one modal');assert.equal($modal[0],$originalModal[0],'First modal is still opened');assert.equal($modal[0],$focusedModal[0],'Modal is focused');assert.ok($('body').hasClass('modal-open'),'Modal is said opened');await testUtils.dom.click($modal.find('button[class="close"]'));$modal=$('.modal-dialog.modal-lg');assert.equal($modal.length,0,'There should be no modal');assert.notOk($('body').hasClass('modal-open'),'Modal is not said opened');form.destroy();});QUnit.test('one2many from a model that has been sorted',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[3,2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,context:{orderedBy:[{name:'foo',asc:false,}]},});assert.strictEqual(form.$('.o_field_one2many[name=turtles] tbody').text().trim(),"kawablip",'The o2m should not have been sorted.');form.destroy();});QUnit.test('widget many2many_checkboxes in a subview',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="Turtles">'+'<field name="turtles" mode="tree">'+'<tree>'+'<field name="id"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',archs:{'turtle,false,form':'<form>'+'<field name="partner_ids" widget="many2many_checkboxes"/>'+'</form>',},res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_cell'));var $firstCheckbox=$('.modal .custom-control-input').first();await testUtils.dom.click($firstCheckbox);assert.ok($firstCheckbox.prop('checked'),"the checkbox should be ticked");var $secondCheckbox=$('.modal .custom-control-input').eq(1);await testUtils.dom.click($secondCheckbox);assert.notOk($secondCheckbox.prop('checked'),"the checkbox should be unticked");form.destroy();});QUnit.test('embedded readonly one2many with handle widget',async function(assert){assert.expect(4);this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="turtles" readonly="1">'+'<tree editable="top">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_row_handle').length,3,"there should be 3 handles (one for each row)");assert.strictEqual(form.$('.o_row_handle:visible').length,0,"the handles should be hidden in readonly mode");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_row_handle').length,3,"the handles should still be there");assert.strictEqual(form.$('.o_row_handle:visible').length,0,"the handles should still be hidden (on readonly fields)");form.destroy();});QUnit.test('delete a record while adding another one in a multipage',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[2,3];this.data.partner.onchanges.turtles=function(obj){obj.turtles=[[5]].concat(obj.turtles);};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="turtles">'+'<tree editable="bottom" limit="1" decoration-muted="turtle_bar == False">'+'<field name="turtle_foo"/>'+'<field name="turtle_bar"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();await testUtils.fields.editInput(form.$('.o_input'),'pi');await testUtils.dom.click(form.$('.o_list_record_remove').first());await testUtils.owlCompatibilityNextTick();assert.strictEqual(form.$('.o_data_row').length,2,"should have 2 records");assert.strictEqual(form.$('.o_data_row .o_data_cell:first-child').text(),'pikawa',"should display the correct records on page 1");form.destroy();});QUnit.test('one2many, onchange, edition and multipage...',async function(assert){assert.expect(7);this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5]].concat(obj.turtles);}};this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="2">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method+' '+args.model);return this._super(route,args);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.verifySteps(['read partner','read turtle','onchange turtle','onchange partner','onchange turtle','onchange partner',]);form.destroy();});QUnit.test('onchange on unloaded record clearing posterious change',async function(assert){assert.expect(5);var numUserOnchange=0;this.data.user.onchanges={partner_ids:function(obj){if(numUserOnchange===0){obj.partner_ids=_.clone(obj.partner_ids);obj.partner_ids.unshift([5]);obj.partner_ids[1][2].turtles.unshift([5]);obj.partner_ids[2]=[1,2,{display_name:'second record',trululu:1,turtles:[[5]],}];}else if(numUserOnchange===1){obj.partner_ids=_.clone(obj.partner_ids);obj.partner_ids.unshift([5]);obj.partner_ids[1][2].turtles.unshift([5]);obj.partner_ids[2][2].turtles.unshift([5]);}
numUserOnchange++;},};var form=await createView({View:FormView,model:'user',data:this.data,arch:'<form><sheet><group>'+'<field name="partner_ids">'+'<form>'+'<field name="trululu"/>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</group></sheet></form>',res_id:17,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_row:eq(0)'));await testUtils.dom.click($('.modal .o_data_cell:eq(0)'));await testUtils.fields.editAndTrigger($('.modal input[name="display_name"]'),'Donatello','change');await testUtils.dom.click($('.modal .btn-primary'));await testUtils.dom.click(form.$('.o_data_row:eq(1)'));await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));await testUtils.fields.editAndTrigger($('.modal input[name="display_name"]'),'Michelangelo','change');await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(numUserOnchange,2,'there should 2 and only 2 onchange from closing the partner modal');await testUtils.dom.click(form.$('.o_data_row:eq(0)'));assert.strictEqual($('.modal .o_data_row').length,1,'only 1 turtle for first partner');assert.strictEqual($('.modal .o_data_row').text(),'Donatello','first partner turtle is Donatello');await testUtils.dom.click($('.modal .o_form_button_cancel'));await testUtils.dom.click(form.$('.o_data_row:eq(1)'));assert.strictEqual($('.modal .o_data_row').length,1,'only 1 turtle for second partner');assert.strictEqual($('.modal .o_data_row').text(),'Michelangelo','second partner turtle is Michelangelo');await testUtils.dom.click($('.modal .o_form_button_cancel'));form.destroy();});QUnit.test('quickly switch between pages in one2many list',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[1,2,3];var readDefs=[Promise.resolve(),testUtils.makeTestPromise(),testUtils.makeTestPromise()];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="1">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read'){var recordID=args.args[0][0];return Promise.resolve(readDefs[recordID-1]).then(_.constant(result));}
return result;},res_id:1,});await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));readDefs[1].resolve();await testUtils.nextTick();assert.strictEqual(form.$('.o_field_widget[name=turtles] .o_data_cell').text(),'donatello');readDefs[2].resolve();await testUtils.nextTick();assert.strictEqual(form.$('.o_field_widget[name=turtles] .o_data_cell').text(),'raphael');form.destroy();});QUnit.test('many2many read, field context is properly sent',async function(assert){assert.expect(4);this.data.partner.fields.timmy.context={hello:'world'};this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many_tags"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='read'&&args.model==='partner_type'){assert.step(args.kwargs.context.hello);}
return this._super.apply(this,arguments);},});assert.verifySteps(['world']);await testUtils.form.clickEdit(form);var $m2mInput=form.$('.o_field_many2manytags input');$m2mInput.click();await testUtils.nextTick();$m2mInput.autocomplete('widget').find('li:first()').click();await testUtils.nextTick();assert.verifySteps(['world']);form.destroy();});QUnit.module('FieldStatus');QUnit.test('static statusbar widget on many2one field',async function(assert){assert.expect(5);this.data.partner.fields.trululu.domain="[('bar', '=', True)]";this.data.partner.records[1].bar=false;var count=0;var nb_fields_fetched;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header><field name="trululu" widget="statusbar"/></header>'+'<field name="timmy" invisible="1"/>'+'</form>',mockRPC:function(route,args){if(args.method==='search_read'){count++;nb_fields_fetched=args.kwargs.fields.length;}
return this._super.apply(this,arguments);},res_id:1,config:{device:{isMobile:false}},});assert.strictEqual(count,1,'once search_read should have been done to fetch the relational values');assert.strictEqual(nb_fields_fetched,1,'search_read should only fetch field id');assert.containsN(form,'.o_statusbar_status button:not(.dropdown-toggle)',2);assert.containsN(form,'.o_statusbar_status button:disabled',2);assert.hasClass(form.$('.o_statusbar_status button[data-value="4"]'),'btn-primary');form.destroy();});QUnit.test('static statusbar widget on many2one field with domain',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header><field name="trululu" domain="[(\'user_id\',\'=\',uid)]" widget="statusbar"/></header>'+'</form>',mockRPC:function(route,args){if(args.method==='search_read'){assert.deepEqual(args.kwargs.domain,['|',['id','=',4],['user_id','=',17]],"search_read should sent the correct domain");}
return this._super.apply(this,arguments);},res_id:1,session:{user_context:{uid:17}},});form.destroy();});QUnit.test('clickable statusbar widget on many2one field',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header><field name="trululu" widget="statusbar" options=\'{"clickable": "1"}\'/></header>'+'</form>',res_id:1,config:{device:{isMobile:false}},});assert.hasClass(form.$('.o_statusbar_status button[data-value="4"]'),'btn-primary');assert.hasClass(form.$('.o_statusbar_status button[data-value="4"]'),'disabled');assert.containsN(form,'.o_statusbar_status button.btn-secondary:not(.dropdown-toggle):not(:disabled)',2);var $clickable=form.$('.o_statusbar_status button.btn-secondary:not(.dropdown-toggle):not(:disabled)');await testUtils.dom.click($clickable.last());assert.hasClass(form.$('.o_statusbar_status button[data-value="1"]'),"btn-primary");assert.hasClass(form.$('.o_statusbar_status button[data-value="1"]'),"disabled");form.destroy();});QUnit.test('statusbar with no status',async function(assert){assert.expect(2);this.data.product.records=[];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                    <header><field name="product_id" widget="statusbar"/></header>
                </form>`,res_id:1,config:{device:{isMobile:false}},});assert.doesNotHaveClass(form.$('.o_statusbar_status'),'o_field_empty');assert.strictEqual(form.$('.o_statusbar_status').children().length,0,'statusbar widget should be empty');form.destroy();});QUnit.test('statusbar with required modifier',async function(assert){assert.expect(2);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                    <header><field name="product_id" widget="statusbar" required="1"/></header>
                </form>`,config:{device:{isMobile:false}},});testUtils.intercept(form,'call_service',function(ev){assert.strictEqual(ev.data.service,'notification',"should display an 'invalid fields' notification");},true);testUtils.form.clickSave(form);assert.containsOnce(form,'.o_form_editable','view should still be in edit');form.destroy();});QUnit.test('statusbar with no value in readonly',async function(assert){assert.expect(2);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <header><field name="product_id" widget="statusbar"/></header>
                </form>`,res_id:1,config:{device:{isMobile:false}},});assert.doesNotHaveClass(form.$('.o_statusbar_status'),'o_field_empty');assert.containsN(form,'.o_statusbar_status button:visible',2);form.destroy();});QUnit.test('statusbar with domain but no value (create mode)',async function(assert){assert.expect(1);this.data.partner.fields.trululu.domain="[('bar', '=', True)]";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header><field name="trululu" widget="statusbar"/></header>'+'</form>',config:{device:{isMobile:false}},});assert.containsN(form,'.o_statusbar_status button:disabled',2);form.destroy();});QUnit.test('clickable statusbar should change m2o fetching domain in edit mode',async function(assert){assert.expect(2);this.data.partner.fields.trululu.domain="[('bar', '=', True)]";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header><field name="trululu" widget="statusbar" options=\'{"clickable": "1"}\'/></header>'+'</form>',res_id:1,config:{device:{isMobile:false}},});await testUtils.form.clickEdit(form);assert.containsN(form,'.o_statusbar_status button:not(.dropdown-toggle)',3);await testUtils.dom.click(form.$('.o_statusbar_status button:not(.dropdown-toggle)').last());assert.containsN(form,'.o_statusbar_status button:not(.dropdown-toggle)',2);form.destroy();});QUnit.test('statusbar fold_field option and statusbar_visible attribute',async function(assert){assert.expect(2);this.data.partner.records[0].bar=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header><field name="trululu" widget="statusbar" options="{\'fold_field\': \'bar\'}"/>'+'<field name="color" widget="statusbar" statusbar_visible="red"/></header>'+'</form>',res_id:1,config:{device:{isMobile:false}},});await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_statusbar_status:first .dropdown-menu button.disabled');assert.containsOnce(form,'.o_statusbar_status:last button.disabled');form.destroy();});QUnit.test('statusbar with dynamic domain',async function(assert){assert.expect(5);this.data.partner.fields.trululu.domain="[('int_field', '>', qux)]";this.data.partner.records[2].int_field=0;var rpcCount=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header><field name="trululu" widget="statusbar"/></header>'+'<field name="qux"/>'+'<field name="foo"/>'+'</form>',mockRPC:function(route,args){if(args.method==='search_read'){rpcCount++;}
return this._super.apply(this,arguments);},res_id:1,config:{device:{isMobile:false}},});await testUtils.form.clickEdit(form);assert.containsN(form,'.o_statusbar_status button.disabled',3);assert.strictEqual(rpcCount,1,"should have done 1 search_read rpc");await testUtils.fields.editInput(form.$('input[name=qux]'),9.5);assert.containsN(form,'.o_statusbar_status button.disabled',2);assert.strictEqual(rpcCount,2,"should have done 1 more search_read rpc");await testUtils.fields.editInput(form.$('input[name=qux]'),"hey");assert.strictEqual(rpcCount,2,"should not have done 1 more search_read rpc");form.destroy();});QUnit.module('FieldSelection');QUnit.test('widget selection in a list view',async function(assert){assert.expect(3);this.data.partner.records.forEach(function(r){r.color='red';});var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree string="Colors" editable="top">'+'<field name="color"/>'+'</tree>',});assert.strictEqual(list.$('td:contains(Red)').length,3,"should have 3 rows with correct value");await testUtils.dom.click(list.$('td:contains(Red):first'));var $td=list.$('tbody tr.o_selected_row td:not(.o_list_record_selector)');assert.strictEqual($td.find('select').length,1,"td should have a child 'select'");assert.strictEqual($td.contents().length,1,"select tag should be only child of td");list.destroy();});QUnit.test('widget selection, edition and on many2one field',async function(assert){assert.expect(21);this.data.partner.onchanges={product_id:function(){}};this.data.partner.records[0].product_id=37;this.data.partner.records[0].trululu=false;var count=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="product_id" widget="selection"/>'+'<field name="trululu" widget="selection"/>'+'<field name="color" widget="selection"/>'+'</form>',res_id:1,mockRPC:function(route,args){count++;assert.step(args.method);return this._super(route,args);},});assert.containsNone(form.$('.o_form_view'),'select');assert.strictEqual(form.$('.o_field_widget[name=product_id]').text(),'xphone',"should have rendered the many2one field correctly");assert.strictEqual(form.$('.o_field_widget[name=product_id]').attr('raw-value'),'37',"should have set the raw-value attr for many2one field correctly");assert.strictEqual(form.$('.o_field_widget[name=trululu]').text(),'',"should have rendered the unset many2one field correctly");assert.strictEqual(form.$('.o_field_widget[name=color]').text(),'Red',"should have rendered the selection field correctly");assert.strictEqual(form.$('.o_field_widget[name=color]').attr('raw-value'),'red',"should have set the raw-value attr for selection field correctly");await testUtils.form.clickEdit(form);assert.containsN(form.$('.o_form_view'),'select',3);assert.containsOnce(form,'select[name="product_id"] option:contains(xphone)',"should have fetched xphone option");assert.containsOnce(form,'select[name="product_id"] option:contains(xpad)',"should have fetched xpad option");assert.strictEqual(form.$('select[name="product_id"]').val(),"37","should have correct product_id value");assert.strictEqual(form.$('select[name="trululu"]').val(),"false","should not have any value in trululu field");await testUtils.fields.editSelect(form.$('select[name="product_id"]'),41);assert.strictEqual(form.$('select[name="product_id"]').val(),"41","should have a value of xphone");assert.strictEqual(form.$('select[name="color"]').val(),"\"red\"","should have correct value in color field");assert.verifySteps(['read','name_search','name_search','onchange']);count=0;await form.reload();assert.strictEqual(count,1,"should not reload product_id relation");assert.verifySteps(['read']);form.destroy();});QUnit.test('unset selection field with 0 as key',async function(assert){assert.expect(2);this.data.partner.fields.selection={type:"selection",selection:[[0,"Value O"],[1,"Value 1"]],};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="selection"/>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_field_widget').text(),'Value O',"the displayed value should be 'Value O'");assert.doesNotHaveClass(form.$('.o_field_widget'),'o_field_empty',"should not have class o_field_empty");form.destroy();});QUnit.test('unset selection field with string keys',async function(assert){assert.expect(2);this.data.partner.fields.selection={type:"selection",selection:[['0',"Value O"],['1',"Value 1"]],};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="selection"/>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_field_widget').text(),'',"there should be no displayed value");assert.hasClass(form.$('.o_field_widget'),'o_field_empty',"should have class o_field_empty");form.destroy();});QUnit.test('unset selection on a many2one field',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="trululu" widget="selection"/>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].trululu,false,"should send 'false' as trululu value");}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{mode:'edit',},});await testUtils.fields.editSelect(form.$('.o_form_view select'),'false');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('field selection with many2ones and special characters',async function(assert){assert.expect(1);this.data.partner.records[2].display_name='<span>hey</span>';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="trululu" widget="selection"/>'+'</form>',res_id:1,viewOptions:{mode:'edit'},});assert.strictEqual(form.$('select option[value="4"]').text(),'<span>hey</span>');form.destroy();});QUnit.test('widget selection on a many2one: domain updated by an onchange',async function(assert){assert.expect(4);this.data.partner.onchanges={int_field:function(){},};var domain=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field"/>'+'<field name="trululu" widget="selection"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){domain=[['id','in',[10]]];return Promise.resolve({domain:{trululu:domain,}});}
if(args.method==='name_search'){assert.deepEqual(args.args[1],domain,"sent domain should be correct");}
return this._super(route,args);},viewOptions:{mode:'edit',},});assert.containsN(form,'.o_field_widget[name=trululu] option',4,"should be 4 options in the selection");await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),2);assert.containsOnce(form,'.o_field_widget[name=trululu] option',"should be 1 option in the selection");form.destroy();});QUnit.test('required selection widget should not have blank option',async function(assert){assert.expect(12);this.data.partner.fields.feedback_value={type:"selection",required:true,selection:[['good','Good'],['bad','Bad']],default:'good',string:'Good'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="feedback_value"/>'+'<field name="color" attrs="{\'required\': [(\'feedback_value\', \'=\', \'bad\')]}"/>'+'</form>',res_id:1});await testUtils.form.clickEdit(form);var $colorField=form.$('.o_field_widget[name=color]');assert.containsN($colorField,'option',3,"Three options in non required field");assert.hasAttrValue($colorField.find('option:first()'),'style',"","Should not have display=none");assert.hasAttrValue($colorField.find('option:eq(1)'),'style',"","Should not have display=none");assert.hasAttrValue($colorField.find('option:eq(2)'),'style',"","Should not have display=none");const $requiredSelect=form.$('.o_field_widget[name=feedback_value]');assert.containsN($requiredSelect,'option',3,"Three options in required field");assert.hasAttrValue($requiredSelect.find('option:first()'),'style',"display: none","Should have display=none");assert.hasAttrValue($requiredSelect.find('option:eq(1)'),'style',"","Should not have display=none");assert.hasAttrValue($requiredSelect.find('option:eq(2)'),'style',"","Should not have display=none");await testUtils.fields.editSelect($requiredSelect,'"bad"');$colorField=form.$('.o_field_widget[name=color]');assert.containsN($colorField,'option',3,"Three options in required field");assert.hasAttrValue($colorField.find('option:first()'),'style',"display: none","Should have display=none");assert.hasAttrValue($colorField.find('option:eq(1)'),'style',"","Should not have display=none");assert.hasAttrValue($colorField.find('option:eq(2)'),'style',"","Should not have display=none");form.destroy();});QUnit.module('FieldMany2ManyTags');QUnit.test('fieldmany2many tags with and without color',async function(assert){assert.expect(5);this.data.partner.fields.partner_ids={string:"Partner",type:"many2many",relation:'partner'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="partner_ids" widget="many2many_tags" options="{\'color_field\': \'color\'}"/>'+'<field name="timmy" widget="many2many_tags"/>'+'</form>',mockRPC:function(route,args){if(args.method==='read'&&args.model==='partner_type'){assert.deepEqual(args.args,[[12],['display_name']],"should not read any color field");}else if(args.method==='read'&&args.model==='partner'){assert.deepEqual(args.args,[[1],['display_name','color']],"should read color field");}
return this._super.apply(this,arguments);}});await testUtils.fields.many2one.clickOpenDropdown('partner_ids');await testUtils.fields.many2one.clickHighlightedItem('partner_ids');await testUtils.fields.many2one.clickOpenDropdown('timmy');var $input=form.$('.o_field_many2manytags[name="timmy"] input');assert.strictEqual($input.autocomplete('widget').find('li').length,3,"autocomplete dropdown should have 3 entries (2 values + 'Search and Edit...')");await testUtils.fields.many2one.clickHighlightedItem('timmy');assert.containsOnce(form,'.o_field_many2manytags[name="timmy"] .badge',"should contain 1 tag");assert.containsOnce(form,'.o_field_many2manytags[name="timmy"] .badge:contains("gold")',"should contain newly added tag 'gold'");form.destroy();});QUnit.test('fieldmany2many tags with color: rendering and edition',async function(assert){assert.expect(28);this.data.partner.records[0].timmy=[12,14];this.data.partner_type.records.push({id:13,display_name:"red",color:8});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many_tags" options="{\'color_field\': \'color\', \'no_create_edit\': True}"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){var commands=args.args[1].timmy;assert.strictEqual(commands.length,1,"should have generated one command");assert.strictEqual(commands[0][0],6,"generated command should be REPLACE WITH");assert.ok(_.isEqual(_.sortBy(commands[0][2],_.identity.bind(_)),[12,13]),"new value should be [12, 13]");}
if(args.method==='read'&&args.model==='partner_type'){assert.deepEqual(args.args[1],['display_name','color'],"should read the color field");}
return this._super.apply(this,arguments);},});assert.containsN(form,'.o_field_many2manytags .badge .dropdown-toggle',2,"should contain 2 tags");assert.ok(form.$('.badge .dropdown-toggle:contains(gold)').length,'should have fetched and rendered gold partner tag');assert.ok(form.$('.badge .dropdown-toggle:contains(silver)').length,'should have fetched and rendered silver partner tag');assert.strictEqual(form.$('.badge:first()').data('color'),2,'should have correctly fetched the color');await testUtils.form.clickEdit(form);assert.containsN(form,'.o_field_many2manytags .badge .dropdown-toggle',2,"should still contain 2 tags in edit mode");assert.ok(form.$('.o_tag_color_2 .o_badge_text:contains(gold)').length,'first tag should still contain "gold" and be color 2 in edit mode');assert.containsN(form,'.o_field_many2manytags .o_delete',2,"tags should contain a delete button");var $input=form.$('.o_field_many2manytags input');await testUtils.fields.many2one.clickOpenDropdown('timmy');assert.strictEqual($input.autocomplete('widget').find('li').length,2,"autocomplete dropdown should have 2 entry");assert.strictEqual($input.autocomplete('widget').find('li a:contains("red")').length,1,"autocomplete dropdown should contain 'red'");await testUtils.fields.many2one.clickHighlightedItem('timmy');assert.containsN(form,'.o_field_many2manytags .badge .dropdown-toggle',3,"should contain 3 tags");assert.ok(form.$('.o_field_many2manytags .badge .dropdown-toggle:contains("red")').length,"should contain newly added tag 'red'");assert.ok(form.$('.o_field_many2manytags .badge[data-color=8] .dropdown-toggle:contains("red")').length,"should have fetched the color of added tag");await testUtils.dom.click(form.$('.o_field_many2manytags .badge[data-id=14] .o_delete'));assert.containsN(form,'.o_field_many2manytags .badge .dropdown-toggle',2,"should contain 2 tags");assert.ok(!form.$('.o_field_many2manytags .badge .dropdown-toggle:contains("silver")').length,"should not contain tag 'silver' anymore");await testUtils.form.clickSave(form);$input=form.$('.o_field_many2manytags .badge[data-id=13] .dropdown-toggle');await testUtils.dom.click($input);var $checkBox=form.$('.o_field_many2manytags .badge[data-id=13] .custom-checkbox input');assert.strictEqual($checkBox.length,1,"should have a checkbox in the colorpicker dropdown menu");assert.notOk($checkBox.is(':checked'),"should have unticked checkbox in colorpicker dropdown menu");await testUtils.fields.editAndTrigger($checkBox,null,['mouseenter','mousedown']);$input=form.$('.o_field_many2manytags .badge[data-id=13] .dropdown-toggle');await testUtils.dom.click($input);$checkBox=form.$('.o_field_many2manytags .badge[data-id=13] .custom-checkbox input');assert.equal($input.parent().data('color'),"0","should become transparent when toggling on checkbox");assert.ok($checkBox.is(':checked'),"should have a ticked checkbox in colorpicker dropdown menu after mousedown");await testUtils.fields.editAndTrigger($checkBox,null,['mouseenter','mousedown']);$input=form.$('.o_field_many2manytags .badge[data-id=13] .dropdown-toggle');await testUtils.dom.click($input);$checkBox=form.$('.o_field_many2manytags .badge[data-id=13] .custom-checkbox input');assert.equal($input.parent().data('color'),"8","should revert to old color when toggling off checkbox");assert.notOk($checkBox.is(':checked'),"should have an unticked checkbox in colorpicker dropdown menu after 2nd click");form.destroy();});QUnit.test('fieldmany2many tags in tree view',async function(assert){assert.expect(3);this.data.partner.records[0].timmy=[12,14];var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree string="Partners">'+'<field name="timmy" widget="many2many_tags" options="{\'color_field\': \'color\'}"/>'+'</tree>',});assert.containsN(list,'.o_field_many2manytags .badge',2,"there should be 2 tags");assert.containsNone(list,'.badge.dropdown-toggle',"the tags should not be dropdowns");testUtils.intercept(list,'switch_view',function(event){assert.strictEqual(event.data.view_type,"form","should switch to form view");});testUtils.dom.click(list.$('.o_field_many2manytags .badge:first'));list.destroy();});QUnit.test('fieldmany2many tags view a domain',async function(assert){assert.expect(7);this.data.partner.fields.timmy.domain=[['id','<',50]];this.data.partner.records[0].timmy=[12];this.data.partner_type.records.push({id:99,display_name:"red",color:8});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many_tags" options="{\'no_create_edit\': True}"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='name_search'){assert.deepEqual(args.kwargs.args,[['id','<',50],['id','not in',[12]]],"domain sent to name_search should be correct");return Promise.resolve([[14,'silver']]);}
return this._super.apply(this,arguments);}});assert.containsOnce(form,'.o_field_many2manytags .badge',"should contain 1 tag");assert.ok(form.$('.badge:contains(gold)').length,'should have fetched and rendered gold partner tag');await testUtils.form.clickEdit(form);var $input=form.$('.o_field_many2manytags input');await testUtils.fields.many2one.clickOpenDropdown('timmy');assert.strictEqual($input.autocomplete('widget').find('li').length,2,"autocomplete dropdown should have 2 entry");assert.strictEqual($input.autocomplete('widget').find('li a:contains("silver")').length,1,"autocomplete dropdown should contain 'silver'");await testUtils.fields.many2one.clickHighlightedItem('timmy');assert.containsN(form,'.o_field_many2manytags .badge',2,"should contain 2 tags");assert.ok(form.$('.o_field_many2manytags .badge:contains("silver")').length,"should contain newly added tag 'silver'");form.destroy();});QUnit.test('fieldmany2many tags in a new record',async function(assert){assert.expect(7);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many_tags"/>'+'</form>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/create'){var commands=args.args[0].timmy;assert.strictEqual(commands.length,1,"should have generated one command");assert.strictEqual(commands[0][0],6,"generated command should be REPLACE WITH");assert.ok(_.isEqual(commands[0][2],[12]),"new value should be [12]");}
return this._super.apply(this,arguments);}});assert.hasClass(form.$('.o_form_view'),'o_form_editable',"form should be in edit mode");await testUtils.fields.many2one.clickOpenDropdown('timmy');assert.strictEqual(form.$('.o_field_many2manytags input').autocomplete('widget').find('li').length,3,"autocomplete dropdown should have 3 entries (2 values + 'Search and Edit...')");await testUtils.fields.many2one.clickHighlightedItem('timmy');assert.containsOnce(form,'.o_field_many2manytags .badge',"should contain 1 tag");assert.ok(form.$('.o_field_many2manytags .badge:contains("gold")').length,"should contain newly added tag 'gold'");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('fieldmany2many tags: update color',async function(assert){assert.expect(5);this.data.partner.records[0].timmy=[12,14];this.data.partner_type.records[0].color=0;var color;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many_tags" options="{\'color_field\': \'color\'}"/>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{color:color},"shoud write the new color");}
return this._super.apply(this,arguments);},res_id:1,});assert.ok(form.$('.badge.dropdown:first()').is('.o_tag_color_0'),'first tag color should be 0');color=1;await testUtils.dom.click(form.$('.badge:first() .dropdown-toggle'));await testUtils.dom.triggerEvents($('.o_colorpicker a[data-color="'+color+'"]'),['mousedown']);await testUtils.nextTick();assert.strictEqual(form.$('.badge:first()').data('color'),color,'should have correctly updated the color (in readonly)');color=6;await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.badge:first() .dropdown-toggle'));await testUtils.dom.triggerEvents($('.o_colorpicker a[data-color="'+color+'"]'),['mousedown']);await testUtils.nextTick();assert.strictEqual(form.$('.badge:first()').data('color'),color,'should have correctly updated the color (in edit)');form.destroy();});QUnit.test('fieldmany2many tags with no_edit_color option',async function(assert){assert.expect(1);this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many_tags" options="{\'color_field\': \'color\', \'no_edit_color\': 1}"/>'+'</form>',res_id:1,});await testUtils.dom.click(form.$('.badge:first() .dropdown-toggle'));assert.containsNone(document.body,'.o_colorpicker');form.destroy();});QUnit.test('fieldmany2many tags in editable list',async function(assert){assert.expect(7);this.data.partner.records[0].timmy=[12];var list=await createView({View:ListView,model:'partner',data:this.data,context:{take:'five'},arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="timmy" widget="many2many_tags"/>'+'</tree>',mockRPC:function(route,args){if(args.method==='read'&&args.model==='partner_type'){assert.deepEqual(args.kwargs.context,{take:'five'},'The context should be passed to the RPC');}
return this._super.apply(this,arguments);}});assert.containsOnce(list,'.o_data_row:first .o_field_many2manytags .badge',"m2m field should contain one tag");await testUtils.dom.click(list.$('.o_data_row:first td:nth(2)'));var $m2o=list.$('.o_data_row:first .o_field_many2manytags .o_field_many2one');assert.strictEqual($m2o.length,1,"a many2one widget should have been instantiated");await testUtils.fields.many2one.clickOpenDropdown('timmy');await testUtils.fields.many2one.clickHighlightedItem('timmy');assert.containsN(list,'.o_data_row:first .o_field_many2manytags .badge',2,"m2m field should contain 2 tags");await testUtils.dom.click(list.$('.o_data_row:nth(1) td:nth(2)'));assert.containsN(list,'.o_data_row:first .o_field_many2manytags .badge',2,"m2m field should contain 2 tags");list.destroy();});QUnit.test('search more in many2one: group and use the pager',async function(assert){assert.expect(2);this.data.partner.records.push({id:5,display_name:"Partner 4",},{id:6,display_name:"Partner 5",},{id:7,display_name:"Partner 6",},{id:8,display_name:"Partner 7",},{id:9,display_name:"Partner 8",},{id:10,display_name:"Partner 9",});this.data.partner.fields.datetime.searchable=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="trululu"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,archs:{'partner,false,list':'<tree limit="7"><field name="display_name"/></tree>','partner,false,search':'<search><group>'+'    <filter name="bar" string="Bar" context="{\'group_by\': \'bar\'}"/>'+'</group></search>',},viewOptions:{mode:'edit',},});await testUtils.fields.many2one.clickOpenDropdown('trululu');await testUtils.fields.many2one.clickItem('trululu','Search');await cpHelpers.toggleGroupByMenu('.modal');await cpHelpers.toggleMenuItem('.modal',"Bar");await testUtils.dom.click($('.modal .o_group_header:first'));assert.strictEqual($('.modal tbody:nth(1) .o_data_row').length,7,"should display 7 records in the first page");await testUtils.dom.click($('.modal .o_group_header:first .o_pager_next'));assert.strictEqual($('.modal tbody:nth(1) .o_data_row').length,1,"should display 1 record in the second page");form.destroy();});QUnit.test('many2many_tags can load more than 40 records',async function(assert){assert.expect(1);this.data.partner.fields.partner_ids={string:"Partner",type:"many2many",relation:'partner'};this.data.partner.records[0].partner_ids=[];for(var i=15;i<115;i++){this.data.partner.records.push({id:i,display_name:'walter'+i});this.data.partner.records[0].partner_ids.push(i);}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="partner_ids" widget="many2many_tags"/>'+'</form>',res_id:1,});assert.containsN(form,'.o_field_widget[name="partner_ids"] .badge',100,'should have rendered 100 tags');form.destroy();});QUnit.test('many2many_tags loads records according to limit defined on widget prototype',async function(assert){assert.expect(1);const M2M_LIMIT=relationalFields.FieldMany2ManyTags.prototype.limit;relationalFields.FieldMany2ManyTags.prototype.limit=30;this.data.partner.fields.partner_ids={string:"Partner",type:"many2many",relation:'partner'};this.data.partner.records[0].partner_ids=[];for(var i=15;i<50;i++){this.data.partner.records.push({id:i,display_name:'walter'+i});this.data.partner.records[0].partner_ids.push(i);}
const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="partner_ids" widget="many2many_tags"/></form>',res_id:1,});assert.strictEqual(form.$('.o_field_widget[name="partner_ids"] .badge').length,30,'should have rendered 30 tags even though 35 records linked');relationalFields.FieldMany2ManyTags.prototype.limit=M2M_LIMIT;form.destroy();});QUnit.test('field many2many_tags keeps focus when being edited',async function(assert){assert.expect(7);this.data.partner.records[0].timmy=[12];this.data.partner.onchanges.foo=function(obj){obj.timmy=[[5]];};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="timmy" widget="many2many_tags"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_many2manytags .badge',"should contain one tag");form.$('input[name=foo]').focus();await testUtils.fields.editInput(form.$('input[name=foo]'),'trigger onchange');assert.containsNone(form,'.o_field_many2manytags .badge',"should contain no tags");assert.strictEqual(form.$('input[name=foo]').get(0),document.activeElement,"foo input should have kept the focus");await testUtils.fields.many2one.clickOpenDropdown('timmy');await testUtils.fields.many2one.clickHighlightedItem('timmy');assert.containsOnce(form,'.o_field_many2manytags .badge',"should contain a tag");assert.strictEqual(form.$('.o_field_many2manytags input').get(0),document.activeElement,"m2m tags input should have kept the focus");await testUtils.dom.click(form.$('.o_field_many2manytags .o_delete'));assert.containsNone(form,'.o_field_many2manytags .badge',"should contain no tags");assert.strictEqual(form.$('.o_field_many2manytags input').get(0),document.activeElement,"m2m tags input should have kept the focus");form.destroy();});QUnit.test('widget many2many_tags in one2many with display_name',async function(assert){assert.expect(4);this.data.turtle.records[0].partner_ids=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="turtles">'+'<tree>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'<form>'+'<sheet>'+'<field name="partner_ids"/>'+'</sheet>'+'</form>'+'</field>'+'</sheet>'+'</form>',archs:{'partner,false,list':'<tree><field name="foo"/></tree>',},res_id:1,});assert.strictEqual(form.$('.o_field_one2many[name="turtles"] .o_list_view .o_field_many2manytags[name="partner_ids"]').text().replace(/\s/g,''),"secondrecordaaa","the tags should be correctly rendered");await testUtils.dom.click(form.$('.o_field_one2many[name="turtles"] .o_list_view td.o_data_cell:first'));assert.strictEqual($('.modal .o_form_view .o_field_many2many[name="partner_ids"] .o_list_view .o_data_cell').text(),"blipMy little Foo Value","the list view should be correctly rendered with foo");await testUtils.dom.click($('.modal button.o_form_button_cancel'));assert.strictEqual(form.$('.o_field_one2many[name="turtles"] .o_list_view .o_field_many2manytags[name="partner_ids"]').text().replace(/\s/g,''),"secondrecordaaa","the tags should still be correctly rendered");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_one2many[name="turtles"] .o_list_view .o_field_many2manytags[name="partner_ids"]').text().replace(/\s/g,''),"secondrecordaaa","the tags should still be correctly rendered");form.destroy();});QUnit.test('widget many2many_tags: tags title attribute',async function(assert){assert.expect(1);this.data.turtle.records[0].partner_ids=[2];var form=await createView({View:FormView,model:'turtle',data:this.data,arch:'<form string="Turtles">'+'<sheet>'+'<field name="display_name"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</sheet>'+'</form>',res_id:1,});assert.deepEqual(form.$('.o_field_many2manytags.o_field_widget .badge .o_badge_text').attr('title'),'second record','the title should be filled in');form.destroy();});QUnit.test('widget many2many_tags: toggle colorpicker multiple times',async function(assert){assert.expect(11);this.data.partner.records[0].timmy=[12];this.data.partner_type.records[0].color=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many_tags" options="{\'color_field\': \'color\'}"/>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual($('.o_field_many2manytags .badge').length,1,"should have one tag");assert.strictEqual($('.o_field_many2manytags .badge').data('color'),0,"tag should have color 0");assert.strictEqual($('.o_colorpicker:visible').length,0,"colorpicker should be closed");await testUtils.dom.click(form.$('.o_field_many2manytags .badge .dropdown-toggle'));assert.strictEqual($('.o_colorpicker:visible').length,1,"colorpicker should be open");await testUtils.dom.click(form.$('.o_field_many2manytags .badge .dropdown-toggle'));assert.strictEqual($('.o_field_many2manytags .badge').data('color'),0,"tag should still have color 0");assert.strictEqual($('.o_colorpicker:visible').length,0,"colorpicker should be closed");await testUtils.dom.click(form.$('.o_field_many2manytags .badge .dropdown-toggle'));assert.strictEqual($('.o_colorpicker:visible').length,1,"colorpicker should be open");await testUtils.dom.click(form.$('.o_colorpicker'));assert.strictEqual($('.o_field_many2manytags .badge').data('color'),0,"tag should still have color 0");assert.strictEqual($('.o_colorpicker:visible').length,0,"colorpicker should be closed");await testUtils.dom.click(form.$('.o_field_many2manytags .badge .dropdown-toggle'));await testUtils.dom.triggerEvents(form.$('.o_colorpicker .o_tag_color_2'),['mousedown']);assert.strictEqual($('.o_field_many2manytags .badge').data('color'),2,"tag should have color 2");assert.strictEqual($('.o_colorpicker:visible').length,0,"colorpicker should be closed");form.destroy();});QUnit.test('widget many2many_tags_avatar',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'turtle',data:this.data,arch:'<form>'+'<sheet>'+'<field name="partner_ids" widget="many2many_tags_avatar"/>'+'</sheet>'+'</form>',res_id:2,});assert.containsN(form,'.o_field_many2manytags.avatar.o_field_widget .badge',2,"should have 2 records");assert.strictEqual(form.$('.o_field_many2manytags.avatar.o_field_widget .badge:first img').data('src'),'/web/image/partner/2/image_128',"should have correct avatar image");form.destroy();});QUnit.test('fieldmany2many tags: quick create a new record',async function(assert){assert.expect(3);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form><field name="timmy" widget="many2many_tags"/></form>`,});assert.containsNone(form,'.o_field_many2manytags .badge');await testUtils.fields.many2one.searchAndClickItem('timmy',{search:'new value'});assert.containsOnce(form,'.o_field_many2manytags .badge');await testUtils.form.clickSave(form);assert.strictEqual(form.el.querySelector('.o_field_many2manytags').innerText.trim(),"new value");form.destroy();});QUnit.module('FieldRadio');QUnit.test('fieldradio widget on a many2one in a new record',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="product_id" widget="radio"/>'+'</form>',});assert.ok(form.$('div.o_radio_item').length,"should have rendered outer div");assert.containsN(form,'input.o_radio_input',2,"should have 2 possible choices");assert.ok(form.$('label.o_form_label:contains(xphone)').length,"one of them should be xphone");assert.containsNone(form,'input:checked',"none of the input should be checked");await testUtils.dom.click(form.$("input.o_radio_input:first"));assert.containsOnce(form,'input:checked',"one of the input should be checked");await testUtils.form.clickSave(form);var newRecord=_.last(this.data.partner.records);assert.strictEqual(newRecord.product_id,37,"should have saved record with correct value");form.destroy();});QUnit.test('fieldradio change value by onchange',async function(assert){assert.expect(4);this.data.partner.onchanges={bar:function(obj){obj.product_id=obj.bar?41:37;obj.color=obj.bar?'red':'black';}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar"/>'+'<field name="product_id" widget="radio"/>'+'<field name="color" widget="radio"/>'+'</form>',});await testUtils.dom.click(form.$("input[type='checkbox']"));assert.containsOnce(form,'input.o_radio_input[data-value="37"]:checked',"one of the input should be checked");assert.containsOnce(form,'input.o_radio_input[data-value="black"]:checked',"the other of the input should be checked");await testUtils.dom.click(form.$("input[type='checkbox']"));assert.containsOnce(form,'input.o_radio_input[data-value="41"]:checked',"the other of the input should be checked");assert.containsOnce(form,'input.o_radio_input[data-value="red"]:checked',"one of the input should be checked");form.destroy();});QUnit.test('fieldradio widget on a selection in a new record',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="color" widget="radio"/>'+'</form>',});assert.ok(form.$('div.o_radio_item').length,"should have rendered outer div");assert.containsN(form,'input.o_radio_input',2,"should have 2 possible choices");assert.ok(form.$('label.o_form_label:contains(Red)').length,"one of them should be Red");await testUtils.dom.click(form.$("input.o_radio_input").eq(1));await testUtils.form.clickSave(form);var newRecord=_.last(this.data.partner.records);assert.strictEqual(newRecord.color,'black',"should have saved record with correct value");form.destroy();});QUnit.test('fieldradio widget has o_horizontal or o_vertical class',async function(assert){assert.expect(2);this.data.partner.fields.color2=this.data.partner.fields.color;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="color" widget="radio"/>'+'<field name="color2" widget="radio" options="{\'horizontal\': True}"/>'+'</group>'+'</form>',});var btn1=form.$('div.o_field_radio.o_vertical');var btn2=form.$('div.o_field_radio.o_horizontal');assert.strictEqual(btn1.length,1,"should have o_vertical class");assert.strictEqual(btn2.length,1,"should have o_horizontal class");form.destroy();});QUnit.test('fieldradio widget with numerical keys encoded as strings',async function(assert){assert.expect(5);this.data.partner.fields.selection={type:'selection',selection:[['0',"Red"],['1',"Black"]],};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="selection" widget="radio"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].selection,'1',"should write correct value");}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.o_field_widget').text(),'',"field should be unset");await testUtils.form.clickEdit(form);assert.containsNone(form,'.o_radio_input:checked',"no value should be checked");await testUtils.dom.click(form.$("input.o_radio_input:nth(1)"));await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget').text(),'Black',"value should be 'Black'");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_radio_input[data-index=1]:checked',"'Black' should be checked");form.destroy();});QUnit.test('widget radio on a many2one: domain updated by an onchange',async function(assert){assert.expect(4);this.data.partner.onchanges={int_field:function(){},};var domain=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field"/>'+'<field name="trululu" widget="radio"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){domain=[['id','in',[10]]];return Promise.resolve({value:{trululu:false,},domain:{trululu:domain,},});}
if(args.method==='search_read'){assert.deepEqual(args.kwargs.domain,domain,"sent domain should be correct");}
return this._super(route,args);},viewOptions:{mode:'edit',},});assert.containsN(form,'.o_field_widget[name=trululu] .o_radio_item',3,"should be 3 radio buttons");await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),2);assert.containsNone(form,'.o_field_widget[name=trululu] .o_radio_item',"should be no more radio button");form.destroy();});QUnit.module('FieldSelectionBadge');QUnit.test('FieldSelectionBadge widget on a many2one in a new record',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="product_id" widget="selection_badge"/>'+'</form>',});assert.ok(form.$('span.o_selection_badge').length,"should have rendered outer div");assert.containsN(form,'span.o_selection_badge',2,"should have 2 possible choices");assert.ok(form.$('span.o_selection_badge:contains(xphone)').length,"one of them should be xphone");assert.containsNone(form,'span.active',"none of the input should be checked");await testUtils.dom.click($("span.o_selection_badge:first"));assert.containsOnce(form,'span.active',"one of the input should be checked");await testUtils.form.clickSave(form);var newRecord=_.last(this.data.partner.records);assert.strictEqual(newRecord.product_id,37,"should have saved record with correct value");form.destroy();});QUnit.test('FieldSelectionBadge widget on a selection in a new record',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="color" widget="selection_badge"/>'+'</form>',});assert.ok(form.$('span.o_selection_badge').length,"should have rendered outer div");assert.containsN(form,'span.o_selection_badge',2,"should have 2 possible choices");assert.ok(form.$('span.o_selection_badge:contains(Red)').length,"one of them should be Red");await testUtils.dom.click(form.$("span.o_selection_badge").eq(1));await testUtils.form.clickSave(form);var newRecord=_.last(this.data.partner.records);assert.strictEqual(newRecord.color,'black',"should have saved record with correct value");form.destroy();});QUnit.test('FieldSelectionBadge widget on a selection in a readonly mode',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="color" widget="selection_badge" readonly="1"/>'+'</form>',});assert.containsOnce(form,'span.o_readonly_modifier',"should have 1 possible value in readonly mode");form.destroy();});QUnit.module('FieldSelectionFont');QUnit.test('FieldSelectionFont displays the correct fonts on options',async function(assert){assert.expect(4);this.data.partner.fields.fonts={type:"selection",selection:[['Lato',"Lato"],['Oswald',"Oswald"]],default:'Lato',string:"Fonts",};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="fonts" widget="font"/>'+'</form>',});var options=form.$('.o_field_widget[name="fonts"] > option');assert.strictEqual(form.$('.o_field_widget[name="fonts"]').css('fontFamily'),'Lato',"Widget font should be default (Lato)");assert.strictEqual($(options[0]).css('fontFamily'),'Lato',"Option 0 should have the correct font (Lato)");assert.strictEqual($(options[1]).css('fontFamily'),'Oswald',"Option 1 should have the correct font (Oswald)");await testUtils.fields.editSelect(form.$('.o_field_widget[name="fonts"]'),'"Oswald"');assert.strictEqual(form.$('.o_field_widget[name="fonts"]').css('fontFamily'),'Oswald',"Widget font should be updated (Oswald)");form.destroy();});QUnit.module('FieldMany2ManyCheckBoxes');QUnit.test('widget many2many_checkboxes',async function(assert){assert.expect(10);this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="timmy" widget="many2many_checkboxes"/></group>'+'</form>',res_id:1,});assert.containsN(form,'div.o_field_widget div.custom-checkbox',2,"should have fetched and displayed the 2 values of the many2many");assert.ok(form.$('div.o_field_widget div.custom-checkbox input').eq(0).prop('checked'),"first checkbox should be checked");assert.notOk(form.$('div.o_field_widget div.custom-checkbox input').eq(1).prop('checked'),"second checkbox should not be checked");assert.ok(form.$('div.o_field_widget div.custom-checkbox input').prop('disabled'),"the checkboxes should be disabled");await testUtils.form.clickEdit(form);assert.notOk(form.$('div.o_field_widget div.custom-checkbox input').prop('disabled'),"the checkboxes should not be disabled");await testUtils.dom.click(form.$('div.o_field_widget div.custom-checkbox input').eq(1));await testUtils.form.clickSave(form);assert.deepEqual(this.data.partner.records[0].timmy,[12,14],"should have added the second element to the many2many");assert.containsN(form,'input:checked',2,"both checkboxes should be checked");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('div.o_field_widget div.custom-checkbox > label').eq(0));await testUtils.form.clickSave(form);assert.deepEqual(this.data.partner.records[0].timmy,[14],"should have removed the first element to the many2many");assert.notOk(form.$('div.o_field_widget div.custom-checkbox input').eq(0).prop('checked'),"first checkbox should be checked");assert.ok(form.$('div.o_field_widget div.custom-checkbox input').eq(1).prop('checked'),"second checkbox should not be checked");form.destroy();});QUnit.test('widget many2many_checkboxes: start non empty, then remove twice',async function(assert){assert.expect(2);this.data.partner.records[0].timmy=[12,14];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="timmy" widget="many2many_checkboxes"/></group>'+'</form>',res_id:1,viewOptions:{mode:'edit'},});await testUtils.dom.click(form.$('div.o_field_widget div.custom-checkbox input').eq(0));await testUtils.dom.click(form.$('div.o_field_widget div.custom-checkbox input').eq(1));await testUtils.form.clickSave(form);assert.notOk(form.$('div.o_field_widget div.custom-checkbox input').eq(0).prop('checked'),"first checkbox should not be checked");assert.notOk(form.$('div.o_field_widget div.custom-checkbox input').eq(1).prop('checked'),"second checkbox should not be checked");form.destroy();});QUnit.test('widget many2many_checkboxes: values are updated when domain changes',async function(assert){assert.expect(5);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form>
                    <field name="int_field"/>
                    <field name="timmy" widget="many2many_checkboxes" domain="[['id', '>', int_field]]"/>
                </form>`,res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_field_widget[name=int_field]').val(),'10');assert.containsN(form,'.o_field_widget[name=timmy] .custom-checkbox',2);assert.strictEqual(form.$('.o_field_widget[name=timmy] .o_form_label').text(),'goldsilver');await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),13);assert.containsOnce(form,'.o_field_widget[name=timmy] .custom-checkbox');assert.strictEqual(form.$('.o_field_widget[name=timmy] .o_form_label').text(),'silver');form.destroy();});QUnit.module('FieldMany2ManyBinaryMultiFiles');QUnit.test('widget many2many_binary',async function(assert){assert.expect(16);this.data['ir.attachment']={fields:{name:{string:"Name",type:"char"},mimetype:{string:"Mimetype",type:"char"},},records:[{id:17,name:'Marley&Me.jpg',mimetype:'jpg',}],};this.data.turtle.fields.picture_ids={string:"Pictures",type:"many2many",relation:'ir.attachment',};this.data.turtle.records[0].picture_ids=[17];var form=await createView({View:FormView,model:'turtle',data:this.data,arch:'<form string="Turtles">'+'<group><field name="picture_ids" widget="many2many_binary" options="{\'accepted_file_extensions\': \'image/*\'}"/></group>'+'</form>',archs:{'ir.attachment,false,list':'<tree string="Pictures"><field name="name"/></tree>',},res_id:1,mockRPC:function(route,args){assert.step(route);if(route==='/web/dataset/call_kw/ir.attachment/read'){assert.deepEqual(args.args[1],['name','mimetype']);}
return this._super.apply(this,arguments);},});assert.containsOnce(form,'div.o_field_widget.oe_fileupload',"there should be the attachment widget");assert.strictEqual(form.$('div.o_field_widget.oe_fileupload .o_attachments').children().length,1,"there should be no attachment");assert.containsNone(form,'div.o_field_widget.oe_fileupload .o_attach',"there should not be an Add button (readonly)");assert.containsNone(form,'div.o_field_widget.oe_fileupload .o_attachment .o_attachment_delete',"there should not be a Delete button (readonly)");await testUtils.form.clickEdit(form);assert.containsOnce(form,'div.o_field_widget.oe_fileupload .o_attach',"there should be an Add button");assert.strictEqual(form.$('div.o_field_widget.oe_fileupload .o_attach').text().trim(),"Pictures","the button should be correctly named");assert.containsOnce(form,'div.o_field_widget.oe_fileupload .o_hidden_input_file form',"there should be a hidden form to upload attachments");assert.strictEqual(form.$('input.o_input_file').attr('accept'),'image/*',"there should be an attribute \"accept\" on the input")
await testUtils.dom.click(form.$('div.o_field_widget.oe_fileupload .o_attachment .o_attachment_delete'));assert.verifySteps(['/web/dataset/call_kw/turtle/read','/web/dataset/call_kw/ir.attachment/read',]);await testUtils.form.clickSave(form);assert.strictEqual(form.$('div.o_field_widget.oe_fileupload .o_attachments').children().length,0,"there should be no attachment");assert.verifySteps(['/web/dataset/call_kw/turtle/write','/web/dataset/call_kw/turtle/read',]);form.destroy();});QUnit.test('name_create in form dialog',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="p">'+'<tree>'+'<field name="bar"/>'+'</tree>'+'<form>'+'<field name="product_id"/>'+'</form>'+'</field>'+'</group>'+'</form>',mockRPC:function(route,args){if(args.method==='name_create'){assert.step('name_create');}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();await testUtils.fields.many2one.searchAndClickItem('product_id',{selector:'.modal',search:'new record'});assert.verifySteps(['name_create']);form.destroy();});QUnit.module('FieldReference');QUnit.test('Reference field can quick create models',async function(assert){assert.expect(8);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form><field name="reference"/></form>`,mockRPC(route,args){assert.step(args.method||route);return this._super(...arguments);},});await testUtils.fields.editSelect(form.$('select'),'partner');await testUtils.fields.many2one.searchAndClickItem('reference',{search:'new partner'});await testUtils.form.clickSave(form);assert.verifySteps(['onchange','name_search','name_search','name_create','create','read','name_get'],"The name_create method should have been called");form.destroy();});QUnit.test('Reference field in modal readonly mode',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];this.data.partner.records[1].trululu=1;this.data.partner.records[1].reference='product,41';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="reference"/>'+'<field name="p"/>'+'</form>',archs:{'partner,false,form':'<form><field name="reference"/></form>','partner,false,list':'<tree><field name="display_name"/></tree>',},res_id:1,});assert.equal(form.$('.o_form_uri.o_field_widget[name=reference]').text(),'xphone','the field reference of the form should have the right value');var $cell_o2m=form.$('.o_data_cell');assert.equal($cell_o2m.text(),'second record','the list should have one record');await testUtils.dom.click($cell_o2m);var $modal=$('.modal-lg');assert.equal($modal.length,1,'there should be one modal opened');assert.equal($modal.find('.o_form_uri.o_field_widget[name=reference]').text(),'xpad','The field reference in the modal should have the right value');await testUtils.dom.click($modal.find('.o_form_button_cancel'));form.destroy();});QUnit.test('Reference field in modal write mode',async function(assert){assert.expect(5);this.data.partner.records[0].p=[2];this.data.partner.records[1].trululu=1;this.data.partner.records[1].reference='product,41';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="reference"/>'+'<field name="p"/>'+'</form>',archs:{'partner,false,form':'<form><field name="reference"/></form>','partner,false,list':'<tree><field name="display_name"/></tree>',},res_id:1,});await testUtils.form.clickEdit(form);var $fieldRef=form.$('.o_field_widget.o_field_many2one[name=reference]');assert.equal($fieldRef.find('option:selected').text(),'Product','The reference field\'s model should be Product');assert.equal($fieldRef.find('.o_input.ui-autocomplete-input').val(),'xphone','The reference field\'s record should be xphone');await testUtils.dom.click(form.$('.o_data_cell'));var $modal=$('.modal-lg');assert.equal($modal.length,1,'there should be one modal opened');var $fieldRefModal=$modal.find('.o_field_widget.o_field_many2one[name=reference]');assert.equal($fieldRefModal.find('option:selected').text(),'Product','The reference field\'s model should be Product');assert.equal($fieldRefModal.find('.o_input.ui-autocomplete-input').val(),'xpad','The reference field\'s record should be xpad');form.destroy();});QUnit.test('reference in form view',async function(assert){assert.expect(15);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="reference" string="custom label"/>'+'</group>'+'</sheet>'+'</form>',archs:{'product,false,form':'<form string="Product"><field name="display_name"/></form>',},res_id:1,mockRPC:function(route,args){if(args.method==='get_formview_action'){assert.deepEqual(args.args[0],[37],"should call get_formview_action with correct id");return Promise.resolve({res_id:17,type:'ir.actions.act_window',target:'current',res_model:'res.partner'});}
if(args.method==='get_formview_id'){assert.deepEqual(args.args[0],[37],"should call get_formview_id with correct id");return Promise.resolve(false);}
if(args.method==='name_search'){assert.strictEqual(args.model,'partner_type',"the name_search should be done on the newly set model");}
if(args.method==='write'){assert.strictEqual(args.model,'partner',"should write on the current model");assert.deepEqual(args.args,[[1],{reference:'partner_type,12'}],"should write the correct value");}
return this._super(route,args);},});testUtils.mock.intercept(form,'do_action',function(event){assert.strictEqual(event.data.action.res_id,17,"should do a do_action with correct parameters");});assert.strictEqual(form.$('a.o_form_uri:contains(xphone)').length,1,"should contain a link");await testUtils.dom.click(form.$('a.o_form_uri'));await testUtils.form.clickEdit(form);assert.containsN(form,'.o_field_widget',2,"should contain two field widgets (selection and many2one)");assert.containsOnce(form,'.o_field_many2one',"should contain one many2one");assert.strictEqual(form.$('.o_field_widget select').val(),"product","widget should contain one select with the model");assert.strictEqual(form.$('.o_field_widget input').val(),"xphone","widget should contain one input with the record");var options=_.map(form.$('.o_field_widget select > option'),function(el){return $(el).val();});assert.deepEqual(options,['','product','partner_type','partner'],"the options should be correctly set");await testUtils.dom.click(form.$('.o_external_button'));assert.strictEqual($('.modal .modal-title').text().trim(),'Open: custom label',"dialog title should display the custom string label");await testUtils.dom.click($('.modal .o_form_button_cancel'));await testUtils.fields.editSelect(form.$('.o_field_widget select'),'partner_type');assert.strictEqual(form.$('.o_field_widget input').val(),"","many2one value should be reset after model change");await testUtils.fields.many2one.clickOpenDropdown('reference');await testUtils.fields.many2one.clickHighlightedItem('reference');await testUtils.form.clickSave(form);assert.strictEqual(form.$('a.o_form_uri:contains(gold)').length,1,"should contain a link with the new value");form.destroy();});QUnit.test('interact with reference field changed by onchange',async function(assert){assert.expect(2);this.data.partner.onchanges={bar:function(obj){if(!obj.bar){obj.reference='partner,1';}},};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form>
                    <field name="bar"/>
                    <field name="reference"/>
                </form>`,mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0],{bar:false,reference:'partner,4',});}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_boolean input'));assert.strictEqual(form.$('.o_field_widget[name=reference] select').val(),'partner');await testUtils.fields.many2one.searchAndClickItem('reference',{search:'aaa'});await testUtils.form.clickSave(form);form.destroy();});QUnit.test('default_get and onchange with a reference field',async function(assert){assert.expect(8);this.data.partner.fields.reference.default='product,37';this.data.partner.onchanges={int_field:function(obj){if(obj.int_field){obj.reference='partner_type,'+obj.int_field;}},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="int_field"/>'+'<field name="reference"/>'+'</group>'+'</sheet>'+'</form>',viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='name_get'){assert.step(args.model);}
return this._super(route,args);},});assert.verifySteps(['product'],"the first name_get should have been done");assert.strictEqual(form.$('.o_field_widget[name="reference"] select').val(),"product","reference field model should be correctly set");assert.strictEqual(form.$('.o_field_widget[name="reference"] input').val(),"xphone","reference field value should be correctly set");await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),12);assert.verifySteps(['partner_type'],"the second name_get should have been done");assert.strictEqual(form.$('.o_field_widget[name="reference"] select').val(),"partner_type","reference field model should be correctly set");assert.strictEqual(form.$('.o_field_widget[name="reference"] input').val(),"gold","reference field value should be correctly set");form.destroy();});QUnit.test('default_get a reference field in a x2m',async function(assert){assert.expect(1);this.data.partner.fields.turtles.default=[[0,false,{turtle_ref:'product,37'}]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="turtles">'+'<tree>'+'<field name="turtle_ref"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',viewOptions:{mode:'edit',},archs:{'turtle,false,form':'<form><field name="display_name"/><field name="turtle_ref"/></form>',},});assert.strictEqual(form.$('.o_field_one2many[name="turtles"] .o_data_row:first').text(),"xphone","the default value should be correctly handled");form.destroy();});QUnit.test('widget reference on char field, reset by onchange',async function(assert){assert.expect(4);this.data.partner.records[0].foo='product,37';this.data.partner.onchanges={int_field:function(obj){obj.foo='product,'+obj.int_field;},};var nbNameGet=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="int_field"/>'+'<field name="foo" widget="reference" readonly="1"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.model==='product'&&args.method==='name_get'){nbNameGet++;}
return this._super(route,args);},});assert.strictEqual(nbNameGet,1,"the first name_get should have been done");assert.strictEqual(form.$('a[name="foo"]').text(),"xphone","foo field should be correctly set");await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),41);assert.strictEqual(nbNameGet,2,"the second name_get should have been done");assert.strictEqual(form.$('a[name="foo"]').text(),"xpad","foo field should have been updated");form.destroy();});QUnit.test('reference and list navigation',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="reference"/></tree>',});await testUtils.dom.click(list.$('.o_data_row .o_data_cell').first());assert.strictEqual(list.$('.o_data_row:eq(0) .o_field_widget[name="reference"] input')[0],document.activeElement,'input of first data row should be selected');await testUtils.dom.triggerEvents(list.$('.o_data_row:eq(0) input:eq(1)'),[$.Event('keydown',{which:$.ui.keyCode.TAB,keyCode:$.ui.keyCode.TAB,})]);assert.strictEqual(list.$('.o_data_row:eq(1) .o_field_widget[name="reference"] select')[0],document.activeElement,'select of second data row should be selected');list.destroy();});QUnit.test('one2many with extra field from server not in form',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p" >'+'<tree>'+'<field name="datetime"/>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{'partner,false,form':'<form>'+'<field name="display_name"/>'+'</form>'},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){args.args[1].p[0][2].datetime='2018-04-05 12:00:00';}
return this._super.apply(this,arguments);}});await testUtils.form.clickEdit(form);var x2mList=form.$('.o_field_x2many_list[name=p]');await testUtils.dom.click(x2mList.find('.o_field_x2many_list_row_add a'));var modal=$('.modal-lg');var nameInput=modal.find('input.o_input[name=display_name]');await testUtils.fields.editInput(nameInput,'michelangelo');await testUtils.dom.click(modal.find('.btn-primary').first());assert.equal(x2mList.find('.o_data_row').length,1,'There should be 1 records in the x2m list');var newlyAdded=x2mList.find('.o_data_row').eq(0);assert.equal(newlyAdded.find('.o_data_cell').first().text(),'','The create_date field should be empty');assert.equal(newlyAdded.find('.o_data_cell').eq(1).text(),'michelangelo','The display name field should have the right value');await testUtils.form.clickSave(form);x2mList=form.$('.o_field_x2many_list[name=p]');assert.equal(x2mList.find('.o_data_row').length,1,'There should be 1 records in the x2m list');newlyAdded=x2mList.find('.o_data_row').eq(0);assert.equal(newlyAdded.find('.o_data_cell').first().text(),'04/05/2018 12:00:00','The create_date field should have the right value');assert.equal(newlyAdded.find('.o_data_cell').eq(1).text(),'michelangelo','The display name field should have the right value');form.destroy();});QUnit.test('one2many invisible depends on parent field',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="bar"/>'+'<field name="p">'+'<tree>'+'<field name="foo" attrs="{\'column_invisible\': [(\'parent.product_id\', \'!=\', False)]}"/>'+'<field name="bar" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.containsN(form,'th',2,"should be 2 columns in the one2many");await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown("product_id");await testUtils.fields.many2one.clickHighlightedItem("product_id");await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column when the product_id is set");await testUtils.fields.editAndTrigger(form.$('.o_field_many2one[name="product_id"] input'),'','keyup');await testUtils.owlCompatibilityNextTick();assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns in the one2many when product_id is not set");await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column after the value change");form.destroy();});QUnit.test('one2many column visiblity depends on onchange of parent field',async function(assert){assert.expect(3);this.data.partner.records[0].p=[2];this.data.partner.records[0].bar=false;this.data.partner.onchanges.p=function(obj){if(obj.p.length>1&&obj.p[1][2].foo==='New line'){obj.bar=true;}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar"/>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="int_field" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.containsOnce(form,'th',"should be only 1 column ('foo') in the one2many");assert.containsOnce(form,'.o_list_view .o_data_row',"should contain one row");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.$('.o_field_one2many input:first').focus();await testUtils.fields.editInput(form.$('.o_field_one2many input:first'),'New line');await testUtils.dom.click(form.$el);assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns('foo' + 'int_field')");form.destroy();});QUnit.test('one2many column_invisible on view not inline',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="bar"/>'+'<field name="p"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,archs:{'partner,false,list':'<tree>'+'<field name="foo" attrs="{\'column_invisible\': [(\'parent.product_id\', \'!=\', False)]}"/>'+'<field name="bar" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>',},});assert.containsN(form,'th',2,"should be 2 columns in the one2many");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_many2one[name="product_id"] input'));await testUtils.fields.many2one.clickHighlightedItem("product_id");await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column when the product_id is set");await testUtils.fields.editAndTrigger(form.$('.o_field_many2one[name="product_id"] input'),'','keyup');await testUtils.owlCompatibilityNextTick();assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns in the one2many when product_id is not set");await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column after the value change");form.destroy();});QUnit.test('one2many field in edit mode with optional fields and trash icon',async function(assert){assert.expect(13);var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p"/>'+'</form>',res_id:1,archs:{'partner,false,list':'<tree editable="top">'+'<field name="foo" optional="show"/>'+'<field name="bar" optional="hide"/>'+'</tree>',},services:{local_storage:RamStorageService,},});assert.containsN(form.$('.o_field_one2many'),'th',1,"should be 1 th in the one2many in readonly mode");assert.containsOnce(form.$('.o_field_one2many table'),'.o_optional_columns_dropdown_toggle',"should have the optional columns dropdown toggle inside the table");await testUtils.form.clickEdit(form);assert.containsN(form.$('.o_field_one2many'),'th',2,"should be 2 th in the one2many edit mode");assert.containsN(form.$('.o_field_one2many'),'.o_data_row:first > td',2,"should be 2 cells in the one2many in edit mode");await testUtils.dom.click(form.$('.o_field_one2many table .o_optional_columns_dropdown_toggle'));assert.containsN(form.$('.o_field_one2many'),'div.o_optional_columns div.dropdown-item:visible',2,"dropdown have 2 advanced field foo with checked and bar with unchecked");await testUtils.dom.click(form.$('div.o_optional_columns div.dropdown-item:eq(1) input'));assert.containsN(form.$('.o_field_one2many'),'th',3,"should be 3 th in the one2many after enabling bar column from advanced dropdown");await testUtils.dom.click(form.$('div.o_optional_columns div.dropdown-item:first input'));assert.containsN(form.$('.o_field_one2many'),'th',2,"should be 2 th in the one2many after disabling foo column from advanced dropdown");assert.containsN(form.$('.o_field_one2many'),'div.o_optional_columns div.dropdown-item:visible',2,"dropdown is still open");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();assert.containsN(form.$('.o_field_one2many'),'div.o_optional_columns div.dropdown-item:visible',0,"dropdown is closed");var $selectedRow=form.$('.o_field_one2many tr.o_selected_row');assert.strictEqual($selectedRow.length,1,"should have selected row i.e. edition mode");await testUtils.dom.click(form.$('.o_field_one2many table .o_optional_columns_dropdown_toggle'));await testUtils.dom.click(form.$('div.o_optional_columns div.dropdown-item:first input'));$selectedRow=form.$('.o_field_one2many tr.o_selected_row');assert.strictEqual($selectedRow.length,0,"current edition mode discarded when selecting advanced field");assert.containsN(form.$('.o_field_one2many'),'th',3,"should be 3 th in the one2many after re-enabling foo column from advanced dropdown");await form.reload();assert.containsN(form.$('.o_field_one2many .o_list_view'),'th',3,"should still have 3 th in the one2many after reloading whole form view");form.destroy();});QUnit.module('TabNavigation');QUnit.test('when Navigating to a many2one with tabs, it receives the focus and adds a new line',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',viewOptions:{mode:'edit',},data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="qux"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$el.find('input[name="qux"]')[0],document.activeElement,"initially, the focus should be on the 'qux' field because it is the first input");await testUtils.fields.triggerKeydown(form.$el.find('input[name="qux"]'),'tab');assert.strictEqual(assert.strictEqual(form.$el.find('input[name="turtle_foo"]')[0],document.activeElement,"after tab, the focus should be on the many2one on the first input of the newly added line"));form.destroy();});QUnit.test('when Navigating to a many to one with tabs, it places the focus on the first visible field',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',viewOptions:{mode:'edit',},data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="qux"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_bar" invisible="1"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$el.find('input[name="qux"]')[0],document.activeElement,"initially, the focus should be on the 'qux' field because it is the first input");form.$el.find('input[name="qux"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,keyCode:$.ui.keyCode.TAB,}));await testUtils.owlCompatibilityNextTick();await testUtils.dom.click(document.activeElement);assert.strictEqual(assert.strictEqual(form.$el.find('input[name="turtle_foo"]')[0],document.activeElement,"after tab, the focus should be on the many2one"));form.destroy();});QUnit.test('when Navigating to a many2one with tabs, not filling any field and hitting tab,'+' we should not add a first line but navigate to the next control',async function(assert){assert.expect(3);this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',viewOptions:{mode:'edit',},data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="qux"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'<field name="turtle_description"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$el.find('input[name="qux"]')[0],document.activeElement,"initially, the focus should be on the 'qux' field because it is the first input");await testUtils.fields.triggerKeydown(form.$el.find('input[name="qux"]'),'tab');await testUtils.fields.triggerKeydown($(document.activeElement),'tab');await testUtils.fields.triggerKeydown($(document.activeElement),'tab');assert.strictEqual(assert.strictEqual(form.$el.find('input[name="foo"]')[0],document.activeElement,"after tab, the focus should be on the many2one"));form.destroy();});QUnit.test('when Navigating to a many to one with tabs, editing in a popup, the popup should receive the focus then give it back',async function(assert){assert.expect(3);this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',viewOptions:{mode:'edit',},data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="qux"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'<field name="turtle_description"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,archs:{'turtle,false,form':'<form><group><field name="turtle_foo"/><field name="turtle_int"/></group></form>',},});assert.strictEqual(form.$el.find('input[name="qux"]')[0],document.activeElement,"initially, the focus should be on the 'qux' field because it is the first input");await testUtils.fields.triggerKeydown(form.$el.find('input[name="qux"]'),'tab');assert.strictEqual($.find('input[name="turtle_foo"]')[0],document.activeElement,"when the one2many received the focus, the popup should open because it automatically adds a new line");await testUtils.fields.triggerKeydown($('input[name="turtle_foo"]'),'escape');assert.strictEqual(form.$el.find('.o_field_x2many_list_row_add a')[0],document.activeElement,"after escape, the focus should be back on the add new line link");form.destroy();});QUnit.test('when creating a new many2one on a x2many then discarding it immediately with ESCAPE, it should not crash',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',viewOptions:{mode:'edit',},data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'<field name="turtle_trululu"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,archs:{'partner,false,form':'<form><group><field name="foo"/><field name="bar"/></group></form>'},});await testUtils.dom.click(form.$el.find('.o_field_x2many_list_row_add>a'));var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;await testUtils.dom.click(form.$el.find('.o_input_dropdown>input'));await testUtils.fields.editInput(form.$('.o_field_many2one input'),'ABC');await testUtils.dom.click($('.ui-autocomplete .ui-menu-item a:contains(Create and)').trigger('mouseenter'));var escapeKey=$.ui.keyCode.ESCAPE;$(document.activeElement).trigger($.Event('keydown',{which:escapeKey,keyCode:escapeKey}));assert.ok('did not crash');relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('navigating through an editable list with custom controls [REQUIRE FOCUS]',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="display_name"/>'+'<field name="p">'+'<tree editable="bottom">'+'<control>'+'<create string="Custom 1" context="{\'default_foo\': \'1\'}"/>'+'<create string="Custom 2" context="{\'default_foo\': \'2\'}"/>'+'</control>'+'<field name="foo"/>'+'</tree>'+'</field>'+'<field name="int_field"/>'+'</form>',viewOptions:{mode:'edit',},});assert.strictEqual(document.activeElement,form.$('.o_field_widget[name="display_name"]')[0],"first input should be focused by default");await testUtils.fields.triggerKeydown(form.$('.o_field_widget[name="display_name"]'),'tab');await testUtils.fields.triggerKeydown(form.$('.o_data_cell input'),'escape');assert.strictEqual(document.activeElement,form.$('.o_field_x2many_list_row_add a:first')[0],"first editable list control should now have the focus");await testUtils.fields.triggerKeydown(form.$('.o_field_x2many_list_row_add a:first'),'right');assert.strictEqual(document.activeElement,form.$('.o_field_x2many_list_row_add a:nth(1)')[0],"second editable list control should now have the focus");await testUtils.fields.triggerKeydown(form.$('.o_field_x2many_list_row_add a:nth(1)'),'left');assert.strictEqual(document.activeElement,form.$('.o_field_x2many_list_row_add a:first')[0],"first editable list control should now have the focus");await testUtils.fields.triggerKeydown(form.$('.o_field_x2many_list_row_add a:first'),'tab');assert.strictEqual(document.activeElement,form.$('.o_field_widget[name="int_field"]')[0],"last input should now be focused");form.destroy();});});});});;

/* /web/static/tests/fields/relational_fields/field_many2many_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.field_many_to_many_tests',function(require){"use strict";var FormView=require('web.FormView');var testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;QUnit.module('fields',{},function(){QUnit.module('relational_fields',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Displayed name",type:"char"},foo:{string:"Foo",type:"char",default:"My little Foo Value"},int_field:{string:"int_field",type:"integer",sortable:true},turtles:{string:"one2many turtle field",type:"one2many",relation:'turtle',relation_field:'turtle_trululu'},timmy:{string:"pokemon",type:"many2many",relation:'partner_type'},color:{type:"selection",selection:[['red',"Red"],['black',"Black"]],default:'red',string:"Color",},user_id:{string:"User",type:'many2one',relation:'user'},reference:{string:"Reference Field",type:'reference',selection:[["product","Product"],["partner_type","Partner Type"],["partner","Partner"]]},},records:[{id:1,display_name:"first record",foo:"yop",int_field:10,turtles:[2],timmy:[],user_id:17,reference:'product,37',},{id:2,display_name:"second record",foo:"blip",int_field:9,timmy:[],user_id:17,},{id:4,display_name:"aaa",}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},partner_type:{fields:{name:{string:"Partner Type",type:"char"},color:{string:"Color index",type:"integer"},},records:[{id:12,display_name:"gold",color:2},{id:14,display_name:"silver",color:5},]},turtle:{fields:{display_name:{string:"Displayed name",type:"char"},turtle_foo:{string:"Foo",type:"char"},turtle_bar:{string:"Bar",type:"boolean",default:true},partner_ids:{string:"Partner",type:"many2many",relation:'partner'},},records:[{id:1,display_name:"leonardo",turtle_foo:"yop",partner_ids:[],},{id:2,display_name:"donatello",turtle_foo:"blip",partner_ids:[2,4],},{id:3,display_name:"raphael",turtle_foo:"kawa",partner_ids:[],}],onchanges:{},},user:{fields:{name:{string:"Name",type:"char"},},records:[{id:17,name:"Aline",},{id:19,name:"Christine",}]},};},},function(){QUnit.module('FieldMany2Many');QUnit.test('many2many kanban: edition',async function(assert){assert.expect(33);this.data.partner.records[0].timmy=[12,14];this.data.partner_type.records.push({id:15,display_name:"red",color:6});this.data.partner_type.records.push({id:18,display_name:"yellow",color:4});this.data.partner_type.records.push({id:21,display_name:"blue",color:1});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<kanban>'+'<field name="display_name"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<a t-if="!read_only_mode" type="delete" class="fa fa-times float-right delete_icon"/>'+'<span><t t-esc="record.display_name.value"/></span>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'<form string="Partners">'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',archs:{'partner_type,false,form':'<form string="Types"><field name="display_name"/></form>','partner_type,false,list':'<tree string="Types"><field name="display_name"/></tree>','partner_type,false,search':'<search string="Types">'+'<field name="name" string="Name"/>'+'</search>',},res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner_type/write'){assert.strictEqual(args.args[1].display_name,"new name","should write 'new_name'");}
if(route==='/web/dataset/call_kw/partner_type/create'){assert.strictEqual(args.args[0].display_name,"A new type","should create 'A new type'");}
if(route==='/web/dataset/call_kw/partner/write'){var commands=args.args[1].timmy;assert.strictEqual(commands.length,1,"should have generated one command");assert.strictEqual(commands[0][0],6,"generated command should be REPLACE WITH");var createdType=_.findWhere(this.data.partner_type.records,{display_name:"A new type"});var ids=_.sortBy([12,15,18].concat(createdType.id),_.identity.bind(_));assert.ok(_.isEqual(_.sortBy(commands[0][2],_.identity.bind(_)),ids),"new value should be "+ids);}
return this._super.apply(this,arguments);},});testUtils.mock.intercept(form,'get_session',function(event){event.data.callback({user_context:{}});});assert.ok(!form.$('.o_kanban_view .delete_icon').length,'delete icon should not be visible in readonly');assert.ok(!form.$('.o_field_many2many .o-kanban-button-new').length,'"Add" button should not be visible in readonly');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,2,'should contain 2 records');assert.strictEqual(form.$('.o_kanban_record:first() span').text(),'gold','display_name of subrecord should be the one in DB');assert.ok(form.$('.o_kanban_view .delete_icon').length,'delete icon should be visible in edit');assert.ok(form.$('.o_field_many2many .o-kanban-button-new').length,'"Add" button should be visible in edit');assert.strictEqual(form.$('.o_field_many2many .o-kanban-button-new').text().trim(),"Add",'Create button should have "Add" label');await testUtils.dom.click(form.$('.oe_kanban_global_click:first()'));await testUtils.fields.editInput($('.modal .o_form_view input'),'new name');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_kanban_record:first() span').text(),'new name','value of subrecord should have been updated');await testUtils.dom.click(form.$('.o_field_many2many .o-kanban-button-new'));assert.ok($('.modal .o_list_view').length,"should have opened a list view in a modal");assert.strictEqual($('.modal .o_list_view tbody .o_list_record_selector').length,3,"list view should contain 3 records");await testUtils.dom.click($('.modal .o_list_view tbody tr:contains(red)'));assert.ok(!$('.modal .o_list_view').length,"should have closed the modal");assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,3,'kanban should now contain 3 records');assert.ok(form.$('.o_kanban_record:contains(red)').length,'record "red" should be in the kanban');await testUtils.dom.click(form.$('.o_field_many2many .o-kanban-button-new'));assert.ok($('.modal .o_select_button').prop('disabled'),"select button should be disabled");assert.strictEqual($('.modal .o_list_view tbody .o_list_record_selector').length,2,"list view should contain 2 records");await testUtils.dom.click($('.modal .o_list_view thead .o_list_record_selector input'));await testUtils.dom.click($('.modal .o_select_button'));assert.ok(!$('.modal .o_select_button').prop('disabled'),"select button should be enabled");assert.ok(!$('.modal .o_list_view').length,"should have closed the modal");assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,5,'kanban should now contain 5 records');await testUtils.dom.click(form.$('.o_field_many2many .o-kanban-button-new'));await testUtils.dom.click($('.modal .modal-footer .btn-primary:nth(1)'));assert.ok($('.modal .o_form_view.o_form_editable').length,"should have opened a form view in edit mode, in a modal");await testUtils.fields.editInput($('.modal .o_form_view input'),'A new type');await testUtils.dom.click($('.modal:nth(1) footer .btn-primary:first()'));assert.ok(!$('.modal').length,"should have closed both modals");assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,6,'kanban should now contain 6 records');assert.ok(form.$('.o_kanban_record:contains(A new type)').length,'the newly created type should be in the kanban');await testUtils.dom.click(form.$('.o_kanban_record:contains(silver)'));assert.strictEqual($('.modal .modal-footer .o_btn_remove').length,1,'There should be a modal having Remove Button');await testUtils.dom.click($('.modal .modal-footer .o_btn_remove'));assert.containsNone($('.o_modal'),"modal should have been closed");assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,5,'should contain 5 records');assert.ok(!form.$('.o_kanban_record:contains(silver)').length,'the removed record should not be in kanban anymore');await testUtils.dom.click(form.$('.o_kanban_record:contains(blue) .delete_icon'));assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,4,'should contain 4 records');assert.ok(!form.$('.o_kanban_record:contains(blue)').length,'the removed record should not be in kanban anymore');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('many2many kanban(editable): properly handle create_text node option',async function(assert){assert.expect(1);this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" options="{\'create_text\': \'Add timmy\'}" mode="kanban">'+'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_details">'+'<field name="display_name"/>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_many2many[name="timmy"] .o-kanban-button-new').text().trim(),"Add timmy","In M2M Kanban, Add button should have 'Add timmy' label");form.destroy();});QUnit.test('many2many kanban: create action disabled',async function(assert){assert.expect(4);this.data.partner.records[0].timmy=[12,14];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<kanban create="0">'+'<field name="display_name"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<a t-if="!read_only_mode" type="delete" class="fa fa-times float-right delete_icon"/>'+'<span><t t-esc="record.display_name.value"/></span>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',archs:{'partner_type,false,list':'<tree><field name="name"/></tree>','partner_type,false,search':'<search>'+'<field name="display_name" string="Name"/>'+'</search>',},res_id:1,session:{user_context:{}},});assert.ok(!form.$('.o-kanban-button-new').length,'"Add" button should not be available in readonly');await testUtils.form.clickEdit(form);assert.ok(form.$('.o-kanban-button-new').length,'"Add" button should be available in edit');assert.ok(form.$('.o_kanban_view .delete_icon').length,'delete icon should be visible in edit');await testUtils.dom.click(form.$('.o-kanban-button-new'));assert.strictEqual($('.modal .modal-footer .btn-primary').length,1,'"Create" button should not be available in the modal');form.destroy();});QUnit.test('many2many kanban: conditional create/delete actions',async function(assert){assert.expect(6);this.data.partner.records[0].timmy=[12,14];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="color"/>
                        <field name="timmy" options="{'create': [('color', '=', 'red')], 'delete': [('color', '=', 'red')]}">
                            <kanban>
                                <field name="display_name"/>
                                <templates>
                                    <t t-name="kanban-box">
                                        <div class="oe_kanban_global_click">
                                            <span><t t-esc="record.display_name.value"/></span>
                                        </div>
                                    </t>
                                </templates>
                            </kanban>
                        </field>
                    </form>`,archs:{'partner_type,false,form':'<form><field name="name"/></form>','partner_type,false,list':'<tree><field name="name"/></tree>','partner_type,false,search':'<search/>',},res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o-kanban-button-new','"Add" button should be available');await testUtils.dom.click(form.$('.o_kanban_record:contains(silver)'));assert.containsOnce(document.body,'.modal .modal-footer .o_btn_remove','remove button should be visible in modal');await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.dom.click(form.$('.o-kanban-button-new'));assert.containsN(document.body,'.modal .modal-footer button',3,'there should be 3 buttons available in the modal');await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.fields.editSelect(form.$('select[name="color"]'),'"black"');assert.containsOnce(form,'.o-kanban-button-new','"Add" button should still be available even after color field changed');await testUtils.dom.click(form.$('.o-kanban-button-new'));assert.containsN(document.body,'.modal .modal-footer button',2,'"Create" button should not be available in the modal after color field changed');await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.dom.click(form.$('.o_kanban_record:contains(silver)'));assert.containsNone(document.body,'.modal .modal-footer .o_btn_remove','remove button should be visible in modal');form.destroy();});QUnit.test('many2many list (non editable): edition',async function(assert){assert.expect(29);this.data.partner.records[0].timmy=[12,14];this.data.partner_type.records.push({id:15,display_name:"bronze",color:6});this.data.partner_type.fields.float_field={string:'Float',type:'float'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<tree>'+'<field name="display_name"/><field name="float_field"/>'+'</tree>'+'<form string="Partners">'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,search':'<search><field name="display_name"/></search>',},res_id:1,mockRPC:function(route,args){if(args.method!=='load_views'){assert.step(_.last(route.split('/')));}
if(args.method==='write'&&args.model==='partner'){assert.deepEqual(args.args[1].timmy,[[6,false,[12,15]],]);}
return this._super.apply(this,arguments);},});assert.containsNone(form.$('.o_list_record_remove'),'delete icon should not be visible in readonly');assert.containsNone(form.$('.o_field_x2many_list_row_add'),'"Add an item" should not be visible in readonly');await testUtils.form.clickEdit(form);assert.containsN(form,'.o_list_view td.o_list_number',2,'should contain 2 records');assert.strictEqual(form.$('.o_list_view tbody td:first()').text(),'gold','display_name of first subrecord should be the one in DB');assert.ok(form.$('.o_list_record_remove').length,'delete icon should be visible in edit');assert.ok(form.$('.o_field_x2many_list_row_add').length,'"Add an item" should be visible in edit');await testUtils.dom.click(form.$('.o_list_view tbody tr:first()'));assert.containsNone($('.modal .modal-footer .o_btn_remove'),'there should not be a "Remove" button in the modal footer');await testUtils.fields.editInput($('.modal .o_form_view input'),'new name');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_list_view tbody td:first()').text(),'new name','value of subrecord should have been updated');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsNone($('.modal .modal-footer .o_btn_remove'),'there should not be a "Remove" button in the modal footer');assert.strictEqual($('.modal .o_list_view').length,1,"a modal should be open");assert.strictEqual($('.modal .o_list_view .o_data_row').length,1,"the list should contain one row");await testUtils.dom.click($('.modal .o_list_view .o_data_row'));assert.strictEqual($('.modal .o_list_view').length,0,"the modal should be closed");assert.containsN(form,'.o_list_view td.o_list_number',3,'should contain 3 subrecords');await testUtils.dom.click(form.$('.o_list_record_remove:nth(1)'));assert.containsN(form,'.o_list_view td.o_list_number',2,'should contain 2 subrecords');assert.strictEqual(form.$('.o_list_view .o_data_row td:first').text(),'new name','the updated row still has the correct values');await testUtils.form.clickSave(form);assert.containsN(form,'.o_list_view td.o_list_number',2,'should contain 2 subrecords');assert.strictEqual(form.$('.o_list_view .o_data_row td:first').text(),'new name','the updated row still has the correct values');assert.verifySteps(['read','read','read','write','read','search_read','read','write','read','read',]);form.destroy();});QUnit.test('many2many list (editable): edition',async function(assert){assert.expect(31);this.data.partner.records[0].timmy=[12,14];this.data.partner_type.records.push({id:15,display_name:"bronze",color:6});this.data.partner_type.fields.float_field={string:'Float',type:'float'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<tree editable="top">'+'<field name="display_name"/><field name="float_field"/>'+'</tree>'+'</field>'+'</form>',archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,search':'<search><field name="display_name"/></search>',},mockRPC:function(route,args){if(args.method!=='load_views'){assert.step(_.last(route.split('/')));}
if(args.method==='write'){assert.deepEqual(args.args[1].timmy,[[6,false,[12,15]],[1,12,{display_name:'new name'}],]);}
return this._super.apply(this,arguments);},res_id:1,});assert.ok(!form.$('.o_list_record_remove').length,'delete icon should not be visible in readonly');assert.ok(!form.$('.o_field_x2many_list_row_add').length,'"Add an item" should not be visible in readonly');await testUtils.form.clickEdit(form);assert.containsN(form,'.o_list_view td.o_list_number',2,'should contain 2 records');assert.strictEqual(form.$('.o_list_view tbody td:first()').text(),'gold','display_name of first subrecord should be the one in DB');assert.ok(form.$('.o_list_record_remove').length,'delete icon should be visible in edit');assert.hasClass(form.$('td.o_list_record_remove button').first(),'fa fa-times',"should have X icons to remove (unlink) records");assert.ok(form.$('.o_field_x2many_list_row_add').length,'"Add an item" should not visible in edit');await testUtils.dom.click(form.$('.o_list_view tbody td:first()'));assert.ok(!$('.modal').length,'in edit, clicking on a subrecord should not open a dialog');assert.hasClass(form.$('.o_list_view tbody tr:first()'),'o_selected_row','first row should be in edition');await testUtils.fields.editInput(form.$('.o_list_view input:first()'),'new name');assert.hasClass(form.$('.o_list_view .o_data_row:first'),'o_selected_row','first row should still be in edition');assert.strictEqual(form.$('.o_list_view input[name=display_name]').get(0),document.activeElement,'edited field should still have the focus');await testUtils.dom.click(form.$el);assert.doesNotHaveClass(form.$('.o_list_view tbody tr:first'),'o_selected_row','first row should not be in edition anymore');assert.strictEqual(form.$('.o_list_view tbody td:first()').text(),'new name','value of subrecord should have been updated');assert.verifySteps(['read','read']);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .o_list_view').length,1,"a modal should be open");assert.strictEqual($('.modal .o_list_view .o_data_row').length,1,"the list should contain one row");await testUtils.dom.click($('.modal .o_list_view .o_data_row'));assert.strictEqual($('.modal .o_list_view').length,0,"the modal should be closed");assert.containsN(form,'.o_list_view td.o_list_number',3,'should contain 3 subrecords');await testUtils.dom.click(form.$('.o_list_record_remove:nth(1)'));assert.containsN(form,'.o_list_view td.o_list_number',2,'should contain 2 subrecord');assert.strictEqual(form.$('.o_list_view tbody .o_data_row td:first').text(),'new name','the updated row still has the correct values');await testUtils.form.clickSave(form);assert.containsN(form,'.o_list_view td.o_list_number',2,'should contain 2 subrecords');assert.strictEqual(form.$('.o_list_view .o_data_row td:first').text(),'new name','the updated row still has the correct values');assert.verifySteps(['search_read','read','write','read','read',]);form.destroy();});QUnit.test('many2many: create & delete attributes',async function(assert){assert.expect(4);this.data.partner.records[0].timmy=[12,14];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<tree create="true" delete="true">'+'<field name="color"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_x2many_list_row_add',"should have the 'Add an item' link");assert.containsN(form,'.o_list_record_remove',2,"should have the 'Add an item' link");form.destroy();form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<tree create="false" delete="false">'+'<field name="color"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_x2many_list_row_add',"should have the 'Add an item' link");assert.containsN(form,'.o_list_record_remove',2,"each record should have the 'Remove Item' link");form.destroy();});QUnit.test('many2many list: create action disabled',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<tree create="0">'+'<field name="name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.containsNone(form,'.o_field_x2many_list_row_add','"Add an item" link should not be available in readonly');await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_x2many_list_row_add','"Add an item" link should be available in edit');form.destroy();});QUnit.test('fieldmany2many list comodel not writable',async function(assert){assert.expect(12);var form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                        <field name="timmy" widget="many2many" can_create="false" can_write="false"/>
                    </form>`,archs:{'partner_type,false,list':`<tree create="false" delete="false" edit="false">
                                                    <field name="display_name"/>
                                                </tree>`,'partner_type,false,search':'<search><field name="display_name"/></search>',},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/create'){assert.deepEqual(args.args[0],{timmy:[[6,false,[12]]]});}
if(route==='/web/dataset/call_kw/partner/write'){assert.deepEqual(args.args[1],{timmy:[[6,false,[]]]});}
return this._super.apply(this,arguments);}});assert.containsOnce(form,'.o_field_many2many .o_field_x2many_list_row_add');await testUtils.dom.click(form.$('.o_field_many2many .o_field_x2many_list_row_add a'));assert.containsOnce(document.body,'.modal');assert.containsN($('.modal-footer'),'button',2);assert.containsOnce($('.modal-footer'),'button.o_select_button');assert.containsOnce($('.modal-footer'),'button.o_form_button_cancel');await testUtils.dom.click($('.modal .o_list_view .o_data_cell:first()'));assert.containsNone(document.body,'.modal');assert.containsOnce(form,'.o_field_many2many .o_data_row');assert.equal($('.o_field_many2many .o_data_row').text(),'gold');assert.containsOnce(form,'.o_field_many2many .o_field_x2many_list_row_add');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_many2many .o_data_row .o_list_record_remove');await testUtils.dom.click(form.$('.o_field_many2many .o_data_row .o_list_record_remove'));await testUtils.form.clickSave(form);form.destroy();});QUnit.test('many2many list: conditional create/delete actions',async function(assert){assert.expect(6);this.data.partner.records[0].timmy=[12,14];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="color"/>
                        <field name="timmy" options="{'create': [('color', '=', 'red')], 'delete': [('color', '=', 'red')]}">
                            <tree>
                                <field name="name"/>
                            </tree>
                        </field>
                    </form>`,archs:{'partner_type,false,list':'<tree><field name="name"/></tree>','partner_type,false,search':'<search/>',},res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_field_x2many_list_row_add',"should have the 'Add an item' link");assert.containsN(form,'.o_list_record_remove',2,"should have two remove icons");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(document.body,'.modal .modal-footer button',3,'there should be 3 buttons available in the modal');await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.fields.editSelect(form.$('select[name="color"]'),'"black"');assert.containsOnce(form,'.o_field_x2many_list_row_add','"Add a line" button should still be available even after color field changed');assert.containsN(form,'.o_list_record_remove',2,"should still have remove icon even after color field changed");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(document.body,'.modal .modal-footer button',2,'"Create" button should not be available in the modal after color field changed');form.destroy();});QUnit.test('many2many list: list of id as default value',async function(assert){assert.expect(1);this.data.partner.fields.turtles.default=[2,3];this.data.partner.fields.turtles.type="many2many";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',});assert.strictEqual(form.$('td.o_data_cell').text(),"blipkawa","should have loaded default data");form.destroy();});QUnit.test('many2many checkboxes with default values',async function(assert){assert.expect(7);this.data.partner.fields.turtles.default=[3];this.data.partner.fields.turtles.type="many2many";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles" widget="many2many_checkboxes">'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0].turtles,[[6,false,[1]]],"correct values should have been sent to create");}
return this._super.apply(this,arguments);}});assert.notOk(form.$('.o_form_view .custom-checkbox input').eq(0).prop('checked'),"first checkbox should not be checked");assert.notOk(form.$('.o_form_view .custom-checkbox input').eq(1).prop('checked'),"second checkbox should not be checked");assert.ok(form.$('.o_form_view .custom-checkbox input').eq(2).prop('checked'),"third checkbox should be checked");await testUtils.dom.click(form.$('.o_form_view .custom-checkbox input:checked'));await testUtils.dom.click(form.$('.o_form_view .custom-checkbox input').first());await testUtils.dom.click(form.$('.o_form_view .custom-checkbox input').first());await testUtils.dom.click(form.$('.o_form_view .custom-checkbox input').first());assert.ok(form.$('.o_form_view .custom-checkbox input').eq(0).prop('checked'),"first checkbox should be checked");assert.notOk(form.$('.o_form_view .custom-checkbox input').eq(1).prop('checked'),"second checkbox should not be checked");assert.notOk(form.$('.o_form_view .custom-checkbox input').eq(2).prop('checked'),"third checkbox should not be checked");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('many2many list with x2many: add a record',async function(assert){assert.expect(18);this.data.partner_type.fields.m2m={string:"M2M",type:"many2many",relation:'turtle',};this.data.partner_type.records[0].m2m=[1,2];this.data.partner_type.records[1].m2m=[2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy"/>'+'</form>',res_id:1,archs:{'partner_type,false,list':'<tree>'+'<field name="display_name"/>'+'<field name="m2m" widget="many2many_tags"/>'+'</tree>','partner_type,false,search':'<search>'+'<field name="display_name" string="Name"/>'+'</search>',},mockRPC:function(route,args){if(args.method!=='load_views'){assert.step(_.last(route.split('/'))+' on '+args.model);}
if(args.model==='turtle'){assert.step(JSON.stringify(args.args[0]));}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal .o_data_row:first'));assert.containsOnce(form,'.o_data_row',"the record should have been added to the relation");assert.strictEqual(form.$('.o_data_row:first .o_badge_text').text(),'leonardodonatello',"inner m2m should have been fetched and correctly displayed");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal .o_data_row:first'));assert.containsN(form,'.o_data_row',2,"the second record should have been added to the relation");assert.strictEqual(form.$('.o_data_row:nth(1) .o_badge_text').text(),'donatelloraphael',"inner m2m should have been fetched and correctly displayed");assert.verifySteps(['read on partner','search_read on partner_type','read on turtle','[1,2,3]','read on partner_type','read on turtle','[1,2]','search_read on partner_type','read on turtle','[2,3]','read on partner_type','read on turtle','[2,3]',]);form.destroy();});QUnit.test('many2many with a domain',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" domain="[[\'display_name\', \'=\', \'gold\']]"/>'+'</form>',res_id:1,archs:{'partner_type,false,list':'<tree>'+'<field name="display_name"/>'+'</tree>','partner_type,false,search':'<search>'+'<field name="display_name" string="Name"/>'+'</search>',},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .o_data_row').length,1,"should contain only one row (gold)");await cpHelpers.editSearch('.modal','s');await cpHelpers.validateSearch('.modal');assert.strictEqual($('.modal .o_data_row').length,0,"should contain no row");form.destroy();});QUnit.test('many2many list with onchange and edition of a record',async function(assert){assert.expect(8);this.data.partner.fields.turtles.type="many2many";this.data.partner.onchanges.turtles=function(){};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{'turtle,false,form':'<form string="Turtle Power"><field name="turtle_bar"/></form>',},mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('td.o_data_cell:first'));await testUtils.dom.click($('.modal-body input[type="checkbox"]'));await testUtils.dom.click($('.modal .modal-footer .btn-primary').first());await testUtils.form.clickSave(form);assert.verifySteps(['read','read','load_views','read','write','onchange','read',]);form.destroy();});QUnit.test('onchange with 40+ commands for a many2many',async function(assert){assert.expect(24);var commands=[[5]];for(var i=0;i<45;i++){var id=100+i;this.data.partner_type.records.push({id:id,display_name:"type "+id});commands.push([4,id]);}
this.data.partner.onchanges={foo:function(obj){obj.timmy=commands;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="timmy">'+'<kanban>'+'<field name="display_name"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div><t t-esc="record.display_name.value"/></div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);if(args.method==='write'){assert.strictEqual(args.args[1].timmy[0][0],6,"should send a command 6");assert.strictEqual(args.args[1].timmy[0][2].length,45,"should replace with 45 ids");}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});assert.verifySteps(['read']);await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'trigger onchange');assert.verifySteps(['onchange','read']);assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'1-40 / 45',"pager should be correct");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'there should be 40 records displayed on page 1');await testUtils.dom.click(form.$('.o_field_widget[name=timmy] .o_pager_next'));assert.verifySteps(['read']);assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'41-45 / 45',"pager should be correct");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,5,'there should be 5 records displayed on page 2');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'1-40 / 45',"pager should be correct");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'there should be 40 records displayed on page 1');await testUtils.dom.click(form.$('.o_field_widget[name=timmy] .o_pager_next'));assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'41-45 / 45',"pager should be correct");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,5,'there should be 5 records displayed on page 2');await testUtils.dom.click(form.$('.o_field_widget[name=timmy] .o_pager_next'));assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'1-40 / 45',"pager should be correct");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'there should be 40 records displayed on page 1');assert.verifySteps(['write','read','read','read']);form.destroy();});QUnit.test('default_get, onchange, onchange on m2m',async function(assert){assert.expect(1);this.data.partner.onchanges.int_field=function(obj){if(obj.int_field===2){assert.deepEqual(obj.timmy,[[6,false,[12]],[1,12,{display_name:'gold'}]]);}
obj.timmy=[[5],[1,12,{display_name:'gold'}]];};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="timmy">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'<field name="int_field"/>'+'</sheet>'+'</form>',});await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),2);form.destroy();});QUnit.test('widget many2many_tags',async function(assert){assert.expect(1);this.data.turtle.records[0].partner_ids=[2];var form=await createView({View:FormView,model:'turtle',data:this.data,arch:'<form string="Turtles">'+'<sheet>'+'<field name="display_name"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</sheet>'+'</form>',res_id:1,});assert.deepEqual(form.$('.o_field_many2manytags.o_field_widget .badge .o_badge_text').attr('title'),'second record','the title should be filled in');form.destroy();});QUnit.test('many2many tags widget: select multiple records',async function(assert){assert.expect(5);for(var i=1;i<=10;i++){this.data.partner_type.records.push({id:100+i,display_name:"Partner"+i});}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'<field name="timmy" widget="many2many_tags"/>'+'</form>',res_id:1,archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,search':'<search><field name="display_name"/></search>',},});await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown('timmy');await testUtils.fields.many2one.clickItem('timmy','Search More');assert.ok($('.modal .o_list_view'),"should have open the modal");assert.containsN($(document),'.modal .o_list_view .o_list_record_selector input',this.data.partner_type.records.length+1,"Should have record selector checkboxes to select multiple records");await testUtils.dom.click($('.modal .o_list_view thead .o_list_record_selector input'));assert.ok(!$('.modal .o_select_button').prop('disabled'),"select button should be enabled");await testUtils.dom.click($('.o_select_button'));assert.containsNone($(document),'.modal .o_list_view',"should have closed the modal");assert.containsN(form,'.o_field_many2manytags[name="timmy"] .badge',this.data.partner_type.records.length,"many2many tag should now contain 12 records");form.destroy();});QUnit.test("many2many tags widget: select multiple records doesn't show already added tags",async function(assert){assert.expect(5);for(var i=1;i<=10;i++){this.data.partner_type.records.push({id:100+i,display_name:"Partner"+i});}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'<field name="timmy" widget="many2many_tags"/>'+'</form>',res_id:1,archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,search':'<search><field name="display_name"/></search>',},});await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown('timmy');await testUtils.fields.many2one.clickItem('timmy','Partner1');await testUtils.fields.many2one.clickOpenDropdown('timmy');await testUtils.fields.many2one.clickItem('timmy','Search More');assert.ok($('.modal .o_list_view'),"should have open the modal");assert.containsN($(document),'.modal .o_list_view .o_list_record_selector input',this.data.partner_type.records.length-1+1,"Should have record selector checkboxes to select multiple records");await testUtils.dom.click($('.modal .o_list_view thead .o_list_record_selector input'));assert.ok(!$('.modal .o_select_button').prop('disabled'),"select button should be enabled");await testUtils.dom.click($('.o_select_button'));assert.containsNone($(document),'.modal .o_list_view',"should have closed the modal");assert.containsN(form,'.o_field_many2manytags[name="timmy"] .badge',this.data.partner_type.records.length,"many2many tag should now contain 12 records");form.destroy();});QUnit.test("many2many tags widget: save&new in edit mode doesn't close edit window",async function(assert){assert.expect(5);for(var i=1;i<=10;i++){this.data.partner_type.records.push({id:100+i,display_name:"Partner"+i});}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'<field name="timmy" widget="many2many_tags"/>'+'</form>',res_id:1,archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,search':'<search><field name="display_name"/></search>','partner_type,false,form':'<form><field name="display_name"/></form>'},});await testUtils.form.clickEdit(form);await testUtils.fields.many2one.createAndEdit('timmy',"Ralts");assert.containsOnce($(document),'.modal .o_form_view',"should have opened the modal");await testUtils.fields.editInput($('.modal input:first'),'Ralts');await testUtils.dom.click($('.modal .btn-primary:nth-child(2)'));assert.containsOnce($(document),'.modal .o_form_view',"modal should still be open");assert.equal($('.modal input:first')[0].value,'',"input should be empty")
await testUtils.fields.editInput($('.modal input:first'),'Pikachu');await testUtils.dom.click($('.modal .btn-primary:first'));assert.containsNone($(document),'.modal .o_list_view',"should have closed the modal");assert.containsN(form,'.o_field_many2manytags[name="timmy"] .badge',2,"many2many tag should now contain 2 records");form.destroy();});QUnit.test('many2many list add *many* records, remove, re-add',async function(assert){assert.expect(5);this.data.partner.fields.timmy.domain=[['color','=',2]];this.data.partner.fields.timmy.onChange=true;this.data.partner_type.fields.product_ids={string:"Product",type:"many2many",relation:'product'};for(var i=0;i<50;i++){var new_record_partner_type={id:100+i,display_name:"batch"+i,color:2};this.data.partner_type.records.push(new_record_partner_type);}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy" widget="many2many">'+'<tree>'+'<field name="display_name"/>'+'<field name="product_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,search':'<search><field name="display_name"/><field name="color"/></search>',},mockRPC:function(route,args){if(args.method==='get_formview_id'){assert.deepEqual(args.args[0],[1],"should call get_formview_id with correct id");return Promise.resolve(false);}
return this._super(route,args);},});await testUtils.dom.click(form.$buttons.find('.btn.btn-primary.o_form_button_edit'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));var $modal=$('.modal-lg');assert.equal($modal.length,1,'There should be one modal');await testUtils.dom.click($modal.find('thead input[type=checkbox]'));await testUtils.dom.click($modal.find('.btn.btn-primary.o_select_button'));assert.strictEqual(form.$('.o_data_row').length,51,'We should have added all the records present in the search view to the m2m field');await testUtils.dom.click(form.$buttons.find('.btn.btn-primary.o_form_button_save'));await testUtils.dom.click(form.$buttons.find('.btn.btn-primary.o_form_button_edit'));var trash_buttons=form.$('.o_field_many2many.o_field_widget.o_field_x2many.o_field_x2many_list .o_list_record_remove');await testUtils.dom.click(trash_buttons.first());var pager_limit=form.$('.o_field_many2many.o_field_widget.o_field_x2many.o_field_x2many_list .o_pager_limit');assert.equal(pager_limit.text(),'50','We should have 50 records in the m2m field');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));$modal=$('.modal-lg');assert.equal($modal.length,1,'There should be one modal');await testUtils.dom.click($modal.find('thead input[type=checkbox]'));await testUtils.dom.click($modal.find('.btn.btn-primary.o_select_button'));assert.strictEqual(form.$('.o_data_row').length,51,'We should have 51 records in the m2m field');form.destroy();});QUnit.test('many2many_tags widget: conditional create/delete actions',async function(assert){assert.expect(10);this.data.turtle.records[0].partner_ids=[2];for(var i=1;i<=10;i++){this.data.partner.records.push({id:100+i,display_name:"Partner"+i});}
const form=await createView({View:FormView,model:'turtle',data:this.data,arch:`
                    <form>
                        <field name="display_name"/>
                        <field name="turtle_bar"/>
                        <field name="partner_ids" options="{'create': [('turtle_bar', '=', True)], 'delete': [('turtle_bar', '=', True)]}" widget="many2many_tags"/>
                    </form>`,archs:{'partner,false,list':'<tree><field name="name"/></tree>','partner,false,search':'<search/>',},res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_field_many2manytags.o_field_widget .badge .o_delete','X icon on badges should not be available');await testUtils.fields.many2one.clickOpenDropdown('partner_ids');const $dropdown1=form.$('.o_field_many2one input').autocomplete('widget');assert.containsOnce($dropdown1,'li.o_m2o_start_typing:contains(Start typing...)','autocomplete should contain Start typing...');await testUtils.fields.many2one.clickItem('partner_ids','Search More');assert.containsN(document.body,'.modal .modal-footer button',3,'there should be 3 buttons (Select, Create and Cancel) available in the modal footer');await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'Something that does not exist','keydown');assert.containsN(form.$('.o_field_many2one input').autocomplete('widget'),'li.o_m2o_dropdown_option',2,'autocomplete should contain Create and Create and Edit... options');await testUtils.dom.click(form.$('.o_field_widget[name="turtle_bar"] input').first());assert.containsOnce(form,'.o_field_many2manytags.o_field_widget .badge .o_delete','X icon on badge should still be there even after turtle_bar is not checked');await testUtils.fields.many2one.clickOpenDropdown('partner_ids');const $dropdown2=form.$('.o_field_many2one input').autocomplete('widget');assert.containsOnce($dropdown2,'li.o_m2o_dropdown_option','autocomplete should contain only one option');assert.containsOnce($dropdown2,'li.o_m2o_dropdown_option:contains(Search More)','autocomplete option should be Search More');await testUtils.fields.many2one.clickItem('partner_ids','Search More');assert.containsN(document.body,'.modal .modal-footer button',2,'there should be 2 buttons (Select and Cancel) available in the modal footer');await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'Something that does not exist','keyup');assert.containsOnce($dropdown2,'li.o_m2o_dropdown_option','autocomplete should contain only one option');assert.containsOnce($dropdown2,'li.o_m2o_dropdown_option:contains(Search More)','autocomplete option should be Search More');form.destroy();});QUnit.test('failing many2one quick create in a many2many_tags',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="timmy" widget="many2many_tags"/></form>',mockRPC(route,args){if(args.method==='name_create'){return Promise.reject();}
if(args.method==='create'){assert.deepEqual(args.args[0],{color:8,name:'new partner',});}
return this._super.apply(this,arguments);},archs:{'partner_type,false,form':`
                        <form>
                            <field name="name"/>
                            <field name="color"/>
                        </form>`,},});assert.containsNone(form,'.o_field_many2manytags .badge');await testUtils.dom.triggerEvent(form.$('.o_field_many2one input'),'focus');await testUtils.fields.many2one.searchAndClickItem('timmy',{search:'new partner',item:'Create'});assert.containsOnce(document.body,'.modal .o_form_view');assert.strictEqual($('.modal .o_field_widget[name=name]').val(),'new partner');await testUtils.fields.editInput($('.modal .o_field_widget[name=color]'),8);await testUtils.modal.clickButton('Save & Close');assert.containsOnce(form,'.o_field_many2manytags .badge');form.destroy();});});});});;

/* /web/static/tests/fields/relational_fields/field_many2one_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.field_many_to_one_tests',function(require){"use strict";var BasicModel=require('web.BasicModel');var FormView=require('web.FormView');var ListView=require('web.ListView');var relationalFields=require('web.relational_fields');var StandaloneFieldManagerMixin=require('web.StandaloneFieldManagerMixin');var testUtils=require('web.test_utils');var Widget=require('web.Widget');const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;QUnit.module('fields',{},function(){QUnit.module('relational_fields',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Displayed name",type:"char"},foo:{string:"Foo",type:"char",default:"My little Foo Value"},bar:{string:"Bar",type:"boolean",default:true},int_field:{string:"int_field",type:"integer",sortable:true},p:{string:"one2many field",type:"one2many",relation:'partner',relation_field:'trululu'},turtles:{string:"one2many turtle field",type:"one2many",relation:'turtle',relation_field:'turtle_trululu'},trululu:{string:"Trululu",type:"many2one",relation:'partner'},timmy:{string:"pokemon",type:"many2many",relation:'partner_type'},product_id:{string:"Product",type:"many2one",relation:'product'},color:{type:"selection",selection:[['red',"Red"],['black',"Black"]],default:'red',string:"Color",},date:{string:"Some Date",type:"date"},datetime:{string:"Datetime Field",type:'datetime'},user_id:{string:"User",type:'many2one',relation:'user'},reference:{string:"Reference Field",type:'reference',selection:[["product","Product"],["partner_type","Partner Type"],["partner","Partner"]]},},records:[{id:1,display_name:"first record",bar:true,foo:"yop",int_field:10,p:[],turtles:[2],timmy:[],trululu:4,user_id:17,reference:'product,37',},{id:2,display_name:"second record",bar:true,foo:"blip",int_field:9,p:[],timmy:[],trululu:1,product_id:37,date:"2017-01-25",datetime:"2016-12-12 10:55:05",user_id:17,},{id:4,display_name:"aaa",bar:false,}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},partner_type:{fields:{display_name:{string:"Partner Type",type:"char"},name:{string:"Partner Type",type:"char"},color:{string:"Color index",type:"integer"},},records:[{id:12,display_name:"gold",color:2},{id:14,display_name:"silver",color:5},]},turtle:{fields:{display_name:{string:"Displayed name",type:"char"},turtle_foo:{string:"Foo",type:"char"},turtle_bar:{string:"Bar",type:"boolean",default:true},turtle_int:{string:"int",type:"integer",sortable:true},turtle_trululu:{string:"Trululu",type:"many2one",relation:'partner'},turtle_ref:{string:"Reference",type:'reference',selection:[["product","Product"],["partner","Partner"]]},product_id:{string:"Product",type:"many2one",relation:'product',required:true},partner_ids:{string:"Partner",type:"many2many",relation:'partner'},},records:[{id:1,display_name:"leonardo",turtle_bar:true,turtle_foo:"yop",partner_ids:[],},{id:2,display_name:"donatello",turtle_bar:true,turtle_foo:"blip",turtle_int:9,partner_ids:[2,4],},{id:3,display_name:"raphael",product_id:37,turtle_bar:false,turtle_foo:"kawa",turtle_int:21,partner_ids:[],turtle_ref:'product,37',}],onchanges:{},},user:{fields:{name:{string:"Name",type:"char"},partner_ids:{string:"one2many partners field",type:"one2many",relation:'partner',relation_field:'user_id'},},records:[{id:17,name:"Aline",partner_ids:[1,2],},{id:19,name:"Christine",}]},};},},function(){QUnit.module('FieldMany2One');QUnit.test('many2ones in form views',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="trululu" string="custom label"/>'+'</group>'+'</sheet>'+'</form>',archs:{'partner,false,form':'<form string="Partners"><field name="display_name"/></form>',},res_id:1,mockRPC:function(route,args){if(args.method==='get_formview_action'){assert.deepEqual(args.args[0],[4],"should call get_formview_action with correct id");return Promise.resolve({res_id:17,type:'ir.actions.act_window',target:'current',res_model:'res.partner'});}
if(args.method==='get_formview_id'){assert.deepEqual(args.args[0],[4],"should call get_formview_id with correct id");return Promise.resolve(false);}
return this._super(route,args);},});testUtils.mock.intercept(form,'do_action',function(event){assert.strictEqual(event.data.action.res_id,17,"should do a do_action with correct parameters");});assert.strictEqual(form.$('a.o_form_uri:contains(aaa)').length,1,"should contain a link");await testUtils.dom.click(form.$('a.o_form_uri'));await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_external_button'));assert.strictEqual($('.modal .modal-title').text().trim(),'Open: custom label',"dialog title should display the custom string label");form.destroy();});QUnit.test('editing a many2one, but not changing anything',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="trululu"/>'+'</sheet>'+'</form>',archs:{'partner,false,form':'<form string="Partners"><field name="display_name"/></form>',},res_id:1,mockRPC:function(route,args){if(args.method==='get_formview_id'){assert.deepEqual(args.args[0],[4],"should call get_formview_id with correct id");return Promise.resolve(false);}
return this._super(route,args);},viewOptions:{ids:[1,2],},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_external_button'));await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));await testUtils.form.clickSave(form);await testUtils.dom.click(form.el.querySelector('.o_pager .o_pager_next'));assert.strictEqual(form.el.querySelector('.o_pager').innerText.trim(),'2 / 2','pager should be at second page');form.destroy();});QUnit.test('context in many2one and default get',async function(assert){assert.expect(1);this.data.partner.fields.int_field.default=14;this.data.partner.fields.trululu.default=2;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="trululu"  context="{\'blip\':int_field}" options=\'{"always_reload": True}\'/>'+'</form>',mockRPC:function(route,args){if(args.method==='name_get'){assert.strictEqual(args.kwargs.context.blip,14,'context should have been properly sent to the nameget rpc');}
return this._super(route,args);},});form.destroy();});QUnit.test('editing a many2one (with form view opened with external button)',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="trululu"/>'+'</sheet>'+'</form>',archs:{'partner,false,form':'<form string="Partners"><field name="foo"/></form>',},res_id:1,mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super(route,args);},viewOptions:{ids:[1,2],},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_external_button'));await testUtils.fields.editInput($('.modal input[name="foo"]'),'brandon');await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));await testUtils.form.clickSave(form);await testUtils.dom.click(form.el.querySelector('.o_pager .o_pager_next'));assert.strictEqual(form.el.querySelector('.o_pager').innerText.trim(),'2 / 2','pager should be at second page');form.destroy();});QUnit.test('many2ones in form views with show_address',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field '+'name="trululu" '+'string="custom label" '+'context="{\'show_address\': 1}" '+'options="{\'always_reload\': True}"'+'/>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='name_get'){return this._super(route,args).then(function(result){result[0][1]+='\nStreet\nCity ZIP';return result;});}
return this._super(route,args);},res_id:1,});assert.strictEqual(form.$('a.o_form_uri').html(),'<span>aaa</span><br><span>Street</span><br><span>City ZIP</span>',"input should have a multi-line content in readonly due to show_address");await testUtils.form.clickEdit(form);assert.containsOnce(form,'button.o_external_button:visible',"should have an open record button");testUtils.dom.click(form.$('input.o_input'));assert.containsOnce(form,'button.o_external_button:visible',"should still have an open record button");form.$('input.o_input').trigger('focusout');assert.strictEqual($('.modal button:contains(Create and edit)').length,0,"there should not be a quick create modal");form.destroy();});QUnit.test('show_address works in a view embedded in a view of another type',async function(assert){assert.expect(1);this.data.turtle.records[1].turtle_trululu=2;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'<field name="turtles"/>'+'</form>',res_id:1,archs:{"turtle,false,form":'<form string="T">'+'<field name="display_name"/>'+'<field name="turtle_trululu" context="{\'show_address\': 1}" options="{\'always_reload\': True}"/>'+'</form>',"turtle,false,list":'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>',},mockRPC:function(route,args){if(args.method==='name_get'){return this._super(route,args).then(function(result){if(args.model==='partner'&&args.kwargs.context.show_address){result[0][1]+='\nrue morgue\nparis 75013';}
return result;});}
return this._super(route,args);},});await testUtils.dom.click(form.$('.o_data_row:first td.o_data_cell'));assert.strictEqual($('[name="turtle_trululu"]').text(),"second recordrue morgueparis 75013","The partner's address should be displayed");form.destroy();});QUnit.test('many2one data is reloaded if there is a context to take into account',async function(assert){assert.expect(1);this.data.turtle.records[1].turtle_trululu=2;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'<field name="turtles"/>'+'</form>',res_id:1,archs:{"turtle,false,form":'<form string="T">'+'<field name="display_name"/>'+'<field name="turtle_trululu" context="{\'show_address\': 1}" options="{\'always_reload\': True}"/>'+'</form>',"turtle,false,list":'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="turtle_trululu"/>'+'</tree>',},mockRPC:function(route,args){if(args.method==='name_get'){return this._super(route,args).then(function(result){if(args.model==='partner'&&args.kwargs.context.show_address){result[0][1]+='\nrue morgue\nparis 75013';}
return result;});}
return this._super(route,args);},});await testUtils.dom.click(form.$('.o_data_row:first'));assert.strictEqual($('.modal [name=turtle_trululu]').text(),"second recordrue morgueparis 75013","The partner's address should be displayed");form.destroy();});QUnit.test('many2ones in form views with search more',async function(assert){assert.expect(3);this.data.partner.records.push({id:5,display_name:"Partner 4",},{id:6,display_name:"Partner 5",},{id:7,display_name:"Partner 6",},{id:8,display_name:"Partner 7",},{id:9,display_name:"Partner 8",},{id:10,display_name:"Partner 9",});this.data.partner.fields.datetime.searchable=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="trululu"/>'+'</group>'+'</sheet>'+'</form>',archs:{'partner,false,list':'<tree><field name="display_name"/></tree>','partner,false,search':'<search><field name="datetime"/></search>',},res_id:1,});await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown('trululu');await testUtils.fields.many2one.clickItem('trululu','Search');assert.strictEqual($('tr.o_data_row').length,9,"should display 9 records");await cpHelpers.toggleFilterMenu('.modal');await cpHelpers.toggleAddCustomFilter('.modal');assert.strictEqual(document.querySelector('.modal .o_generator_menu_field').value,'datetime',"datetime field should be selected");await cpHelpers.applyFilter('.modal');assert.strictEqual($('tr.o_data_row').length,0,"should display 0 records");form.destroy();});QUnit.test('onchanges on many2ones trigger when editing record in form view',async function(assert){assert.expect(10);this.data.partner.onchanges.user_id=function(){};this.data.user.fields.other_field={string:"Other Field",type:"char"};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="user_id"/>'+'</group>'+'</sheet>'+'</form>',archs:{'user,false,form':'<form string="Users"><field name="other_field"/></form>',},res_id:1,mockRPC:function(route,args){assert.step(args.method);if(args.method==='get_formview_id'){return Promise.resolve(false);}
if(args.method==='onchange'){assert.strictEqual(args.args[1].user_id,17,"onchange is triggered with correct user_id");}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_external_button'));await testUtils.fields.editInput($('.modal-body input[name="other_field"]'),'wood');await testUtils.dom.click($('.modal .modal-footer .btn-primary').first());assert.verifySteps(['read','get_formview_id','load_views','read','write','read','onchange']);await testUtils.form.clickSave(form);assert.verifySteps([]);form.destroy();});QUnit.test("many2one doesn't trigger field_change when being emptied",async function(assert){assert.expect(2);const list=await createView({arch:`
                    <tree multi_edit="1">
                        <field name="trululu"/>
                    </tree>`,data:this.data,model:'partner',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:first() .o_data_cell:first()'));const $input=list.$('.o_field_widget[name=trululu] input');await testUtils.fields.editInput($input,"");await testUtils.dom.triggerEvents($input,['keyup']);assert.containsNone(document.body,'.modal',"No save should be triggered when removing value");await testUtils.fields.many2one.clickHighlightedItem('trululu');assert.containsOnce(document.body,'.modal',"Saving should be triggered when selecting a value");await testUtils.dom.click($('.modal .btn-primary'));list.destroy();});QUnit.test("focus tracking on a many2one in a list",async function(assert){assert.expect(4);const list=await createView({arch:'<tree editable="top"><field name="trululu"/></tree>',archs:{'partner,false,form':'<form string="Partners"><field name="foo"/></form>',},data:this.data,model:'partner',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:first() .o_data_cell:first()'));const input=list.$('.o_data_row:first() .o_data_cell:first() input')[0];assert.strictEqual(document.activeElement,input,"Input should be focused when activated");await testUtils.fields.many2one.createAndEdit('trululu',"ABC");assert.containsOnce(document.body,'.modal',"There should be only one modal");await testUtils.dom.click($('.modal .btn:not(.btn-primary)'));assert.strictEqual(document.activeElement,input,"Input should be focused after dialog closes");assert.strictEqual(input.value,"","Input should be empty after discard");list.destroy();});QUnit.test('many2one fields with option "no_open"',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="trululu" options="{&quot;no_open&quot;: True}" />'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'span.o_field_widget[name=trululu]',"should be displayed inside a span (sanity check)");assert.containsNone(form,'span.o_form_uri',"should not have an anchor");await testUtils.form.clickEdit(form);assert.containsNone(form,'.o_field_widget[name=trululu] .o_external_button',"should not have the button to open the record");form.destroy();});QUnit.test('empty many2one field',async function(assert){assert.expect(4);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                        <sheet>
                            <group>
                                <field name="trululu"/>
                            </group>
                        </sheet>
                    </form>`,viewOptions:{mode:'edit',},});const $dropdown=form.$('.o_field_many2one input').autocomplete('widget');await testUtils.fields.many2one.clickOpenDropdown('trululu');assert.containsNone($dropdown,'li.o_m2o_dropdown_option','autocomplete should not contains dropdown options');assert.containsOnce($dropdown,'li.o_m2o_start_typing','autocomplete should contains start typing option');await testUtils.fields.editAndTrigger(form.$('.o_field_many2one[name="trululu"] input'),'abc','keydown');await testUtils.nextTick();assert.containsN($dropdown,'li.o_m2o_dropdown_option',2,'autocomplete should contains 2 dropdown options');assert.containsNone($dropdown,'li.o_m2o_start_typing','autocomplete should not contains start typing option');form.destroy();});QUnit.test('empty many2one field with node options',async function(assert){assert.expect(2);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                    <sheet>
                        <group>
                            <field name="trululu" options="{'no_create_edit': 1}"/>
                            <field name="product_id" options="{'no_create_edit': 1, 'no_quick_create': 1}"/>
                        </group>
                    </sheet>
                </form>`,viewOptions:{mode:'edit',},});const $dropdownTrululu=form.$('.o_field_many2one[name="trululu"] input').autocomplete('widget');const $dropdownProduct=form.$('.o_field_many2one[name="product_id"] input').autocomplete('widget');await testUtils.fields.many2one.clickOpenDropdown('trululu');assert.containsOnce($dropdownTrululu,'li.o_m2o_start_typing','autocomplete should contains start typing option');await testUtils.fields.many2one.clickOpenDropdown('product_id');assert.containsNone($dropdownProduct,'li.o_m2o_start_typing','autocomplete should contains start typing option');form.destroy();});QUnit.test('many2one in edit mode',async function(assert){assert.expect(17);for(var i=0;i<10;i++){var id=20+i;this.data.partner.records.push({id:id,display_name:"Partner "+id});}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="trululu"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,archs:{'partner,false,list':'<tree string="Partners"><field name="display_name"/></tree>','partner,false,search':'<search string="Partners">'+'<field name="display_name" string="Name"/>'+'</search>',},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[1].trululu,20,"should write the correct id");}
return this._super.apply(this,arguments);},});testUtils.mock.intercept(form,'get_session',function(event){event.data.callback({user_context:{}});});await testUtils.form.clickEdit(form);var $dropdown=form.$('.o_field_many2one input').autocomplete('widget');await testUtils.fields.many2one.clickOpenDropdown('trululu');assert.ok($dropdown.is(':visible'),'clicking on the m2o input should open the dropdown if it is not open yet');assert.strictEqual($dropdown.find('li:not(.o_m2o_dropdown_option)').length,7,'autocomplete should contains 8 suggestions');assert.strictEqual($dropdown.find('li.o_m2o_dropdown_option').length,1,'autocomplete should contain "Search More"');assert.containsNone($dropdown,'li.o_m2o_start_typing','autocomplete should not contains start typing option if value is available');await testUtils.fields.many2one.clickOpenDropdown('trululu');assert.ok(!$dropdown.is(':visible'),'clicking on the m2o input should close the dropdown if it is open');await testUtils.fields.many2one.clickOpenDropdown('trululu');await testUtils.fields.many2one.clickHighlightedItem('trululu');assert.ok(!$dropdown.is(':visible'),'clicking on a value should close the dropdown');assert.strictEqual(form.$('.o_field_many2one input').val(),'first record','value of the m2o should have been correctly updated');await testUtils.fields.many2one.clickOpenDropdown('trululu');await testUtils.fields.many2one.clickItem('trululu','Search');assert.ok($('.modal .o_list_view').length,"should have opened a list view in a modal");assert.ok(!$('.modal .o_list_view .o_list_record_selector').length,"there should be no record selector in the list view");assert.ok(!$('.modal .modal-footer .o_select_button').length,"there should be no 'Select' button in the footer");assert.ok($('.modal tbody tr').length>10,"list should contain more than 10 records");await cpHelpers.editSearch('.modal',"P");await cpHelpers.validateSearch('.modal');assert.strictEqual($('.modal tbody tr').length,10,"list should be restricted to records containing a P (10 records)");await testUtils.dom.click($('.modal tbody tr:contains(Partner 20)'));assert.ok(!$('.modal').length,"should have closed the modal");assert.ok(!$dropdown.is(':visible'),'should have closed the dropdown');assert.strictEqual(form.$('.o_field_many2one input').val(),'Partner 20','value of the m2o should have been correctly updated');await testUtils.form.clickSave(form);assert.strictEqual(form.$('a.o_form_uri').text(),'Partner 20',"should display correct value after save");form.destroy();});QUnit.test('many2one in non edit mode',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="trululu"/>'+'</form>',res_id:1,});assert.containsOnce(form,'a.o_form_uri',"should display 1 m2o link in form");assert.hasAttrValue(form.$('a.o_form_uri'),'href',"#id=4&model=partner","href should contain id and model");await testUtils.form.clickEdit(form);form.$('.o_field_many2one input').val('').trigger('keyup').trigger('focusout');await testUtils.form.clickSave(form);assert.hasAttrValue(form.$('a.o_form_uri'),'href',"#","href should have #");form.destroy();});QUnit.test('many2one with co-model whose name field is a many2one',async function(assert){assert.expect(4);this.data.product.fields.name={string:'User Name',type:'many2one',relation:'user',};const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="product_id"/></form>',archs:{'product,false,form':'<form><field name="name"/></form>',},});await testUtils.fields.many2one.createAndEdit('product_id',"ABC");assert.containsOnce(document.body,'.modal .o_form_view');await testUtils.fields.many2one.searchAndClickItem('name',{search:'new value'});assert.strictEqual($('.modal .o_field_many2one input').val(),'new value');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.containsNone(document.body,'.modal .o_form_view');assert.strictEqual(form.$('.o_field_many2one input').val(),'new value');form.destroy();});QUnit.test('many2one searches with correct value',async function(assert){assert.expect(6);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="trululu"/>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='name_search'){assert.step('search: '+args.kwargs.name);}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_field_many2one input').val(),'aaa',"should be initially set to 'aaa'");await testUtils.dom.click(form.$('.o_field_many2one input'));form.$('.o_field_many2one input').val('').trigger('keydown');await testUtils.nextTick();form.$('.o_field_many2one input').val('p').trigger('keydown').trigger('keyup');await testUtils.nextTick();await testUtils.dom.click(form.$('.o_field_many2one input'));await testUtils.dom.click(form.$('.o_field_many2one input'));assert.verifySteps(['search: ','search: ','search: p','search: p']);relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('many2one search with trailing and leading spaces',async function(assert){assert.expect(10);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form><field name="trululu"/></form>`,mockRPC:function(route,args){if(args.method==='name_search'){assert.step('search: '+args.kwargs.name);}
return this._super.apply(this,arguments);},});const $dropdown=form.$('.o_field_many2one input').autocomplete('widget');await testUtils.fields.many2one.clickOpenDropdown('trululu');assert.isVisible($dropdown);assert.containsN($dropdown,'li:not(.o_m2o_dropdown_option)',4,'autocomplete should contains 4 suggestions');form.$('.o_field_many2one input').val('   first').trigger('keydown').trigger('keyup');await testUtils.nextTick();assert.containsOnce($dropdown,'li:not(.o_m2o_dropdown_option)','autocomplete should contains 1 suggestion');form.$('.o_field_many2one input').val('first  ').trigger('keydown').trigger('keyup');await testUtils.nextTick();assert.containsOnce($dropdown,'li:not(.o_m2o_dropdown_option)','autocomplete should contains 1 suggestion');form.$('.o_field_many2one input').val('   first   ').trigger('keydown').trigger('keyup');await testUtils.nextTick();assert.containsOnce($dropdown,'li:not(.o_m2o_dropdown_option)','autocomplete should contains 1 suggestion');assert.verifySteps(['search: ','search: first','search: first','search: first']);form.destroy();});QUnit.test('many2one field with option always_reload',async function(assert){assert.expect(4);var count=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="trululu" options="{\'always_reload\': True}"/>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='name_get'){count++;return Promise.resolve([[1,"first record\nand some address"]]);}
return this._super(route,args);},});assert.strictEqual(count,1,"an extra name_get should have been done");assert.ok(form.$('a:contains(and some address)').length,"should display additional result");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name=trululu] input').val(),"first record","actual field value should be displayed to be edited");await testUtils.form.clickSave(form);assert.ok(form.$('a:contains(and some address)').length,"should still display additional result");form.destroy();});QUnit.test('many2one field and list navigation',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="trululu"/></tree>',});await testUtils.dom.click(list.$('.o_data_row .o_data_cell').first());await testUtils.fields.editInput(list.$('.o_data_cell input'),'');await testUtils.fields.triggerKeydown(list.$('.o_data_cell input').focus(),'down');var $dropdown=list.$('.o_field_many2one input').autocomplete('widget');assert.ok($dropdown.is(':visible'),"dropdown should be visible");assert.hasClass(list.$('.o_data_row:eq(0)'),'o_selected_row','first data row should still be selected');assert.doesNotHaveClass(list.$('.o_data_row:eq(1)'),'o_selected_row','second data row should not be selected');list.destroy();});QUnit.test('standalone many2one field',async function(assert){assert.expect(4);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;var fixture=$('#qunit-fixture');var self=this;var model=await testUtils.createModel({Model:BasicModel,data:this.data,});var record;model.makeRecord('coucou',[{name:'partner_id',relation:'partner',type:'many2one',value:[1,'first partner'],}]).then(function(recordID){record=model.get(recordID);});await testUtils.nextTick();var StandaloneWidget=Widget.extend(StandaloneFieldManagerMixin,{init:function(parent){this._super.apply(this,arguments);StandaloneFieldManagerMixin.init.call(this,parent);},});var parent=new StandaloneWidget(model);model.setParent(parent);await testUtils.mock.addMockEnvironment(parent,{data:self.data,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});var relField=new relationalFields.FieldMany2One(parent,'partner_id',record,{mode:'edit',noOpen:true,});relField.appendTo(fixture);await testUtils.nextTick();await testUtils.fields.editInput($('input.o_input'),'xyzzrot');await testUtils.fields.many2one.clickItem('partner_id','Create');assert.containsNone(relField,'.o_external_button',"should not have the button to open the record");assert.verifySteps(['name_search','name_create']);parent.destroy();model.destroy();relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;});QUnit.test('form: quick create then save directly',async function(assert){assert.expect(5);var prom=testUtils.makeTestPromise();var newRecordID;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="trululu"/>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='name_create'){assert.step('name_create');return prom.then(_.constant(result)).then(function(nameGet){newRecordID=nameGet[0];return nameGet;});}
if(args.method==='create'){assert.step('create');assert.strictEqual(args.args[0].trululu,newRecordID,"should create with the correct m2o id");}
return result;},});await testUtils.fields.many2one.searchAndClickItem('trululu',{search:'b'});await testUtils.form.clickSave(form);assert.verifySteps(['name_create'],"should wait for the name_create before creating the record");await prom.resolve();await testUtils.nextTick();assert.verifySteps(['create']);form.destroy();});QUnit.test('form: quick create for field that returns false after name_create call',async function(assert){assert.expect(3);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="trululu"/></form>',mockRPC:function(route,args){const result=this._super.apply(this,arguments);if(args.method==='name_create'){assert.step('name_create');return Promise.resolve(false);}
return result;},});await testUtils.fields.many2one.searchAndClickItem('trululu',{search:'beam'});assert.verifySteps(['name_create'],'attempt to name_create');assert.strictEqual(form.$(".o_input_dropdown input").val(),"","the input should contain no text after search and click")
form.destroy();});QUnit.test('list: quick create then save directly',async function(assert){assert.expect(8);var prom=testUtils.makeTestPromise();var newRecordID;var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="top">'+'<field name="trululu"/>'+'</tree>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='name_create'){assert.step('name_create');return prom.then(_.constant(result)).then(function(nameGet){newRecordID=nameGet[0];return nameGet;});}
if(args.method==='create'){assert.step('create');assert.strictEqual(args.args[0].trululu,newRecordID,"should create with the correct m2o id");}
return result;},});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));await testUtils.fields.many2one.searchAndClickItem('trululu',{search:'b'});list.$buttons.find('.o_list_button_add').show();testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.verifySteps(['name_create'],"should wait for the name_create before creating the record");assert.containsN(list,'.o_data_row',4,"should wait for the name_create before adding the new row");await prom.resolve();await testUtils.nextTick();assert.verifySteps(['create']);assert.strictEqual(list.$('.o_data_row:nth(1) .o_data_cell').text(),'b',"created row should have the correct m2o value");assert.containsN(list,'.o_data_row',5,"should have added the fifth row");list.destroy();});QUnit.test('list in form: quick create then save directly',async function(assert){assert.expect(6);var prom=testUtils.makeTestPromise();var newRecordID;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='name_create'){assert.step('name_create');return prom.then(_.constant(result)).then(function(nameGet){newRecordID=nameGet[0];return nameGet;});}
if(args.method==='create'){assert.step('create');assert.strictEqual(args.args[0].p[0][2].trululu,newRecordID,"should create with the correct m2o id");}
return result;},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.many2one.searchAndClickItem('trululu',{search:'b'});await testUtils.form.clickSave(form);assert.verifySteps(['name_create'],"should wait for the name_create before creating the record");await prom.resolve();await testUtils.nextTick();assert.verifySteps(['create']);assert.strictEqual(form.$('.o_data_row:first .o_data_cell').text(),'b',"first row should have the correct m2o value");form.destroy();});QUnit.test('list in form: quick create then add a new line directly',async function(assert){assert.expect(8);this.data.partner.onchanges={trululu:function(){},};var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;var prom=testUtils.makeTestPromise();var newRecordID;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="trululu" required="1"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='name_create'){return prom.then(_.constant(result)).then(function(nameGet){newRecordID=nameGet[0];return nameGet;});}
if(args.method==='create'){assert.deepEqual(args.args[0].p[0][2].trululu,newRecordID);}
return result;},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'b','keydown');await testUtils.fields.many2one.clickHighlightedItem('trululu');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(form,'.o_data_row',"there should still be only one row");assert.hasClass(form.$('.o_data_row'),'o_selected_row',"the row should still be in edition");await prom.resolve();await testUtils.nextTick();assert.strictEqual(form.$('.o_data_row:first .o_data_cell').text(),'b',"first row should have the correct m2o value");assert.containsN(form,'.o_data_row',2,"there should now be 2 rows");assert.hasClass(form.$('.o_data_row:nth(1)'),'o_selected_row',"the second row should be in edition");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_data_row',"there should be 1 row saved (the second one was empty and invalid)");assert.strictEqual(form.$('.o_data_row .o_data_cell').text(),'b',"should have the correct m2o value");relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('list in form: create with one2many with many2one',async function(assert){assert.expect(1);this.data.partner.fields.p.default=[[0,0,{display_name:'new record',p:[]}]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='name_get'){throw new Error('Nameget should not be called');}
return this._super.apply(this,arguments);},});assert.strictEqual($('td.o_data_cell:first').text(),'new record',"should have created the new record in the o2m with the correct name");form.destroy();});QUnit.test('list in form: create with one2many with many2one (version 2)',async function(assert){assert.expect(1);this.data.partner.fields.p.default=[[0,0,{display_name:'new record',trululu:false,p:[]}]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='name_get'){throw new Error('Nameget should not be called');}
return this._super.apply(this,arguments);},});assert.strictEqual($('td.o_data_cell:first').text(),'new record',"should have created the new record in the o2m with the correct name");form.destroy();});QUnit.test('item not dropped on discard with empty required field (default_get)',async function(assert){assert.expect(8);this.data.partner.fields.p.default=[[0,0,{display_name:'new record',trululu:false,p:[]}]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="trululu" required="1"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',});assert.strictEqual($('tr.o_data_row').length,1,"should have created the new record in the o2m");assert.strictEqual($('td.o_data_cell').first().text(),"new record","should have the correct displayed name");var requiredElement=$('td.o_data_cell.o_required_modifier');assert.strictEqual(requiredElement.length,1,"should have a required field on this record");assert.strictEqual(requiredElement.text(),"","should have empty string in the required field on this record");testUtils.dom.click(requiredElement);testUtils.dom.click($('body'));assert.strictEqual($('tr.o_data_row').length,1,"should still have the record in the o2m");assert.strictEqual($('td.o_data_cell').first().text(),"new record","should still have the correct displayed name");requiredElement=$('td.o_data_cell.o_required_modifier');assert.strictEqual(requiredElement.length,1,"should still have the required field on this record");assert.strictEqual(requiredElement.text(),"","should still have empty string in the required field on this record");form.destroy();});QUnit.test('list in form: name_get with unique ids (default_get)',async function(assert){assert.expect(1);this.data.partner.records[0].display_name="MyTrululu";this.data.partner.fields.p.default=[[0,0,{trululu:1,p:[]}],[0,0,{trululu:1,p:[]}]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='name_get'){throw new Error('should not call name_get');}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('td.o_data_cell').text(),"MyTrululuMyTrululu","both records should have the correct display_name for trululu field");form.destroy();});QUnit.test('list in form: show name of many2one fields in multi-page (default_get)',async function(assert){assert.expect(4);this.data.partner.fields.p.default=[[0,0,{display_name:'record1',trululu:1,p:[]}],[0,0,{display_name:'record2',trululu:2,p:[]}]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom" limit="1">'+'<field name="display_name"/>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',});assert.strictEqual(form.$('td.o_data_cell').first().text(),"record1","should show display_name of 1st record");assert.strictEqual(form.$('td.o_data_cell').first().next().text(),"first record","should show display_name of trululu of 1st record");await testUtils.dom.click(form.$('button.o_pager_next'));assert.strictEqual(form.$('td.o_data_cell').first().text(),"record2","should show display_name of 2nd record");assert.strictEqual(form.$('td.o_data_cell').first().next().text(),"second record","should show display_name of trululu of 2nd record");form.destroy();});QUnit.test('list in form: item not dropped on discard with empty required field (onchange in default_get)',async function(assert){assert.expect(7);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;this.data.partner.fields.product_id.default=37;this.data.partner.onchanges={product_id:function(obj){if(obj.product_id===37){obj.p=[[0,0,{display_name:"entry",trululu:false}]];}},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="product_id"/>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="trululu" required="1"/>'+'</tree>'+'</field>'+'</form>',});assert.containsOnce(form,'.o_data_row',"should have a row in the editable list");assert.strictEqual($('td.o_data_cell').first().text(),"entry","should have the correct displayed name");var requiredField=$('td.o_data_cell.o_required_modifier');assert.strictEqual(requiredField.length,1,"should have a required field on this record");assert.strictEqual(requiredField.text(),"","should have empty string in the required field on this record");testUtils.dom.click(requiredField);testUtils.dom.click($('body'));assert.containsOnce(form,'.o_data_row',"should not have dropped record in the editable list");assert.strictEqual($('td.o_data_cell').first().text(),"entry","should still have the correct displayed name");assert.strictEqual($('td.o_data_cell.o_required_modifier').text(),"","should still have empty string in the required field");relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('list in form: item not dropped on discard with empty required field (onchange on list after default_get)',async function(assert){assert.expect(8);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;this.data.partner.onchanges={product_id:function(obj){if(obj.product_id===37){obj.p=[[0,0,{display_name:"entry",trululu:false}]];}},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="product_id"/>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="trululu" required="1"/>'+'</tree>'+'</field>'+'</form>',});assert.containsNone(form,'.o_data_row',"should have no row in the editable list");await testUtils.dom.click(form.$('.o_field_widget[name="product_id"] .o_input'));await testUtils.dom.click($('.ui-menu-item').first());assert.containsOnce(form,'.o_data_row',"should have a row in the editable list");assert.strictEqual($('td.o_data_cell').first().text(),"entry","should have the correct displayed name");var requiredField=$('td.o_data_cell.o_required_modifier');assert.strictEqual(requiredField.length,1,"should have a required field on this record");assert.strictEqual(requiredField.text(),"","should have empty string in the required field on this record");await testUtils.dom.click(requiredField);await testUtils.dom.click($('body'));assert.containsOnce(form,'.o_data_row',"should not have dropped record in the editable list");assert.strictEqual($('td.o_data_cell').first().text(),"entry","should still have the correct displayed name");assert.strictEqual($('td.o_data_cell.o_required_modifier').text(),"","should still have empty string in the required field");relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('item dropped on discard with empty required field with "Add an item" (invalid on "ADD")',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="trululu" required="1"/>'+'</tree>'+'</field>'+'</form>',});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));var charField=form.$('.o_field_widget.o_field_char[name="display_name"]');var requiredField=form.$('.o_field_widget.o_required_modifier[name="trululu"]');charField.val("some text");assert.strictEqual(charField.length,1,"should have a char field 'display_name' on this record");assert.doesNotHaveClass(charField,'o_required_modifier',"the char field should not be required on this record");assert.strictEqual(charField.val(),"some text","should have entered text in the char field on this record");assert.strictEqual(requiredField.length,1,"should have a required field 'trululu' on this record");assert.strictEqual(requiredField.val().trim(),"","should have empty string in the required field on this record");await testUtils.dom.click(requiredField);await testUtils.dom.click($('body'));assert.containsNone(form,'.o_data_row',"should have dropped record in the editable list");form.destroy();});QUnit.test('item not dropped on discard with empty required field with "Add an item" (invalid on "UPDATE")',async function(assert){assert.expect(8);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="trululu" required="1"/>'+'</tree>'+'</field>'+'</form>',});assert.containsNone(form,'.o_data_row',"should initially not have any record in the list");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(form,'.o_data_row',"should have a temporary record in the list");var $inputEditMode=form.$('.o_field_widget.o_required_modifier[name="trululu"] input');assert.strictEqual($inputEditMode.length,1,"should have a required field 'trululu' on this record");assert.strictEqual($inputEditMode.val(),"","should have empty string in the required field on this record");await testUtils.dom.click($inputEditMode);await testUtils.dom.click($('li.ui-menu-item').first());await testUtils.dom.click($('body'));var $inputReadonlyMode=form.$('.o_data_cell.o_required_modifier');assert.containsOnce(form,'.o_data_row',"should not have dropped valid record when leaving edit mode");assert.strictEqual($inputReadonlyMode.text(),"first record","should have put some content in the required field on this record");await testUtils.dom.click($('.o_data_row'));assert.containsOnce(form,'.o_data_row',"should not have dropped record in the list on discard (invalid on UPDATE)");assert.strictEqual($inputReadonlyMode.text(),"first record","should keep previous valid required field content on this record");relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('list in form: default_get with x2many create',async function(assert){assert.expect(3);this.data.partner.fields.timmy.default=[[0,0,{display_name:'brandon is the new timmy',name:'brandon'}]];var displayName='brandon is the new timmy';this.data.partner.onchanges.timmy=function(obj){obj.int_field=obj.timmy.length;};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="timmy">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'<field name="int_field"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0],{int_field:2,timmy:[[6,false,[]],[0,args.args[0].timmy[1][1],{display_name:displayName}],],},"should send the correct values to create");}
return this._super.apply(this,arguments);},});assert.strictEqual($('td.o_data_cell:first').text(),'brandon is the new timmy',"should have created the new record in the m2m with the correct name");assert.strictEqual($('input.o_field_integer').val(),'1',"should have called and executed the onchange properly");displayName='new value';await testUtils.dom.click(form.$('.o_data_cell'));await testUtils.fields.editInput(form.$('.o_data_cell input'),displayName);await testUtils.form.clickSave(form);form.destroy();});QUnit.test('list in form: default_get with x2many create and onchange',async function(assert){assert.expect(1);this.data.partner.fields.turtles.default=[[6,0,[2,3]]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'<field name="int_field"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0].turtles,[[4,2,false],[4,3,false],],'should send proper commands to create method');}
return this._super.apply(this,arguments);},});await testUtils.form.clickSave(form);form.destroy();});QUnit.test('list in form: call button in sub view',async function(assert){assert.expect(11);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/product/get_formview_id'){return Promise.resolve(false);}
return this._super.apply(this,arguments);},intercepts:{execute_action:function(event){assert.strictEqual(event.data.env.model,'product','should call with correct model in env');assert.strictEqual(event.data.env.currentID,37,'should call with correct currentID in env');assert.deepEqual(event.data.env.resIDs,[37],'should call with correct resIDs in env');assert.step(event.data.action_data.name);},},archs:{'product,false,form':'<form string="Partners">'+'<header>'+'<button name="action" type="action" string="Just do it !"/>'+'<button name="object" type="object" string="Just don\'t do it !"/>'+'<field name="display_name"/>'+'</header>'+'</form>',},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('td.o_data_cell:first'));await testUtils.dom.click(form.$('.o_external_button'));await testUtils.dom.click($('button:contains("Just do it !")'));assert.verifySteps(['action']);await testUtils.dom.click($('button:contains("Just don\'t do it !")'));assert.verifySteps([]);await testUtils.dom.click($('.modal .btn-secondary:contains(Discard)'));await testUtils.dom.click(form.$('.o_external_button'));await testUtils.dom.click($('button:contains("Just don\'t do it !")'));assert.verifySteps(['object']);form.destroy();});QUnit.test('X2Many sequence list in modal',async function(assert){assert.expect(5);this.data.partner.fields.sequence={string:'Sequence',type:'integer'};this.data.partner.records[0].sequence=1;this.data.partner.records[1].sequence=2;this.data.partner.onchanges={sequence:function(obj){if(obj.id===2){obj.sequence=1;assert.step('onchange sequence');}},};this.data.product.fields.turtle_ids={string:'Turtles',type:'one2many',relation:'turtle'};this.data.product.records[0].turtle_ids=[1];this.data.turtle.fields.partner_types_ids={string:"Partner",type:"one2many",relation:'partner'};this.data.turtle.fields.type_id={string:"Partner Type",type:"many2one",relation:'partner_type'};this.data.partner_type.fields.partner_ids={string:"Partner",type:"one2many",relation:'partner'};this.data.partner_type.records[0].partner_ids=[1,2];var form=await createView({View:FormView,model:'product',data:this.data,arch:'<form>'+'<field name="name"/>'+'<field name="turtle_ids" widget="one2many">'+'<tree string="Turtles" editable="bottom">'+'<field name="type_id"/>'+'</tree>'+'</field>'+'</form>',archs:{'partner_type,false,form':'<form><field name="partner_ids"/></form>','partner,false,list':'<tree string="Vendors">'+'<field name="display_name"/>'+'<field name="sequence" widget="handle"/>'+'</tree>',},res_id:37,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/product/read'){return Promise.resolve([{id:37,name:'xphone',display_name:'leonardo',turtle_ids:[1]}]);}
if(route==='/web/dataset/call_kw/turtle/read'){return Promise.resolve([{id:1,type_id:[12,'gold']}]);}
if(route==='/web/dataset/call_kw/partner_type/get_formview_id'){return Promise.resolve(false);}
if(route==='/web/dataset/call_kw/partner_type/read'){return Promise.resolve([{id:12,partner_ids:[1,2],display_name:'gold'}]);}
if(route==='/web/dataset/call_kw/partner_type/write'){assert.step('partner_type write');}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_cell'));await testUtils.dom.click(form.$('.o_external_button'));var $modal=$('.modal');assert.equal($modal.length,1,'There should be 1 modal opened');var $handles=$modal.find('.ui-sortable-handle');assert.equal($handles.length,2,'There should be 2 sequence handlers');await testUtils.dom.dragAndDrop($handles.eq(1),$modal.find('tbody tr').first(),{position:'top'});await testUtils.dom.click($modal.find('.modal-footer .btn-primary'));await testUtils.form.clickSave(form);assert.verifySteps(['onchange sequence','partner_type write']);form.destroy();});QUnit.test('autocompletion in a many2one, in form view with a domain',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="product_id"/>'+'</form>',res_id:1,viewOptions:{domain:[['trululu','=',4]]},mockRPC:function(route,args){if(args.method==='name_search'){assert.deepEqual(args.kwargs.args,[],"should not have a domain");}
return this._super(route,args);}});await testUtils.form.clickEdit(form);testUtils.dom.click(form.$('.o_field_widget[name=product_id] input'));form.destroy();});QUnit.test('autocompletion in a many2one, in form view with a date field',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar"/>'+'<field name="date"/>'+'<field name="trululu" domain="[(\'bar\',\'=\',True)]"/>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='name_search'){assert.deepEqual(args.kwargs.args,[["bar","=",true]],"should not have a domain");}
return this._super(route,args);},});await testUtils.form.clickEdit(form);testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));form.destroy();});QUnit.test('creating record with many2one with option always_reload',async function(assert){assert.expect(2);this.data.partner.fields.trululu.default=1;this.data.partner.onchanges={trululu:function(obj){obj.trululu=2;},};var count=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="trululu" options="{\'always_reload\': True}"/>'+'</form>',mockRPC:function(route,args){count++;if(args.method==='name_get'&&args.args[0]===2){return Promise.resolve([[2,"hello world\nso much noise"]]);}
return this._super(route,args);},});assert.strictEqual(count,2,"should have done 2 rpcs (onchange and name_get)");assert.strictEqual(form.$('.o_field_widget[name=trululu] input').val(),'hello world',"should have taken the correct display name");form.destroy();});QUnit.test('selecting a many2one, then discarding',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="product_id"/>'+'</form>',res_id:1,});assert.strictEqual(form.$('a[name=product_id]').text(),'','the tag a should be empty');await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickItem('product_id','xphone');assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),"xphone","should have selected xphone");await testUtils.form.clickDiscard(form);assert.strictEqual(form.$('a[name=product_id]').text(),'','the tag a should be empty');form.destroy();});QUnit.test('domain and context are correctly used when doing a name_search in a m2o',async function(assert){assert.expect(4);this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="product_id" '+'domain="[[\'foo\', \'=\', \'bar\'], [\'foo\', \'=\', foo]]" '+'context="{\'hello\': \'world\', \'test\': foo}"/>'+'<field name="foo"/>'+'<field name="trululu" context="{\'timmy\': timmy}" domain="[[\'id\', \'in\', timmy]]"/>'+'<field name="timmy" widget="many2many_tags" invisible="1"/>'+'</form>',res_id:1,session:{user_context:{hey:"ho"}},mockRPC:function(route,args){if(args.method==='name_search'&&args.model==='product'){assert.deepEqual(args.kwargs.args,[['foo','=','bar'],['foo','=','yop']],'the field attr domain should have been used for the RPC (and evaluated)');assert.deepEqual(args.kwargs.context,{hey:"ho",hello:"world",test:"yop"},'the field attr context should have been used for the '+'RPC (evaluated and merged with the session one)');return Promise.resolve([]);}
if(args.method==='name_search'&&args.model==='partner'){assert.deepEqual(args.kwargs.args,[['id','in',[12]]],'the field attr domain should have been used for the RPC (and evaluated)');assert.deepEqual(args.kwargs.context,{hey:'ho',timmy:[[6,false,[12]]]},'the field attr context should have been used for the RPC (and evaluated)');return Promise.resolve([]);}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);testUtils.dom.click(form.$('.o_field_widget[name=product_id] input'));testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));form.destroy();});QUnit.test('quick create on a many2one',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/product/name_create'){assert.strictEqual(args.args[0],'new partner',"should name create a new product");}
return this._super.apply(this,arguments);},});await testUtils.dom.triggerEvent(form.$('.o_field_many2one input'),'focus');await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'new partner',['keyup','blur']);await testUtils.dom.click($('.modal .modal-footer .btn-primary').first());assert.strictEqual($('.modal .modal-body').text().trim(),"Do you want to create new partner as a new Product?");form.destroy();});QUnit.test('failing quick create on a many2one',async function(assert){assert.expect(4);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="product_id"/></form>',archs:{'product,false,form':'<form><field name="name"/></form>',},mockRPC(route,args){if(args.method==='name_create'){return Promise.reject();}
if(args.method==='create'){assert.deepEqual(args.args[0],{name:'xyz'});}
return this._super(...arguments);},});await testUtils.fields.many2one.searchAndClickItem('product_id',{search:'abcd',item:'Create "abcd"',});assert.containsOnce(document.body,'.modal .o_form_view');assert.strictEqual($('.o_field_widget[name=name]').val(),'abcd');await testUtils.fields.editInput($('.modal .o_field_widget[name=name]'),'xyz');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'xyz');form.destroy();});QUnit.test('failing quick create on a many2one inside a one2many',async function(assert){assert.expect(4);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="p"/></form>',archs:{'partner,false,list':'<tree editable="bottom"><field name="product_id"/></tree>','product,false,form':'<form><field name="name"/></form>',},mockRPC(route,args){if(args.method==='name_create'){return Promise.reject();}
if(args.method==='create'){assert.deepEqual(args.args[0],{name:'xyz'});}
return this._super(...arguments);},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.many2one.searchAndClickItem('product_id',{search:'abcd',item:'Create "abcd"',});assert.containsOnce(document.body,'.modal .o_form_view');assert.strictEqual($('.o_field_widget[name=name]').val(),'abcd');await testUtils.fields.editInput($('.modal .o_field_widget[name=name]'),'xyz');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'xyz');form.destroy();});QUnit.test('slow create on a many2one',async function(assert){assert.expect(11);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="product_id" options="{\'quick_create\': False}"/>'+'</sheet>'+'</form>',archs:{'product,false,form':'<form>'+'<field name="name"/>'+'</form>',},});form.$('.o_field_many2one input').focus().val('new product').trigger('keyup').trigger('blur');await testUtils.nextTick();assert.strictEqual($('.modal').length,1,"there should be one opened modal");await testUtils.dom.click($('.modal .modal-footer .btn:contains(Cancel)'));assert.strictEqual($('.modal').length,0,"the modal should be closed");assert.strictEqual(form.$('.o_field_many2one input').val(),"",'the many2one should not set a value as its creation has been cancelled (with Cancel button)');await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'new product',['keyup','blur']);assert.strictEqual($('.modal').length,1,"there should be one opened modal");await testUtils.dom.click($('.modal .modal-header button'));assert.strictEqual(form.$('.o_field_many2one input').val(),"",'the many2one should not set a value as its creation has been cancelled (with Close button)');assert.strictEqual($('.modal').length,0,"the modal should be closed");await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickItem('product_id','o');assert.strictEqual(form.$('.o_field_many2one input').val(),"xphone","should have selected xphone");form.$('.o_field_many2one input').focus().val('new product').trigger('keyup').trigger('blur');await testUtils.nextTick();assert.strictEqual($('.modal').length,1,"there should be one opened modal");await testUtils.dom.click($('.modal .modal-footer .btn:contains(Cancel)'));assert.strictEqual(form.$('.o_field_many2one input').val(),"xphone",'should have restored the many2one with its previous selected value (xphone)');form.$('.o_field_many2one input').focus().val('new partner').trigger('keyup').trigger('blur');await testUtils.nextTick();assert.strictEqual($('.modal').length,1,"there should be one opened modal");await testUtils.dom.click($('.modal .modal-footer .btn-primary:contains(Create and edit)'));await testUtils.nextTick();assert.strictEqual($('.modal .o_form_view').length,1,'a new modal should be opened and contain a form view');await testUtils.dom.click($('.modal .o_form_button_cancel'));form.destroy();});QUnit.test('no_create option on a many2one',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id" options="{\'no_create\': True}"/>'+'</sheet>'+'</form>',});await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'new partner',['keyup','focusout']);await testUtils.nextTick();assert.strictEqual($('.modal').length,0,"should not display the create modal");form.destroy();});QUnit.test('can_create and can_write option on a many2one',async function(assert){assert.expect(5);this.data.product.options={can_create:"false",can_write:"false",};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id" can_create="false" can_write="false"/>'+'</sheet>'+'</form>',archs:{'product,false,form':'<form string="Products"><field name="display_name"/></form>',},mockRPC:function(route){if(route==='/web/dataset/call_kw/product/get_formview_id'){return Promise.resolve(false);}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_many2one input'));assert.strictEqual($('.ui-autocomplete .o_m2o_dropdown_option:contains(Create)').length,0,"there shouldn't be any option to search and create");await testUtils.dom.click($('.ui-autocomplete li:contains(xpad)').mouseenter());assert.strictEqual(form.$('.o_field_many2one input').val(),"xpad","the correct record should be selected");assert.containsOnce(form,'.o_field_many2one .o_external_button',"there should be an external button displayed");await testUtils.dom.click(form.$('.o_field_many2one .o_external_button'));assert.strictEqual($('.modal .o_form_view.o_form_readonly').length,1,"there should be a readonly form view opened");await testUtils.dom.click($('.modal .o_form_button_cancel'));await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'new product',['keyup','focusout']);assert.strictEqual($('.modal').length,0,"should not display the create modal");form.destroy();});QUnit.test('pressing enter in a m2o in an editable list',async function(assert){assert.expect(9);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="product_id"/></tree>',});await testUtils.dom.click(list.$('td.o_data_cell:first'));assert.containsOnce(list,'.o_selected_row',"should have a row in edit mode");await testUtils.fields.editInput(list.$('td.o_data_cell input:first'),'a');var $input=list.$('td.o_data_cell input:first');var $dropdown=$input.autocomplete('widget');assert.ok($dropdown.is(':visible'),"autocomplete dropdown should be visible");await testUtils.fields.triggerKeydown($input,'enter');assert.strictEqual($input[0],document.activeElement,"input should still be focused");await testUtils.fields.triggerKeydown($input,'enter');assert.notOk(document.contains($input[0]),"input should no longer be in dom");assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row',"second row should now be selected");await testUtils.fields.editInput(list.$('td.o_data_cell input:first'),'a');var $input=list.$('td.o_data_cell input:first');var $dropdown=$input.autocomplete('widget');assert.ok($dropdown.is(':visible'),"autocomplete dropdown should be visible");await testUtils.fields.triggerKeydown($input,'tab');assert.strictEqual($input[0],document.activeElement,"input should still be focused");await testUtils.fields.triggerKeydown($input,'tab');assert.notOk(document.contains($input[0]),"input should no longer be in dom");assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row',"third row should now be selected");list.destroy();relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;});QUnit.test('pressing ENTER on a \'no_quick_create\' many2one should open a M2ODialog',async function(assert){assert.expect(2);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="trululu" options="{\'no_quick_create\': True}"/>'+'<field name="foo"/>'+'</form>',archs:{'partner,false,form':'<form string="Partners"><field name="display_name"/></form>',},});var $input=form.$('.o_field_many2one input');await testUtils.fields.editInput($input,"Something that does not exist");$('.ui-autocomplete .ui-menu-item a:contains(Create and)').trigger('mouseenter');await testUtils.nextTick();await testUtils.fields.triggerKey('down',$input,'enter')
await testUtils.fields.triggerKey('press',$input,'enter')
await testUtils.fields.triggerKey('up',$input,'enter')
$input.blur();assert.strictEqual($('.modal').length,1,"should have one modal in body");await testUtils.dom.click($('.modal .o_form_button_cancel'));assert.strictEqual($input.val(),'',"the field should be empty");form.destroy();relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;});QUnit.test('select a value by pressing TAB on a many2one with onchange',async function(assert){assert.expect(3);this.data.partner.onchanges.trululu=function(){};var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;var prom=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="trululu"/>'+'<field name="display_name"/>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return prom.then(_.constant(result));}
return result;},res_id:1,viewOptions:{mode:'edit',},});var $input=form.$('.o_field_many2one input');await testUtils.fields.editInput($input,"first");await testUtils.fields.triggerKey('down',$input,'tab');await testUtils.fields.triggerKey('press',$input,'tab');await testUtils.fields.triggerKey('up',$input,'tab');form.$('.o_field_char').focus();assert.strictEqual($('.modal').length,0,"there shouldn't be any modal in body");prom.resolve();await testUtils.nextTick();assert.strictEqual($input.val(),'first record',"first record should have been selected");assert.strictEqual($('.modal').length,0,"there shouldn't be any modal in body");relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('many2one in editable list + onchange, with enter [REQUIRE FOCUS]',async function(assert){assert.expect(6);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;this.data.partner.onchanges.product_id=function(obj){obj.int_field=obj.product_id||0;};var prom=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="product_id"/><field name="int_field"/></tree>',mockRPC:function(route,args){if(args.method){assert.step(args.method);}
var result=this._super.apply(this,arguments);if(args.method==='onchange'){return prom.then(_.constant(result));}
return result;},});await testUtils.dom.click(list.$('td.o_data_cell:first'));await testUtils.fields.editInput(list.$('td.o_data_cell input:first'),'a');var $input=list.$('td.o_data_cell input:first');await testUtils.fields.triggerKeydown($input,'enter');await testUtils.fields.triggerKey('up',$input,'enter');prom.resolve();await testUtils.nextTick();await testUtils.fields.triggerKeydown($input,'enter');assert.strictEqual($('.modal').length,0,"should not have any modal in DOM");assert.verifySteps(['name_search','onchange','write','read']);list.destroy();relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;});QUnit.test('many2one in editable list + onchange, with enter, part 2 [REQUIRE FOCUS]',async function(assert){assert.expect(6);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;this.data.partner.onchanges.product_id=function(obj){obj.int_field=obj.product_id||0;};var prom=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree editable="bottom"><field name="product_id"/><field name="int_field"/></tree>',mockRPC:function(route,args){if(args.method){assert.step(args.method);}
var result=this._super.apply(this,arguments);if(args.method==='onchange'){return prom.then(_.constant(result));}
return result;},});await testUtils.dom.click(list.$('td.o_data_cell:first'));await testUtils.fields.editInput(list.$('td.o_data_cell input:first'),'a');var $input=list.$('td.o_data_cell input:first');await testUtils.fields.triggerKeydown($input,'enter');await testUtils.fields.triggerKey('up',$input,'enter');await testUtils.fields.triggerKeydown($input,'enter');prom.resolve();await testUtils.nextTick();assert.strictEqual($('.modal').length,0,"should not have any modal in DOM");assert.verifySteps(['name_search','onchange','write','read']);list.destroy();relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;});QUnit.test('many2one: domain updated by an onchange',async function(assert){assert.expect(2);this.data.partner.onchanges={int_field:function(){},};var domain=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="int_field"/>'+'<field name="trululu"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){domain=[['id','in',[10]]];return Promise.resolve({domain:{trululu:domain,unexisting_field:domain,}});}
if(args.method==='name_search'){assert.deepEqual(args.kwargs.args,domain,"sent domain should be correct");}
return this._super(route,args);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));await testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),2);await testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));form.destroy();});QUnit.test('many2one in one2many: domain updated by an onchange',async function(assert){assert.expect(3);this.data.partner.onchanges={trululu:function(){},};var domain=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({domain:{trululu:domain,},});}
if(args.method==='name_search'){assert.deepEqual(args.kwargs.args,domain,"sent domain should be correct");}
return this._super(route,args);},viewOptions:{mode:'edit',},});domain=[['id','in',[10]]];await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));domain=[['id','in',[5]]];await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));domain=[['id','in',[10]]];await testUtils.dom.click(form.$('.o_data_row:first .o_data_cell'));await testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));form.destroy();});QUnit.test('search more in many2one: no text in input',async function(assert){assert.expect(6);for(var i=0;i<8;i++){this.data.partner.records.push({id:100+i,display_name:'test_'+i});}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="trululu"/></form>',archs:{'partner,false,list':'<list><field name="display_name"/></list>','partner,false,search':'<search></search>',},mockRPC:function(route,args){assert.step(args.method||route);if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,[],"should not preselect ids as there as nothing in the m2o input");}
return this._super.apply(this,arguments);},});await testUtils.fields.many2one.searchAndClickItem('trululu',{item:'Search More',search:'',});assert.verifySteps(['onchange','name_search','load_views','/web/dataset/search_read',]);form.destroy();});QUnit.test('search more in many2one: text in input',async function(assert){assert.expect(12);for(var i=0;i<8;i++){this.data.partner.records.push({id:100+i,display_name:'test_'+i});}
var expectedDomain;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="trululu"/></form>',archs:{'partner,false,list':'<list><field name="display_name"/></list>','partner,false,search':'<search></search>',},mockRPC:function(route,args){assert.step(args.method||route);if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,expectedDomain);}
return this._super.apply(this,arguments);},});expectedDomain=[['id','in',[100,101,102,103,104,105,106,107]]];await testUtils.fields.many2one.searchAndClickItem('trululu',{item:'Search More',search:'test',});assert.containsOnce(document.body,'.modal .o_list_view');assert.containsOnce(document.body,'.modal .o_cp_searchview .o_facet_values',"should have a special facet for the pre-selected ids");expectedDomain=[];await testUtils.dom.click($('.modal .o_cp_searchview .o_facet_remove'));assert.verifySteps(['onchange','name_search','name_search','name_search','load_views','/web/dataset/search_read','/web/dataset/search_read',]);form.destroy();});QUnit.test('search more in many2one: dropdown click',async function(assert){assert.expect(8);for(let i=0;i<8;i++){this.data.partner.records.push({id:100+i,display_name:'test_'+i});}
const $fakeDialog=$(`<div>
                <div class="pouet">
                    <div class="modal"></div>
                </div>
            </div>`);$('body').append($fakeDialog);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="trululu"/></form>',archs:{'partner,false,list':'<list><field name="display_name"/></list>','partner,false,search':'<search></search>',},});await testUtils.fields.many2one.searchAndClickItem('trululu',{item:'Search More',search:'test',});let filterMenuCss='.o_search_options > .o_filter_menu';let groupByMenuCss='.o_search_options > .o_group_by_menu';await testUtils.dom.click(document.querySelector(`${filterMenuCss} > .o_dropdown_toggler_btn`));assert.hasClass(document.querySelector(filterMenuCss),'show');assert.isVisible(document.querySelector(`${filterMenuCss} > .dropdown-menu`),"the filter dropdown menu should be visible");assert.doesNotHaveClass(document.querySelector(groupByMenuCss),'show');assert.isNotVisible(document.querySelector(`${groupByMenuCss} > .dropdown-menu`),"the Group by dropdown menu should be not visible");await testUtils.dom.click(document.querySelector(`${groupByMenuCss} > .o_dropdown_toggler_btn`));assert.hasClass(document.querySelector(groupByMenuCss),'show');assert.isVisible(document.querySelector(`${groupByMenuCss} > .dropdown-menu`),"the group by dropdown menu should be visible");assert.doesNotHaveClass(document.querySelector(filterMenuCss),'show');assert.isNotVisible(document.querySelector(`${filterMenuCss} > .dropdown-menu`),"the filter dropdown menu should be not visible");$fakeDialog.remove();form.destroy();});QUnit.test('updating a many2one from a many2many',async function(assert){assert.expect(4);this.data.turtle.records[1].turtle_trululu=1;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="turtle_trululu"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,archs:{'partner,false,form':'<form string="Trululu"><field name="display_name"/></form>',},mockRPC:function(route,args){if(args.method==='get_formview_id'){assert.deepEqual(args.args[0],[1],"should call get_formview_id with correct id");return Promise.resolve(false);}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_row td:contains(first record)'));await testUtils.dom.click(form.$('.o_external_button'));assert.strictEqual($('.modal').length,1,"should have one modal in body");await testUtils.fields.editInput($('.modal input[name="display_name"]'),'test');await testUtils.dom.click($('.modal button.btn-primary'));assert.strictEqual($('.modal').length,0,"the modal should be closed");assert.equal(form.$('.o_data_cell:contains(test)').text(),'test',"the partner name should have been updated to 'test'");form.destroy();});QUnit.test('search more in many2one: resequence inside dialog',async function(assert){assert.expect(10);this.data.partner.fields.sequence={string:'Sequence',type:'integer'};for(var i=0;i<8;i++){this.data.partner.records.push({id:100+i,display_name:'test_'+i});}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="trululu"/></form>',archs:{'partner,false,list':'<list>'+'<field name="sequence" widget="handle"/>'+'<field name="display_name"/>'+'</list>','partner,false,search':'<search></search>',},mockRPC:function(route,args){assert.step(args.method||route);if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,[],"should not preselect ids as there as nothing in the m2o input");}
return this._super.apply(this,arguments);},});await testUtils.fields.many2one.searchAndClickItem('trululu',{item:'Search More',search:'',});var $modal=$('.modal');assert.equal($modal.length,1,'There should be 1 modal opened');var $handles=$modal.find('.ui-sortable-handle');assert.equal($handles.length,11,'There should be 11 sequence handlers');await testUtils.dom.dragAndDrop($handles.eq(1),$modal.find('tbody tr').first(),{position:'top'});assert.verifySteps(['onchange','name_search','load_views','/web/dataset/search_read','/web/dataset/resequence','read',]);form.destroy();});QUnit.test('many2one dropdown disappears on scroll',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div style="height: 2000px;">'+'<field name="trululu"/>'+'</div>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);var $input=form.$('.o_field_many2one input');await testUtils.dom.click($input);assert.isVisible($input.autocomplete('widget'),"dropdown should be opened");form.el.dispatchEvent(new Event('scroll'));assert.isNotVisible($input.autocomplete('widget'),"dropdown should be closed");form.destroy();});QUnit.test('x2many list sorted by many2one',async function(assert){assert.expect(3);this.data.partner.records[0].p=[1,2,4];this.data.partner.fields.trululu.sortable=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree>'+'<field name="id"/>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_data_row .o_list_number').text(),'124',"should have correct order initially");await testUtils.dom.click(form.$('.o_list_view thead th:nth(1)'));assert.strictEqual(form.$('.o_data_row .o_list_number').text(),'412',"should have correct order (ASC)");await testUtils.dom.click(form.$('.o_list_view thead th:nth(1)'));assert.strictEqual(form.$('.o_data_row .o_list_number').text(),'214',"should have correct order (DESC)");form.destroy();});QUnit.test('one2many with extra field from server not in form',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p" >'+'<tree>'+'<field name="datetime"/>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{'partner,false,form':'<form>'+'<field name="display_name"/>'+'</form>'},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){args.args[1].p[0][2].datetime='2018-04-05 12:00:00';}
return this._super.apply(this,arguments);}});await testUtils.form.clickEdit(form);var x2mList=form.$('.o_field_x2many_list[name=p]');await testUtils.dom.click(x2mList.find('.o_field_x2many_list_row_add a'));var modal=$('.modal-lg');var nameInput=modal.find('input.o_input[name=display_name]');await testUtils.fields.editInput(nameInput,'michelangelo');await testUtils.dom.click(modal.find('.btn-primary').first());assert.equal(x2mList.find('.o_data_row').length,1,'There should be 1 records in the x2m list');var newlyAdded=x2mList.find('.o_data_row').eq(0);assert.equal(newlyAdded.find('.o_data_cell').first().text(),'','The create_date field should be empty');assert.equal(newlyAdded.find('.o_data_cell').eq(1).text(),'michelangelo','The display name field should have the right value');await testUtils.form.clickSave(form);x2mList=form.$('.o_field_x2many_list[name=p]');assert.equal(x2mList.find('.o_data_row').length,1,'There should be 1 records in the x2m list');newlyAdded=x2mList.find('.o_data_row').eq(0);assert.equal(newlyAdded.find('.o_data_cell').first().text(),'04/05/2018 12:00:00','The create_date field should have the right value');assert.equal(newlyAdded.find('.o_data_cell').eq(1).text(),'michelangelo','The display name field should have the right value');form.destroy();});QUnit.test('one2many with extra field from server not in (inline) form',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p" >'+'<tree>'+'<field name="datetime"/>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});var x2mList=form.$('.o_field_x2many_list[name=p]');await testUtils.dom.click(x2mList.find('.o_field_x2many_list_row_add a'));var modal=$('.modal-lg');var nameInput=modal.find('input.o_input[name=display_name]');await testUtils.fields.editInput(nameInput,'michelangelo');await testUtils.dom.click(modal.find('.btn-primary').first());assert.equal(x2mList.find('.o_data_row').length,1,'There should be 1 records in the x2m list');form.destroy();});QUnit.test('one2many with extra X2many field from server not in inline form',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p" >'+'<tree>'+'<field name="turtles"/>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});var x2mList=form.$('.o_field_x2many_list[name=p]');await testUtils.dom.click(x2mList.find('.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal-lg').find('.btn-primary').eq(1));await testUtils.dom.click($('.modal-lg').find('.btn-primary').eq(0));assert.equal(x2mList.find('.o_data_row').length,2,'There should be 2 records in the x2m list');form.destroy();});QUnit.test('one2many invisible depends on parent field',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="bar"/>'+'<field name="p">'+'<tree>'+'<field name="foo" attrs="{\'column_invisible\': [(\'parent.product_id\', \'!=\', False)]}"/>'+'<field name="bar" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.containsN(form,'th',2,"should be 2 columns in the one2many");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_many2one[name="product_id"] input'));await testUtils.dom.click($('li.ui-menu-item a:contains(xpad)').trigger('mouseenter'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column when the product_id is set");await testUtils.fields.editAndTrigger(form.$('.o_field_many2one[name="product_id"] input'),'','keyup');await testUtils.owlCompatibilityNextTick();assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns in the one2many when product_id is not set");await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column after the value change");form.destroy();});QUnit.test('one2many column visiblity depends on onchange of parent field',async function(assert){assert.expect(3);this.data.partner.records[0].p=[2];this.data.partner.records[0].bar=false;this.data.partner.onchanges.p=function(obj){if(obj.p.length>1&&obj.p[1][2].foo==='New line'){obj.bar=true;}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar"/>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="int_field" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.containsOnce(form,'th',"should be only 1 column ('foo') in the one2many");assert.containsOnce(form,'.o_list_view .o_data_row',"should contain one row");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.$('.o_field_one2many input:first').focus();await testUtils.fields.editInput(form.$('.o_field_one2many input:first'),'New line');await testUtils.dom.click(form.$el);assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns('foo' + 'int_field')");form.destroy();});QUnit.test('one2many column_invisible on view not inline',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="bar"/>'+'<field name="p"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,archs:{'partner,false,list':'<tree>'+'<field name="foo" attrs="{\'column_invisible\': [(\'parent.product_id\', \'!=\', False)]}"/>'+'<field name="bar" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>',},});assert.containsN(form,'th',2,"should be 2 columns in the one2many");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_many2one[name="product_id"] input'));await testUtils.dom.click($('li.ui-menu-item a:contains(xpad)').trigger('mouseenter'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column when the product_id is set");await testUtils.fields.editAndTrigger(form.$('.o_field_many2one[name="product_id"] input'),'','keyup');await testUtils.owlCompatibilityNextTick();assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns in the one2many when product_id is not set");await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column after the value change");form.destroy();});QUnit.module('Many2OneAvatar');QUnit.test('many2one_avatar widget in form view',async function(assert){assert.expect(10);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="user_id" widget="many2one_avatar"/></form>',res_id:1,});assert.hasClass(form.$('.o_form_view'),'o_form_readonly');assert.strictEqual(form.$('.o_field_widget[name=user_id]').text().trim(),'Aline');assert.containsOnce(form,'img.o_m2o_avatar[data-src="/web/image/user/17/image_128"]');await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.containsOnce(form,'.o_input_dropdown');assert.strictEqual(form.$('.o_input_dropdown input').val(),'Aline');assert.containsOnce(form,'.o_external_button');await testUtils.fields.many2one.clickOpenDropdown("user_id");await testUtils.fields.many2one.clickItem("user_id","Christine");await testUtils.form.clickSave(form);assert.hasClass(form.$('.o_form_view'),'o_form_readonly');assert.strictEqual(form.$('.o_field_widget[name=user_id]').text().trim(),'Christine');assert.containsOnce(form,'img.o_m2o_avatar[data-src="/web/image/user/19/image_128"]');form.destroy();});QUnit.test('many2one_avatar widget in form view, with onchange',async function(assert){assert.expect(7);this.data.partner.onchanges={int_field:function(obj){if(obj.int_field===1){obj.user_id=[19,'Christine'];}else if(obj.int_field===2){obj.user_id=false;}else{obj.user_id=[17,'Aline'];}},};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="int_field"/>
                        <field name="user_id" widget="many2one_avatar" readonly="1"/>
                    </form>`,});assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.strictEqual(form.$('.o_field_widget[name=user_id]').text().trim(),'Aline');assert.containsOnce(form,'img.o_m2o_avatar[data-src="/web/image/user/17/image_128"]');await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),1);assert.strictEqual(form.$('.o_field_widget[name=user_id]').text().trim(),'Christine');assert.containsOnce(form,'img.o_m2o_avatar[data-src="/web/image/user/19/image_128"]');await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),2);assert.strictEqual(form.$('.o_field_widget[name=user_id]').text().trim(),'');assert.containsNone(form,'img.o_m2o_avatar');form.destroy();});QUnit.test('many2one_avatar widget in list view',async function(assert){assert.expect(5);this.data.partner.records=[{id:1,user_id:17,},{id:2,user_id:19,},{id:3,user_id:17,},{id:4,user_id:false,},];const list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="user_id" widget="many2one_avatar"/></tree>',});assert.strictEqual(list.$('.o_data_cell span').text(),'AlineChristineAline');assert.containsOnce(list.$('.o_data_cell:nth(0)'),'img.o_m2o_avatar[data-src="/web/image/user/17/image_128"]');assert.containsOnce(list.$('.o_data_cell:nth(1)'),'img.o_m2o_avatar[data-src="/web/image/user/19/image_128"]');assert.containsOnce(list.$('.o_data_cell:nth(2)'),'img.o_m2o_avatar[data-src="/web/image/user/17/image_128"]');assert.containsNone(list.$('.o_data_cell:nth(3)'),'img.o_m2o_avatar');list.destroy();});});});});;

/* /web/static/tests/fields/relational_fields/field_one2many_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.field_one_to_many_tests',function(require){"use strict";var AbstractField=require('web.AbstractField');var AbstractStorageService=require('web.AbstractStorageService');const ControlPanel=require('web.ControlPanel');const fieldRegistry=require('web.field_registry');var FormView=require('web.FormView');var KanbanRecord=require('web.KanbanRecord');var ListRenderer=require('web.ListRenderer');var NotificationService=require('web.NotificationService');var RamStorage=require('web.RamStorage');var relationalFields=require('web.relational_fields');var testUtils=require('web.test_utils');var fieldUtils=require('web.field_utils');const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;const{FieldOne2Many}=relationalFields;QUnit.module('fields',{},function(){QUnit.module('relational_fields',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Displayed name",type:"char"},foo:{string:"Foo",type:"char",default:"My little Foo Value"},bar:{string:"Bar",type:"boolean",default:true},int_field:{string:"int_field",type:"integer",sortable:true},qux:{string:"Qux",type:"float",digits:[16,1]},p:{string:"one2many field",type:"one2many",relation:'partner',relation_field:'trululu'},turtles:{string:"one2many turtle field",type:"one2many",relation:'turtle',relation_field:'turtle_trululu'},trululu:{string:"Trululu",type:"many2one",relation:'partner'},timmy:{string:"pokemon",type:"many2many",relation:'partner_type'},product_id:{string:"Product",type:"many2one",relation:'product'},color:{type:"selection",selection:[['red',"Red"],['black',"Black"]],default:'red',string:"Color",},date:{string:"Some Date",type:"date"},datetime:{string:"Datetime Field",type:'datetime'},user_id:{string:"User",type:'many2one',relation:'user'},reference:{string:"Reference Field",type:'reference',selection:[["product","Product"],["partner_type","Partner Type"],["partner","Partner"]]},},records:[{id:1,display_name:"first record",bar:true,foo:"yop",int_field:10,qux:0.44,p:[],turtles:[2],timmy:[],trululu:4,user_id:17,reference:'product,37',},{id:2,display_name:"second record",bar:true,foo:"blip",int_field:9,qux:13,p:[],timmy:[],trululu:1,product_id:37,date:"2017-01-25",datetime:"2016-12-12 10:55:05",user_id:17,},{id:4,display_name:"aaa",bar:false,}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},partner_type:{fields:{name:{string:"Partner Type",type:"char"},color:{string:"Color index",type:"integer"},},records:[{id:12,display_name:"gold",color:2},{id:14,display_name:"silver",color:5},]},turtle:{fields:{display_name:{string:"Displayed name",type:"char"},turtle_foo:{string:"Foo",type:"char"},turtle_bar:{string:"Bar",type:"boolean",default:true},turtle_int:{string:"int",type:"integer",sortable:true},turtle_qux:{string:"Qux",type:"float",digits:[16,1],required:true,default:1.5},turtle_description:{string:"Description",type:"text"},turtle_trululu:{string:"Trululu",type:"many2one",relation:'partner'},turtle_ref:{string:"Reference",type:'reference',selection:[["product","Product"],["partner","Partner"]]},product_id:{string:"Product",type:"many2one",relation:'product',required:true},partner_ids:{string:"Partner",type:"many2many",relation:'partner'},},records:[{id:1,display_name:"leonardo",turtle_bar:true,turtle_foo:"yop",partner_ids:[],},{id:2,display_name:"donatello",turtle_bar:true,turtle_foo:"blip",turtle_int:9,partner_ids:[2,4],},{id:3,display_name:"raphael",product_id:37,turtle_bar:false,turtle_foo:"kawa",turtle_int:21,turtle_qux:9.8,partner_ids:[],turtle_ref:'product,37',}],onchanges:{},},user:{fields:{name:{string:"Name",type:"char"},partner_ids:{string:"one2many partners field",type:"one2many",relation:'partner',relation_field:'user_id'},},records:[{id:17,name:"Aline",partner_ids:[1,2],},{id:19,name:"Christine",}]},};}},function(){QUnit.module('FieldOne2Many');QUnit.test('New record with a o2m also with 2 new records, ordered, and resequenced',async function(assert){assert.expect(2);this.data.partner.onchanges={foo:function(obj){obj.p=[[5],[0,0,{trululu:false}],[0,0,{trululu:false}],];}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" />'+'<field name="p">'+'<tree editable="bottom" default_order="int_field">'+'<field name="int_field" widget="handle"/>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</form>',viewOptions:{mode:'create',},mockRPC:function(route,args){assert.step(args.method+' '+args.model);return this._super(route,args);},});await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(1),form.$('tbody tr').first(),{position:'top'});assert.verifySteps(['onchange partner']);form.destroy();});QUnit.test('O2M List with pager, decoration and default_order: add and cancel adding',async function(assert){assert.expect(3);this.data.partner.records[0].p=[2,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom" limit="1" decoration-muted="foo != False" default_order="display_name">'+'<field name="foo" invisible="1"/>'+'<field name="display_name" />'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list .o_field_x2many_list_row_add a'));assert.containsN(form,'.o_field_x2many_list .o_data_row',2,'There should be 2 rows');var $expectedSelectedRow=form.$('.o_field_x2many_list .o_data_row').eq(1);var $actualSelectedRow=form.$('.o_selected_row');assert.equal($actualSelectedRow[0],$expectedSelectedRow[0],'The selected row should be the new one');await testUtils.fields.triggerKeydown($actualSelectedRow.find('input'),'escape');assert.containsOnce(form,'.o_field_x2many_list .o_data_row','There should be 1 row');form.destroy();});QUnit.test('O2M with parented m2o and domain on parent.m2o',async function(assert){assert.expect(4);this.data.turtle.fields.parent_id={string:"Parent",type:"many2one",relation:'turtle'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree>'+'<field name="parent_id" />'+'</tree>'+'</field>'+'</form>',archs:{'turtle,false,form':'<form><field name="parent_id" domain="[(\'id\', \'in\', parent.turtles)]"/></form>',},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/turtle/name_search'){assert.deepEqual(args.kwargs.args,[['id','in',[]]]);}
return this._super(route,args);},});await testUtils.dom.click(form.$('.o_field_x2many_list[name=turtles] .o_field_x2many_list_row_add a'));await testUtils.fields.many2one.createAndEdit('parent_id');var $modal=$('.modal-content');await testUtils.dom.click($modal.eq(1).find('.modal-footer .btn-primary').eq(0));await testUtils.dom.click($modal.eq(0).find('.modal-footer .btn-primary').eq(1));assert.containsOnce(form,'.o_data_row','The main record should have the new record in its o2m');$modal=$('.modal-content');await testUtils.dom.click($modal.find('.o_field_many2one input'));form.destroy();});QUnit.test('one2many list editable with cell readonly modifier',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];this.data.partner.records[1].turtles=[1,2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="turtles" invisible="1"/>'+'<field name="foo" attrs="{&quot;readonly&quot; : [(&quot;turtles&quot;, &quot;!=&quot;, [])] }"/>'+'<field name="qux" attrs="{&quot;readonly&quot; : [(&quot;turtles&quot;, &quot;!=&quot;, [])] }"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){assert.deepEqual(args.args[1].p[1][2],{foo:'ff',qux:99},'The right values should be written');}
return this._super(route,args);}});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));var $targetInput=$('.o_selected_row .o_input[name=foo]');assert.equal($targetInput[0],document.activeElement,'The first input of the line should have the focus');await testUtils.fields.editInput($targetInput,'f');await testUtils.fields.editInput($targetInput,$targetInput.val()+'f');assert.equal($targetInput[0],document.activeElement,'The first input of the line should still have the focus');await testUtils.fields.triggerKeydown($targetInput,'tab');var $secondTarget=$('.o_selected_row .o_input[name=qux]');assert.equal($secondTarget[0],document.activeElement,'The second input of the line should have the focus after the TAB press');await testUtils.fields.editInput($secondTarget,9);await testUtils.fields.editInput($secondTarget,$secondTarget.val()+9);await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many basic properties',async function(assert){assert.expect(6);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="Partner page">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,intercepts:{load_filters:function(event){throw new Error('Should not load filters');},},});assert.containsNone(form,'td.o_list_record_selector',"embedded one2many should not have a selector");assert.ok(!form.$('.o_field_x2many_list_row_add').length,"embedded one2many should not be editable");assert.ok(!form.$('td.o_list_record_remove').length,"embedded one2many records should not have a remove icon");await testUtils.form.clickEdit(form);assert.ok(form.$('.o_field_x2many_list_row_add').length,"embedded one2many should now be editable");assert.hasAttrValue(form.$('.o_field_x2many_list_row_add'),'colspan',"2","should have colspan 2 (one for field foo, one for being below remove icon)");assert.ok(form.$('td.o_list_record_remove').length,"embedded one2many records should have a remove icon");form.destroy();});QUnit.test('transferring class attributes in one2many sub fields',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo" class="hey"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.containsOnce(form,'td.hey','should have a td with the desired class');await testUtils.form.clickEdit(form);assert.containsOnce(form,'td.hey','should have a td with the desired class');await testUtils.dom.click(form.$('td.o_data_cell'));assert.containsOnce(form,'input[name="turtle_foo"].hey','should have an input with the desired class');form.destroy();});QUnit.test('one2many with date and datetime',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="Partner page">'+'<field name="p">'+'<tree>'+'<field name="date"/>'+'<field name="datetime"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,session:{getTZOffset:function(){return 120;},},});assert.strictEqual(form.$('td:eq(0)').text(),"01/25/2017","should have formatted the date");assert.strictEqual(form.$('td:eq(1)').text(),"12/12/2016 12:55:05","should have formatted the datetime");form.destroy();});QUnit.test('rendering with embedded one2many',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="P page">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.strictEqual(form.$('th:contains(Foo)').length,1,"embedded one2many should have a column titled according to foo");assert.strictEqual(form.$('td:contains(blip)').length,1,"embedded one2many should have a cell with relational value");form.destroy();});QUnit.test('use the limit attribute in arch (in field o2m inline tree view)',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="2">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.model==='turtle'){assert.deepEqual(args.args[0],[1,2],'should only load first 2 records');}
return this._super.apply(this,arguments);},});assert.containsN(form,'.o_data_row',2,'should display 2 data rows');form.destroy();});QUnit.test('use the limit attribute in arch (in field o2m non inline tree view)',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles"/>'+'</form>',archs:{'turtle,false,list':'<tree limit="2"><field name="turtle_foo"/></tree>',},res_id:1,mockRPC:function(route,args){if(args.model==='turtle'&&args.method==='read'){assert.deepEqual(args.args[0],[1,2],'should only load first 2 records');}
return this._super.apply(this,arguments);},});assert.containsN(form,'.o_data_row',2,'should display 2 data rows');form.destroy();});QUnit.test('one2many with default_order on view not inline',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="Turtles">'+'<field name="turtles"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',archs:{'turtle,false,list':'<tree default_order="turtle_foo">'+'<field name="turtle_int"/>'+'<field name="turtle_foo"/>'+'</tree>',},res_id:1,});assert.strictEqual(form.$('.o_field_one2many .o_list_view .o_data_row').text(),"9blip21kawa0yop","the default order should be correctly applied");form.destroy();});QUnit.test('embedded one2many with widget',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="P page">'+'<field name="p">'+'<tree>'+'<field name="int_field" widget="handle"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'span.o_row_handle',"should have 1 handles");form.destroy();});QUnit.test('embedded one2many with handle widget',async function(assert){assert.expect(10);var nbConfirmChange=0;testUtils.mock.patch(ListRenderer,{confirmChange:function(){nbConfirmChange++;return this._super.apply(this,arguments);},});this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="P page">'+'<field name="turtles">'+'<tree default_order="turtle_int">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});testUtils.mock.intercept(form,"field_changed",function(event){assert.step(event.data.changes.turtles.data.turtle_int.toString());},true);assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"yopblipkawa","should have the 3 rows in the correct order");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"yopblipkawa","should still have the 3 rows in the correct order");assert.strictEqual(nbConfirmChange,0,"should not have confirmed any change yet");await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(1),form.$('tbody tr').first(),{position:'top'});assert.strictEqual(nbConfirmChange,1,"should have confirmed changes only once");assert.verifySteps(["0","1"],"sequences values should be incremental starting from the previous minimum one");assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"blipyopkawa","should have the 3 rows in the new order");await testUtils.form.clickSave(form);assert.deepEqual(_.map(this.data.turtle.records,function(turtle){return _.pick(turtle,'id','turtle_foo','turtle_int');}),[{id:1,turtle_foo:"yop",turtle_int:1},{id:2,turtle_foo:"blip",turtle_int:0},{id:3,turtle_foo:"kawa",turtle_int:21}],"should have save the changed sequence");assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"blipyopkawa","should still have the 3 rows in the new order");testUtils.mock.unpatch(ListRenderer);form.destroy();});QUnit.test('onchange for embedded one2many in a one2many with a second page',async function(assert){assert.expect(1);this.data.turtle.fields.partner_ids.type='one2many';this.data.turtle.records[0].partner_ids=[1];this.data.partner.records[0].turtles=[1,2];this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5],[1,1,{turtle_foo:"hop",partner_ids:[[5],[4,1]],}],[1,2,{turtle_foo:"blip",partner_ids:[[5],[4,2],[4,4]],}],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="1">'+'<field name="turtle_foo"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){var expectedResultTurtles=[[1,1,{turtle_foo:"hop",}],[1,2,{partner_ids:[[4,2,false],[4,4,false]],turtle_foo:"blip",}],];assert.deepEqual(args.args[1].turtles,expectedResultTurtles,"the right values should be written");}
return this._super.apply(this,arguments);}});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_cell').eq(1));var $cell=form.$('.o_selected_row .o_input[name=turtle_foo]');await testUtils.fields.editSelect($cell,"hop");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('onchange for embedded one2many in a one2many updated by server',async function(assert){assert.expect(3);this.data.turtle.fields.partner_ids.type='one2many';this.data.partner.records[0].turtles=[2];this.data.turtle.records[1].partner_ids=[2];this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5],[1,2,{turtle_foo:"hop",partner_ids:[[5],[4,2],[4,4]],}],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){var expectedResultTurtles=[[1,2,{partner_ids:[[4,2,false],[4,4,false]],turtle_foo:"hop",}],];assert.deepEqual(args.args[1].turtles,expectedResultTurtles,'The right values should be written');}
return this._super.apply(this,arguments);},});assert.deepEqual(form.$('.o_data_cell.o_many2many_tags_cell').text().trim(),"second record","the partner_ids should be as specified at initialization");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_cell').eq(1));var $cell=form.$('.o_selected_row .o_input[name=turtle_foo]');await testUtils.fields.editSelect($cell,"hop");await testUtils.form.clickSave(form);assert.deepEqual(form.$('.o_data_cell.o_many2many_tags_cell').text().trim().split(/\s+/),["second","record","aaa"],'The partner_ids should have been updated');form.destroy();});QUnit.test('onchange for embedded one2many with handle widget',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[1,2,3];var partnerOnchange=0;this.data.partner.onchanges={turtles:function(){partnerOnchange++;},};var turtleOnchange=0;this.data.turtle.onchanges={turtle_int:function(){turtleOnchange++;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="P page">'+'<field name="turtles">'+'<tree default_order="turtle_int">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(1),form.$('tbody tr').first(),{position:'top'});assert.strictEqual(turtleOnchange,2,"should trigger one onchange per line updated");assert.strictEqual(partnerOnchange,1,"should trigger only one onchange on the parent");form.destroy();});QUnit.test('onchange for embedded one2many with handle widget using same sequence',async function(assert){assert.expect(4);this.data.turtle.records[0].turtle_int=1;this.data.turtle.records[1].turtle_int=1;this.data.turtle.records[2].turtle_int=1;this.data.partner.records[0].turtles=[1,2,3];var turtleOnchange=0;this.data.turtle.onchanges={turtle_int:function(){turtleOnchange++;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="P page">'+'<field name="turtles">'+'<tree default_order="turtle_int">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1].turtles,[[1,2,{"turtle_int":1}],[1,1,{"turtle_int":2}],[1,3,{"turtle_int":3}]],"should change all lines that have changed (the first one doesn't change because it has the same sequence)");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"yopblipkawa","should have the 3 rows in the correct order");await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(1),form.$('tbody tr').first(),{position:'top'});assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"blipyopkawa","should still have the 3 rows in the correct order");assert.strictEqual(turtleOnchange,3,"should update all lines");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('onchange (with command 5) for embedded one2many with handle widget',async function(assert){assert.expect(3);var ids=[];for(var i=10;i<50;i++){var id=10+i;ids.push(id);this.data.turtle.records.push({id:id,turtle_int:0,turtle_foo:"#"+id,});}
ids.push(1,2,3);this.data.partner.records[0].turtles=ids;this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5]].concat(obj.turtles);},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="turtles">'+'<tree editable="bottom" default_order="turtle_int">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"yopblipkawa","should have the 3 rows in the correct order");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:first td:first'));await testUtils.fields.editInput(form.$('.o_field_one2many .o_list_view tbody tr:first input:first'),'blurp');await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(2),form.$('.o_field_one2many tbody tr').eq(1),{position:'top'});assert.strictEqual(form.$('.o_data_cell').text(),"blurpkawablip","should display to record in 'turtle_int' order");await testUtils.form.clickSave(form);await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));assert.strictEqual(form.$('.o_data_cell:not(.o_handle_cell)').text(),"blurpkawablip","should display to record in 'turtle_int' order");form.destroy();});QUnit.test('onchange with modifiers for embedded one2many on the second page',async function(assert){assert.expect(7);var data=this.data;var ids=[];for(var i=10;i<60;i++){var id=10+i;ids.push(id);data.turtle.records.push({id:id,turtle_int:0,turtle_foo:"#"+id,});}
ids.push(1,2,3);data.partner.records[0].turtles=ids;data.partner.onchanges={turtles:function(obj){var turtles=[];turtles.unshift([5]);for(var k in obj.turtles){var change=obj.turtles[k];var record=_.findWhere(data.turtle.records,{id:change[1]});if(change[0]===1){_.extend(record,change[2]);}
turtles.push([1,record.id,record]);}
obj.turtles=turtles;},};var form=await createView({View:FormView,model:'partner',data:data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="turtles">'+'<tree editable="bottom" default_order="turtle_int" limit="10">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'<field name="turtle_qux" attrs="{\'readonly\': [(\'turtle_foo\', \'=\', False)]}"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.equal(form.$('.o_field_one2many .o_list_char').text(),"#20#21#22#23#24#25#26#27#28#29","should display the records in order");await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:first td:first'));await testUtils.fields.editInput(form.$('.o_field_one2many .o_list_view tbody tr:first input:first'),'blurp');await testUtils.form.clickDiscard(form);assert.equal(form.$('.o_field_one2many .o_list_char').text(),"blurp#21#22#23#24#25#26#27#28#29","should display the records in order with the changes");await testUtils.dom.click($('.modal .modal-footer button:first'));assert.equal(form.$('.o_field_one2many .o_list_char').text(),"#20#21#22#23#24#25#26#27#28#29","should cancel changes and display the records in order");await testUtils.form.clickEdit(form);await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(2),form.$('.o_field_one2many tbody tr').eq(1),{position:'top'});assert.equal(form.$('.o_field_one2many .o_list_char').text(),"#20#30#31#32#33#34#35#36#37#38","should display the records in order after resequence (display record with turtle_int=0)");await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(2),form.$('.o_field_one2many tbody tr').eq(1),{position:'top'});assert.equal(form.$('.o_field_one2many .o_list_char').text(),"#20#39#40#41#42#43#44#45#46#47","should display the records in order after resequence (display record with turtle_int=0)");await testUtils.form.clickDiscard(form);assert.equal(form.$('.o_field_one2many .o_list_char').text(),"#20#39#40#41#42#43#44#45#46#47","should display the records in order after resequence");await testUtils.dom.click($('.modal .modal-footer button:first'));assert.equal(form.$('.o_field_one2many .o_list_char').text(),"#20#21#22#23#24#25#26#27#28#29","should cancel changes and display the records in order");form.destroy();});QUnit.test('onchange followed by edition on the second page',async function(assert){assert.expect(12);var ids=[];for(var i=1;i<85;i++){var id=10+i;ids.push(id);this.data.turtle.records.push({id:id,turtle_int:id/3|0,turtle_foo:"#"+i,});}
ids.splice(41,0,1,2,3);this.data.partner.records[0].turtles=ids;this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5]].concat(obj.turtles);},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="turtles">'+'<tree editable="top" default_order="turtle_int">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:eq(1) td:first'));await testUtils.fields.editInput(form.$('.o_field_one2many .o_list_view tbody tr:eq(1) input:first'),'value 1');await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:eq(2) td:first'));await testUtils.fields.editInput(form.$('.o_field_one2many .o_list_view tbody tr:eq(2) input:first'),'value 2');assert.containsN(form,'.o_data_row',40,"should display 40 records");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(#39))').index(),0,"should display '#39' at the first line");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'.o_data_row',40,"should display 39 records and the create line");assert.containsOnce(form,'.o_data_row:first .o_field_char',"should display the create line in first position");assert.strictEqual(form.$('.o_data_row:first .o_field_char').val(),"","should an empty input");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(#39))').index(),1,"should display '#39' at the second line");await testUtils.fields.editInput(form.$('.o_data_row input:first'),'value 3');assert.containsOnce(form,'.o_data_row:first .o_field_char',"should display the create line in first position after onchange");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(#39))').index(),1,"should display '#39' at the second line after onchange");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'.o_data_row',40,"should display 39 records and the create line");assert.containsOnce(form,'.o_data_row:first .o_field_char',"should display the create line in first position");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(value 3))').index(),1,"should display the created line at the second position");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(#39))').index(),2,"should display '#39' at the third line");form.destroy();});QUnit.test('onchange followed by edition on the second page (part 2)',async function(assert){assert.expect(8);var ids=[];for(var i=1;i<85;i++){var id=10+i;ids.push(id);this.data.turtle.records.push({id:id,turtle_int:id/3|0,turtle_foo:"#"+i,});}
ids.splice(41,0,1,2,3);this.data.partner.records[0].turtles=ids;this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5]].concat(obj.turtles);},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="turtles">'+'<tree editable="bottom" default_order="turtle_int">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:eq(1) td:first'));await testUtils.fields.editInput(form.$('.o_field_one2many .o_list_view tbody tr:eq(1) input:first'),'value 1');await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:eq(2) td:first'));await testUtils.fields.editInput(form.$('.o_field_one2many .o_list_view tbody tr:eq(2) input:first'),'value 2');assert.containsN(form,'.o_data_row',40,"should display 40 records");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(#77))').index(),39,"should display '#77' at the last line");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'.o_data_row',41,"should display 41 records and the create line");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(#76))').index(),38,"should display '#76' at the penultimate line");assert.strictEqual(form.$('.o_data_row:has(.o_field_char)').index(),40,"should display the create line at the last position");await testUtils.fields.editInput(form.$('.o_data_row input:first'),'value 3');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'.o_data_row',42,"should display 42 records and the create line");assert.strictEqual(form.$('.o_data_row:has(.o_data_cell:contains(#76))').index(),38,"should display '#76' at the penultimate line");assert.strictEqual(form.$('.o_data_row:has(.o_field_char)').index(),41,"should display the create line at the last position");form.destroy();});QUnit.test('onchange returning a command 6 for an x2many',async function(assert){assert.expect(2);this.data.partner.onchanges={foo:function(obj){obj.turtles=[[6,false,[1,2,3]]];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_data_row',"there should be one record in the relation");await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'some value');assert.containsN(form,'.o_data_row',3,"there should be three records in the relation");form.destroy();});QUnit.test('x2many fields inside x2manys are fetched after an onchange',async function(assert){assert.expect(6);this.data.turtle.records[0].partner_ids=[1];this.data.partner.onchanges={foo:function(obj){obj.turtles=[[5],[4,1],[4,2],[4,3]];},};var checkRPC=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="foo"/>'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(checkRPC&&args.method==='read'&&args.model==='partner'){assert.deepEqual(args.args[1],['display_name'],"should only read the display_name for the m2m tags");assert.deepEqual(args.args[0],[1],"should only read the display_name of the unknown record");}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_data_row',"there should be one record in the relation");assert.strictEqual(form.$('.o_data_row .o_field_widget[name=partner_ids]').text().replace(/\s/g,''),'secondrecordaaa',"many2many_tags should be correctly displayed");checkRPC=true;await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'some value');assert.containsN(form,'.o_data_row',3,"there should be three records in the relation");assert.strictEqual(form.$('.o_data_row:first .o_field_widget[name=partner_ids]').text().trim(),'first record',"many2many_tags should be correctly displayed");form.destroy();});QUnit.test('reference fields inside x2manys are fetched after an onchange',async function(assert){assert.expect(5);this.data.turtle.records[1].turtle_ref='product,41';this.data.partner.onchanges={foo:function(obj){obj.turtles=[[5],[4,1],[4,2],[4,3]];},};var checkRPC=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group>'+'<field name="foo"/>'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'<field name="turtle_ref" class="ref_field"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(checkRPC&&args.method==='name_get'){assert.deepEqual(args.args[0],[37],"should only fetch the name_get of the unknown record");}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_data_row',"there should be one record in the relation");assert.strictEqual(form.$('.ref_field').text().trim(),'xpad',"reference field should be correctly displayed");checkRPC=true;await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'some value');assert.containsN(form,'.o_data_row',3,"there should be three records in the relation");assert.strictEqual(form.$('.ref_field').text().trim(),'xpadxphone',"reference fields should be correctly displayed");form.destroy();});QUnit.test('onchange on one2many containing x2many in form view',async function(assert){assert.expect(16);this.data.partner.onchanges={foo:function(obj){obj.turtles=[[0,false,{turtle_foo:'new record'}]];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'</tree>'+'<form>'+'<field name="partner_ids">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>'+'</field>'+'</form>',archs:{'partner,false,list':'<tree><field name="foo"/></tree>','partner,false,search':'<search></search>',},});assert.containsOnce(form,'.o_data_row',"the onchange should have created one record in the relation");await testUtils.dom.click(form.$('.o_data_row'));assert.strictEqual($('.modal').length,1,"should have opened a dialog");assert.strictEqual($('.modal .o_data_row').length,0,"there should be no record in the one2many in the dialog");await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));assert.strictEqual($('.modal').length,2,"should have opened a second dialog");await testUtils.dom.click($('.modal:nth(1) .o_list_view .o_data_cell:first'));assert.strictEqual($('.modal').length,1,"second dialog should be closed");assert.strictEqual($('.modal .o_data_row').length,1,"there should be one record in the one2many in the dialog");assert.containsNone($('.modal'),'.o_x2m_control_panel .o_pager','m2m pager should be hidden');await testUtils.dom.click($('.modal-footer .btn-primary:first'));assert.strictEqual($('.modal').length,0,"dialog should be closed");await testUtils.dom.click(form.$('.o_data_row'));assert.strictEqual($('.modal').length,1,"should have opened a dialog");assert.strictEqual($('.modal .o_data_row').length,1,"there should be one record in the one2many in the dialog");await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));assert.strictEqual($('.modal').length,2,"should have opened a second dialog");await testUtils.dom.click($('.modal:nth(1) .o_list_view .o_data_cell:first'));assert.strictEqual($('.modal').length,1,"second dialog should be closed");assert.strictEqual($('.modal .o_data_row').length,2,"there should be two records in the one2many in the dialog");await testUtils.dom.click($('.modal-footer .btn-secondary'));assert.strictEqual($('.modal').length,0,"dialog should be closed");await testUtils.dom.click(form.$('.o_data_row'));assert.strictEqual($('.modal').length,1,"should have opened a dialog");assert.strictEqual($('.modal .o_data_row').length,1,"there should be one record in the one2many in the dialog");form.destroy();});QUnit.test('onchange on one2many with x2many in list (no widget) and form view (list)',async function(assert){assert.expect(6);this.data.turtle.fields.turtle_foo.default="a default value";this.data.partner.onchanges={foo:function(obj){obj.p=[[0,false,{turtles:[[0,false,{turtle_foo:'hello'}]]}]];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="p">'+'<tree>'+'<field name="turtles"/>'+'</tree>'+'<form>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>'+'</field>'+'</form>',});assert.containsOnce(form,'.o_data_row',"the onchange should have created one record in the relation");await testUtils.dom.click(form.$('.o_data_row'));assert.containsOnce(document.body,'.modal',"should have opened a dialog");assert.containsOnce(document.body,'.modal .o_data_row');assert.strictEqual($('.modal .o_data_row').text(),'hello');await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));assert.containsN(document.body,'.modal .o_data_row',2);assert.strictEqual($('.modal .o_data_row:first .o_field_widget[name=turtle_foo]').val(),'a default value');form.destroy();});QUnit.test('onchange on one2many with x2many in list (many2many_tags) and form view (list)',async function(assert){assert.expect(6);this.data.turtle.fields.turtle_foo.default="a default value";this.data.partner.onchanges={foo:function(obj){obj.p=[[0,false,{turtles:[[0,false,{turtle_foo:'hello'}]]}]];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="p">'+'<tree>'+'<field name="turtles" widget="many2many_tags"/>'+'</tree>'+'<form>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>'+'</field>'+'</form>',debug:1,});assert.containsOnce(form,'.o_data_row',"the onchange should have created one record in the relation");await testUtils.dom.click(form.$('.o_data_row'));assert.containsOnce(document.body,'.modal',"should have opened a dialog");assert.containsOnce(document.body,'.modal .o_data_row');assert.strictEqual($('.modal .o_data_row').text(),'hello');await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));assert.containsN(document.body,'.modal .o_data_row',2);assert.strictEqual($('.modal .o_data_row:first .o_field_widget[name=turtle_foo]').val(),'a default value');form.destroy();});QUnit.test('embedded one2many with handle widget with minimum setValue calls',async function(assert){var done=assert.async();assert.expect(20);this.data.turtle.records[0].turtle_int=6;this.data.turtle.records.push({id:4,turtle_int:20,turtle_foo:"a1",},{id:5,turtle_int:9,turtle_foo:"a2",},{id:6,turtle_int:2,turtle_foo:"a3",},{id:7,turtle_int:11,turtle_foo:"a4",});this.data.partner.records[0].turtles=[1,2,3,4,5,6,7];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="P page">'+'<field name="turtles">'+'<tree default_order="turtle_int">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});testUtils.mock.intercept(form,"field_changed",function(event){assert.step(String(form.model.get(event.data.changes.turtles.id).res_id));},true);await testUtils.form.clickEdit(form);var positions=[[6,0,'top',['3','6','1','2','5','7','4']],[5,1,'top',['7','6','1','2','5']],[2,5,'center',['1','2','5','6']],];async function dragAndDrop(){var pos=positions.shift();await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(pos[0]),form.$('tbody tr').eq(pos[1]),{position:pos[2]});assert.verifySteps(pos[3],"sequences values should be apply from the begin index to the drop index");if(positions.length){setTimeout(dragAndDrop,10);}else{assert.deepEqual(_.pluck(form.model.get(form.handle).data.turtles.data,'data'),[{id:3,turtle_foo:"kawa",turtle_int:2},{id:7,turtle_foo:"a4",turtle_int:3},{id:1,turtle_foo:"yop",turtle_int:4},{id:2,turtle_foo:"blip",turtle_int:5},{id:5,turtle_foo:"a2",turtle_int:6},{id:6,turtle_foo:"a3",turtle_int:7},{id:4,turtle_foo:"a1",turtle_int:8}],"sequences must be apply correctly");form.destroy();done();}}
dragAndDrop();});QUnit.test('embedded one2many (editable list) with handle widget',async function(assert){assert.expect(8);this.data.partner.records[0].p=[1,2,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="P page">'+'<field name="p">'+'<tree editable="top">'+'<field name="int_field" widget="handle"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});testUtils.mock.intercept(form,"field_changed",function(event){assert.step(event.data.changes.p.data.int_field.toString());},true);assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"My little Foo Valueblipyop","should have the 3 rows in the correct order");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"My little Foo Valueblipyop","should still have the 3 rows in the correct order");await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(1),form.$('tbody tr').first(),{position:'top'});assert.verifySteps(["0","1"],"sequences values should be incremental starting from the previous minimum one");assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"blipMy little Foo Valueyop","should have the 3 rows in the new order");await testUtils.dom.click(form.$('tbody tr:first td:first'));assert.strictEqual(form.$('tbody tr:first td.o_data_cell:not(.o_handle_cell) input').val(),"blip","should edit the correct row");await testUtils.form.clickSave(form);assert.strictEqual(form.$('td.o_data_cell:not(.o_handle_cell)').text(),"blipMy little Foo Valueyop","should still have the 3 rows in the new order");form.destroy();});QUnit.test('one2many field when using the pager',async function(assert){assert.expect(13);var ids=[];for(var i=0;i<45;i++){var id=10+i;ids.push(id);this.data.partner.records.push({id:id,display_name:"relational record "+id,});}
this.data.partner.records[0].p=ids.slice(0,42);this.data.partner.records[1].p=ids.slice(42);var count=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<kanban>'+'<field name="display_name"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div><t t-esc="record.display_name"/></div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',viewOptions:{ids:[1,2],index:0,},mockRPC:function(){count++;return this._super.apply(this,arguments);},res_id:1,});assert.strictEqual(count,2,'two RPCs should have been done');assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'one2many kanban should contain 40 cards for record 1');await cpHelpers.pagerNext(form);assert.strictEqual(count,4,'two RPCs should have been done');assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,3,'one2many kanban should contain 3 cards for record 2');await cpHelpers.pagerPrevious(form);assert.strictEqual(count,6,'two RPCs should have been done');assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'one2many kanban should contain 40 cards for record 1');await testUtils.dom.click(form.$('.o_x2m_control_panel .o_pager_next'));assert.strictEqual(count,7,'one RPC should have been done');assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,2,'one2many kanban should contain 2 cards for record 1 at page 2');await cpHelpers.pagerNext(form);assert.strictEqual(count,9,'two RPCs should have been done');assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,3,'one2many kanban should contain 3 cards for record 2');await cpHelpers.pagerPrevious(form);assert.strictEqual(count,11,'two RPCs should have been done');await testUtils.dom.click(form.$('.o_x2m_control_panel .o_pager_next'));assert.strictEqual(count,12,'one RPC should have been done');assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,2,'one2many kanban should contain 2 cards for record 1 at page 2');form.destroy();});QUnit.test('edition of one2many field with pager',async function(assert){assert.expect(31);var ids=[];for(var i=0;i<45;i++){var id=10+i;ids.push(id);this.data.partner.records.push({id:id,display_name:"relational record "+id,});}
this.data.partner.records[0].p=ids;var saveCount=0;var checkRead=false;var readIDs;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<kanban>'+'<field name="display_name"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<a t-if="!read_only_mode" type="delete" class="fa fa-times float-right delete_icon"/>'+'<span><t t-esc="record.display_name.value"/></span>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',archs:{'partner,false,form':'<form><field name="display_name"/></form>',},mockRPC:function(route,args){if(args.method==='read'&&checkRead){readIDs=args.args[0];checkRead=false;}
if(args.method==='write'){saveCount++;var nbCommands=args.args[1].p.length;var nbLinkCommands=_.filter(args.args[1].p,function(command){return command[0]===4;}).length;switch(saveCount){case 1:assert.strictEqual(nbCommands,46,"should send 46 commands (one for each record)");assert.strictEqual(nbLinkCommands,45,"should send a LINK_TO command for each existing record");assert.deepEqual(args.args[1].p[45],[0,args.args[1].p[45][1],{display_name:'new record',}],"should sent a CREATE command for the new record");break;case 2:assert.strictEqual(nbCommands,46,"should send 46 commands");assert.strictEqual(nbLinkCommands,45,"should send a LINK_TO command for each existing record");assert.deepEqual(args.args[1].p[45],[2,10,false],"should sent a DELETE command for the deleted record");break;case 3:assert.strictEqual(nbCommands,47,"should send 47 commands");assert.strictEqual(nbLinkCommands,43,"should send a LINK_TO command for each existing record");assert.deepEqual(args.args[1].p[43],[0,args.args[1].p[43][1],{display_name:'new record page 1'}],"should sent correct CREATE command");assert.deepEqual(args.args[1].p[44],[0,args.args[1].p[44][1],{display_name:'new record page 2'}],"should sent correct CREATE command");assert.deepEqual(args.args[1].p[45],[2,11,false],"should sent correct DELETE command");assert.deepEqual(args.args[1].p[46],[2,52,false],"should sent correct DELETE command");break;}}
return this._super.apply(this,arguments);},res_id:1,});assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'there should be 40 records on page 1');assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'1-40 / 45',"pager range should be correct");checkRead=true;await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o-kanban-button-new'));await testUtils.fields.editInput($('.modal input'),'new record');await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual(readIDs,undefined,"should not have read any record");assert.strictEqual(form.$('span:contains(new record)').length,0,"new record should be on page 2");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'there should be 40 records on page 1');assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'1-40 / 46',"pager range should be correct");assert.strictEqual(form.$('.o_kanban_record:first span:contains(new record)').length,0,'new record should not be on page 1');await testUtils.form.clickSave(form);checkRead=true;await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_kanban_record:first span:contains(relational record 10)').length,1,'first record should be the one with id 10 (next checks rely on that)');await testUtils.dom.click(form.$('.delete_icon:first'));assert.deepEqual(readIDs,[50],"should have read a record (to display 40 records on page 1)");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,40,'there should be 40 records on page 1');assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'1-40 / 45',"pager range should be correct");await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);checkRead=true;readIDs=undefined;await testUtils.dom.click(form.$('.o-kanban-button-new'));await testUtils.fields.editInput($('.modal input'),'new record page 1');await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual(form.$('.o_kanban_record:first span:contains(relational record 11)').length,1,'first record should be the one with id 11 (next checks rely on that)');await testUtils.dom.click(form.$('.delete_icon:first'));assert.deepEqual(readIDs,[51],"should have read a record (to display 40 records on page 1)");await testUtils.dom.click(form.$('.o_x2m_control_panel .o_pager_next'));assert.strictEqual(form.$('.o_kanban_record:first span:contains(relational record 52)').length,1,'first record should be the one with id 52 (next checks rely on that)');checkRead=true;readIDs=undefined;await testUtils.dom.click(form.$('.delete_icon:first'));await testUtils.dom.click(form.$('.o-kanban-button-new'));await testUtils.fields.editInput($('.modal input'),'new record page 2');await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual(readIDs,undefined,"should not have read any record");assert.strictEqual(form.$('.o_kanban_record:not(".o_kanban_ghost")').length,5,'there should be 5 records on page 2');assert.strictEqual(form.$('.o_x2m_control_panel .o_pager_counter').text().trim(),'41-45 / 45',"pager range should be correct");assert.strictEqual(form.$('.o_kanban_record span:contains(new record page 1)').length,1,'new records should be on page 2');assert.strictEqual(form.$('.o_kanban_record span:contains(new record page 2)').length,1,'new records should be on page 2');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('edition of one2many field, with onchange and not inline sub view',async function(assert){assert.expect(2);this.data.turtle.onchanges.turtle_int=function(obj){obj.turtle_foo=String(obj.turtle_int);};this.data.partner.onchanges.turtles=function(){};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles"/>'+'</form>',archs:{'turtle,false,list':'<tree><field name="turtle_foo"/></tree>','turtle,false,form':'<form><group><field name="turtle_foo"/><field name="turtle_int"/></group></form>',},mockRPC:function(){return this._super.apply(this,arguments);},res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput($('input[name="turtle_int"]'),'5');await testUtils.dom.click($('.modal-footer button.btn-primary').first());assert.strictEqual(form.$('tbody tr:eq(1) td.o_data_cell').text(),'5','should display 5 in the foo field');await testUtils.dom.click(form.$('tbody tr:eq(1) td.o_data_cell'));await testUtils.fields.editInput($('input[name="turtle_int"]'),'3');await testUtils.dom.click($('.modal-footer button.btn-primary').first());assert.strictEqual(form.$('tbody tr:eq(1) td.o_data_cell').text(),'3','should now display 3 in the foo field');form.destroy();});QUnit.test('sorting one2many fields',async function(assert){assert.expect(4);this.data.partner.fields.foo.sortable=true;this.data.partner.records.push({id:23,foo:"abc"});this.data.partner.records.push({id:24,foo:"xyz"});this.data.partner.records.push({id:25,foo:"def"});this.data.partner.records[0].p=[23,24,25];var rpcCount=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(){rpcCount++;return this._super.apply(this,arguments);},});rpcCount=0;assert.ok(form.$('table tbody tr:eq(2) td:contains(def)').length,"the 3rd record is the one with 'def' value");form.renderer._render=function(){throw"should not render the whole form";};await testUtils.dom.click(form.$('table thead th:contains(Foo)'));assert.strictEqual(rpcCount,0,'sort should be in memory, no extra RPCs should have been done');assert.ok(form.$('table tbody tr:eq(2) td:contains(xyz)').length,"the 3rd record is the one with 'xyz' value");await testUtils.dom.click(form.$('table thead th:contains(Foo)'));assert.ok(form.$('table tbody tr:eq(2) td:contains(abc)').length,"the 3rd record is the one with 'abc' value");form.destroy();});QUnit.test('one2many list field edition',async function(assert){assert.expect(6);this.data.partner.records.push({id:3,display_name:"relational record 1",});this.data.partner.records[1].p=[3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:2,});assert.strictEqual(form.$('.o_field_one2many tbody td').first().text(),'relational record 1',"display name of first record in o2m list should be 'relational record 1'");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_one2many tbody td').first());assert.hasClass(form.$('.o_field_one2many tbody td').first().parent(),'o_selected_row',"first row of o2m should be in edition");await testUtils.fields.editInput(form.$('.o_field_one2many tbody td').first().find('input'),"new value");assert.hasClass(form.$('.o_field_one2many tbody td').first().parent(),'o_selected_row',"first row of o2m should still be in edition");await testUtils.dom.click(form.$el);assert.doesNotHaveClass(form.$('.o_field_one2many tbody td').first().parent(),'o_selected_row',"first row of o2m should be readonly again");await testUtils.form.clickDiscard(form);assert.strictEqual(form.$('.o_field_one2many tbody td').first().text(),'new value',"changes shouldn't have been discarded yet, waiting for user confirmation");await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_field_one2many tbody td').first().text(),'relational record 1',"display name of first record in o2m list should be 'relational record 1'");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_one2many tbody td').first());await testUtils.fields.editInput(form.$('.o_field_one2many tbody td').first().find('input'),"new value");await testUtils.dom.click(form.$el);await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many list: create action disabled',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree create="0">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.ok(!form.$('.o_field_x2many_list_row_add').length,'"Add an item" link should not be available in readonly');await testUtils.form.clickEdit(form);assert.ok(!form.$('.o_field_x2many_list_row_add').length,'"Add an item" link should not be available in readonly');form.destroy();});QUnit.test('one2many list: conditional create/delete actions',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2,4];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="bar"/>
                        <field name="p" options="{'create': [('bar', '=', True)], 'delete': [('bar', '=', True)]}">
                            <tree>
                                <field name="display_name"/>
                            </tree>
                        </field>
                    </form>`,res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_field_x2many_list_row_add','"Add an item" link should be available');assert.hasClass(form.$('td.o_list_record_remove button').first(),'fa fa-trash-o',"should have trash bin icons");await testUtils.dom.click(form.$('.o_field_widget[name="bar"] input').first());assert.containsNone(form,'.o_field_x2many_list_row_add','"Add an item" link should not be available if bar field is False');assert.containsNone(form,'td.o_list_record_remove button',"should not have trash bin icons if bar field is False");form.destroy();});QUnit.test('one2many list: unlink two records',async function(assert){assert.expect(8);this.data.partner.records[0].p=[1,2,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p" widget="many2many">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){var commands=args.args[1].p;assert.strictEqual(commands.length,3,'should have generated three commands');assert.ok(commands[0][0]===4&&commands[0][1]===2,'should have generated the command 4 (LINK_TO) with id 4');assert.ok(commands[1][0]===4&&commands[1][1]===4,'should have generated the command 4 (LINK_TO) with id 4');assert.ok(commands[2][0]===3&&commands[2][1]===1,'should have generated the command 3 (UNLINK) with id 1');}
return this._super.apply(this,arguments);},archs:{'partner,false,form':'<form string="Partner"><field name="display_name"/></form>',},});await testUtils.form.clickEdit(form);assert.containsN(form,'td.o_list_record_remove button',3,"should have 3 remove buttons");assert.hasClass(form.$('td.o_list_record_remove button').first(),'fa fa-times',"should have X icons to remove (unlink) records");await testUtils.dom.click(form.$('td.o_list_record_remove button').first());assert.containsN(form,'td.o_list_record_remove button',2,"should have 2 remove buttons (a record is supposed to have been unlinked)");await testUtils.dom.click(form.$('tr.o_data_row').first());assert.containsNone($('.modal .modal-footer .o_btn_remove'),'there should not be a modal having Remove Button');await testUtils.dom.click($('.modal .btn-secondary'))
await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many list: deleting one records',async function(assert){assert.expect(7);this.data.partner.records[0].p=[1,2,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){var commands=args.args[1].p;assert.strictEqual(commands.length,3,'should have generated three commands');assert.ok(commands[0][0]===4&&commands[0][1]===2,'should have generated the command 4 (LINK_TO) with id 2');assert.ok(commands[1][0]===4&&commands[1][1]===4,'should have generated the command 2 (LINK_TO) with id 1');assert.ok(commands[2][0]===2&&commands[2][1]===1,'should have generated the command 2 (DELETE) with id 2');}
return this._super.apply(this,arguments);},archs:{'partner,false,form':'<form string="Partner"><field name="display_name"/></form>',},});await testUtils.form.clickEdit(form);assert.containsN(form,'td.o_list_record_remove button',3,"should have 3 remove buttons");assert.hasClass(form.$('td.o_list_record_remove button').first(),'fa fa-trash-o',"should have trash bin icons to remove (delete) records");await testUtils.dom.click(form.$('td.o_list_record_remove button').first());assert.containsN(form,'td.o_list_record_remove button',2,"should have 2 remove buttons");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many kanban: edition',async function(assert){assert.expect(23);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<kanban>'+'<field name="color"/>'+'<field name="display_name"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<a t-if="!read_only_mode" type="delete" class="fa fa-times float-right delete_icon"/>'+'<span><t t-esc="record.display_name.value"/></span>'+'<span><t t-esc="record.color.value"/></span>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'<form string="Partners">'+'<field name="display_name"/>'+'<field name="foo"/>'+'</form>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){var commands=args.args[1].p;assert.strictEqual(commands.length,2,'should have generated two commands');assert.strictEqual(commands[0][0],0,'generated command should be ADD WITH VALUES');assert.strictEqual(commands[0][2].display_name,"new subrecord 3",'value of newly created subrecord should be "new subrecord 3"');assert.strictEqual(commands[1][0],2,'generated command should be REMOVE AND DELETE');assert.strictEqual(commands[1][1],2,'deleted record id should be 2');}
return this._super.apply(this,arguments);},});assert.ok(!form.$('.o_kanban_view .delete_icon').length,'delete icon should not be visible in readonly');assert.ok(!form.$('.o_field_one2many .o-kanban-button-new').length,'"Create" button should not be visible in readonly');await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,1,'should contain 1 record');assert.strictEqual(form.$('.o_kanban_record span:first').text(),'second record','display_name of subrecord should be the one in DB');assert.strictEqual(form.$('.o_kanban_record span:nth(1)').text(),'Red','color of subrecord should be the one in DB');assert.ok(form.$('.o_kanban_view .delete_icon').length,'delete icon should be visible in edit');assert.ok(form.$('.o_field_one2many .o-kanban-button-new').length,'"Create" button should be visible in edit');assert.hasClass(form.$('.o_field_one2many .o-kanban-button-new'),'btn-secondary',"'Create' button should have className 'btn-secondary'");assert.strictEqual(form.$('.o_field_one2many .o-kanban-button-new').text().trim(),"Add",'Create button should have "Add" label');await testUtils.dom.click(form.$('.oe_kanban_global_click'));await testUtils.fields.editInput($('.modal .o_form_view input').first(),'new name');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_kanban_record span:first').text(),'new name','value of subrecord should have been updated');await testUtils.dom.click(form.$('.o-kanban-button-new'));await testUtils.fields.editInput($('.modal .o_form_view input').first(),'new subrecord 1');await testUtils.dom.clickFirst($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,2,'should contain 2 records');assert.strictEqual(form.$('.o_kanban_record:nth(1) span').text(),'new subrecord 1Red','value of newly created subrecord should be "new subrecord 1"');await testUtils.dom.click(form.$('.o-kanban-button-new'));await testUtils.fields.editInput($('.modal .o_form_view input').first(),'new subrecord 2');await testUtils.dom.click($('.modal .modal-footer .btn-primary:nth(1)'));await testUtils.fields.editInput($('.modal .o_form_view input').first(),'new subrecord 3');await testUtils.dom.clickFirst($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,4,'should contain 4 records');await testUtils.dom.click(form.$('.oe_kanban_global_click').first());assert.strictEqual($('.modal .modal-footer .o_btn_remove').length,1,'There should be a modal having Remove Button');await testUtils.dom.click($('.modal .modal-footer .o_btn_remove'));assert.containsNone($('.o_modal'),"modal should have been closed");assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,3,'should contain 3 records');await testUtils.dom.click(form.$('.o_kanban_view .delete_icon:first()'));await testUtils.dom.click(form.$('.o_kanban_view .delete_icon:first()'));assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,1,'should contain 1 records');assert.strictEqual(form.$('.o_kanban_record span:first').text(),'new subrecord 3','the remaining subrecord should be "new subrecord 3"');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many kanban (editable): properly handle create_text node option',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles" options="{\'create_text\': \'Add turtle\'}" mode="kanban">'+'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_details">'+'<field name="display_name"/>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_one2many[name="turtles"] .o-kanban-button-new').text().trim(),"Add turtle","In O2M Kanban, Add button should have 'Add turtle' label");form.destroy();});QUnit.test('one2many kanban: create action disabled',async function(assert){assert.expect(3);this.data.partner.records[0].p=[4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<kanban create="0">'+'<field name="display_name"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<a t-if="!read_only_mode" type="delete" class="fa fa-times float-right delete_icon"/>'+'<span><t t-esc="record.display_name.value"/></span>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',res_id:1,});assert.ok(!form.$('.o-kanban-button-new').length,'"Add" button should not be available in readonly');await testUtils.form.clickEdit(form);assert.ok(!form.$('.o-kanban-button-new').length,'"Add" button should not be available in edit');assert.ok(form.$('.o_kanban_view .delete_icon').length,'delete icon should be visible in edit');form.destroy();});QUnit.test('one2many kanban: conditional create/delete actions',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2,4];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="bar"/>
                        <field name="p" options="{'create': [('bar', '=', True)], 'delete': [('bar', '=', True)]}">
                            <kanban>
                                <field name="display_name"/>
                                <templates>
                                    <t t-name="kanban-box">
                                        <div class="oe_kanban_global_click">
                                            <span><t t-esc="record.display_name.value"/></span>
                                        </div>
                                    </t>
                                </templates>
                            </kanban>
                            <form>
                                <field name="display_name"/>
                                <field name="foo"/>
                            </form>
                        </field>
                    </form>`,res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o-kanban-button-new','"Add" button should be available');await testUtils.dom.click(form.$('.oe_kanban_global_click').first());assert.containsOnce(document.body,'.modal .modal-footer .o_btn_remove','There should be a Remove Button inside modal');await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.dom.click(form.$('.o_field_widget[name="bar"] input').first());assert.containsNone(form,'.o-kanban-button-new','"Add" button should not be available as bar is False');await testUtils.dom.click(form.$('.oe_kanban_global_click').first());assert.containsNone(document.body,'.modal .modal-footer .o_btn_remove','There should not be a Remove Button as bar field is False');form.destroy();});QUnit.test('editable one2many list, pager is updated',async function(assert){assert.expect(1);this.data.turtle.records.push({id:4,turtle_foo:'stephen hawking'});this.data.partner.records[0].turtles=[1,2,3,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="3">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$el);assert.strictEqual(form.$('.o_field_widget[name=turtles] .o_pager').text().trim(),'1-4 / 5',"pager should display the correct total");form.destroy();});QUnit.test('one2many list (non editable): edition',async function(assert){assert.expect(12);var nbWrite=0;this.data.partner.records[0].p=[2,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="display_name"/><field name="qux"/>'+'</tree>'+'<form string="Partners">'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){nbWrite++;assert.deepEqual(args.args[1],{p:[[1,2,{display_name:'new name'}],[2,4,false]]},"should have sent the correct commands");}
return this._super.apply(this,arguments);},});assert.ok(!form.$('.o_list_record_remove').length,'remove icon should not be visible in readonly');assert.ok(!form.$('.o_field_x2many_list_row_add').length,'"Add an item" should not be visible in readonly');await testUtils.form.clickEdit(form);assert.containsN(form,'.o_list_view td.o_list_number',2,'should contain 2 records');assert.strictEqual(form.$('.o_list_view tbody td:first()').text(),'second record','display_name of first subrecord should be the one in DB');assert.ok(form.$('.o_list_record_remove').length,'remove icon should be visible in edit');assert.ok(form.$('.o_field_x2many_list_row_add').length,'"Add an item" should not visible in edit');await testUtils.dom.click(form.$('.o_list_view tbody tr:first() td:eq(1)'));await testUtils.fields.editInput($('.modal .o_form_view input'),'new name');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_list_view tbody td:first()').text(),'new name','value of subrecord should have been updated');assert.strictEqual(nbWrite,0,"should not have write anything in DB");await testUtils.dom.click(form.$('.o_list_record_remove:nth(1)'));assert.containsOnce(form,'.o_list_view td.o_list_number','should contain 1 subrecord');assert.strictEqual(form.$('.o_list_view tbody td:first()').text(),'new name','the remaining subrecord should be "new name"');await testUtils.form.clickSave(form);assert.strictEqual(nbWrite,1,"should have write the changes in DB");form.destroy();});QUnit.test('one2many list (editable): edition',async function(assert){assert.expect(7);this.data.partner.records[0].p=[2,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name"/><field name="qux"/>'+'</tree>'+'<form string="Partners">'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',res_id:1,});assert.ok(!form.$('.o_field_x2many_list_row_add').length,'"Add an item" link should not be available in readonly');await testUtils.dom.click(form.$('.o_list_view tbody td:first()'));assert.ok($('.modal .o_form_readonly').length,'in readonly, clicking on a subrecord should open it in readonly in a dialog');await testUtils.dom.click($('.modal .o_form_button_cancel'));await testUtils.form.clickEdit(form);assert.ok(form.$('.o_field_x2many_list_row_add').length,'"Add an item" link should be available in edit');await testUtils.dom.click(form.$('.o_list_view tbody td:first()'));assert.strictEqual($('.modal').length,0,'in edit, clicking on a subrecord should not open a dialog');assert.hasClass(form.$('.o_list_view tbody tr:first()'),'o_selected_row','first row should be in edition');await testUtils.fields.editInput(form.$('.o_list_view input:first()'),'new name');await testUtils.dom.click(form.$('.o_list_view tbody tr:nth(1) td:first'));assert.doesNotHaveClass(form.$('.o_list_view tbody tr:first'),'o_selected_row','first row should not be in edition anymore');assert.strictEqual(form.$('.o_list_view tbody td:first').text(),'new name','value of subrecord should have been updated');form.destroy();});QUnit.test('one2many list (editable): edition, part 2',async function(assert){assert.expect(8);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].p[0][0],0,"should send a 0 command for field p");assert.strictEqual(args.args[1].p[1][0],0,"should send a second 0 command for field p");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_selected_row > td input'),'kartoffel');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('td:contains(kartoffel)').length,1,"should have one td with the new value");assert.containsOnce(form,'.o_selected_row > td input',"should have one other new td");assert.containsN(form,'tr.o_data_row',2,"should have 2 data rows");await testUtils.fields.editInput(form.$('.o_selected_row > td input'),'gemuse');await testUtils.form.clickSave(form);assert.containsN(form,'tr.o_data_row',2,"should have 2 data rows");assert.strictEqual(form.$('td:contains(kartoffel)').length,1,"should have one td with the new value");assert.strictEqual(form.$('td:contains(gemuse)').length,1,"should have one td with the new value");form.destroy();});QUnit.test('one2many list (editable): edition, part 3',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,});assert.containsOnce(form,'tr.o_data_row',"should have 1 data rows");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'tr.o_data_row',3,"should have 3 data rows");await testUtils.form.clickDiscard(form);await testUtils.dom.click($('.modal-footer button.btn-primary').first());assert.containsOnce(form,'tr.o_data_row',"should have 1 data rows");form.destroy();});QUnit.test('one2many list (editable): edition, part 4',async function(assert){assert.expect(3);var i=0;this.data.turtle.onchanges={turtle_trululu:function(obj){if(i){obj.turtle_description="Some Description";}
i++;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_trululu"/>'+'<field name="turtle_description"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,});assert.containsNone(form,'tr.o_data_row',"should have 0 data rows");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('textarea').val(),"","field turtle_description should be empty");await testUtils.fields.many2one.clickOpenDropdown('turtle_trululu');await testUtils.fields.many2one.clickHighlightedItem('turtle_trululu');assert.strictEqual(form.$('textarea').val(),"Some Description","field turtle_description should be set to the result of the onchange");form.destroy();});QUnit.test('one2many list (editable): discarding required empty data',async function(assert){assert.expect(7);this.data.turtle.fields.turtle_foo.required=true;delete this.data.turtle.fields.turtle_foo.default;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method){assert.step(args.method);}
return this._super.apply(this,arguments);},});assert.containsNone(form,'tr.o_data_row',"should have 0 data rows");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('label.o_form_label').first());assert.containsNone(form,'tr.o_data_row',"should still have 0 data rows");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.form.clickSave(form);assert.containsNone(form,'tr.o_data_row',"should still have 0 data rows");assert.verifySteps(['read','onchange','onchange']);form.destroy();});QUnit.test('editable one2many list, adding line when only one page',async function(assert){assert.expect(5);this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="3">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsNone(form,'.o_field_widget[name=turtles] .o_pager');await testUtils.dom.click(form.$el);assert.containsNone(form,'.o_selected_row');assert.containsNone(form,'.o_field_widget[name=turtles] .o_pager');await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_field_widget[name=turtles] .o_pager');assert.strictEqual(form.$('.o_field_widget[name=turtles] .o_pager').text(),"1-3 / 4");form.destroy();});QUnit.test('editable one2many list, adding line, then discarding',async function(assert){assert.expect(2);this.data.turtle.records.push({id:4,turtle_foo:'stephen hawking'});this.data.partner.records[0].turtles=[1,2,3,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="3">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.form.clickDiscard(form);await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.isVisible(form.$('.o_field_widget[name=turtles] .o_pager'));assert.strictEqual(form.$('.o_field_widget[name=turtles] .o_pager').text().trim(),'1-3 / 4',"pager should display correct values");form.destroy();});QUnit.test('editable one2many list, required field and pager',async function(assert){assert.expect(1);this.data.turtle.records.push({id:4,turtle_foo:'stephen hawking'});this.data.turtle.fields.turtle_foo.required=true;this.data.partner.records[0].turtles=[1,2,3,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="3">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));assert.containsOnce(form,'tr.o_data_row');form.destroy();});QUnit.test('editable one2many list, required field, pager and confirm discard',async function(assert){assert.expect(3);this.data.turtle.records.push({id:4,turtle_foo:'stephen hawking'});this.data.turtle.fields.turtle_foo.required=true;this.data.partner.records[0].turtles=[1,2,3,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="3">'+'<field name="turtle_foo"/>'+'<field name="turtle_int"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('input[name="turtle_int"]'),4321);await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));assert.strictEqual(form.$('.o_field_widget[name=turtles] .o_pager').text().trim(),'1-4 / 5',"pager should still display the correct total");await testUtils.dom.click($('.modal .modal-footer .btn-secondary'));assert.strictEqual(form.$('.o_field_widget[name=turtles] .o_pager').text().trim(),'1-4 / 5',"pager should again display the correct total");assert.containsOnce(form,'.o_field_one2many input.o_field_invalid',"there should be an invalid input in the one2many");form.destroy();});QUnit.test('editable one2many list, adding, discarding, and pager',async function(assert){assert.expect(4);this.data.partner.records[0].turtles=[1];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="3">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'tr.o_data_row',5);assert.containsNone(form,'.o_field_widget[name=turtles] .o_pager');await testUtils.form.clickDiscard(form);await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.containsOnce(form,'tr.o_data_row');assert.containsNone(form,'.o_field_widget[name=turtles] .o_pager');form.destroy();});QUnit.test('unselecting a line with missing required data',async function(assert){assert.expect(5);this.data.turtle.fields.turtle_foo.required=true;delete this.data.turtle.fields.turtle_foo.default;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'<field name="turtle_int"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,});assert.containsNone(form,'tr.o_data_row',"should have 0 data rows");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(form,'tr.o_data_row',"should have 1 data rows");await testUtils.fields.editInput(form.$('input[name="turtle_int"]'),'12345');await testUtils.dom.click(form.$('label.o_form_label'));assert.strictEqual($('.modal').length,1,'a confirmation model should be opened');await testUtils.dom.click($('.modal .modal-footer button.btn-secondary'));assert.containsOnce(form,'tr.o_data_row.o_selected_row',"should still have 1 selected data row");await testUtils.dom.click(form.$('label.o_form_label'));await testUtils.dom.click($('.modal .modal-footer button.btn-primary'));assert.containsNone(form,'tr.o_data_row',"should have 0 data rows (invalid line has been discarded");form.destroy();});QUnit.test('pressing enter in a o2m with a required empty field',async function(assert){assert.expect(4);this.data.turtle.fields.turtle_foo.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.triggerKeydown(form.$('input[name="turtle_foo"]'),'enter');assert.hasClass(form.$('input[name="turtle_foo"]'),'o_field_invalid',"input should be marked invalid");assert.verifySteps(['read','onchange']);form.destroy();});QUnit.test('editing a o2m, with required field and onchange',async function(assert){assert.expect(11);this.data.turtle.fields.turtle_foo.required=true;delete this.data.turtle.fields.turtle_foo.default;this.data.turtle.onchanges={turtle_foo:function(obj){obj.turtle_int=obj.turtle_foo.length;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'<field name="turtle_int"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method){assert.step(args.method);}
return this._super.apply(this,arguments);},});assert.containsNone(form,'tr.o_data_row',"should have 0 data rows");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('input[name="turtle_foo"]'),'aubergine');assert.strictEqual(form.$('input[name="turtle_int"]').val(),"9","onchange should have been triggered");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_data_row td:contains(aubergine)').length,1,"should have one row with turtle_foo value");assert.strictEqual(form.$('.o_data_row td:contains(9)').length,1,"should have one row with turtle_int value");assert.verifySteps(['read','onchange','onchange','write','read','read']);form.destroy();});QUnit.test('editable o2m, pressing ESC discard current changes',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:2,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(form,'tr.o_data_row',"there should be one data row");await testUtils.fields.triggerKeydown(form.$('input[name="turtle_foo"]'),'escape');assert.containsNone(form,'tr.o_data_row',"data row should have been discarded");assert.verifySteps(['read','onchange']);form.destroy();});QUnit.test('editable o2m with required field, pressing ESC discard current changes',async function(assert){assert.expect(5);this.data.turtle.fields.turtle_foo.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:2,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(form,'tr.o_data_row',"there should be one data row");await testUtils.fields.triggerKeydown(form.$('input[name="turtle_foo"]'),'escape');assert.containsNone(form,'tr.o_data_row',"data row should have been discarded");assert.verifySteps(['read','onchange']);form.destroy();});QUnit.test('pressing escape in editable o2m list in dialog',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,archs:{"partner,false,form":'<form>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .o_data_row.o_selected_row').length,1,"there should be a row in edition in the dialog");await testUtils.fields.triggerKeydown($('.modal .o_data_cell input'),'escape');assert.strictEqual($('.modal').length,1,"dialog should still be open");assert.strictEqual($('.modal .o_data_row').length,0,"the row should have been removed");form.destroy();});QUnit.test('editable o2m with onchange and required field: delete an invalid line',async function(assert){assert.expect(5);this.data.partner.onchanges={turtles:function(){},};this.data.partner.records[0].turtles=[1];this.data.turtle.records[0].product_id=37;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="top">'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_data_cell:first'));form.$('.o_field_widget[name="product_id"] input').val('').trigger('keyup');assert.verifySteps(['read','read'],'no onchange should be done as line is invalid');await testUtils.dom.click(form.$('.o_list_record_remove'));assert.verifySteps(['onchange'],'onchange should have been done');form.destroy();});QUnit.test('onchange in a one2many',async function(assert){assert.expect(1);this.data.partner.records.push({id:3,foo:"relational record 1",});this.data.partner.records[1].p=[3];this.data.partner.onchanges={p:true};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{p:[[5],[0,0,{foo:"from onchange"}],]}});}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_one2many tbody td').first());await testUtils.fields.editInput(form.$('.o_field_one2many tbody td').first().find('input'),"new value");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_one2many tbody td').first().text(),'from onchange',"display name of first record in o2m list should be 'new value'");form.destroy();});QUnit.test('one2many, default_get and onchange (basic)',async function(assert){assert.expect(1);this.data.partner.fields.p.default=[[6,0,[]],];this.data.partner.onchanges={p:true};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{p:[[5],[0,0,{foo:"from onchange"}],]}});}
return this._super(route,args);},});assert.ok(form.$('td:contains(from onchange)').length,"should have 'from onchange' value in one2many");form.destroy();});QUnit.test('one2many and default_get (with date)',async function(assert){assert.expect(1);this.data.partner.fields.p.default=[[0,false,{date:'2017-10-08',p:[]}],];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="date"/>'+'</tree>'+'</field>'+'</form>',});assert.strictEqual(form.$('.o_data_cell').text(),'10/08/2017',"should correctly display the date");form.destroy();});QUnit.test('one2many and onchange (with integer)',async function(assert){assert.expect(4);this.data.turtle.onchanges={turtle_int:function(){}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_int"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('td:contains(9)'));await testUtils.fields.editInput(form.$('td input[name="turtle_int"]'),"3");form.$('td input[name="turtle_int"]').trigger('change');assert.verifySteps(['read','read','onchange']);form.destroy();});QUnit.test('one2many and onchange (with date)',async function(assert){assert.expect(7);this.data.partner.onchanges={date:function(){}};this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="date"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('td:contains(01/25/2017)'));await testUtils.dom.click(form.$('.o_datepicker_input'));await testUtils.nextTick();await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch').first());await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch:eq(1)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .year:contains(2017)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .month').eq(1));await testUtils.dom.click($('.day:contains(22)'));await testUtils.form.clickSave(form);assert.verifySteps(['read','read','onchange','write','read','read']);form.destroy();});QUnit.test('one2many and onchange (with command DELETE_ALL)',async function(assert){assert.expect(5);this.data.partner.onchanges={foo:function(obj){obj.p=[[5]];},p:function(){},};this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(method,args){if(args.method==='write'){assert.deepEqual(args.args[1].p,[[0,args.args[1].p[0][1],{display_name:'z'}],[2,2,false],],"correct commands should be sent");}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_data_row',"o2m should contain one row");await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'trigger onchange');assert.containsNone(form,'.o_data_row',"rows of the o2m should have been deleted");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'x');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'y');assert.containsN(form,'.o_data_row',2,"o2m should contain two rows");await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'trigger onchange again');assert.containsNone(form,'.o_data_row',"rows of the o2m should have been deleted");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'z');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many and onchange only write modified field',async function(assert){assert.expect(2);this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5],[1,3,{display_name:"coucou",product_id:[37,"xphone"],turtle_bar:false,turtle_foo:"has changed",turtle_int:42,turtle_qux:9.8,partner_ids:[],turtle_ref:'product,37',}],];},};this.data.partner.records[0].turtles=[3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="product_id"/>'+'<field name="turtle_bar"/>'+'<field name="turtle_foo"/>'+'<field name="turtle_int"/>'+'<field name="turtle_qux"/>'+'<field name="turtle_ref"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(method,args){if(args.method==='write'){assert.deepEqual(args.args[1].turtles,[[1,3,{display_name:'coucou',turtle_foo:'has changed',turtle_int:42}],],"correct commands should be sent (only send changed values)");}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_data_row',"o2m should contain one row");await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:first td:first'));await testUtils.fields.editInput(form.$('.o_field_one2many .o_list_view tbody tr:first input:first'),'blurp');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many with CREATE onchanges correctly refreshed',async function(assert){assert.expect(5);var delta=0;testUtils.mock.patch(AbstractField,{init:function(){delta++;this._super.apply(this,arguments);},destroy:function(){delta--;this._super.apply(this,arguments);},});var deactiveOnchange=true;this.data.partner.records[0].turtles=[];this.data.partner.onchanges={turtles:function(obj){if(deactiveOnchange){return;}
if(obj.turtles.length===1){obj.turtles=[[5],[0,obj.turtles[0][1],{display_name:"first",turtle_int:obj.turtles[0][2].turtle_int,}],[0,0,{display_name:"second",turtle_int:-obj.turtles[0][2].turtle_int,}],];}else if(obj.turtles.length===2){obj.turtles=[[5],[0,obj.turtles[0][1],{display_name:"first",turtle_int:obj.turtles[0][2].turtle_int,}],[0,obj.turtles[1][1],{display_name:"second",turtle_int:-obj.turtles[0][2].turtle_int,}],];}},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name" widget="char"/>'+'<field name="turtle_int"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.containsNone(form,'.o_data_row',"o2m shouldn't contain any row");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));deactiveOnchange=false;await testUtils.fields.editInput(form.$('input[name="turtle_int"]'),'10');await testUtils.dom.click(form.$('input[name="foo"]'));assert.strictEqual(form.$('.o_data_row').text(),"first10second-10","should correctly refresh the records");await testUtils.dom.click(form.$('.o_field_x2many_list tbody tr:first td:first'));await testUtils.fields.editInput(form.$('input[name="turtle_int"]'),'20');await testUtils.dom.click(form.$('input[name="foo"]'));assert.strictEqual(form.$('.o_data_row').text(),"first20second-20","should correctly refresh the records");assert.containsN(form,'.o_field_widget',delta,"all (non visible) field widgets should have been destroyed");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_data_row').text(),"first20second-20","should correctly refresh the records after save");form.destroy();testUtils.mock.unpatch(AbstractField);});QUnit.test('editable one2many with sub widgets are rendered in readonly',async function(assert){assert.expect(2);var editableWidgets=0;testUtils.mock.patch(AbstractField,{init:function(){this._super.apply(this,arguments);if(this.mode==='edit'){editableWidgets++;}},});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo" widget="char" attrs="{\'readonly\': [(\'turtle_int\', \'==\', 11111)]}"/>'+'<field name="turtle_int"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual(editableWidgets,1,"o2m is only widget in edit mode");await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));assert.strictEqual(editableWidgets,3,"3 widgets currently in edit mode");form.destroy();testUtils.mock.unpatch(AbstractField);});QUnit.test('one2many editable list with onchange keeps the order',async function(assert){assert.expect(2);this.data.partner.records[0].p=[1,2,4];this.data.partner.onchanges={p:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_data_cell').text(),'first recordsecond recordaaa',"records should be display in the correct order");await testUtils.dom.click(form.$('.o_data_row:first .o_data_cell'));await testUtils.fields.editInput(form.$('.o_selected_row .o_field_widget[name=display_name]'),'new');await testUtils.dom.click(form.$el);assert.strictEqual(form.$('.o_data_cell').text(),'newsecond recordaaa',"records should be display in the correct order");form.destroy();});QUnit.test('one2many list (editable): readonly domain is evaluated',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2,4];this.data.partner.records[1].product_id=false;this.data.partner.records[2].product_id=37;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name" attrs=\'{"readonly": [["product_id", "=", false]]}\'/>'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_list_view tbody tr:eq(0) td:first'),'o_readonly_modifier',"first record should have display_name in readonly mode");assert.doesNotHaveClass(form.$('.o_list_view tbody tr:eq(1) td:first'),'o_readonly_modifier',"second record should not have display_name in readonly mode");form.destroy();});QUnit.test('pager of one2many field in new record',async function(assert){assert.expect(3);this.data.partner.records[0].p=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',});assert.containsNone(form,'.o_x2m_control_panel .o_pager','o2m pager should be hidden');await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));assert.containsOnce(form,'tr.o_data_row');assert.containsNone(form,'.o_x2m_control_panel .o_pager','o2m pager should be hidden');form.destroy();});QUnit.test('one2many list with a many2one',async function(assert){assert.expect(5);let checkOnchange=false;this.data.partner.records[0].p=[2];this.data.partner.records[1].product_id=37;this.data.partner.onchanges.p=function(obj){obj.p=[[5],[1,2,{product_id:[37,"xphone"]}],[0,0,{product_id:[41,"xpad"]}]];};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{'partner,false,form':'<form string="Partner"><field name="product_id"/></form>',},mockRPC:function(route,args){if(args.method==='onchange'&&checkOnchange){assert.deepEqual(args.args[1].p,[[4,2,false],[0,args.args[1].p[1][1],{product_id:41}]],"should trigger onchange with correct parameters");}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('tbody td:contains(xphone)').length,1,"should have properly fetched the many2one nameget");assert.strictEqual(form.$('tbody td:contains(xpad)').length,0,"should not display 'xpad' anywhere");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));checkOnchange=true;await testUtils.fields.many2one.clickOpenDropdown('product_id');testUtils.fields.many2one.clickItem('product_id','xpad');await testUtils.dom.click($('.modal .modal-footer button:eq(0)'));assert.strictEqual(form.$('tbody td:contains(xpad)').length,1,"should display 'xpad' on a td");assert.strictEqual(form.$('tbody td:contains(xphone)').length,1,"should still display xphone");form.destroy();});QUnit.test('one2many list with inline form view',async function(assert){assert.expect(5);this.data.partner.records[0].p=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<form string="Partner">'+'<field name="product_id"/>'+'<field name="int_field"/>'+'</form>'+'<tree>'+'<field name="product_id"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1].p,[[0,args.args[1].p[0][1],{foo:"My little Foo Value",int_field:123,product_id:41,}]]);}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');await testUtils.fields.editInput($('.modal .modal-body input.o_field_widget'),'123');await testUtils.dom.click($('.modal .modal-footer button:eq(0)'));assert.strictEqual(form.$('tbody td:contains(xphone)').length,1,"should display 'xphone' in a td");await testUtils.dom.click(form.$('tbody td:contains(xphone)'));assert.strictEqual($('.modal .modal-body input').val(),"xphone","should display 'xphone' in an input");await testUtils.fields.editInput($('.modal .modal-body input.o_field_widget'),'456');await testUtils.dom.click($('.modal .modal-footer span:contains(Discard)'));await testUtils.dom.click(form.$('tbody td:contains(xphone)'));assert.strictEqual($('.modal .modal-body input.o_field_widget').val(),"123","should display 123 (previous change has been discarded)");await testUtils.fields.many2one.clickOpenDropdown('product_id');testUtils.fields.many2one.clickItem('product_id','xpad');await testUtils.dom.click($('.modal .modal-footer button:eq(0)'));assert.strictEqual(form.$('tbody td:contains(xpad)').length,1,"should display 'xpad' in a td");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many list with inline form view with context with parent key',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2];this.data.partner.records[0].product_id=41;this.data.partner.records[1].product_id=37;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="product_id"/>'+'<field name="p">'+'<form string="Partner">'+'<field name="product_id" context="{\'partner_foo\':parent.foo, \'lalala\': parent.product_id}"/>'+'</form>'+'<tree>'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='name_search'){assert.strictEqual(args.kwargs.context.partner_foo,"yop","should have correctly evaluated parent foo field");assert.strictEqual(args.kwargs.context.lalala,41,"should have correctly evaluated parent product_id field");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tr.o_data_row:eq(0) td:contains(xphone)'));await testUtils.dom.click($('.modal .o_field_many2one input'));form.destroy();});QUnit.test('value of invisible x2many fields is correctly evaluated in context',async function(assert){assert.expect(1);this.data.partner.records[0].timmy=[12];this.data.partner.records[0].p=[2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="product_id" context="{\'p\': p, \'timmy\': timmy}"/>'+'<field name="p" invisible="1"/>'+'<field name="timmy" invisible="1"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='name_search'){assert.deepEqual(args.kwargs.context,{p:[[4,2,false],[4,3,false]],timmy:[[6,false,[12]]],},'values of x2manys should have been correctly evaluated in context');}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_widget[name=product_id] input'));form.destroy();});QUnit.test('one2many list, editable, with many2one and with context with parent key',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];this.data.partner.records[1].product_id=37;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="product_id" context="{\'partner_foo\':parent.foo}"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='name_search'){assert.strictEqual(args.kwargs.context.partner_foo,"yop","should have correctly evaluated parent foo field");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tr.o_data_row:eq(0) td:contains(xphone)'));await testUtils.dom.click(form.$('table td input'));form.destroy();});QUnit.test('one2many list, editable, with a date in the context',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];this.data.partner.records[1].product_id=37;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="date"/>'+'<field name="p" context="{\'date\':date}">'+'<tree editable="top">'+'<field name="date"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){assert.strictEqual(args.kwargs.context.date,'2017-01-25',"should have properly evaluated date key in context");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.destroy();});QUnit.test('one2many field with context',async function(assert){assert.expect(2);var counter=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles" context="{\'turtles\':turtles}">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){var expected=counter===0?[[4,2,false]]:[[4,2,false],[0,args.kwargs.context.turtles[1][1],{turtle_foo:'hammer'}]];assert.deepEqual(args.kwargs.context.turtles,expected,"should have properly evaluated turtles key in context");counter++;}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('input[name="turtle_foo"]'),'hammer');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.destroy();});QUnit.test('one2many list edition, some basic functionality',async function(assert){assert.expect(3);this.data.partner.fields.foo.default=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));assert.containsOnce(form,'td input.o_field_widget',"should have created a row in edit mode");await testUtils.fields.editInput(form.$('td input.o_field_widget'),'a');assert.containsOnce(form,'td input.o_field_widget',"should not have unselected the row after edition");await testUtils.fields.editInput(form.$('td input.o_field_widget'),'abc');await testUtils.form.clickSave(form);assert.strictEqual(form.$('td:contains(abc)').length,1,"should have a row with the correct value");form.destroy();});QUnit.test('one2many list, the context is properly evaluated and sent',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="p" context="{\'hello\': \'world\', \'abc\': int_field}">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){var context=args.kwargs.context;assert.strictEqual(context.hello,"world");assert.strictEqual(context.abc,10);}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));form.destroy();});QUnit.test('one2many with many2many widget: create',async function(assert){assert.expect(10);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles" widget="many2many">'+'<tree>'+'<field name="turtle_foo"/>'+'<field name="turtle_qux"/>'+'<field name="turtle_int"/>'+'<field name="product_id"/>'+'</tree>'+'<form>'+'<group>'+'<field name="turtle_foo"/>'+'<field name="turtle_bar"/>'+'<field name="turtle_int"/>'+'<field name="product_id"/>'+'</group>'+'</form>'+'</field>'+'</form>',archs:{'turtle,false,list':'<tree><field name="display_name"/><field name="turtle_foo"/><field name="turtle_bar"/><field name="product_id"/></tree>','turtle,false,search':'<search><field name="turtle_foo"/><field name="turtle_bar"/><field name="product_id"/></search>',},session:{},res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/turtle/create'){assert.ok(args.args,"should write on the turtle record");}
if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[0][0],1,"should write on the partner record 1");assert.strictEqual(args.args[1].turtles[0][0],6,"should send only a 'replace with' command");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .o_data_row').length,2,"should have 2 records in the select view (the last one is not displayed because it is already selected)");await testUtils.dom.click($('.modal .o_data_row:first .o_list_record_selector input'));await testUtils.dom.click($('.modal .o_select_button'));await testUtils.dom.click($('.o_form_button_save'));await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .o_data_row').length,1,"should have 1 record in the select view");await testUtils.dom.click($('.modal-footer button:eq(1)'));await testUtils.fields.editInput($('.modal input.o_field_widget[name="turtle_foo"]'),'tototo');await testUtils.fields.editInput($('.modal input.o_field_widget[name="turtle_int"]'),50);await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');await testUtils.dom.click($('.modal-footer button:contains(&):first'));assert.strictEqual($('.modal').length,0,"should close the modals");assert.containsN(form,'.o_data_row',3,"should have 3 records in one2many list");assert.strictEqual(form.$('.o_data_row').text(),"blip1.59yop1.50tototo1.550xphone","should display the record values in one2many list");await testUtils.dom.click($('.o_form_button_save'));form.destroy();});QUnit.test('one2many with many2many widget: edition',async function(assert){assert.expect(7);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles" widget="many2many">'+'<tree>'+'<field name="turtle_foo"/>'+'<field name="turtle_qux"/>'+'<field name="turtle_int"/>'+'<field name="product_id"/>'+'</tree>'+'<form>'+'<group>'+'<field name="turtle_foo"/>'+'<field name="turtle_bar"/>'+'<field name="turtle_int"/>'+'<field name="turtle_trululu"/>'+'<field name="product_id"/>'+'</group>'+'</form>'+'</field>'+'</form>',archs:{'turtle,false,list':'<tree><field name="display_name"/><field name="turtle_foo"/><field name="turtle_bar"/><field name="product_id"/></tree>','turtle,false,search':'<search><field name="turtle_foo"/><field name="turtle_bar"/><field name="product_id"/></search>',},session:{},res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/turtle/write'){assert.strictEqual(args.args[0].length,1,"should write on the turtle record");assert.deepEqual(args.args[1],{"product_id":37},"should write only the product_id on the turtle record");}
if(route==='/web/dataset/call_kw/partner/write'){assert.strictEqual(args.args[0][0],1,"should write on the partner record 1");assert.strictEqual(args.args[1].turtles[0][0],6,"should send only a 'replace with' command");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_data_row:first'));assert.strictEqual($('.modal .modal-title').first().text().trim(),'Open: one2many turtle field',"modal should use the python field string as title");await testUtils.dom.click($('.modal .o_form_button_cancel'));await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_row:first'));await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');await testUtils.dom.click($('.modal-footer button:first'));await testUtils.dom.click($('.o_form_button_save'));await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal .o_data_row:first .o_list_record_selector input'));await testUtils.dom.click($('.modal .o_select_button'));await testUtils.dom.click(form.$('.o_data_row:eq(1)'));await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');await testUtils.dom.click($('.modal-footer button:first'));await testUtils.dom.click($('.o_form_button_save'));form.destroy();});QUnit.test('new record, the context is properly evaluated and sent',async function(assert){assert.expect(2);this.data.partner.fields.int_field.default=17;var n=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="p" context="{\'hello\': \'world\', \'abc\': int_field}">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'){n++;if(n===2){var context=args.kwargs.context;assert.strictEqual(context.hello,"world");assert.strictEqual(context.abc,17);}}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));form.destroy();});QUnit.test('parent data is properly sent on an onchange rpc',async function(assert){assert.expect(1);this.data.partner.onchanges={bar:function(){}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="p">'+'<tree editable="top">'+'<field name="bar"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){var fieldValues=args.args[1];assert.strictEqual(fieldValues.trululu.foo,"yop","should have properly sent the parent foo value");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();form.destroy();});QUnit.test('parent data is properly sent on an onchange rpc, new record',async function(assert){assert.expect(4);this.data.turtle.onchanges={turtle_bar:function(){}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_bar"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){assert.step(args.method);if(args.method==='onchange'&&args.model==='turtle'){var fieldValues=args.args[1];assert.strictEqual(fieldValues.turtle_trululu.foo,"My little Foo Value","should have properly sent the parent foo value");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();assert.verifySteps(['onchange','onchange']);form.destroy();});QUnit.test('id in one2many obtained in onchange is properly set',async function(assert){assert.expect(1);this.data.partner.onchanges.turtles=function(obj){obj.turtles=[[5],[1,3,{turtle_foo:"kawa"}]];};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree>'+'<field name="id"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',});assert.strictEqual(form.$('tr.o_data_row').text(),'3kawa',"should have properly displayed id and foo field");form.destroy();});QUnit.test('id field in one2many in a new record',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="id" invisible="1"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){var virtualID=args.args[0].turtles[0][1];assert.deepEqual(args.args[0].turtles,[[0,virtualID,{turtle_foo:"cat"}]],'should send proper commands');}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('td.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('td input[name="turtle_foo"]'),'cat');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('sub form view with a required field',async function(assert){assert.expect(2);this.data.partner.fields.foo.required=true;this.data.partner.fields.foo.default=null;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<form string="Partner">'+'<group><field name="foo"/></group>'+'</form>'+'<tree>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal-footer button.btn-primary').first());assert.strictEqual($('.modal').length,1,"should still have an open modal");assert.strictEqual($('.modal tbody label.o_field_invalid').length,1,"should have displayed invalid fields");form.destroy();});QUnit.test('one2many list with action button',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<button name="method_name" type="object" icon="fa-plus"/>'+'</tree>'+'</field>'+'</form>',res_id:1,intercepts:{execute_action:function(event){assert.deepEqual(event.data.env.currentID,2,'should call with correct id');assert.strictEqual(event.data.env.model,'partner','should call with correct model');assert.strictEqual(event.data.action_data.name,'method_name',"should call correct method");assert.strictEqual(event.data.action_data.type,'object','should have correct type');},},});await testUtils.dom.click(form.$('.o_list_button button'));form.destroy();});QUnit.test('one2many kanban with action button',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<kanban>'+'<field name="foo"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div>'+'<span><t t-esc="record.foo.value"/></span>'+'<button name="method_name" type="object" class="fa fa-plus"/>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',res_id:1,intercepts:{execute_action:function(event){assert.deepEqual(event.data.env.currentID,2,'should call with correct id');assert.strictEqual(event.data.env.model,'partner','should call with correct model');assert.strictEqual(event.data.action_data.name,'method_name',"should call correct method");assert.strictEqual(event.data.action_data.type,'object','should have correct type');},},});await testUtils.dom.click(form.$('.oe_kanban_action_button'));form.destroy();});QUnit.test('one2many kanban with edit type action and domain widget (widget using SpecialData)',async function(assert){assert.expect(1);this.data.turtle.fields.model_name={string:"Domain Condition Model",type:"char"};this.data.turtle.fields.condition={string:"Domain Condition",type:"char"};_.each(this.data.turtle.records,function(record){record.model_name='partner';record.condition='[]';});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles" mode="kanban">'+'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'<div><field name="turtle_foo"/></div>'+'<div><field name="condition"/></div>'+'<div> <a type="edit"> Edit </a> </div>'+'</t>'+'</templates>'+'</kanban>'+'<form>'+'<field name="product_id" widget="statusbar"/>'+'<field name="model_name"/>'+'<field name="condition" widget="domain" options="{\'model\': \'model_name\'}"/>'+'</form>'+'</field>'+'</group>'+'</form>',res_id:1,});await testUtils.dom.click(form.$('.oe_kanban_action:eq(0)'));assert.strictEqual($('.o_domain_selector').length,1,"should add domain selector widget");form.destroy();});QUnit.test('one2many list with onchange and domain widget (widget using SpecialData)',async function(assert){assert.expect(3);this.data.turtle.fields.model_name={string:"Domain Condition Model",type:"char"};this.data.turtle.fields.condition={string:"Domain Condition",type:"char"};_.each(this.data.turtle.records,function(record){record.model_name='partner';record.condition='[]';});this.data.partner.onchanges={turtles:function(obj){var virtualID=obj.turtles[1][1];obj.turtles=[[5],[0,virtualID,{display_name:"coucou",product_id:[37,"xphone"],turtle_bar:false,turtle_foo:"has changed",turtle_int:42,turtle_qux:9.8,partner_ids:[],turtle_ref:'product,37',model_name:'partner',condition:'[]',}],];},};var nbFetchSpecialDomain=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles" mode="tree">'+'<tree>'+'<field name="display_name"/>'+'<field name="turtle_foo"/>'+'<field name="condition"/>'+'</tree>'+'<form>'+'<field name="model_name"/>'+'<field name="condition" widget="domain" options="{\'model\': \'model_name\'}"/>'+'</form>'+'</field>'+'</group>'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route){if(route==='/web/dataset/call_kw/partner/search_count'){nbFetchSpecialDomain++;}
return this._super.apply(this,arguments);}});await testUtils.dom.click(form.$('.o_field_one2many .o_field_x2many_list_row_add a'));assert.strictEqual($('.modal').length,1,"form view dialog should be opened");await testUtils.fields.editInput($('.modal-body input[name="model_name"]'),'partner');await testUtils.dom.click($('.modal-footer button:first'));assert.strictEqual(form.$('.o_field_one2many tbody tr:first').text(),"coucouhas changed[]","the onchange should create one new record and remove the existing");await testUtils.dom.click(form.$('.o_field_one2many .o_list_view tbody tr:eq(0) td:first'));await testUtils.form.clickSave(form);assert.strictEqual(nbFetchSpecialDomain,1,"should only fetch special domain once");form.destroy();});QUnit.test('one2many without inline tree arch',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="p" widget="many2many_tags"/>'+'<field name="turtles"/>'+'<field name="timmy" invisible="1"/>'+'</group>'+'</form>',res_id:1,archs:{"turtle,false,list":'<tree string="Turtles"><field name="turtle_bar"/><field name="display_name"/><field name="partner_ids"/></tree>',}});assert.containsOnce(form,'.o_field_widget[name="turtles"] .o_list_view','should display one2many list view in the modal');assert.containsN(form,'.o_data_row',2,'should display the 2 turtles');form.destroy();});QUnit.test('many2one and many2many in one2many',async function(assert){assert.expect(11);this.data.turtle.records[1].product_id=37;this.data.partner.records[0].turtles=[2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="int_field"/>'+'<field name="turtles">'+'<form string="Turtles">'+'<group>'+'<field name="product_id"/>'+'</group>'+'</form>'+'<tree editable="top">'+'<field name="display_name"/>'+'<field name="product_id"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){var commands=args.args[1].turtles;assert.strictEqual(commands.length,2,"should have generated 2 commands");assert.deepEqual(commands[0],[1,2,{partner_ids:[[6,false,[2,1]]],product_id:41,}],"generated commands should be correct");assert.deepEqual(commands[1],[4,3,false],"generated commands should be correct");}
return this._super.apply(this,arguments);},});assert.containsN(form,'.o_data_row',2,'should display the 2 turtles');assert.strictEqual(form.$('.o_data_row:first td:nth(1)').text(),'xphone',"should correctly display the m2o");assert.strictEqual(form.$('.o_data_row:first td:nth(2) .badge').length,2,"m2m should contain two tags");assert.strictEqual(form.$('.o_data_row:first td:nth(2) .badge:first span').text(),'second record',"m2m values should have been correctly fetched");await testUtils.dom.click(form.$('.o_data_row:first'));assert.strictEqual($('.modal .o_field_widget').text(),"xphone",'should display the form view dialog with the many2one value');await testUtils.dom.click($('.modal-footer button'));await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_list_view tbody td:first()'));await testUtils.dom.click(form.$('.o_field_many2manytags .badge:contains(aaa) .o_delete'));assert.strictEqual(form.$('.o_selected_row .o_field_many2manytags .o_badge_text:contains(aaa)').length,0,"tag should have been correctly removed");await testUtils.fields.many2one.clickOpenDropdown('partner_ids');await testUtils.fields.many2one.clickHighlightedItem('partner_ids');assert.strictEqual(form.$('.o_selected_row .o_field_many2manytags .o_badge_text:contains(first record)').length,1,"tag should have been correctly added");await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickItem('product_id','xpad');assert.strictEqual(form.$('.o_selected_row .o_field_many2one:first input').val(),'xpad',"m2o value should have been updated");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('many2manytag in one2many, onchange, some modifiers, and more than one page',async function(assert){assert.expect(9);this.data.partner.records[0].turtles=[1,2,3];this.data.partner.onchanges.turtles=function(){};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="top" limit="2">'+'<field name="turtle_foo"/>'+'<field name="partner_ids" widget="many2many_tags" attrs="{\'readonly\': [(\'turtle_foo\', \'=\', \'a\')]}"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit'},mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});assert.containsN(form,'.o_data_row',2,'there should be only 2 rows displayed');await testUtils.dom.clickFirst(form.$('.o_list_record_remove'));await testUtils.dom.clickFirst(form.$('.o_list_record_remove'));assert.containsOnce(form,'.o_data_row','there should be just one remaining row');assert.verifySteps(["read","read","read","read","onchange","onchange"]);form.destroy();});QUnit.test('onchange many2many in one2many list editable',async function(assert){assert.expect(14);this.data.product.records.push({id:1,display_name:"xenomorphe",});this.data.turtle.onchanges={product_id:function(rec){if(rec.product_id){rec.partner_ids=[[5],[4,rec.product_id===41?1:2]];}},};var partnerOnchange=function(rec){if(!rec.int_field||!rec.turtles.length){return;}
rec.turtles=[[5],[0,0,{display_name:'new line',product_id:[37,'xphone'],partner_ids:[[5],[4,1]]}],[0,rec.turtles[0][1],{display_name:rec.turtles[0][2].display_name,product_id:[1,'xenomorphe'],partner_ids:[[5],[4,2]]}],];};this.data.partner.onchanges={int_field:partnerOnchange,turtles:partnerOnchange,};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="int_field"/>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="product_id"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</group>'+'</form>',});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('input[name="display_name"]'),'first');await testUtils.dom.click(form.$('div[name="product_id"] input'));await testUtils.dom.click($('li.ui-menu-item a:contains(xpad)').trigger('mouseenter'));assert.containsOnce(form,'.o_field_many2manytags.o_input','should display the line in editable mode');assert.strictEqual(form.$('.o_field_many2one input').val(),"xpad",'should display the product xpad');assert.strictEqual(form.$('.o_field_many2manytags.o_input .o_badge_text').text(),"first record",'should display the tag from the onchange');await testUtils.dom.click(form.$('input.o_field_integer[name="int_field"]'));assert.strictEqual(form.$('.o_data_cell.o_required_modifier').text(),"xpad",'should display the product xpad');assert.strictEqual(form.$('.o_field_many2manytags:not(.o_input) .o_badge_text').text(),"first record",'should display the tag in readonly');await testUtils.fields.editInput(form.$('input.o_field_integer[name="int_field"]'),'10');assert.strictEqual(form.$('.o_data_cell.o_required_modifier').text(),"xenomorphexphone",'should display the product xphone and xenomorphe');assert.strictEqual(form.$('.o_data_row').text().replace(/\s+/g,' '),"firstxenomorphe second record new linexphone first record ",'should display the name, one2many and many2many value');await testUtils.fields.editInput(form.$('input.o_field_integer[name="int_field"]'),'0');await testUtils.dom.click(form.$('.o_list_record_remove:first button'));await testUtils.dom.click(form.$('.o_list_record_remove:first button'));await testUtils.fields.editInput(form.$('input.o_field_integer[name="int_field"]'),'10');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('input[name="display_name"]'),'first');await testUtils.dom.click(form.$('div[name="product_id"] input'));await testUtils.dom.click($('li.ui-menu-item a:contains(xenomorphe)').trigger('mouseenter'));assert.containsOnce(form,'.o_field_many2manytags.o_input','should display the line in editable mode');assert.strictEqual(form.$('.o_field_many2one input').val(),"xenomorphe",'should display the product xenomorphe');assert.strictEqual(form.$('.o_field_many2manytags.o_input .o_badge_text').text(),"second record",'should display the tag from the onchange');await testUtils.dom.click(form.$('input.o_field_integer[name="int_field"]'));assert.strictEqual(form.$('.o_data_cell.o_required_modifier').text(),"xenomorphexphone",'should display the product xphone and xenomorphe');assert.strictEqual(form.$('.o_field_many2manytags:not(.o_input) .o_badge_text').text(),"second recordfirst record",'should display the tag in readonly (first record and second record)');await testUtils.fields.editInput(form.$('input.o_field_integer[name="int_field"]'),'10');assert.strictEqual(form.$('.o_data_row').text().replace(/\s+/g,' '),"firstxenomorphe second record new linexphone first record ",'should display the name, one2many and many2many value');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_data_row').text().replace(/\s+/g,' '),"firstxenomorphe second record new linexphone first record ",'should display the name, one2many and many2many value after save');form.destroy();});QUnit.test('load view for x2many in one2many',async function(assert){assert.expect(2);this.data.turtle.records[1].product_id=37;this.data.partner.records[0].turtles=[2,3];this.data.partner.records[2].turtles=[1,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="int_field"/>'+'<field name="turtles">'+'<form string="Turtles">'+'<group>'+'<field name="product_id"/>'+'<field name="partner_ids"/>'+'</group>'+'</form>'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,archs:{"partner,false,list":'<tree string="Partners"><field name="display_name"/></tree>',},});assert.containsN(form,'.o_data_row',2,'should display the 2 turtles');await testUtils.dom.click(form.$('.o_data_row:first'));assert.strictEqual($('.modal .o_field_widget[name="partner_ids"] .o_list_view').length,1,'should display many2many list view in the modal');form.destroy();});QUnit.test('one2many (who contains a one2many) with tree view and without form view',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree>'+'<field name="partner_ids"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,archs:{"turtle,false,form":'<form string="Turtles"><field name="turtle_foo"/></form>',},});await testUtils.dom.click(form.$('.o_data_row:first'));assert.strictEqual($('.modal .o_field_widget[name="turtle_foo"]').text(),'blip','should open the modal and display the form field');form.destroy();});QUnit.test('one2many with x2many in form view (but not in list view)',async function(assert){assert.expect(1);this.data.turtle.fields.o2m={string:"o2m",type:"one2many",relation:'user'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,archs:{"turtle,false,form":'<form string="Turtles">'+'<field name="partner_ids" widget="many2many_tags"/>'+'</form>',},viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1].turtles,[[1,2,{partner_ids:[[6,false,[2,4,1]]],}]]);}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_data_row:first'));await testUtils.fields.many2one.clickOpenDropdown('partner_ids');await testUtils.fields.many2one.clickHighlightedItem('partner_ids');await testUtils.dom.click($('.modal .o_field_many2manytags input'));await testUtils.fields.editInput($('.modal .o_field_many2manytags input'),'test');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));await testUtils.form.clickSave(form);form.destroy();});QUnit.test('many2many list in a one2many opened by a many2one',async function(assert){assert.expect(1);this.data.turtle.records[1].turtle_trululu=2;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_trululu"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{"partner,false,form":'<form string="P">'+'<field name="timmy"/>'+'</form>',"partner_type,false,list":'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>',"partner_type,false,search":'<search>'+'</search>',},viewOptions:{mode:'edit',},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/get_formview_id'){return Promise.resolve(false);}
if(args.method==='write'){assert.deepEqual(args.args[1].timmy,[[6,false,[12]]],'should properly write ids');}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_data_row:first td.o_data_cell'));await testUtils.dom.click(form.$('.o_external_button'));await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal td:contains(gold)'));await testUtils.dom.click($('.modal .modal-footer .btn-primary'));await testUtils.form.clickSave(form);form.destroy();});QUnit.test('nested x2many default values',async function(assert){assert.expect(3);this.data.partner.fields.turtles.default=[[0,0,{partner_ids:[[6,0,[4]]]}],[0,0,{partner_ids:[[6,0,[1]]]}],];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="top">'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</form>',});assert.containsN(form,'.o_list_view .o_data_row',2,"one2many list should contain 2 rows");assert.containsN(form,'.o_list_view .o_field_many2manytags[name="partner_ids"] .badge',2,"m2mtags should contain two tags");assert.strictEqual(form.$('.o_list_view .o_field_many2manytags[name="partner_ids"] .o_badge_text').text(),'aaafirst record',"tag names should have been correctly loaded");form.destroy();});QUnit.test('nested x2many (inline form view) and onchanges',async function(assert){assert.expect(6);this.data.partner.onchanges.bar=function(obj){if(!obj.bar){obj.p=[[5],[0,0,{turtles:[[0,0,{turtle_foo:'new turtle',}]],}]];}};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form>
                        <field name="bar"/>
                        <field name="p">
                            <tree>
                                <field name="turtles"/>
                            </tree>
                            <form>
                                <field name="turtles">
                                    <tree>
                                        <field name="turtle_foo"/>
                                    </tree>
                                </field>
                            </form>
                        </field>
                    </form>`,});assert.containsNone(form,'.o_data_row');await testUtils.dom.click(form.$('.o_field_widget[name=bar] input'));assert.containsOnce(form,'.o_data_row');assert.strictEqual(form.$('.o_data_row').text(),'1 record');await testUtils.dom.click(form.$('.o_data_row:first'));assert.containsOnce(document.body,'.modal .o_form_view');assert.containsOnce(document.body,'.modal .o_form_view .o_data_row');assert.strictEqual($('.modal .o_form_view .o_data_row').text(),'new turtle');form.destroy();});QUnit.test('nested x2many (non inline form view) and onchanges',async function(assert){assert.expect(6);this.data.partner.onchanges.bar=function(obj){if(!obj.bar){obj.p=[[5],[0,0,{turtles:[[0,0,{turtle_foo:'new turtle',}]],}]];}};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="bar"/>
                        <field name="p">
                            <tree>
                                <field name="turtles"/>
                            </tree>
                        </field>
                    </form>`,archs:{'partner,false,form':`
                        <form>
                            <field name="turtles">
                                <tree>
                                    <field name="turtle_foo"/>
                                </tree>
                            </field>
                        </form>`,},});assert.containsNone(form,'.o_data_row');await testUtils.dom.click(form.$('.o_field_widget[name=bar] input'));assert.containsOnce(form,'.o_data_row');assert.strictEqual(form.$('.o_data_row').text(),'1 record');await testUtils.dom.click(form.$('.o_data_row:first'));assert.containsOnce(document.body,'.modal .o_form_view');assert.containsOnce(document.body,'.modal .o_form_view .o_data_row');assert.strictEqual($('.modal .o_form_view .o_data_row').text(),'new turtle');form.destroy();});QUnit.test('nested x2many (non inline views and no widget on inner x2many in list)',async function(assert){assert.expect(5);this.data.partner.records[0].p=[1];const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="p"/></form>',archs:{'partner,false,list':'<tree><field name="turtles"/></tree>','partner,false,form':'<form><field name="turtles" widget="many2many_tags"/></form>',},res_id:1,});assert.containsOnce(form,'.o_data_row');assert.strictEqual(form.$('.o_data_row').text(),'1 record');await testUtils.dom.click(form.$('.o_data_row'));assert.containsOnce(document.body,'.modal .o_form_view');assert.containsOnce(document.body,'.modal .o_form_view .o_field_many2manytags .badge');assert.strictEqual($('.modal .o_field_many2manytags').text().trim(),'donatello');form.destroy();});QUnit.test('one2many (who contains display_name) with tree view and without form view',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,archs:{"turtle,false,form":'<form string="Turtles"><field name="turtle_foo"/></form>',},});await testUtils.dom.click(form.$('.o_data_row:first'));assert.strictEqual($('.modal .o_field_widget[name="turtle_foo"]').text(),'blip','should open the modal and display the form field');form.destroy();});QUnit.test('one2many field with virtual ids',async function(assert){assert.expect(11);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<notebook>'+'<page>'+'<field name="p" mode="kanban">'+'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_details">'+'<div class="o_test_id">'+'<field name="id"/>'+'</div>'+'<div class="o_test_foo">'+'<field name="foo"/>'+'</div>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</page>'+'</notebook>'+'</group>'+'</sheet>'+'</form>',archs:{'partner,false,form':'<form string="Associated partners">'+'<field name="foo"/>'+'</form>',},res_id:4,});assert.containsOnce(form,'.o_field_widget .o_kanban_view',"should have one inner kanban view for the one2many field");assert.strictEqual(form.$('.o_field_widget .o_kanban_view .o_kanban_record:not(.o_kanban_ghost)').length,0,"should not have kanban records yet");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_widget .o-kanban-button-new'));assert.strictEqual($('.modal-content input.o_field_widget').val(),'My little Foo Value',"should already have the default value for field foo");await testUtils.dom.click($('.modal-content .btn-primary').first());assert.containsOnce(form,'.o_field_widget .o_kanban_view',"should have one inner kanban view for the one2many field");assert.strictEqual(form.$('.o_field_widget .o_kanban_view .o_kanban_record:not(.o_kanban_ghost)').length,1,"should now have one kanban record");assert.strictEqual(form.$('.o_field_widget .o_kanban_view .o_kanban_record:not(.o_kanban_ghost) .o_test_id').text(),'',"should not have a value for the id field");assert.strictEqual(form.$('.o_field_widget .o_kanban_view .o_kanban_record:not(.o_kanban_ghost) .o_test_foo').text(),'My little Foo Value',"should have a value for the foo field");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_field_widget .o_kanban_view',"should have one inner kanban view for the one2many field");assert.strictEqual(form.$('.o_field_widget .o_kanban_view .o_kanban_record:not(.o_kanban_ghost)').length,1,"should now have one kanban record");assert.notEqual(form.$('.o_field_widget .o_kanban_view .o_kanban_record:not(.o_kanban_ghost) .o_test_id').text(),'',"should now have a value for the id field");assert.strictEqual(form.$('.o_field_widget .o_kanban_view .o_kanban_record:not(.o_kanban_ghost) .o_test_foo').text(),'My little Foo Value',"should still have a value for the foo field");form.destroy();});QUnit.test('one2many field with virtual ids with kanban button',async function(assert){assert.expect(25);testUtils.mock.patch(KanbanRecord,{init:function(){this._super.apply(this,arguments);this._onKanbanActionClicked=this.__proto__._onKanbanActionClicked;},});this.data.partner.records[0].p=[4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p" mode="kanban">'+'<kanban>'+'<templates>'+'<field name="foo"/>'+'<t t-name="kanban-box">'+'<div>'+'<span><t t-esc="record.foo.value"/></span>'+'<button type="object" class="btn btn-link fa fa-shopping-cart" name="button_warn" string="button_warn" warn="warn" />'+'<button type="object" class="btn btn-link fa fa-shopping-cart" name="button_disabled" string="button_disabled" />'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',archs:{'partner,false,form':'<form><field name="foo"/></form>',},res_id:1,services:{notification:NotificationService.extend({notify:function(params){assert.step(params.type);}}),},intercepts:{execute_action:function(event){assert.step(event.data.action_data.name+'_'+event.data.env.model+'_'+event.data.env.currentID);event.data.on_success();},},});var oKanbanView='.o_field_widget .o_kanban_view';var oKanbanRecordActive=oKanbanView+' .o_kanban_record:not(.o_kanban_ghost)';var oAllKanbanButton=oKanbanRecordActive+' button[data-type="object"]';var btn1=oKanbanRecordActive+':nth-child(1) button[data-type="object"]';var btn2=oKanbanRecordActive+':nth-child(2) button[data-type="object"]';var btn1Warn=btn1+'[data-name="button_warn"]';var btn1Disabled=btn1+'[data-name="button_disabled"]';var btn2Warn=btn2+'[data-name="button_warn"]';var btn2Disabled=btn2+'[data-name="button_disabled"]';assert.containsOnce(form,oKanbanView,"should have one inner kanban view for the one2many field");assert.containsOnce(form,oKanbanRecordActive,"should have one kanban records yet");assert.containsN(form,oAllKanbanButton,2,"should have 2 buttons type object");assert.containsNone(form,oAllKanbanButton+'[disabled]',"should not have button type object disabled");await testUtils.dom.click(form.$(btn1Disabled));await testUtils.dom.click(form.$(btn1Warn));await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$(btn1Disabled));await testUtils.dom.click(form.$(btn1Warn));await testUtils.dom.click(form.$('.o_field_widget .o-kanban-button-new'));assert.strictEqual($('.modal-content input.o_field_widget').val(),'My little Foo Value',"should already have the default value for field foo");await testUtils.dom.click($('.modal-content .btn-primary').first());assert.containsN(form,oAllKanbanButton,4,"should have 4 buttons type object");assert.containsN(form,btn1,2,"should have 2 buttons type object in area 1");assert.containsN(form,btn2,2,"should have 2 buttons type object in area 2");assert.containsOnce(form,oAllKanbanButton+'[disabled]',"should have 1 button type object disabled");assert.strictEqual(form.$(btn2Disabled).attr('disabled'),'disabled','Should have a button type object disabled in area 2');assert.strictEqual(form.$(btn2Warn).attr('disabled'),undefined,'Should have a button type object not disabled in area 2');assert.strictEqual(form.$(btn2Warn).attr('warn'),'warn','Should have a button type object with warn attr in area 2');await testUtils.dom.click(form.$(btn1Disabled));await testUtils.dom.click(form.$(btn1Warn));await testUtils.dom.click(form.$(btn2Disabled));await testUtils.dom.click(form.$(btn2Warn));await testUtils.form.clickSave(form);assert.containsNone(form,oAllKanbanButton+'[disabled]',"should not have button type object disabled after save");await testUtils.dom.click(form.$(btn1Disabled));await testUtils.dom.click(form.$(btn1Warn));await testUtils.dom.click(form.$(btn2Disabled));await testUtils.dom.click(form.$(btn2Warn));assert.verifySteps(["button_disabled_partner_4","button_warn_partner_4","button_disabled_partner_4","button_warn_partner_4","button_disabled_partner_4","button_warn_partner_4","danger","button_disabled_partner_4","button_warn_partner_4","button_disabled_partner_5","button_warn_partner_5"],"should have triggered theses 11 clicks event");testUtils.mock.unpatch(KanbanRecord);form.destroy();});QUnit.test('focusing fields in one2many list',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'<field name="turtle_int"/>'+'</tree>'+'</field>'+'</group>'+'<field name="foo"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_row:first td:first'));assert.strictEqual(form.$('input[name="turtle_foo"]')[0],document.activeElement,"turtle foo field should have focus");await testUtils.fields.triggerKeydown(form.$('input[name="turtle_foo"]'),'tab');assert.strictEqual(form.$('input[name="turtle_int"]')[0],document.activeElement,"turtle int field should have focus");form.destroy();});QUnit.test('one2many list editable = top',async function(assert){assert.expect(6);this.data.turtle.fields.turtle_foo.default="default foo turtle";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){var commands=args.args[1].turtles;assert.strictEqual(commands[0][0],0,"first command is a create");assert.strictEqual(commands[1][0],4,"second command is a link to");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_data_row',"should start with one data row");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'.o_data_row',2,"should have 2 data rows");assert.strictEqual(form.$('tr.o_data_row:first input').val(),'default foo turtle',"first row should be the new value");assert.hasClass(form.$('tr.o_data_row:first'),'o_selected_row',"first row should be selected");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many list editable = bottom',async function(assert){assert.expect(6);this.data.turtle.fields.turtle_foo.default="default foo turtle";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){var commands=args.args[1].turtles;assert.strictEqual(commands[0][0],4,"first command is a link to");assert.strictEqual(commands[1][0],0,"second command is a create");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_data_row',"should start with one data row");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'.o_data_row',2,"should have 2 data rows");assert.strictEqual(form.$('tr.o_data_row:eq(1) input').val(),'default foo turtle',"second row should be the new value");assert.hasClass(form.$('tr.o_data_row:eq(1)'),'o_selected_row',"second row should be selected");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many list edition, no "Remove" button in modal',async function(assert){assert.expect(2);this.data.partner.fields.foo.default=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'</tree>'+'<form string="Partners">'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('tbody td.o_field_x2many_list_row_add a'));assert.containsOnce($(document),$('.modal'),'there should be a modal opened');assert.containsNone($('.modal .modal-footer .o_btn_remove'),'modal should not contain a "Remove" button');await testUtils.dom.click($('.modal-footer .btn-secondary'));await testUtils.form.clickDiscard(form);form.destroy();});QUnit.test('x2many fields use their "mode" attribute',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field mode="kanban" name="turtles">'+'<tree>'+'<field name="turtle_foo"/>'+'</tree>'+'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<div>'+'<field name="turtle_int"/>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</group>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_field_one2many .o_kanban_view',"should have rendered a kanban view");form.destroy();});QUnit.test('one2many list editable, onchange and required field',async function(assert){assert.expect(8);this.data.turtle.fields.turtle_foo.required=true;this.data.partner.onchanges={turtles:function(obj){obj.int_field=obj.turtles.length;},};this.data.partner.records[0].int_field=0;this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_int"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"0","int_field should start with value 0");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"0","int_field should still be 0 (no onchange should have been done yet");assert.verifySteps(['read','onchange']);await testUtils.fields.editInput(form.$('.o_field_widget[name="turtle_foo"]'),"some text");assert.verifySteps(['onchange']);assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"1","int_field should now be 1 (the onchange should have been done");form.destroy();});QUnit.test('one2many list editable: trigger onchange when row is valid',async function(assert){assert.expect(13);this.data.turtle.fields.turtle_foo.required=true;this.data.turtle.fields.turtle_qux.required=true;this.data.turtle.fields.turtle_bar.required=true;delete this.data.turtle.fields.turtle_bar.default;this.data.turtle.fields.turtle_int.required=true;this.data.turtle.fields.turtle_int.default=0;this.data.turtle.fields.partner_ids.required=true;this.data.partner.onchanges={turtles:function(obj){obj.int_field=obj.turtles.length;},};this.data.partner.records[0].int_field=0;this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="turtles"/>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},archs:{'turtle,false,list':'<tree editable="top">'+'<field name="turtle_qux"/>'+'<field name="turtle_bar"/>'+'<field name="turtle_int"/>'+'<field name="turtle_foo"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>',},res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"0","int_field should start with value 0");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"0","int_field should still be 0 (no onchange should have been done yet)");assert.verifySteps(['load_views','read','onchange']);await testUtils.fields.editInput(form.$('.o_field_widget[name="turtle_foo"]'),"some text");assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"0","int_field should still be 0 (no onchange should have been done yet)");assert.verifySteps([],"no onchange should have been applied");await testUtils.fields.many2one.clickOpenDropdown('partner_ids');await testUtils.fields.many2one.clickHighlightedItem('partner_ids');assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"1","int_field should now be 1 (the onchange should have been done");assert.verifySteps(['name_search','read','onchange']);form.destroy();});QUnit.test('one2many list editable: \'required\' modifiers is properly working',async function(assert){assert.expect(3);this.data.partner.onchanges={turtles:function(obj){obj.int_field=obj.turtles.length;},};this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo" required="1"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"10","int_field should start with value 10");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"10","int_field should still be 10 (no onchange, because line is not valid)");await testUtils.fields.editInput(form.$('.o_field_widget[name="turtle_foo"]'),"some text");assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"1","int_field should be 1 (onchange triggered, because line is now valid)");form.destroy();});QUnit.test('one2many list editable: \'required\' modifiers is properly working, part 2',async function(assert){assert.expect(3);this.data.partner.onchanges={turtles:function(obj){obj.int_field=obj.turtles.length;},};this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_int"/>'+'<field name="turtle_foo" attrs=\'{"required": [["turtle_int", "=", 0]]}\'/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"10","int_field should start with value 10");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"10","int_field should still be 10 (no onchange, because line is not valid)");await testUtils.fields.editInput(form.$('.o_field_widget[name="turtle_int"]'),"1");assert.strictEqual(form.$('.o_field_widget[name="int_field"]').val(),"1","int_field should be 1 (onchange triggered, because line is now valid)");form.destroy();});QUnit.test('one2many list editable: add new line before onchange returns',async function(assert){assert.expect(7);this.data.turtle.onchanges={turtle_trululu:function(){},};var prom;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_trululu" required="1"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(prom).then(_.constant(result));}
return result;},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));prom=testUtils.makeTestPromise();assert.containsOnce(form,'.o_data_row',"should have created the first row immediately");await testUtils.fields.many2one.clickOpenDropdown('turtle_trululu');await testUtils.fields.many2one.clickHighlightedItem('turtle_trululu');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal').length,0,"no modal should be displayed");assert.strictEqual($('.o_field_invalid').length,0,"no field should be marked as invalid");assert.containsOnce(form,'.o_data_row',"should wait for the onchange to create the second row");assert.hasClass(form.$('.o_data_row'),'o_selected_row',"first row should still be in edition");prom.resolve();await testUtils.nextTick();assert.containsN(form,'.o_data_row',2,"second row should now have been created");assert.doesNotHaveClass(form.$('.o_data_row:first'),'o_selected_row',"first row should no more be in edition");form.destroy();});QUnit.test('editable list: multiple clicks on Add an item do not create invalid rows',async function(assert){assert.expect(3);this.data.turtle.onchanges={turtle_trululu:function(){},};var prom;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_trululu" required="1"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(prom).then(_.constant(result));}
return result;},});prom=testUtils.makeTestPromise();await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsNone(form,'.o_data_row',"no row should have been created yet (waiting for the onchange)");prom.resolve();await testUtils.nextTick();assert.containsOnce(form,'.o_data_row',"only one row should have been created");assert.hasClass(form.$('.o_data_row:first'),'o_selected_row',"the created row should be in edition");form.destroy();});QUnit.test('editable list: value reset by an onchange',async function(assert){assert.expect(2);this.data.partner.onchanges={datetime:function(obj){obj.turtles=[[5],[0,0,{display_name:'new'}]];},};var prom;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="datetime"/>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(prom).then(_.constant(result));}
return result;},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_data_row .o_field_widget'),'a name');prom=testUtils.makeTestPromise();await testUtils.dom.click(form.$('.o_datepicker_input'));var dateTimeVal=fieldUtils.format.datetime(moment(),{timezone:false});await testUtils.fields.editSelect(form.$('.o_datepicker_input'),dateTimeVal);prom.resolve();await testUtils.nextTick();assert.containsOnce(form,'.o_data_row',"should have one record in the o2m");assert.strictEqual(form.$('.o_data_row .o_data_cell').text(),'new',"should be the record created by the onchange");form.destroy();});QUnit.test('editable list: onchange that returns a warning',async function(assert){assert.expect(5);this.data.turtle.onchanges={display_name:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){assert.step(args.method);return Promise.resolve({value:{},warning:{title:"Warning",message:"You must first select a partner"},});}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},intercepts:{warning:function(){assert.step('warning');},},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.verifySteps(['onchange','warning','onchange','warning']);form.destroy();});QUnit.test('editable list: contexts are correctly sent',async function(assert){assert.expect(5);this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="timmy" context="{\'key\': parent.foo}">'+'<tree editable="top">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='read'&&args.model==='partner'){assert.deepEqual(args.kwargs.context,{active_field:2,bin_size:true,someKey:'some value',},"sent context should be correct");}
if(args.method==='read'&&args.model==='partner_type'){assert.deepEqual(args.kwargs.context,{key:'yop',active_field:2,someKey:'some value',},"sent context should be correct");}
if(args.method==='write'){assert.deepEqual(args.kwargs.context,{active_field:2,someKey:'some value',},"sent context should be correct");}
return this._super.apply(this,arguments);},session:{user_context:{someKey:'some value'},},viewOptions:{mode:'edit',context:{active_field:2},},res_id:1,});await testUtils.dom.click(form.$('.o_data_cell:first'));await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'abc');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('resetting invisible one2manys',async function(assert){assert.expect(3);this.data.partner.records[0].turtles=[];this.data.partner.onchanges.foo=function(obj){obj.turtles=[[5],[4,1]];};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="turtles" invisible="1"/>'+'</form>',viewOptions:{mode:'edit',},res_id:1,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.fields.editInput(form.$('input[name="foo"]'),'abcd');assert.verifySteps(['read','onchange']);form.destroy();});QUnit.test('one2many: onchange that returns unknown field in list, but not in form',async function(assert){assert.expect(5);this.data.partner.onchanges={name:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="name"/>'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form string="Partners">'+'<field name="display_name"/>'+'<field name="timmy" widget="many2many_tags"/>'+'</form>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{p:[[5],[0,0,{display_name:'new',timmy:[[5],[4,12]]}]],},});}
return this._super.apply(this,arguments);},});assert.containsOnce(form,'.o_data_row',"the one2many should contain one row");assert.containsNone(form,'.o_field_widget[name="timmy"]',"timmy should not be displayed in the list view");await testUtils.dom.click(form.$('.o_data_row td:first'));assert.strictEqual($('.modal .o_field_many2manytags[name="timmy"]').length,1,"timmy should be displayed in the form view");assert.strictEqual($('.modal .o_field_many2manytags[name="timmy"] .badge').length,1,"m2mtags should contain one tag");assert.strictEqual($('.modal .o_field_many2manytags[name="timmy"] .o_badge_text').text(),'gold',"tag name should have been correctly loaded");form.destroy();});QUnit.test('multi level of nested x2manys, onchange and rawChanges',async function(assert){assert.expect(8);this.data.partner.records[0].p=[1];this.data.partner.onchanges={name:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="name"/>
                        <field name="p">
                            <tree><field name="display_name"/></tree>
                            <form>
                                <field name="display_name"/>
                                <field name="p">
                                    <tree><field name="display_name"/></tree>
                                    <form><field name="display_name"/></form>
                                </field>
                            </form>
                        </field>
                    </form>`,mockRPC(route,args){if(args.method==='write'){assert.deepEqual(args.args[1].p[0][2],{p:[[1,1,{display_name:'new name'}]],});}
return this._super(...arguments);},res_id:1,});assert.containsOnce(form,'.o_data_row',"the one2many should contain one row");await testUtils.dom.click(form.$('.o_data_row td:first'));assert.containsOnce(document.body,".modal .o_form_readonly");await testUtils.dom.click($('.modal .modal-footer .o_form_button_cancel'));await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_row td:first'));assert.containsOnce(document.body,".modal .o_form_editable");assert.containsOnce(document.body,'.modal .o_data_row',"the one2many should contain one row");await testUtils.dom.click($('.modal .o_data_row td:first'));assert.containsN(document.body,".modal .o_form_editable",2);await testUtils.fields.editInput($('.modal:nth(1) .o_field_widget[name=display_name]'),'new name');await testUtils.dom.click($('.modal:nth(1) .modal-footer .btn-primary'));assert.containsOnce(document.body,".modal .o_form_editable");await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.containsNone(document.body,".modal");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('onchange and required fields with override in arch',async function(assert){assert.expect(4);this.data.partner.onchanges={turtles:function(){}};this.data.turtle.fields.turtle_foo.required=true;this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_int"/>'+'<field name="turtle_foo" required="0"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.verifySteps(['read','onchange','onchange']);form.destroy();});QUnit.test('onchange on a one2many containing a one2many',async function(assert){assert.expect(1);this.data.partner.onchanges={p:function(){}};var checkOnchange=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree><field name="display_name"/></tree>'+'<form>'+'<field name="display_name"/>'+'<field name="p">'+'<tree editable="bottom"><field name="display_name"/></tree>'+'</field>'+'</form>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'&&checkOnchange){assert.strictEqual(args.args[3]['p.p.display_name'],'',"onchange specs should be computed recursively");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));await testUtils.fields.editInput($('.modal .o_data_cell input'),'new record');checkOnchange=true;await testUtils.dom.clickFirst($('.modal .modal-footer .btn-primary'));form.destroy();});QUnit.test('editing tabbed one2many (editable=bottom)',async function(assert){assert.expect(12);this.data.partner.records[0].turtles=[];for(var i=0;i<42;i++){var id=100+i;this.data.turtle.records.push({id:id,turtle_foo:'turtle'+(id-99)});this.data.partner.records[0].turtles.push(id);}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);if(args.method==='write'){assert.strictEqual(args.args[1].turtles[40][0],0,'should send a create command');assert.deepEqual(args.args[1].turtles[40][2],{turtle_foo:'rainbow dash'});}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'tr.o_data_row',41);assert.hasClass(form.$('tr.o_data_row').last(),'o_selected_row');await testUtils.fields.editInput(form.$('.o_data_row input[name="turtle_foo"]'),'rainbow dash');await testUtils.form.clickSave(form);assert.containsN(form,'tr.o_data_row',40);assert.verifySteps(['read','read','onchange','write','read','read']);form.destroy();});QUnit.test('editing tabbed one2many (editable=bottom), again...',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[];for(var i=0;i<9;i++){var id=100+i;this.data.turtle.records.push({id:id,turtle_foo:'turtle'+(id-99)});this.data.partner.records[0].turtles.push(id);}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom" limit="3">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_data_row input[name="turtle_foo"]'),'rainbow dash');await testUtils.dom.click(form.$('.o_x2m_control_panel .o_pager_next'));await testUtils.dom.click(form.$('.o_x2m_control_panel .o_pager_next'));assert.containsN(form,'tr.o_data_row',2,"should have 2 data rows on the current page");form.destroy();});QUnit.test('editing tabbed one2many (editable=top)',async function(assert){assert.expect(15);this.data.partner.records[0].turtles=[];this.data.turtle.fields.turtle_foo.default="default foo";for(var i=0;i<42;i++){var id=100+i;this.data.turtle.records.push({id:id,turtle_foo:'turtle'+(id-99)});this.data.partner.records[0].turtles.push(id);}
var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);if(args.method==='write'){assert.strictEqual(args.args[1].turtles[40][0],0);assert.deepEqual(args.args[1].turtles[40][2],{turtle_foo:'rainbow dash'});}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_widget[name=turtles] .o_pager_next'));assert.containsN(form,'tr.o_data_row',2);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'tr.o_data_row',3);assert.hasClass(form.$('tr.o_data_row').first(),'o_selected_row');assert.strictEqual(form.$('tr.o_data_row input').val(),'default foo',"selected input should have correct string");await testUtils.fields.editInput(form.$('.o_data_row input[name="turtle_foo"]'),'rainbow dash');await testUtils.form.clickSave(form);assert.containsN(form,'tr.o_data_row',40);assert.verifySteps(['read','read','read','onchange','write','read','read']);form.destroy();});QUnit.test('one2many field: change value before pending onchange returns',async function(assert){assert.expect(2);var M2O_DELAY=relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY;relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=0;this.data.partner.onchanges={int_field:function(){}};var prom;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="int_field"/>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(prom).then(_.constant(result));}
return result;},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));prom=testUtils.makeTestPromise();await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),'44');var $dropdown=form.$('.o_field_many2one input').autocomplete('widget');await testUtils.fields.editAndTrigger(form.$('.o_field_many2one input'),'first',['keydown','keyup']);prom.resolve();assert.strictEqual(form.$('.o_field_many2one input').val(),'first','should have kept the new value');await testUtils.nextTick();assert.strictEqual($dropdown.find('li:not(.o_m2o_dropdown_option)').length,1,'autocomplete should contains 1 suggestion');relationalFields.FieldMany2One.prototype.AUTOCOMPLETE_DELAY=M2O_DELAY;form.destroy();});QUnit.test('focus is correctly reset after an onchange in an x2many',async function(assert){assert.expect(2);this.data.partner.onchanges={int_field:function(){}};var prom;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="int_field"/>'+'<button string="hello"/>'+'<field name="qux"/>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(prom).then(_.constant(result));}
return result;},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));prom=testUtils.makeTestPromise();await testUtils.fields.editAndTrigger(form.$('.o_field_widget[name=int_field]'),'44',['input',{type:'keydown',which:$.ui.keyCode.TAB}]);prom.resolve();await testUtils.nextTick();assert.strictEqual(document.activeElement,form.$('.o_field_widget[name=qux]')[0],"qux field should have the focus");await testUtils.fields.many2one.clickOpenDropdown('trululu');await testUtils.fields.many2one.clickHighlightedItem('trululu');assert.strictEqual(form.$('.o_field_many2one input').val(),'first record',"the one2many field should have the expected value");form.destroy();});QUnit.test('checkbox in an x2many that triggers an onchange',async function(assert){assert.expect(1);this.data.partner.onchanges={bar:function(){}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="bar"/>'+'</tree>'+'</field>'+'</form>',});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();await testUtils.dom.click(form.$('.o_field_widget[name=bar] input'));assert.notOk(form.$('.o_field_widget[name=bar] input').prop('checked'),"the checkbox should be unticked");form.destroy();});QUnit.test('one2many with default value: edit line to make it invalid',async function(assert){assert.expect(3);this.data.partner.fields.p.default=[[0,false,{foo:"coucou",int_field:5,p:[]}],];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>'+'</field>'+'</form>',});await testUtils.dom.click(form.$('.o_data_row .o_data_cell:nth(1)'));await testUtils.fields.editInput(form.$('.o_field_widget[name=int_field]'),'e');await testUtils.dom.click(form.$el);assert.containsOnce(form,'.o_data_row.o_selected_row',"line should not have been removed and should still be in edition");assert.strictEqual($('.modal').length,1,"a confirmation dialog should be opened");assert.hasClass(form.$('.o_field_widget[name=int_field]'),'o_field_invalid',"should indicate that int_field is invalid");form.destroy();});QUnit.test('default value for nested one2manys (coming from onchange)',async function(assert){assert.expect(3);this.data.partner.onchanges.p=function(obj){obj.p=[[5],[0,0,{turtles:[[5],[4,1]]}],];};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="p">'+'<tree><field name="turtles"/></tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){assert.strictEqual(args.args[0].p[0][0],0,"should send a command 0 (CREATE) for p");assert.deepEqual(args.args[0].p[0][2],{turtles:[[4,1,false]]},"should send the correct values");}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.o_data_cell').text(),'1 record',"should correctly display the value of the inner o2m");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('display correct value after validation error',async function(assert){assert.expect(4);this.data.partner.onchanges.turtles=function(){};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'){if(args.args[1].turtles[0][2].turtle_foo==='pinky'){return Promise.reject();}}
if(args.method==='write'){assert.deepEqual(args.args[1].turtles[0],[1,2,{turtle_foo:'foo'}],'should send the "good" value');}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit'},res_id:1,});assert.strictEqual(form.$('.o_data_row .o_data_cell:nth(0)').text(),'blip',"initial text should be correct");await testUtils.dom.click(form.$('.o_data_row .o_data_cell:nth(0)'));await testUtils.fields.editInput(form.$('.o_field_widget[name=turtle_foo]'),'foo');await testUtils.dom.click(form.$el);assert.strictEqual(form.$('.o_data_row .o_data_cell:nth(0)').text(),'foo',"field should have been changed to foo");await testUtils.dom.click(form.$('.o_data_row .o_data_cell:nth(0)'));await testUtils.fields.editInput(form.$('.o_field_widget[name=turtle_foo]'),'pinky');await testUtils.dom.click(form.$el);assert.strictEqual(form.$('.o_data_row .o_data_cell:nth(0)').text(),'foo',"turtle_foo text should now be set back to foo");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('propagate context to sub views without default_* keys',async function(assert){assert.expect(7);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.strictEqual(args.kwargs.context.flutter,'shy','view context key should be used for every rpcs');if(args.method==='onchange'){if(args.model==='partner'){assert.strictEqual(args.kwargs.context.default_flutter,'why',"should have default_* values in context for form view RPCs");}else if(args.model==='turtle'){assert.notOk(args.kwargs.context.default_flutter,"should not have default_* values in context for subview RPCs");}}
return this._super.apply(this,arguments);},viewOptions:{context:{flutter:'shy',default_flutter:'why',},},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('input[name="turtle_foo"]'),'pinky pie');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('onchange on nested one2manys',async function(assert){assert.expect(6);this.data.partner.onchanges.display_name=function(obj){if(obj.display_name){obj.p=[[5],[0,0,{display_name:'test',turtles:[[5],[0,0,{display_name:'test nested'}]],}],];}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="display_name"/>'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="turtles">'+'<tree><field name="display_name"/></tree>'+'</field>'+'</form>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){assert.strictEqual(args.args[0].p[0][0],0,"should send a command 0 (CREATE) for p");assert.strictEqual(args.args[0].p[0][2].display_name,'test',"should send the correct values");assert.strictEqual(args.args[0].p[0][2].turtles[0][0],0,"should send a command 0 (CREATE) for turtles");assert.deepEqual(args.args[0].p[0][2].turtles[0][2],{display_name:'test nested'},"should send the correct values");}
return this._super.apply(this,arguments);},});await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'trigger onchange');assert.strictEqual(form.$('.o_data_cell').text(),'test',"should have added the new row to the one2many");await testUtils.dom.click(form.$('.o_data_cell:first'));assert.strictEqual($('.modal .o_data_cell').text(),'test nested',"should have added the new row to the nested one2many");await testUtils.dom.clickFirst($('.modal .modal-footer .btn-primary'));await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many with multiple pages and sequence field',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[3,2,1];this.data.partner.onchanges.turtles=function(){};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="2">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'<field name="partner_ids" invisible="1"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{turtles:[[5],[1,1,{turtle_foo:"from onchange",partner_ids:[[5]]}],]}});}
return this._super(route,args);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_list_record_remove:first button'));assert.strictEqual(form.$('.o_data_row').text(),'from onchange','onchange has been properly applied');form.destroy();});QUnit.test('one2many with multiple pages and sequence field, part2',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[3,2,1];this.data.partner.onchanges.turtles=function(){};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="2">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'<field name="partner_ids" invisible="1"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{turtles:[[5],[1,1,{turtle_foo:"from onchange id2",partner_ids:[[5]]}],[1,3,{turtle_foo:"from onchange id3",partner_ids:[[5]]}],]}});}
return this._super(route,args);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_list_record_remove:first button'));assert.strictEqual(form.$('.o_data_row').text(),'from onchange id2from onchange id3','onchange has been properly applied');form.destroy();});QUnit.test('one2many with sequence field, override default_get, bottom when inline',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[3,2,1];this.data.turtle.fields.turtle_int.default=10;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual($('.o_data_cell').text(),"blipyopkawa");var inputText='ninja';await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_input[name="turtle_foo"]'),inputText);await testUtils.form.clickSave(form);assert.strictEqual($('.o_data_cell').text(),"blipyopkawa"+inputText);form.destroy();});QUnit.test('one2many with sequence field, override default_get, top when inline',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[3,2,1];this.data.turtle.fields.turtle_int.default=10;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual($('.o_data_cell').text(),"blipyopkawa");var inputText='ninja';await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_input[name="turtle_foo"]'),inputText);await testUtils.form.clickSave(form);assert.strictEqual($('.o_data_cell').text(),inputText+"blipyopkawa");form.destroy();});QUnit.test('one2many with sequence field, override default_get, bottom when popup',async function(assert){assert.expect(3);this.data.partner.records[0].turtles=[3,2,1];this.data.turtle.fields.turtle_int.default=10;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree>'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'</tree>'+'<form>'+'<field name="turtle_int" invisible="1"/>'+'<field name="turtle_foo"/>'+'</form>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual($('.o_data_cell').text(),"blipyopkawa");var inputText='ninja';await testUtils.dom.click($('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput($('.o_input[name="turtle_foo"]'),inputText);await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual($('.o_data_cell').text(),"blipyopkawa"+inputText);await testUtils.dom.click($('.o_form_button_save'));assert.strictEqual($('.o_data_cell').text(),"blipyopkawa"+inputText);form.destroy();});QUnit.test('one2many with sequence field, override default_get, not last page',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[3,2,1];this.data.turtle.fields.turtle_int.default=10;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="2">'+'<field name="turtle_int" widget="handle"/>'+'</tree>'+'<form>'+'<field name="turtle_int"/>'+'</form>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.dom.click($('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .o_input[name="turtle_int"]').val(),'10');form.destroy();});QUnit.test('one2many with sequence field, override default_get, last page',async function(assert){assert.expect(1);this.data.partner.records[0].turtles=[3,2,1];this.data.turtle.fields.turtle_int.default=10;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="4">'+'<field name="turtle_int" widget="handle"/>'+'</tree>'+'<form>'+'<field name="turtle_int"/>'+'</form>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.dom.click($('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .o_input[name="turtle_int"]').val(),'22');form.destroy();});QUnit.test('one2many with sequence field, fetch name_get from empty list, field text',async function(assert){assert.expect(4);this.data.turtle.fields.turtle_int.default=10;this.data.turtle.fields.product_id.default=37;this.data.turtle.fields.not_required_product_id={string:"Product",type:"many2one",relation:'product'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_int" widget="handle"/>'+'<field name="turtle_foo"/>'+'<field name="not_required_product_id"/>'+'<field name="turtle_description" widget="text"/>'+'</tree>'+'</field>'+'</form>',viewOptions:{mode:'edit',},});assert.strictEqual($('.o_data_cell:nth-child(2)').text(),"");var inputText1='relax';var inputText2='max';await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_input[name="turtle_foo"]'),inputText1);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_input[name="turtle_foo"]'),inputText2);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.o_data_cell:nth-child(2)').text(),inputText1+inputText2);var $handles=form.$('.ui-sortable-handle');assert.equal($handles.length,3,'There should be 3 sequence handlers');await testUtils.dom.dragAndDrop($handles.eq(1),form.$('tbody tr').first(),{position:'top'});assert.strictEqual($('.o_data_cell:nth-child(2)').text(),inputText2+inputText1);form.destroy();});QUnit.skip('one2many with several pages, onchange and default order',async function(assert){assert.expect(8);var data=this.data;data.partner.records[0].turtles=[1,2,3];data.turtle.records[0].partner_ids=[1];data.partner.onchanges={turtles:function(obj){var res=_.map(obj.turtles,function(command){if(command[0]===1){return command;}
var id=command[1];var record=_.findWhere(data.turtle.records,{id:id});return[1,id,_.pick(record,['turtle_int','turtle_foo','partner_ids'])];});obj.turtles=[[5]].concat(res);},};var form=await createView({View:FormView,model:'partner',data:data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="top" limit="2" default_order="turtle_foo">'+'<field name="turtle_int"/>'+'<field name="turtle_foo" class="foo"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var ids=args.method==='read'?' ['+args.args[0]+']':'';assert.step(args.method+ids);return this._super.apply(this,arguments);},res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_data_cell.foo').text(),'blipkawa',"should display two records out of three, in the correct order");await testUtils.dom.click(form.$('.o_data_cell:first'));await testUtils.fields.editInput(form.$('.o_field_widget[name=turtle_int]'),3);await testUtils.dom.click(form.$el);assert.strictEqual(form.$('.o_data_cell.foo').text(),'blipkawa',"should still display the same two records");assert.verifySteps(['read [1]','read [1,2,3]','read [2,3]','read [2,4]','onchange','read [1]',]);form.destroy();});QUnit.test('new record, with one2many with more default values than limit',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="2">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',context:{default_turtles:[1,2,3]},viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_data_row').text(),'yopblip','data has been properly loaded');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_data_row').text(),'yopblip','data has been properly saved');form.destroy();});QUnit.test('add a new line after limit is reached should behave nicely',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[1,2,3];this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5],[1,1,{turtle_foo:"yop"}],[1,2,{turtle_foo:"blip"}],[1,3,{turtle_foo:"kawa"}],[0,obj.turtles[3][2],{turtle_foo:"abc"}],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree limit="3" editable="bottom">'+'<field name="turtle_foo" required="1"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsN(form,'.o_data_row',4,'should have 4 data rows');await testUtils.fields.editInput(form.$('.o_input[name="turtle_foo"]'),'a');assert.containsN(form,'.o_data_row',4,'should still have 4 data rows (the limit is increased to 4)');form.destroy();});QUnit.test('onchange in a one2many with non inline view on an existing record',async function(assert){assert.expect(6);this.data.partner.fields.sequence={string:'Sequence',type:'integer'};this.data.partner.records[0].sequence=1;this.data.partner.records[1].sequence=2;this.data.partner.onchanges={sequence:function(){}};this.data.partner_type.fields.partner_ids={string:"Partner",type:"one2many",relation:'partner'};this.data.partner_type.records[0].partner_ids=[1,2];var form=await createView({View:FormView,model:'partner_type',data:this.data,arch:'<form><field name="partner_ids"/></form>',archs:{'partner,false,list':'<tree string="Vendors">'+'<field name="sequence" widget="handle"/>'+'<field name="display_name"/>'+'</tree>',},res_id:12,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},viewOptions:{mode:'edit'},});await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle:eq(1)'),form.$('tbody tr').first(),{position:'top'});assert.verifySteps(['load_views','read','read','onchange','onchange']);form.destroy();});QUnit.test('onchange in a one2many with non inline view on a new record',async function(assert){assert.expect(6);this.data.turtle.onchanges={display_name:function(obj){if(obj.display_name){obj.turtle_int=44;}},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="turtles"/></form>',archs:{'turtle,false,list':'<tree editable="bottom">'+'<field name="display_name"/>'+'<field name="turtle_int"/>'+'</tree>',},mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_data_row .o_field_widget[name=display_name]'),'a name');assert.strictEqual(form.$('.o_data_row .o_field_widget[name=turtle_int]').val(),"44","should have triggered the onchange");assert.verifySteps(['load_views','onchange','onchange','onchange',]);form.destroy();});QUnit.test('add a line, edit it and "Save & New"',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree><field name="display_name"/></tree>'+'<form><field name="display_name"/></form>'+'</field>'+'</form>',});assert.containsNone(form,'.o_data_row',"there should be no record in the relation");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput($('.modal .o_field_widget'),'new record');await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual(form.$('.o_data_row .o_data_cell').text(),'new record',"should display the new record");await testUtils.dom.click(form.$('.o_data_row .o_data_cell'));await testUtils.fields.editInput($('.modal .o_field_widget'),'new record edited');await testUtils.dom.click($('.modal .modal-footer .btn-primary:nth(1)'));assert.strictEqual($('.modal').length,1,"the model should still be open");assert.strictEqual($('.modal .o_field_widget').text(),'',"should have cleared the input");await testUtils.fields.editInput($('.modal .o_field_widget'),'another new record');await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual(form.$('.o_data_row .o_data_cell').text(),'new record editedanother new record',"should display the two records");form.destroy();});QUnit.test('o2m add a line custom control create editable',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="bottom">'+'<control>'+'<create string="Add food" context="" />'+'<create string="Add pizza" context="{\'default_display_name\': \'pizza\'}"/>'+'</control>'+'<control>'+'<create string="Add pasta" context="{\'default_display_name\': \'pasta\'}"/>'+'</control>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',});var $td=form.$('.o_field_x2many_list_row_add');assert.strictEqual($td.length,1);assert.strictEqual($td.closest('tr').find('td').length,1);assert.strictEqual($td.text(),"Add foodAdd pizzaAdd pasta");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a:eq(0)'));assert.strictEqual($('.o_data_cell').text(),"");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a:eq(1)'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a:eq(2)'));await testUtils.form.clickSave(form);assert.strictEqual($('.o_data_cell').text(),"pizzapasta");form.destroy();});QUnit.test('o2m add a line custom control create non-editable',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<control>'+'<create string="Add food" context="" />'+'<create string="Add pizza" context="{\'default_display_name\': \'pizza\'}" />'+'</control>'+'<control>'+'<create string="Add pasta" context="{\'default_display_name\': \'pasta\'}" />'+'</control>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',});var $td=form.$('.o_field_x2many_list_row_add');assert.strictEqual($td.length,1);assert.strictEqual($td.closest('tr').find('td').length,1);assert.strictEqual($td.text(),"Add foodAdd pizzaAdd pasta");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a:eq(0)'));await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual($('.o_data_cell').text(),"");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a:eq(1)'));await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual($('.o_data_cell').text(),"pizza");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a:eq(2)'));await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual($('.o_data_cell').text(),"pizzapasta");form.destroy();});QUnit.test('o2m add a line custom control create align with handle',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="int_field" widget="handle"/>'+'</tree>'+'</field>'+'</form>',});var $tr=form.$('.o_field_x2many_list_row_add').closest('tr');assert.strictEqual($tr.find('td').length,2);assert.strictEqual($tr.find('td:eq(0)').text(),"");assert.strictEqual($tr.find('td:eq(1)').text(),"Add a line");form.destroy();});QUnit.test('one2many form view with action button',async function(assert){assert.expect(7);var data=this.data;data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:data,res_id:1,arch:'<form string="Partners">'+'<field name="p">'+'<tree><field name="display_name"/></tree>'+'<form>'+'<button type="action" string="Set Timmy"/>'+'<field name="timmy"/>'+'</form>'+'</field>'+'</form>',archs:{'partner_type,false,list':'<tree><field name="display_name"/></tree>',},intercepts:{execute_action:function(ev){data.partner.records[1].display_name='new name';data.partner.records[1].timmy=[12];ev.data.on_closed();},},viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_data_row',"there should be one record in the one2many");assert.strictEqual(form.$('.o_data_cell').text(),'second record',"initial display_name of o2m record should be correct");await testUtils.dom.click(form.$('.o_data_cell:first'));assert.strictEqual($('.modal .o_form_view').length,1,"should have opened the form view in a dialog");assert.strictEqual($('.modal .o_form_view .o_data_row').length,0,"there should be no record in the many2many");await testUtils.dom.click($('.modal .o_form_view button'));assert.strictEqual($('.modal .o_data_row').length,1,"fields in the o2m form view should have been read");assert.strictEqual($('.modal .o_data_cell').text(),'gold',"many2many subrecord should have been fetched");await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(form.$('.o_data_cell').text(),'new name',"fields in the o2m list view should have been read as well");form.destroy();});QUnit.test('onchange affecting inline unopened list view',async function(assert){assert.expect(5);var numUserOnchange=0;this.data.user.onchanges={partner_ids:function(obj){if(numUserOnchange===0){obj.partner_ids=[[5],[1,1,{display_name:'first record',turtles:[[5],[1,2,{'display_name':'donatello'}],],}],[1,2,{display_name:'second record',turtles:[[5],obj.partner_ids[1][2].turtles[0],],}],];}
numUserOnchange++;},};var form=await createView({View:FormView,model:'user',data:this.data,arch:'<form><sheet><group>'+'<field name="partner_ids">'+'<form>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</group></sheet></form>',res_id:17,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_row:eq(1)'));await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));$('.modal input[name="display_name"]').val('michelangelo').change();await testUtils.dom.click($('.modal .btn-primary'));await testUtils.dom.click(form.$('.o_data_row:eq(0)'));await testUtils.dom.click($('.modal .btn-primary'));await testUtils.form.clickSave(form);assert.strictEqual(numUserOnchange,2,'there should 2 and only 2 onchange from closing the partner modal');await testUtils.dom.click(form.$('.o_data_row:eq(0)'));assert.strictEqual($('.modal .o_data_row').length,1,'only 1 turtle for first partner');assert.strictEqual($('.modal .o_data_row').text(),'donatello','first partner turtle is donatello');await testUtils.dom.click($('.modal .o_form_button_cancel'));await testUtils.dom.click(form.$('.o_data_row:eq(1)'));assert.strictEqual($('.modal .o_data_row').length,1,'only 1 turtle for second partner');assert.strictEqual($('.modal .o_data_row').text(),'michelangelo','second partner turtle is michelangelo');await testUtils.dom.click($('.modal .o_form_button_cancel'));form.destroy();});QUnit.test('click on URL should not open the record',async function(assert){assert.expect(2);this.data.partner.records[0].turtles=[1];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree>'+'<field name="display_name" widget="email"/>'+'<field name="turtle_foo" widget="url"/>'+'</tree>'+'<form></form>'+'</field>'+'</form>',res_id:1,});await testUtils.dom.click(form.$('.o_email_cell a'));assert.strictEqual($('.modal .o_form_view').length,0,'click should not open the modal');await testUtils.dom.click(form.$('.o_url_cell a'));assert.strictEqual($('.modal .o_form_view').length,0,'click should not open the modal');form.destroy();});QUnit.test('create and edit on m2o in o2m, and press ESCAPE',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles">'+'<tree editable="top">'+'<field name="turtle_trululu"/>'+'</tree>'+'</field>'+'</form>',archs:{'partner,false,form':'<form><field name="display_name"/></form>',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(form,'.o_selected_row',"should have create a new row in edition");await testUtils.fields.many2one.createAndEdit('turtle_trululu',"ABC");assert.strictEqual($('.modal .o_form_view').length,1,"should have opened a form view in a dialog");await testUtils.fields.triggerKeydown($('.modal .o_form_view .o_field_widget[name=display_name]'),'escape');assert.strictEqual($('.modal .o_form_view').length,0,"should have closed the dialog");assert.containsOnce(form,'.o_selected_row',"new row should still be present");form.destroy();});QUnit.test('one2many add a line should not crash if orderedResIDs is not set',async function(assert){assert.expect(0);this.data.partner.records[0].turtles=[];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="post" type="object" string="Validate" class="oe_highlight"/>'+'</header>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',viewOptions:{mode:'edit',},intercepts:{execute_action:function(event){event.data.on_fail();},},});await testUtils.dom.click($('button[name="post"]'));await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.destroy();});QUnit.test('one2many shortcut tab should not crash when there is no input widget',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo" widget="text"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_input[name="turtle_foo"]'),'ninja');await testUtils.fields.triggerKeydown(form.$('.o_input[name="turtle_foo"]'),'tab');assert.strictEqual(form.$('.o_field_text').text(),'blipninja','current line should be saved');assert.containsOnce(form,'textarea.o_field_text','new line should be created');form.destroy();});QUnit.test('one2many with onchange, required field, shortcut enter',async function(assert){assert.expect(5);this.data.turtle.onchanges={turtle_foo:function(){},};var prom;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo" required="1"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(prom).then(_.constant(result));}
return result;},fieldDebounce:5000,});var value="hello";await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));prom=testUtils.makeTestPromise();var $input=form.$('input[name="turtle_foo"]');await testUtils.fields.editInput($input,value);await testUtils.fields.triggerKeydown($input,'enter');assert.strictEqual($input.val(),value,"input content shouldn't change");assert.containsOnce(form,'.o_data_row',"should still contain only one row");prom.resolve();await testUtils.nextTick();assert.strictEqual(form.$('td.o_data_cell').text(),value);assert.strictEqual(form.$('input[name="turtle_foo"]').val(),'');assert.containsN(form,'.o_data_row',2,"should now contain two rows");form.destroy();});QUnit.test('no deadlock when leaving a one2many line with uncommitted changes',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},fieldDebounce:5000,});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_field_widget[name=turtles] input'),'some foo value');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_form_readonly',"form view should be in readonly");assert.strictEqual(form.$('.o_data_row').text(),'some foo value',"foo field should have correct value");assert.verifySteps(['onchange','onchange','onchange','create','read','read',]);form.destroy();});QUnit.test('one2many with extra field from server not in form',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p" >'+'<tree>'+'<field name="datetime"/>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{'partner,false,form':'<form>'+'<field name="display_name"/>'+'</form>'},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/write'){args.args[1].p[0][2].datetime='2018-04-05 12:00:00';}
return this._super.apply(this,arguments);}});await testUtils.form.clickEdit(form);var x2mList=form.$('.o_field_x2many_list[name=p]');await testUtils.dom.click(x2mList.find('.o_field_x2many_list_row_add a'));var modal=$('.modal-lg');var nameInput=modal.find('input.o_input[name=display_name]');await testUtils.fields.editInput(nameInput,'michelangelo');await testUtils.dom.click(modal.find('.btn-primary').first());assert.equal(x2mList.find('.o_data_row').length,1,'There should be 1 records in the x2m list');var newlyAdded=x2mList.find('.o_data_row').eq(0);assert.equal(newlyAdded.find('.o_data_cell').first().text(),'','The create_date field should be empty');assert.equal(newlyAdded.find('.o_data_cell').eq(1).text(),'michelangelo','The display name field should have the right value');await testUtils.form.clickSave(form);x2mList=form.$('.o_field_x2many_list[name=p]');assert.equal(x2mList.find('.o_data_row').length,1,'There should be 1 records in the x2m list');newlyAdded=x2mList.find('.o_data_row').eq(0);assert.equal(newlyAdded.find('.o_data_cell').first().text(),'04/05/2018 12:00:00','The create_date field should have the right value');assert.equal(newlyAdded.find('.o_data_cell').eq(1).text(),'michelangelo','The display name field should have the right value');form.destroy();});QUnit.test('one2many invisible depends on parent field',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="bar"/>'+'<field name="p">'+'<tree>'+'<field name="foo" attrs="{\'column_invisible\': [(\'parent.product_id\', \'!=\', False)]}"/>'+'<field name="bar" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.containsN(form,'th',2,"should be 2 columns in the one2many");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_many2one[name="product_id"] input'));await testUtils.dom.click($('li.ui-menu-item a:contains(xpad)').trigger('mouseenter'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column when the product_id is set");await testUtils.fields.editAndTrigger(form.$('.o_field_many2one[name="product_id"] input'),'','keyup');await testUtils.owlCompatibilityNextTick();assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns in the one2many when product_id is not set");await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column after the value change");form.destroy();});QUnit.test('column_invisible attrs on a button in a one2many list',async function(assert){assert.expect(6);this.data.partner.records[0].p=[2];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="product_id"/>
                        <field name="p">
                            <tree>
                                <field name="foo"/>
                                <button name="abc" string="Do it" class="some_button" attrs="{'column_invisible': [('parent.product_id', '=', False)]}"/>
                            </tree>
                        </field>
                    </form>`,res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'');assert.containsN(form,'.o_list_table th',2);assert.containsNone(form,'.some_button');await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'xphone');assert.containsN(form,'.o_list_table th',3);assert.containsOnce(form,'.some_button');form.destroy();});QUnit.test('column_invisible attrs on adjacent buttons',async function(assert){assert.expect(14);this.data.partner.records[0].p=[2];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="product_id"/>
                        <field name="trululu"/>
                        <field name="p">
                            <tree>
                                <button name="abc1" string="Do it 1" class="some_button1"/>
                                <button name="abc2" string="Do it 2" class="some_button2" attrs="{'column_invisible': [('parent.product_id', '!=', False)]}"/>
                                <field name="foo"/>
                                <button name="abc3" string="Do it 3" class="some_button3" attrs="{'column_invisible': [('parent.product_id', '!=', False)]}"/>
                                <button name="abc4" string="Do it 4" class="some_button4" attrs="{'column_invisible': [('parent.trululu', '!=', False)]}"/>
                            </tree>
                        </field>
                    </form>`,res_id:1,viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'');assert.strictEqual(form.$('.o_field_widget[name=trululu] input').val(),'aaa');assert.containsN(form,'.o_list_table th',4);assert.containsOnce(form,'.some_button1');assert.containsOnce(form,'.some_button2');assert.containsOnce(form,'.some_button3');assert.containsNone(form,'.some_button4');await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'xphone');assert.strictEqual(form.$('.o_field_widget[name=trululu] input').val(),'aaa');assert.containsN(form,'.o_list_table th',3);assert.containsOnce(form,'.some_button1');assert.containsNone(form,'.some_button2');assert.containsNone(form,'.some_button3');assert.containsNone(form,'.some_button4');form.destroy();});QUnit.test('one2many column visiblity depends on onchange of parent field',async function(assert){assert.expect(3);this.data.partner.records[0].p=[2];this.data.partner.records[0].bar=false;this.data.partner.onchanges.p=function(obj){if(obj.p.length>1&&obj.p[1][2].foo==='New line'){obj.bar=true;}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar"/>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="int_field" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.containsOnce(form,'th',"should be only 1 column ('foo') in the one2many");assert.containsOnce(form,'.o_list_view .o_data_row',"should contain one row");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.$('.o_field_one2many input:first').focus();await testUtils.fields.editInput(form.$('.o_field_one2many input:first'),'New line');await testUtils.dom.click(form.$el);assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns('foo' + 'int_field')");form.destroy();});QUnit.test('one2many column_invisible on view not inline',async function(assert){assert.expect(4);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'<notebook>'+'<page string="Partner page">'+'<field name="bar"/>'+'<field name="p"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,archs:{'partner,false,list':'<tree>'+'<field name="foo" attrs="{\'column_invisible\': [(\'parent.product_id\', \'!=\', False)]}"/>'+'<field name="bar" attrs="{\'column_invisible\': [(\'parent.bar\', \'=\', False)]}"/>'+'</tree>',},});assert.containsN(form,'th',2,"should be 2 columns in the one2many");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_many2one[name="product_id"] input'));await testUtils.dom.click($('li.ui-menu-item a:contains(xpad)').trigger('mouseenter'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column when the product_id is set");await testUtils.fields.editAndTrigger(form.$('.o_field_many2one[name="product_id"] input'),'','keyup');await testUtils.owlCompatibilityNextTick();assert.containsN(form,'th:not(.o_list_record_remove_header)',2,"should be 2 columns in the one2many when product_id is not set");await testUtils.dom.click(form.$('.o_field_boolean[name="bar"] input'));await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'th:not(.o_list_record_remove_header)',"should be 1 column after the value change");form.destroy();});QUnit.test('field context is correctly passed to x2m subviews',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles" context="{\'some_key\': 1}">'+'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<div>'+'<t t-if="context.some_key">'+'<field name="turtle_foo"/>'+'</t>'+'</div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,1,"should have a record in the relation");assert.strictEqual(form.$('.o_kanban_record span:contains(blip)').length,1,"condition in the kanban template should have been correctly evaluated");form.destroy();});QUnit.test('one2many kanban with widget handle',async function(assert){assert.expect(5);this.data.partner.records[0].turtles=[1,2,3];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles">'+'<kanban>'+'<field name="turtle_int" widget="handle"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div><field name="turtle_foo"/></div>'+'</t>'+'</templates>'+'</kanban>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{turtles:[[1,2,{turtle_int:0}],[1,3,{turtle_int:1}],[1,1,{turtle_int:2}],],});}
return this._super.apply(this,arguments);},res_id:1,});assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').text(),'yopblipkawa');assert.doesNotHaveClass(form.$('.o_field_one2many .o_kanban_view'),'ui-sortable');await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_field_one2many .o_kanban_view'),'ui-sortable');var $record=form.$('.o_field_one2many[name=turtles] .o_kanban_view .o_kanban_record:first');var $to=form.$('.o_field_one2many[name=turtles] .o_kanban_view .o_kanban_record:nth-child(3)');await testUtils.dom.dragAndDrop($record,$to,{position:"bottom"});assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').text(),'blipkawayop');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2many editable list: edit and click on add a line',async function(assert){assert.expect(9);this.data.turtle.onchanges={turtle_int:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles">'+'<tree editable="bottom"><field name="turtle_int"/></tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){assert.step('onchange');}
return this._super.apply(this,arguments);},fieldDebounce:100000,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_data_row');await testUtils.dom.click(form.$('.o_data_row:first .o_data_cell:first'));assert.hasClass(form.$('.o_data_row:first'),'o_selected_row');await testUtils.fields.editInput(form.$('.o_selected_row input[name=turtle_int]'),'44');assert.verifySteps([]);var $addLine=form.$('.o_field_x2many_list_row_add a');testUtils.dom.triggerEvents($addLine,'mousedown');testUtils.dom.triggerEvents(form.$('.o_selected_row input[name=turtle_int]'),'change');await testUtils.nextTick();await testUtils.dom.triggerEvents($addLine,['mouseup','click']);assert.verifySteps(['onchange','onchange']);assert.containsN(form,'.o_data_row',2);assert.strictEqual(form.$('.o_data_row:first').text(),'44');assert.hasClass(form.$('.o_data_row:nth(1)'),'o_selected_row');form.destroy();});QUnit.test('many2manys inside a one2many are fetched in batch after onchange',async function(assert){assert.expect(6);this.data.partner.onchanges={turtles:function(obj){obj.turtles=[[5],[1,1,{turtle_foo:"leonardo",partner_ids:[[4,2]],}],[1,2,{turtle_foo:"donatello",partner_ids:[[4,2],[4,4]],}],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles">'+'<tree editable="bottom">'+'<field name="turtle_foo"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</form>',enableBasicModelBachedRPCs:true,mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='read'){assert.deepEqual(args.args[0],[2,4],'should read the partner_ids once, batched');}
return this._super.apply(this,arguments);},});assert.containsN(form,'.o_data_row',2);assert.strictEqual(form.$('.o_field_widget[name="partner_ids"]').text().replace(/\s/g,''),"secondrecordsecondrecordaaa");assert.verifySteps(['onchange','read']);form.destroy();});QUnit.test('two one2many fields with same relation and onchanges',async function(assert){assert.expect(6);this.data.partner.fields.turtles2={string:"Turtles 2",type:"one2many",relation:'turtle',relation_field:'turtle_trululu',};this.data.partner.onchanges={turtles:function(obj){if(obj.turtles.length){obj.turtles=[[5]].concat(obj.turtles);obj.turtles2=obj.turtles;}},turtles2:function(obj){if(obj.turtles2.length){obj.turtles2=[[5]].concat(obj.turtles2);}}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="turtles">'+'<tree editable="bottom"><field name="name" required="1"/></tree>'+'</field>'+'<field name="turtles2">'+'<tree editable="bottom"><field name="name" required="1"/></tree>'+'</field>'+'</form>',});await testUtils.dom.click(form.$('.o_field_widget[name="turtles"] .o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_field_widget[name="turtles"] .o_field_widget[name="name"]'),'ABC');assert.containsOnce(form,'.o_field_widget[name="turtles"] .o_data_row','line of first o2m should have been created');assert.containsOnce(form,'.o_field_widget[name="turtles2"] .o_data_row','line of second o2m should have been created');await testUtils.dom.click(form.$('.o_field_widget[name="turtles2"] .o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('.o_field_widget[name="turtles2"] .o_field_widget[name="name"]'),'DEF');assert.containsOnce(form,'.o_field_widget[name="turtles"] .o_data_row','we should still have 1 line in turtles');assert.containsN(form,'.o_field_widget[name="turtles2"] .o_data_row',2,'we should have 2 lines in turtles2');assert.hasClass(form.$('.o_field_widget[name="turtles2"] .o_data_row:nth(1)'),'o_selected_row','second row should be in edition');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget[name="turtles2"] .o_data_row').text(),'ABCDEF');form.destroy();});QUnit.test('column widths are kept when adding first record in o2m',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="top">'+'<field name="date"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',});var width=form.$('th[data-name="date"]')[0].offsetWidth;await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(form,'.o_data_row');assert.strictEqual(form.$('th[data-name="date"]')[0].offsetWidth,width);form.destroy();});QUnit.test('column widths are kept when editing a record in o2m',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="top">'+'<field name="date"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});var width=form.$('th[data-name="date"]')[0].offsetWidth;await testUtils.dom.click(form.$('.o_data_row .o_data_cell:first'));assert.strictEqual(form.$('th[data-name="date"]')[0].offsetWidth,width);var longVal='Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed blandit, '+'justo nec tincidunt feugiat, mi justo suscipit libero, sit amet tempus ipsum '+'purus bibendum est.';await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),longVal);assert.strictEqual(form.$('th[data-name="date"]')[0].offsetWidth,width);form.destroy();});QUnit.test('column widths are kept when remove last record in o2m',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="top">'+'<field name="date"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{mode:'edit',},});var width=form.$('th[data-name="date"]')[0].offsetWidth;await testUtils.dom.click(form.$('.o_data_row .o_list_record_remove'));assert.strictEqual(form.$('th[data-name="date"]')[0].offsetWidth,width);form.destroy();});QUnit.test('column widths are correct after toggling optional fields',async function(assert){assert.expect(2);var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="top">'+'<field name="date" required="1"/>'+'<field name="foo"/>'+'<field name="int_field" optional="1"/>'+'</tree>'+'</field>'+'</form>',services:{local_storage:RamStorageService,},});let width=form.$('th[data-name="date"]')[0].offsetWidth;await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('th[data-name="date"]')[0].offsetWidth,width);await testUtils.dom.click(form.$('.o_optional_columns_dropdown_toggle'));await testUtils.dom.click(form.$('div.o_optional_columns div.dropdown-item input'));assert.strictEqual(form.$('th[data-name="date"]')[0].offsetWidth,width);form.destroy();});QUnit.test('editable one2many list with oe_read_only button',async function(assert){assert.expect(9);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form>
                        <field name="turtles">
                            <tree editable="bottom">
                                <field name="turtle_foo"/>
                                <button name="do_it" type="object" class="oe_read_only"/>
                            </tree>
                        </field>
                    </form>`,res_id:1,});assert.containsN(form,'.o_list_view thead th:visible',2);assert.containsN(form,'.o_list_view tbody .o_data_row td:visible',2);assert.containsN(form,'.o_list_view tfoot td:visible',2);assert.containsNone(form,'.o_list_record_remove_header');await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.containsN(form,'.o_list_view thead th:visible',2);assert.containsN(form,'.o_list_view tbody .o_data_row td:visible',2);assert.containsN(form,'.o_list_view tfoot td:visible',2);assert.containsOnce(form,'.o_list_record_remove_header');form.destroy();});QUnit.test('one2many reset by onchange (of another field) while being edited',async function(assert){assert.expect(3);const prom=testUtils.makeTestPromise();this.data.partner.onchanges={trululu:obj=>{obj.p=[[5]].concat(obj.p);},};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="trululu"/>
                        <field name="p">
                            <tree editable="top"><field name="product_id" required="1"/></tree>
                        </field>
                    </form>`,mockRPC:function(route,args){const result=this._super.apply(this,arguments);if(args.method==='name_create'){return prom.then(()=>result);}
return result;},});await testUtils.fields.many2one.searchAndClickItem('trululu',{search:'new value'});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsNone(form,'.o_data_row');prom.resolve();await testUtils.nextTick();await testUtils.owlCompatibilityNextTick();assert.containsOnce(form,'.o_data_row');assert.hasClass(form.$('.o_data_row'),'o_selected_row');form.destroy();});QUnit.skip('one2many with many2many_tags in list and list in form with a limit',async function(assert){assert.expect(6);this.data.partner.records[0].p=[1];this.data.partner.records[0].turtles=[1,2,3];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="bar"/>
                        <field name="p">
                            <tree>
                                <field name="turtles" widget="many2many_tags"/>
                            </tree>
                            <form>
                                <field name="turtles">
                                    <tree limit="2"><field name="display_name"/></tree>
                                </field>
                            </form>
                        </field>
                    </form>`,res_id:1,});assert.containsOnce(form,'.o_field_widget[name=p] .o_data_row');assert.containsN(form,'.o_data_row .o_field_many2manytags .badge',3);await testUtils.dom.click(form.$('.o_data_row'));assert.containsOnce(document.body,'.modal .o_form_view');assert.containsN(document.body,'.modal .o_field_widget[name=turtles] .o_data_row',2);assert.isVisible($('.modal .o_field_x2many_list .o_pager'));assert.strictEqual($(".modal .o_field_x2many_list .o_pager").text().trim(),'1-2 / 3');form.destroy();});QUnit.test('one2many with many2many_tags in list and list in form, and onchange',async function(assert){assert.expect(8);this.data.partner.onchanges={bar:function(obj){obj.p=[[5],[0,0,{turtles:[[5],[0,0,{display_name:'new turtle',}]],}]];},};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="bar"/>
                        <field name="p">
                            <tree>
                                <field name="turtles" widget="many2many_tags"/>
                            </tree>
                            <form>
                                <field name="turtles">
                                    <tree editable="bottom"><field name="display_name"/></tree>
                                </field>
                            </form>
                        </field>
                    </form>`,});assert.containsOnce(form,'.o_field_widget[name=p] .o_data_row');assert.containsOnce(form,'.o_data_row .o_field_many2manytags .badge');await testUtils.dom.click(form.$('.o_data_row'));assert.containsOnce(document.body,'.modal .o_form_view');assert.containsOnce(document.body,'.modal .o_field_widget[name=turtles] .o_data_row');assert.strictEqual($('.modal .o_field_widget[name=turtles] .o_data_row').text(),'new turtle');await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));assert.containsN(document.body,'.modal .o_field_widget[name=turtles] .o_data_row',2);assert.strictEqual($('.modal .o_field_widget[name=turtles] .o_data_row:first').text(),'new turtle');assert.hasClass($('.modal .o_field_widget[name=turtles] .o_data_row:nth(1)'),'o_selected_row');form.destroy();});QUnit.test('one2many with many2many_tags in list and list in form, and onchange (2)',async function(assert){assert.expect(7);this.data.partner.onchanges={bar:function(obj){obj.p=[[5],[0,0,{turtles:[[5],[0,0,{display_name:'new turtle',}]],}]];},};this.data.turtle.onchanges={turtle_foo:function(obj){obj.display_name=obj.turtle_foo;},};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="bar"/>
                        <field name="p">
                            <tree>
                                <field name="turtles" widget="many2many_tags"/>
                            </tree>
                            <form>
                                <field name="turtles">
                                    <tree editable="bottom">
                                        <field name="turtle_foo" required="1"/>
                                    </tree>
                                </field>
                            </form>
                        </field>
                    </form>`,});assert.containsOnce(form,'.o_field_widget[name=p] .o_data_row');await testUtils.dom.click(form.$('.o_data_row'));assert.containsOnce(document.body,'.modal .o_form_view');await testUtils.dom.click($('.modal .o_field_x2many_list_row_add a'));assert.containsN(document.body,'.modal .o_field_widget[name=turtles] .o_data_row',2);await testUtils.fields.editInput($('.modal .o_selected_row input'),'another one');await testUtils.modal.clickButton('Save & Close');assert.containsNone(document.body,'.modal');assert.containsOnce(form,'.o_field_widget[name=p] .o_data_row');assert.containsN(form,'.o_data_row .o_field_many2manytags .badge',2);assert.strictEqual(form.$('.o_data_row .o_field_many2manytags .o_badge_text').text(),'new turtleanother one');form.destroy();});QUnit.test('one2many value returned by onchange with unknown fields',async function(assert){assert.expect(3);this.data.partner.onchanges={bar:function(obj){obj.p=[[5],[0,0,{bar:true,display_name:"coucou",trululu:[2,'second record'],turtles:[[5],[0,0,{turtle_int:4}]],}]];},};const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="bar"/>
                        <field name="p" widget="many2many_tags"/>
                    </form>`,mockRPC(route,args){if(args.method==='create'){assert.deepEqual(args.args[0].p[0][2],{bar:true,display_name:"coucou",trululu:2,turtles:[[5],[0,0,{turtle_int:4}]],});}
return this._super(...arguments);},});assert.containsOnce(form,'.o_field_many2manytags .badge');assert.strictEqual(form.$('.o_field_many2manytags .o_badge_text').text(),'coucou');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('mounted is called only once for x2many control panel',async function(assert){assert.expect(5);const PadLikeWidget=fieldRegistry.get('char').extend({start(){this._setValue("some value");}});fieldRegistry.add('pad_like',PadLikeWidget);let resolveCP;const prom=new Promise(r=>{resolveCP=r;});ControlPanel.patch('cp_patch_mock',T=>class extends T{constructor(){super(...arguments);owl.hooks.onMounted(()=>{assert.step('mounted');});owl.hooks.onWillUnmount(()=>{assert.step('willUnmount');});}
async update(){await prom;super.update(...arguments);}});const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="foo" widget="pad_like"/>
                        <field name="p">
                            <tree><field name="display_name"/></tree>
                        </field>
                    </form>`,viewOptions:{withControlPanel:false,},});assert.verifySteps(['mounted']);resolveCP();await testUtils.nextTick();assert.verifySteps([]);ControlPanel.unpatch('cp_patch_mock');delete fieldRegistry.map.pad_like;form.destroy();assert.verifySteps(["willUnmount"]);});QUnit.test('one2many: internal state is updated after another field changes',async function(assert){assert.expect(2);let o2m;testUtils.patch(FieldOne2Many,{init(){this._super(...arguments);o2m=this;},});const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="display_name"/>
                        <field name="p">
                            <tree><field name="display_name"/></tree>
                        </field>
                    </form>`,});assert.strictEqual(o2m.recordData.display_name,false);await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'val');assert.strictEqual(o2m.recordData.display_name,"val");form.destroy();testUtils.unpatch(FieldOne2Many);});});});});;

/* /web/static/tests/fields/signature_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.signature_field_tests',function(require){"use strict";var ajax=require('web.ajax');var core=require('web.core');var FormView=require('web.FormView');var testUtils=require('web.test_utils');var createView=testUtils.createView;QUnit.module('fields',{},function(){QUnit.module('signature',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Name",type:"char"},product_id:{string:"Product Name",type:"many2one",relation:'product'},sign:{string:"Signature",type:"binary"},},records:[{id:1,display_name:"Pop's Chock'lit",product_id:7,}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:7,display_name:"Veggie Burger",}]},};}},function(){QUnit.module('Signature Field',{before:function(){return ajax.loadXML('/web/static/src/xml/name_and_signature.xml',core.qweb);},});QUnit.test('Set simple field in "full_name" node option',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form>'+'<field name="display_name"/>'+'<field name="sign" widget="signature" options="{\'full_name\': \'display_name\'}" />'+'</form>',mockRPC:function(route,args){if(route==='/web/sign/get_fonts/'){return Promise.resolve();}
return this._super(route,args);},});await testUtils.form.clickEdit(form);assert.containsOnce(form,'div[name=sign] div.o_signature svg',"should have a valid signature widget");await testUtils.dom.click(form.$('div[name=sign] div.o_signature'));assert.strictEqual($('.modal .modal-body a.o_web_sign_auto_button').length,1,'should open a modal with "Auto" button');assert.strictEqual($('.modal .modal-body .o_web_sign_name_input').val(),"Pop's Chock'lit",'Correct Value should be set in the input for auto drawing the signature');form.destroy();});QUnit.test('Set m2o field in "full_name" node option',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form>'+'<field name="product_id"/>'+'<field name="sign" widget="signature" options="{\'full_name\': \'product_id\'}" />'+'</form>',mockRPC:function(route,args){if(route==='/web/sign/get_fonts/'){return Promise.resolve();}
return this._super(route,args);},});await testUtils.form.clickEdit(form);assert.containsOnce(form,'div[name=sign] div.o_signature svg',"should have a valid signature widget");await testUtils.dom.click(form.$('div[name=sign] div.o_signature'));assert.strictEqual($('.modal .modal-body a.o_web_sign_auto_button').length,1,'should open a modal with "Auto" button');assert.strictEqual($('.modal .modal-body .o_web_sign_name_input').val(),"Veggie Burger",'Correct Value should be set in the input for auto drawing the signature');form.destroy();});QUnit.module('Signature Widget');QUnit.test('Signature widget renders a Sign button',async function(assert){assert.expect(3);const form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form>'+'<header>'+'<widget name="signature" string="Sign"/>'+'</header>'+'</form>',mockRPC:function(route,args){if(route==='/web/sign/get_fonts/'){return Promise.resolve();}
return this._super(route,args);},});assert.containsOnce(form,'button.o_sign_button.o_widget',"Should have a signature widget button");assert.strictEqual($('.modal-dialog').length,0,"Should not have any modal");await testUtils.dom.click(form.$('span.o_sign_label'));assert.strictEqual($('.modal-dialog').length,1,"Should have one modal opened");form.destroy();});QUnit.test('Signature widget: full_name option',async function(assert){assert.expect(2);const form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form>'+'<header>'+'<widget name="signature" string="Sign" full_name="display_name"/>'+'</header>'+'<field name="display_name"/>'+'</form>',mockRPC:function(route,args){if(route==='/web/sign/get_fonts/'){return Promise.resolve();}
return this._super(route,args);},});await testUtils.dom.click(form.$('span.o_sign_label'));assert.strictEqual($('.modal .modal-body a.o_web_sign_auto_button').length,1,"Should open a modal with \"Auto\" button");assert.strictEqual($('.modal .modal-body .o_web_sign_name_input').val(),"Pop's Chock'lit","Correct Value should be set in the input for auto drawing the signature");form.destroy();});QUnit.test('Signature widget: highlight option',async function(assert){assert.expect(3);const form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form>'+'<header>'+'<widget name="signature" string="Sign" highlight="1"/>'+'</header>'+'</form>',mockRPC:function(route,args){if(route==='/web/sign/get_fonts/'){return Promise.resolve();}
return this._super(route,args);},});assert.hasClass(form.$('button.o_sign_button.o_widget'),'btn-primary',"The button must have the 'btn-primary' class as \"highlight=1\"");await testUtils.dom.click(form.$('span.o_sign_label'));assert.isNotVisible($('.modal .modal-body a.o_web_sign_auto_button'),"\"Auto\" button must be invisible");assert.strictEqual($('.modal .modal-body .o_web_sign_name_input').val(),'',"No value should be set in the input for auto drawing the signature");form.destroy();});});});});;

/* /web/static/tests/fields/special_fields_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.special_fields_tests',function(require){"use strict";var FormView=require('web.FormView');var ListView=require('web.ListView');var testUtils=require('web.test_utils');var createView=testUtils.createView;QUnit.module('fields',{},function(){QUnit.module('special_fields',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Displayed name",type:"char"},foo:{string:"Foo",type:"char",default:"My little Foo Value"},bar:{string:"Bar",type:"boolean",default:true},int_field:{string:"int_field",type:"integer",sortable:true},qux:{string:"Qux",type:"float",digits:[16,1]},p:{string:"one2many field",type:"one2many",relation:'partner',relation_field:'trululu'},turtles:{string:"one2many turtle field",type:"one2many",relation:'turtle'},trululu:{string:"Trululu",type:"many2one",relation:'partner'},timmy:{string:"pokemon",type:"many2many",relation:'partner_type'},product_id:{string:"Product",type:"many2one",relation:'product'},color:{type:"selection",selection:[['red',"Red"],['black',"Black"]],default:'red',},date:{string:"Some Date",type:"date"},datetime:{string:"Datetime Field",type:'datetime'},user_id:{string:"User",type:'many2one',relation:'user'},},records:[{id:1,display_name:"first record",bar:true,foo:"yop",int_field:10,qux:0.44,p:[],turtles:[2],timmy:[],trululu:4,user_id:17,},{id:2,display_name:"second record",bar:true,foo:"blip",int_field:9,qux:13,p:[],timmy:[],trululu:1,product_id:37,date:"2017-01-25",datetime:"2016-12-12 10:55:05",user_id:17,},{id:4,display_name:"aaa",bar:false,}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},partner_type:{fields:{name:{string:"Partner Type",type:"char"},color:{string:"Color index",type:"integer"},},records:[{id:12,display_name:"gold",color:2},{id:14,display_name:"silver",color:5},]},turtle:{fields:{display_name:{string:"Displayed name",type:"char"},turtle_foo:{string:"Foo",type:"char",default:"My little Foo Value"},turtle_bar:{string:"Bar",type:"boolean",default:true},turtle_int:{string:"int",type:"integer",sortable:true},turtle_qux:{string:"Qux",type:"float",digits:[16,1],required:true,default:1.5},turtle_description:{string:"Description",type:"text"},turtle_trululu:{string:"Trululu",type:"many2one",relation:'partner'},product_id:{string:"Product",type:"many2one",relation:'product',required:true},partner_ids:{string:"Partner",type:"many2many",relation:'partner'},},records:[{id:1,display_name:"leonardo",turtle_bar:true,turtle_foo:"yop",partner_ids:[],},{id:2,display_name:"donatello",turtle_bar:true,turtle_foo:"blip",turtle_int:9,partner_ids:[2,4],},{id:3,display_name:"raphael",turtle_bar:false,turtle_foo:"kawa",turtle_int:21,turtle_qux:9.8,partner_ids:[],}],},user:{fields:{name:{string:"Name",type:"char"}},records:[{id:17,name:"Aline",},{id:19,name:"Christine",}]},};}},function(){QUnit.module('FieldTimezoneMismatch');QUnit.test('widget timezone_mismatch in a list view',async function(assert){assert.expect(5);this.data.partner.fields.tz_offset={string:"tz_offset",type:"char"};this.data.partner.records.forEach(function(r){r.color='red';r.tz_offset=0;});this.data.partner.onchanges={color:function(r){r.tz_offset='+4800';}};var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree string="Colors" editable="top">'+'<field name="tz_offset" invisible="True"/>'+'<field name="color" widget="timezone_mismatch"/>'+'</tree>',});assert.strictEqual(list.$('td:contains(Red)').length,3,"should have 3 rows with correct value");await testUtils.dom.click(list.$('td:contains(Red):first'));var $td=list.$('tbody tr.o_selected_row td:not(.o_list_record_selector)');assert.strictEqual($td.find('select').length,1,"td should have a child 'select'");assert.strictEqual($td.contents().length,1,"select tag should be only child of td");await testUtils.fields.editSelect($td.find('select'),'"black"');assert.strictEqual($td.find('.o_tz_warning').length,1,"Should display icon alert");assert.ok($td.find('select option:selected').text().match(/Black\s+\([0-9]+\/[0-9]+\/[0-9]+ [0-9]+:[0-9]+:[0-9]+\)/),"Should display the datetime in the selected timezone");list.destroy();});QUnit.test('widget timezone_mismatch in a form view',async function(assert){assert.expect(2);this.data.partner.fields.tz_offset={string:"tz_offset",type:"char"};this.data.partner.fields.tz={type:"selection",selection:[['Europe/Brussels',"Europe/Brussels"],['America/Los_Angeles',"America/Los_Angeles"]],};this.data.partner.records[0].tz=false;this.data.partner.records[0].tz_offset='+4800';var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form>'+'<field name="tz_offset" invisible="True"/>'+'<field name="tz" widget="timezone_mismatch"/>'+'</form>',});await testUtils.form.clickEdit(form);assert.containsOnce(form,'select[name=tz]');var $timezoneMismatch=form.$('.o_tz_warning');assert.strictEqual($timezoneMismatch.length,1,"warning class should be there.");form.destroy();});QUnit.test('widget timezone_mismatch in a form view edit mode with mismatch',async function(assert){assert.expect(3);this.data.partner.fields.tz_offset={string:"tz_offset",type:"char"};this.data.partner.fields.tz={type:"selection",selection:[['Europe/Brussels',"Europe/Brussels"],['America/Los_Angeles',"America/Los_Angeles"]],};this.data.partner.records[0].tz='America/Los_Angeles';this.data.partner.records[0].tz_offset='+4800';var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form>'+'<field name="tz_offset" invisible="True"/>'+'<field name="tz" widget="timezone_mismatch" options="{\'tz_offset_field\': \'tz_offset\'}"/>'+'</form>',viewOptions:{mode:'edit',},});var $timezoneEl=form.$('select[name="tz"]');assert.strictEqual($timezoneEl.children().length,3,'The select element should have 3 children');var $timezoneMismatch=form.$('.o_tz_warning');assert.strictEqual($timezoneMismatch.length,1,'timezone mismatch is present');assert.notOk($timezoneMismatch.children().length,'The mismatch element should not have children');form.destroy();});QUnit.module('FieldReportLayout');QUnit.test('report_layout widget in form view',async function(assert){assert.expect(3);this.data['report.layout']={fields:{view_id:{string:"Document Template",type:"many2one",relation:"product"},image:{string:"Preview image src",type:"char"},pdf:{string:"Preview pdf src",type:"char"}},records:[{id:1,view_id:37,image:"/web/static/toto.png",pdf:"/web/static/toto.pdf",},{id:2,view_id:41,image:"/web/static/tata.png",pdf:"/web/static/tata.pdf",}],};this.data.partner.records[1].product_id=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="product_id" widget="report_layout"/> '+'</form>',res_id:2,viewOptions:{mode:'edit',},});assert.strictEqual(form.$('.img.img-fluid').length,2,"Two images should be rendered");assert.strictEqual(form.$('.img.btn-info').length,0,"No image should be selected");await testUtils.dom.click(form.$(".img.img-fluid:first"));assert.ok(form.$(".img.img-fluid:first").hasClass('btn-info'),"First image should be selected");form.destroy();});QUnit.module('IframeWrapper');QUnit.test('iframe_wrapper widget in form view',async function(assert){assert.expect(2);this.data={report:{fields:{report_content:{string:"Content of report",type:"html"}},records:[{id:1,report_content:`<html>
                            <head>
                                <style>
                                    body { color : rgb(255, 0, 0); }
                                </style>
                            <head>
                            <body>
                                <div class="nice_div"><p>Some content</p></div>
                            </body>
                         </html>`}]}};const form=await createView({View:FormView,model:'report',data:this.data,arch:`<form><field name="report_content" widget="iframe_wrapper"/></form>`,res_id:1,});const $iframe=form.$('iframe');await $iframe.data('ready');const doc=$iframe.contents()[0];assert.strictEqual($(doc).find('.nice_div').html(),'<p>Some content</p>',"should have rendered a div with correct content");assert.strictEqual($(doc).find('.nice_div p').css('color'),'rgb(255, 0, 0)',"head tag style should have been applied");form.destroy();});});});});;

/* /web/static/tests/fields/upgrade_fields_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.upgrade_fields_tests',function(require){"use strict";var FormView=require('web.FormView');var testUtils=require('web.test_utils');var createView=testUtils.createView;QUnit.module('fields',{},function(){QUnit.module('upgrade_fields',{beforeEach:function(){this.data={partner:{fields:{bar:{string:"Bar",type:"boolean"},},}};},},function(){QUnit.module('UpgradeBoolean');QUnit.test('widget upgrade_boolean in a form view',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="bar" widget="upgrade_boolean"/></form>',});await testUtils.dom.click(form.$('input:checkbox'));assert.strictEqual($('.modal').length,1,"the 'Upgrade to Enterprise' dialog should be opened");form.destroy();});QUnit.test('widget upgrade_boolean in a form view',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div class="o_field"><field name="bar" widget="upgrade_boolean"/></div>'+'<div class="o_label"><label for="bar"/><div>Coucou</div></div>'+'</form>',});assert.containsNone(form,'.o_field .badge',"the upgrade badge shouldn't be inside the field section");assert.containsOnce(form,'.o_label .badge',"the upgrade badge should be inside the label section");assert.strictEqual(form.$('.o_label').text(),"Bar EnterpriseCoucou","the upgrade label should be inside the label section");form.destroy();});});});});;

/* /web/static/tests/views/sample_server_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.sample_server_tests',function(require){"use strict";const SampleServer=require('web.SampleServer');const session=require('web.session');const{mock}=require('web.test_utils');const{MAIN_RECORDSET_SIZE,SEARCH_READ_LIMIT,SAMPLE_COUNTRIES,SAMPLE_PEOPLE,SAMPLE_TEXTS,MAX_COLOR_INT,MAX_FLOAT,MAX_INTEGER,MAX_MONETARY,SUB_RECORDSET_SIZE,}=SampleServer;class DeterministicSampleServer extends SampleServer{constructor(){super(...arguments);this.arrayElCpt=0;this.boolCpt=0;this.subRecordIdCpt=0;}
_getRandomArrayEl(array){return array[this.arrayElCpt++%array.length];}
_getRandomBool(){return Boolean(this.boolCpt++%2);}
_getRandomSubRecordId(){return(this.subRecordIdCpt++%SUB_RECORDSET_SIZE)+1;}}
QUnit.module("Sample Server",{beforeEach(){this.fields={'res.users':{display_name:{string:"Name",type:'char'},name:{string:"Reference",type:'char'},email:{string:"Email",type:'char'},phone_number:{string:"Phone number",type:'char'},brol_machin_url_truc:{string:"URL",type:'char'},urlemailphone:{string:"Whatever",type:'char'},active:{string:"Active",type:'boolean'},is_alive:{string:"Is alive",type:'boolean'},description:{string:"Description",type:'text'},birthday:{string:"Birthday",type:'date'},arrival_date:{string:"Date of arrival",type:'datetime'},height:{string:"Height",type:'float'},color:{string:"Color",type:'integer'},age:{string:"Age",type:'integer'},salary:{string:"Salary",type:'monetary'},currency:{string:"Currency",type:'many2one',relation:'res.currency'},manager_id:{string:"Manager",type:'many2one',relation:'res.users'},managed_ids:{string:"Managing",type:'one2many',relation:'res.users'},tag_ids:{string:"Tags",type:'many2many',relation:'tag'},type:{string:"Type",type:'selection',selection:[['client',"Client"],['partner',"Partner"],['employee',"Employee"]]},},'res.country':{display_name:{string:"Name",type:'char'},},'hobbit':{display_name:{string:"Name",type:'char'},profession:{string:"Profession",type:'selection',selection:[['gardener',"Gardener"],['brewer',"Brewer"],['adventurer',"Adventurer"]]},age:{string:"Age",type:'integer'},},};},},function(){QUnit.module("Basic behaviour");QUnit.test("Sample data: people type + all field names",async function(assert){assert.expect(25);mock.patch(session,{company_currency_id:4,});const allFieldNames=Object.keys(this.fields['res.users']);const server=new DeterministicSampleServer('res.users',this.fields['res.users']);const{records}=await server.mockRpc({method:'/web/dataset/search_read',model:'res.users',fields:allFieldNames,});const rec=records[0];function assertFormat(fieldName,regex){if(regex instanceof RegExp){assert.ok(regex.test(rec[fieldName].toString()),`Field "${fieldName}" has the correct format`);}else{assert.strictEqual(typeof rec[fieldName],regex,`Field "${fieldName}" is of type ${regex}`);}}
function assertBetween(fieldName,min,max,isFloat=false){const val=rec[fieldName];assert.ok(min<=val&&val<max&&(isFloat||parseInt(val,10)===val),`Field "${fieldName}" is between ${min} and ${max} ${!isFloat ? 'and is an integer ' : ''}: ${val}`);}
assert.ok(SAMPLE_PEOPLE.includes(rec.display_name));assert.ok(SAMPLE_PEOPLE.includes(rec.name));assert.strictEqual(rec.email,`${rec.display_name.replace(/ /, ".").toLowerCase()}@sample.demo`);assertFormat('phone_number',/\+1 555 754 000\d/);assertFormat('brol_machin_url_truc',/http:\/\/sample\d\.com/);assert.strictEqual(rec.urlemailphone,false);assert.strictEqual(rec.active,true);assertFormat('is_alive','boolean');assert.ok(SAMPLE_TEXTS.includes(rec.description));assertFormat('birthday',/\d{4}-\d{2}-\d{2}/);assertFormat('arrival_date',/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);assertBetween('height',0,MAX_FLOAT,true);assertBetween('color',0,MAX_COLOR_INT);assertBetween('age',0,MAX_INTEGER);assertBetween('salary',0,MAX_MONETARY);assert.strictEqual(rec.height,parseFloat(parseFloat(rec.height).toFixed(2)));const selectionValues=this.fields['res.users'].type.selection.map((sel)=>sel[0]);assert.ok(selectionValues.includes(rec.type));assert.strictEqual(rec.currency[0],4);assert.ok(SAMPLE_TEXTS.includes(rec.currency[1]));assert.strictEqual(typeof rec.manager_id[0],'number');assert.ok(SAMPLE_PEOPLE.includes(rec.manager_id[1]));assert.strictEqual(rec.managed_ids.length,2);assert.ok(rec.managed_ids.every((id)=>typeof id==='number'));assert.strictEqual(rec.tag_ids.length,2);assert.ok(rec.tag_ids.every((id)=>typeof id==='number'));mock.unpatch(session);});QUnit.test("Sample data: country type",async function(assert){assert.expect(1);const server=new DeterministicSampleServer('res.country',this.fields['res.country']);const{records}=await server.mockRpc({method:'/web/dataset/search_read',model:'res.country',fields:['display_name'],});assert.ok(SAMPLE_COUNTRIES.includes(records[0].display_name));});QUnit.test("Sample data: any type",async function(assert){assert.expect(1);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const{records}=await server.mockRpc({method:'/web/dataset/search_read',model:'hobbit',fields:['display_name'],});assert.ok(SAMPLE_TEXTS.includes(records[0].display_name));});QUnit.module("RPC calls");QUnit.test("Send 'search_read' RPC: valid field names",async function(assert){assert.expect(3);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'/web/dataset/search_read',model:'hobbit',fields:['display_name'],});assert.deepEqual(Object.keys(result.records[0]),['id','display_name']);assert.strictEqual(result.length,SEARCH_READ_LIMIT);assert.ok(/\w+/.test(result.records[0].display_name),"Display name has been mocked");});QUnit.test("Send 'search_read' RPC: invalid field names",async function(assert){assert.expect(3);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'/web/dataset/search_read',model:'hobbit',fields:['name'],});assert.deepEqual(Object.keys(result.records[0]),['id','name']);assert.strictEqual(result.length,SEARCH_READ_LIMIT);assert.strictEqual(result.records[0].name,false,`Field "name" doesn't exist => returns false`);});QUnit.test("Send 'web_read_group' RPC: no group",async function(assert){assert.expect(1);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);server.setExistingGroups([]);const result=await server.mockRpc({method:'web_read_group',model:'hobbit',groupBy:['profession'],});assert.deepEqual(result,{groups:[],length:0});});QUnit.test("Send 'web_read_group' RPC: 2 groups",async function(assert){assert.expect(5);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const existingGroups=[{profession:'gardener',profession_count:0},{profession:'adventurer',profession_count:0},];server.setExistingGroups(existingGroups);const result=await server.mockRpc({method:'web_read_group',model:'hobbit',groupBy:['profession'],fields:[],});assert.strictEqual(result.length,2);assert.strictEqual(result.groups.length,2);assert.deepEqual(result.groups.map((g)=>g.profession),["gardener","adventurer"]);assert.strictEqual(result.groups.reduce((acc,g)=>acc+g.profession_count,0),MAIN_RECORDSET_SIZE);assert.ok(result.groups.every((g)=>g.profession_count===g.__data.length));});QUnit.test("Send 'web_read_group' RPC: all groups",async function(assert){assert.expect(5);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const existingGroups=[{profession:'gardener',profession_count:0},{profession:'brewer',profession_count:0},{profession:'adventurer',profession_count:0},];server.setExistingGroups(existingGroups);const result=await server.mockRpc({method:'web_read_group',model:'hobbit',groupBy:['profession'],fields:[],});assert.strictEqual(result.length,3);assert.strictEqual(result.groups.length,3);assert.deepEqual(result.groups.map((g)=>g.profession),["gardener","brewer","adventurer"]);assert.strictEqual(result.groups.reduce((acc,g)=>acc+g.profession_count,0),MAIN_RECORDSET_SIZE);assert.ok(result.groups.every((g)=>g.profession_count===g.__data.length));});QUnit.test("Send 'read_group' RPC: no group",async function(assert){assert.expect(1);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'read_group',model:'hobbit',fields:[],groupBy:[],});assert.deepEqual(result,[{__count:MAIN_RECORDSET_SIZE,__domain:[],}]);});QUnit.test("Send 'read_group' RPC: groupBy",async function(assert){assert.expect(3);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'read_group',model:'hobbit',fields:[],groupBy:['profession'],});assert.strictEqual(result.length,3);assert.deepEqual(result.map((g)=>g.profession),["adventurer","brewer","gardener"]);assert.strictEqual(result.reduce((acc,g)=>acc+g.profession_count,0),MAIN_RECORDSET_SIZE,);});QUnit.test("Send 'read_group' RPC: groupBy and field",async function(assert){assert.expect(4);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'read_group',model:'hobbit',fields:['age'],groupBy:['profession'],});assert.strictEqual(result.length,3);assert.deepEqual(result.map((g)=>g.profession),["adventurer","brewer","gardener"]);assert.strictEqual(result.reduce((acc,g)=>acc+g.profession_count,0),MAIN_RECORDSET_SIZE,);assert.strictEqual(result.reduce((acc,g)=>acc+g.age,0),server.data.hobbit.records.reduce((acc,g)=>acc+g.age,0));});QUnit.test("Send 'read_group' RPC: multiple groupBys and lazy",async function(assert){assert.expect(2);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'read_group',model:'hobbit',fields:[],groupBy:['profession','age'],});assert.ok('profession'in result[0]);assert.notOk('age'in result[0]);});QUnit.test("Send 'read_group' RPC: multiple groupBys and not lazy",async function(assert){assert.expect(2);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'read_group',model:'hobbit',fields:[],groupBy:['profession','age'],lazy:false,});assert.ok('profession'in result[0]);assert.ok('age'in result[0]);});QUnit.test("Send 'read' RPC: no id",async function(assert){assert.expect(1);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'read',model:'hobbit',args:[[],['display_name']],});assert.deepEqual(result,[]);});QUnit.test("Send 'read' RPC: one id",async function(assert){assert.expect(3);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const result=await server.mockRpc({method:'read',model:'hobbit',args:[[1],['display_name']],});assert.strictEqual(result.length,1);assert.ok(/\w+/.test(result[0].display_name),"Display name has been mocked");assert.strictEqual(result[0].id,1);});QUnit.test("Send 'read' RPC: more than all available ids",async function(assert){assert.expect(1);const server=new DeterministicSampleServer('hobbit',this.fields.hobbit);const amount=MAIN_RECORDSET_SIZE+3;const ids=new Array(amount).fill().map((_,i)=>i+1);const result=await server.mockRpc({method:'read',model:'hobbit',args:[ids,['display_name']],});assert.strictEqual(result.length,MAIN_RECORDSET_SIZE);});});});;

/* /web/static/tests/views/abstract_controller_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define("base.abstract_controller_tests",function(require){"use strict";const{xml}=owl.tags;var testUtils=require("web.test_utils");var createView=testUtils.createView;var BasicView=require("web.BasicView");var BasicRenderer=require("web.BasicRenderer");const AbstractRenderer=require('web.AbstractRendererOwl');const RendererWrapper=require('web.RendererWrapper');function getHtmlRenderer(html){return BasicRenderer.extend({start:function(){this.$el.html(html);return this._super.apply(this,arguments);}});}
function getOwlView(owlRenderer,viewType){viewType=viewType||"test";return BasicView.extend({viewType:viewType,config:_.extend({},BasicView.prototype.config,{Renderer:owlRenderer,}),getRenderer(){return new RendererWrapper(null,this.config.Renderer,{});}});}
function getHtmlView(html,viewType){viewType=viewType||"test";return BasicView.extend({viewType:viewType,config:_.extend({},BasicView.prototype.config,{Renderer:getHtmlRenderer(html)})});}
QUnit.module("Views",{beforeEach:function(){this.data={test_model:{fields:{},records:[]}};}},function(){QUnit.module('AbstractController');QUnit.test('click on a a[type="action"] child triggers the correct action',async function(assert){assert.expect(7);var html="<div>"+'<a name="a1" type="action" class="simple">simple</a>'+'<a name="a2" type="action" class="with-child">'+"<span>child</input>"+"</a>"+'<a type="action" data-model="foo" data-method="bar" class="method">method</a>'+'<a type="action" data-model="foo" data-res-id="42" class="descr">descr</a>'+'<a type="action" data-model="foo" class="descr2">descr2</a>'+"</div>";var view=await createView({View:getHtmlView(html,"test"),data:this.data,model:"test_model",arch:"<test/>",intercepts:{do_action:function(event){assert.step(event.data.action.name||event.data.action);}},mockRPC:function(route,args){if(args.model==='foo'&&args.method==='bar'){assert.step("method");return Promise.resolve({name:'method'});}
return this._super.apply(this,arguments);}});await testUtils.dom.click(view.$(".simple"));await testUtils.dom.click(view.$(".with-child span"));await testUtils.dom.click(view.$(".method"));await testUtils.dom.click(view.$(".descr"));await testUtils.dom.click(view.$(".descr2"));assert.verifySteps(["a1","a2","method","method","descr","descr2"]);view.destroy();});QUnit.test('OWL Renderer correctly destroyed',async function(assert){assert.expect(2);class Renderer extends AbstractRenderer{__destroy(){assert.step("destroy");super.__destroy();}}
Renderer.template=xml`<div>Test</div>`;var view=await createView({View:getOwlView(Renderer,"test"),data:this.data,model:"test_model",arch:"<test/>",});view.destroy();assert.verifySteps(["destroy"]);});QUnit.test('Correctly set focus to search panel with Owl Renderer',async function(assert){assert.expect(1);class Renderer extends AbstractRenderer{}
Renderer.template=xml`<div>Test</div>`;var view=await createView({View:getOwlView(Renderer,"test"),data:this.data,model:"test_model",arch:"<test/>",});assert.hasClass(document.activeElement,"o_searchview_input");view.destroy();});QUnit.test('Owl Renderer mounted/willUnmount hooks are properly called',async function(assert){assert.expect(3);class Renderer extends AbstractRenderer{mounted(){assert.step("mounted");}
willUnmount(){assert.step("unmounted");}}
Renderer.template=xml`<div>Test</div>`;const view=await createView({View:getOwlView(Renderer,"test"),data:this.data,model:"test_model",arch:"<test/>",});view.destroy();assert.verifySteps(["mounted","unmounted",]);});});});;

/* /web/static/tests/views/abstract_view_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.abstract_view_tests',function(require){"use strict";var AbstractView=require('web.AbstractView');var ajax=require('web.ajax');var testUtils=require('web.test_utils');var createActionManager=testUtils.createActionManager;var createView=testUtils.createView;QUnit.module('Views',{beforeEach:function(){this.data={fake_model:{fields:{},record:[],},foo:{fields:{foo:{string:"Foo",type:"char"},bar:{string:"Bar",type:"boolean"},},records:[{id:1,bar:true,foo:"yop"},{id:2,bar:true,foo:"blip"},]},};},},function(){QUnit.module('AbstractView');QUnit.test('lazy loading of js libs (in parallel)',async function(assert){var done=assert.async();assert.expect(6);var prom=testUtils.makeTestPromise();var loadJS=ajax.loadJS;ajax.loadJS=function(url){assert.step(url);return prom.then(function(){assert.step(url+' loaded');});};var View=AbstractView.extend({jsLibs:[['a','b']],});createView({View:View,arch:'<fake/>',data:this.data,model:'fake_model',}).then(function(view){assert.verifySteps(['a loaded','b loaded'],"should wait for both libs to be loaded");ajax.loadJS=loadJS;view.destroy();done();});await testUtils.nextTick();assert.verifySteps(['a','b'],"both libs should be loaded in parallel");prom.resolve();});QUnit.test('lazy loading of js libs (sequentially)',async function(assert){var done=assert.async();assert.expect(10);var proms={a:testUtils.makeTestPromise(),b:testUtils.makeTestPromise(),c:testUtils.makeTestPromise(),};var loadJS=ajax.loadJS;ajax.loadJS=function(url){assert.step(url);return proms[url].then(function(){assert.step(url+' loaded');});};var View=AbstractView.extend({jsLibs:[['a','b'],'c',],});createView({View:View,arch:'<fake/>',data:this.data,model:'fake_model',}).then(function(view){assert.verifySteps(['c loaded'],"should wait for all libs to be loaded");ajax.loadJS=loadJS;view.destroy();done();});await testUtils.nextTick();assert.verifySteps(['a','b'],"libs 'a' and 'b' should be loaded in parallel");await proms.b.resolve();await testUtils.nextTick();assert.verifySteps(['b loaded'],"should wait for 'a' and 'b' to be loaded before loading 'c'");await proms.a.resolve();await testUtils.nextTick();assert.verifySteps(['a loaded','c'],"should load 'c' when 'a' and 'b' are loaded");await proms.c.resolve();});QUnit.test('group_by from context can be a string, instead of a list of strings',async function(assert){assert.expect(1);var actionManager=await createActionManager({actions:[{id:1,name:'Foo',res_model:'foo',type:'ir.actions.act_window',views:[[false,'list']],context:{group_by:'bar',},}],archs:{'foo,false,list':'<tree><field name="foo"/><field name="bar"/></tree>','foo,false,search':'<search></search>',},data:this.data,mockRPC:function(route,args){if(args.method==='web_read_group'){assert.deepEqual(args.kwargs.groupby,['bar']);}
return this._super.apply(this,arguments);},});await actionManager.doAction(1);actionManager.destroy();});});});;

/* /web/static/tests/views/form_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.form_tests',function(require){"use strict";var AbstractStorageService=require('web.AbstractStorageService');var BasicModel=require('web.BasicModel');var concurrency=require('web.concurrency');var core=require('web.core');var fieldRegistry=require('web.field_registry');const fieldRegistryOwl=require('web.field_registry_owl');var FormView=require('web.FormView');var mixins=require('web.mixins');var NotificationService=require('web.NotificationService');var pyUtils=require('web.py_utils');var RamStorage=require('web.RamStorage');var testUtils=require('web.test_utils');var widgetRegistry=require('web.widget_registry');var Widget=require('web.Widget');var _t=core._t;const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;var createActionManager=testUtils.createActionManager;QUnit.module('Views',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Displayed name",type:"char"},foo:{string:"Foo",type:"char",default:"My little Foo Value"},bar:{string:"Bar",type:"boolean"},int_field:{string:"int_field",type:"integer",sortable:true},qux:{string:"Qux",type:"float",digits:[16,1]},p:{string:"one2many field",type:"one2many",relation:'partner'},trululu:{string:"Trululu",type:"many2one",relation:'partner'},timmy:{string:"pokemon",type:"many2many",relation:'partner_type'},product_id:{string:"Product",type:"many2one",relation:'product'},priority:{string:"Priority",type:"selection",selection:[[1,"Low"],[2,"Medium"],[3,"High"]],default:1,},state:{string:"State",type:"selection",selection:[["ab","AB"],["cd","CD"],["ef","EF"]]},date:{string:"Some Date",type:"date"},datetime:{string:"Datetime Field",type:'datetime'},product_ids:{string:"one2many product",type:"one2many",relation:"product"},reference:{string:"Reference Field",type:'reference',selection:[["product","Product"],["partner_type","Partner Type"],["partner","Partner"]]},},records:[{id:1,display_name:"first record",bar:true,foo:"yop",int_field:10,qux:0.44,p:[],timmy:[],trululu:4,state:"ab",date:"2017-01-25",datetime:"2016-12-12 10:55:05",},{id:2,display_name:"second record",bar:true,foo:"blip",int_field:9,qux:13,p:[],timmy:[],trululu:1,state:"cd",},{id:4,display_name:"aaa",state:"ef",},{id:5,display_name:"aaa",foo:'',bar:false,state:"ef",}],onchanges:{},},product:{fields:{display_name:{string:"Product Name",type:"char"},name:{string:"Product Name",type:"char"},partner_type_id:{string:"Partner type",type:"many2one",relation:"partner_type"},},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},partner_type:{fields:{name:{string:"Partner Type",type:"char"},color:{string:"Color index",type:"integer"},},records:[{id:12,display_name:"gold",color:2},{id:14,display_name:"silver",color:5},]},"ir.translation":{fields:{lang_code:{type:"char"},value:{type:"char"},res_id:{type:"integer"}},records:[{id:99,res_id:12,value:'',lang_code:'en_US'}]},user:{fields:{name:{string:"Name",type:"char"},partner_ids:{string:"one2many partners field",type:"one2many",relation:'partner',relation_field:'user_id'},},records:[{id:17,name:"Aline",partner_ids:[1],},{id:19,name:"Christine",}]},"res.company":{fields:{name:{string:"Name",type:"char"},},},};this.actions=[{id:1,name:'Partners Action 1',res_model:'partner',type:'ir.actions.act_window',views:[[false,'kanban'],[false,'form']],}];},},function(){QUnit.module('FormView');QUnit.test('simple form rendering',async function(assert){assert.expect(12);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<div class="test" style="opacity: 0.5;">some html<span>aa</span></div>'+'<sheet>'+'<group>'+'<group style="background-color: red">'+'<field name="foo" style="color: blue"/>'+'<field name="bar"/>'+'<field name="int_field" string="f3_description"/>'+'<field name="qux"/>'+'</group>'+'<group>'+'<div class="hello"></div>'+'</group>'+'</group>'+'<notebook>'+'<page string="Partner Yo">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:2,});assert.containsOnce(form,'div.test');assert.strictEqual(form.$('div.test').css('opacity'),'0.5',"should keep the inline style on html elements");assert.containsOnce(form,'label:contains(Foo)');assert.containsOnce(form,'span:contains(blip)');assert.hasAttrValue(form.$('.o_group .o_group:first'),'style','background-color: red',"should apply style attribute on groups");assert.hasAttrValue(form.$('.o_field_widget[name=foo]'),'style','color: blue',"should apply style attribute on fields");assert.containsNone(form,'label:contains(something_id)');assert.containsOnce(form,'label:contains(f3_description)');assert.containsOnce(form,'div.o_field_one2many table');assert.containsOnce(form,'tbody td:not(.o_list_record_selector) .custom-checkbox input:checked');assert.containsOnce(form,'.o_control_panel .breadcrumb:contains(second record)');assert.containsNone(form,'label.o_form_label_empty:contains(timmy)');form.destroy();});QUnit.test('duplicate fields rendered properly',async function(assert){assert.expect(6);this.data.partner.records.push({id:6,bar:true,foo:"blip",int_field:9,});var form=await createView({View:FormView,viewOptions:{mode:'edit'},model:'partner',data:this.data,arch:'<form>'+'<group>'+'<group>'+'<field name="foo" attrs="{\'invisible\': [(\'bar\',\'=\',True)]}"/>'+'<field name="foo" attrs="{\'invisible\': [(\'bar\',\'=\',False)]}"/>'+'<field name="foo"/>'+'<field name="int_field" attrs="{\'readonly\': [(\'bar\',\'=\',False)]}"/>'+'<field name="int_field" attrs="{\'readonly\': [(\'bar\',\'=\',True)]}"/>'+'<field name="bar"/>'+'</group>'+'</group>'+'</form>',res_id:6,});assert.hasClass(form.$('div.o_group input[name="foo"]:eq(0)'),'o_invisible_modifier','first foo widget should be invisible');assert.containsOnce(form,'div.o_group input[name="foo"]:eq(1):not(.o_invisible_modifier)',"second foo widget should be visible");assert.containsOnce(form,'div.o_group input[name="foo"]:eq(2):not(.o_invisible_modifier)',"third foo widget should be visible");await testUtils.fields.editInput(form.$('div.o_group input[name="foo"]:eq(2)'),"hello");assert.strictEqual(form.$('div.o_group input[name="foo"]:eq(1)').val(),"hello","second foo widget should be 'hello'");assert.containsOnce(form,'div.o_group input[name="int_field"]:eq(0):not(.o_readonly_modifier)',"first int_field widget should not be readonly");assert.hasClass(form.$('div.o_group span[name="int_field"]:eq(0)'),'o_readonly_modifier',"second int_field widget should be readonly");form.destroy();});QUnit.test('duplicate fields rendered properly (one2many)',async function(assert){assert.expect(7);this.data.partner.records.push({id:6,p:[1],});var form=await createView({View:FormView,viewOptions:{mode:'edit'},model:'partner',data:this.data,arch:'<form>'+'<notebook>'+'<page>'+'<field name="p">'+'<tree editable="True">'+'<field name="foo"/>'+'</tree>'+'<form/>'+'</field>'+'</page>'+'<page>'+'<field name="p" readonly="True">'+'<tree editable="True">'+'<field name="foo"/>'+'</tree>'+'<form/>'+'</field>'+'</page>'+'</notebook>'+'</form>',res_id:6,});assert.containsOnce(form,'div.o_field_one2many:eq(0):not(.o_readonly_modifier)',"first one2many widget should not be readonly");assert.hasClass(form.$('div.o_field_one2many:eq(1)'),'o_readonly_modifier',"second one2many widget should be readonly");await testUtils.dom.click(form.$('div.tab-content table.o_list_table:eq(0) tr.o_data_row td.o_data_cell:eq(0)'));assert.strictEqual(form.$('div.tab-content table.o_list_table tr.o_selected_row input[name="foo"]').val(),"yop","first line in one2many of first tab contains yop");assert.strictEqual(form.$('div.tab-content table.o_list_table:eq(1) tr.o_data_row td.o_data_cell:eq(0)').text(),"yop","first line in one2many of second tab contains yop");await testUtils.fields.editInput(form.$('div.tab-content table.o_list_table tr.o_selected_row input[name="foo"]'),"hello");assert.strictEqual(form.$('div.tab-content table.o_list_table:eq(1) tr.o_data_row td.o_data_cell:eq(0)').text(),"hello","first line in one2many of second tab contains hello");await testUtils.dom.click(form.$('div.tab-content table.o_list_table:eq(0) a:contains(Add a line)'));assert.strictEqual(form.$('div.tab-content table.o_list_table tr.o_selected_row input[name="foo"]').val(),"My little Foo Value","second line in one2many of first tab contains 'My little Foo Value'");assert.strictEqual(form.$('div.tab-content table.o_list_table:eq(1) tr.o_data_row:eq(1) td.o_data_cell:eq(0)').text(),"My little Foo Value","first line in one2many of second tab contains hello");form.destroy();});QUnit.test('attributes are transferred on async widgets',async function(assert){assert.expect(1);var done=assert.async();var def=testUtils.makeTestPromise();var FieldChar=fieldRegistry.get('char');fieldRegistry.add('asyncwidget',FieldChar.extend({willStart:function(){return def;},}));createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="foo" style="color: blue" widget="asyncwidget"/>'+'</group>'+'</form>',res_id:2,}).then(function(form){assert.hasAttrValue(form.$('.o_field_widget[name=foo]'),'style','color: blue',"should apply style attribute on fields");form.destroy();delete fieldRegistry.map.asyncwidget;done();});def.resolve();await testUtils.nextTick();});QUnit.test('placeholder attribute on input',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<input placeholder="chimay"/>'+'</form>',res_id:2,});assert.containsOnce(form,'input[placeholder="chimay"]');form.destroy();});QUnit.test('decoration works on widgets',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="display_name" decoration-danger="int_field &lt; 5"/>'+'<field name="foo" decoration-danger="int_field &gt; 5"/>'+'</form>',res_id:2,});assert.doesNotHaveClass(form.$('span[name="display_name"]'),'text-danger');assert.hasClass(form.$('span[name="foo"]'),'text-danger');form.destroy();});QUnit.test('decoration on widgets are reevaluated if necessary',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="display_name" decoration-danger="int_field &lt; 5"/>'+'</form>',res_id:2,viewOptions:{mode:'edit'},});assert.doesNotHaveClass(form.$('input[name="display_name"]'),'text-danger');await testUtils.fields.editInput(form.$('input[name=int_field]'),3);assert.hasClass(form.$('input[name="display_name"]'),'text-danger');form.destroy();});QUnit.test('decoration on widgets works on same widget',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field" decoration-danger="int_field &lt; 5"/>'+'</form>',res_id:2,viewOptions:{mode:'edit'},});assert.doesNotHaveClass(form.$('input[name="int_field"]'),'text-danger');await testUtils.fields.editInput(form.$('input[name=int_field]'),3);assert.hasClass(form.$('input[name="int_field"]'),'text-danger');form.destroy();});QUnit.test('only necessary fields are fetched with correct context',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,mockRPC:function(route,args){assert.deepEqual(args.args[1],["foo","display_name"],"should only fetch requested fields");assert.deepEqual(args.kwargs.context,{bin_size:true},"bin_size should always be in the context");return this._super(route,args);}});form.destroy();});QUnit.test('group rendering',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'table.o_inner_group');form.destroy();});QUnit.test('group containing both a field and a group',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo"/>'+'<group>'+'<field name="int_field"/>'+'</group>'+'</group>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_group .o_field_widget[name=foo]');assert.containsOnce(form,'.o_group .o_inner_group .o_field_widget[name=int_field]');assert.hasClass(form.$('.o_field_widget[name=foo]'),'o_field_char');assert.hasClass(form.$('.o_field_widget[name=foo]'),'o_group_col_6');form.destroy();});QUnit.test('Form and subview with _view_ref contexts',async function(assert){assert.expect(2);this.data.product.fields.partner_type_ids={string:"one2many field",type:"one2many",relation:"partner_type"},this.data.product.records=[{id:1,name:'Tromblon',partner_type_ids:[12,14]}];this.data.partner.records[0].product_id=1;var actionManager=await createActionManager({data:this.data,archs:{'product,false,form':'<form>'+'<field name="name"/>'+'<field name="partner_type_ids" context="{\'tree_view_ref\': \'some_other_tree_view\'}"/>'+'</form>','partner_type,false,list':'<tree>'+'<field name="color"/>'+'</tree>','product,false,search':'<search></search>',},mockRPC:function(route,args){if(args.method==='load_views'){var context=args.kwargs.context;if(args.model==='product'){assert.deepEqual(context,{tree_view_ref:'some_tree_view'},'The correct _view_ref should have been sent to the server, first time');}
if(args.model==='partner_type'){assert.deepEqual(context,{base_model_name:'product',tree_view_ref:'some_other_tree_view',},'The correct _view_ref should have been sent to the server for the subview');}}
return this._super.apply(this,arguments);},});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="name"/>'+'<field name="product_id" context="{\'tree_view_ref\': \'some_tree_view\'}"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='get_formview_action'){return Promise.resolve({res_id:1,type:'ir.actions.act_window',target:'current',res_model:args.model,context:args.kwargs.context,'view_mode':'form','views':[[false,'form']],});}
return this._super(route,args);},interceptsPropagate:{do_action:function(ev){actionManager.doAction(ev.data.action);},},});await testUtils.dom.click(form.$('.o_field_widget[name="product_id"]'));form.destroy();actionManager.destroy();});QUnit.test('invisible fields are properly hidden',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" invisible="1"/>'+'<field name="bar"/>'+'</group>'+'<field name="qux" invisible="1"/>'+'<field name="p" invisible="True"/>'+'</sheet>'+'</form>',res_id:1,});assert.containsNone(form,'label:contains(Foo)');assert.containsNone(form,'.o_field_widget[name=foo]');assert.containsNone(form,'.o_field_widget[name=qux]');assert.containsNone(form,'.o_field_widget[name=p]');form.destroy();});QUnit.test('invisible elements are properly hidden',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header invisible="1">'+'<button name="myaction" string="coucou"/>'+'</header>'+'<sheet>'+'<group>'+'<group string="invgroup" invisible="1">'+'<field name="foo"/>'+'</group>'+'</group>'+'<notebook>'+'<page string="visible"/>'+'<page string="invisible" invisible="1"/>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_form_statusbar.o_invisible_modifier button:contains(coucou)');assert.containsOnce(form,'.o_notebook li.o_invisible_modifier a:contains(invisible)');assert.containsOnce(form,'table.o_inner_group.o_invisible_modifier td:contains(invgroup)');form.destroy();});QUnit.test('invisible attrs on fields are re-evaluated on field change',async function(assert){assert.expect(3);this.data.partner.records[0].bar=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet><group>'+'<field name="product_id"/>'+'<field name="timmy" invisible="1"/>'+'<field name="foo" class="foo_field" attrs=\'{"invisible": [["product_id", "=", false]]}\'/>'+'<field name="bar" class="bar_field" attrs=\'{"invisible":[("bar","=",False),("timmy","=",[])]}\'/>'+'</group></sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit'},});assert.hasClass(form.$('.foo_field'),'o_invisible_modifier');assert.hasClass(form.$('.bar_field'),'o_invisible_modifier');await testUtils.fields.many2one.searchAndClickItem('product_id');assert.doesNotHaveClass(form.$('.foo_field'),'o_invisible_modifier');form.destroy();});QUnit.test('asynchronous fields can be set invisible',async function(assert){assert.expect(1);var done=assert.async();var def=testUtils.makeTestPromise();var PercentPieWidget=fieldRegistry.get('percentpie');fieldRegistry.add('asyncwidget',PercentPieWidget.extend({willStart:function(){return def;},}));createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet><group>'+'<field name="foo"/>'+'<field name="int_field" invisible="1" widget="asyncwidget"/>'+'</group></sheet>'+'</form>',res_id:1,}).then(function(form){assert.containsNone(form,'.o_field_widget[name="int_field"]');form.destroy();delete fieldRegistry.map.asyncwidget;done();});def.resolve();});QUnit.test('properly handle modifiers and attributes on notebook tags',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id"/>'+'<notebook class="new_class" attrs=\'{"invisible": [["product_id", "=", false]]}\'>'+'<page string="Foo">'+'<field name="foo"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.hasClass(form.$('.o_notebook'),'o_invisible_modifier');assert.hasClass(form.$('.o_notebook'),'new_class');form.destroy();});QUnit.test('empty notebook',async function(assert){assert.expect(2);const form=await createView({arch:`
                <form string="Partners">
                    <sheet>
                        <notebook/>
                    </sheet>
                </form>`,data:this.data,model:'partner',res_id:1,View:FormView,});await testUtils.form.clickEdit(form);assert.containsNone(form,':scope .o_notebook .nav');await testUtils.form.clickSave(form);assert.containsNone(form,':scope .o_notebook .nav');form.destroy();});QUnit.test('no visible page',async function(assert){assert.expect(4);const form=await createView({arch:`
                <form string="Partners">
                    <sheet>
                        <notebook>
                            <page string="Foo" invisible="1">
                                <field name="foo"/>
                            </page>
                            <page string="Bar" invisible="1">
                                <field name="bar"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>`,data:this.data,model:'partner',res_id:1,View:FormView,});await testUtils.form.clickEdit(form);for(const nav of form.el.querySelectorAll(':scope .o_notebook .nav')){assert.containsNone(nav,'.nav-link.active');assert.containsN(nav,'.nav-item.o_invisible_modifier',2);}
await testUtils.form.clickSave(form);for(const nav of form.el.querySelectorAll(':scope .o_notebook .nav')){assert.containsNone(nav,'.nav-link.active');assert.containsN(nav,'.nav-item.o_invisible_modifier',2);}
form.destroy();});QUnit.test('notebook: pages with invisible modifiers',async function(assert){assert.expect(10);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form string="Partners">
                    <sheet>
                        <field name="bar"/>
                        <notebook>
                            <page string="First" attrs='{"invisible": [["bar", "=", false]]}'>
                                <field name="foo"/>
                            </page>
                            <page string="Second" attrs='{"invisible": [["bar", "=", true]]}'>
                                <field name="int_field"/>
                            </page>
                            <page string="Third">
                                <field name="qux"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>`,res_id:1,});await testUtils.form.clickEdit(form);assert.containsOnce(form,".o_notebook .nav .nav-link.active","There should be only one active tab");assert.isVisible(form.$(".o_notebook .nav .nav-item:first"));assert.hasClass(form.$(".o_notebook .nav .nav-link:first"),"active");assert.isNotVisible(form.$(".o_notebook .nav .nav-item:eq(1)"));assert.doesNotHaveClass(form.$(".o_notebook .nav .nav-link:eq(1)"),"active");await testUtils.dom.click(form.$(".o_field_widget[name=bar] input"));assert.containsOnce(form,".o_notebook .nav .nav-link.active","There should be only one active tab");assert.isNotVisible(form.$(".o_notebook .nav .nav-item:first"));assert.doesNotHaveClass(form.$(".o_notebook .nav .nav-link:first"),"active");assert.isVisible(form.$(".o_notebook .nav .nav-item:eq(1)"));assert.hasClass(form.$(".o_notebook .nav .nav-link:eq(1)"),"active");form.destroy();});QUnit.test('invisible attrs on first notebook page',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id"/>'+'<notebook>'+'<page string="Foo" attrs=\'{"invisible": [["product_id", "!=", false]]}\'>'+'<field name="foo"/>'+'</page>'+'<page string="Bar">'+'<field name="bar"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_notebook .nav .nav-link:first()'),'active');assert.doesNotHaveClass(form.$('.o_notebook .nav .nav-item:first()'),'o_invisible_modifier');await testUtils.fields.many2one.searchAndClickItem('product_id');assert.doesNotHaveClass(form.$('.o_notebook .nav .nav-link:first()'),'active');assert.hasClass(form.$('.o_notebook .nav .nav-item:first()'),'o_invisible_modifier');assert.hasClass(form.$('.o_notebook .nav .nav-link:nth(1)'),'active');assert.hasClass(form.$('.o_notebook .tab-content .tab-pane:nth(1)'),'active');form.destroy();});QUnit.test('first notebook page invisible',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id"/>'+'<notebook>'+'<page string="Foo" invisible="1">'+'<field name="foo"/>'+'</page>'+'<page string="Bar">'+'<field name="bar"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.notOk(form.$('.o_notebook .nav .nav-item:first()').is(':visible'),'first tab should be invisible');assert.hasClass(form.$('.o_notebook .nav .nav-link:nth(1)'),'active');form.destroy();});QUnit.test('autofocus on second notebook page',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id"/>'+'<notebook>'+'<page string="Choucroute">'+'<field name="foo"/>'+'</page>'+'<page string="Cassoulet" autofocus="autofocus">'+'<field name="bar"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});assert.doesNotHaveClass(form.$('.o_notebook .nav .nav-link:first()'),'active');assert.hasClass(form.$('.o_notebook .nav .nav-link:nth(1)'),'active');form.destroy();});QUnit.test('invisible attrs on group are re-evaluated on field change',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="bar"/>'+'<group attrs=\'{"invisible": [["bar", "!=", true]]}\'>'+'<group>'+'<field name="foo"/>'+'</group>'+'</group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit'},});assert.containsOnce(form,'div.o_group:visible');await testUtils.dom.click('.o_field_boolean input',form);assert.containsOnce(form,'div.o_group:hidden');form.destroy();});QUnit.test('invisible attrs with zero value in domain and unset value in data',async function(assert){assert.expect(1);this.data.partner.fields.int_field.type='monetary';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="foo"/>'+'<group attrs=\'{"invisible": [["int_field", "=", 0.0]]}\'>'+'<div class="hello">this should be invisible</div>'+'<field name="int_field"/>'+'</group>'+'</sheet>'+'</form>',});assert.isNotVisible(form.$('div.hello'));form.destroy();});QUnit.test('rendering stat buttons',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div name="button_box">'+'<button class="oe_stat_button">'+'<field name="int_field"/>'+'</button>'+'<button class="oe_stat_button" attrs=\'{"invisible": [["bar", "=", true]]}\'>'+'<field name="bar"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,});assert.containsN(form,'button.oe_stat_button',2);assert.containsOnce(form,'button.oe_stat_button.o_invisible_modifier');var count=0;await testUtils.mock.intercept(form,"execute_action",function(){count++;});await testUtils.dom.click('.oe_stat_button');assert.strictEqual(count,1,"should have triggered a execute action");form.destroy();});QUnit.test('label uses the string attribute',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<label for="bar" string="customstring"/>'+'<div><field name="bar"/></div>'+'</group>'+'</sheet>'+'</form>',res_id:2,});assert.containsOnce(form,'label.o_form_label:contains(customstring)');form.destroy();});QUnit.test('input ids for multiple occurrences of fields in form view',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <group>
                        <field name="foo"/>
                        <label for="qux"/>
                        <div><field name="qux"/></div>
                    </group>
                    <group>
                        <field name="foo"/>
                        <label for="qux2"/>
                        <div><field name="qux" id="qux2"/></div>
                    </group>
                </form>`,});const fieldIdAttrs=[...form.$('.o_field_widget')].map(n=>n.getAttribute('id'));const labelForAttrs=[...form.$('.o_form_label')].map(n=>n.getAttribute('for'));assert.strictEqual([...new Set(fieldIdAttrs)].length,4,"should have generated a unique id for each field occurrence");assert.deepEqual(fieldIdAttrs,labelForAttrs,"the for attribute of labels must coincide with field ids");form.destroy();});QUnit.test('input ids for multiple occurrences of fields in sub form view (inline)',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="p">
                        <tree><field name="foo"/></tree>
                        <form>
                            <group>
                                <field name="foo"/>
                                <label for="qux"/>
                                <div><field name="qux"/></div>
                            </group>
                            <group>
                                <field name="foo"/>
                                <label for="qux2"/>
                                <div><field name="qux" id="qux2"/></div>
                            </group>
                        </form>
                    </field>
                </form>`,});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(document.body,'.modal .o_form_view');const fieldIdAttrs=[...$('.modal .o_form_view .o_field_widget')].map(n=>n.getAttribute('id'));const labelForAttrs=[...$('.modal .o_form_view .o_form_label')].map(n=>n.getAttribute('for'));assert.strictEqual([...new Set(fieldIdAttrs)].length,4,"should have generated a unique id for each field occurrence");assert.deepEqual(fieldIdAttrs,labelForAttrs,"the for attribute of labels must coincide with field ids");form.destroy();});QUnit.test('input ids for multiple occurrences of fields in sub form view (not inline)',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="p"/></form>',archs:{'partner,false,list':'<tree><field name="foo"/></tree>','partner,false,form':`
                    <form>
                        <group>
                            <field name="foo"/>
                            <label for="qux"/>
                            <div><field name="qux"/></div>
                        </group>
                        <group>
                            <field name="foo"/>
                            <label for="qux2"/>
                            <div><field name="qux" id="qux2"/></div>
                        </group>
                    </form>`},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsOnce(document.body,'.modal .o_form_view');const fieldIdAttrs=[...$('.modal .o_form_view .o_field_widget')].map(n=>n.getAttribute('id'));const labelForAttrs=[...$('.modal .o_form_view .o_form_label')].map(n=>n.getAttribute('for'));assert.strictEqual([...new Set(fieldIdAttrs)].length,4,"should have generated a unique id for each field occurrence");assert.deepEqual(fieldIdAttrs,labelForAttrs,"the for attribute of labels must coincide with field ids");form.destroy();});QUnit.test('two occurrences of invalid field in form view',async function(assert){assert.expect(2);this.data.partner.fields.trululu.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <group>
                        <field name="trululu"/>
                        <field name="trululu"/>
                    </group>
                </form>`,});await testUtils.form.clickSave(form);assert.containsN(form,'.o_form_label.o_field_invalid',2);assert.containsN(form,'.o_field_many2one.o_field_invalid',2);form.destroy();});QUnit.test('tooltips on multiple occurrences of fields and labels',async function(assert){assert.expect(4);const initialDebugMode=odoo.debug;odoo.debug=false;this.data.partner.fields.foo.help='foo tooltip';this.data.partner.fields.bar.help='bar tooltip';const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <group>
                        <field name="foo"/>
                        <label for="bar"/>
                        <div><field name="bar"/></div>
                    </group>
                    <group>
                        <field name="foo"/>
                        <label for="bar2"/>
                        <div><field name="bar" id="bar2"/></div>
                    </group>
                </form>`,});const $fooLabel1=form.$('.o_form_label:nth(0)');$fooLabel1.tooltip('show',false);$fooLabel1.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_help').text().trim(),"foo tooltip");$fooLabel1.trigger($.Event('mouseleave'));const $fooLabel2=form.$('.o_form_label:nth(2)');$fooLabel2.tooltip('show',false);$fooLabel2.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_help').text().trim(),"foo tooltip");$fooLabel2.trigger($.Event('mouseleave'));const $barLabel1=form.$('.o_form_label:nth(1)');$barLabel1.tooltip('show',false);$barLabel1.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_help').text().trim(),"bar tooltip");$barLabel1.trigger($.Event('mouseleave'));const $barLabel2=form.$('.o_form_label:nth(3)');$barLabel2.tooltip('show',false);$barLabel2.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_help').text().trim(),"bar tooltip");$barLabel2.trigger($.Event('mouseleave'));odoo.debug=initialDebugMode;form.destroy();});QUnit.test('readonly attrs on fields are re-evaluated on field change',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" attrs="{\'readonly\': [[\'bar\', \'=\', True]]}"/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.containsOnce(form,'span[name="foo"]',"the foo field widget should be readonly");await testUtils.dom.click(form.$('.o_field_boolean input'));assert.containsOnce(form,'input[name="foo"]',"the foo field widget should have been rerendered to now be editable");await testUtils.dom.click(form.$('.o_field_boolean input'));assert.containsOnce(form,'span[name="foo"]',"the foo field widget should have been rerendered to now be readonly again");await testUtils.dom.click(form.$('.o_field_boolean input'));assert.containsOnce(form,'input[name="foo"]',"the foo field widget should have been rerendered to now be editable again");form.destroy();});QUnit.test('empty fields have o_form_empty class in readonly mode',async function(assert){assert.expect(8);this.data.partner.fields.foo.default=false;this.data.partner.records[1].foo=false;this.data.partner.records[1].trululu=false;this.data.partner.fields.int_field.readonly=true;this.data.partner.onchanges.foo=function(obj){if(obj.foo==="hello"){obj.int_field=false;}};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'<field name="trululu" attrs="{\'readonly\': [[\'foo\', \'=\', False]]}"/>'+'<field name="int_field"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,});assert.containsN(form,'.o_field_widget.o_field_empty',2,"should have 2 empty fields with correct class");assert.containsN(form,'.o_form_label_empty',2,"should have 2 muted labels (for the empty fieds) in readonly");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.o_field_empty',"in edit mode, only empty readonly fields should have the o_field_empty class");assert.containsOnce(form,'.o_form_label_empty',"in edit mode, only labels associated to empty readonly fields should have the o_form_label_empty class");await testUtils.fields.editInput(form.$('input[name=foo]'),'test');assert.containsNone(form,'.o_field_empty',"after readonly modifier change, the o_field_empty class should have been removed");assert.containsNone(form,'.o_form_label_empty',"after readonly modifier change, the o_form_label_empty class should have been removed");await testUtils.fields.editInput(form.$('input[name=foo]'),'hello');assert.containsOnce(form,'.o_field_empty',"after value changed to false for a readonly field, the o_field_empty class should have been added");assert.containsOnce(form,'.o_form_label_empty',"after value changed to false for a readonly field, the o_form_label_empty class should have been added");form.destroy();});QUnit.test('empty fields\' labels still get the empty class after widget rerender',async function(assert){assert.expect(6);this.data.partner.fields.foo.default=false;this.data.partner.records[1].foo=false;this.data.partner.records[1].display_name=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo"/>'+'<field name="display_name" attrs="{\'readonly\': [[\'foo\', \'=\', \'readonly\']]}"/>'+'</group>'+'</form>',res_id:2,});assert.containsN(form,'.o_field_widget.o_field_empty',2);assert.containsN(form,'.o_form_label_empty',2,"should have 1 muted label (for the empty fied) in readonly");await testUtils.form.clickEdit(form);assert.containsNone(form,'.o_field_empty',"in edit mode, only empty readonly fields should have the o_field_empty class");assert.containsNone(form,'.o_form_label_empty',"in edit mode, only labels associated to empty readonly fields should have the o_form_label_empty class");await testUtils.fields.editInput(form.$('input[name=foo]'),'readonly');await testUtils.fields.editInput(form.$('input[name=foo]'),'edit');await testUtils.fields.editInput(form.$('input[name=display_name]'),'some name');await testUtils.fields.editInput(form.$('input[name=foo]'),'readonly');assert.containsNone(form,'.o_field_empty',"there still should not be any empty class on fields as the readonly one is now set");assert.containsNone(form,'.o_form_label_empty',"there still should not be any empty class on labels as the associated readonly field is now set");form.destroy();});QUnit.test('empty inner readonly fields don\'t have o_form_empty class in "create" mode',async function(assert){assert.expect(2);this.data.partner.fields.product_id.readonly=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<group>'+'<field name="product_id"/>'+'</group>'+'</group>'+'</sheet>'+'</form>',});assert.containsNone(form,'.o_form_label_empty',"no empty class on label");assert.containsNone(form,'.o_field_empty',"no empty class on field");form.destroy();});QUnit.test('form view can switch to edit mode',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'</form>',res_id:1,});assert.strictEqual(form.mode,'readonly','form view should be in readonly mode');assert.hasClass(form.$('.o_form_view'),'o_form_readonly');assert.isVisible(form.$buttons.find('.o_form_buttons_view'));assert.isNotVisible(form.$buttons.find('.o_form_buttons_edit'));await testUtils.form.clickEdit(form);assert.strictEqual(form.mode,'edit','form view should be in edit mode');assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.doesNotHaveClass(form.$('.o_form_view'),'o_form_readonly');assert.isNotVisible(form.$buttons.find('.o_form_buttons_view'));assert.isVisible(form.$buttons.find('.o_form_buttons_edit'));form.destroy();});QUnit.test('required attrs on fields are re-evaluated on field change',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" attrs="{\'required\': [[\'bar\', \'=\', True]]}"/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.containsOnce(form,'input[name="foo"].o_required_modifier',"the foo field widget should be required");await testUtils.dom.click('.o_field_boolean input');assert.containsOnce(form,'input[name="foo"]:not(.o_required_modifier)',"the foo field widget should now have been marked as non-required");await testUtils.dom.click('.o_field_boolean input');assert.containsOnce(form,'input[name="foo"].o_required_modifier',"the foo field widget should now have been marked as required again");form.destroy();});QUnit.test('required fields should have o_required_modifier in readonly mode',async function(assert){assert.expect(2);this.data.partner.fields.foo.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'span.o_required_modifier',form);await testUtils.form.clickEdit(form);assert.containsOnce(form,'input.o_required_modifier',"in edit mode, should have 1 input with o_required_modifier");form.destroy();});QUnit.test('required float fields works as expected',async function(assert){assert.expect(10);this.data.partner.fields.qux.required=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="qux"/>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});assert.hasClass(form.$('input[name="qux"]'),'o_required_modifier');assert.strictEqual(form.$('input[name="qux"]').val(),"0.0","qux input is 0 by default (float field)");await testUtils.form.clickSave(form);assert.containsNone(form.$('input[name="qux"]'),"should have switched to readonly");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=qux]'),'1');await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name="qux"]').val(),"1.0","qux input is properly formatted");assert.verifySteps(['onchange','create','read','write','read']);form.destroy();});QUnit.test('separators',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<separator string="Geolocation"/>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'div.o_horizontal_separator');form.destroy();});QUnit.test('invisible attrs on separators',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<separator string="Geolocation" attrs=\'{"invisible": [["bar", "=", True]]}\'/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.hasClass(form.$('div.o_horizontal_separator'),'o_invisible_modifier');form.destroy();});QUnit.test('buttons in form view',async function(assert){assert.expect(8);var rpcCount=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="state" invisible="1"/>'+'<header>'+'<button name="post" class="p" string="Confirm" type="object"/>'+'<button name="some_method" class="s" string="Do it" type="object"/>'+'<button name="some_other_method" states="ab,ef" string="Do not" type="object"/>'+'</header>'+'<sheet>'+'<group>'+'<button string="Geolocate" name="geo_localize" icon="fa-check" type="object"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,mockRPC:function(){rpcCount++;return this._super.apply(this,arguments);},});assert.containsOnce(form,'button.btn i.fa.fa-check');assert.containsN(form,'.o_form_statusbar button',3);assert.containsOnce(form,'button.p[name="post"]:contains(Confirm)');assert.containsN(form,'.o_form_statusbar button:visible',2);await testUtils.mock.intercept(form,'execute_action',function(ev){assert.strictEqual(ev.data.action_data.name,'post',"should trigger execute_action with correct method name");assert.deepEqual(ev.data.env.currentID,2,"should have correct id in ev data");ev.data.on_success();ev.data.on_closed();});rpcCount=0;await testUtils.dom.click('.o_form_statusbar button.p',form);assert.strictEqual(rpcCount,1,"should have done 1 rpcs to reload");await testUtils.mock.intercept(form,'execute_action',function(ev){ev.data.on_fail();});await testUtils.dom.click('.o_form_statusbar button.s',form);assert.strictEqual(rpcCount,1,"should have done 1 rpc, because we do not reload anymore if the server action fails");form.destroy();});QUnit.test('buttons classes in form view',async function(assert){assert.expect(16);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="0"/>'+'<button name="1" class="btn-primary"/>'+'<button name="2" class="oe_highlight"/>'+'<button name="3" class="btn-secondary"/>'+'<button name="4" class="btn-link"/>'+'<button name="5" class="oe_link"/>'+'<button name="6" class="btn-success"/>'+'<button name="7" class="o_this_is_a_button"/>'+'</header>'+'<sheet>'+'<button name="8"/>'+'<button name="9" class="btn-primary"/>'+'<button name="10" class="oe_highlight"/>'+'<button name="11" class="btn-secondary"/>'+'<button name="12" class="btn-link"/>'+'<button name="13" class="oe_link"/>'+'<button name="14" class="btn-success"/>'+'<button name="15" class="o_this_is_a_button"/>'+'</sheet>'+'</form>',res_id:2,});assert.hasAttrValue(form.$('button[name="0"]'),'class','btn btn-secondary');assert.hasAttrValue(form.$('button[name="1"]'),'class','btn btn-primary');assert.hasAttrValue(form.$('button[name="2"]'),'class','btn btn-primary');assert.hasAttrValue(form.$('button[name="3"]'),'class','btn btn-secondary');assert.hasAttrValue(form.$('button[name="4"]'),'class','btn btn-link');assert.hasAttrValue(form.$('button[name="5"]'),'class','btn btn-link');assert.hasAttrValue(form.$('button[name="6"]'),'class','btn btn-success');assert.hasAttrValue(form.$('button[name="7"]'),'class','btn o_this_is_a_button btn-secondary');assert.hasAttrValue(form.$('button[name="8"]'),'class','btn btn-secondary');assert.hasAttrValue(form.$('button[name="9"]'),'class','btn btn-primary');assert.hasAttrValue(form.$('button[name="10"]'),'class','btn btn-primary');assert.hasAttrValue(form.$('button[name="11"]'),'class','btn btn-secondary');assert.hasAttrValue(form.$('button[name="12"]'),'class','btn btn-link');assert.hasAttrValue(form.$('button[name="13"]'),'class','btn btn-link');assert.hasAttrValue(form.$('button[name="14"]'),'class','btn btn-success');assert.hasAttrValue(form.$('button[name="15"]'),'class','btn o_this_is_a_button');form.destroy();});QUnit.test('button in form view and long willStart',async function(assert){assert.expect(6);var rpcCount=0;var FieldChar=fieldRegistry.get('char');fieldRegistry.add('asyncwidget',FieldChar.extend({willStart:function(){assert.step('load '+rpcCount);if(rpcCount===2){return $.Deferred();}
return $.Deferred().resolve();},}));var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="state" invisible="1"/>'+'<header>'+'<button name="post" class="p" string="Confirm" type="object"/>'+'</header>'+'<sheet>'+'<group>'+'<field name="foo" widget="asyncwidget"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,mockRPC:function(){rpcCount++;return this._super.apply(this,arguments);},});assert.verifySteps(['load 1']);await testUtils.mock.intercept(form,'execute_action',function(ev){ev.data.on_success();ev.data.on_closed();});await testUtils.dom.click('.o_form_statusbar button.p',form);assert.verifySteps(['load 2']);testUtils.mock.intercept(form,'execute_action',function(ev){ev.data.on_success();ev.data.on_closed();});await testUtils.dom.click('.o_form_statusbar button.p',form);assert.verifySteps(['load 3']);form.destroy();});QUnit.test('buttons in form view, new record',async function(assert){assert.expect(7);var resID;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="post" class="p" string="Confirm" type="object"/>'+'<button name="some_method" class="s" string="Do it" type="object"/>'+'</header>'+'<sheet>'+'<group>'+'<button string="Geolocate" name="geo_localize" icon="fa-check" type="object"/>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.step(args.method);if(args.method==='create'){return this._super.apply(this,arguments).then(function(result){resID=result;return resID;});}
return this._super.apply(this,arguments);},});await testUtils.mock.intercept(form,'execute_action',function(event){assert.step('execute_action');assert.deepEqual(event.data.env.currentID,resID,"execute action should be done on correct record id");event.data.on_success();event.data.on_closed();});await testUtils.dom.click('.o_form_statusbar button.p',form);assert.verifySteps(['onchange','create','read','execute_action','read']);form.destroy();});QUnit.test('buttons in form view, new record, with field id in view',async function(assert){assert.expect(7);var resID;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="post" class="p" string="Confirm" type="object"/>'+'</header>'+'<sheet>'+'<group>'+'<field name="id" invisible="1"/>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.step(args.method);if(args.method==='create'){return this._super.apply(this,arguments).then(function(result){resID=result;return resID;});}
return this._super.apply(this,arguments);},});await testUtils.mock.intercept(form,'execute_action',function(event){assert.step('execute_action');assert.deepEqual(event.data.env.currentID,resID,"execute action should be done on correct record id");event.data.on_success();event.data.on_closed();});await testUtils.dom.click('.o_form_statusbar button.p',form);assert.verifySteps(['onchange','create','read','execute_action','read']);form.destroy();});QUnit.test('change and save char',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/></group>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){assert.ok(true,"should call the /write route");}
return this._super(route,args);},res_id:2,});assert.strictEqual(form.mode,'readonly','form view should be in readonly mode');assert.containsOnce(form,'span:contains(blip)',"should contain span with field value");await testUtils.form.clickEdit(form);assert.strictEqual(form.mode,'edit','form view should be in edit mode');await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');await testUtils.form.clickSave(form);assert.strictEqual(form.mode,'readonly','form view should be in readonly mode');assert.containsOnce(form,'span:contains(tralala)',"should contain span with field value");form.destroy();});QUnit.test('properly reload data from server',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/></group>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){args.args[1].foo="apple";}
return this._super(route,args);},res_id:2,});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');await testUtils.form.clickSave(form);assert.containsOnce(form,'span:contains(apple)',"should contain span with field value");form.destroy();});QUnit.test('disable buttons until reload data from server',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/></group>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){args.args[1].foo="apple";}else if(args.method==='read'){var result=this._super.apply(this,arguments);return Promise.resolve(def).then(result);}
return this._super(route,args);},res_id:2,});var def=testUtils.makeTestPromise();await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');await testUtils.form.clickSave(form);assert.hasAttrValue(form.$buttons.find('.o_form_button_save'),'disabled','disabled');await def.resolve();await testUtils.nextTick();assert.hasAttrValue(form.$buttons.find('.o_form_button_edit'),'disabled',undefined);form.destroy();});QUnit.test('properly apply onchange in simple case',async function(assert){assert.expect(2);this.data.partner.onchanges={foo:function(obj){obj.int_field=obj.foo.length+1000;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/><field name="int_field"/></group>'+'</form>',res_id:2,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=int_field]').val(),"9","should contain input with initial value");await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');assert.strictEqual(form.$('input[name=int_field]').val(),"1007","should contain input with onchange applied");form.destroy();});QUnit.test('properly apply onchange when changed field is active field',async function(assert){assert.expect(3);this.data.partner.onchanges={int_field:function(obj){obj.int_field=14;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="int_field"/></group>'+'</form>',res_id:2,viewOptions:{mode:'edit'},});assert.strictEqual(form.$('input[name=int_field]').val(),"9","should contain input with initial value");await testUtils.fields.editInput(form.$('input[name=int_field]'),'666');assert.strictEqual(form.$('input[name=int_field]').val(),"14","value should have been set to 14 by onchange");await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget[name=int_field]').text(),"14","value should still be 14");form.destroy();});QUnit.test('onchange send only the present fields to the server',async function(assert){assert.expect(1);this.data.partner.records[0].product_id=false;this.data.partner.onchanges.foo=function(obj){obj.foo=obj.foo+" alligator";};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="p">'+'<tree>'+'<field name="bar"/>'+'<field name="product_id"/>'+'</tree>'+'</field>'+'<field name="timmy"/>'+'</form>',archs:{"partner_type,false,list":'<tree><field name="name"/></tree>'},res_id:1,mockRPC:function(route,args){if(args.method==="onchange"){assert.deepEqual(args.args[3],{"foo":"1","p":"","p.bar":"","p.product_id":"","timmy":"","timmy.name":""},"should send only the fields used in the views");}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');form.destroy();});QUnit.test('onchange only send present fields value',async function(assert){assert.expect(1);this.data.partner.onchanges.foo=function(obj){};let checkOnchange=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'<field name="foo"/>'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name"/>'+'<field name="qux"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==="onchange"&&checkOnchange){assert.deepEqual(args.args[1],{display_name:"first record",foo:"tralala",id:1,p:[[0,args.args[1].p[0][1],{"display_name":"valid line","qux":12.4}]]},"should send the values for the present fields");}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.dom.click('.o_field_x2many_list_row_add a');form.$('.o_field_one2many input:first').focus();await testUtils.nextTick();await testUtils.fields.editInput(form.$('.o_field_one2many input[name=display_name]'),'valid line');form.$('.o_field_one2many input:last').focus();await testUtils.nextTick();await testUtils.fields.editInput(form.$('.o_field_one2many input[name=qux]'),'12.4');checkOnchange=true;await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');form.destroy();});QUnit.test('evaluate in python field options',async function(assert){assert.expect(1);var isOk=false;var tmp=py.eval;py.eval=function(expr){if(expr==="{'horizontal': true}"){isOk=true;}
return tmp.apply(tmp,arguments);};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" options="{\'horizontal\': true}"/>'+'</form>',res_id:2,});py.eval=tmp;assert.ok(isOk,"should have evaluated the field options");form.destroy();});QUnit.test('can create a record with default values',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,viewOptions:{context:{active_field:2},},mockRPC:function(route,args){if(args.method==='create'){assert.strictEqual(args.kwargs.context.active_field,2,"should have send the correct context");}
return this._super.apply(this,arguments);},});var n=this.data.partner.records.length;await testUtils.form.clickCreate(form);assert.strictEqual(form.mode,'edit','form view should be in edit mode');assert.strictEqual(form.$('input:first').val(),"My little Foo Value","should have correct default_get value");await testUtils.form.clickSave(form);assert.strictEqual(form.mode,'readonly','form view should be in readonly mode');assert.strictEqual(this.data.partner.records.length,n+1,"should have created a record");form.destroy();});QUnit.test('default record with a one2many and an onchange on sub field',async function(assert){assert.expect(3);this.data.partner.onchanges.foo=function(){};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){assert.step(args.method);if(args.method==='onchange'){assert.deepEqual(args.args[3],{p:'','p.foo':'1'},"onchangeSpec should be correct (with sub fields)");}
return this._super.apply(this,arguments);},});assert.verifySteps(['onchange']);form.destroy();});QUnit.test('reference field in one2many list',async function(assert){assert.expect(1);this.data.partner.records[0].reference='partner,2';var form=await createView({View:FormView,model:'user',data:this.data,arch:`<form>
                        <field name="name"/>
                        <field name="partner_ids">
                            <tree editable="bottom">
                                <field name="display_name"/>
                                <field name="reference"/>
                            </tree>
                       </field>
                   </form>`,archs:{'partner,false,form':'<form><field name="display_name"/></form>',},mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super(route,args);},res_id:17,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('table td[title="first record"]'));await testUtils.dom.click(form.$('table td button.o_external_button'));await testUtils.fields.editInput($('.modal-body input[name="display_name"]'),'New name');await testUtils.dom.click($('.modal-dialog footer button:first-child'));assert.containsOnce(form,'.o_field_cell[title="New name"]','should not crash and value must be edited');form.destroy();});QUnit.test('toolbar is hidden when switching to edit mode',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="foo"/>'+'</sheet>'+'</form>',viewOptions:{hasActionMenus:true},res_id:1,});assert.containsOnce(form,'.o_cp_action_menus');await testUtils.form.clickEdit(form);assert.containsNone(form,'.o_cp_action_menus');await testUtils.form.clickDiscard(form);assert.containsOnce(form,'.o_cp_action_menus');form.destroy();});QUnit.test('basic default record',async function(assert){assert.expect(2);this.data.partner.fields.foo.default="default foo value";var count=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',mockRPC:function(route,args){count++;return this._super(route,args);},});assert.strictEqual(form.$('input[name=foo]').val(),"default foo value","should have correct default");assert.strictEqual(count,1,"should do only one rpc");form.destroy();});QUnit.test('make default record with non empty one2many',async function(assert){assert.expect(4);this.data.partner.fields.p.default=[[6,0,[]],[0,0,{foo:"new foo1",product_id:41,p:[]}],[0,0,{foo:"new foo2",product_id:37,p:[]}],];var nameGetCount=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='name_get'){nameGetCount++;}
return this._super(route,args);},});assert.containsOnce(form,'td:contains(new foo1)',"should have new foo1 value in one2many");assert.containsOnce(form,'td:contains(new foo2)',"should have new foo2 value in one2many");assert.containsOnce(form,'td:contains(xphone)',"should have a cell with the name field 'product_id', set to xphone");assert.strictEqual(nameGetCount,0,"should have done no nameget");form.destroy();});QUnit.test('make default record with non empty many2one',async function(assert){assert.expect(2);this.data.partner.fields.trululu.default=4;var nameGetCount=0;const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="trululu"/></form>',mockRPC:function(route,args){if(args.method==='name_get'){nameGetCount++;}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.o_field_widget[name=trululu] input').val(),'aaa',"default value should be correctly displayed");assert.strictEqual(nameGetCount,0,"should have done no name_get");form.destroy();});QUnit.test('form view properly change its title',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,});assert.strictEqual(form.$('.o_control_panel .breadcrumb').text(),'first record',"should have the display name of the record as  title");await testUtils.form.clickCreate(form);assert.strictEqual(form.$('.o_control_panel .breadcrumb').text(),_t("New"),"should have the display name of the record as title");form.destroy();});QUnit.test('archive/unarchive a record',async function(assert){assert.expect(10);this.data.partner.fields.active={string:'Active',type:'char',default:true};const form=await createView({View:FormView,model:'partner',data:this.data,res_id:1,viewOptions:{hasActionMenus:true},arch:'<form><field name="active"/><field name="foo"/></form>',mockRPC:function(route,args){assert.step(args.method);if(args.method==='action_archive'){this.data.partner.records[0].active=false;return Promise.resolve();}
if(args.method==='action_unarchive'){this.data.partner.records[0].active=true;return Promise.resolve();}
return this._super(...arguments);},});await cpHelpers.toggleActionMenu(form);assert.containsOnce(form,'.o_cp_action_menus a:contains(Archive)');await cpHelpers.toggleMenuItem(form,"Archive");assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal-footer .btn-primary'));await cpHelpers.toggleActionMenu(form);assert.containsOnce(form,'.o_cp_action_menus a:contains(Unarchive)');await cpHelpers.toggleMenuItem(form,"Unarchive");await cpHelpers.toggleActionMenu(form);assert.containsOnce(form,'.o_cp_action_menus a:contains(Archive)');assert.verifySteps(['read','action_archive','read','action_unarchive','read',]);form.destroy();});QUnit.test('archive action with active field not in view',async function(assert){assert.expect(2);this.data.partner.fields.active={string:'Active',type:'char',default:true};const form=await createView({View:FormView,model:'partner',data:this.data,res_id:1,viewOptions:{hasActionMenus:true},arch:'<form><field name="foo"/></form>',});await cpHelpers.toggleActionMenu(form);assert.containsNone(form,'.o_cp_action_menus a:contains(Archive)');assert.containsNone(form,'.o_cp_action_menus a:contains(Unarchive)');form.destroy();});QUnit.test('can duplicate a record',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,viewOptions:{hasActionMenus:true},});assert.strictEqual(form.$('.o_control_panel .breadcrumb').text(),'first record',"should have the display name of the record as  title");await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Duplicate");assert.strictEqual(form.$('.o_control_panel .breadcrumb').text(),'first record (copy)',"should have duplicated the record");assert.strictEqual(form.mode,"edit",'should be in edit mode');form.destroy();});QUnit.test('duplicating a record preserve the context',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,viewOptions:{hasActionMenus:true,context:{hey:'hoy'}},mockRPC:function(route,args){if(args.method==='read'){assert.strictEqual(args.kwargs.context.hey,'hoy',"should have send the correct context");}
return this._super.apply(this,arguments);},});await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Duplicate");form.destroy();});QUnit.test('cannot duplicate a record',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners" duplicate="false">'+'<field name="foo"/>'+'</form>',res_id:1,viewOptions:{hasActionMenus:true},});assert.strictEqual(form.$('.o_control_panel .breadcrumb').text(),'first record',"should have the display name of the record as  title");assert.containsNone(form,'.o_cp_action_menus a:contains(Duplicate)',"should not contains a 'Duplicate' action");form.destroy();});QUnit.test('clicking on stat buttons in edit mode',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div name="button_box">'+'<button class="oe_stat_button">'+'<field name="bar"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual(args.args[1].foo,"tralala","should have saved the changes");}
assert.step(args.method);return this._super(route,args);},});await testUtils.form.clickEdit(form);var count=0;await testUtils.mock.intercept(form,"execute_action",function(event){event.stopPropagation();count++;});await testUtils.dom.click('.oe_stat_button');assert.strictEqual(count,1,"should have triggered a execute action");assert.strictEqual(form.mode,"edit","form view should be in edit mode");await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');await testUtils.dom.click('.oe_stat_button:first');assert.strictEqual(form.mode,"edit","form view should be in edit mode");assert.strictEqual(count,2,"should have triggered a execute action");assert.verifySteps(['read','write','read']);form.destroy();});QUnit.test('clicking on stat buttons save and reload in edit mode',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div name="button_box">'+'<button class="oe_stat_button" type="action">'+'<field name="int_field" widget="statinfo" string="Some number"/>'+'</button>'+'</div>'+'<group>'+'<field name="name"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='write'){args.args[1].display_name="GOLDORAK";args.args[1].name="GOLDORAK";}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.o_control_panel .breadcrumb').text(),'second record',"should have correct display_name");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=name]'),'some other name');await testUtils.dom.click('.oe_stat_button');assert.strictEqual(form.$('.o_control_panel .breadcrumb').text(),'GOLDORAK',"should have correct display_name");form.destroy();});QUnit.test('buttons with attr "special" do not trigger a save',async function(assert){assert.expect(4);var executeActionCount=0;var writeCount=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<button string="Do something" class="btn-primary" name="abc" type="object"/>'+'<button string="Or discard" class="btn-secondary" special="cancel"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){writeCount++;}
return this._super(route,args);},});await testUtils.mock.intercept(form,"execute_action",function(){executeActionCount++;});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');await testUtils.dom.click(form.$('button:contains(Do something)'));assert.strictEqual(writeCount,1,"should have triggered a write");assert.strictEqual(executeActionCount,1,"should have triggered a execute action");await testUtils.fields.editInput(form.$('input[name=foo]'),'abcdef');await testUtils.dom.click(form.$('button:contains(Or discard)'));assert.strictEqual(writeCount,1,"should not have triggered a write");assert.strictEqual(executeActionCount,2,"should have triggered a execute action");form.destroy();});QUnit.test('buttons with attr "special=save" save',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<button string="Save" class="btn-primary" special="save"/>'+'</form>',res_id:1,intercepts:{execute_action:function(){assert.step('execute_action');},},mockRPC:function(route,args){assert.step(args.method);return this._super(route,args);},viewOptions:{mode:'edit',},});await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');await testUtils.dom.click(form.$('button[special="save"]'));assert.verifySteps(['read','write','read','execute_action']);form.destroy();});QUnit.test('missing widgets do not crash',async function(assert){assert.expect(1);this.data.partner.fields.foo.type='new field type without widget';var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_field_widget');form.destroy();});QUnit.test('nolabel',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<group class="firstgroup"><field name="foo" nolabel="1"/></group>'+'<group class="secondgroup">'+'<field name="product_id"/>'+'<field name="int_field" nolabel="1"/><field name="qux" nolabel="1"/>'+'</group>'+'<group><field name="bar"/></group>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsN(form,"label.o_form_label",2);assert.strictEqual(form.$("label.o_form_label").first().text(),"Product","one should be the one for the product field");assert.strictEqual(form.$("label.o_form_label").eq(1).text(),"Bar","one should be the one for the bar field");assert.hasAttrValue(form.$('.firstgroup td').first(),'colspan',undefined,"foo td should have a default colspan (1)");assert.containsN(form,'.secondgroup tr',2,"int_field and qux should have same tr");assert.containsN(form,'.secondgroup tr:first td',2,"product_id field should be on its own tr");form.destroy();});QUnit.test('many2one in a one2many',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];this.data.partner.records[1].product_id=37;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.containsOnce(form,'td:contains(xphone)',"should display the name of the many2one");form.destroy();});QUnit.test('circular many2many\'s',async function(assert){assert.expect(4);this.data.partner_type.fields.partner_ids={string:"partners",type:"many2many",relation:'partner'};this.data.partner.records[0].timmy=[12];this.data.partner_type.records[0].partner_ids=[1];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="timmy">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="partner_ids">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>'+'</field>'+'</form>',res_id:1,});assert.containsOnce(form,'td:contains(gold)',"should display the name of the many2many on the original form");await testUtils.dom.click(form.$('td:contains(gold)'));assert.containsOnce(document.body,'.modal');assert.containsOnce($('.modal'),'td:contains(first record)',"should display the name of the many2many on the modal form");await testUtils.dom.click('.modal td:contains(first record)');assert.containsN(document.body,'.modal',2,"there should be 2 modals (partner on top of partner_type) opened");form.destroy();});QUnit.test('discard changes on a non dirty form view',async function(assert){assert.expect(4);var nbWrite=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',res_id:1,mockRPC:function(route){if(route==='/web/dataset/call_kw/partner/write'){nbWrite++;}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=foo]').val(),'yop',"input should contain yop");await testUtils.form.clickDiscard(form);assert.containsNone(document.body,'.modal','no confirm modal should be displayed');assert.strictEqual(form.$('.o_field_widget').text(),'yop','field in readonly should display yop');assert.strictEqual(nbWrite,0,"no write RPC should have been done");form.destroy();});QUnit.test('discard changes on a dirty form view',async function(assert){assert.expect(7);var nbWrite=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',res_id:1,mockRPC:function(route){if(route==='/web/dataset/call_kw/partner/write'){nbWrite++;}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=foo]').val(),'yop',"input should contain yop");await testUtils.fields.editInput(form.$('input[name=foo]'),'new value');assert.strictEqual(form.$('input[name=foo]').val(),'new value',"input should contain new value");await testUtils.form.clickDiscard(form);assert.containsOnce(document.body,'.modal',"a confirm modal should be displayed");await testUtils.dom.click('.modal-footer .btn-secondary');assert.strictEqual(form.$('input').val(),'new value','input should still contain new value');await testUtils.form.clickDiscard(form);assert.containsOnce(document.body,'.modal',"a confirm modal should be displayed");await testUtils.dom.click('.modal-footer .btn-primary');assert.strictEqual(form.$('.o_field_widget').text(),'yop','field in readonly should display yop');assert.strictEqual(nbWrite,0,"no write RPC should have been done");form.destroy();});QUnit.test('discard changes on a dirty form view (for date field)',async function(assert){assert.expect(1);this.data.partner.fields.date.default="2017-01-25";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="date"></field></form>',intercepts:{history_back:function(){form.update({},{reload:false});}},});form.$buttons.find('.o_form_button_cancel').focus();await testUtils.dom.click('.o_form_button_cancel');form.$buttons.find('.o_form_button_save').focus();await testUtils.dom.click('.o_form_button_save');assert.containsOnce(form,'span:contains(2017)');form.destroy();});QUnit.test('discard changes on relational data on new record',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><sheet><group>'+'<field name="p">'+'<tree editable="top">'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</group></sheet></form>',intercepts:{history_back:function(){assert.ok(true,"should have sent correct event");form.update({},{reload:false});}},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');assert.strictEqual(form.$('.o_field_widget[name=product_id] input').val(),'xphone',"input should contain xphone");await testUtils.form.clickDiscard(form);await testUtils.dom.click('.modal-footer .btn-primary');assert.notOk(form.$el.prop('outerHTML').match('xphone'),"the string xphone should not be present after discarding");form.destroy();});QUnit.test('discard changes on a new (non dirty, except for defaults) form view',async function(assert){assert.expect(3);this.data.partner.fields.foo.default="ABC";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',intercepts:{history_back:function(){assert.ok(true,"should have sent correct event");}}});assert.strictEqual(form.$('input[name=foo]').val(),'ABC',"input should contain ABC");await testUtils.form.clickDiscard(form);assert.containsNone(document.body,'.modal',"there should not be a confirm modal");form.destroy();});QUnit.test('discard changes on a new (dirty) form view',async function(assert){assert.expect(8);this.data.partner.fields.foo.default="ABC";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',intercepts:{history_back:function(){assert.ok(true,"should have sent correct event");form.update({},{reload:false});}},});assert.strictEqual(form.$('input').val(),'ABC','input should contain ABC');await testUtils.fields.editInput(form.$('input[name=foo]'),'DEF');await testUtils.form.clickDiscard(form);assert.containsOnce(document.body,'.modal','there should be a confirm modal');assert.strictEqual(form.$('input').val(),'DEF','input should be DEF');await testUtils.dom.click('.modal-footer .btn-primary');assert.strictEqual(form.$('input').val(),'ABC','input should now be ABC');await testUtils.fields.editInput(form.$('input[name=foo]'),'GHI');await testUtils.form.clickDiscard(form);assert.strictEqual(form.$('input').val(),'GHI','input should be GHI');await testUtils.dom.click('.modal-footer .btn-primary');assert.strictEqual(form.$('input').val(),'ABC','input should now be ABC');form.destroy();});QUnit.test('discard changes on a duplicated record',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',res_id:1,viewOptions:{hasActionMenus:true},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');await testUtils.form.clickSave(form);await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Duplicate");assert.strictEqual(form.$('input[name=foo]').val(),'tralala','input should contain ABC');await testUtils.form.clickDiscard(form);assert.containsNone(document.body,'.modal',"there should not be a confirm modal");form.destroy();});QUnit.test("switching to another record from a dirty one",async function(assert){assert.expect(11);var nbWrite=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',viewOptions:{ids:[1,2],index:0,},res_id:1,mockRPC:function(route){if(route==='/web/dataset/call_kw/partner/write'){nbWrite++;}
return this._super.apply(this,arguments);},});assert.strictEqual(cpHelpers.getPagerValue(form),'1',"pager value should be 1");assert.strictEqual(cpHelpers.getPagerSize(form),'2',"pager limit should be 2");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=foo]').val(),'yop',"input should contain yop");await testUtils.fields.editInput(form.$('input[name=foo]'),'new value');assert.strictEqual(form.$('input').val(),'new value','input should contain new value');await cpHelpers.pagerNext(form);assert.containsOnce(document.body,'.modal',"a confirm modal should be displayed");await testUtils.dom.click('.modal-footer .btn-secondary');assert.strictEqual(form.$('input[name=foo]').val(),'new value',"input should still contain new value");assert.strictEqual(cpHelpers.getPagerValue(form),'1',"pager value should still be 1");await cpHelpers.pagerNext(form);assert.containsOnce(document.body,'.modal',"a confirm modal should be displayed");await testUtils.dom.click('.modal-footer .btn-primary');assert.strictEqual(form.$('input[name=foo]').val(),'blip',"input should contain blip");assert.strictEqual(cpHelpers.getPagerValue(form),'2',"pager value should be 2");assert.strictEqual(nbWrite,0,'no write RPC should have been done');form.destroy();});QUnit.test('handling dirty state: switching to another record',async function(assert){assert.expect(12);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"></field>'+'<field name="priority" widget="priority"></field>'+'</form>',viewOptions:{ids:[1,2],index:0,},res_id:1,});assert.strictEqual(cpHelpers.getPagerValue(form),'1',"pager value should be 1");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=foo]').val(),'yop',"input should contain yop");await testUtils.fields.editInput(form.$('input[name=foo]'),'new value');assert.strictEqual(form.$('input[name=foo]').val(),'new value',"input should contain new value");await testUtils.form.clickSave(form);await cpHelpers.pagerNext(form);assert.containsNone(document.body,'.modal:visible',"no confirm modal should be displayed");assert.strictEqual(cpHelpers.getPagerValue(form),'2',"pager value should be 2");assert.containsN(form,'.o_priority .fa-star-o',2,'priority widget should have been rendered with correct value');await testUtils.dom.click(form.$('.o_priority .fa-star-o:first'));assert.containsOnce(form,'.o_priority .fa-star','priority widget should have been updated');await cpHelpers.pagerNext(form);assert.containsNone(document.body,'.modal:visible',"no confirm modal should be displayed");assert.strictEqual(cpHelpers.getPagerValue(form),'1',"pager value should be 1");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=foo]').val(),'new value',"input should contain yop");await testUtils.fields.editInput(form.$('input[name=foo]'),'wrong value');await testUtils.form.clickDiscard(form);assert.containsOnce(document.body,'.modal',"a confirm modal should be displayed");await testUtils.dom.click('.modal-footer .btn-primary');await cpHelpers.pagerNext(form);assert.strictEqual(cpHelpers.getPagerValue(form),'2',"pager value should be 2");form.destroy();});QUnit.test('restore local state when switching to another record',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<notebook>'+'<page string="First Page" name="first">'+'<field name="foo"/>'+'</page>'+'<page string="Second page" name="second">'+'<field name="bar"/>'+'</page>'+'</notebook>'+'</form>',viewOptions:{ids:[1,2],index:0,},res_id:1,});await testUtils.dom.click(form.$('.o_notebook .nav-link:eq(1)'));assert.doesNotHaveClass(form.$('.o_notebook .nav-link:eq(0)'),'active');assert.hasClass(form.$('.o_notebook .nav-link:eq(1)'),'active');await cpHelpers.pagerNext(form);assert.doesNotHaveClass(form.$('.o_notebook .nav-link:eq(0)'),'active');assert.hasClass(form.$('.o_notebook .nav-link:eq(1)'),'active');form.destroy();});QUnit.test('pager is hidden in create mode',async function(assert){assert.expect(7);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,viewOptions:{ids:[1,2],index:0,},});assert.containsOnce(form,'.o_pager');assert.strictEqual(cpHelpers.getPagerValue(form),"1","current pager value should be 1");assert.strictEqual(cpHelpers.getPagerSize(form),"2","current pager limit should be 1");await testUtils.form.clickCreate(form);assert.containsNone(form,'.o_pager');await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_pager');assert.strictEqual(cpHelpers.getPagerValue(form),"3","current pager value should be 3");assert.strictEqual(cpHelpers.getPagerSize(form),"3","current pager limit should be 3");form.destroy();});QUnit.test('switching to another record, in readonly mode',async function(assert){assert.expect(5);var pushStateCount=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',viewOptions:{ids:[1,2],index:0,},res_id:1,intercepts:{push_state:function(event){pushStateCount++;}}});assert.strictEqual(form.mode,'readonly','form view should be in readonly mode');assert.strictEqual(cpHelpers.getPagerValue(form),"1",'pager value should be 1');await cpHelpers.pagerNext(form);assert.strictEqual(cpHelpers.getPagerValue(form),"2",'pager value should be 2');assert.strictEqual(form.mode,'readonly','form view should be in readonly mode');assert.strictEqual(pushStateCount,2,"should have triggered 2 push_state");form.destroy();});QUnit.test('modifiers are reevaluated when creating new record',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet><group>'+'<field name="foo" class="foo_field" attrs=\'{"invisible": [["bar", "=", True]]}\'/>'+'<field name="bar"/>'+'</group></sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'span.foo_field');assert.isNotVisible(form.$('span.foo_field'));await testUtils.form.clickCreate(form);assert.containsOnce(form,'input.foo_field');assert.isVisible(form.$('input.foo_field'));form.destroy();});QUnit.test('empty readonly fields are visible on new records',async function(assert){assert.expect(2);this.data.partner.fields.foo.readonly=true;this.data.partner.fields.foo.default=undefined;this.data.partner.records[0].foo=undefined;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet><group>'+'<field name="foo"/>'+'</group></sheet>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_field_empty');await testUtils.form.clickCreate(form);assert.containsNone(form,'.o_field_empty');form.destroy();});QUnit.test('all group children have correct layout classname',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet><group>'+'<group class="inner_group">'+'<field name="name"/>'+'</group>'+'<div class="inner_div">'+'<field name="foo"/>'+'</div>'+'</group></sheet>'+'</form>',res_id:1,});assert.hasClass(form.$('.inner_group'),'o_group_col_6'),assert.hasClass(form.$('.inner_div'),'o_group_col_6'),form.destroy();});QUnit.test('deleting a record',async function(assert){assert.expect(8);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',viewOptions:{ids:[1,2,4],index:0,hasActionMenus:true,},res_id:1,});assert.strictEqual(cpHelpers.getPagerValue(form),"1",'pager value should be 1');assert.strictEqual(cpHelpers.getPagerSize(form),"3",'pager limit should be 3');assert.strictEqual(form.$('span:contains(yop)').length,1,'should have a field with foo value for record 1');assert.ok(!$('.modal:visible').length,'no confirm modal should be displayed');await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Delete");assert.ok($('.modal').length,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer button.btn-primary'));assert.strictEqual(cpHelpers.getPagerValue(form),"1",'pager value should be 1');assert.strictEqual(cpHelpers.getPagerSize(form),"2",'pager limit should be 2');assert.strictEqual(form.$('span:contains(blip)').length,1,'should have a field with foo value for record 2');form.destroy();});QUnit.test('deleting the last record',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners"><field name="foo"></field></form>',viewOptions:{ids:[1],index:0,hasActionMenus:true,},res_id:1,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);}});await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Delete");await testUtils.mock.intercept(form,'history_back',function(){assert.step('history_back');});assert.strictEqual($('.modal').length,1,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer button.btn-primary'));assert.strictEqual($('.modal').length,0,'no confirm modal should be displayed');assert.verifySteps(['read','unlink','history_back']);form.destroy();});QUnit.test('empty required fields cannot be saved',async function(assert){assert.expect(5);this.data.partner.fields.foo.required=true;delete this.data.partner.fields.foo.default;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/></group>'+'</form>',services:{notification:NotificationService.extend({notify:function(params){if(params.type!=='danger'){return;}
assert.strictEqual(params.title,'Invalid fields:',"should have a warning with correct title");assert.strictEqual(params.message,'<ul><li>Foo</li></ul>',"should have a warning with correct message");}}),},});await testUtils.form.clickSave(form);assert.hasClass(form.$('label.o_form_label'),'o_field_invalid');assert.hasClass(form.$('input[name=foo]'),'o_field_invalid');await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');assert.containsNone(form,'.o_field_invalid');form.destroy();});QUnit.test('changes in a readonly form view are saved directly',async function(assert){assert.expect(10);var nbWrite=0;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="foo"/>'+'<field name="priority" widget="priority"/>'+'</group>'+'</form>',mockRPC:function(route){if(route==='/web/dataset/call_kw/partner/write'){nbWrite++;}
return this._super.apply(this,arguments);},res_id:1,});assert.containsN(form,'.o_priority .o_priority_star',2,'priority widget should have been rendered');assert.containsN(form,'.o_priority .fa-star-o',2,'priority widget should have been rendered with correct value');await testUtils.dom.click(form.$('.o_priority .fa-star-o:first'));assert.strictEqual(nbWrite,1,'should have saved directly');assert.containsOnce(form,'.o_priority .fa-star','priority widget should have been updated');await testUtils.form.clickEdit(form);assert.containsN(form,'.o_priority .o_priority_star',2,'priority widget should have been correctly rendered');assert.containsOnce(form,'.o_priority .fa-star','priority widget should have correct value');await testUtils.dom.click(form.$('.o_priority .fa-star-o:first'));assert.strictEqual(nbWrite,1,'should not have saved directly');assert.containsN(form,'.o_priority .fa-star',2,'priority widget should have been updated');await testUtils.form.clickSave(form);assert.strictEqual(nbWrite,2,'should not have saved directly');assert.containsN(form,'.o_priority .fa-star',2,'priority widget should have correct value');form.destroy();});QUnit.test('display a dialog if onchange result is a warning',async function(assert){assert.expect(5);this.data.partner.onchanges={foo:true};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/><field name="int_field"/></group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{int_field:10},warning:{title:"Warning",message:"You must first select a partner",type:'dialog',}});}
return this._super.apply(this,arguments);},intercepts:{warning:function(event){assert.strictEqual(event.data.type,'dialog',"should have triggered an event with the correct data");assert.strictEqual(event.data.title,"Warning","should have triggered an event with the correct data");assert.strictEqual(event.data.message,"You must first select a partner","should have triggered an event with the correct data");},},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=int_field]').val(),'9');await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');assert.strictEqual(form.$('input[name=int_field]').val(),'10');form.destroy();});QUnit.test('display a notificaton if onchange result is a warning with type notification',async function(assert){assert.expect(5);this.data.partner.onchanges={foo:true};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/><field name="int_field"/></group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{int_field:10},warning:{title:"Warning",message:"You must first select a partner",type:'notification',}});}
return this._super.apply(this,arguments);},intercepts:{warning:function(event){assert.strictEqual(event.data.type,'notification',"should have triggered an event with the correct data");assert.strictEqual(event.data.title,"Warning","should have triggered an event with the correct data");assert.strictEqual(event.data.message,"You must first select a partner","should have triggered an event with the correct data");},},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name=int_field]').val(),'9');await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');assert.strictEqual(form.$('input[name=int_field]').val(),'10');form.destroy();});QUnit.test('can create record even if onchange returns a warning',async function(assert){assert.expect(2);this.data.partner.onchanges={foo:true};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/><field name="int_field"/></group>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{int_field:10},warning:{title:"Warning",message:"You must first select a partner"}});}
return this._super.apply(this,arguments);},intercepts:{warning:function(event){assert.ok(true,'should trigger a warning');},},});assert.strictEqual(form.$('input[name="int_field"]').val(),"10","record should have been created and rendered");form.destroy();});QUnit.test('do nothing if add a line in one2many result in a onchange with a warning',async function(assert){assert.expect(3);this.data.partner.onchanges={foo:true};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{},warning:{title:"Warning",message:"You must first select a partner",}});}
return this._super.apply(this,arguments);},intercepts:{warning:function(){assert.step("should have triggered a warning");},},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.containsNone(form,'tr.o_data_row',"should not have added a line");assert.verifySteps(["should have triggered a warning"]);form.destroy();});QUnit.test('button box is rendered in create mode',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div name="button_box" class="oe_button_box">'+'<button type="object" class="oe_stat_button" icon="fa-check-square">'+'<field name="bar"/>'+'</button>'+'</div>'+'</form>',res_id:2,});assert.containsOnce(form,'.oe_stat_button',"button box should be displayed in readonly");await testUtils.form.clickEdit(form);assert.containsOnce(form,'.oe_stat_button',"button box should be displayed in edit on an existing record");await testUtils.form.clickDiscard(form);await testUtils.form.clickCreate(form);assert.containsOnce(form,'.oe_stat_button',"button box should be displayed when creating a new record as well");form.destroy();});QUnit.test('properly apply onchange on one2many fields',async function(assert){assert.expect(5);this.data.partner.records[0].p=[4];this.data.partner.onchanges={foo:function(obj){obj.p=[[5],[1,4,{display_name:"updated record"}],[0,null,{display_name:"created record"}],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/></group>'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});assert.containsOnce(form,'.o_field_one2many .o_data_row',"there should be one one2many record linked at first");assert.strictEqual(form.$('.o_field_one2many .o_data_row td:first').text(),'aaa',"the 'display_name' of the one2many record should be correct");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'let us trigger an onchange');var $o2m=form.$('.o_field_one2many');assert.strictEqual($o2m.find('.o_data_row').length,2,"there should be two linked record");assert.strictEqual($o2m.find('.o_data_row:first td:first').text(),'updated record',"the 'display_name' of the first one2many record should have been updated");assert.strictEqual($o2m.find('.o_data_row:nth(1) td:first').text(),'created record',"the 'display_name' of the second one2many record should be correct");form.destroy();});QUnit.test('properly apply onchange on one2many fields direct click',async function(assert){assert.expect(3);var def=testUtils.makeTestPromise();this.data.partner.records[0].p=[2,4];this.data.partner.onchanges={int_field:function(obj){obj.p=[[5],[1,2,{display_name:"updated record 1",int_field:obj.int_field}],[1,4,{display_name:"updated record 2",int_field:obj.int_field*2}],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</group>'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'<field name="int_field"/>'+'</tree>'+'</field>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='onchange'){var self=this;var my_args=arguments;var my_super=this._super;return def.then(()=>{return my_super.apply(self,my_args)});}
return this._super.apply(this,arguments);},archs:{'partner,false,form':'<form><group><field name="display_name"/><field name="int_field"/></group></form>'},viewOptions:{mode:'edit',},});await testUtils.fields.editInput(form.$('input[name=int_field]'),'2');await testUtils.dom.click(form.$('.o_data_row:first'));assert.containsNone(document.body,'.modal');def.resolve();await testUtils.nextTick();assert.containsOnce(document.body,'.modal');assert.strictEqual($('.modal').find('input[name=int_field]').val(),'2');form.destroy();});QUnit.test('update many2many value in one2many after onchange',async function(assert){assert.expect(2);this.data.partner.records[1].p=[4];this.data.partner.onchanges={foo:function(obj){obj.p=[[5],[1,4,{display_name:"gold",timmy:[[5]],}],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name" attrs="{\'readonly\': [(\'timmy\', \'=\', false)]}"/>'+'<field name="timmy"/>'+'</tree>'+'</field>'+'</form>',res_id:2,});assert.strictEqual($('div[name="p"] .o_data_row td').text().trim(),"aaaNo records","should have proper initial content");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'tralala');assert.strictEqual($('div[name="p"] .o_data_row td').text().trim(),"goldNo records","should have proper initial content");form.destroy();});QUnit.test('delete a line in a one2many while editing another line triggers a warning',async function(assert){assert.expect(3);this.data.partner.records[0].p=[1,2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="bottom">'+'<field name="display_name" required="True"/>'+'</tree>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_data_cell').first());await testUtils.fields.editInput(form.$('input[name=display_name]'),'');await testUtils.dom.click(form.$('.fa-trash-o').eq(1));assert.strictEqual($('.modal').find('.modal-title').first().text(),"Warning","Clicking out of a dirty line while editing should trigger a warning modal.");await testUtils.dom.click($('.modal').find('.btn-primary'));await testUtils.owlCompatibilityNextTick();assert.strictEqual(form.$('.o_data_cell').first().text(),"first record","Value should have been reset to what it was before editing began.");assert.containsOnce(form,'.o_data_row',"The other line should have been deleted.");form.destroy();});QUnit.test('properly apply onchange on many2many fields',async function(assert){assert.expect(14);this.data.partner.onchanges={foo:function(obj){obj.timmy=[[5],[4,12],[4,14],];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/></group>'+'<field name="timmy">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){assert.step(args.method);if(args.method==='read'&&args.model==='partner_type'){assert.deepEqual(args.args[0],[12,14],"should read both m2m with one RPC");}
if(args.method==='write'){assert.deepEqual(args.args[1].timmy,[[6,false,[12,14]]],"should correctly save the changed m2m values");}
return this._super.apply(this,arguments);},res_id:2,});assert.containsNone(form,'.o_field_many2many .o_data_row',"there should be no many2many record linked at first");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'let us trigger an onchange');var $m2m=form.$('.o_field_many2many');assert.strictEqual($m2m.find('.o_data_row').length,2,"there should be two linked records");assert.strictEqual($m2m.find('.o_data_row:first td:first').text(),'gold',"the 'display_name' of the first m2m record should be correctly displayed");assert.strictEqual($m2m.find('.o_data_row:nth(1) td:first').text(),'silver',"the 'display_name' of the second m2m record should be correctly displayed");await testUtils.form.clickSave(form);assert.verifySteps(['read','onchange','read','write','read','read']);form.destroy();});QUnit.test('display_name not sent for onchanges if not in view',async function(assert){assert.expect(7);this.data.partner.records[0].timmy=[12];this.data.partner.onchanges={foo:function(){},};this.data.partner_type.onchanges={name:function(){},};var readInModal=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="foo"/>'+'<field name="timmy">'+'<tree>'+'<field name="name"/>'+'</tree>'+'<form>'+'<field name="name"/>'+'<field name="color"/>'+'</form>'+'</field>'+'</group>'+'</form>',mockRPC:function(route,args){if(args.method==='read'&&args.model==='partner'){assert.deepEqual(args.args[1],['foo','timmy','display_name'],"should read display_name even if not in the view");}
if(args.method==='read'&&args.model==='partner_type'){if(!readInModal){assert.deepEqual(args.args[1],['name'],"should not read display_name for records in the list");}else{assert.deepEqual(args.args[1],['name','color','display_name'],"should read display_name when opening the subrecord");}}
if(args.method==='onchange'&&args.model==='partner'){assert.deepEqual(args.args[1],{id:1,foo:'coucou',timmy:[[6,false,[12]]],},"should only send the value of fields in the view (+ id)");assert.deepEqual(args.args[3],{foo:'1',timmy:'','timmy.name':'1','timmy.color':'',},"only the fields in the view should be in the onchange spec");}
if(args.method==='onchange'&&args.model==='partner_type'){assert.deepEqual(args.args[1],{id:12,name:'new name',color:2,},"should only send the value of fields in the view (+ id)");assert.deepEqual(args.args[3],{name:'1',color:'',},"only the fields in the view should be in the onchange spec");}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{mode:'edit',},});await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),"coucou");readInModal=true;await testUtils.dom.click(form.$('.o_data_row .o_data_cell:first'));await testUtils.fields.editInput($('.modal .o_field_widget[name=name]'),"new name");form.destroy();});QUnit.test('onchanges on date(time) fields',async function(assert){assert.expect(6);this.data.partner.onchanges={foo:function(obj){obj.date='2021-12-12';obj.datetime='2021-12-12 10:55:05';},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="foo"/>'+'<field name="date"/>'+'<field name="datetime"/>'+'</group>'+'</form>',res_id:1,session:{getTZOffset:function(){return 120;},},});assert.strictEqual(form.$('.o_field_widget[name=date]').text(),'01/25/2017',"the initial date should be correct");assert.strictEqual(form.$('.o_field_widget[name=datetime]').text(),'12/12/2016 12:55:05',"the initial datetime should be correct");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_field_widget[name=date] input').val(),'01/25/2017',"the initial date should be correct in edit");assert.strictEqual(form.$('.o_field_widget[name=datetime] input').val(),'12/12/2016 12:55:05',"the initial datetime should be correct in edit");await testUtils.fields.editInput(form.$('.o_field_widget[name="foo"]'),"coucou");assert.strictEqual(form.$('.o_field_widget[name=date] input').val(),'12/12/2021',"the initial date should be correct in edit");assert.strictEqual(form.$('.o_field_widget[name=datetime] input').val(),'12/12/2021 12:55:05',"the initial datetime should be correct in edit");form.destroy();});QUnit.test('onchanges are not sent for each keystrokes',async function(assert){var done=assert.async();assert.expect(5);var onchangeNbr=0;this.data.partner.onchanges={foo:function(obj){obj.int_field=obj.foo.length+1000;},};var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group><field name="foo"/><field name="int_field"/></group>'+'</form>',res_id:2,fieldDebounce:3,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){onchangeNbr++;return concurrency.delay(3).then(function(){def.resolve();return result;});}
return result;},});await testUtils.form.clickEdit(form);testUtils.fields.editInput(form.$('input[name=foo]'),'1');assert.strictEqual(onchangeNbr,0,"no onchange has been called yet");testUtils.fields.editInput(form.$('input[name=foo]'),'12');assert.strictEqual(onchangeNbr,0,"no onchange has been called yet");return waitForFinishedOnChange().then(async function(){assert.strictEqual(onchangeNbr,1,"one onchange has been called");await testUtils.fields.editAndTrigger(form.$('input[name=foo]'),'123',['change']);assert.strictEqual(onchangeNbr,2,"one onchange has been called immediately");return waitForFinishedOnChange();}).then(function(){assert.strictEqual(onchangeNbr,2,"no extra onchange should have been called");form.destroy();done();});function waitForFinishedOnChange(){return def.then(function(){def=testUtils.makeTestPromise();return concurrency.delay(0);});}});QUnit.test('onchanges are not sent for invalid values',async function(assert){assert.expect(6);this.data.partner.onchanges={int_field:function(obj){obj.foo=String(obj.int_field);},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group><field name="foo"/><field name="int_field"/></group>'+'</form>',res_id:2,mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name="int_field"]'),"123");assert.strictEqual(form.$('input[name="foo"]').val(),"123","the onchange has been applied");await testUtils.fields.editInput(form.$('input[name="int_field"]'),"123a");assert.strictEqual(form.$('input[name="foo"]').val(),"123","the onchange has not been applied");await testUtils.form.clickSave(form);assert.hasClass(form.$('input[name="int_field"]'),'o_field_invalid',"input int_field is marked as invalid");assert.verifySteps(['read','onchange']);form.destroy();});QUnit.test('rpc complete after destroying parent',async function(assert){assert.expect(0);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<button name="update_module" type="object" class="o_form_button_update"/>'+'</form>',res_id:2,intercepts:{execute_action:function(event){form.destroy();event.data.on_success();}}});await testUtils.dom.click(form.$('.o_form_button_update'));});QUnit.test('onchanges that complete after discarding',async function(assert){assert.expect(5);var def1=testUtils.makeTestPromise();this.data.partner.onchanges={foo:function(obj){obj.int_field=obj.foo.length+1000;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group><field name="foo"/><field name="int_field"/></group>'+'</form>',res_id:2,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){assert.step('onchange is done');return def1.then(function(){return result;});}
return result;},});assert.strictEqual(form.$('span[name="foo"]').text(),"blip","field foo should be displayed to initial value");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'1234');await testUtils.form.clickDiscard(form);await testUtils.dom.click($('.modal-footer .btn-primary'));assert.strictEqual(form.$('span[name="foo"]').text(),"blip","field foo should still be displayed to initial value");def1.resolve();await testUtils.nextTick();assert.strictEqual(form.$('span[name="foo"]').text(),"blip","field foo should still be displayed to initial value");assert.verifySteps(['onchange is done']);form.destroy();});QUnit.test('discarding before save returns',async function(assert){assert.expect(4);var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group><field name="foo"/></group>'+'</form>',res_id:2,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='write'){return def.then(_.constant(result));}
return result;},viewOptions:{mode:'edit',},});await testUtils.fields.editInput(form.$('input[name=foo]'),'1234');await testUtils.form.clickSave(form);form.discardChanges();assert.strictEqual(form.$('.o_field_widget[name="foo"]').val(),"1234","field foo should still contain new value");assert.strictEqual($('.modal').length,0,"Confirm dialog should not be displayed");def.resolve();await testUtils.nextTick();assert.strictEqual($('.modal').length,0,"Confirm dialog should not be displayed");assert.strictEqual(form.$('.o_field_widget[name="foo"]').text(),"1234","value should have been saved and rerendered in readonly");form.destroy();});QUnit.test('unchanged relational data is sent for onchanges',async function(assert){assert.expect(1);this.data.partner.records[1].p=[4];this.data.partner.onchanges={foo:function(obj){obj.int_field=obj.foo.length+1000;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){assert.deepEqual(args.args[1].p,[[4,4,false]],"should send a command for field p even if it hasn't changed");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'trigger an onchange');form.destroy();});QUnit.test('onchanges on unknown fields of o2m are ignored',async function(assert){assert.expect(2);this.data.partner.records[1].p=[4];this.data.partner.onchanges={foo:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>'+'<form>'+'<field name="foo"/>'+'<field name="product_id"/>'+'</form>'+'</field>'+'</group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{p:[[5],[1,4,{foo:'foo changed',product_id:[37,"xphone"],}]],},});}
if(args.method==='write'){assert.deepEqual(args.args[1].p,[[1,4,{foo:'foo changed',}]],"should only write value of known fields");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'trigger an onchange');await testUtils.owlCompatibilityNextTick();assert.strictEqual(form.$('.o_data_row td:first').text(),'foo changed',"onchange should have been correctly applied on field in o2m list");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('onchange value are not discarded on o2m edition',async function(assert){assert.expect(4);this.data.partner.records[1].p=[4];this.data.partner.onchanges={foo:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>'+'<form>'+'<field name="foo"/>'+'<field name="product_id"/>'+'</form>'+'</field>'+'</group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{p:[[5],[1,4,{foo:'foo changed'}]],},});}
if(args.method==='write'){assert.deepEqual(args.args[1].p,[[1,4,{foo:'foo changed',}]],"should only write value of known fields");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_data_row td:first').text(),'My little Foo Value',"the initial value should be the default one");await testUtils.fields.editInput(form.$('input[name=foo]'),'trigger an onchange');await testUtils.owlCompatibilityNextTick();assert.strictEqual(form.$('.o_data_row td:first').text(),'foo changed',"onchange should have been correctly applied on field in o2m list");await testUtils.dom.click(form.$('.o_data_row'));assert.strictEqual($('.modal .modal-title').text().trim(),'Open: one2many field',"the field string is displayed in the modal title");assert.strictEqual($('.modal .o_field_widget').val(),'foo changed',"the onchange value hasn't been discarded when opening the o2m");form.destroy();});QUnit.test('args of onchanges in o2m fields are correct (inline edition)',async function(assert){assert.expect(3);this.data.partner.records[1].p=[4];this.data.partner.fields.p.relation_field='rel_field';this.data.partner.fields.int_field.default=14;this.data.partner.onchanges={int_field:function(obj){obj.foo='['+obj.rel_field.foo+'] '+obj.int_field;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo"/>'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>'+'</field>'+'</group>'+'</form>',res_id:2,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_data_row td:first').text(),'My little Foo Value',"the initial value should be the default one");await testUtils.dom.click(form.$('.o_data_row td:nth(1)'));await testUtils.fields.editInput(form.$('.o_data_row input:nth(1)'),77);assert.strictEqual(form.$('.o_data_row input:first').val(),'[blip] 77',"onchange should have been correctly applied");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('.o_data_row input:first').val(),'[blip] 14',"onchange should have been correctly applied after default get");form.destroy();});QUnit.test('args of onchanges in o2m fields are correct (dialog edition)',async function(assert){assert.expect(6);this.data.partner.records[1].p=[4];this.data.partner.fields.p.relation_field='rel_field';this.data.partner.fields.int_field.default=14;this.data.partner.onchanges={int_field:function(obj){obj.foo='['+obj.rel_field.foo+'] '+obj.int_field;},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo"/>'+'<field name="p" string="custom label">'+'<tree>'+'<field name="foo"/>'+'</tree>'+'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</form>'+'</field>'+'</group>'+'</form>',res_id:2,});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('.o_data_row td:first').text(),'My little Foo Value',"the initial value should be the default one");await testUtils.dom.click(form.$('.o_data_row td:first'));await testUtils.nextTick();await testUtils.fields.editInput($('.modal input:nth(1)'),77);assert.strictEqual($('.modal input:first').val(),'[blip] 77',"onchange should have been correctly applied");await testUtils.dom.click($('.modal-footer .btn-primary'));assert.strictEqual(form.$('.o_data_row td:first').text(),'[blip] 77',"onchange should have been correctly applied");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal .modal-title').text().trim(),'Create custom label',"the custom field label is applied in the modal title");assert.strictEqual($('.modal input:first').val(),'[blip] 14',"onchange should have been correctly applied after default get");await testUtils.dom.clickFirst($('.modal-footer .btn-primary'));await testUtils.nextTick();assert.strictEqual(form.$('.o_data_row:nth(1) td:first').text(),'[blip] 14',"onchange should have been correctly applied after default get");form.destroy();});QUnit.test('context of onchanges contains the context of changed fields',async function(assert){assert.expect(2);this.data.partner.onchanges={foo:function(){},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="foo" context="{\'test\': 1}"/>'+'<field name="int_field" context="{\'int_ctx\': 1}"/>'+'</group>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'){assert.strictEqual(args.kwargs.context.test,1,"the context of the field triggering the onchange should be given");assert.strictEqual(args.kwargs.context.int_ctx,undefined,"the context of other fields should not be given");}
return this._super.apply(this,arguments);},res_id:2,});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name=foo]'),'coucou');form.destroy();});QUnit.test('navigation with tab key in form view',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" widget="email"/>'+'<field name="bar"/>'+'<field name="display_name" widget="url"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,});await testUtils.form.clickEdit(form);form.$('input[name="foo"]').focus();const tabKey={keyCode:$.ui.keyCode.TAB,which:$.ui.keyCode.TAB};await testUtils.dom.triggerEvent(form.$('input[name="foo"]'),'keydown',tabKey);assert.ok($.contains(form.$('div[name="bar"]')[0],document.activeElement),"bar checkbox should be focused");await testUtils.dom.triggerEvent(document.activeElement,'keydown',tabKey);assert.strictEqual(form.$('input[name="display_name"]')[0],document.activeElement,"display_name should be focused");const shiftTabKey=Object.assign({},tabKey,{shiftKey:true});await testUtils.dom.triggerEvent(document.activeElement,'keydown',shiftTabKey);await testUtils.dom.triggerEvent(document.activeElement,'keydown',shiftTabKey);assert.strictEqual(document.activeElement,form.$('input[name="foo"]')[0],"first input should be focused");form.destroy();});QUnit.test('navigation with tab key in readonly form view',async function(assert){assert.expect(3);this.data.partner.records[1].product_id=37;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="trululu"/>'+'<field name="foo"/>'+'<field name="product_id"/>'+'<field name="foo" widget="phone"/>'+'<field name="display_name" widget="url"/>'+'</group>'+'</sheet>'+'</form>',res_id:2,});form.$('[name="trululu"]').focus();form.$('[name="trululu"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));form.$('[name="foo"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('[name="product_id"]')[0],document.activeElement,"product_id should be focused");form.$('[name="product_id"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));form.$('[name="foo"]:eq(1)').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('[name="display_name"]')[0],document.activeElement,"display_name should be focused");$(document.activeElement).trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));$(document.activeElement).trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));$(document.activeElement).trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));$(document.activeElement).trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));assert.strictEqual(document.activeElement,form.$('[name="trululu"]')[0],"first many2one should be focused");form.destroy();});QUnit.test('skip invisible fields when navigating with TAB',async function(assert){assert.expect(1);this.data.partner.records[0].bar=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet><group>'+'<field name="foo"/>'+'<field name="bar" invisible="1"/>'+'<field name="product_id" attrs=\'{"invisible": [["bar", "=", true]]}\'/>'+'<field name="int_field"/>'+'</group></sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);form.$('input[name="foo"]').focus();form.$('input[name="foo"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('input[name="int_field"]')[0],document.activeElement,"int_field should be focused");form.destroy();});QUnit.test('navigation with tab key selects a value in form view',async function(assert){assert.expect(5);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <field name="display_name"/>
                    <field name="int_field"/>
                    <field name="qux"/>
                    <field name="trululu"/>
                    <field name="date"/>
                    <field name="datetime"/>
                </form>`,res_id:1,viewOptions:{mode:'edit',},});await testUtils.dom.click(form.el.querySelector('input[name="display_name"]'));await testUtils.fields.triggerKeydown(document.activeElement,'tab');assert.strictEqual(document.getSelection().toString(),"10","int_field value should be selected");await testUtils.fields.triggerKeydown(document.activeElement,'tab');assert.strictEqual(document.getSelection().toString(),"0.4","qux field value should be selected");await testUtils.fields.triggerKeydown(document.activeElement,'tab');assert.strictEqual(document.getSelection().toString(),"aaa","trululu field value should be selected");await testUtils.fields.triggerKeydown(document.activeElement,'tab');assert.strictEqual(document.getSelection().toString(),"01/25/2017","date field value should be selected");await testUtils.fields.triggerKeydown(document.activeElement,'tab');assert.strictEqual(document.getSelection().toString(),"12/12/2016 10:55:05","datetime field value should be selected");form.destroy();});QUnit.test('clicking on a stat button with a context',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div class="oe_button_box" name="button_box">'+'<button class="oe_stat_button" type="action" name="1" context="{\'test\': active_id}">'+'<field name="qux" widget="statinfo"/>'+'</button>'+'</div>'+'</sheet>'+'</form>',res_id:2,viewOptions:{context:{some_context:true},},intercepts:{execute_action:function(e){assert.deepEqual(e.data.action_data.context,{'test':2},"button context should have been evaluated and given to the action, with magicc without previous context");},},});await testUtils.dom.click(form.$('.oe_stat_button'));form.destroy();});QUnit.test('clicking on a stat button with no context',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<div class="oe_button_box" name="button_box">'+'<button class="oe_stat_button" type="action" name="1">'+'<field name="qux" widget="statinfo"/>'+'</button>'+'</div>'+'</sheet>'+'</form>',res_id:2,viewOptions:{context:{some_context:true},},intercepts:{execute_action:function(e){assert.deepEqual(e.data.action_data.context,{},"button context should have been evaluated and given to the action, with magic keys but without previous context");},},});await testUtils.dom.click(form.$('.oe_stat_button'));form.destroy();});QUnit.test('diplay a stat button outside a buttonbox',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<button class="oe_stat_button" type="action" name="1">'+'<field name="int_field" widget="statinfo"/>'+'</button>'+'</sheet>'+'</form>',res_id:2,});assert.containsOnce(form,'button .o_field_widget',"a field widget should be display inside the button");assert.strictEqual(form.$('button .o_field_widget').children().length,2,"the field widget should have 2 children, the text and the value");assert.strictEqual(parseInt(form.$('button .o_field_widget .o_stat_value').text()),9,"the value rendered should be the same as the field value");form.destroy();});QUnit.test('diplay something else than a button in a buttonbox',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div name="button_box" class="oe_button_box">'+'<button type="object" class="oe_stat_button" icon="fa-check-square">'+'<field name="bar"/>'+'</button>'+'<label/>'+'</div>'+'</form>',res_id:2,});assert.strictEqual(form.$('.oe_button_box').children().length,2,"button box should contain two children");assert.containsOnce(form,'.oe_button_box > .oe_stat_button',"button box should only contain one button");assert.containsOnce(form,'.oe_button_box > label',"button box should only contain one label");form.destroy();});QUnit.test('invisible fields are not considered as visible in a buttonbox',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div name="button_box" class="oe_button_box">'+'<field name="foo" invisible="1"/>'+'<field name="bar" invisible="1"/>'+'<field name="int_field" invisible="1"/>'+'<field name="qux" invisible="1"/>'+'<field name="display_name" invisible="1"/>'+'<field name="state" invisible="1"/>'+'<field name="date" invisible="1"/>'+'<field name="datetime" invisible="1"/>'+'<button type="object" class="oe_stat_button" icon="fa-check-square"/>'+'</div>'+'</form>',res_id:2,});assert.strictEqual(form.$('.oe_button_box').children().length,1,"button box should contain only one child");assert.hasClass(form.$('.oe_button_box'),'o_not_full',"the buttonbox should not be full");form.destroy();});QUnit.test('display correctly buttonbox, in large size class',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div name="button_box" class="oe_button_box">'+'<button type="object" class="oe_stat_button" icon="fa-check-square">'+'<field name="bar"/>'+'</button>'+'<button type="object" class="oe_stat_button" icon="fa-check-square">'+'<field name="foo"/>'+'</button>'+'</div>'+'</form>',res_id:2,config:{device:{size_class:5},},});assert.strictEqual(form.$('.oe_button_box').children().length,2,"button box should contain two children");form.destroy();});QUnit.test('one2many default value creation',async function(assert){assert.expect(1);this.data.partner.records[0].product_ids=[37];this.data.partner.fields.product_ids.default=[[0,0,{name:'xdroid',partner_type_id:12}]];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_ids" nolabel="1">'+'<tree editable="top" create="0">'+'<field name="name" readonly="1"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){var command=args.args[0].product_ids[0];assert.strictEqual(command[2].partner_type_id,12,"the default partner_type_id should be equal to 12");}
return this._super.apply(this,arguments);},});await testUtils.form.clickSave(form);form.destroy();});QUnit.test('many2manys inside one2manys are saved correctly',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p">'+'<tree editable="top">'+'<field name="timmy" widget="many2many_tags"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){var command=args.args[0].p;assert.deepEqual(command,[[0,command[0][1],{timmy:[[6,false,[12]]],}]],"the default partner_type_id should be equal to 12");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.many2one.clickOpenDropdown('timmy');await testUtils.fields.many2one.clickHighlightedItem('timmy');await testUtils.form.clickSave(form);form.destroy();});QUnit.test('one2manys (list editable) inside one2manys are saved correctly',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p">'+'<tree>'+'<field name="p"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',archs:{"partner,false,form":'<form>'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</form>'},mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0].p,[[0,args.args[0].p[0][1],{p:[[0,args.args[0].p[0][2].p[0][1],{display_name:"xtv"}]],}]],"create should be called with the correct arguments");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.click($('.modal-body .o_field_one2many .o_field_x2many_list_row_add a'));await testUtils.fields.editInput($('.modal-body input'),'xtv');await testUtils.dom.click($('.modal-footer button:first'));assert.strictEqual($('.modal').length,0,"dialog should be closed");var row=form.$('.o_field_one2many .o_list_view .o_data_row');assert.strictEqual(row.children()[0].textContent,'1 record',"the cell should contains the number of record: 1");await testUtils.form.clickSave(form);form.destroy();});QUnit.test('oe_read_only and oe_edit_only classNames on fields inside groups',async function(assert){assert.expect(10);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <group>
                        <field name="foo" class="oe_read_only"/>
                        <field name="bar" class="oe_edit_only"/>
                    </group>
                </form>`,res_id:1,});assert.hasClass(form.$('.o_form_view'),'o_form_readonly','form should be in readonly mode');assert.isVisible(form.$('.o_field_widget[name=foo]'));assert.isVisible(form.$('label:contains(Foo)'));assert.isNotVisible(form.$('.o_field_widget[name=bar]'));assert.isNotVisible(form.$('label:contains(Bar)'));await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable','form should be in readonly mode');assert.isNotVisible(form.$('.o_field_widget[name=foo]'));assert.isNotVisible(form.$('label:contains(Foo)'));assert.isVisible(form.$('.o_field_widget[name=bar]'));assert.isVisible(form.$('label:contains(Bar)'));form.destroy();});QUnit.test('oe_read_only className is handled in list views',async function(assert){assert.expect(7);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'<field name="display_name" class="oe_read_only"/>'+'<field name="bar"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,});assert.hasClass(form.$('.o_form_view'),'o_form_readonly','form should be in readonly mode');assert.isVisible(form.$('.o_field_one2many .o_list_view thead th[data-name="display_name"]'),'display_name cell should be visible in readonly mode');await testUtils.form.clickEdit(form);assert.strictEqual(form.el.querySelector('th[data-name="foo"]').style.width,'100%','As the only visible char field, "foo" should take 100% of the remaining space');assert.strictEqual(form.el.querySelector('th.oe_read_only').style.width,'0px','"oe_read_only" in edit mode should have a 0px width');assert.hasClass(form.$('.o_form_view'),'o_form_editable','form should be in edit mode');assert.isNotVisible(form.$('.o_field_one2many .o_list_view thead th[data-name="display_name"]'),'display_name cell should not be visible in edit mode');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();assert.hasClass(form.$('.o_form_view .o_list_view tbody tr:first input[name="display_name"]'),'oe_read_only','display_name input should have oe_read_only class');form.destroy();});QUnit.test('oe_edit_only className is handled in list views',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p">'+'<tree editable="top">'+'<field name="foo"/>'+'<field name="display_name" class="oe_edit_only"/>'+'<field name="bar"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,});assert.hasClass(form.$('.o_form_view'),'o_form_readonly','form should be in readonly mode');assert.isNotVisible(form.$('.o_field_one2many .o_list_view thead th[data-name="display_name"]'),'display_name cell should not be visible in readonly mode');await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable','form should be in edit mode');assert.isVisible(form.$('.o_field_one2many .o_list_view thead th[data-name="display_name"]'),'display_name cell should be visible in edit mode');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.owlCompatibilityNextTick();assert.hasClass(form.$('.o_form_view .o_list_view tbody tr:first input[name="display_name"]'),'oe_edit_only','display_name input should have oe_edit_only class');form.destroy();});QUnit.test('*_view_ref in context are passed correctly',async function(assert){var done=assert.async();assert.expect(3);createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p" context="{\'tree_view_ref\':\'module.tree_view_ref\'}"/>'+'</sheet>'+'</form>',res_id:1,intercepts:{load_views:function(event){var context=event.data.context;assert.strictEqual(context.tree_view_ref,'module.tree_view_ref',"context should contain tree_view_ref");event.data.on_success();}},viewOptions:{context:{some_context:false},},mockRPC:function(route,args){if(args.method==='read'){assert.strictEqual('some_context'in args.kwargs.context&&!args.kwargs.context.some_context,true,"the context should have been set");}
return this._super.apply(this,arguments);},}).then(async function(form){await form.reload();form.destroy();done();});});QUnit.test('non inline subview and create=0 in action context',async function(assert){assert.expect(2);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="product_ids" mode="kanban"/></form>',archs:{"product,false,kanban":`<kanban>
                                            <templates><t t-name="kanban-box">
                                                <div><field name="name"/></div>
                                            </t></templates>
                                        </kanban>`,},res_id:1,viewOptions:{context:{create:false},mode:'edit',},});assert.containsNone(form,'.o_form_button_create');assert.containsOnce(form,'.o-kanban-button-new');form.destroy();});QUnit.test('readonly fields with modifiers may be saved',async function(assert){assert.expect(3);this.data.partner.fields.foo.readonly=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="foo" attrs="{\'readonly\': [(\'bar\',\'=\',False)]}"/>'+'<field name="bar"/>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{foo:'New foo value'},"the new value should be saved");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.containsOnce(form,'input[name="foo"]',"foo field should be editable");await testUtils.fields.editInput(form.$('input[name="foo"]'),'New foo value');await testUtils.form.clickSave(form);assert.strictEqual(form.$('.o_field_widget[name=foo]').text(),'New foo value',"new value for foo field should have been saved");form.destroy();});QUnit.test('readonly set by modifier do not break many2many_tags',async function(assert){assert.expect(0);this.data.partner.onchanges={bar:function(obj){obj.timmy=[[6,false,[12]]];},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="bar"/>'+'<field name="timmy" widget="many2many_tags" attrs="{\'readonly\': [(\'bar\',\'=\',True)]}"/>'+'</sheet>'+'</form>',res_id:5,});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_widget[name=bar] input'));form.destroy();});QUnit.test('check if id and active_id are defined',async function(assert){assert.expect(2);let checkOnchange=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p" context="{\'default_trululu\':active_id, \'current_id\':id}">'+'<tree>'+'<field name="trululu"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',archs:{"partner,false,form":'<form><field name="trululu"/></form>'},mockRPC:function(route,args){if(args.method==='onchange'&&checkOnchange){assert.strictEqual(args.kwargs.context.current_id,false,"current_id should be false");assert.strictEqual(args.kwargs.context.default_trululu,false,"default_trululu should be false");}
return this._super.apply(this,arguments);},});checkOnchange=true;await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.destroy();});QUnit.test('modifiers are considered on multiple <footer/> tags',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="bar"/>'+'<footer attrs="{\'invisible\': [(\'bar\',\'=\',False)]}">'+'<button>Hello</button>'+'<button>World</button>'+'</footer>'+'<footer attrs="{\'invisible\': [(\'bar\',\'!=\',False)]}">'+'<button>Foo</button>'+'</footer>'+'</form>',res_id:1,viewOptions:{footerToButtons:true,mode:'edit',},});assert.deepEqual(getVisibleButtonTexts(),["Hello","World"],"only the first button section should be visible");await testUtils.dom.click(form.$(".o_field_boolean input"));assert.deepEqual(getVisibleButtonTexts(),["Foo"],"only the second button section should be visible");form.destroy();function getVisibleButtonTexts(){var $visibleButtons=form.$buttons.find('button:visible');return _.map($visibleButtons,function(el){return el.innerHTML.trim();});}});QUnit.test('buttons in footer are moved to $buttons if necessary',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<footer>'+'<button string="Create" type="object" class="infooter"/>'+'</footer>'+'</form>',res_id:1,viewOptions:{footerToButtons:true},});assert.containsOnce(form.$('.o_control_panel'),'button.infooter');assert.containsNone(form.$('.o_form_view'),'button.infooter');await testUtils.form.reload(form);assert.containsOnce(form.$('.o_control_panel'),'button.infooter');assert.containsNone(form.$('.o_form_view'),'button.infooter');form.destroy();});QUnit.test('open new record even with warning message',async function(assert){assert.expect(3);this.data.partner.onchanges={foo:true};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="foo"/></group>'+'</form>',res_id:2,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({warning:{title:"Warning",message:"Any warning."}});}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input').val(),'blip','input should contain record value');await testUtils.fields.editInput(form.$('input[name="foo"]'),"tralala");assert.strictEqual(form.$('input').val(),'tralala','input should contain new value');await form.reload({currentId:false});assert.strictEqual(form.$('input').val(),'','input should have no value after reload');form.destroy();});QUnit.test('render stat button with string inline',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form string="Manufacturing Orders">'+'<sheet>'+'<div class="oe_button_box" name="button_box">'+'<button string="Inventory Moves" class="oe_stat_button" icon="fa-arrows-v"/>'+'</div>'+'</sheet>'+'</form>',});var $button=form.$('.o_form_view .o_form_sheet .oe_button_box .oe_stat_button span');assert.strictEqual($button.text(),"Inventory Moves","the stat button should contain a span with the string attribute value");form.destroy();});QUnit.test('renderer waits for asynchronous fields rendering',async function(assert){assert.expect(1);var done=assert.async();testUtils.createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="bar"/>'+'<field name="foo" widget="ace"/>'+'<field name="int_field"/>'+'</form>',res_id:1,}).then(function(form){assert.containsOnce(form,'.ace_editor',"should have waited for ace to load its dependencies");form.destroy();done();});});QUnit.test('open one2many form containing one2many',async function(assert){assert.expect(9);this.data.partner.records[0].product_ids=[37];this.data.product.fields.partner_type_ids={string:"one2many partner",type:"one2many",relation:"partner_type",};this.data.product.records[0].partner_type_ids=[12];var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_ids">'+'<tree create="0">'+'<field name="display_name"/>'+'<field name="partner_type_ids"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',archs:{'product,false,form':'<form string="Products">'+'<sheet>'+'<group>'+'<field name="partner_type_ids">'+'<tree create="0">'+'<field name="display_name"/>'+'<field name="color"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',},mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});var row=form.$('.o_field_one2many .o_list_view .o_data_row');assert.strictEqual(row.children()[1].textContent,'1 record',"the cell should contains the number of record: 1");await testUtils.dom.click(row);var modal_row=$('.modal-body .o_form_sheet .o_field_one2many .o_list_view .o_data_row');assert.strictEqual(modal_row.children().length,2,"the row should contains the 2 fields defined in the form view");assert.strictEqual($(modal_row).text(),"gold2","the value of the fields should be fetched and displayed");assert.verifySteps(['read','read','load_views','read','read'],"there should be 4 read rpcs");form.destroy();});QUnit.test('in edit mode, first field is focused',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="bar"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(document.activeElement,form.$('input[name="foo"]')[0],"foo field should have focus");assert.strictEqual(form.$('input[name="foo"]')[0].selectionStart,3,"cursor should be at the end");form.destroy();});QUnit.test('autofocus fields are focused',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="bar"/>'+'<field name="foo" default_focus="1"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.strictEqual(document.activeElement,form.$('input[name="foo"]')[0],"foo field should have focus");form.destroy();});QUnit.test('correct amount of buttons',async function(assert){assert.expect(7);var self=this;var buttons=Array(8).join('<button type="object" class="oe_stat_button" icon="fa-check-square">'+'<field name="bar"/>'+'</button>');var statButtonSelector='.oe_stat_button:not(.dropdown-item, .dropdown-toggle)';var createFormWithDeviceSizeClass=async function(size_class){return await createView({View:FormView,model:'partner',data:self.data,arch:'<form>'+'<div name="button_box" class="oe_button_box">'
+buttons+'</div>'+'</form>',res_id:2,config:{device:{size_class:size_class},},});};var assertFormContainsNButtonsWithSizeClass=async function(size_class,n){var form=await createFormWithDeviceSizeClass(size_class);assert.containsN(form,statButtonSelector,n,'The form has the expected amount of buttons');form.destroy();};await assertFormContainsNButtonsWithSizeClass(0,2);await assertFormContainsNButtonsWithSizeClass(1,2);await assertFormContainsNButtonsWithSizeClass(2,2);await assertFormContainsNButtonsWithSizeClass(3,4);await assertFormContainsNButtonsWithSizeClass(4,7);await assertFormContainsNButtonsWithSizeClass(5,7);await assertFormContainsNButtonsWithSizeClass(6,7);});QUnit.test('can set bin_size to false in context',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',res_id:1,context:{bin_size:false,},mockRPC:function(route,args){assert.strictEqual(args.kwargs.context.bin_size,false,"bin_size should always be in the context and should be false");return this._super(route,args);}});form.destroy();});QUnit.test('no focus set on form when closing many2one modal if lastActivatedFieldIndex is not set',async function(assert){assert.expect(8);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'<field name="foo"/>'+'<field name="bar"/>'+'<field name="p"/>'+'<field name="timmy"/>'+'<field name="product_ids"/>'+'<field name="trululu"/>'+'</form>',res_id:2,archs:{'partner,false,list':'<tree><field name="display_name"/></tree>','partner_type,false,list':'<tree><field name="name"/></tree>','partner,false,form':'<form><field name="trululu"/></form>','product,false,list':'<tree><field name="name"/></tree>',},mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super(route,args);},});$('.o_content').css({'overflow':'auto','max-height':'300px'});await testUtils.form.clickEdit(form);assert.strictEqual($(".o_content").scrollTop(),0,"scroll position should be 0");form.$(".o_field_many2one[name='trululu'] .o_input").focus();assert.notStrictEqual($(".o_content").scrollTop(),0,"scroll position should not be 0");await testUtils.dom.click(form.$('.o_external_button'));await testUtils.dom.click($('.modal').last().find('button[class="close"]'));assert.notStrictEqual($(".o_content").scrollTop(),0,"scroll position should not be 0 after closing modal");assert.containsNone(document.body,'.modal','There should be no modal');assert.doesNotHaveClass($('body'),'modal-open','Modal is not said opened');assert.strictEqual(form.renderer.lastActivatedFieldIndex,-1,"lastActivatedFieldIndex is -1");assert.equal(document.activeElement,$('body')[0],'body is focused, should not set focus on form widget');assert.notStrictEqual(document.activeElement,form.$('.o_field_many2one[name="trululu"] .o_input'),'field widget should not be focused when lastActivatedFieldIndex is -1');form.destroy();});QUnit.test('in create mode, autofocus fields are focused',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="foo" default_focus="1"/>'+'</form>',});assert.strictEqual(document.activeElement,form.$('input[name="foo"]')[0],"foo field should have focus");form.destroy();});QUnit.test('create with false values',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group><field name="bar"/></group>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){assert.strictEqual(args.args[0].bar,false,"the false value should be given as parameter");}
return this._super(route,args);},});await testUtils.form.clickSave(form);form.destroy();});QUnit.test('autofocus first visible field',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field" invisible="1"/>'+'<field name="foo"/>'+'</form>',});assert.strictEqual(document.activeElement,form.$('input[name="foo"]')[0],"foo field should have focus");form.destroy();});QUnit.test('no autofocus with disable_autofocus option [REQUIRE FOCUS]',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="int_field"/>'+'<field name="foo"/>'+'</form>',viewOptions:{disable_autofocus:true,},});assert.notStrictEqual(document.activeElement,form.$('input[name="int_field"]')[0],"int_field field should not have focus");await form.update({});assert.notStrictEqual(document.activeElement,form.$('input[name="int_field"]')[0],"int_field field should not have focus");form.destroy();});QUnit.test('open one2many form containing many2many_tags',async function(assert){assert.expect(4);this.data.partner.records[0].product_ids=[37];this.data.product.fields.partner_type_ids={string:"many2many partner_type",type:"many2many",relation:"partner_type",};this.data.product.records[0].partner_type_ids=[12,14];var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_ids">'+'<tree create="0">'+'<field name="display_name"/>'+'<field name="partner_type_ids" widget="many2many_tags"/>'+'</tree>'+'<form string="Products">'+'<sheet>'+'<group>'+'<label for="partner_type_ids"/>'+'<div>'+'<field name="partner_type_ids" widget="many2many_tags"/>'+'</div>'+'</group>'+'</sheet>'+'</form>'+'</field>'+'</group>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});var row=form.$('.o_field_one2many .o_list_view .o_data_row');await testUtils.dom.click(row);assert.verifySteps(['read','read','read'],"there should be 3 read rpcs");form.destroy();});QUnit.test('onchanges are applied before checking if it can be saved',async function(assert){assert.expect(4);this.data.partner.onchanges.foo=function(obj){};this.data.partner.fields.foo.required=true;var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet><group>'+'<field name="foo"/>'+'</group></sheet>'+'</form>',res_id:2,mockRPC:function(route,args){var result=this._super.apply(this,arguments);assert.step(args.method);if(args.method==='onchange'){return def.then(function(){return result;});}
return result;},services:{notification:NotificationService.extend({notify:function(params){assert.step(params.type);}}),},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name="foo"]'),'');await testUtils.form.clickSave(form);def.resolve();await testUtils.nextTick();assert.verifySteps(['read','onchange','danger']);form.destroy();});QUnit.test('display toolbar',async function(assert){assert.expect(8);var form=await createView({View:FormView,model:'partner',data:this.data,res_id:1,arch:'<form string="Partners">'+'<group><field name="bar"/></group>'+'</form>',toolbar:{action:[{model_name:'partner',name:'Action partner',type:'ir.actions.server',usage:'ir_actions_server',}],print:[],},viewOptions:{hasActionMenus:true,},mockRPC:function(route,args){if(route==='/web/action/load'){assert.strictEqual(args.context.active_id,1,"the active_id shoud be 1.");assert.deepEqual(args.context.active_ids,[1],"the active_ids should be an array with 1 inside.");return Promise.resolve({});}
return this._super.apply(this,arguments);},});assert.containsNone(form,'.o_cp_action_menus .o_dropdown:contains(Print)');assert.containsOnce(form,'.o_cp_action_menus .o_dropdown:contains(Action)');await cpHelpers.toggleActionMenu(form);assert.containsN(form,'.o_cp_action_menus .dropdown-item',3,"there should be 3 actions");assert.strictEqual(form.$('.o_cp_action_menus .dropdown-item:last').text().trim(),'Action partner',"the custom action should have 'Action partner' as name");await testUtils.mock.intercept(form,'do_action',function(event){var context=event.data.action.context.__contexts[1];assert.strictEqual(context.active_id,1,"the active_id shoud be 1.");assert.deepEqual(context.active_ids,[1],"the active_ids should be an array with 1 inside.");});await cpHelpers.toggleMenuItem(form,"Action partner");form.destroy();});QUnit.test('check interactions between multiple FormViewDialogs',async function(assert){assert.expect(8);this.data.product.fields.product_ids={string:"one2many product",type:"one2many",relation:"product",};this.data.partner.records[0].product_id=37;var form=await createView({View:FormView,model:'partner',res_id:1,data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'</sheet>'+'</form>',archs:{'product,false,form':'<form string="Products">'+'<sheet>'+'<group>'+'<field name="display_name"/>'+'<field name="product_ids"/>'+'</group>'+'</sheet>'+'</form>','product,false,list':'<tree><field name="display_name"/></tree>'},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/product/get_formview_id'){return Promise.resolve(false);}else if(args.method==='write'){assert.strictEqual(args.model,'product',"should write on product model");assert.strictEqual(args.args[1].product_ids[0][2].display_name,'xtv',"display_name of the new object should be xtv");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_external_button'));assert.strictEqual($('.modal').length,1,"One FormViewDialog should be opened");var $firstModal=$('.modal');assert.strictEqual($('.modal .modal-title').first().text().trim(),'Open: Product',"dialog title should display the python field string as label");assert.strictEqual($firstModal.find('input').val(),'xphone',"display_name should be correctly displayed");await testUtils.dom.click($firstModal.find('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal').length,2,"two FormViewDialogs should be opened");var $secondModal=$('.modal:nth(1)');await testUtils.fields.editInput($secondModal.find('input'),'xtv');await testUtils.dom.click($secondModal.find('.modal-footer button:first'));assert.strictEqual($('.modal').length,1,"last opened dialog should be closed");assert.strictEqual($firstModal.find('tr.o_data_row td').text(),'xtv',"should have added a line with xtv as new record");await testUtils.dom.click($firstModal.find('.modal-footer button:first'));form.destroy();});QUnit.test('fields and record contexts are not mixed',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<group>'+'<field name="trululu" context="{\'test\': 1}"/>'+'</group>'+'</form>',mockRPC:function(route,args){if(args.method==='name_search'){assert.strictEqual(args.kwargs.context.test,1,"field's context should be sent");assert.notOk('mainContext'in args.kwargs.context,"record's context should not be sent");}
return this._super.apply(this,arguments);},res_id:2,viewOptions:{mode:'edit',context:{mainContext:3},},});await testUtils.dom.click(form.$('.o_field_widget[name=trululu] input'));form.destroy();});QUnit.test('do not activate an hidden tab when switching between records',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="Foo" attrs=\'{"invisible": [["id", "=", 2]]}\'>'+'<field name="foo"/>'+'</page>'+'<page string="Bar">'+'<field name="bar"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',viewOptions:{ids:[1,2],index:0,},res_id:1,});assert.strictEqual(form.$('.o_notebook .nav-item:not(.o_invisible_modifier)').length,2,"both tabs should be visible");assert.hasClass(form.$('.o_notebook .nav-link:first'),'active',"first tab should be active");await cpHelpers.pagerNext(form);assert.strictEqual(form.$('.o_notebook .nav-item:not(.o_invisible_modifier)').length,1,"only the second tab should be visible");assert.hasClass(form.$('.o_notebook .nav-item:not(.o_invisible_modifier) .nav-link'),'active',"the visible tab should be active");await cpHelpers.pagerPrevious(form);assert.strictEqual(form.$('.o_notebook .nav-item:not(.o_invisible_modifier)').length,2,"both tabs should be visible again");assert.hasClass(form.$('.o_notebook .nav-link:nth(1)'),'active',"second tab should be active");form.destroy();});QUnit.test('support anchor tags with action type',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<a type="action" name="42"><i class="fa fa-arrow-right"/> Click me !</a>'+'</form>',res_id:1,intercepts:{do_action:function(event){assert.strictEqual(event.data.action,"42","should trigger do_action with correct action parameter");}}});await testUtils.dom.click(form.$('a[type="action"]'));form.destroy();});QUnit.test('do not perform extra RPC to read invisible many2one fields',async function(assert){assert.expect(2);this.data.partner.fields.trululu.default=2;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="trululu" invisible="1"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});assert.verifySteps(['onchange'],"only one RPC should have been done");form.destroy();});QUnit.test('do not perform extra RPC to read invisible x2many fields',async function(assert){assert.expect(2);this.data.partner.records[0].p=[2];this.data.partner.records[0].product_ids=[37];this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p" invisible="1"/>'+'<field name="product_ids" invisible="1">'+'<tree><field name="display_name"/></tree>'+'</field>'+'<field name="timmy" invisible="1" widget="many2many_tags"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},res_id:1,});assert.verifySteps(['read'],"only one read should have been done");form.destroy();});QUnit.test('default_order on x2many embedded view',async function(assert){assert.expect(11);this.data.partner.fields.display_name.sortable=true;this.data.partner.records[0].p=[1,4];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="p">'+'<tree default_order="foo desc">'+'<field name="display_name"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',archs:{'partner,false,form':'<form string="Partner">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',},res_id:1,});assert.ok(form.$('.o_field_one2many tbody tr:first td:contains(yop)').length,"record 1 should be first");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual($('.modal').length,1,"FormViewDialog should be opened");await testUtils.fields.editInput($('.modal input[name="foo"]'),'xop');await testUtils.dom.click($('.modal-footer button:eq(1)'));await testUtils.fields.editInput($('.modal input[name="foo"]'),'zop');await testUtils.dom.click($('.modal-footer button:first'));assert.ok(form.$('.o_field_one2many tbody tr:eq(0) td:contains(zop)').length,"record zop should be first");assert.ok(form.$('.o_field_one2many tbody tr:eq(1) td:contains(yop)').length,"record yop should be second");assert.ok(form.$('.o_field_one2many tbody tr:eq(2) td:contains(xop)').length,"record xop should be third");await testUtils.form.clickSave(form);assert.ok(form.$('.o_field_one2many tbody tr:eq(0) td:contains(zop)').length,"record zop should be first");assert.ok(form.$('.o_field_one2many tbody tr:eq(1) td:contains(yop)').length,"record yop should be second");assert.ok(form.$('.o_field_one2many tbody tr:eq(2) td:contains(xop)').length,"record xop should be third");await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_one2many tbody tr:eq(1) td:contains(yop)'));await testUtils.fields.editInput($('.modal input[name="foo"]'),'zzz');await testUtils.dom.click($('.modal-footer button:first'));assert.ok(form.$('.o_field_one2many tbody tr:eq(0) td:contains(zzz)').length,"record zzz should be first");assert.ok(form.$('.o_field_one2many tbody tr:eq(1) td:contains(zop)').length,"record zop should be second");assert.ok(form.$('.o_field_one2many tbody tr:eq(2) td:contains(xop)').length,"record xop should be third");form.destroy();});QUnit.test('action context is used when evaluating domains',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="trululu" domain="[(\'id\', \'in\', context.get(\'product_ids\', []))]"/>'+'</sheet>'+'</form>',res_id:1,viewOptions:{context:{product_ids:[45,46,47]}},mockRPC:function(route,args){if(args.method==='name_search'){assert.deepEqual(args.kwargs.args[0],['id','in',[45,46,47]],"domain should be properly evaluated");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('div[name="trululu"] input'));form.destroy();});QUnit.test('form rendering with groups with col/colspan',async function(assert){assert.expect(45);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group col="6" class="parent_group">'+'<group col="4" colspan="3" class="group_4">'+'<div colspan="3"/>'+'<div colspan="2"/><div/>'+'<div colspan="4"/>'+'</group>'+'<group col="3" colspan="4" class="group_3">'+'<group col="1" class="group_1">'+'<div/><div/><div/>'+'</group>'+'<div/>'+'<group col="3" class="field_group">'+'<field name="foo" colspan="3"/>'+'<div/><field name="bar" nolabel="1"/>'+'<field name="qux"/>'+'<field name="int_field" colspan="3" nolabel="1"/>'+'<span/><field name="product_id"/>'+'</group>'+'</group>'+'</group>'+'<group>'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>'+'</field>'+'</group>'+'</sheet>'+'</form>',res_id:1,});var $parentGroup=form.$('.parent_group');var $group4=form.$('.group_4');var $group3=form.$('.group_3');var $group1=form.$('.group_1');var $fieldGroup=form.$('.field_group');assert.strictEqual($parentGroup[0].tagName,'DIV',".parent_group should be an outergroup");assert.strictEqual($group4[0].tagName,'TABLE',".group_4 should be an innergroup");assert.strictEqual($group3[0].tagName,'DIV',".group_3 should be an outergroup");assert.strictEqual($group1[0].tagName,'TABLE',".group_1 should be an innergroup");assert.strictEqual($fieldGroup[0].tagName,'TABLE',".field_group should be an innergroup");var $parentGroupChildren=$parentGroup.children();assert.strictEqual($parentGroupChildren.length,2,"there should be 2 groups in .parent_group");assert.ok($parentGroupChildren.eq(0).is('.o_group_col_6'),"first .parent_group group should be 1/2 parent width");assert.ok($parentGroupChildren.eq(1).is('.o_group_col_8'),"second .parent_group group should be 2/3 parent width");var $group4rows=$group4.find('> tbody > tr');assert.strictEqual($group4rows.length,3,"there should be 3 rows in .group_4");var $group4firstRowTd=$group4rows.eq(0).children('td');assert.strictEqual($group4firstRowTd.length,1,"there should be 1 td in first row");assert.hasAttrValue($group4firstRowTd,'colspan',"3","the first td colspan should be 3");assert.strictEqual($group4firstRowTd.attr('style').substr(0,9),"width: 75","the first td should be 75% width");assert.strictEqual($group4firstRowTd.children()[0].tagName,"DIV","the first td should contain a div");var $group4secondRowTds=$group4rows.eq(1).children('td');assert.strictEqual($group4secondRowTds.length,2,"there should be 2 tds in second row");assert.hasAttrValue($group4secondRowTds.eq(0),'colspan',"2","the first td colspan should be 2");assert.strictEqual($group4secondRowTds.eq(0).attr('style').substr(0,9),"width: 50","the first td be 50% width");assert.hasAttrValue($group4secondRowTds.eq(1),'colspan',undefined,"the second td colspan should be default one (1)");assert.strictEqual($group4secondRowTds.eq(1).attr('style').substr(0,9),"width: 25","the second td be 75% width");var $group4thirdRowTd=$group4rows.eq(2).children('td');assert.strictEqual($group4thirdRowTd.length,1,"there should be 1 td in third row");assert.hasAttrValue($group4thirdRowTd,'colspan',"4","the first td colspan should be 4");assert.strictEqual($group4thirdRowTd.attr('style').substr(0,10),"width: 100","the first td should be 100% width");assert.strictEqual($group3.children().length,3,".group_3 should have 3 children");assert.strictEqual($group3.children('.o_group_col_4').length,3,".group_3 should have 3 children of 1/3 width");assert.strictEqual($group1.find('> tbody > tr').length,3,"there should be 3 rows in .group_1");var $fieldGroupRows=$fieldGroup.find('> tbody > tr');assert.strictEqual($fieldGroupRows.length,5,"there should be 5 rows in .field_group");var $fieldGroupFirstRowTds=$fieldGroupRows.eq(0).children('td');assert.strictEqual($fieldGroupFirstRowTds.length,2,"there should be 2 tds in first row");assert.hasClass($fieldGroupFirstRowTds.eq(0),'o_td_label',"first td should be a label td");assert.hasAttrValue($fieldGroupFirstRowTds.eq(1),'colspan',"2","second td colspan should be given colspan (3) - 1 (label)");assert.strictEqual($fieldGroupFirstRowTds.eq(1).attr('style').substr(0,10),"width: 100","second td width should be 100%");var $fieldGroupSecondRowTds=$fieldGroupRows.eq(1).children('td');assert.strictEqual($fieldGroupSecondRowTds.length,2,"there should be 2 tds in second row");assert.hasAttrValue($fieldGroupSecondRowTds.eq(0),'colspan',undefined,"first td colspan should be default one (1)");assert.strictEqual($fieldGroupSecondRowTds.eq(0).attr('style').substr(0,9),"width: 33","first td width should be 33.3333%");assert.hasAttrValue($fieldGroupSecondRowTds.eq(1),'colspan',undefined,"second td colspan should be default one (1)");assert.strictEqual($fieldGroupSecondRowTds.eq(1).attr('style').substr(0,9),"width: 33","second td width should be 33.3333%");var $fieldGroupThirdRowTds=$fieldGroupRows.eq(2).children('td');assert.strictEqual($fieldGroupThirdRowTds.length,2,"there should be 2 tds in third row");assert.hasClass($fieldGroupThirdRowTds.eq(0),'o_td_label',"first td should be a label td");assert.hasAttrValue($fieldGroupThirdRowTds.eq(1),'colspan',undefined,"second td colspan should be default one (1)");assert.strictEqual($fieldGroupThirdRowTds.eq(1).attr('style').substr(0,9),"width: 50","second td should be 50% width");var $fieldGroupFourthRowTds=$fieldGroupRows.eq(3).children('td');assert.strictEqual($fieldGroupFourthRowTds.length,1,"there should be 1 td in fourth row");assert.hasAttrValue($fieldGroupFourthRowTds,'colspan',"3","the td should have a colspan equal to 3");assert.strictEqual($fieldGroupFourthRowTds.attr('style').substr(0,10),"width: 100","the td should have 100% width");var $fieldGroupFifthRowTds=$fieldGroupRows.eq(4).children('td');assert.strictEqual($fieldGroupFifthRowTds.length,3,"there should be 3 tds in fourth row");assert.strictEqual($fieldGroupFifthRowTds.eq(0).attr('style').substr(0,9),"width: 50","the first td should 50% width");assert.hasClass($fieldGroupFifthRowTds.eq(1),'o_td_label',"the second td should be a label td");assert.strictEqual($fieldGroupFifthRowTds.eq(2).attr('style').substr(0,9),"width: 50","the third td should 50% width");form.destroy();});QUnit.test('outer and inner groups string attribute',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group string="parent group" class="parent_group">'+'<group string="child group 1" class="group_1">'+'<field name="bar"/>'+'</group>'+'<group string="child group 2" class="group_2">'+'<field name="bar"/>'+'</group>'+'</group>'+'</sheet>'+'</form>',res_id:1,});var $parentGroup=form.$('.parent_group');var $group1=form.$('.group_1');var $group2=form.$('.group_2');assert.containsN(form,'table.o_inner_group',2,"should contain two inner groups");assert.strictEqual($group1.find('.o_horizontal_separator').length,1,"inner group should contain one string separator");assert.strictEqual($group1.find('.o_horizontal_separator:contains(child group 1)').length,1,"first inner group should contain 'child group 1' string");assert.strictEqual($group2.find('.o_horizontal_separator:contains(child group 2)').length,1,"second inner group should contain 'child group 2' string");assert.strictEqual($parentGroup.find('> div.o_horizontal_separator:contains(parent group)').length,1,"outer group should contain 'parent group' string");form.destroy();});QUnit.test('form group with newline tag inside',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<group col="5" class="main_inner_group">'+'<field name="foo"/>'+'<newline/>'+'<field name="bar"/>'+'<field name="qux"/>'+'</group>'+'<group col="3">'+'<group class="top_group">'+'<div style="height: 200px;"/>'+'</group>'+'<newline/>'+'<group class="bottom_group">'+'<div/>'+'</group>'+'</group>'+'</sheet>'+'</form>',res_id:1,});assert.containsN(form,'.main_inner_group > tbody > tr',2,"there should be 2 rows in the group");assert.containsOnce(form,'.main_inner_group > tbody > tr:first > .o_td_label',"there should be only one label in the first row");assert.containsOnce(form,'.main_inner_group > tbody > tr:first .o_field_widget',"there should be only one widget in the first row");assert.containsN(form,'.main_inner_group > tbody > tr:last > .o_td_label',2,"there should be two labels in the second row");assert.containsN(form,'.main_inner_group > tbody > tr:last .o_field_widget',2,"there should be two widgets in the second row");assert.ok((form.$('.bottom_group').position().top-form.$('.top_group').position().top)>=200,"outergroup children should not be on the same line");form.destroy();});QUnit.test('custom open record dialog title',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p" widget="many2many" string="custom label">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form>'+'<field name="display_name"/>'+'</form>'+'</field>'+'</form>',session:{},res_id:1,});await testUtils.dom.click(form.$('.o_data_row:first'));assert.strictEqual($('.modal .modal-title').first().text().trim(),'Open: custom label',"modal should use the python field string as title");form.destroy();});QUnit.test('display translation alert',async function(assert){assert.expect(2);this.data.partner.fields.foo.translate=true;this.data.partner.fields.display_name.translate=true;var multi_lang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'<field name="display_name"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name="foo"]'),"test");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_form_view .alert > div .oe_field_translate',"should have single translation alert");await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name="display_name"]'),"test2");await testUtils.form.clickSave(form);assert.containsN(form,'.o_form_view .alert > div .oe_field_translate',2,"should have two translate fields in translation alert");form.destroy();_t.database.multi_lang=multi_lang;});QUnit.test('translation alerts are preserved on pager change',async function(assert){assert.expect(5);this.data.partner.fields.foo.translate=true;var multi_lang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="foo"/>'+'</sheet>'+'</form>',viewOptions:{ids:[1,2],index:0,},res_id:1,});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name="foo"]'),"test");await testUtils.form.clickSave(form);assert.containsOnce(form,'.o_form_view .alert > div',"should have a translation alert");await cpHelpers.pagerNext(form);assert.containsNone(form,'.o_form_view .alert > div',"should not have a translation alert");await cpHelpers.pagerPrevious(form);assert.containsOnce(form,'.o_form_view .alert > div',"should have a translation alert");await testUtils.dom.click(form.$('.o_form_view .alert > .close'));assert.containsNone(form,'.o_form_view .alert > div',"should not have a translation alert");await form.reload();assert.containsNone(form,'.o_form_view .alert > div',"should not have a translation alert after reload");form.destroy();_t.database.multi_lang=multi_lang;});QUnit.test('translation alerts preseved on reverse breadcrumb',async function(assert){assert.expect(2);this.data['ir.translation']={fields:{name:{string:"name",type:"char"},source:{string:"Source",type:"char"},value:{string:"Value",type:"char"},},records:[],};this.data.partner.fields.foo.translate=true;var multi_lang=_t.database.multi_lang;_t.database.multi_lang=true;var archs={'partner,false,form':'<form string="Partners">'+'<sheet>'+'<field name="foo"/>'+'</sheet>'+'</form>','partner,false,search':'<search></search>','ir.translation,false,list':'<tree>'+'<field name="name"/>'+'<field name="source"/>'+'<field name="value"/>'+'</tree>','ir.translation,false,search':'<search></search>',};var actions=[{id:1,name:'Partner',res_model:'partner',type:'ir.actions.act_window',views:[[false,'form']],},{id:2,name:'Translate',res_model:'ir.translation',type:'ir.actions.act_window',views:[[false,'list']],target:'current',flags:{'search_view':true,'action_buttons':true},}];var actionManager=await createActionManager({actions:actions,archs:archs,data:this.data,});await actionManager.doAction(1);actionManager.$('input[name="foo"]').val("test").trigger("input");await testUtils.dom.click(actionManager.$('.o_form_button_save'));assert.strictEqual(actionManager.$('.o_form_view .alert > div').length,1,"should have a translation alert");var currentController=actionManager.getCurrentController().widget;await actionManager.doAction(2,{on_reverse_breadcrumb:function(){if(!_.isEmpty(currentController.renderer.alertFields)){currentController.renderer.displayTranslationAlert();}
return false;},});await testUtils.dom.click($('.o_control_panel .breadcrumb a:first'));assert.strictEqual(actionManager.$('.o_form_view .alert > div').length,1,"should have a translation alert");actionManager.destroy();_t.database.multi_lang=multi_lang;});QUnit.test('translate event correctly handled with multiple controllers',async function(assert){assert.expect(3);this.data.product.fields.name.translate=true;this.data.partner.records[0].product_id=37;var nbTranslateCalls=0;var multi_lang=_t.database.multi_lang;_t.database.multi_lang=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_id"/>'+'</group>'+'</sheet>'+'</form>',archs:{'product,false,form':'<form>'+'<sheet>'+'<group>'+'<field name="name"/>'+'<field name="partner_type_id"/>'+'</group>'+'</sheet>'+'</form>',},res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/product/get_formview_id'){return Promise.resolve(false);}
if(route==="/web/dataset/call_button"&&args.method==='translate_fields'){assert.deepEqual(args.args,["product",37,"name"],'should call "call_button" route');nbTranslateCalls++;return Promise.resolve({domain:[],context:{search_default_name:'partnes,foo'},});}
if(route==="/web/dataset/call_kw/res.lang/get_installed"){return Promise.resolve([["en_US"],["fr_BE"]]);}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('[name="product_id"] .o_external_button'));assert.containsOnce($('.modal-body'),'span.o_field_translate',"there should be a translate button in the modal");await testUtils.dom.click($('.modal-body span.o_field_translate'));assert.strictEqual(nbTranslateCalls,1,"should call_button translate once");form.destroy();_t.database.multi_lang=multi_lang;});QUnit.test('buttons are disabled until status bar action is resolved',async function(assert){assert.expect(9);var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="post" class="p" string="Confirm" type="object"/>'+'<button name="some_method" class="s" string="Do it" type="object"/>'+'</header>'+'<sheet>'+'<div name="button_box" class="oe_button_box">'+'<button class="oe_stat_button">'+'<field name="bar"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,intercepts:{execute_action:function(event){return def.then(function(){event.data.on_success();});}},});assert.strictEqual(form.$buttons.find('button:not(:disabled)').length,4,"control panel buttons should be enabled");assert.strictEqual(form.$('.o_form_statusbar button:not(:disabled)').length,2,"status bar buttons should be enabled");assert.strictEqual(form.$('.oe_button_box button:not(:disabled)').length,1,"stat buttons should be enabled");await testUtils.dom.clickFirst(form.$('.o_form_statusbar button'));assert.strictEqual(form.$buttons.find('button:disabled').length,4,"control panel buttons should be disabled");assert.containsN(form,'.o_form_statusbar button:disabled',2,"status bar buttons should be disabled");assert.containsOnce(form,'.oe_button_box button:disabled',"stat buttons should be disabled");def.resolve();await testUtils.nextTick();assert.strictEqual(form.$buttons.find('button:not(:disabled)').length,4,"control panel buttons should be enabled");assert.strictEqual(form.$('.o_form_statusbar button:not(:disabled)').length,2,"status bar buttons should be enabled");assert.strictEqual(form.$('.oe_button_box button:not(:disabled)').length,1,"stat buttons should be enabled");form.destroy();});QUnit.test('buttons are disabled until button box action is resolved',async function(assert){assert.expect(9);var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="post" class="p" string="Confirm" type="object"/>'+'<button name="some_method" class="s" string="Do it" type="object"/>'+'</header>'+'<sheet>'+'<div name="button_box" class="oe_button_box">'+'<button class="oe_stat_button">'+'<field name="bar"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,intercepts:{execute_action:function(event){return def.then(function(){event.data.on_success();});}},});assert.strictEqual(form.$buttons.find('button:not(:disabled)').length,4,"control panel buttons should be enabled");assert.strictEqual(form.$('.o_form_statusbar button:not(:disabled)').length,2,"status bar buttons should be enabled");assert.strictEqual(form.$('.oe_button_box button:not(:disabled)').length,1,"stat buttons should be enabled");await testUtils.dom.click(form.$('.oe_button_box button'));assert.strictEqual(form.$buttons.find('button:disabled').length,4,"control panel buttons should be disabled");assert.containsN(form,'.o_form_statusbar button:disabled',2,"status bar buttons should be disabled");assert.containsOnce(form,'.oe_button_box button:disabled',"stat buttons should be disabled");def.resolve();await testUtils.nextTick();assert.strictEqual(form.$buttons.find('button:not(:disabled)').length,4,"control panel buttons should be enabled");assert.strictEqual(form.$('.o_form_statusbar button:not(:disabled)').length,2,"status bar buttons should be enabled");assert.strictEqual(form.$('.oe_button_box button:not(:disabled)').length,1,"stat buttons should be enabled");form.destroy();});QUnit.test('buttons with "confirm" attribute save before calling the method',async function(assert){assert.expect(9);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="post" class="p" string="Confirm" type="object" '+'confirm="Very dangerous. U sure?"/>'+'</header>'+'<sheet>'+'<field name="foo"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},intercepts:{execute_action:function(event){assert.step('execute_action');event.data.on_success();},},});await testUtils.dom.click(form.$('.o_statusbar_buttons button'));assert.ok(form.$('.o_statusbar_buttons button').prop('disabled'),'button should be disabled');await testUtils.dom.click($('.modal-footer button.btn-secondary'));assert.ok(!form.$('.o_statusbar_buttons button').prop('disabled'),'button should no longer be disabled');assert.verifySteps(['onchange']);await testUtils.dom.click(form.$('.o_statusbar_buttons button'));assert.verifySteps([]);await testUtils.dom.click($('.modal-footer button.btn-primary'));assert.verifySteps(['create','read','execute_action']);form.destroy();});QUnit.test('buttons are disabled until action is resolved (in dialogs)',async function(assert){assert.expect(3);var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="trululu"/>'+'</sheet>'+'</form>',archs:{'partner,false,form':'<form>'+'<sheet>'+'<div name="button_box" class="oe_button_box">'+'<button class="oe_stat_button">'+'<field name="bar"/>'+'</button>'+'</div>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',},res_id:1,intercepts:{execute_action:function(event){return def.then(function(){event.data.on_success();});}},mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_external_button'));assert.notOk($('.modal .oe_button_box button').attr('disabled'),"stat buttons should be enabled");await testUtils.dom.click($('.modal .oe_button_box button'));assert.ok($('.modal .oe_button_box button').attr('disabled'),"stat buttons should be disabled");def.resolve();await testUtils.nextTick();assert.notOk($('.modal .oe_button_box button').attr('disabled'),"stat buttons should be enabled");form.destroy();});QUnit.test('multiple clicks on save should reload only once',async function(assert){assert.expect(4);var def=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){var result=this._super.apply(this,arguments);assert.step(args.method);if(args.method==="write"){return def.then(function(){return result;});}else{return result;}},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name="foo"]'),"test");await testUtils.form.clickSave(form);await testUtils.form.clickSave(form);def.resolve();await testUtils.nextTick();assert.verifySteps(['read','write','read']);form.destroy();});QUnit.test('form view is not broken if save operation fails',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',res_id:1,mockRPC:function(route,args){assert.step(args.method);if(args.method==='write'&&args.args[1].foo==='incorrect value'){return Promise.reject();}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.fields.editInput(form.$('input[name="foo"]'),"incorrect value");await testUtils.form.clickSave(form);await testUtils.fields.editInput(form.$('input[name="foo"]'),"correct value");await testUtils.form.clickSave(form);assert.verifySteps(['read','write','write','read']);form.destroy();});QUnit.test('form view is not broken if save failed in readonly mode on field changed',async function(assert){assert.expect(10);var failFlag=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<header><field name="trululu" widget="statusbar" clickable="true"/></header>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==='write'){assert.step('write');if(failFlag){return Promise.reject();}}else if(args.method==='read'){assert.step('read');}
return this._super.apply(this,arguments);},});var $selectedState=form.$('.o_statusbar_status button[data-value="4"]');assert.ok($selectedState.hasClass('btn-primary')&&$selectedState.hasClass('disabled'),"selected status should be btn-primary and disabled");failFlag=true;var $clickableState=form.$('.o_statusbar_status button[data-value="1"]');await testUtils.dom.click($clickableState);var $lastActiveState=form.$('.o_statusbar_status button[data-value="4"]');$selectedState=form.$('.o_statusbar_status button.btn-primary');assert.strictEqual($selectedState[0],$lastActiveState[0],"selected status is AAA record after save fail");failFlag=false;$clickableState=form.$('.o_statusbar_status button[data-value="1"]');await testUtils.dom.click($clickableState);var $lastClickedState=form.$('.o_statusbar_status button[data-value="1"]');$selectedState=form.$('.o_statusbar_status button.btn-primary');assert.strictEqual($selectedState[0],$lastClickedState[0],"last clicked status should be active");assert.verifySteps(['read','write','read','write','read','read',]);form.destroy();});QUnit.test('support password attribute',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" password="True"/>'+'</form>',res_id:1,});assert.strictEqual(form.$('span[name="foo"]').text(),'***',"password should be displayed with stars");await testUtils.form.clickEdit(form);assert.strictEqual(form.$('input[name="foo"]').val(),'yop',"input value should be the password");assert.strictEqual(form.$('input[name="foo"]').prop('type'),'password',"input should be of type password");form.destroy();});QUnit.test('support autocomplete attribute',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name" autocomplete="coucou"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.hasAttrValue(form.$('input[name="display_name"]'),'autocomplete','coucou',"attribute autocomplete should be set");form.destroy();});QUnit.test('input autocomplete attribute set to none by default',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.hasAttrValue(form.$('input[name="display_name"]'),'autocomplete','none',"attribute autocomplete should be set to none by default");form.destroy();});QUnit.test('context is correctly passed after save & new in FormViewDialog',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',res_id:4,data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="product_ids"/>'+'</group>'+'</sheet>'+'</form>',archs:{'product,false,form':'<form string="Products">'+'<sheet>'+'<group>'+'<field name="partner_type_id" '+'context="{\'color\': parent.id}"/>'+'</group>'+'</sheet>'+'</form>','product,false,list':'<tree><field name="display_name"/></tree>'},mockRPC:function(route,args){if(args.method==='name_search'){assert.strictEqual(args.kwargs.context.color,4,"should use the correct context");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.nextTick();assert.strictEqual($('.modal').length,1,"One FormViewDialog should be opened");await testUtils.fields.many2one.clickOpenDropdown('partner_type_id');await testUtils.fields.many2one.clickHighlightedItem('partner_type_id');await testUtils.dom.click($('.modal-footer button:eq(1)'));await testUtils.nextTick();await testUtils.dom.click($('.modal .o_field_many2one input'));await testUtils.fields.many2one.clickHighlightedItem('partner_type_id');await testUtils.dom.click($('.modal-footer button:first'));await testUtils.nextTick();form.destroy();});QUnit.test('render domain field widget without model',async function(assert){assert.expect(3);this.data.partner.fields.model_name={string:"Model name",type:"char"};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<group>'+'<field name="model_name"/>'+'<field name="display_name" widget="domain" options="{\'model\': \'model_name\'}"/>'+'</group>'+'</form>',mockRPC:function(route,args){if(args.method==='search_count'){assert.strictEqual(args.model,'test',"should search_count on test");if(!args.kwargs.domain){return Promise.reject({message:{code:200,data:{},message:"MockServer._getRecords: given domain has to be an array.",},event:$.Event()});}}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.o_field_widget[name="display_name"]').text(),"Select a model to add a filter.","should contain an error message saying the model is missing");await testUtils.fields.editInput(form.$('input[name="model_name"]'),"test");assert.notStrictEqual(form.$('.o_field_widget[name="display_name"]').text(),"Select a model to add a filter.","should not contain an error message anymore");form.destroy();});QUnit.test('readonly fields are not sent when saving',async function(assert){assert.expect(6);this.data.partner.onchanges={display_name:function(){},p:function(){},};var checkOnchange=false;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="display_name"/>'+'</tree>'+'<form string="Partners">'+'<field name="display_name"/>'+'<field name="foo" attrs="{\'readonly\': [[\'display_name\', \'=\', \'readonly\']]}"/>'+'</form>'+'</field>'+'</form>',mockRPC:function(route,args){if(checkOnchange&&args.method==='onchange'){if(args.args[2]==='display_name'){assert.strictEqual(args.args[1].foo,'foo value',"readonly fields value should be sent for onchanges");}else{assert.deepEqual(args.args[1].p,[[0,args.args[1].p[0][1],{display_name:'readonly',foo:'foo value'}]],"readonly fields value should be sent for onchanges");}}
if(args.method==='create'){assert.deepEqual(args.args[0],{p:[[0,args.args[0].p[0][1],{display_name:'readonly'}]]},"should not have sent the value of the readonly field");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.nextTick();assert.strictEqual($('.modal input.o_field_widget[name=foo]').length,1,'foo should be editable');checkOnchange=true;await testUtils.fields.editInput($('.modal .o_field_widget[name=foo]'),'foo value');await testUtils.fields.editInput($('.modal .o_field_widget[name=display_name]'),'readonly');assert.strictEqual($('.modal span.o_field_widget[name=foo]').length,1,'foo should be readonly');await testUtils.dom.clickFirst($('.modal-footer .btn-primary'));await testUtils.nextTick();checkOnchange=false;await testUtils.dom.click(form.$('.o_data_row'));assert.strictEqual($('.modal .o_field_widget[name=foo]').text(),'foo value',"the edited value should have been kept");await testUtils.dom.clickFirst($('.modal-footer .btn-primary'));await testUtils.nextTick();await testUtils.form.clickSave(form);form.destroy();});QUnit.test('id is False in evalContext for new records',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="id"/>'+'<field name="foo" attrs="{\'readonly\': [[\'id\', \'=\', False]]}"/>'+'</form>',});assert.hasClass(form.$('.o_field_widget[name=foo]'),'o_readonly_modifier',"foo should be readonly in 'Create' mode");await testUtils.form.clickSave(form);await testUtils.form.clickEdit(form);assert.doesNotHaveClass(form.$('.o_field_widget[name=foo]'),'o_readonly_modifier',"foo should not be readonly anymore");form.destroy();});QUnit.test('delete a duplicated record',async function(assert){assert.expect(5);var newRecordID;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="display_name"/>'+'</form>',res_id:1,viewOptions:{hasActionMenus:true},mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='copy'){return result.then(function(id){newRecordID=id;return id;});}
if(args.method==='unlink'){assert.deepEqual(args.args[0],[newRecordID],"should delete the newly created record");}
return result;},});await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Duplicate");assert.containsOnce(form,'.o_form_editable',"form should be in edit mode");assert.strictEqual(form.$('.o_field_widget').val(),'first record (copy)',"duplicated record should have correct name");await testUtils.form.clickSave(form);await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Delete");assert.strictEqual($('.modal').length,1,"should have opened a confirm dialog");await testUtils.dom.click($('.modal-footer .btn-primary'));assert.strictEqual(form.$('.o_field_widget').text(),'first record',"should have come back to previous record");form.destroy();});QUnit.test('display tooltips for buttons',async function(assert){assert.expect(2);var initialDebugMode=odoo.debug;odoo.debug=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="some_method" class="oe_highlight" string="Button" type="object"/>'+'</header>'+'<button name="other_method" class="oe_highlight" string="Button2" type="object"/>'+'</form>',});var $button=form.$('.o_form_statusbar button');$button.tooltip('show',false);$button.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_string').length,1,"should have rendered a tooltip");$button.trigger($.Event('mouseleave'));var $secondButton=form.$('button[name="other_method"]');$secondButton.tooltip('show',false);$secondButton.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_string').length,1,"should have rendered a tooltip");$secondButton.trigger($.Event('mouseleave'));odoo.debug=initialDebugMode;form.destroy();});QUnit.test('reload event is handled only once',async function(assert){assert.expect(11);var arch='<form>'+'<field name="display_name"/>'+'<field name="trululu"/>'+'</form>';var form=await createView({View:FormView,model:'partner',data:this.data,arch:arch,archs:{'partner,false,form':arch,},res_id:2,mockRPC:function(route,args){assert.step(args.method);if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_external_button'));await testUtils.dom.click($('.modal .o_external_button'));await testUtils.fields.editInput($('.modal:nth(1) .o_field_widget[name=display_name]'),'new name');await testUtils.dom.click($('.modal:nth(1) footer .btn-primary').first());assert.strictEqual($('.modal .o_field_widget[name=trululu] input').val(),'new name',"record should have been reloaded");assert.verifySteps(["read","get_formview_id","load_views","read","get_formview_id","load_views","read","write","read",]);form.destroy();});QUnit.test('process the context for inline subview',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="bar" invisible="context.get(\'hide_bar\', False)"/>'+'</tree>'+'</field>'+'</form>',res_id:1,viewOptions:{context:{hide_bar:true},},});assert.containsOnce(form,'.o_list_view thead tr th',"there should be only one column");form.destroy();});QUnit.test('process the context for subview not inline',async function(assert){assert.expect(1);this.data.partner.records[0].p=[2];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="p"/>'+'</form>',archs:{"partner,false,list":'<tree>'+'<field name="foo"/>'+'<field name="bar" invisible="context.get(\'hide_bar\', False)"/>'+'</tree>',},res_id:1,viewOptions:{context:{hide_bar:true},},});assert.containsOnce(form,'.o_list_view thead tr th',"there should be only one column");form.destroy();});QUnit.test('can toggle column in x2many in sub form view',async function(assert){assert.expect(2);this.data.partner.records[2].p=[1,2];this.data.partner.fields.foo.sortable=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="trululu"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/get_formview_id'){return Promise.resolve(false);}
return this._super.apply(this,arguments);},archs:{'partner,false,form':'<form string="Partners">'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</form>',},viewOptions:{mode:'edit'},});await testUtils.dom.click(form.$('.o_external_button'));assert.strictEqual($('.modal-body .o_form_view .o_list_view .o_data_cell').text(),"yopblip","table has some initial order");await testUtils.dom.click($('.modal-body .o_form_view .o_list_view th.o_column_sortable'));assert.strictEqual($('.modal-body .o_form_view .o_list_view .o_data_cell').text(),"blipyop","table is now sorted");form.destroy();});QUnit.test('rainbowman attributes correctly passed on button click',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<button name="action_won" string="Won" type="object" effect="{\'message\': \'Congrats!\'}"/>'+'</header>'+'</form>',intercepts:{execute_action:function(event){var effectDescription=pyUtils.py_eval(event.data.action_data.effect);assert.deepEqual(effectDescription,{message:'Congrats!'},"should have correct effect description");}},});await testUtils.dom.click(form.$('.o_form_statusbar .btn-secondary'));form.destroy();});QUnit.test('basic support for widgets',async function(assert){assert.expect(1);var MyWidget=Widget.extend({init:function(parent,dataPoint){this.data=dataPoint.data;},start:function(){this.$el.text(JSON.stringify(this.data));},});widgetRegistry.add('test',MyWidget);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<field name="bar"/>'+'<widget name="test"/>'+'</form>',});assert.strictEqual(form.$('.o_widget').text(),'{"foo":"My little Foo Value","bar":false}',"widget should have been instantiated");form.destroy();delete widgetRegistry.map.test;});QUnit.test('attach document widget calls action with attachment ids',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method==='my_action'){assert.deepEqual(args.kwargs.attachment_ids,[5,2]);return Promise.resolve();}
return this._super.apply(this,arguments);},arch:'<form>'+'<widget name="attach_document" action="my_action"/>'+'</form>',});var onFileLoadedEventName=form.$('.o_form_binary_form').attr('target');$(window).trigger(onFileLoadedEventName,[{id:5},{id:2}]);form.destroy();});QUnit.test('support header button as widgets on form statusbar',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<header>'+'<widget name="attach_document" string="Attach document"/>'+'</header>'+'</form>',});assert.containsOnce(form,'button.o_attachment_button',"should have 1 attach_document widget in the statusbar");assert.strictEqual(form.$('span.o_attach_document').text().trim(),'Attach document',"widget should have been instantiated");form.destroy();});QUnit.test('basic support for widgets',async function(assert){assert.expect(1);var MyWidget=Widget.extend({init:function(parent,dataPoint){this.data=dataPoint.data;},start:function(){this.$el.text(this.data.foo+"!");},updateState:function(dataPoint){this.$el.text(dataPoint.data.foo+"!");},});widgetRegistry.add('test',MyWidget);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'<widget name="test"/>'+'</form>',});await testUtils.fields.editInput(form.$('input[name="foo"]'),"I am alive");assert.strictEqual(form.$('.o_widget').text(),'I am alive!',"widget should have been updated");form.destroy();delete widgetRegistry.map.test;});QUnit.test('bounce edit button in readonly mode',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div class="oe_title">'+'<field name="display_name"/>'+'</div>'+'</form>',res_id:1,});await testUtils.dom.click(form.$('[name="display_name"]'));assert.hasClass(form.$('.o_form_button_edit'),'o_catch_attention');await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('[name="display_name"]'));assert.containsNone(form,'button.o_catch_attention:visible');form.destroy();});QUnit.test('proper stringification in debug mode tooltip',async function(assert){assert.expect(6);var initialDebugMode=odoo.debug;odoo.debug=true;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="product_id" context="{\'lang\': \'en_US\'}" '+'attrs=\'{"invisible": [["product_id", "=", 33]]}\' '+'widget="many2one" />'+'</sheet>'+'</form>',});var $field=form.$('[name="product_id"]');$field.tooltip('show',true);$field.trigger($.Event('mouseenter'));assert.strictEqual($('.oe_tooltip_technical>li[data-item="context"]').length,1,'context should be present for this field');assert.strictEqual($('.oe_tooltip_technical>li[data-item="context"]')[0].lastChild.wholeText.trim(),"{'lang': 'en_US'}","context should be properly stringified");assert.strictEqual($('.oe_tooltip_technical>li[data-item="modifiers"]').length,1,'modifiers should be present for this field');assert.strictEqual($('.oe_tooltip_technical>li[data-item="modifiers"]')[0].lastChild.wholeText.trim(),'{"invisible":[["product_id","=",33]]}',"modifiers should be properly stringified");assert.strictEqual($('.oe_tooltip_technical>li[data-item="widget"]').length,1,'widget should be present for this field');assert.strictEqual($('.oe_tooltip_technical>li[data-item="widget"]')[0].lastChild.wholeText.trim(),'Many2one (many2one)',"widget description should be correct");odoo.debug=initialDebugMode;form.destroy();});QUnit.test('autoresize of text fields is done when switching to edit mode',async function(assert){assert.expect(4);this.data.partner.fields.text_field={string:'Text field',type:'text'};this.data.partner.fields.text_field.default="some\n\nmulti\n\nline\n\ntext\n";this.data.partner.records[0].text_field="a\nb\nc\nd\ne\nf";var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="display_name"/>'+'<field name="text_field"/>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);var height=form.$('.o_field_widget[name=text_field]').height();form.$('.o_field_widget[name=text_field]').trigger('focus');assert.strictEqual(form.$('.o_field_widget[name=text_field]').height(),height,"autoresize should have been done automatically at rendering");assert.ok(height>80,"textarea should have an height of at least 80px");await testUtils.form.clickSave(form);await testUtils.form.clickCreate(form);height=form.$('.o_field_widget[name=text_field]').height();form.$('.o_field_widget[name=text_field]').trigger('focus');assert.strictEqual(form.$('.o_field_widget[name=text_field]').height(),height,"autoresize should have been done automatically at rendering");assert.ok(height>80,"textarea should have an height of at least 80px");form.destroy();});QUnit.test('autoresize of text fields is done on notebook page show',async function(assert){assert.expect(5);this.data.partner.fields.text_field={string:'Text field',type:'text'};this.data.partner.fields.text_field.default="some\n\nmulti\n\nline\n\ntext\n";this.data.partner.records[0].text_field="a\nb\nc\nd\ne\nf";this.data.partner.fields.text_field_empty={string:'Text field',type:'text'};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<notebook>'+'<page string="First Page">'+'<field name="foo"/>'+'</page>'+'<page string="Second Page">'+'<field name="text_field"/>'+'</page>'+'<page string="Third Page">'+'<field name="text_field_empty"/>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_notebook .nav .nav-link:first()'),'active');await testUtils.dom.click(form.$('.o_notebook .nav .nav-link:nth(1)'));assert.hasClass(form.$('.o_notebook .nav .nav-link:nth(1)'),'active');var height=form.$('.o_field_widget[name=text_field]').height();assert.ok(height>80,"textarea should have an height of at least 80px");await testUtils.dom.click(form.$('.o_notebook .nav .nav-link:nth(2)'));assert.hasClass(form.$('.o_notebook .nav .nav-link:nth(2)'),'active');var height=form.$('.o_field_widget[name=text_field_empty]').css('height');assert.strictEqual(height,'50px',"empty textarea should have height of 50px");form.destroy();});QUnit.test('check if the view destroys all widgets and instances',async function(assert){assert.expect(2);var instanceNumber=0;await testUtils.mock.patch(mixins.ParentedMixin,{init:function(){instanceNumber++;return this._super.apply(this,arguments);},destroy:function(){if(!this.isDestroyed()){instanceNumber--;}
return this._super.apply(this,arguments);}});var params={View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<field name="display_name"/>'+'<field name="foo"/>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'<field name="trululu"/>'+'<field name="timmy"/>'+'<field name="product_id"/>'+'<field name="priority"/>'+'<field name="state"/>'+'<field name="date"/>'+'<field name="datetime"/>'+'<field name="product_ids"/>'+'<field name="p">'+'<tree default_order="foo desc">'+'<field name="display_name"/>'+'<field name="foo"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',archs:{'partner,false,form':'<form string="Partner">'+'<sheet>'+'<group>'+'<field name="foo"/>'+'</group>'+'</sheet>'+'</form>',"partner_type,false,list":'<tree><field name="name"/></tree>','product,false,list':'<tree><field name="display_name"/></tree>',},res_id:1,};var form=await createView(params);assert.ok(instanceNumber>0);form.destroy();assert.strictEqual(instanceNumber,0);await testUtils.mock.unpatch(mixins.ParentedMixin);});QUnit.test('do not change pager when discarding current record',async function(assert){assert.expect(4);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo"/>'+'</form>',viewOptions:{ids:[1,2],index:0,},res_id:2,});assert.strictEqual(cpHelpers.getPagerValue(form),"2",'pager should indicate that we are on second record');assert.strictEqual(cpHelpers.getPagerSize(form),"2",'pager should indicate that we are on second record');await testUtils.form.clickEdit(form);await testUtils.form.clickDiscard(form);assert.strictEqual(cpHelpers.getPagerValue(form),"2",'pager value should not have changed');assert.strictEqual(cpHelpers.getPagerSize(form),"2",'pager limit should not have changed');form.destroy();});QUnit.test('Form view from ordered, grouped list view correct context',async function(assert){assert.expect(10);this.data.partner.records[0].timmy=[12];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="timmy"/>'+'</form>',archs:{'partner_type,false,list':'<tree>'+'<field name="name"/>'+'</tree>',},viewOptions:{context:{orderedBy:[{name:'foo',asc:true}],group_by:['foo'],}},res_id:1,mockRPC:function(route,args){assert.step(args.model+":"+args.method);if(args.method==='read'){assert.ok(args.kwargs.context,'context is present');assert.notOk('orderedBy'in args.kwargs.context,'orderedBy not in context');assert.notOk('group_by'in args.kwargs.context,'group_by not in context');}
return this._super.apply(this,arguments);}});assert.verifySteps(['partner_type:load_views','partner:read','partner_type:read']);form.destroy();});QUnit.test('edition in form view on a "noCache" model',async function(assert){assert.expect(5);await testUtils.mock.patch(BasicModel,{noCacheModels:BasicModel.prototype.noCacheModels.concat(['partner']),});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="display_name"/>'+'</sheet>'+'</form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='write'){assert.step('write');}
return this._super.apply(this,arguments);},});core.bus.on('clear_cache',form,assert.step.bind(assert,'clear_cache'));await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'new value');await testUtils.form.clickSave(form);assert.verifySteps(['write','clear_cache']);form.destroy();await testUtils.mock.unpatch(BasicModel);assert.verifySteps(['clear_cache']);});QUnit.test('creation in form view on a "noCache" model',async function(assert){assert.expect(5);await testUtils.mock.patch(BasicModel,{noCacheModels:BasicModel.prototype.noCacheModels.concat(['partner']),});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="display_name"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='create'){assert.step('create');}
return this._super.apply(this,arguments);},});core.bus.on('clear_cache',form,assert.step.bind(assert,'clear_cache'));await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'value');await testUtils.form.clickSave(form);assert.verifySteps(['create','clear_cache']);form.destroy();await testUtils.mock.unpatch(BasicModel);assert.verifySteps(['clear_cache']);});QUnit.test('deletion in form view on a "noCache" model',async function(assert){assert.expect(5);await testUtils.mock.patch(BasicModel,{noCacheModels:BasicModel.prototype.noCacheModels.concat(['partner']),});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<sheet>'+'<field name="display_name"/>'+'</sheet>'+'</form>',mockRPC:function(route,args){if(args.method==='unlink'){assert.step('unlink');}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{hasActionMenus:true,},});core.bus.on('clear_cache',form,assert.step.bind(assert,'clear_cache'));await cpHelpers.toggleActionMenu(form);await cpHelpers.toggleMenuItem(form,"Delete");await testUtils.dom.click($('.modal-footer .btn-primary'));assert.verifySteps(['unlink','clear_cache']);form.destroy();await testUtils.mock.unpatch(BasicModel);assert.verifySteps(['clear_cache']);});QUnit.test('reload currencies when writing on records of model res.currency',async function(assert){assert.expect(5);this.data['res.currency']={fields:{},records:[{id:1,display_name:"some currency"}],};var form=await createView({View:FormView,model:'res.currency',data:this.data,arch:'<form><field name="display_name"/></form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},session:{reloadCurrencies:function(){assert.step('reload currencies');},},});await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'new value');await testUtils.form.clickSave(form);assert.verifySteps(['read','write','reload currencies','read',]);form.destroy();});QUnit.test('keep editing after call_button fail',async function(assert){assert.expect(4);var values;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<button name="post" class="p" string="Raise Error" type="object"/>'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name"/>'+'<field name="product_id"/>'+'</tree>'+'</field>'+'</form>',res_id:1,intercepts:{execute_action:function(ev){assert.ok(true,'the action is correctly executed');ev.data.on_fail();},},mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1].p[0][2],values);}
return this._super.apply(this,arguments);},viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput(form.$('input[name=display_name]'),'abc');values={display_name:'abc',product_id:false,};await testUtils.dom.click(form.$('button.p'));await testUtils.dom.clickLast(form.$('.o_form_view .o_field_one2many .o_data_row .o_data_cell'));await testUtils.nextTick();await testUtils.fields.many2one.clickOpenDropdown('product_id');await testUtils.fields.many2one.clickHighlightedItem('product_id');assert.strictEqual(form.$('.o_field_many2one input').val(),'xphone',"value of the m2o should have been correctly updated");values={product_id:37,};await testUtils.form.clickSave(form);form.destroy();});QUnit.test('asynchronous rendering of a widget tag',async function(assert){assert.expect(1);var def1=testUtils.makeTestPromise();var MyWidget=Widget.extend({willStart:function(){return def1;},});widgetRegistry.add('test',MyWidget);createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<widget name="test"/>'+'</form>',}).then(function(form){assert.containsOnce(form,'div.o_widget',"there should be a div with widget class");form.destroy();delete widgetRegistry.map.test;});def1.resolve();await testUtils.nextTick();});QUnit.test('no deadlock when saving with uncommitted changes',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="foo"/></form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},fieldDebounce:5000,});await testUtils.fields.editInput(form.$('input[name=foo]'),'some foo value');form.saveRecord();await testUtils.nextTick();assert.containsOnce(form,'.o_form_readonly',"form view should be in readonly");assert.strictEqual(form.$('.o_form_view').text().trim(),'some foo value',"foo field should have correct value");assert.verifySteps(['onchange','create','read']);form.destroy();});QUnit.test('save record with onchange on one2many with required field',async function(assert){assert.expect(6);this.data.partner.fields.foo.default=undefined;this.data.partner.onchanges={display_name:function(obj){obj.foo=obj.display_name?'foo value':undefined;},};var onchangeDef;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<tree editable="top">'+'<field name="display_name"/>'+'<field name="foo" required="1"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(onchangeDef).then(_.constant(result));}
if(args.method==='create'){assert.step('create');assert.strictEqual(args.args[0].p[0][2].foo,'foo value',"should have wait for the onchange to return before saving");}
return result;},});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));assert.strictEqual(form.$('.o_field_widget[name=display_name]').val(),'',"display_name should be the empty string by default");assert.strictEqual(form.$('.o_field_widget[name=foo]').val(),'',"foo should be the empty string by default");onchangeDef=testUtils.makeTestPromise();await testUtils.fields.editInput(form.$('.o_field_widget[name=display_name]'),'some value');await testUtils.form.clickSave(form);assert.step('resolve');onchangeDef.resolve();await testUtils.nextTick();assert.verifySteps(['resolve','create']);form.destroy();});QUnit.test('call canBeRemoved while saving',async function(assert){assert.expect(10);this.data.partner.onchanges={foo:function(obj){obj.display_name=obj.foo==='trigger onchange'?'changed':'default';},};var onchangeDef;var createDef=testUtils.makeTestPromise();var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="display_name"/><field name="foo"/></form>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return Promise.resolve(onchangeDef).then(_.constant(result));}
if(args.method==='create'){return Promise.resolve(createDef).then(_.constant(result));}
return result;},});onchangeDef=testUtils.makeTestPromise();await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'trigger onchange');assert.strictEqual(form.$('.o_field_widget[name=display_name]').val(),'default');await testUtils.dom.click(form.$buttons.find('.o_form_button_save'));assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.strictEqual(form.$('.o_field_widget[name=display_name]').val(),'default');form.canBeRemoved();await testUtils.nextTick();assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.strictEqual(form.$('.o_field_widget[name=display_name]').val(),'default');onchangeDef.resolve();await testUtils.nextTick();assert.hasClass(form.$('.o_form_view'),'o_form_editable');assert.strictEqual(form.$('.o_field_widget[name=display_name]').val(),'changed');createDef.resolve();await testUtils.nextTick();assert.hasClass(form.$('.o_form_view'),'o_form_readonly');assert.strictEqual(form.$('.o_field_widget[name=display_name]').text(),'changed');assert.containsNone(document.body,'.modal',"should not display the 'Changes will be discarded' dialog");form.destroy();});QUnit.test('call canBeRemoved twice',async function(assert){assert.expect(4);const form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="display_name"/><field name="foo"/></form>',res_id:1,viewOptions:{mode:'edit',},});assert.containsOnce(form,'.o_form_editable');await testUtils.fields.editInput(form.$('.o_field_widget[name=foo]'),'some value');form.canBeRemoved();await testUtils.nextTick();assert.containsOnce(document.body,'.modal');form.canBeRemoved();await testUtils.nextTick();assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal .modal-footer .btn-secondary'));assert.containsNone(document.body,'.modal');form.destroy();});QUnit.test('domain returned by onchange is cleared on discard',async function(assert){assert.expect(4);this.data.partner.onchanges={foo:function(){},};var domain=['id','=',1];var expectedDomain=domain;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="foo"/><field name="trululu"/></form>',mockRPC:function(route,args){if(args.method==='onchange'&&args.args[0][0]===1){return Promise.resolve({domain:{trululu:domain,},});}
if(args.method==='name_search'){assert.deepEqual(args.kwargs.args,expectedDomain);}
return this._super.apply(this,arguments);},res_id:1,viewOptions:{ids:[1,2],mode:'edit',},});assert.strictEqual(form.$('input[name=foo]').val(),'yop',"should be on record 1");await testUtils.fields.editInput(form.$('input[name=foo]'),'new value');await testUtils.fields.many2one.clickOpenDropdown('trululu');await cpHelpers.pagerNext(form);await testUtils.dom.click($('.modal .modal-footer .btn-primary:first'));assert.strictEqual(form.$('input[name=foo]').val(),'blip',"should be on record 2");expectedDomain=[];await testUtils.fields.many2one.clickOpenDropdown('trululu');form.destroy();});QUnit.test('discard after a failed save',async function(assert){assert.expect(2);var actionManager=await createActionManager({data:this.data,archs:{'partner,false,form':'<form>'+'<field name="date" required="true"/>'+'<field name="foo" required="true"/>'+'</form>','partner,false,kanban':'<kanban><templates><t t-name="kanban-box">'+'</t></templates></kanban>','partner,false,search':'<search></search>',},actions:this.actions,});await actionManager.doAction(1);await testUtils.dom.click('.o_control_panel .o-kanban-button-new');await testUtils.dom.click('.o_control_panel .o_form_button_save');await testUtils.dom.click('.o_control_panel .o_form_button_cancel');assert.containsNone(actionManager,'.o_form_view');assert.containsOnce(actionManager,'.o_kanban_view');actionManager.destroy();});QUnit.test("one2many create record dialog shouldn't have a 'remove' button",async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="p">'+'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<field name="foo"/>'+'</t>'+'</templates>'+'</kanban>'+'<form>'+'<field name="foo"/>'+'</form>'+'</field>'+'</form>',res_id:1,});await testUtils.form.clickCreate(form);await testUtils.dom.click(form.$('.o-kanban-button-new'));assert.containsOnce(document.body,'.modal');assert.strictEqual($('.modal .modal-footer .o_btn_remove').length,0,"shouldn't have a 'remove' button on new records");form.destroy();});QUnit.test('edit a record in readonly and switch to edit before it is actually saved',async function(assert){assert.expect(3);const prom=testUtils.makeTestPromise();const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form>
                    <field name="foo"/>
                    <field name="bar" widget="toggle_button"/>
                </form>`,mockRPC:function(route,args){const result=this._super.apply(this,arguments);if(args.method==='write'){assert.deepEqual(args.args[1],{bar:false});return prom.then(_.constant(result));}
return result;},res_id:1,});await testUtils.dom.click(form.$('.o_field_widget[name=bar]'));await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_form_view'),'o_form_readonly');prom.resolve();await testUtils.nextTick();assert.hasClass(form.$('.o_form_view'),'o_form_editable');form.destroy();});QUnit.test('"bare" buttons in template should not trigger button click',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<button string="Save" class="btn-primary" special="save"/>'+'<button class="mybutton">westvleteren</button>'+'</form>',res_id:2,intercepts:{execute_action:function(){assert.step('execute_action');},},});await testUtils.dom.click(form.$('.o_form_view button.btn-primary'));assert.verifySteps(['execute_action']);await testUtils.dom.click(form.$('.o_form_view button.mybutton'));assert.verifySteps([]);form.destroy();});QUnit.test('form view with inline tree view with optional fields and local storage mock',async function(assert){assert.expect(12);var Storage=RamStorage.extend({getItem:function(key){assert.step('getItem '+key);return this._super.apply(this,arguments);},setItem:function(key,value){assert.step('setItem '+key+' to '+value);return this._super.apply(this,arguments);},});var RamStorageService=AbstractStorageService.extend({storage:new Storage(),});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="qux"/>'+'<field name="p">'+'<tree>'+'<field name="foo"/>'+'<field name="bar" optional="hide"/>'+'</tree>'+'</field>'+'</form>',services:{local_storage:RamStorageService,},view_id:27,});var localStorageKey='optional_fields,partner,form,27,p,list,undefined,bar,foo';assert.verifySteps(['getItem '+localStorageKey]);assert.containsN(form,'th',2,"should have 2 th, 1 for selector, 1 for foo column");assert.ok(form.$('th:contains(Foo)').is(':visible'),"should have a visible foo field");assert.notOk(form.$('th:contains(Bar)').is(':visible'),"should not have a visible bar field");await testUtils.dom.click(form.$('table .o_optional_columns_dropdown_toggle'));assert.containsN(form,'div.o_optional_columns div.dropdown-item',1,"dropdown have 1 optional field");await testUtils.dom.click(form.$('div.o_optional_columns div.dropdown-item input'));assert.verifySteps(['setItem '+localStorageKey+' to ["bar"]','getItem '+localStorageKey,]);assert.containsN(form,'th',3,"should have 3 th, 1 for selector, 2 for columns");assert.ok(form.$('th:contains(Foo)').is(':visible'),"should have a visible foo field");assert.ok(form.$('th:contains(Bar)').is(':visible'),"should have a visible bar field");form.destroy();});QUnit.test('form view with tree_view_ref with optional fields and local storage mock',async function(assert){assert.expect(12);var Storage=RamStorage.extend({getItem:function(key){assert.step('getItem '+key);return this._super.apply(this,arguments);},setItem:function(key,value){assert.step('setItem '+key+' to '+value);return this._super.apply(this,arguments);},});var RamStorageService=AbstractStorageService.extend({storage:new Storage(),});var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="qux"/>'+'<field name="p" context="{\'tree_view_ref\': \'34\'}"/>'+'</form>',archs:{"partner,nope_not_this_one,list":'<tree>'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>',"partner,34,list":'<tree>'+'<field name="foo" optional="hide"/>'+'<field name="bar"/>'+'</tree>',},services:{local_storage:RamStorageService,},view_id:27,});var localStorageKey='optional_fields,partner,form,27,p,list,34,bar,foo';assert.verifySteps(['getItem '+localStorageKey]);assert.containsN(form,'th',2,"should have 2 th, 1 for selector, 1 for foo column");assert.notOk(form.$('th:contains(Foo)').is(':visible'),"should have a visible foo field");assert.ok(form.$('th:contains(Bar)').is(':visible'),"should not have a visible bar field");await testUtils.dom.click(form.$('table .o_optional_columns_dropdown_toggle'));assert.containsN(form,'div.o_optional_columns div.dropdown-item',1,"dropdown have 1 optional field");await testUtils.dom.click(form.$('div.o_optional_columns div.dropdown-item input'));assert.verifySteps(['setItem '+localStorageKey+' to ["foo"]','getItem '+localStorageKey,]);assert.containsN(form,'th',3,"should have 3 th, 1 for selector, 2 for columns");assert.ok(form.$('th:contains(Foo)').is(':visible'),"should have a visible foo field");assert.ok(form.$('th:contains(Bar)').is(':visible'),"should have a visible bar field");form.destroy();});QUnit.test('using tab in an empty required string field should not move to the next field',async function(assert){assert.expect(3);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="display_name" required="1" />'+'<field name="foo" />'+'</group>'+'</sheet>'+'</form>',});await testUtils.dom.click(form.$('input[name=display_name]'));assert.strictEqual(form.$('input[name="display_name"]')[0],document.activeElement,"display_name should be focused");form.$('input[name="display_name"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('input[name="display_name"]')[0],document.activeElement,"display_name should still be focused because it is empty and required");assert.hasClass(form.$('input[name="display_name"]'),'o_field_invalid',"display_name should have the o_field_invalid class");form.destroy();});QUnit.test('using tab in an empty required date field should not move to the next field',async function(assert){assert.expect(2);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="date" required="1" />'+'<field name="foo" />'+'</group>'+'</sheet>'+'</form>',});await testUtils.dom.click(form.$('input[name=date]'));assert.strictEqual(form.$('input[name="date"]')[0],document.activeElement,"display_name should be focused");form.$('input[name="date"]').trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('input[name="date"]')[0],document.activeElement,"date should still be focused because it is empty and required");form.destroy();});QUnit.test('Edit button get the focus when pressing TAB from form',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<div class="oe_title">'+'<field name="display_name"/>'+'</div>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);form.$('input[name="display_name"]').focus().trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$buttons.find('.btn-primary:visible')[0],document.activeElement,"the first primary button (save) should be focused");form.destroy();});QUnit.test('In Edition mode, after navigating to the last field, the default button when pressing TAB is SAVE',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="state" invisible="1"/>'+'<header>'+'<button name="post" class="btn-primary firstButton" string="Confirm" type="object"/>'+'<button name="post" class="btn-primary secondButton" string="Confirm2" type="object"/>'+'</header>'+'<sheet>'+'<group>'+'<div class="oe_title">'+'<field name="display_name"/>'+'</div>'+'</group>'+'</sheet>'+'</form>',res_id:2,viewOptions:{mode:'edit',},});form.$('input[name="display_name"]').focus().trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$buttons.find('.o_form_button_save:visible')[0],document.activeElement,"the save should be focused");form.destroy();});QUnit.test('In READ mode, the default button with focus is the first primary button of the form',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="state" invisible="1"/>'+'<header>'+'<button name="post" class="btn-primary firstButton" string="Confirm" type="object"/>'+'<button name="post" class="btn-primary secondButton" string="Confirm2" type="object"/>'+'</header>'+'<sheet>'+'<group>'+'<div class="oe_title">'+'<field name="display_name"/>'+'</div>'+'</group>'+'</sheet>'+'</form>',res_id:2,});assert.strictEqual(form.$('button.firstButton')[0],document.activeElement,"by default the focus in edit mode should go to the first primary button of the form (not edit)");form.destroy();});QUnit.test('In READ mode, the default button when pressing TAB is EDIT when there is no primary button on the form',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="state" invisible="1"/>'+'<header>'+'<button name="post" class="not-primary" string="Confirm" type="object"/>'+'<button name="post" class="not-primary" string="Confirm2" type="object"/>'+'</header>'+'<sheet>'+'<group>'+'<div class="oe_title">'+'<field name="display_name"/>'+'</div>'+'</group>'+'</sheet>'+'</form>',res_id:2,});assert.strictEqual(form.$buttons.find('.o_form_button_edit')[0],document.activeElement,"in read mode, when there are no primary buttons on the form, the default button with the focus should be edit");form.destroy();});QUnit.test('In Edition mode, when an attribute is dynamically required (and not required), TAB should navigate to the next field',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" attrs="{\'required\': [[\'bar\', \'=\', True]]}"/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:5,viewOptions:{mode:'edit',},});form.$('input[name="foo"]').focus();$(document.activeElement).trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('div[name="bar"]>input')[0],document.activeElement,"foo is not required, so hitting TAB on foo should have moved the focus to BAR");form.destroy();});QUnit.test('In Edition mode, when an attribute is dynamically required, TAB should stop on the field if it is required',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<sheet>'+'<group>'+'<field name="foo" attrs="{\'required\': [[\'bar\', \'=\', True]]}"/>'+'<field name="bar"/>'+'</group>'+'</sheet>'+'</form>',res_id:5,viewOptions:{mode:'edit',},});await testUtils.dom.click(form.$('div[name="bar"]>input'));form.$('input[name="foo"]').focus();$(document.activeElement).trigger($.Event('keydown',{which:$.ui.keyCode.TAB}));assert.strictEqual(form.$('input[name="foo"]')[0],document.activeElement,"foo is required, so hitting TAB on foo should keep the focus on foo");form.destroy();});QUnit.test('display tooltips for save and discard buttons',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" />'+'</form>',});form.$buttons.find('.o_form_buttons_edit').tooltip('show',false);assert.strictEqual($('.tooltip .oe_tooltip_string').length,1,"should have rendered a tooltip");await testUtils.nextTick();form.destroy();});QUnit.test('if the focus is on the save button, hitting ENTER should save',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" />'+'</form>',viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='create'){assert.ok(true,"should call the /create route");}
return this._super(route,args);},});form.$buttons.find('.o_form_button_save').focus().trigger($.Event('keydown',{which:$.ui.keyCode.ENTER}));await testUtils.nextTick();form.destroy();});QUnit.test('if the focus is on the discard button, hitting ENTER should save',async function(assert){assert.expect(1);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" />'+'</form>',viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='create'){assert.ok(true,"should call the /create route");}
return this._super(route,args);},});form.$buttons.find('.o_form_button_cancel').focus().trigger($.Event('keydown',{which:$.ui.keyCode.ENTER}));await testUtils.nextTick();form.destroy();});QUnit.test('if the focus is on the save button, hitting ESCAPE should discard',async function(assert){assert.expect(0);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" />'+'</form>',viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='create'){throw new Error('Create should not be called');}
return this._super(route,args);},});form.$buttons.find('.o_form_button_save').focus().trigger($.Event('keydown',{which:$.ui.keyCode.ESCAPE}));await testUtils.nextTick();form.destroy();});QUnit.test('resequence list lines when discardable lines are present',async function(assert){assert.expect(8);var onchangeNum=0;this.data.partner.onchanges={p:function(obj){onchangeNum++;obj.foo=obj.p?obj.p.length.toString():"0";},};var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="foo"/>'+'<field name="p"/>'+'</form>',archs:{'partner,false,list':'<tree editable="bottom">'+'<field name="int_field" widget="handle"/>'+'<field name="display_name" required="1"/>'+'</tree>',},});assert.strictEqual(onchangeNum,1,"one onchange happens when form is opened");assert.strictEqual(form.$('[name="foo"]').val(),"0","onchange worked there is 0 line");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.$('.o_field_one2many input:first').focus();await testUtils.nextTick();form.$('.o_field_one2many input:first').val('first line').trigger('input');await testUtils.nextTick();await testUtils.dom.click(form.$('input[name="foo"]'));assert.strictEqual(onchangeNum,2,"one onchange happens when a line is added");assert.strictEqual(form.$('[name="foo"]').val(),"1","onchange worked there is 1 line");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.dom.dragAndDrop(form.$('.ui-sortable-handle').eq(0),form.$('.o_data_row').last(),{position:'bottom'});assert.strictEqual(onchangeNum,3,"one onchange happens when lines are resequenced");assert.strictEqual(form.$('[name="foo"]').val(),"1","onchange worked there is 1 line");await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));form.$('.o_field_one2many input:first').focus();await testUtils.nextTick();form.$('.o_field_one2many input:first').val('second line').trigger('input');await testUtils.nextTick();await testUtils.dom.click(form.$('input[name="foo"]'));assert.strictEqual(onchangeNum,4,"one onchange happens when a line is added");assert.strictEqual(form.$('[name="foo"]').val(),"2","onchange worked there is 2 lines");form.destroy();});QUnit.test('if the focus is on the discard button, hitting ESCAPE should discard',async function(assert){assert.expect(0);var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form string="Partners">'+'<field name="foo" />'+'</form>',viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='create'){throw new Error('Create should not be called');}
return this._super(route,args);},});form.$buttons.find('.o_form_button_cancel').focus().trigger($.Event('keydown',{which:$.ui.keyCode.ESCAPE}));await testUtils.nextTick();form.destroy();});QUnit.test('if the focus is on the save button, hitting TAB should not move to the next button',async function(assert){assert.expect(1);assert.ok("Behavior can't be tested");});QUnit.test('reload company when creating records of model res.company',async function(assert){assert.expect(6);var form=await createView({View:FormView,model:'res.company',data:this.data,arch:'<form><field name="name"/></form>',mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},intercepts:{do_action:function(ev){assert.step('reload company');assert.strictEqual(ev.data.action,"reload_context","company view reloaded");},},});await testUtils.fields.editInput(form.$('input[name="name"]'),'Test Company');await testUtils.form.clickSave(form);assert.verifySteps(['onchange','create','reload company','read',]);form.destroy();});QUnit.test('reload company when writing on records of model res.company',async function(assert){assert.expect(6);this.data['res.company'].records=[{id:1,name:"Test Company"}];var form=await createView({View:FormView,model:'res.company',data:this.data,arch:'<form><field name="name"/></form>',res_id:1,viewOptions:{mode:'edit',},mockRPC:function(route,args){assert.step(args.method);return this._super.apply(this,arguments);},intercepts:{do_action:function(ev){assert.step('reload company');assert.strictEqual(ev.data.action,"reload_context","company view reloaded");},},});await testUtils.fields.editInput(form.$('input[name="name"]'),'Test Company2');await testUtils.form.clickSave(form);assert.verifySteps(['read','write','reload company','read',]);form.destroy();});QUnit.test('company_dependent field in form view, in multi company group',async function(assert){assert.expect(2);this.data.partner.fields.product_id.company_dependent=true;this.data.partner.fields.product_id.help='this is a tooltip';this.data.partner.fields.foo.company_dependent=true;const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <group>
                        <field name="foo"/>
                        <field name="product_id"/>
                    </group>
                </form>`,session:{display_switch_company_menu:true,},});const $productLabel=form.$('.o_form_label:eq(1)');$productLabel.tooltip('show',false);$productLabel.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_help').text().trim(),"this is a tooltip\n\nValues set here are company-specific.");$productLabel.trigger($.Event('mouseleave'));const $fooLabel=form.$('.o_form_label:first');$fooLabel.tooltip('show',false);$fooLabel.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_help').text().trim(),"Values set here are company-specific.");$fooLabel.trigger($.Event('mouseleave'));form.destroy();});QUnit.test('company_dependent field in form view, not in multi company group',async function(assert){assert.expect(1);this.data.partner.fields.product_id.company_dependent=true;this.data.partner.fields.product_id.help='this is a tooltip';const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                <form>
                    <group>
                        <field name="product_id"/>
                    </group>
                </form>`,session:{display_switch_company_menu:false,},});const $productLabel=form.$('.o_form_label');$productLabel.tooltip('show',false);$productLabel.trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_help').text().trim(),"this is a tooltip");$productLabel.trigger($.Event('mouseleave'));form.destroy();});QUnit.test('reload a form view with a pie chart does not crash',async function(assert){assert.expect(3);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form>
                      <widget name="pie_chart" title="qux by product" attrs="{'measure\': 'qux', 'groupby': 'product_id'}"/>
                  </form>`,});assert.containsOnce(form,'.o_widget');const canvasId1=form.el.querySelector('.o_widget canvas').id;await form.reload();await testUtils.nextTick();assert.containsOnce(form,'.o_widget');const canvasId2=form.el.querySelector('.o_widget canvas').id;assert.notStrictEqual(canvasId1,canvasId2);form.destroy();delete widgetRegistry.map.test;});QUnit.test('do not call mounted twice on children',async function(assert){assert.expect(3);class CustomFieldComponent extends fieldRegistryOwl.get('boolean'){mounted(){super.mounted(...arguments);assert.step('mounted');}
willUnmount(){super.willUnmount(...arguments);assert.step('willUnmount');}}
fieldRegistryOwl.add('custom',CustomFieldComponent);const form=await createView({View:FormView,model:'partner',data:this.data,arch:`<form><field name="bar" widget="custom"/></form>`,});form.destroy();delete fieldRegistryOwl.map.custom;assert.verifySteps(['mounted','willUnmount']);});});});;

/* /web/static/tests/views/graph_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.graph_view_tests',function(require){"use strict";var searchUtils=require('web.searchUtils');var GraphView=require('web.GraphView');var testUtils=require('web.test_utils');const{sortBy}=require('web.utils');const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;var patchDate=testUtils.mock.patchDate;const{INTERVAL_OPTIONS,PERIOD_OPTIONS,COMPARISON_OPTIONS}=searchUtils;var INTERVAL_OPTION_IDS=Object.keys(INTERVAL_OPTIONS);const yearIds=[];const otherIds=[];for(const id of Object.keys(PERIOD_OPTIONS)){const option=PERIOD_OPTIONS[id];if(option.granularity==='year'){yearIds.push(id);}else{otherIds.push(id);}}
const BASIC_DOMAIN_IDS=[];for(const yearId of yearIds){BASIC_DOMAIN_IDS.push(yearId);for(const id of otherIds){BASIC_DOMAIN_IDS.push(`${yearId}__${id}`);}}
const GENERATOR_INDEXES={};let index=0;for(const id of Object.keys(PERIOD_OPTIONS)){GENERATOR_INDEXES[id]=index++;}
const COMPARISON_OPTION_IDS=Object.keys(COMPARISON_OPTIONS);const COMPARISON_OPTION_INDEXES={};index=0;for(const comparisonOptionId of COMPARISON_OPTION_IDS){COMPARISON_OPTION_INDEXES[comparisonOptionId]=index++;}
var f=(a,b)=>[].concat(...a.map(d=>b.map(e=>[].concat(d,e))));var cartesian=(a,b,...c)=>(b?cartesian(f(a,b),...c):a);var COMBINATIONS=cartesian(COMPARISON_OPTION_IDS,BASIC_DOMAIN_IDS);var COMBINATIONS_WITH_DATE=cartesian(COMPARISON_OPTION_IDS,BASIC_DOMAIN_IDS,INTERVAL_OPTION_IDS);QUnit.assert.checkDatasets=function(graph,keys,expectedDatasets){keys=keys instanceof Array?keys:[keys];expectedDatasets=expectedDatasets instanceof Array?expectedDatasets:[expectedDatasets];var datasets=graph.renderer.chart.data.datasets;var actualValues=datasets.map(dataset=>_.pick(dataset,keys));this.pushResult({result:_.isEqual(actualValues,expectedDatasets),actual:actualValues,expected:expectedDatasets,});};QUnit.assert.checkLabels=function(graph,expectedLabels){var labels=graph.renderer.chart.data.labels;this.pushResult({result:_.isEqual(labels,expectedLabels),actual:labels,expected:expectedLabels,});};QUnit.assert.checkLegend=function(graph,expectedLegendLabels){expectedLegendLabels=expectedLegendLabels instanceof Array?expectedLegendLabels:[expectedLegendLabels];var chart=graph.renderer.chart;var actualLegendLabels=chart.config.options.legend.labels.generateLabels(chart).map(o=>o.text);this.pushResult({result:_.isEqual(actualLegendLabels,expectedLegendLabels),actual:actualLegendLabels,expected:expectedLegendLabels,});};QUnit.module('Views',{beforeEach:function(){this.data={foo:{fields:{foo:{string:"Foo",type:"integer",store:true},bar:{string:"bar",type:"boolean"},product_id:{string:"Product",type:"many2one",relation:'product',store:true},color_id:{string:"Color",type:"many2one",relation:'color'},date:{string:"Date",type:'date',store:true,sortable:true},revenue:{string:"Revenue",type:'integer',store:true},},records:[{id:1,foo:3,bar:true,product_id:37,date:"2016-01-01",revenue:1},{id:2,foo:53,bar:true,product_id:37,color_id:7,date:"2016-01-03",revenue:2},{id:3,foo:2,bar:true,product_id:37,date:"2016-03-04",revenue:3},{id:4,foo:24,bar:false,product_id:37,date:"2016-03-07",revenue:4},{id:5,foo:4,bar:false,product_id:41,date:"2016-05-01",revenue:5},{id:6,foo:63,bar:false,product_id:41},{id:7,foo:42,bar:false,product_id:41},{id:8,foo:48,bar:false,product_id:41,date:"2016-04-01",revenue:8},]},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},color:{fields:{name:{string:"Color",type:"char"}},records:[{id:7,display_name:"red",},{id:14,display_name:"black",}]},};}},function(){QUnit.module('GraphView');QUnit.test('simple graph rendering',async function(assert){assert.expect(5);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners">'+'<field name="bar"/>'+'</graph>',});assert.containsOnce(graph,'div.o_graph_canvas_container canvas',"should contain a div with a canvas element");assert.strictEqual(graph.renderer.state.mode,"bar","should be in bar chart mode by default");assert.checkLabels(graph,[[true],[false]]);assert.checkDatasets(graph,['backgroundColor','data','label','originIndex','stack'],{backgroundColor:"#1f77b4",data:[3,5],label:"Count",originIndex:0,stack:"",});assert.checkLegend(graph,'Count');graph.destroy();});QUnit.test('default type attribute',async function(assert){assert.expect(1);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners" type="pie">'+'<field name="bar"/>'+'</graph>',});assert.strictEqual(graph.renderer.state.mode,"pie","should be in pie chart mode by default");graph.destroy();});QUnit.test('title attribute',async function(assert){assert.expect(1);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph title="Partners" type="pie">'+'<field name="bar"/>'+'</graph>',});assert.strictEqual(graph.$('.o_graph_renderer label').text(),"Partners","should have 'Partners as title'");graph.destroy();});QUnit.test('field id not in groupBy',async function(assert){assert.expect(1);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners">'+'<field name="id"/>'+'</graph>',mockRPC:function(route,args){if(args.method==='read_group'){assert.deepEqual(args.kwargs.groupby,[],'groupby should not contain id field');}
return this._super.apply(this,arguments);},});graph.destroy();});QUnit.test('switching mode',async function(assert){assert.expect(6);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners" type="line">'+'<field name="bar"/>'+'</graph>',});assert.strictEqual(graph.renderer.state.mode,"line","should be in line chart mode by default");assert.doesNotHaveClass(graph.$buttons.find('button[data-mode="bar"]'),'active','bar type button should not be active');assert.hasClass(graph.$buttons.find('button[data-mode="line"]'),'active','line type button should be active');await testUtils.dom.click(graph.$buttons.find('button[data-mode="bar"]'));assert.strictEqual(graph.renderer.state.mode,"bar","should be in bar chart mode by default");assert.doesNotHaveClass(graph.$buttons.find('button[data-mode="line"]'),'active','line type button should not be active');assert.hasClass(graph.$buttons.find('button[data-mode="bar"]'),'active','bar type button should be active');graph.destroy();});QUnit.test('displaying line chart with only 1 data point',async function(assert){assert.expect(1);this.data.foo.records=this.data.foo.records.slice(0,1);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners" type="line">'+'<field name="bar"/>'+'</graph>',});assert.containsOnce(graph,'canvas',"should have a canvas");graph.destroy();});QUnit.test('displaying chart data with multiple groupbys',async function(assert){assert.expect(6);var graph=await createView({View:GraphView,model:'foo',data:this.data,arch:'<graph type="bar"><field name="foo" /></graph>',groupBy:['product_id','bar','color_id'],});assert.checkLabels(graph,[['xphone'],['xpad']]);assert.checkLegend(graph,['true/Undefined','true/red','false/Undefined']);await testUtils.dom.click(graph.$buttons.find('button[data-mode="line"]'));assert.checkLabels(graph,[['xphone'],['xpad']]);assert.checkLegend(graph,['true/Undefined','true/red','false/Undefined']);await testUtils.dom.click(graph.$buttons.find('button[data-mode="pie"]'));assert.checkLabels(graph,[["xphone",true,"Undefined"],["xphone",true,"red"],["xphone",false,"Undefined"],["xpad",false,"Undefined"]]);assert.checkLegend(graph,['xphone/true/Undefined','xphone/true/red','xphone/false/Undefined','xpad/false/Undefined']);graph.destroy();});QUnit.test('switching measures',async function(assert){assert.expect(2);var rpcCount=0;var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Gloups">'+'<field name="product_id"/>'+'</graph>',mockRPC:function(route,args){rpcCount++;return this._super(route,args);},});await cpHelpers.toggleMenu(graph,"Measures");await cpHelpers.toggleMenuItem(graph,"Foo");assert.checkLegend(graph,'Foo');assert.strictEqual(rpcCount,2,"should have done 2 rpcs (2 readgroups)");graph.destroy();});QUnit.test('no content helper (bar chart)',async function(assert){assert.expect(3);this.data.foo.records=[];var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`
                <graph string="Gloups">
                    <field name="product_id"/>
                </graph>`,viewOptions:{action:{help:'<p class="abc">This helper should not be displayed in graph views</p>'}},});assert.containsOnce(graph,'div.o_graph_canvas_container canvas');assert.containsNone(graph,'div.o_view_nocontent');assert.containsNone(graph,'.abc');graph.destroy();});QUnit.test('no content helper (pie chart)',async function(assert){assert.expect(3);this.data.foo.records=[];var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`
                <graph type="pie">
                    <field name="product_id"/>
                </graph>`,viewOptions:{action:{help:'<p class="abc">This helper should not be displayed in graph views</p>'}},});assert.containsOnce(graph,'div.o_graph_canvas_container canvas');assert.containsNone(graph,'div.o_view_nocontent');assert.containsNone(graph,'.abc');graph.destroy();});QUnit.test('render pie chart in comparison mode',async function(assert){assert.expect(2);const unpatchDate=patchDate(2020,4,19,1,0,0);var graph=await createView({View:GraphView,model:"foo",data:this.data,context:{search_default_date_filter:1,},arch:'<graph type="pie">'+'<field name="product_id"/>'+'</graph>',archs:{'foo,false,search':`
                    <search>
                        <filter name="date_filter" domain="[]" date="date" default_period="third_quarter"/>
                    </search>
                `,},});await cpHelpers.toggleComparisonMenu(graph);await cpHelpers.toggleMenuItem(graph,'Date: Previous period');assert.containsNone(graph,'div.o_view_nocontent',"should not display the no content helper");assert.checkLegend(graph,'No data');unpatchDate();graph.destroy();});QUnit.test('no content helper after update',async function(assert){assert.expect(6);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`
                <graph string="Gloups">
                    <field name="product_id"/>
                </graph>`,viewOptions:{action:{help:'<p class="abc">This helper should not be displayed in graph views</p>'}},});assert.containsOnce(graph,'div.o_graph_canvas_container canvas');assert.containsNone(graph,'div.o_view_nocontent');assert.containsNone(graph,'.abc');await testUtils.graph.reload(graph,{domain:[['product_id','<',0]]});assert.containsOnce(graph,'div.o_graph_canvas_container canvas');assert.containsNone(graph,'div.o_view_nocontent');assert.containsNone(graph,'.abc');graph.destroy();});QUnit.test('can reload with other group by',async function(assert){assert.expect(2);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Gloups">'+'<field name="product_id"/>'+'</graph>',});assert.checkLabels(graph,[['xphone'],['xpad']]);await testUtils.graph.reload(graph,{groupBy:['color_id']});assert.checkLabels(graph,[['Undefined'],['red']]);graph.destroy();});QUnit.test('getOwnedQueryParams correctly returns mode, measure, and groupbys',async function(assert){assert.expect(4);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Gloups">'+'<field name="product_id"/>'+'</graph>',});assert.deepEqual(graph.getOwnedQueryParams(),{context:{graph_mode:'bar',graph_measure:'__count__',graph_groupbys:['product_id'],}},"context should be correct");await cpHelpers.toggleMenu(graph,"Measures");await cpHelpers.toggleMenuItem(graph,"Foo");assert.deepEqual(graph.getOwnedQueryParams(),{context:{graph_mode:'bar',graph_measure:'foo',graph_groupbys:['product_id'],},},"context should be correct");await testUtils.dom.click(graph.$buttons.find('button[data-mode="line"]'));assert.deepEqual(graph.getOwnedQueryParams(),{context:{graph_mode:'line',graph_measure:'foo',graph_groupbys:['product_id'],},},"context should be correct");await testUtils.graph.reload(graph,{groupBy:['product_id','color_id']});assert.deepEqual(graph.getOwnedQueryParams(),{context:{graph_mode:'line',graph_measure:'foo',graph_groupbys:['product_id','color_id'],},},"context should be correct");graph.destroy();});QUnit.test('correctly uses graph_ keys from the context',async function(assert){assert.expect(5);var lastOne=_.last(this.data.foo.records);lastOne.color_id=14;var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph><field name="product_id"/></graph>',viewOptions:{context:{graph_measure:'foo',graph_mode:'line',graph_groupbys:['color_id'],},},});assert.checkLegend(graph,'Foo');assert.strictEqual(graph.renderer.state.mode,"line","should be in line chart mode");assert.doesNotHaveClass(graph.$buttons.find('button[data-mode="bar"]'),'active','bar chart button should not be active');assert.hasClass(graph.$buttons.find('button[data-mode="line"]'),'active','line chart button should be active');assert.checkLabels(graph,[['red'],['black']]);graph.destroy();});QUnit.test('correctly use group_by key from the context',async function(assert){assert.expect(1);var lastOne=_.last(this.data.foo.records);lastOne.color_id=14;var graph=await createView({View:GraphView,model:'foo',data:this.data,arch:'<graph><field name="product_id" /></graph>',groupBy:['color_id'],viewOptions:{context:{graph_measure:'foo',graph_mode:'line',},},});assert.checkLabels(graph,[['red'],['black']]);graph.destroy();});QUnit.test('correctly uses graph_ keys from the context (at reload)',async function(assert){assert.expect(7);var lastOne=_.last(this.data.foo.records);lastOne.color_id=14;var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph><field name="product_id"/></graph>',});assert.strictEqual(graph.renderer.state.mode,"bar","should be in bar chart mode");assert.hasClass(graph.$buttons.find('button[data-mode="bar"]'),'active','bar chart button should be active');var reloadParams={context:{graph_measure:'foo',graph_mode:'line',graph_groupbys:['color_id'],},};await testUtils.graph.reload(graph,reloadParams);assert.checkLegend(graph,'Foo');assert.strictEqual(graph.renderer.state.mode,"line","should be in line chart mode");assert.doesNotHaveClass(graph.$buttons.find('button[data-mode="bar"]'),'active','bar chart button should not be active');assert.hasClass(graph.$buttons.find('button[data-mode="line"]'),'active','line chart button should be active');assert.checkLabels(graph,[['red'],['black']]);graph.destroy();});QUnit.test('reload graph with correct fields',async function(assert){assert.expect(2);var graph=await createView({View:GraphView,model:'foo',data:this.data,arch:'<graph>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</graph>',mockRPC:function(route,args){if(args.method==='read_group'){assert.deepEqual(args.kwargs.fields,['product_id','foo'],"should read the correct fields");}
return this._super.apply(this,arguments);},});await testUtils.graph.reload(graph,{groupBy:[]});graph.destroy();});QUnit.test('initial groupby is kept when reloading',async function(assert){assert.expect(8);var graph=await createView({View:GraphView,model:'foo',data:this.data,arch:'<graph>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</graph>',mockRPC:function(route,args){if(args.method==='read_group'){assert.deepEqual(args.kwargs.groupby,['product_id'],"should group by the correct field");}
return this._super.apply(this,arguments);},});assert.checkLabels(graph,[['xphone'],['xpad']]);assert.checkLegend(graph,'Foo');assert.checkDatasets(graph,'data',{data:[82,157]});await testUtils.graph.reload(graph,{groupBy:[]});assert.checkLabels(graph,[['xphone'],['xpad']]);assert.checkLegend(graph,'Foo');assert.checkDatasets(graph,'data',{data:[82,157]});graph.destroy();});QUnit.test('use a many2one as a measure should work (without groupBy)',async function(assert){assert.expect(4);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners">'+'<field name="product_id" type="measure"/>'+'</graph>',});assert.containsOnce(graph,'div.o_graph_canvas_container canvas',"should contain a div with a canvas element");assert.checkLabels(graph,[[]]);assert.checkLegend(graph,'Product');assert.checkDatasets(graph,'data',{data:[2]});graph.destroy();});QUnit.test('use a many2one as a measure should work (with groupBy)',async function(assert){assert.expect(5);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners">'+'<field name="bar" type="row"/>'+'<field name="product_id" type="measure"/>'+'</graph>',});assert.containsOnce(graph,'div.o_graph_canvas_container canvas',"should contain a div with a canvas element");assert.strictEqual(graph.renderer.state.mode,"bar","should be in bar chart mode by default");assert.checkLabels(graph,[[true],[false]]);assert.checkLegend(graph,'Product');assert.checkDatasets(graph,'data',{data:[1,2]});graph.destroy();});QUnit.test('use a many2one as a measure and as a groupby should work',async function(assert){assert.expect(3);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners">'+'<field name="product_id" type="row"/>'+'</graph>',viewOptions:{additionalMeasures:['product_id'],},});await cpHelpers.toggleMenu(graph,"Measures");await cpHelpers.toggleMenuItem(graph,"Product");assert.checkLabels(graph,[['xphone'],['xpad']]);assert.checkLegend(graph,'Product');assert.checkDatasets(graph,'data',{data:[1,1]});graph.destroy();});QUnit.test('not use a many2one as a measure by default',async function(assert){assert.expect(1);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners">'+'<field name="product_id"/>'+'</graph>',});assert.notOk(graph.measures.product_id,"should not have product_id as measure");graph.destroy();});QUnit.test('use a many2one as a measure if set as additional fields',async function(assert){assert.expect(1);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners">'+'<field name="product_id"/>'+'</graph>',viewOptions:{additionalMeasures:['product_id'],},});assert.ok(graph.measures.find(m=>m.fieldName==='product_id'),"should have product_id as measure");graph.destroy();});QUnit.test('measure dropdown consistency',async function(assert){assert.expect(2);const actionManager=await testUtils.createActionManager({archs:{'foo,false,graph':`
                    <graph string="Partners" type="bar">
                        <field name="foo" type="measure"/>
                    </graph>`,'foo,false,search':`<search/>`,'foo,false,kanban':`
                    <kanban>
                        <templates>
                            <div t-name="kanban-box">
                                <field name="foo"/>
                            </div>
                        </templates>
                    </kanban>`,},data:this.data,});await actionManager.doAction({res_model:'foo',type:'ir.actions.act_window',views:[[false,'graph'],[false,'kanban']],flags:{graph:{additionalMeasures:['product_id'],}},});assert.containsOnce(actionManager,'.o_control_panel .o_graph_measures_list',"Measures dropdown is present at init");await cpHelpers.switchView(actionManager,'kanban');await cpHelpers.switchView(actionManager,'graph');assert.containsOnce(actionManager,'.o_control_panel .o_graph_measures_list',"Measures dropdown is present after reload");actionManager.destroy();});QUnit.test('graph view crash when moving from search view using Down key',async function(assert){assert.expect(1);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners" type="pie">'+'<field name="bar"/>'+'</graph>',});graph._giveFocus();assert.ok(true,"should not generate any error");graph.destroy();});QUnit.test('graph measures should be alphabetically sorted',async function(assert){assert.expect(2);var data=this.data;data.foo.fields.bouh={string:"bouh",type:"integer"};var graph=await createView({View:GraphView,model:"foo",data:data,arch:'<graph string="Partners">'+'<field name="foo" type="measure"/>'+'<field name="bouh" type="measure"/>'+'</graph>',});await cpHelpers.toggleMenu(graph,"Measures");assert.strictEqual(graph.$buttons.find('.o_graph_measures_list .dropdown-item:first').text(),'bouh',"Bouh should be the first measure");assert.strictEqual(graph.$buttons.find('.o_graph_measures_list .dropdown-item:last').text(),'Count',"Count should be the last measure");graph.destroy();});QUnit.test('Undefined should appear in bar, pie graph but not in line graph',async function(assert){assert.expect(3);var graph=await createView({View:GraphView,model:"foo",groupBy:['date'],data:this.data,arch:'<graph string="Partners" type="line">'+'<field name="bar"/>'+'</graph>',});function _indexOf(label){return graph.renderer._indexOf(graph.renderer.chart.data.labels,label);}
assert.strictEqual(_indexOf(['Undefined']),-1);await testUtils.dom.click(graph.$buttons.find('.o_graph_button[data-mode=bar]'));assert.ok(_indexOf(['Undefined'])>=0);await testUtils.dom.click(graph.$buttons.find('.o_graph_button[data-mode=pie]'));assert.ok(_indexOf(['Undefined'])>=0);graph.destroy();});QUnit.test('Undefined should appear in bar, pie graph but not in line graph with multiple groupbys',async function(assert){assert.expect(4);var graph=await createView({View:GraphView,model:"foo",groupBy:['date','color_id'],data:this.data,arch:'<graph string="Partners" type="line">'+'<field name="bar"/>'+'</graph>',});function _indexOf(label){return graph.renderer._indexOf(graph.renderer.chart.data.labels,label);}
assert.strictEqual(_indexOf(['Undefined']),-1);await testUtils.dom.click(graph.$buttons.find('.o_graph_button[data-mode=bar]'));assert.ok(_indexOf(['Undefined'])>=0);await testUtils.dom.click(graph.$buttons.find('.o_graph_button[data-mode=pie]'));var labels=graph.renderer.chart.data.labels;assert.ok(labels.filter(label=>/Undefined/.test(label.join(''))).length>=1);await testUtils.dom.click(graph.$buttons.find('.o_graph_button[data-mode=line]'));assert.strictEqual(_indexOf(['Undefined']),-1);graph.destroy();});QUnit.test('no comparison and no groupby',async function(assert){assert.expect(9);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners" type="bar">'+'<field name="foo" type="measure"/>'+'</graph>',});assert.checkLabels(graph,[[]]);assert.checkLegend(graph,'Foo');assert.checkDatasets(graph,'data',{data:[239]});await testUtils.dom.click(graph.$('.o_graph_button[data-mode=line]'));assert.checkLabels(graph,[[''],[],['']]);assert.checkLegend(graph,'Foo');assert.checkDatasets(graph,'data',{data:[undefined,239]});await testUtils.dom.click(graph.$('.o_graph_button[data-mode=pie]'));assert.checkLabels(graph,[[]]);assert.checkLegend(graph,'Total');assert.checkDatasets(graph,'data',{data:[239]});graph.destroy();});QUnit.test('no comparison and one groupby',async function(assert){assert.expect(9);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners" type="bar">'+'<field name="foo" type="measure"/>'+'<field name="bar" type="row"/>'+'</graph>',});assert.checkLabels(graph,[[true],[false]]);assert.checkLegend(graph,'Foo');assert.checkDatasets(graph,'data',{data:[58,181]});await testUtils.dom.click(graph.$('.o_graph_button[data-mode=line]'));assert.checkLabels(graph,[[true],[false]]);assert.checkLegend(graph,'Foo');assert.checkDatasets(graph,'data',{data:[58,181]});await testUtils.dom.click(graph.$('.o_graph_button[data-mode=pie]'));assert.checkLabels(graph,[[true],[false]]);assert.checkLegend(graph,['true','false']);assert.checkDatasets(graph,'data',{data:[58,181]});graph.destroy();});QUnit.test('no comparison and two groupby',async function(assert){assert.expect(9);var graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Partners" type="bar">'+'<field name="foo" type="measure"/>'+'</graph>',groupBy:['product_id','color_id'],});assert.checkLabels(graph,[['xphone'],['xpad']]);assert.checkLegend(graph,['Undefined','red']);assert.checkDatasets(graph,['label','data'],[{label:'Undefined',data:[29,157],},{label:'red',data:[53,0],}]);await testUtils.dom.click(graph.$('.o_graph_button[data-mode=line]'));assert.checkLabels(graph,[['xphone'],['xpad']]);assert.checkLegend(graph,['Undefined','red']);assert.checkDatasets(graph,['label','data'],[{label:'Undefined',data:[29,157],},{label:'red',data:[53,0],}]);await testUtils.dom.click(graph.$('.o_graph_button[data-mode=pie]'));assert.checkLabels(graph,[['xphone','Undefined'],['xphone','red'],['xpad','Undefined']]);assert.checkLegend(graph,['xphone/Undefined','xphone/red','xpad/Undefined']);assert.checkDatasets(graph,['label','data'],{label:'',data:[29,53,157],});graph.destroy();});QUnit.test('graph view only keeps finer groupby filter option for a given groupby',async function(assert){assert.expect(3);var graph=await createView({View:GraphView,model:"foo",groupBy:['date:year','product_id','date','date:quarter'],data:this.data,arch:'<graph string="Partners" type="line">'+'<field name="bar"/>'+'</graph>',});assert.checkLabels(graph,[["January 2016"],["March 2016"],["May 2016"],["April 2016"]]);assert.checkLegend(graph,["xphone","xpad"]);assert.checkDatasets(graph,['label','data'],[{label:'xphone',data:[2,2,0,0],},{label:'xpad',data:[0,0,1,1],}]);graph.destroy();});QUnit.test('clicking on bar and pie charts triggers a do_action',async function(assert){assert.expect(5);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Foo Analysis"><field name="bar"/></graph>',intercepts:{do_action:function(ev){assert.deepEqual(ev.data.action,{context:{},domain:[["bar","=",true]],name:"Foo Analysis",res_model:"foo",target:'current',type:'ir.actions.act_window',view_mode:'list',views:[[false,'list'],[false,'form']],},"should trigger do_action with correct action parameter");}},});await testUtils.nextTick();assert.strictEqual(graph.renderer.state.mode,"bar","should be in bar chart mode");assert.checkDatasets(graph,['domain'],{domain:[[["bar","=",true]],[["bar","=",false]]],});let myChart=graph.renderer.chart;let meta=myChart.getDatasetMeta(0);let rectangle=myChart.canvas.getBoundingClientRect();let point=meta.data[0].getCenterPoint();await testUtils.dom.triggerEvent(myChart.canvas,'click',{pageX:rectangle.left+point.x,pageY:rectangle.top+point.y});await testUtils.dom.click(graph.$('.o_graph_button[data-mode=pie]'));assert.strictEqual(graph.renderer.state.mode,"pie","should be in pie chart mode");myChart=graph.renderer.chart;meta=myChart.getDatasetMeta(0);rectangle=myChart.canvas.getBoundingClientRect();point=meta.data[0].getCenterPoint();await testUtils.dom.triggerEvent(myChart.canvas,'click',{pageX:rectangle.left+point.x,pageY:rectangle.top+point.y});graph.destroy();});QUnit.test('clicking charts trigger a do_action with correct views',async function(assert){assert.expect(3);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph string="Foo Analysis"><field name="bar"/></graph>',intercepts:{do_action:function(ev){assert.deepEqual(ev.data.action,{context:{},domain:[["bar","=",true]],name:"Foo Analysis",res_model:"foo",target:'current',type:'ir.actions.act_window',view_mode:'list',views:[[364,'list'],[29,'form']],},"should trigger do_action with correct action parameter");}},viewOptions:{actionViews:[{type:'list',viewID:364,},{type:'form',viewID:29,}],},});await testUtils.nextTick();assert.strictEqual(graph.renderer.state.mode,"bar","should be in bar chart mode");assert.checkDatasets(graph,['domain'],{domain:[[["bar","=",true]],[["bar","=",false]]],});let myChart=graph.renderer.chart;let meta=myChart.getDatasetMeta(0);let rectangle=myChart.canvas.getBoundingClientRect();let point=meta.data[0].getCenterPoint();await testUtils.dom.triggerEvent(myChart.canvas,'click',{pageX:rectangle.left+point.x,pageY:rectangle.top+point.y});graph.destroy();});QUnit.test('graph view with attribute disable_linking="True"',async function(assert){assert.expect(2);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:'<graph disable_linking="1"><field name="bar"/></graph>',intercepts:{do_action:function(){throw new Error('Should not perform a do_action');},},});await testUtils.nextTick();assert.strictEqual(graph.renderer.state.mode,"bar","should be in bar chart mode");assert.checkDatasets(graph,['domain'],{domain:[[["bar","=",true]],[["bar","=",false]]],});let myChart=graph.renderer.chart;let meta=myChart.getDatasetMeta(0);let rectangle=myChart.canvas.getBoundingClientRect();let point=meta.data[0].getCenterPoint();await testUtils.dom.triggerEvent(myChart.canvas,'click',{pageX:rectangle.left+point.x,pageY:rectangle.top+point.y});graph.destroy();});QUnit.test('graph view without invisible attribute on field',async function(assert){assert.expect(4);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`<graph string="Partners"></graph>`,});await testUtils.dom.click(graph.$('.btn-group:first button'));assert.containsN(graph,'li.o_menu_item',3,"there should be three menu item in the measures dropdown (count, revenue and foo)");assert.containsOnce(graph,'li.o_menu_item a:contains("Revenue")');assert.containsOnce(graph,'li.o_menu_item a:contains("Foo")');assert.containsOnce(graph,'li.o_menu_item a:contains("Count")');graph.destroy();});QUnit.test('graph view with invisible attribute on field',async function(assert){assert.expect(2);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`
                <graph string="Partners">
                    <field name="revenue" invisible="1"/>
                </graph>`,});await testUtils.dom.click(graph.$('.btn-group:first button'));assert.containsN(graph,'li.o_menu_item',2,"there should be only two menu item in the measures dropdown (count and foo)");assert.containsNone(graph,'li.o_menu_item a:contains("Revenue")');graph.destroy();});QUnit.test('graph view sort by measure',async function(assert){assert.expect(18);this.data.product.records.push({id:38,display_name:"zphone"});this.data.foo.records[7].product_id=38;const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`<graph string="Partners" order="desc">
                        <field name="product_id"/>
                </graph>`,});assert.containsN(graph,'button[data-order]',2,"there should be two order buttons for sorting axis labels in bar mode");assert.checkLegend(graph,'Count','measure should be by count');assert.hasClass(graph.$('button[data-order="desc"]'),'active','sorting should be applie on descending order by default when sorting="desc"');assert.checkDatasets(graph,'data',{data:[4,3,1]});await testUtils.dom.click(graph.$buttons.find('button[data-order="asc"]'));assert.hasClass(graph.$('button[data-order="asc"]'),'active',"ascending order should be applied");assert.checkDatasets(graph,'data',{data:[1,3,4]});await testUtils.dom.click(graph.$buttons.find('button[data-order="desc"]'));assert.hasClass(graph.$('button[data-order="desc"]'),'active',"descending order button should be active");assert.checkDatasets(graph,'data',{data:[4,3,1]});await testUtils.dom.click(graph.$buttons.find('button[data-order="desc"]'));assert.doesNotHaveClass(graph.$('button[data-order="desc"]'),'active',"descending order button should not be active");assert.checkDatasets(graph,'data',{data:[4,3,1]});await testUtils.dom.click(graph.$buttons.find('button[data-mode="line"]'));assert.containsN(graph,'button[data-order]',2,"there should be two order buttons for sorting axis labels in line mode");assert.checkLegend(graph,'Count','measure should be by count');assert.doesNotHaveClass(graph.$('button[data-order="desc"]'),'active',"descending order should be applied");assert.checkDatasets(graph,'data',{data:[4,3,1]});await testUtils.dom.click(graph.$buttons.find('button[data-order="asc"]'));assert.hasClass(graph.$('button[data-order="asc"]'),'active',"ascending order button should be active");assert.checkDatasets(graph,'data',{data:[1,3,4]});await testUtils.dom.click(graph.$buttons.find('button[data-order="desc"]'));assert.hasClass(graph.$('button[data-order="desc"]'),'active',"descending order button should be active");assert.checkDatasets(graph,'data',{data:[4,3,1]});graph.destroy();});QUnit.test('graph view sort by measure for grouped data',async function(assert){assert.expect(9);this.data.product.records.push({id:38,display_name:"zphone",});this.data.foo.records[7].product_id=38;const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`<graph string="Partners">
                        <field name="product_id"/>
                        <field name="bar"/>
                </graph>`,});assert.checkLegend(graph,["true","false"],'measure should be by count');assert.containsN(graph,'button[data-order]',2,"there should be two order buttons for sorting axis labels");assert.checkDatasets(graph,'data',[{data:[3,0,0]},{data:[1,3,1]}]);await testUtils.dom.click(graph.$buttons.find('button[data-order="asc"]'));assert.hasClass(graph.$('button[data-order="asc"]'),'active',"ascending order should be applied by default");assert.checkDatasets(graph,'data',[{data:[1,3,1]},{data:[0,0,3]}]);await testUtils.dom.click(graph.$buttons.find('button[data-order="desc"]'));assert.hasClass(graph.$('button[data-order="desc"]'),'active',"ascending order button should be active");assert.checkDatasets(graph,'data',[{data:[1,3,1]},{data:[3,0,0]}]);await testUtils.dom.click(graph.$buttons.find('button[data-order="desc"]'));assert.doesNotHaveClass(graph.$('button[data-order="desc"]'),'active',"descending order button should not be active");assert.checkDatasets(graph,'data',[{data:[3,0,0]},{data:[1,3,1]}]);graph.destroy();});QUnit.test('graph view sort by measure for multiple grouped data',async function(assert){assert.expect(9);this.data.product.records.push({id:38,display_name:"zphone"});this.data.foo.records[7].product_id=38;const data=[{id:9,foo:48,bar:false,product_id:41,date:"2016-04-01"},{id:10,foo:49,bar:false,product_id:41,date:"2016-04-01"},{id:11,foo:50,bar:true,product_id:37,date:"2016-01-03"},{id:12,foo:50,bar:true,product_id:41,date:"2016-01-03"},];Object.assign(this.data.foo.records,data);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`<graph string="Partners">
                        <field name="product_id"/>
                        <field name="date"/>
                </graph>`,groupBy:['date','product_id']});assert.checkLegend(graph,["xpad","xphone","zphone"],'measure should be by count');assert.containsN(graph,'button[data-order]',2,"there should be two order buttons for sorting axis labels");assert.checkDatasets(graph,'data',[{data:[2,1,1,2]},{data:[0,1,0,0]},{data:[1,0,0,0]}]);await testUtils.dom.click(graph.$buttons.find('button[data-order="asc"]'));assert.hasClass(graph.$('button[data-order="asc"]'),'active',"ascending order should be applied by default");assert.checkDatasets(graph,'data',[{data:[1,1,2,2]},{data:[0,1,0,0]},{data:[0,0,0,1]}]);await testUtils.dom.click(graph.$buttons.find('button[data-order="desc"]'));assert.hasClass(graph.$('button[data-order="desc"]'),'active',"descending order button should be active");assert.checkDatasets(graph,'data',[{data:[1,0,0,0]},{data:[2,2,1,1]},{data:[0,0,1,0]}]);await testUtils.dom.click(graph.$buttons.find('button[data-order="desc"]'));assert.doesNotHaveClass(graph.$('button[data-order="desc"]'),'active',"descending order button should not be active");assert.checkDatasets(graph,'data',[{data:[2,1,1,2]},{data:[0,1,0,0]},{data:[1,0,0,0]}]);graph.destroy();});QUnit.test('empty graph view with sample data',async function(assert){assert.expect(8);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`
                <graph sample="1">
                    <field name="product_id"/>
                    <field name="date"/>
                </graph>`,domain:[['id','<',0]],viewOptions:{action:{help:'<p class="abc">click to add a foo</p>'}},});assert.hasClass(graph.el,'o_view_sample_data');assert.containsOnce(graph,'.o_view_nocontent');assert.containsOnce(graph,'.o_graph_canvas_container canvas');assert.hasClass(graph.$('.o_graph_canvas_container'),'o_sample_data_disabled');await graph.reload({domain:[]});assert.doesNotHaveClass(graph.el,'o_view_sample_data');assert.containsNone(graph,'.o_view_nocontent');assert.containsOnce(graph,'.o_graph_canvas_container canvas');assert.doesNotHaveClass(graph.$('.o_graph_canvas_container'),'o_sample_data_disabled');graph.destroy();});QUnit.test('non empty graph view with sample data',async function(assert){assert.expect(8);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`
                <graph sample="1">
                    <field name="product_id"/>
                    <field name="date"/>
                </graph>`,viewOptions:{action:{help:'<p class="abc">click to add a foo</p>'}},})
assert.doesNotHaveClass(graph.el,'o_view_sample_data');assert.containsNone(graph,'.o_view_nocontent');assert.containsOnce(graph,'.o_graph_canvas_container canvas');assert.doesNotHaveClass(graph.$('.o_graph_canvas_container'),'o_sample_data_disabled');await graph.reload({domain:[['id','<',0]]});assert.doesNotHaveClass(graph.el,'o_view_sample_data');assert.containsOnce(graph,'.o_graph_canvas_container canvas');assert.doesNotHaveClass(graph.$('.o_graph_canvas_container'),'o_sample_data_disabled');assert.containsNone(graph,'.o_view_nocontent');graph.destroy();});QUnit.module('GraphView: comparison mode',{beforeEach:async function(){this.data.foo.records[0].date='2016-12-15';this.data.foo.records[1].date='2016-12-17';this.data.foo.records[2].date='2016-11-22';this.data.foo.records[3].date='2016-11-03';this.data.foo.records[4].date='2016-12-20';this.data.foo.records[5].date='2016-12-19';this.data.foo.records[6].date='2016-12-15';this.data.foo.records[7].date=undefined;this.data.foo.records.push({id:9,foo:48,bar:false,product_id:41,color_id:7,date:"2016-12-01"});this.data.foo.records.push({id:10,foo:17,bar:true,product_id:41,color_id:7,date:"2016-12-01"});this.data.foo.records.push({id:11,foo:45,bar:true,product_id:37,color_id:14,date:"2016-12-01"});this.data.foo.records.push({id:12,foo:48,bar:false,product_id:37,color_id:7,date:"2016-12-10"});this.data.foo.records.push({id:13,foo:48,bar:false,product_id:undefined,color_id:14,date:"2016-11-30"});this.data.foo.records.push({id:14,foo:-50,bar:true,product_id:41,color_id:14,date:"2016-12-15"});this.data.foo.records.push({id:15,foo:53,bar:false,product_id:41,color_id:14,date:"2016-11-01"});this.data.foo.records.push({id:16,foo:53,bar:true,product_id:undefined,color_id:7,date:"2016-09-01"});this.data.foo.records.push({id:17,foo:48,bar:false,product_id:41,color_id:undefined,date:"2016-08-01"});this.data.foo.records.push({id:18,foo:-156,bar:false,product_id:37,color_id:undefined,date:"2016-07-15"});this.data.foo.records.push({id:19,foo:31,bar:false,product_id:41,color_id:14,date:"2016-12-15"});this.data.foo.records.push({id:20,foo:109,bar:true,product_id:41,color_id:7,date:"2015-06-01"});this.data.foo.records=sortBy(this.data.foo.records,'date');this.unpatchDate=patchDate(2016,11,20,1,0,0);const graph=await createView({View:GraphView,model:"foo",data:this.data,arch:`
                    <graph string="Partners" type="bar">
                        <field name="foo" type="measure"/>
                    </graph>
                `,archs:{'foo,false,search':`
                        <search>
                            <filter name="date" string="Date" context="{'group_by': 'date'}"/>
                            <filter name="date_filter" string="Date Filter" date="date"/>
                            <filter name="bar" string="Bar" context="{'group_by': 'bar'}"/>
                            <filter name="product_id" string="Product" context="{'group_by': 'product_id'}"/>
                            <filter name="color_id" string="Color" context="{'group_by': 'color_id'}"/>
                        </search>
                    `,},viewOptions:{additionalMeasures:['product_id'],},});this.graph=graph;var checkOnlyToCheck=true;var exhaustiveTest=false||checkOnlyToCheck;var self=this;async function*graphGenerator(combinations){var i=0;while(i<combinations.length){var combination=combinations[i];if(!checkOnlyToCheck||combination.toString()in self.combinationsToCheck){await self.setConfig(combination);}
if(exhaustiveTest){i++;}else{i+=Math.floor(1+Math.random()*20);}
yield combination;}}
this.combinationsToCheck={};this.testCombinations=async function(combinations,assert){for await(var combination of graphGenerator(combinations)){if(combination.toString()in self.combinationsToCheck){if(self.combinationsToCheck[combination].errorMessage){assert.strictEqual(graph.$('.o_nocontent_help p').eq(1).text().trim(),self.combinationsToCheck[combination].errorMessage);}else{assert.checkLabels(graph,self.combinationsToCheck[combination].labels);assert.checkLegend(graph,self.combinationsToCheck[combination].legend);assert.checkDatasets(graph,['label','data'],self.combinationsToCheck[combination].datasets);}}}};const GROUPBY_NAMES=['Date','Bar','Product','Color'];this.selectTimeRanges=async function(comparisonOptionId,basicDomainId){const facetEls=graph.el.querySelectorAll('.o_searchview_facet');const facetIndex=[...facetEls].findIndex(el=>!!el.querySelector('span.fa-filter'));if(facetIndex>-1){await cpHelpers.removeFacet(graph,facetIndex);}
const[yearId,otherId]=basicDomainId.split('__');await cpHelpers.toggleFilterMenu(graph);await cpHelpers.toggleMenuItem(graph,'Date Filter');await cpHelpers.toggleMenuItemOption(graph,'Date Filter',GENERATOR_INDEXES[yearId]);if(otherId){await cpHelpers.toggleMenuItemOption(graph,'Date Filter',GENERATOR_INDEXES[otherId]);}
const itemIndex=COMPARISON_OPTION_INDEXES[comparisonOptionId];await cpHelpers.toggleComparisonMenu(graph);await cpHelpers.toggleMenuItem(graph,itemIndex);};this.selectDateIntervalOption=async function(intervalOption){intervalOption=intervalOption||'month';const optionIndex=INTERVAL_OPTION_IDS.indexOf(intervalOption);await cpHelpers.toggleGroupByMenu(graph);let wasSelected=false;if(this.keepFirst){if(cpHelpers.isItemSelected(graph,2)){wasSelected=true;await cpHelpers.toggleMenuItem(graph,2);}}
await cpHelpers.toggleMenuItem(graph,0);if(!cpHelpers.isOptionSelected(graph,0,optionIndex)){await cpHelpers.toggleMenuItemOption(graph,0,optionIndex);}
for(let i=0;i<INTERVAL_OPTION_IDS.length;i++){const oId=INTERVAL_OPTION_IDS[i];if(oId!==intervalOption&&cpHelpers.isOptionSelected(graph,0,i)){await cpHelpers.toggleMenuItemOption(graph,0,i);}}
if(this.keepFirst){if(wasSelected&&!cpHelpers.isItemSelected(graph,2)){await cpHelpers.toggleMenuItem(graph,2);}}
await cpHelpers.toggleGroupByMenu(graph);};this.selectGroupBy=async function(groupByName){await cpHelpers.toggleGroupByMenu(graph);const index=GROUPBY_NAMES.indexOf(groupByName);if(!cpHelpers.isItemSelected(graph,index)){await cpHelpers.toggleMenuItem(graph,index);}
await cpHelpers.toggleGroupByMenu(graph);};this.setConfig=async function(combination){await this.selectTimeRanges(combination[0],combination[1]);if(combination.length===3){await self.selectDateIntervalOption(combination[2]);}};this.setMode=async function(mode){await testUtils.dom.click($(`.o_control_panel .o_graph_button[data-mode="${mode}"]`));};},afterEach:function(){this.unpatchDate();this.graph.destroy();},},function(){QUnit.test('comparison with one groupby equal to comparison date field',async function(assert){assert.expect(11);this.combinationsToCheck={'previous_period,this_year__this_month,day':{labels:[...Array(6).keys()].map(x=>[x]),legend:["December 2016","November 2016"],datasets:[{data:[110,48,26,53,63,4],label:"December 2016",},{data:[53,24,2,48],label:"November 2016",}],}};var combinations=COMBINATIONS_WITH_DATE;await this.testCombinations(combinations,assert);await this.setMode('line');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year__this_month,day']={labels:[...Array(6).keys()].map(x=>[x]),legend:["2016-12-01,2016-11-01","2016-12-10,2016-11-03","2016-12-15,2016-11-22","2016-12-17,2016-11-30","2016-12-19","2016-12-20"],datasets:[{data:[110,48,26,53,63,4],label:"December 2016",},{data:[53,24,2,48,0,0],label:"November 2016",}],};await this.setMode('pie');await this.testCombinations(combinations,assert);assert.isNotVisible(this.graph.$('button[data-order]:first'),"there should not be order button in comparison mode");assert.ok(true,"No combination causes a crash");});QUnit.test('comparison with no groupby',async function(assert){assert.expect(10);this.combinationsToCheck={'previous_period,this_year__this_month':{labels:[[]],legend:["December 2016","November 2016"],datasets:[{data:[304],label:"December 2016",},{data:[127],label:"November 2016",}],}};var combinations=COMBINATIONS;await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year__this_month']={labels:[[''],[],['']],legend:["December 2016","November 2016"],datasets:[{data:[undefined,304],label:"December 2016",},{data:[undefined,127],label:"November 2016",}],};await this.setMode('line');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year__this_month']={labels:[[]],legend:["Total"],datasets:[{data:[304],label:"December 2016",},{data:[127],label:"November 2016",}],};await this.setMode('pie');await this.testCombinations(combinations,assert);assert.ok(true,"No combination causes a crash");});QUnit.test('comparison with one groupby different from comparison date field',async function(assert){assert.expect(10);this.combinationsToCheck={'previous_period,this_year__this_month':{labels:[["xpad"],["xphone"],["Undefined"]],legend:["December 2016","November 2016"],datasets:[{data:[155,149,0],label:"December 2016",},{data:[53,26,48],label:"November 2016",}],}};var combinations=COMBINATIONS;await this.selectGroupBy('Product');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year__this_month']={labels:[["xpad"],["xphone"]],legend:["December 2016","November 2016"],datasets:[{data:[155,149],label:"December 2016",},{data:[53,26],label:"November 2016",}],};await this.setMode('line');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year__this_month']={labels:[["xpad"],["xphone"],["Undefined"]],legend:["xpad","xphone","Undefined"],datasets:[{data:[155,149,0],label:"December 2016",},{data:[53,26,48],label:"November 2016",}],};await this.setMode('pie');await this.testCombinations(combinations,assert);assert.ok(true,"No combination causes a crash");});QUnit.test('comparison with two groupby with first groupby equal to comparison date field',async function(assert){assert.expect(10);this.keepFirst=true;this.combinationsToCheck={'previous_period,this_year__this_month,day':{labels:[...Array(6).keys()].map(x=>[x]),legend:["December 2016/xpad","December 2016/xphone","November 2016/xpad","November 2016/xphone","November 2016/Undefined"],datasets:[{data:[65,0,23,0,63,4],label:"December 2016/xpad"},{data:[45,48,3,53,0,0],label:"December 2016/xphone"},{data:[53,0,0,0],label:"November 2016/xpad"},{data:[0,24,2,0],label:"November 2016/xphone"},{data:[0,0,0,48],label:"November 2016/Undefined"}]}};var combinations=COMBINATIONS_WITH_DATE;await this.selectGroupBy('Product');await this.testCombinations(combinations,assert);await this.setMode('line');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year__this_month,day']={labels:[[0,"xpad"],[0,"xphone"],[1,"xphone"],[2,"xphone"],[2,"xpad"],[3,"xphone"],[4,"xpad"],[5,"xpad"],[3,"Undefined"]],legend:["2016-12-01,2016-11-01/xpad","2016-12-01,2016-11-01/xphone","2016-12-10,2016-11-03/xphone","2016-12-15,2016-11-22/xphone","2016-12-15,2016-11-22/xpad","2016-12-17,2016-11-30/xphone","2016-12-19/xpad","2016-12-20/xpad","2016-12-17,2016-11-30/Undefine..."],datasets:[{"data":[65,45,48,3,23,53,63,4,0],"label":"December 2016"},{"data":[53,0,24,2,0,0,0,0,48],"label":"November 2016"}],};await this.setMode('pie');await this.testCombinations(combinations,assert);assert.ok(true,"No combination causes a crash");this.keepFirst=false;});QUnit.test('comparison with two groupby with second groupby equal to comparison date field',async function(assert){assert.expect(8);this.combinationsToCheck={'previous_period,this_year,quarter':{labels:[["xphone"],["xpad"],["Undefined"]],legend:["2016/Q3 2016","2016/Q4 2016","2015/Q2 2015"],datasets:[{data:[-156,48,53],label:"2016/Q3 2016",},{data:[175,208,48],label:"2016/Q4 2016",},{data:[0,109,0],label:"2015/Q2 2015",},]}};const combinations=COMBINATIONS_WITH_DATE;await this.selectGroupBy('Product');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year,quarter']={labels:[["xphone"],["xpad"]],legend:["2016/Q3 2016","2016/Q4 2016","2015/Q2 2015"],datasets:[{data:[-156,48],label:"2016/Q3 2016",},{data:[175,208],label:"2016/Q4 2016",},{data:[0,109],label:"2015/Q2 2015",},]};await this.setMode('line');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_period,this_year,quarter']={errorMessage:'Pie chart cannot mix positive and negative numbers. '+'Try to change your domain to only display positive results'};await this.setMode('pie');await this.testCombinations(combinations,assert);assert.ok(true,"No combination causes a crash");});QUnit.test('comparison with two groupby with no groupby equal to comparison date field',async function(assert){assert.expect(10);this.combinationsToCheck={'previous_year,this_year__last_month':{labels:[["xpad"],["xphone"],["Undefined"]],legend:["November 2016/false","November 2016/true"],datasets:[{data:[53,24,48],label:"November 2016/false",},{data:[0,2,0],label:"November 2016/true",}],}};var combinations=COMBINATIONS;await this.selectGroupBy('Product');await this.selectGroupBy('Bar');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_year,this_year__last_month']={labels:[["xpad"],["xphone"]],legend:["November 2016/false","November 2016/true"],datasets:[{data:[53,24],label:"November 2016/false",},{data:[0,2],label:"November 2016/true",}],};await this.setMode('line');await this.testCombinations(combinations,assert);this.combinationsToCheck['previous_year,this_year__last_month']={labels:[["xpad",false],["xphone",false],["xphone",true],["Undefined",false],["No data"]],legend:["xpad/false","xphone/false","xphone/true","Undefined/false","No data"],datasets:[{"data":[53,24,2,48],"label":"November 2016"},{"data":[undefined,undefined,undefined,undefined,1],"label":"November 2015"}],};await this.setMode('pie');await this.testCombinations(combinations,assert);assert.ok(true,"No combination causes a crash");});});});});;

/* /web/static/tests/views/list_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.list_tests',function(require){"use strict";var AbstractFieldOwl=require('web.AbstractFieldOwl');var AbstractStorageService=require('web.AbstractStorageService');var BasicModel=require('web.BasicModel');var core=require('web.core');const Domain=require('web.Domain')
var basicFields=require('web.basic_fields');var fieldRegistry=require('web.field_registry');var fieldRegistryOwl=require('web.field_registry_owl');var FormView=require('web.FormView');var ListRenderer=require('web.ListRenderer');var ListView=require('web.ListView');var mixins=require('web.mixins');var NotificationService=require('web.NotificationService');var RamStorage=require('web.RamStorage');var testUtils=require('web.test_utils');var widgetRegistry=require('web.widget_registry');var Widget=require('web.Widget');var _t=core._t;const cpHelpers=testUtils.controlPanel;var createActionManager=testUtils.createActionManager;var createView=testUtils.createView;QUnit.module('Views',{beforeEach:function(){this.data={foo:{fields:{foo:{string:"Foo",type:"char"},bar:{string:"Bar",type:"boolean"},date:{string:"Some Date",type:"date"},int_field:{string:"int_field",type:"integer",sortable:true,group_operator:"sum"},text:{string:"text field",type:"text"},qux:{string:"my float",type:"float"},m2o:{string:"M2O field",type:"many2one",relation:"bar"},o2m:{string:"O2M field",type:"one2many",relation:"bar"},m2m:{string:"M2M field",type:"many2many",relation:"bar"},amount:{string:"Monetary field",type:"monetary"},currency_id:{string:"Currency",type:"many2one",relation:"res_currency",default:1},datetime:{string:"Datetime Field",type:'datetime'},reference:{string:"Reference Field",type:'reference',selection:[["bar","Bar"],["res_currency","Currency"],["event","Event"]]},},records:[{id:1,bar:true,foo:"yop",int_field:10,qux:0.4,m2o:1,m2m:[1,2],amount:1200,currency_id:2,date:"2017-01-25",datetime:"2016-12-12 10:55:05",reference:'bar,1',},{id:2,bar:true,foo:"blip",int_field:9,qux:13,m2o:2,m2m:[1,2,3],amount:500,reference:'res_currency,1'},{id:3,bar:true,foo:"gnap",int_field:17,qux:-3,m2o:1,m2m:[],amount:300,reference:'res_currency,2'},{id:4,bar:false,foo:"blip",int_field:-4,qux:9,m2o:1,m2m:[1],amount:0},]},bar:{fields:{},records:[{id:1,display_name:"Value 1"},{id:2,display_name:"Value 2"},{id:3,display_name:"Value 3"},]},res_currency:{fields:{symbol:{string:"Symbol",type:"char"},position:{string:"Position",type:"selection",selection:[['after','A'],['before','B']],},},records:[{id:1,display_name:"USD",symbol:'$',position:'before'},{id:2,display_name:"EUR",symbol:'€',position:'after'},],},event:{fields:{id:{string:"ID",type:"integer"},name:{string:"name",type:"char"},},records:[{id:"2-20170808020000",name:"virtual"},]},"ir.translation":{fields:{lang_code:{type:"char"},src:{type:"char"},value:{type:"char"},res_id:{type:"integer"},name:{type:"char"},lang:{type:"char"},},records:[{id:99,res_id:1,value:'',lang_code:'en_US',lang:'en_US',name:'foo,foo'},{id:100,res_id:1,value:'',lang_code:'fr_BE',lang:'fr_BE',name:'foo,foo'}]},};}},function(){QUnit.module('ListView');QUnit.test('simple readonly list',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="int_field"/></tree>',});assert.doesNotHaveClass(list.$el,'o_cannot_create',"should not have className 'o_cannot_create'");assert.containsN(list,'th',3,"should have 3 columns");assert.strictEqual(list.$('td:contains(gnap)').length,1,"should contain gnap");assert.containsN(list,'tbody tr',4,"should have 4 rows");assert.containsOnce(list,'th.o_column_sortable',"should have 1 sortable column");assert.strictEqual(list.$('thead th:nth(2)').css('text-align'),'right',"header cells of integer fields should be right aligned");assert.strictEqual(list.$('tbody tr:first td:nth(2)').css('text-align'),'right',"integer cells should be right aligned");assert.isVisible(list.$buttons.find('.o_list_button_add'));assert.isNotVisible(list.$buttons.find('.o_list_button_save'));assert.isNotVisible(list.$buttons.find('.o_list_button_discard'));list.destroy();});QUnit.test('on_attach_callback is properly called',async function(assert){assert.expect(3);testUtils.mock.patch(ListRenderer,{on_attach_callback(){assert.step('on_attach_callback');this._super(...arguments);},});const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="display_name"/></tree>',});assert.verifySteps(['on_attach_callback']);await list.reload();assert.verifySteps([]);testUtils.mock.unpatch(ListRenderer);list.destroy();});QUnit.test('list with create="0"',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree create="0"><field name="foo"/></tree>',});assert.hasClass(list.$el,'o_cannot_create',"should have className 'o_cannot_create'");assert.containsNone(list.$buttons,'.o_list_button_add',"should not have the 'Create' button");list.destroy();});QUnit.test('list with delete="0"',async function(assert){assert.expect(3);const list=await createView({View:ListView,model:'foo',data:this.data,viewOptions:{hasActionMenus:true},arch:'<tree delete="0"><field name="foo"/></tree>',});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.ok(list.$('tbody td.o_list_record_selector').length,'should have at least one record');await testUtils.dom.click(list.$('tbody td.o_list_record_selector:first input'));assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus .o_dropdown_menu');list.destroy();});QUnit.test('editable list with edit="0"',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,viewOptions:{hasActionMenus:true},arch:'<tree editable="top" edit="0"><field name="foo"/></tree>',});assert.ok(list.$('tbody td.o_list_record_selector').length,'should have at least one record');await testUtils.dom.click(list.$('tr td:not(.o_list_record_selector)').first());assert.containsNone(list,'tbody tr.o_selected_row',"should not have editable row");list.destroy();});QUnit.test('export feature in list for users not in base.group_allow_export',async function(assert){assert.expect(5);const list=await createView({View:ListView,model:'foo',data:this.data,viewOptions:{hasActionMenus:true},arch:'<tree><field name="foo"/></tree>',session:{async user_has_group(group){if(group==='base.group_allow_export'){return false;}
return this._super(...arguments);},},});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.ok(list.$('tbody td.o_list_record_selector').length,'should have at least one record');assert.containsNone(list.el,'div.o_control_panel .o_cp_buttons .o_list_export_xlsx');await testUtils.dom.click(list.$('tbody td.o_list_record_selector:first input'));assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');await cpHelpers.toggleActionMenu(list);assert.deepEqual(cpHelpers.getMenuItemTexts(list),['Delete'],'action menu should not contain the Export button');list.destroy();});QUnit.test('list with export button',async function(assert){assert.expect(5);const list=await createView({View:ListView,model:'foo',data:this.data,viewOptions:{hasActionMenus:true},arch:'<tree><field name="foo"/></tree>',session:{async user_has_group(group){if(group==='base.group_allow_export'){return true;}
return this._super(...arguments);},},});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.ok(list.$('tbody td.o_list_record_selector').length,'should have at least one record');assert.containsOnce(list.el,'div.o_control_panel .o_cp_buttons .o_list_export_xlsx');await testUtils.dom.click(list.$('tbody td.o_list_record_selector:first input'));assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');await cpHelpers.toggleActionMenu(list);assert.deepEqual(cpHelpers.getMenuItemTexts(list),['Export','Delete'],'action menu should have Export button');list.destroy();});QUnit.test('export button in list view',async function(assert){assert.expect(5);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',session:{async user_has_group(group){if(group==='base.group_allow_export'){return true;}
return this._super(...arguments);},},});assert.containsN(list,'.o_data_row',4);assert.isVisible(list.$('.o_list_export_xlsx'));await testUtils.dom.click(list.$('tbody td.o_list_record_selector:first input'));assert.isNotVisible(list.$('.o_list_export_xlsx'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');await testUtils.dom.click(list.$('tbody td.o_list_record_selector:first input'));assert.isVisible(list.$('.o_list_export_xlsx'));list.destroy();});QUnit.test('export button in empty list view',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:"foo",data:this.data,arch:'<tree><field name="foo"/></tree>',domain:[["id","<",0]],session:{async user_has_group(group){if(group==='base.group_allow_export'){return true;}
return this._super(...arguments);},},});assert.isNotVisible(list.el.querySelector('.o_list_export_xlsx'));await list.reload({domain:[['id','>',0]]});assert.isVisible(list.el.querySelector('.o_list_export_xlsx'));list.destroy();});QUnit.test('list view with adjacent buttons',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <button name="a" type="object" icon="fa-car"/>
                    <field name="foo"/>
                    <button name="x" type="object" icon="fa-star"/>
                    <button name="y" type="object" icon="fa-refresh"/>
                    <button name="z" type="object" icon="fa-exclamation"/>
                </tree>`,});assert.containsN(list,'th',4,"adjacent buttons in the arch must be grouped in a single column");assert.containsN(list.$('.o_data_row:first'),'td.o_list_button',2);list.destroy();});QUnit.test('list view with adjacent buttons and invisible field',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <button name="a" type="object" icon="fa-car"/>
                    <field name="foo" invisible="1"/>
                    <button name="x" type="object" icon="fa-star"/>
                    <button name="y" type="object" icon="fa-refresh"/>
                    <button name="z" type="object" icon="fa-exclamation"/>
                </tree>`,});assert.containsN(list,'th',3,"adjacent buttons in the arch must be grouped in a single column");assert.containsN(list.$('.o_data_row:first'),'td.o_list_button',2);list.destroy();});QUnit.test('list view with adjacent buttons and invisible field (modifier)',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <button name="a" type="object" icon="fa-car"/>
                    <field name="foo" attrs="{'invisible': [['foo', '=', 'blip']]}"/>
                    <button name="x" type="object" icon="fa-star"/>
                    <button name="y" type="object" icon="fa-refresh"/>
                    <button name="z" type="object" icon="fa-exclamation"/>
                </tree>`,});assert.containsN(list,'th',4,"adjacent buttons in the arch must be grouped in a single column");assert.containsN(list.$('.o_data_row:first'),'td.o_list_button',2);list.destroy();});QUnit.test('list view with adjacent buttons and optional field',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <button name="a" type="object" icon="fa-car"/>
                    <field name="foo" optional="hide"/>
                    <button name="x" type="object" icon="fa-star"/>
                    <button name="y" type="object" icon="fa-refresh"/>
                    <button name="z" type="object" icon="fa-exclamation"/>
                </tree>`,});assert.containsN(list,'th',3,"adjacent buttons in the arch must be grouped in a single column");assert.containsN(list.$('.o_data_row:first'),'td.o_list_button',2);list.destroy();});QUnit.test('list view with adjacent buttons with invisible modifier',async function(assert){assert.expect(6);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <field name="foo"/>
                    <button name="x" type="object" icon="fa-star" attrs="{'invisible': [['foo', '=', 'blip']]}"/>
                    <button name="y" type="object" icon="fa-refresh" attrs="{'invisible': [['foo', '=', 'yop']]}"/>
                    <button name="z" type="object" icon="fa-exclamation" attrs="{'invisible': [['foo', '=', 'gnap']]}"/>
                </tree>`,});assert.containsN(list,'th',3,"adjacent buttons in the arch must be grouped in a single column");assert.containsOnce(list.$('.o_data_row:first'),'td.o_list_button');assert.strictEqual(list.$('.o_field_cell').text(),'yopblipgnapblip');assert.containsN(list,'td button i.fa-star:visible',2);assert.containsN(list,'td button i.fa-refresh:visible',3);assert.containsN(list,'td button i.fa-exclamation:visible',3);list.destroy();});QUnit.test('list view with icon buttons',async function(assert){assert.expect(5);this.data.foo.records.splice(1);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <button name="x" type="object" icon="fa-asterisk"/>
                    <button name="x" type="object" icon="fa-star" class="o_yeah"/>
                    <button name="x" type="object" icon="fa-refresh" string="Refresh" class="o_yeah"/>
                    <button name="x" type="object" icon="fa-exclamation" string="Danger" class="o_yeah btn-danger"/>
                </tree>`,});assert.containsOnce(list,'button.btn.btn-link i.fa.fa-asterisk');assert.containsOnce(list,'button.btn.btn-link.o_yeah i.fa.fa-star');assert.containsOnce(list,'button.btn.btn-link.o_yeah:contains("Refresh") i.fa.fa-refresh');assert.containsOnce(list,'button.btn.btn-danger.o_yeah:contains("Danger") i.fa.fa-exclamation');assert.containsNone(list,'button.btn.btn-link.btn-danger');list.destroy();});QUnit.test('list view: action button in controlPanel basic rendering',async function(assert){assert.expect(11);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <header>
                         <button name="x" type="object" class="plaf" string="plaf"/>
                         <button name="y" type="object" class="plouf" string="plouf" invisible="not context.get('bim')"/>
                    </header>
                    <field name="foo" />
                </tree>`,});let cpButtons=cpHelpers.getButtons(list);assert.containsNone(cpButtons[0],'button[name="x"]');assert.containsNone(cpButtons[0],'.o_list_selection_box');assert.containsNone(cpButtons[0],'button[name="y"]');await testUtils.dom.click(list.el.querySelector('.o_data_row .o_list_record_selector input[type="checkbox"]'));cpButtons=cpHelpers.getButtons(list);assert.containsOnce(cpButtons[0],'button[name="x"]');assert.hasClass(cpButtons[0].querySelector('button[name="x"]'),'btn btn-secondary');assert.containsOnce(cpButtons[0],'.o_list_selection_box');assert.strictEqual(cpButtons[0].querySelector('button[name="x"]').previousElementSibling,cpButtons[0].querySelector('.o_list_selection_box'));assert.containsNone(cpButtons[0],'button[name="y"]');await testUtils.dom.click(list.el.querySelector('.o_data_row .o_list_record_selector input[type="checkbox"]'));cpButtons=cpHelpers.getButtons(list);assert.containsNone(cpButtons[0],'button[name="x"]');assert.containsNone(cpButtons[0],'.o_list_selection_box');assert.containsNone(cpButtons[0],'button[name="y"]');list.destroy();});QUnit.test('list view: action button executes action on click: buttons are disabled and re-enabled',async function(assert){assert.expect(3);const executeActionDef=testUtils.makeTestPromise();const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <header>
                         <button name="x" type="object" class="plaf" string="plaf"/>
                    </header>
                    <field name="foo" />
                </tree>`,intercepts:{async execute_action(ev){const{on_success}=ev.data;await executeActionDef;on_success();}}});await testUtils.dom.click(list.el.querySelector('.o_data_row .o_list_record_selector input[type="checkbox"]'));const cpButtons=cpHelpers.getButtons(list);assert.ok(Array.from(cpButtons[0].querySelectorAll('button')).every(btn=>!btn.disabled));await testUtils.dom.click(cpButtons[0].querySelector('button[name="x"]'));assert.ok(Array.from(cpButtons[0].querySelectorAll('button')).every(btn=>btn.disabled));executeActionDef.resolve();await testUtils.nextTick();assert.ok(Array.from(cpButtons[0].querySelectorAll('button')).every(btn=>!btn.disabled));list.destroy();});QUnit.test('list view: action button executes action on click: correct parameters',async function(assert){assert.expect(4);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <header>
                         <button name="x" type="object" class="plaf" string="plaf" context="{'plouf': 'plif'}"/>
                    </header>
                    <field name="foo" />
                </tree>`,intercepts:{async execute_action(ev){const{action_data:{context,name,type},env,}=ev.data;assert.strictEqual(name,"x");assert.strictEqual(type,"object");assert.deepEqual(context,{active_domain:[],active_id:1,active_ids:[1],active_model:'foo',plouf:'plif',});assert.deepEqual(env,{context:{},model:'foo',resIDs:[1],});}}});await testUtils.dom.click(list.el.querySelector('.o_data_row .o_list_record_selector input[type="checkbox"]'));const cpButtons=cpHelpers.getButtons(list);await testUtils.dom.click(cpButtons[0].querySelector('button[name="x"]'));list.destroy();});QUnit.test('list view: action button executes action on click with domain selected: correct parameters',async function(assert){assert.expect(10);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree limit="1">
                    <header>
                         <button name="x" type="object" class="plaf" string="plaf"/>
                    </header>
                    <field name="foo" />
                </tree>`,intercepts:{async execute_action(ev){assert.step('execute_action');const{action_data:{context,name,type},env,}=ev.data;assert.strictEqual(name,"x");assert.strictEqual(type,"object");assert.deepEqual(context,{active_domain:[],active_id:1,active_ids:[1,2,3,4],active_model:'foo',});assert.deepEqual(env,{context:{},model:'foo',resIDs:[1,2,3,4],});}},mockRPC(route,args){if(args.method==='search'){assert.step('search');assert.strictEqual(args.model,'foo');assert.deepEqual(args.args,[[]]);}
return this._super.call(this,...arguments);}});await testUtils.dom.click(list.el.querySelector('.o_data_row .o_list_record_selector input[type="checkbox"]'));const cpButtons=cpHelpers.getButtons(list);await testUtils.dom.click(cpButtons[0].querySelector('.o_list_select_domain'));assert.verifySteps([]);await testUtils.dom.click(cpButtons[0].querySelector('button[name="x"]'));assert.verifySteps(['search','execute_action',]);list.destroy();});QUnit.test('column names (noLabel, label, string and default)',async function(assert){assert.expect(4);const FieldChar=fieldRegistry.get('char');fieldRegistry.add('nolabel_char',FieldChar.extend({noLabel:true,}));fieldRegistry.add('label_char',FieldChar.extend({label:"Some static label",}));const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <field name="display_name" widget="nolabel_char"/>
                    <field name="foo" widget="label_char"/>
                    <field name="int_field" string="My custom label"/>
                    <field name="text"/>
                </tree>`,});assert.strictEqual(list.$('thead th[data-name=display_name]').text(),'');assert.strictEqual(list.$('thead th[data-name=foo]').text(),'Some static label');assert.strictEqual(list.$('thead th[data-name=int_field]').text(),'My custom label');assert.strictEqual(list.$('thead th[data-name=text]').text(),'text field');list.destroy();});QUnit.test('simple editable rendering',async function(assert){assert.expect(15);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="bar"/></tree>',});assert.containsN(list,'th',3,"should have 2 th");assert.containsN(list,'th',3,"should have 3 th");assert.containsN(list,'.o_list_record_selector input:enabled',5);assert.containsOnce(list,'td:contains(yop)',"should contain yop");assert.isVisible(list.$buttons.find('.o_list_button_add'),"should have a visible Create button");assert.isNotVisible(list.$buttons.find('.o_list_button_save'),"should not have a visible save button");assert.isNotVisible(list.$buttons.find('.o_list_button_discard'),"should not have a visible discard button");await testUtils.dom.click(list.$('td:not(.o_list_record_selector)').first());assert.isNotVisible(list.$buttons.find('.o_list_button_add'),"should not have a visible Create button");assert.isVisible(list.$buttons.find('.o_list_button_save'),"should have a visible save button");assert.isVisible(list.$buttons.find('.o_list_button_discard'),"should have a visible discard button");assert.containsNone(list,'.o_list_record_selector input:enabled');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.isVisible(list.$buttons.find('.o_list_button_add'),"should have a visible Create button");assert.isNotVisible(list.$buttons.find('.o_list_button_save'),"should not have a visible save button");assert.isNotVisible(list.$buttons.find('.o_list_button_discard'),"should not have a visible discard button");assert.containsN(list,'.o_list_record_selector input:enabled',5);list.destroy();});QUnit.test('editable rendering with handle and no data',async function(assert){assert.expect(6);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="int_field" widget="handle"/>'+'<field name="currency_id"/>'+'<field name="m2o"/>'+'</tree>',});assert.containsN(list,'thead th',4,"there should be 4 th");assert.hasClass(list.$('thead th:eq(0)'),'o_list_record_selector');assert.hasClass(list.$('thead th:eq(1)'),'o_handle_cell');assert.strictEqual(list.$('thead th:eq(1)').text(),'',"the handle field shouldn't have a header description");assert.strictEqual(list.$('thead th:eq(2)').attr('style'),"width: 50%;");assert.strictEqual(list.$('thead th:eq(3)').attr('style'),"width: 50%;");list.destroy();});QUnit.test('invisible columns are not displayed',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="bar" invisible="1"/>'+'</tree>',});assert.containsN(list,'th',2,"should have 2 th");list.destroy();});QUnit.test('boolean field has no title',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="bar"/></tree>',});assert.equal(list.$('tbody tr:first td:eq(1)').attr('title'),"");list.destroy();});QUnit.test('field with nolabel has no title',async function(assert){assert.expect(1);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo" nolabel="1"/></tree>',});assert.strictEqual(list.$('thead tr:first th:eq(1)').text(),"");list.destroy();});QUnit.test('field titles are not escaped',async function(assert){assert.expect(2);this.data.foo.records[0].foo='<div>Hello</div>';const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',});assert.strictEqual(list.$('tbody tr:first .o_data_cell').text(),"<div>Hello</div>");assert.strictEqual(list.$('tbody tr:first .o_data_cell').attr('title'),"<div>Hello</div>");list.destroy();});QUnit.test('record-depending invisible lines are correctly aligned',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="bar" attrs="{\'invisible\': [(\'id\',\'=\', 1)]}"/>'+'<field name="int_field"/>'+'</tree>',});assert.containsN(list,'tbody tr:first td',4,"there should be 4 cells in the first row");assert.containsOnce(list,'tbody td.o_invisible_modifier',"there should be 1 invisible bar cell");assert.hasClass(list.$('tbody tr:first td:eq(2)'),'o_invisible_modifier',"the 3rd cell should be invisible");assert.containsN(list,'tbody tr:eq(0) td:visible',list.$('tbody tr:eq(1) td:visible').length,"there should be the same number of visible cells in different rows");list.destroy();});QUnit.test('do not perform extra RPC to read invisible many2one fields',async function(assert){assert.expect(3);this.data.foo.fields.m2o.default=2;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'<field name="m2o" invisible="1"/>'+'</tree>',mockRPC:function(route){assert.step(_.last(route.split('/')));return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.verifySteps(['search_read','onchange'],"no nameget should be done");list.destroy();});QUnit.test('editable list datetimepicker destroy widget (edition)',async function(assert){assert.expect(7);var eventPromise=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="date"/>'+'</tree>',});list.$el.on({'show.datetimepicker':async function(){assert.containsOnce(list,'.o_selected_row');assert.containsOnce($('body'),'.bootstrap-datetimepicker-widget');await testUtils.fields.triggerKeydown(list.$('.o_datepicker_input'),'escape');assert.containsOnce(list,'.o_selected_row');assert.containsNone($('body'),'.bootstrap-datetimepicker-widget');await testUtils.fields.triggerKeydown($(document.activeElement),'escape');assert.containsNone(list,'.o_selected_row');eventPromise.resolve();}});assert.containsN(list,'.o_data_row',4);assert.containsNone(list,'.o_selected_row');await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.dom.openDatepicker(list.$('.o_datepicker'));await eventPromise;list.destroy();});QUnit.test('editable list datetimepicker destroy widget (new line)',async function(assert){assert.expect(10);var eventPromise=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="date"/>'+'</tree>',});list.$el.on({'show.datetimepicker':async function(){assert.containsOnce($('body'),'.bootstrap-datetimepicker-widget');assert.containsN(list,'.o_data_row',5);assert.containsOnce(list,'.o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_datepicker_input'),'escape');assert.containsNone($('body'),'.bootstrap-datetimepicker-widget');assert.containsN(list,'.o_data_row',5);assert.containsOnce(list,'.o_selected_row');await testUtils.fields.triggerKeydown($(document.activeElement),'escape');assert.containsN(list,'.o_data_row',4);assert.containsNone(list,'.o_selected_row');eventPromise.resolve();}});assert.equal(list.$('.o_data_row').length,4,'There should be 4 rows');assert.equal(list.$('.o_selected_row').length,0,'No row should be in edit mode');await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));await testUtils.dom.openDatepicker(list.$('.o_datepicker'));await eventPromise;list.destroy();});QUnit.test('at least 4 rows are rendered, even if less data',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="bar"/></tree>',domain:[['bar','=',true]],});assert.containsN(list,'tbody tr',4,"should have 4 rows");list.destroy();});QUnit.test('discard a new record in editable="top" list with less than 4 records',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="bar"/></tree>',domain:[['bar','=',true]],});assert.containsN(list,'.o_data_row',3);assert.containsN(list,'tbody tr',4);await testUtils.dom.click(list.$('.o_list_button_add'));assert.containsN(list,'.o_data_row',4);assert.hasClass(list.$('tbody tr:first'),'o_selected_row');await testUtils.dom.click(list.$('.o_list_button_discard'));assert.containsN(list,'.o_data_row',3);assert.containsN(list,'tbody tr',4);assert.hasClass(list.$('tbody tr:first'),'o_data_row');list.destroy();});QUnit.test('basic grouped list rendering',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],});assert.strictEqual(list.$('th:contains(Foo)').length,1,"should contain Foo");assert.strictEqual(list.$('th:contains(Bar)').length,1,"should contain Bar");assert.containsN(list,'tr.o_group_header',2,"should have 2 .o_group_header");assert.containsN(list,'th.o_group_name',2,"should have 2 .o_group_name");list.destroy();});QUnit.test('basic grouped list rendering with widget="handle" col',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="int_field" widget="handle"/>'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>',groupBy:['bar'],});assert.strictEqual(list.$('th:contains(Foo)').length,1,"should contain Foo");assert.strictEqual(list.$('th:contains(Bar)').length,1,"should contain Bar");assert.containsN(list,'tr.o_group_header',2,"should have 2 .o_group_header");assert.containsN(list,'th.o_group_name',2,"should have 2 .o_group_name");assert.containsNone(list,'th:contains(int_field)',"Should not have int_field in grouped list");list.destroy();});QUnit.test('basic grouped list rendering 1 col without selector',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree ><field name="foo"/></tree>',groupBy:['bar'],hasSelectors:false,});assert.strictEqual(list.$('.o_group_header:first').children().length,1,"group header should have exactly 1 column");assert.strictEqual(list.$('.o_group_header:first th').attr('colspan'),"1","the header should span the whole table");list.destroy();});QUnit.test('basic grouped list rendering 1 col with selector',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree ><field name="foo"/></tree>',groupBy:['bar'],hasSelectors:true,});assert.strictEqual(list.$('.o_group_header:first').children().length,1,"group header should have exactly 1 column");assert.strictEqual(list.$('.o_group_header:first th').attr('colspan'),"2","the header should span the whole table");list.destroy();});QUnit.test('basic grouped list rendering 2 cols without selector',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree ><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],hasSelectors:false,});assert.strictEqual(list.$('.o_group_header:first').children().length,2,"group header should have exactly 2 column");assert.strictEqual(list.$('.o_group_header:first th').attr('colspan'),"1","the header should not span the whole table");list.destroy();});QUnit.test('basic grouped list rendering 3 cols without selector',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree ><field name="foo"/><field name="bar"/><field name="text"/></tree>',groupBy:['bar'],hasSelectors:false,});assert.strictEqual(list.$('.o_group_header:first').children().length,2,"group header should have exactly 2 columns");assert.strictEqual(list.$('.o_group_header:first th').attr('colspan'),"2","the first header should  span two columns");list.destroy();});QUnit.test('basic grouped list rendering 2 col with selector',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree ><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],hasSelectors:true,});assert.strictEqual(list.$('.o_group_header:first').children().length,2,"group header should have exactly 2 columns");assert.strictEqual(list.$('.o_group_header:first th').attr('colspan'),"2","the header should not span the whole table");list.destroy();});QUnit.test('basic grouped list rendering 3 cols with selector',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree ><field name="foo"/><field name="bar"/><field name="text"/></tree>',groupBy:['bar'],hasSelectors:true,});assert.strictEqual(list.$('.o_group_header:first').children().length,2,"group header should have exactly 2 columns");assert.strictEqual(list.$('.o_group_header:first th').attr('colspan'),"3","the header should not span the whole table");list.destroy();});QUnit.test('basic grouped list rendering 7 cols with aggregates and selector',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="datetime"/>'+'<field name="foo"/>'+'<field name="int_field" sum="Sum1"/>'+'<field name="bar"/>'+'<field name="qux" sum="Sum2"/>'+'<field name="date"/>'+'<field name="text"/>'+'</tree>',groupBy:['bar'],});assert.strictEqual(list.$('.o_group_header:first').children().length,5,"group header should have exactly 5 columns (one before first aggregate, one after last aggregate, and all in between");assert.strictEqual(list.$('.o_group_header:first th').attr('colspan'),"3","header name should span on the two first fields + selector (colspan 3)");assert.containsN(list,'.o_group_header:first td',3,"there should be 3 tds (aggregates + fields in between)");assert.strictEqual(list.$('.o_group_header:first th:last').attr('colspan'),"2","header last cell should span on the two last fields (to give space for the pager) (colspan 2)");list.destroy();});QUnit.test('ordered list, sort attribute in context',async function(assert){assert.expect(1);this.data.foo.fields.foo.sortable=true;this.data.foo.fields.date.sortable=true;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="date"/>'+'</tree>',});await testUtils.dom.click(list.$('th.o_column_sortable:contains("Foo")'));await testUtils.dom.click(list.$('th.o_column_sortable:contains("Foo")'));await testUtils.dom.click(list.$('th.o_column_sortable:contains("Date")'));var listContext=list.getOwnedQueryParams();assert.deepEqual(listContext,{orderedBy:[{name:'date',asc:true,},{name:'foo',asc:false,}]},'the list should have the right orderedBy in context');list.destroy();});QUnit.test('Loading a filter with a sort attribute',async function(assert){assert.expect(2);this.data.foo.fields.foo.sortable=true;this.data.foo.fields.date.sortable=true;var searchReads=0;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="date"/>'+'</tree>',mockRPC:function(route,args){if(route==='/web/dataset/search_read'){if(searchReads===0){assert.strictEqual(args.sort,'date ASC, foo DESC','The sort attribute of the filter should be used by the initial search_read');}else if(searchReads===1){assert.strictEqual(args.sort,'date DESC, foo ASC','The sort attribute of the filter should be used by the next search_read');}
searchReads+=1;}
return this._super.apply(this,arguments);},favoriteFilters:[{context:"{}",domain:"[]",id:7,is_default:true,name:"My favorite",sort:"[\"date asc\", \"foo desc\"]",user_id:[2,"Mitchell Admin"],},{context:"{}",domain:"[]",id:8,is_default:false,name:"My second favorite",sort:"[\"date desc\", \"foo asc\"]",user_id:[2,"Mitchell Admin"],}]});await cpHelpers.toggleFavoriteMenu(list);await cpHelpers.toggleMenuItem(list,"My second favorite");list.destroy();});QUnit.test('many2one field rendering',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="m2o"/></tree>',});assert.ok(list.$('td:contains(Value 1)').length,"should have the display_name of the many2one");list.destroy();});QUnit.test('grouped list view, with 1 open group',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="int_field"/></tree>',groupBy:['foo'],});await testUtils.dom.click(list.$('th.o_group_name:nth(1)'));await testUtils.nextTick();assert.containsN(list,'tbody:eq(1) tr',2,"open group should contain 2 records");assert.containsN(list,'tbody',3,"should contain 3 tbody");assert.containsOnce(list,'td:contains(9)',"should contain 9");assert.containsOnce(list,'td:contains(-4)',"should contain -4");assert.containsOnce(list,'td:contains(10)',"should contain 10");assert.containsOnce(list,'tr.o_group_header td:contains(10)',"but 10 should be in a header");list.destroy();});QUnit.test('opening records when clicking on record',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',});testUtils.mock.intercept(list,"open_record",function(){assert.ok("list view should trigger 'open_record' event");});await testUtils.dom.click(list.$('tr td:not(.o_list_record_selector)').first());list.update({groupBy:['foo']});await testUtils.nextTick();assert.containsN(list,'tr.o_group_header',3,"list should be grouped");await testUtils.dom.click(list.$('th.o_group_name').first());testUtils.dom.click(list.$('tr:not(.o_group_header) td:not(.o_list_record_selector)').first());list.destroy();});QUnit.test('editable list view: readonly fields cannot be edited',async function(assert){assert.expect(4);this.data.foo.fields.foo.readonly=true;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="bar"/>'+'<field name="int_field" readonly="1"/>'+'</tree>',});var $td=list.$('td:not(.o_list_record_selector)').first();var $second_td=list.$('td:not(.o_list_record_selector)').eq(1);var $third_td=list.$('td:not(.o_list_record_selector)').eq(2);await testUtils.dom.click($td);assert.hasClass($td.parent(),'o_selected_row',"row should be in edit mode");assert.hasClass($td,'o_readonly_modifier',"foo cell should be readonly in edit mode");assert.doesNotHaveClass($second_td,'o_readonly_modifier',"bar cell should be editable");assert.hasClass($third_td,'o_readonly_modifier',"int_field cell should be readonly in edit mode");list.destroy();});QUnit.test('editable list view: line with no active element',async function(assert){assert.expect(3);this.data.bar={fields:{titi:{string:"Char",type:"char"},grosminet:{string:"Bool",type:"boolean"},},records:[{id:1,titi:'cui',grosminet:true},{id:2,titi:'cuicui',grosminet:false},],};this.data.foo.records[0].o2m=[1,2];var form=await createView({View:FormView,model:'foo',data:this.data,res_id:1,viewOptions:{mode:'edit'},arch:'<form>'+'<field name="o2m">'+'<tree editable="top">'+'<field name="titi" readonly="1"/>'+'<field name="grosminet" widget="boolean_toggle"/>'+'</tree>'+'</field>'+'</form>',mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{o2m:[[1,1,{grosminet:false}],[4,2,false]],});}
return this._super.apply(this,arguments);},});var $td=form.$('.o_data_cell').first();var $td2=form.$('.o_data_cell').eq(1);assert.hasClass($td,'o_readonly_modifier');assert.hasClass($td2,'o_boolean_toggle_cell');await testUtils.dom.click($td);await testUtils.dom.click($td2.find('.o_boolean_toggle input'));await testUtils.nextTick();await testUtils.form.clickSave(form);await testUtils.nextTick();form.destroy();});QUnit.test('editable list view: click on last element after creation empty new line',async function(assert){assert.expect(1);this.data.bar={fields:{titi:{string:"Char",type:"char",required:true},int_field:{string:"int_field",type:"integer",sortable:true,required:true}},records:[{id:1,titi:'cui',int_field:2},{id:2,titi:'cuicui',int_field:4},],};this.data.foo.records[0].o2m=[1,2];var form=await createView({View:FormView,model:'foo',data:this.data,res_id:1,viewOptions:{mode:'edit'},arch:'<form>'+'<field name="o2m">'+'<tree editable="top">'+'<field name="int_field" widget="handle"/>'+'<field name="titi"/>'+'</tree>'+'</field>'+'</form>',});await testUtils.dom.click(form.$('.o_field_x2many_list_row_add > a'));await testUtils.dom.click(form.$('.o_data_row:last() > td.o_list_char'));assert.containsN(form,'.o_data_row',2,"list should have exactly 2 rows");form.destroy();});QUnit.test('edit field in editable field without editing the row',async function(assert){assert.expect(13);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree editable="top">
                    <field name="foo"/>
                    <field name="bar" widget="boolean_toggle"/>
                </tree>`,mockRPC(route,args){if(args.method==='write'){assert.step('write: '+args.args[1].bar);}
return this._super(...arguments);},});assert.ok(list.$('.o_data_row:first .o_boolean_toggle input')[0].checked);assert.containsNone(list,'.o_selected_row');await testUtils.dom.click(list.$('.o_data_row:first .o_boolean_toggle'));assert.notOk(list.$('.o_data_row:first .o_boolean_toggle input')[0].checked);assert.containsNone(list,'.o_selected_row');assert.verifySteps(['write: false']);assert.containsNone(list,'.o_selected_row');await testUtils.dom.click(list.$('.o_data_row .o_data_cell:first'));assert.containsOnce(list,'.o_selected_row');await testUtils.dom.click(list.$('.o_selected_row .o_boolean_toggle'));assert.containsOnce(list,'.o_selected_row');assert.verifySteps([]);await testUtils.dom.click(list.$('.o_list_button_save'));assert.containsNone(list,'.o_selected_row');assert.verifySteps(['write: true']);list.destroy();});QUnit.test('basic operations for editable list renderer',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="bar"/></tree>',});var $td=list.$('td:not(.o_list_record_selector)').first();assert.doesNotHaveClass($td.parent(),'o_selected_row',"td should not be in edit mode");await testUtils.dom.click($td);assert.hasClass($td.parent(),'o_selected_row',"td should be in edit mode");list.destroy();});QUnit.test('editable list: add a line and discard',async function(assert){assert.expect(11);testUtils.mock.patch(basicFields.FieldChar,{destroy:function(){assert.step('destroy');this._super.apply(this,arguments);},});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="bar"/></tree>',domain:[['foo','=','yop']],});assert.containsN(list,'tbody tr',4,"list should contain 4 rows");assert.containsOnce(list,'.o_data_row',"list should contain one record (and thus 3 empty rows)");assert.strictEqual(cpHelpers.getPagerValue(list),'1-1',"pager should be correct");await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsN(list,'tbody tr',4,"list should still contain 4 rows");assert.containsN(list,'.o_data_row',2,"list should contain two record (and thus 2 empty rows)");assert.strictEqual(cpHelpers.getPagerValue(list),'1-2',"pager should be correct");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.containsN(list,'tbody tr',4,"list should still contain 4 rows");assert.containsOnce(list,'.o_data_row',"list should contain one record (and thus 3 empty rows)");assert.strictEqual(cpHelpers.getPagerValue(list),'1-1',"pager should be correct");assert.verifySteps(['destroy'],"should have destroyed the widget of the removed line");testUtils.mock.unpatch(basicFields.FieldChar);list.destroy();});QUnit.test('field changes are triggered correctly',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="bar"/></tree>',});var $td=list.$('td:not(.o_list_record_selector)').first();var n=0;testUtils.mock.intercept(list,"field_changed",function(){n+=1;});await testUtils.dom.click($td);await testUtils.fields.editInput($td.find('input'),'abc');assert.strictEqual(n,1,"field_changed should have been triggered");await testUtils.dom.click(list.$('td:not(.o_list_record_selector)').eq(2));assert.strictEqual(n,1,"field_changed should not have been triggered");list.destroy();});QUnit.test('editable list view: basic char field edition',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="bar"/></tree>',});var $td=list.$('td:not(.o_list_record_selector)').first();await testUtils.dom.click($td);await testUtils.fields.editInput($td.find('input'),'abc');assert.strictEqual($td.find('input').val(),'abc',"char field has been edited correctly");var $next_row_td=list.$('tbody tr:eq(1) td:not(.o_list_record_selector)').first();await testUtils.dom.click($next_row_td);assert.strictEqual(list.$('td:not(.o_list_record_selector)').first().text(),'abc','changes should be saved correctly');assert.doesNotHaveClass(list.$('tbody tr').first(),'o_selected_row','saved row should be in readonly mode');assert.strictEqual(this.data.foo.records[0].foo,'abc',"the edition should have been properly saved");list.destroy();});QUnit.test('editable list view: save data when list sorting in edit mode',async function(assert){assert.expect(3);this.data.foo.fields.foo.sortable=true;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args,[[1],{foo:'xyz'}],"should correctly save the edited record");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.fields.editInput(list.$('input[name="foo"]'),'xyz');await testUtils.dom.click(list.$('.o_column_sortable'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row',"first row should still be in edition");await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.doesNotHaveClass(list.$buttons,'o-editing',"list buttons should be back to their readonly mode");list.destroy();});QUnit.test('editable list view: check that controlpanel buttons are updating when groupby applied',async function(assert){assert.expect(4);this.data.foo.fields.foo={string:"Foo",type:"char",required:true};var actionManager=await createActionManager({actions:[{id:11,name:'Partners Action 11',res_model:'foo',type:'ir.actions.act_window',views:[[3,'list']],search_view_id:[9,'search'],}],archs:{'foo,3,list':'<tree editable="top"><field name="display_name"/><field name="foo"/></tree>','foo,9,search':'<search>'+'<filter string="candle" name="itsName" context="{\'group_by\': \'foo\'}"/>'+'</search>',},data:this.data,});await actionManager.doAction(11);await testUtils.dom.click(actionManager.$('.o_list_button_add'));assert.isNotVisible(actionManager.$('.o_list_button_add'),"create button should be invisible");assert.isVisible(actionManager.$('.o_list_button_save'),"save button should be visible");await testUtils.dom.click(actionManager.$('.o_dropdown_toggler_btn:contains("Group By")'));await testUtils.dom.click(actionManager.$('.o_group_by_menu .o_menu_item a:contains("candle")'));assert.isNotVisible(actionManager.$('.o_list_button_add'),"create button should be invisible");assert.isNotVisible(actionManager.$('.o_list_button_save'),"save button should be invisible after applying groupby");actionManager.destroy();});QUnit.test('list view not groupable',async function(assert){assert.expect(2);const searchMenuTypesOriginal=ListView.prototype.searchMenuTypes;ListView.prototype.searchMenuTypes=['filter','favorite'];const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree editable="top">
                    <field name="display_name"/>
                    <field name="foo"/>
                </tree>
            `,archs:{'foo,false,search':`
                    <search>
                        <filter context="{'group_by': 'foo'}" name="foo"/>
                    </search>
                `,},mockRPC:function(route,args){if(args.method==='read_group'){throw new Error("Should not do a read_group RPC");}
return this._super.apply(this,arguments);},context:{search_default_foo:1,},});assert.containsNone(list,'.o_control_panel div.o_search_options div.o_group_by_menu',"there should not be groupby menu");assert.deepEqual(cpHelpers.getFacetTexts(list),[]);list.destroy();ListView.prototype.searchMenuTypes=searchMenuTypesOriginal;});QUnit.test('selection changes are triggered correctly',async function(assert){assert.expect(8);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="bar"/></tree>',});var $tbody_selector=list.$('tbody .o_list_record_selector input').first();var $thead_selector=list.$('thead .o_list_record_selector input');var n=0;testUtils.mock.intercept(list,"selection_changed",function(){n+=1;});testUtils.dom.click($tbody_selector);assert.strictEqual(n,1,"selection_changed should have been triggered");assert.ok($tbody_selector.is(':checked'),"selection checkbox should be checked");testUtils.dom.click($tbody_selector);assert.strictEqual(n,2,"selection_changed should have been triggered");assert.ok(!$tbody_selector.is(':checked'),"selection checkbox shouldn't be checked");testUtils.dom.click($thead_selector);assert.strictEqual(n,3,"selection_changed should have been triggered");assert.containsN(list,'tbody .o_list_record_selector input:checked',list.$('tbody tr').length,"all selection checkboxes should be checked");testUtils.dom.click($thead_selector);assert.strictEqual(n,4,"selection_changed should have been triggered");assert.containsNone(list,'tbody .o_list_record_selector input:checked',"no selection checkbox should be checked");list.destroy();});QUnit.test('Row selection checkbox can be toggled by clicking on the cell',async function(assert){assert.expect(9);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="bar"/></tree>',});testUtils.mock.intercept(list,"selection_changed",function(ev){assert.step(ev.data.selection.length.toString());});testUtils.dom.click(list.$('tbody .o_list_record_selector:first'));assert.containsOnce(list,'tbody .o_list_record_selector input:checked');testUtils.dom.click(list.$('tbody .o_list_record_selector:first'));assert.containsNone(list,'.o_list_record_selector input:checked');testUtils.dom.click(list.$('thead .o_list_record_selector'));assert.containsN(list,'.o_list_record_selector input:checked',5);testUtils.dom.click(list.$('thead .o_list_record_selector'));assert.containsNone(list,'.o_list_record_selector input:checked');assert.verifySteps(['1','0','4','0']);list.destroy();});QUnit.test('head selector is toggled by the other selectors',async function(assert){assert.expect(6);const list=await createView({arch:'<tree><field name="foo"/><field name="bar"/></tree>',data:this.data,groupBy:['bar'],model:'foo',View:ListView,});assert.ok(!list.$('thead .o_list_record_selector input')[0].checked,"Head selector should be unchecked");await testUtils.dom.click(list.$('.o_group_header:first()'));await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsN(list,'tbody .o_list_record_selector input:checked',3,"All visible checkboxes should be checked");await testUtils.dom.click(list.$('.o_group_header:last()'));assert.ok(!list.$('thead .o_list_record_selector input')[0].checked,"Head selector should be unchecked");await testUtils.dom.click(list.$('tbody .o_list_record_selector input:last()'));assert.ok(list.$('thead .o_list_record_selector input')[0].checked,"Head selector should be checked");await testUtils.dom.click(list.$('tbody .o_list_record_selector:first() input'));assert.ok(!list.$('thead .o_list_record_selector input')[0].checked,"Head selector should be unchecked");await testUtils.dom.click(list.$('.o_group_header:first()'));assert.ok(list.$('thead .o_list_record_selector input')[0].checked,"Head selector should be checked");list.destroy();});QUnit.test('selection box is properly displayed (single page)',async function(assert){assert.expect(11);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="bar"/></tree>',});assert.containsN(list,'.o_data_row',4);assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box');await testUtils.dom.click(list.$('.o_data_row:first .o_list_record_selector input'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.containsNone(list.$('.o_list_selection_box'),'.o_list_select_domain');assert.strictEqual(list.$('.o_list_selection_box').text().trim(),'1 selected');await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.containsNone(list.$('.o_list_selection_box'),'.o_list_select_domain');assert.strictEqual(list.$('.o_list_selection_box').text().trim(),'4 selected');await testUtils.dom.click(list.$('.o_data_row:nth(1) .o_list_record_selector input'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.containsNone(list.$('.o_list_selection_box'),'.o_list_select_domain');assert.strictEqual(list.$('.o_list_selection_box').text().trim(),'3 selected');list.destroy();});QUnit.test('selection box is properly displayed (multi pages)',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="3"><field name="foo"/><field name="bar"/></tree>',});assert.containsN(list,'.o_data_row',3);assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box');await testUtils.dom.click(list.$('.o_data_row:first .o_list_record_selector input'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.containsNone(list.$('.o_list_selection_box'),'.o_list_select_domain');assert.strictEqual(list.$('.o_list_selection_box').text().trim(),'1 selected');await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.containsOnce(list.$('.o_list_selection_box'),'.o_list_select_domain');assert.strictEqual(list.$('.o_list_selection_box').text().replace(/\s+/g,' ').trim(),'3 selected Select all 4');await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.strictEqual(list.$('.o_list_selection_box').text().trim(),'All 4 selected');list.destroy();});QUnit.test('selection box is removed after multi record edition',async function(assert){assert.expect(6);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1"><field name="foo"/><field name="bar"/></tree>',});assert.containsN(list,'.o_data_row',4,"there should be 4 records");assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box',"list selection box should not be displayed");await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box',"list selection box should be displayed");assert.containsN(list,'.o_data_row .o_list_record_selector input:checked',4,"all 4 records should be selected");await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),'legion');await testUtils.dom.click($('.modal-dialog button.btn-primary'));assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box',"list selection box should not be displayed");assert.containsNone(list,'.o_data_row .o_list_record_selector input:checked',"no records should be selected");list.destroy();});QUnit.test('selection is reset on reload',async function(assert){assert.expect(8);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="int_field" sum="Sum"/>'+'</tree>',});assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.strictEqual(list.$('tfoot td:nth(2)').text(),'32',"total should be 32 (no record selected)");var $firstRowSelector=list.$('tbody .o_list_record_selector input').first();testUtils.dom.click($firstRowSelector);assert.ok($firstRowSelector.is(':checked'),"first row should be selected");assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.strictEqual(list.$('tfoot td:nth(2)').text(),'10',"total should be 10 (first record selected)");await list.reload();$firstRowSelector=list.$('tbody .o_list_record_selector input').first();assert.notOk($firstRowSelector.is(':checked'),"first row should no longer be selected");assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box');assert.strictEqual(list.$('tfoot td:nth(2)').text(),'32',"total should be 32 (no more record selected)");list.destroy();});QUnit.test('selection is kept on render without reload',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'foo',data:this.data,groupBy:['foo'],viewOptions:{hasActionMenus:true},arch:'<tree>'+'<field name="foo"/>'+'<field name="int_field" sum="Sum"/>'+'</tree>',});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box');await testUtils.dom.click(list.$('.o_group_header:contains("blip (2)")'));await testUtils.dom.click(list.$('.o_data_row:first input'));assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');await testUtils.dom.click(list.$('.o_group_header:contains("yop (1)")'));assert.containsOnce(list,'.o_data_row input:checked',"opening a grouping does not uncheck others");assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsOnce(list.$('.o_cp_buttons'),'.o_list_selection_box');await testUtils.dom.click(list.$('.o_group_header:contains("blip (2)")'));await testUtils.dom.click(list.$('.o_group_header:contains("blip (2)")'));assert.containsNone(list,'.o_data_row input:checked',"opening and closing a grouping uncheck its elements");assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsNone(list.$('.o_cp_buttons'),'.o_list_selection_box');list.destroy();});QUnit.test('aggregates are computed correctly',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field" sum="Sum"/></tree>',});var $tbody_selectors=list.$('tbody .o_list_record_selector input');var $thead_selector=list.$('thead .o_list_record_selector input');assert.strictEqual(list.$('tfoot td:nth(2)').text(),"32","total should be 32");testUtils.dom.click($tbody_selectors.first());testUtils.dom.click($tbody_selectors.last());assert.strictEqual(list.$('tfoot td:nth(2)').text(),"6","total should be 6 as first and last records are selected");testUtils.dom.click($thead_selector);assert.strictEqual(list.$('tfoot td:nth(2)').text(),"32","total should be 32 as all records are selected");await list.update({domain:['&',['bar','=',false],['int_field','>',0]]});assert.strictEqual(list.$('tfoot td:nth(2)').text(),"0","total should have been recomputed to 0");list.destroy();});QUnit.test('aggregates are computed correctly in grouped lists',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,groupBy:['m2o'],arch:'<tree editable="bottom"><field name="foo" /><field name="int_field" sum="Sum"/></tree>',});var $groupHeader1=list.$('.o_group_header').filter(function(index,el){return $(el).data('group').res_id===1;});var $groupHeader2=list.$('.o_group_header').filter(function(index,el){return $(el).data('group').res_id===2;});assert.strictEqual($groupHeader1.find('td:last()').text(),"23","first group total should be 23");assert.strictEqual($groupHeader2.find('td:last()').text(),"9","second group total should be 9");assert.strictEqual(list.$('tfoot td:last()').text(),"32","total should be 32");await testUtils.dom.click($groupHeader1);await testUtils.dom.click(list.$('tbody .o_list_record_selector input').first());assert.strictEqual(list.$('tfoot td:last()').text(),"10","total should be 10 as first record of first group is selected");list.destroy();});QUnit.test('aggregates are updated when a line is edited',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="int_field" sum="Sum"/></tree>',});assert.strictEqual(list.$('td[title="Sum"]').text(),"32","current total should be 32");await testUtils.dom.click(list.$('tr.o_data_row td.o_data_cell').first());await testUtils.fields.editInput(list.$('td.o_data_cell input'),"15");assert.strictEqual(list.$('td[title="Sum"]').text(),"37","current total should now be 37");list.destroy();});QUnit.test('aggregates are formatted according to field widget',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="qux" widget="float_time" sum="Sum"/>'+'</tree>',});assert.strictEqual(list.$('tfoot td:nth(2)').text(),'19:24',"total should be formatted as a float_time");list.destroy();});QUnit.test('aggregates digits can be set with digits field attribute',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="amount" widget="monetary" sum="Sum" digits="[69,3]"/>'+'</tree>',});assert.strictEqual(list.$('.o_data_row td:nth(1)').text(),'1200.00',"field should still be formatted based on currency");assert.strictEqual(list.$('tfoot td:nth(1)').text(),'2000.000',"aggregates monetary use digits attribute if available");list.destroy();});QUnit.test('groups can be sorted on aggregates',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'foo',data:this.data,groupBy:['foo'],arch:'<tree editable="bottom"><field name="foo" /><field name="int_field" sum="Sum"/></tree>',mockRPC:function(route,args){if(args.method==='web_read_group'){assert.step(args.kwargs.orderby||'default order');}
return this._super.apply(this,arguments);},});assert.strictEqual(list.$('tbody .o_list_number').text(),'10517',"initial order should be 10, 5, 17");assert.strictEqual(list.$('tfoot td:last()').text(),'32',"total should be 32");await testUtils.dom.click(list.$('.o_column_sortable'));assert.strictEqual(list.$('tfoot td:last()').text(),'32',"total should still be 32");assert.strictEqual(list.$('tbody .o_list_number').text(),'51017',"order should be 5, 10, 17");await testUtils.dom.click(list.$('.o_column_sortable'));assert.strictEqual(list.$('tbody .o_list_number').text(),'17105',"initial order should be 17, 10, 5");assert.strictEqual(list.$('tfoot td:last()').text(),'32',"total should still be 32");assert.verifySteps(['default order','int_field ASC','int_field DESC']);list.destroy();});QUnit.test('groups cannot be sorted on non-aggregable fields',async function(assert){assert.expect(6);this.data.foo.fields.sort_field={string:"sortable_field",type:"sting",sortable:true,default:"value"};_.each(this.data.records,function(elem){elem.sort_field="value"+elem.id;});this.data.foo.fields.foo.sortable=true;var list=await createView({View:ListView,model:'foo',data:this.data,groupBy:['foo'],arch:'<tree editable="bottom"><field name="foo" /><field name="int_field"/><field name="sort_field"/></tree>',mockRPC:function(route,args){if(args.method==='web_read_group'){assert.step(args.kwargs.orderby||'default order');}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_column_sortable:eq(2)'));await testUtils.dom.click(list.$('.o_column_sortable:eq(1)'));await testUtils.dom.click(list.$('.o_column_sortable:eq(2)'));await testUtils.dom.click(list.$('.o_column_sortable:eq(0)'));assert.verifySteps(['default order','default order','int_field ASC','int_field ASC','foo ASC, int_field ASC']);list.destroy();});QUnit.test('properly apply onchange in simple case',async function(assert){assert.expect(2);this.data.foo.onchanges={foo:function(obj){obj.int_field=obj.foo.length+1000;},};var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="int_field"/></tree>',});var $foo_td=list.$('td:not(.o_list_record_selector)').first();var $int_field_td=list.$('td:not(.o_list_record_selector)').eq(1);assert.strictEqual($int_field_td.text(),'10',"should contain initial value");await testUtils.dom.click($foo_td);await testUtils.fields.editInput($foo_td.find('input'),'tralala');assert.strictEqual($int_field_td.find('input').val(),"1007","should contain input with onchange applied");list.destroy();});QUnit.test('column width should not change when switching mode',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'<field name="int_field" readonly="1"/>'+'<field name="m2o"/>'+'<field name="m2m" widget="many2many_tags"/>'+'</tree>',});var startWidths=_.pluck(list.$('thead th'),'offsetWidth');var startWidth=list.$('table').addBack('table').width();await testUtils.dom.click(list.$('td:not(.o_list_record_selector)').first());var editionWidths=_.pluck(list.$('thead th'),'offsetWidth');var editionWidth=list.$('table').addBack('table').width();await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));var readonlyWidths=_.pluck(list.$('thead th'),'offsetWidth');var readonlyWidth=list.$('table').addBack('table').width();assert.strictEqual(editionWidth,startWidth,"table should have kept the same width when switching from readonly to edit mode");assert.deepEqual(editionWidths,startWidths,"width of columns should remain unchanged when switching from readonly to edit mode");assert.strictEqual(readonlyWidth,editionWidth,"table should have kept the same width when switching from edit to readonly mode");assert.deepEqual(readonlyWidths,editionWidths,"width of columns should remain unchanged when switching from edit to readonly mode");list.destroy();});QUnit.test('column widths should depend on the content when there is data',async function(assert){assert.expect(1);this.data.foo.records[0].foo='Some very very long value for a char field';var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="bar"/>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'<field name="date"/>'+'<field name="datetime"/>'+'</tree>',viewOptions:{limit:2,},});var widthPage1=list.$(`th[data-name=foo]`)[0].offsetWidth;await cpHelpers.pagerNext(list);var widthPage2=list.$(`th[data-name=foo]`)[0].offsetWidth;assert.ok(widthPage1>widthPage2,'column widths should be computed dynamically according to the content');list.destroy();});QUnit.test('width of some of the fields should be hardcoded if no data',async function(assert){const assertions=[{field:'bar',expected:70,type:'Boolean'},{field:'int_field',expected:74,type:'Integer'},{field:'qux',expected:92,type:'Float'},{field:'date',expected:92,type:'Date'},{field:'datetime',expected:146,type:'Datetime'},{field:'amount',expected:104,type:'Monetary'},];assert.expect(9);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="bar"/>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'<field name="date"/>'+'<field name="datetime"/>'+'<field name="amount"/>'+'<field name="currency_id" width="25px"/>'+'</tree>',});assert.containsNone(list,'.o_resize',"There shouldn't be any resize handle if no data");assertions.forEach(a=>{assert.strictEqual(list.$(`th[data-name="${a.field}"]`)[0].offsetWidth,a.expected,`Field ${a.type} should have a fixed width of ${a.expected} pixels`);});assert.strictEqual(list.$('th[data-name="foo"]')[0].style.width,'100%',"Char field should occupy the remaining space");assert.strictEqual(list.$('th[data-name="currency_id"]')[0].offsetWidth,25,'Currency field should have a fixed width of 25px (see arch)');list.destroy();});QUnit.test('width of some fields should be hardcoded if no data, and list initially invisible',async function(assert){const assertions=[{field:'bar',expected:70,type:'Boolean'},{field:'int_field',expected:74,type:'Integer'},{field:'qux',expected:92,type:'Float'},{field:'date',expected:92,type:'Date'},{field:'datetime',expected:146,type:'Datetime'},{field:'amount',expected:104,type:'Monetary'},];assert.expect(12);this.data.foo.fields.foo_o2m={string:"Foo O2M",type:"one2many",relation:"foo"};const form=await createView({View:FormView,model:'foo',data:this.data,res_id:1,viewOptions:{mode:'edit'},arch:`<form>
                    <sheet>
                        <notebook>
                            <page string="Page1"></page>
                            <page string="Page2">
                                <field name="foo_o2m">
                                    <tree editable="bottom">
                                        <field name="bar"/>
                                        <field name="foo"/>
                                        <field name="int_field"/>
                                        <field name="qux"/>
                                        <field name="date"/>
                                        <field name="datetime"/>
                                        <field name="amount"/>
                                        <field name="currency_id" width="25px"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                </form>`,});assert.isNotVisible(form.$('.o_field_one2many'));await testUtils.dom.click(form.$('.nav-item:last-child .nav-link'));assert.isVisible(form.$('.o_field_one2many'));assert.containsNone(form,'.o_field_one2many .o_resize',"There shouldn't be any resize handle if no data");assertions.forEach(a=>{assert.strictEqual(form.$(`.o_field_one2many th[data-name="${a.field}"]`)[0].offsetWidth,a.expected,`Field ${a.type} should have a fixed width of ${a.expected} pixels`);});assert.strictEqual(form.$('.o_field_one2many th[data-name="foo"]')[0].style.width,'100%',"Char field should occupy the remaining space");assert.strictEqual(form.$('th[data-name="currency_id"]')[0].offsetWidth,25,'Currency field should have a fixed width of 25px (see arch)');assert.strictEqual(form.el.querySelector('.o_list_record_remove_header').style.width,'32px');form.destroy();});QUnit.test('empty editable list with the handle widget and no content help',async function(assert){assert.expect(4);this.data.foo.records=[];const list=await createView({View:ListView,model:'foo',data:this.data,arch:`<tree editable="bottom">
                    <field name="int_field" widget="handle" />
                    <field name="foo" />
                </tree>`,viewOptions:{action:{help:'<p class="hello">click to add a foo</p>'}},});assert.containsNone(list,'.o_list_table'," there should not be any records in the view.");assert.containsOnce(list,'.o_view_nocontent',"should have no content help");await testUtils.dom.click(list.$('.o_list_button_add'));const handleWidgetMinWidth="33px";const handleWidgetHeader=list.$('thead > tr > th.o_handle_cell');assert.strictEqual(handleWidgetHeader.css('min-width'),handleWidgetMinWidth,"While creating first record, min-width should be applied to handle widget.");await testUtils.fields.editInput(list.$("tr.o_selected_row input[name='foo']"),'test_foo');await testUtils.dom.click(list.$('.o_list_button_save'));assert.strictEqual(handleWidgetHeader.css('min-width'),handleWidgetMinWidth,"After creation of the first record, min-width of the handle widget should remain as it is");list.destroy();});QUnit.test('editable list: overflowing table',async function(assert){assert.expect(1);this.data.bar={fields:{titi:{string:"Small char",type:"char",sortable:true},grosminet:{string:"Beeg char",type:"char",sortable:true},},records:[{id:1,titi:"Tiny text",grosminet:`Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                        Donec est massa, gravida eget dapibus ac, eleifend eget libero.
                        Suspendisse feugiat sed massa eleifend vestibulum. Sed tincidunt
                        velit sed lacinia lacinia. Nunc in fermentum nunc. Vestibulum ante
                        ipsum primis in faucibus orci luctus et ultrices posuere cubilia
                        Curae; Nullam ut nisi a est ornare molestie non vulputate orci.
                        Nunc pharetra porta semper. Mauris dictum eu nulla a pulvinar. Duis
                        eleifend odio id ligula congue sollicitudin. Curabitur quis aliquet
                        nunc, ut aliquet enim. Suspendisse malesuada felis non metus
                        efficitur aliquet.`,},],};const list=await createView({arch:`
                <tree editable="top">
                    <field name="titi"/>
                    <field name="grosminet" widget="char"/>
                </tree>`,data:this.data,model:'bar',View:ListView,});assert.strictEqual(list.$('table').width(),list.$('.o_list_view').width(),"Table should not be stretched by its content");list.destroy();});QUnit.test('editable list: overflowing table (3 columns)',async function(assert){assert.expect(4);const longText=`Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                        Donec est massa, gravida eget dapibus ac, eleifend eget libero.
                        Suspendisse feugiat sed massa eleifend vestibulum. Sed tincidunt
                        velit sed lacinia lacinia. Nunc in fermentum nunc. Vestibulum ante
                        ipsum primis in faucibus orci luctus et ultrices posuere cubilia
                        Curae; Nullam ut nisi a est ornare molestie non vulputate orci.
                        Nunc pharetra porta semper. Mauris dictum eu nulla a pulvinar. Duis
                        eleifend odio id ligula congue sollicitudin. Curabitur quis aliquet
                        nunc, ut aliquet enim. Suspendisse malesuada felis non metus
                        efficitur aliquet.`;this.data.bar={fields:{titi:{string:"Small char",type:"char",sortable:true},grosminet1:{string:"Beeg char 1",type:"char",sortable:true},grosminet2:{string:"Beeg char 2",type:"char",sortable:true},grosminet3:{string:"Beeg char 3",type:"char",sortable:true},},records:[{id:1,titi:"Tiny text",grosminet1:longText,grosminet2:longText+longText,grosminet3:longText+longText+longText,}],};const list=await createView({arch:`
                <tree editable="top">
                    <field name="titi"/>
                    <field name="grosminet1" class="large"/>
                    <field name="grosminet3" class="large"/>
                    <field name="grosminet2" class="large"/>
                </tree>`,data:this.data,model:'bar',View:ListView,});assert.strictEqual(list.$('table').width(),list.$('.o_list_view').width());const largeCells=list.$('.o_data_cell.large');assert.strictEqual(largeCells[0].offsetWidth,largeCells[1].offsetWidth);assert.strictEqual(largeCells[1].offsetWidth,largeCells[2].offsetWidth);assert.ok(list.$('.o_data_cell:not(.large)')[0].offsetWidth<largeCells[0].offsetWidth);list.destroy();});QUnit.test('editable list: list view in an initially unselected notebook page',async function(assert){assert.expect(5);this.data.foo.records=[{id:1,o2m:[1]}];this.data.bar={fields:{titi:{string:"Small char",type:"char",sortable:true},grosminet:{string:"Beeg char",type:"char",sortable:true},},records:[{id:1,titi:"Tiny text",grosminet:'Lorem ipsum dolor sit amet, consectetur adipiscing elit. '+'Ut at nisi congue, facilisis neque nec, pulvinar nunc. '+'Vivamus ac lectus velit.',},],};const form=await createView({View:FormView,model:'foo',data:this.data,res_id:1,viewOptions:{mode:'edit'},arch:'<form>'+'<sheet>'+'<notebook>'+'<page string="Page1"></page>'+'<page string="Page2">'+'<field name="o2m">'+'<tree editable="bottom">'+'<field name="titi"/>'+'<field name="grosminet"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',});const[titi,grosminet]=form.el.querySelectorAll('.tab-pane:last-child th');const one2many=form.el.querySelector('.o_field_one2many');assert.isNotVisible(one2many,"One2many field should be hidden");assert.strictEqual(titi.style.width,"","width of small char should not be set yet");assert.strictEqual(grosminet.style.width,"","width of large char should also not be set");await testUtils.dom.click(form.el.querySelector('.nav-item:last-child .nav-link'));assert.isVisible(one2many,"One2many field should be visible");assert.ok(titi.style.width.split('px')[0]>80&&grosminet.style.width.split('px')[0]>700,"list has been correctly frozen after being visible");form.destroy();});QUnit.test('editable list: list view hidden by an invisible modifier',async function(assert){assert.expect(5);this.data.foo.records=[{id:1,bar:true,o2m:[1]}];this.data.bar={fields:{titi:{string:"Small char",type:"char",sortable:true},grosminet:{string:"Beeg char",type:"char",sortable:true},},records:[{id:1,titi:"Tiny text",grosminet:'Lorem ipsum dolor sit amet, consectetur adipiscing elit. '+'Ut at nisi congue, facilisis neque nec, pulvinar nunc. '+'Vivamus ac lectus velit.',},],};var form=await createView({View:FormView,model:'foo',data:this.data,res_id:1,viewOptions:{mode:'edit'},arch:'<form>'+'<sheet>'+'<field name="bar"/>'+'<field name="o2m" attrs="{\'invisible\': [(\'bar\', \'=\', True)]}">'+'<tree editable="bottom">'+'<field name="titi"/>'+'<field name="grosminet"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',});const[titi,grosminet]=form.el.querySelectorAll('th');const one2many=form.el.querySelector('.o_field_one2many');assert.isNotVisible(one2many,"One2many field should be hidden");assert.strictEqual(titi.style.width,"","width of small char should not be set yet");assert.strictEqual(grosminet.style.width,"","width of large char should also not be set");await testUtils.dom.click(form.el.querySelector('.o_field_boolean input'));assert.isVisible(one2many,"One2many field should be visible");assert.ok(titi.style.width.split('px')[0]>80&&grosminet.style.width.split('px')[0]>700,"list has been correctly frozen after being visible");form.destroy();});QUnit.test('editable list: updating list state while invisible',async function(assert){assert.expect(2);this.data.foo.onchanges={bar:function(obj){obj.o2m=[[5],[0,null,{display_name:"Whatever"}]];},};var form=await createView({View:FormView,model:'foo',data:this.data,res_id:1,viewOptions:{mode:'edit'},arch:'<form>'+'<sheet>'+'<field name="bar"/>'+'<notebook>'+'<page string="Page 1"></page>'+'<page string="Page 2">'+'<field name="o2m">'+'<tree editable="bottom">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</page>'+'</notebook>'+'</sheet>'+'</form>',});await testUtils.dom.click(form.$('.o_field_boolean input'));assert.strictEqual(form.el.querySelector('th').style.width,"","Column header should be initially unfrozen");await testUtils.dom.click(form.$('.nav-item:last() .nav-link'));assert.notEqual(form.el.querySelector('th').style.width,"","Column header should have been frozen");form.destroy();});QUnit.test('empty list: state with nameless and stringless buttons',async function(assert){assert.expect(2);this.data.foo.records=[];const list=await createView({arch:`
                <tree>
                    <field name="foo"/>
                    <button string="choucroute"/>
                    <button icon="fa-heart"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});assert.strictEqual(list.el.querySelector('th[data-name="foo"]').style.width,'50%',"Field column should be frozen");assert.strictEqual(list.el.querySelector('th:last-child').style.width,'50%',"Buttons column should be frozen");list.destroy();});QUnit.test('editable list: unnamed columns cannot be resized',async function(assert){assert.expect(2);this.data.foo.records=[{id:1,o2m:[1]}];this.data.bar.records=[{id:1,display_name:"Oui"}];var form=await createView({View:FormView,model:'foo',data:this.data,res_id:1,viewOptions:{mode:'edit'},arch:'<form>'+'<sheet>'+'<field name="o2m">'+'<tree editable="top">'+'<field name="display_name"/>'+'<button name="the_button" icon="fa-heart"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',});const[charTh,buttonTh]=form.$('.o_field_one2many th');const thRect=charTh.getBoundingClientRect();const resizeRect=charTh.getElementsByClassName('o_resize')[0].getBoundingClientRect();assert.strictEqual(thRect.x+thRect.width,resizeRect.x+resizeRect.width,"First resize handle should be attached at the end of the first header");assert.containsNone(buttonTh,'.o_resize',"Columns without name should not have a resize handle");form.destroy();});QUnit.test('editable list view, click on m2o dropdown do not close editable row',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree string="Phonecalls" editable="top">'+'<field name="m2o"/>'+'</tree>',});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));await testUtils.dom.click(list.$('.o_selected_row .o_data_cell .o_field_many2one input'));const $dropdown=list.$('.o_selected_row .o_data_cell .o_field_many2one input').autocomplete('widget');await testUtils.dom.click($dropdown);assert.containsOnce(list,'.o_selected_row',"should still have editable row");await testUtils.dom.click($dropdown.find("li:first"));assert.containsOnce(list,'.o_selected_row',"should still have editable row");list.destroy();});QUnit.test('width of some of the fields should be hardcoded if no data (grouped case)',async function(assert){const assertions=[{field:'bar',expected:70,type:'Boolean'},{field:'int_field',expected:74,type:'Integer'},{field:'qux',expected:92,type:'Float'},{field:'date',expected:92,type:'Date'},{field:'datetime',expected:146,type:'Datetime'},{field:'amount',expected:104,type:'Monetary'},];assert.expect(9);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="bar"/>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'<field name="date"/>'+'<field name="datetime"/>'+'<field name="amount"/>'+'<field name="currency_id" width="25px"/>'+'</tree>',groupBy:['int_field'],});assert.containsNone(list,'.o_resize',"There shouldn't be any resize handle if no data");assertions.forEach(a=>{assert.strictEqual(list.$(`th[data-name="${a.field}"]`)[0].offsetWidth,a.expected,`Field ${a.type} should have a fixed width of ${a.expected} pixels`);});assert.strictEqual(list.$('th[data-name="foo"]')[0].style.width,'100%',"Char field should occupy the remaining space");assert.strictEqual(list.$('th[data-name="currency_id"]')[0].offsetWidth,25,"Currency field should have a fixed width of 25px (see arch)");list.destroy();});QUnit.test('column width should depend on the widget',async function(assert){assert.expect(1);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="datetime" widget="date"/>'+'<field name="text"/>'+'</tree>',});assert.strictEqual(list.$('th[data-name="datetime"]')[0].offsetWidth,92,"should be the optimal width to display a date, not a datetime");list.destroy();});QUnit.test('column widths are kept when adding first record',async function(assert){assert.expect(2);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="datetime"/>'+'<field name="text"/>'+'</tree>',});var width=list.$('th[data-name="datetime"]')[0].offsetWidth;await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsOnce(list,'.o_data_row');assert.strictEqual(list.$('th[data-name="datetime"]')[0].offsetWidth,width);list.destroy();});QUnit.test('column widths are kept when editing a record',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="datetime"/>'+'<field name="text"/>'+'</tree>',});var width=list.$('th[data-name="datetime"]')[0].offsetWidth;await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));assert.containsOnce(list,'.o_selected_row');var longVal='Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed blandit, '+'justo nec tincidunt feugiat, mi justo suscipit libero, sit amet tempus ipsum purus '+'bibendum est.';await testUtils.fields.editInput(list.$('.o_field_widget[name=text]'),longVal);await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.containsNone(list,'.o_selected_row');assert.strictEqual(list.$('th[data-name="datetime"]')[0].offsetWidth,width);list.destroy();});QUnit.test('column widths are kept when switching records in edition',async function(assert){assert.expect(4);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`<tree editable="bottom">
                    <field name="m2o"/>
                    <field name="text"/>
                </tree>`,});const width=list.$('th[data-name="m2o"]')[0].offsetWidth;await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:first'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');assert.strictEqual(list.$('th[data-name="m2o"]')[0].offsetWidth,width);await testUtils.dom.click(list.$('.o_data_row:nth(1) .o_data_cell:first'));assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');assert.strictEqual(list.$('th[data-name="m2o"]')[0].offsetWidth,width);list.destroy();});QUnit.test('column widths are re-computed on window resize',async function(assert){assert.expect(2);testUtils.mock.patch(ListRenderer,{RESIZE_DELAY:0,});this.data.foo.records[0].text='Lorem ipsum dolor sit amet, consectetur adipiscing elit. '+'Sed blandit, justo nec tincidunt feugiat, mi justo suscipit libero, sit amet tempus '+'ipsum purus bibendum est.';const list=await createView({View:ListView,model:'foo',data:this.data,arch:`<tree editable="bottom">
                        <field name="datetime"/>
                        <field name="text"/>
                    </tree>`,});const initialTextWidth=list.$('th[data-name="text"]')[0].offsetWidth;const selectorWidth=list.$('th.o_list_record_selector')[0].offsetWidth;list.$el.width(`${list.$el.width() / 2}px`);core.bus.trigger('resize');await testUtils.nextTick();const postResizeTextWidth=list.$('th[data-name="text"]')[0].offsetWidth;const postResizeSelectorWidth=list.$('th.o_list_record_selector')[0].offsetWidth;assert.ok(postResizeTextWidth<initialTextWidth);assert.strictEqual(selectorWidth,postResizeSelectorWidth);testUtils.mock.unpatch(ListRenderer);list.destroy();});QUnit.test('columns with an absolute width are never narrower than that width',async function(assert){assert.expect(2);this.data.foo.records[0].text='Lorem ipsum dolor sit amet, consectetur adipiscing elit, '+'sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim '+'veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo '+'consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum '+'dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, '+'sunt in culpa qui officia deserunt mollit anim id est laborum';var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="datetime"/>'+'<field name="int_field" width="200px"/>'+'<field name="text"/>'+'</tree>',});assert.strictEqual(list.$('th[data-name="datetime"]')[0].offsetWidth,146);assert.strictEqual(list.$('th[data-name="int_field"]')[0].offsetWidth,200);list.destroy();});QUnit.test('list view with data: text columns are not crushed',async function(assert){assert.expect(2);const longText='Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do '+'eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim '+'veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo '+'consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum '+'dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, '+'sunt in culpa qui officia deserunt mollit anim id est laborum';this.data.foo.records[0].foo=longText;this.data.foo.records[0].text=longText;this.data.foo.records[1].foo="short text";this.data.foo.records[1].text="short text";var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="text"/></tree>',});const fooWidth=list.$('th[data-name="foo"]')[0].offsetWidth;const textWidth=list.$('th[data-name="text"]')[0].offsetWidth;assert.strictEqual(fooWidth,textWidth,"both columns should have been given the same width");const firstRowHeight=list.$('.o_data_row:nth(0)')[0].offsetHeight;const secondRowHeight=list.$('.o_data_row:nth(1)')[0].offsetHeight;assert.ok(firstRowHeight>secondRowHeight,"in the first row, the (long) text field should be properly displayed on several lines");list.destroy();});QUnit.test("button in a list view with a default relative width",async function(assert){assert.expect(1);const list=await createView({arch:`
            <tree>
                <field name="foo"/>
                <button name="the_button" icon="fa-heart" width="0.1"/>
            </tree>`,data:this.data,model:'foo',View:ListView,});assert.strictEqual(list.el.querySelector('.o_data_cell button').style.width,"","width attribute should not change the CSS style");list.destroy();});QUnit.test("button columns in a list view don't have a max width",async function(assert){assert.expect(2);testUtils.mock.patch(ListRenderer,{RESIZE_DELAY:0,});this.data.foo.records[0].foo='Lorem ipsum dolor sit amet';const list=await createView({arch:`
                <tree>
                    <field name="foo"/>
                    <button name="b1" string="Do This"/>
                    <button name="b2" string="Do That"/>
                    <button name="b3" string="Or Rather Do Something Else"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});list.$el.width('300px');core.bus.trigger('resize');await testUtils.nextTick();assert.strictEqual(list.$('th:nth(1)').css('max-width'),'92px',"max-width should be set on column foo to the minimum column width (92px)");assert.strictEqual(list.$('th:nth(2)').css('max-width'),'100%',"no max-width should be harcoded on the buttons column");testUtils.mock.unpatch(ListRenderer);list.destroy();});QUnit.test('column widths are kept when editing multiple records',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="datetime"/>'+'<field name="text"/>'+'</tree>',});var width=list.$('th[data-name="datetime"]')[0].offsetWidth;await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));assert.containsOnce(list,'.o_selected_row');var longVal='Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed blandit, '+'justo nec tincidunt feugiat, mi justo suscipit libero, sit amet tempus ipsum purus '+'bibendum est.';await testUtils.fields.editInput(list.$('.o_field_widget[name=text]'),longVal);assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal .btn-primary'));assert.containsNone(list,'.o_selected_row');assert.strictEqual(list.$('th[data-name="datetime"]')[0].offsetWidth,width);list.destroy();});QUnit.test('row height and width should not change when switching mode',async function(assert){assert.expect(5);var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;this.data.foo.fields.foo.translate=true;this.data.foo.fields.boolean={type:'boolean',string:'Bool'};var currencies={};_.each(this.data.res_currency.records,function(currency){currencies[currency.id]=currency;});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo" required="1"/>'+'<field name="int_field" readonly="1"/>'+'<field name="boolean"/>'+'<field name="date"/>'+'<field name="text"/>'+'<field name="amount"/>'+'<field name="currency_id" invisible="1"/>'+'<field name="m2o"/>'+'<field name="m2m" widget="many2many_tags"/>'+'</tree>',session:{currencies:currencies,},});list.$el.width('1200px');var startHeight=list.$('.o_data_row:first').outerHeight();var startWidth=list.$('.o_data_row:first').outerWidth();await testUtils.dom.click(list.$('.o_data_row:first > td:not(.o_list_record_selector)').first());assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');var editionHeight=list.$('.o_data_row:first').outerHeight();var editionWidth=list.$('.o_data_row:first').outerWidth();await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));var readonlyHeight=list.$('.o_data_row:first').outerHeight();var readonlyWidth=list.$('.o_data_row:first').outerWidth();assert.strictEqual(startHeight,editionHeight);assert.strictEqual(startHeight,readonlyHeight);assert.strictEqual(startWidth,editionWidth);assert.strictEqual(startWidth,readonlyWidth);_t.database.multi_lang=multiLang;list.destroy();});QUnit.test('fields are translatable in list view',async function(assert){assert.expect(3);var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;this.data.foo.fields.foo.translate=true;var list=await createView({View:ListView,model:'foo',data:this.data,mockRPC:function(route,args){if(route==="/web/dataset/call_button"&&args.method==='translate_fields'){return Promise.resolve({domain:[],context:{search_default_name:'foo,foo'},});}
if(route==="/web/dataset/call_kw/res.lang/get_installed"){return Promise.resolve([["en_US","English"],["fr_BE","Frenglish"]]);}
return this._super.apply(this,arguments);},arch:'<tree editable="top">'+'<field name="foo" required="1"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:first > td:not(.o_list_record_selector)').first());assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');await testUtils.dom.click(list.$('input.o_field_translate+span.o_field_translate'));await testUtils.nextTick();assert.containsOnce($('body'),'.o_translation_dialog');assert.containsN($('.o_translation_dialog'),'.translation>input.o_field_char',2,'modal should have 2 languages to translate');_t.database.multi_lang=multiLang;list.destroy();});QUnit.test('long words in text cells should break into smaller lines',async function(assert){assert.expect(2);this.data.foo.records[0].text="a";this.data.foo.records[1].text="pneumonoultramicroscopicsilicovolcanoconiosis";var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="text"/></tree>',});list.$('table').width('100px');list.$('th:last').width('100px');var shortText=list.$('.o_data_row:eq(0) td:last')[0].clientHeight;var longText=list.$('.o_data_row:eq(1) td:last')[0].clientHeight;var emptyText=list.$('.o_data_row:eq(2) td:last')[0].clientHeight;assert.strictEqual(shortText,emptyText,"Short word should not change the height of the cell");assert.ok(longText>emptyText,"Long word should change the height of the cell");list.destroy();});QUnit.test('deleting one record',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,viewOptions:{hasActionMenus:true},arch:'<tree><field name="foo"/></tree>',});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'tbody td.o_list_record_selector',4,"should have 4 records");await testUtils.dom.click(list.$('tbody td.o_list_record_selector:first input'));assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Delete");assert.hasClass($('body'),'modal-open','body should have modal-open clsss');await testUtils.dom.click($('body .modal button span:contains(Ok)'));assert.containsN(list,'tbody td.o_list_record_selector',3,"should have 3 records");list.destroy();});QUnit.test('delete all records matching the domain',async function(assert){assert.expect(6);this.data.foo.records.push({id:5,bar:true,foo:"xxx"});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="2"><field name="foo"/></tree>',domain:[['bar','=',true]],mockRPC:function(route,args){if(args.method==='unlink'){assert.deepEqual(args.args[0],[1,2,3,5]);}
return this._super.apply(this,arguments);},services:{notification:NotificationService.extend({notify:function(){throw new Error('should not display a notification');},}),},viewOptions:{hasActionMenus:true,},});assert.containsNone(list,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'tbody td.o_list_record_selector',2,"should have 2 records");await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsOnce(list,'div.o_control_panel .o_cp_action_menus');assert.containsOnce(list,'.o_list_selection_box .o_list_select_domain');await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Delete");assert.strictEqual($('.modal').length,1,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer .btn-primary'));list.destroy();});QUnit.test('delete all records matching the domain (limit reached)',async function(assert){assert.expect(8);this.data.foo.records.push({id:5,bar:true,foo:"xxx"});this.data.foo.records.push({id:6,bar:true,foo:"yyy"});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="2"><field name="foo"/></tree>',domain:[['bar','=',true]],mockRPC:function(route,args){if(args.method==='unlink'){assert.deepEqual(args.args[0],[1,2,3,5]);}
return this._super.apply(this,arguments);},services:{notification:NotificationService.extend({notify:function(){assert.step('notify');},}),},session:{active_ids_limit:4,},viewOptions:{hasActionMenus:true,},});assert.containsNone(list,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'tbody td.o_list_record_selector',2,"should have 2 records");await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsOnce(list,'div.o_control_panel .o_cp_action_menus');assert.containsOnce(list,'.o_list_selection_box .o_list_select_domain');await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Delete");assert.strictEqual($('.modal').length,1,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer .btn-primary'));assert.verifySteps(['notify']);list.destroy();});QUnit.test('archiving one record',async function(assert){assert.expect(12);this.data.foo.fields.active={string:'Active',type:'boolean',default:true};var list=await createView({View:ListView,model:'foo',data:this.data,viewOptions:{hasActionMenus:true},arch:'<tree><field name="foo"/></tree>',mockRPC:function(route){assert.step(route);if(route==='/web/dataset/call_kw/foo/action_archive'){this.data.foo.records[0].active=false;return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'tbody td.o_list_record_selector',4,"should have 4 records");await testUtils.dom.click(list.$('tbody td.o_list_record_selector:first input'));assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');assert.verifySteps(['/web/dataset/search_read']);await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Archive");assert.strictEqual($('.modal').length,1,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer .btn-secondary'));assert.containsN(list,'tbody td.o_list_record_selector',4,"still should have 4 records");await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Archive");assert.strictEqual($('.modal').length,1,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer .btn-primary'));assert.containsN(list,'tbody td.o_list_record_selector',3,"should have 3 records");assert.verifySteps(['/web/dataset/call_kw/foo/action_archive','/web/dataset/search_read']);list.destroy();});QUnit.test('archive all records matching the domain',async function(assert){assert.expect(6);this.data.foo.fields.active={string:'Active',type:'boolean',default:true};this.data.foo.records.push({id:5,bar:true,foo:"xxx"});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="2"><field name="foo"/></tree>',domain:[['bar','=',true]],mockRPC:function(route,args){if(args.method==='action_archive'){assert.deepEqual(args.args[0],[1,2,3,5]);return Promise.resolve();}
return this._super.apply(this,arguments);},services:{notification:NotificationService.extend({notify:function(){throw new Error('should not display a notification');},}),},viewOptions:{hasActionMenus:true,},});assert.containsNone(list,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'tbody td.o_list_record_selector',2,"should have 2 records");await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsOnce(list,'div.o_control_panel .o_cp_action_menus');assert.containsOnce(list,'.o_list_selection_box .o_list_select_domain');await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Archive");assert.strictEqual($('.modal').length,1,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer .btn-primary'));list.destroy();});QUnit.test('archive all records matching the domain (limit reached)',async function(assert){assert.expect(8);this.data.foo.fields.active={string:'Active',type:'boolean',default:true};this.data.foo.records.push({id:5,bar:true,foo:"xxx"});this.data.foo.records.push({id:6,bar:true,foo:"yyy"});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="2"><field name="foo"/></tree>',domain:[['bar','=',true]],mockRPC:function(route,args){if(args.method==='action_archive'){assert.deepEqual(args.args[0],[1,2,3,5]);return Promise.resolve();}
return this._super.apply(this,arguments);},services:{notification:NotificationService.extend({notify:function(){assert.step('notify');},}),},session:{active_ids_limit:4,},viewOptions:{hasActionMenus:true,},});assert.containsNone(list,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'tbody td.o_list_record_selector',2,"should have 2 records");await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsOnce(list,'div.o_control_panel .o_cp_action_menus');assert.containsOnce(list,'.o_list_selection_box .o_list_select_domain');await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Archive");assert.strictEqual($('.modal').length,1,'a confirm modal should be displayed');await testUtils.dom.click($('.modal-footer .btn-primary'));assert.verifySteps(['notify']);list.destroy();});QUnit.test('pager (ungrouped and grouped mode), default limit',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="bar"/></tree>',mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.strictEqual(args.limit,80,"default limit should be 80 in List");}
return this._super.apply(this,arguments);},});assert.containsOnce(list.el,'div.o_control_panel .o_cp_pager');assert.strictEqual(cpHelpers.getPagerSize(list),"4","pager's size should be 4");await list.update({groupBy:['bar']});assert.strictEqual(cpHelpers.getPagerSize(list),"2","pager's size should be 2");list.destroy();});QUnit.test('can sort records when clicking on header',async function(assert){assert.expect(9);this.data.foo.fields.foo.sortable=true;var nbSearchRead=0;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="bar"/></tree>',mockRPC:function(route){if(route==='/web/dataset/search_read'){nbSearchRead++;}
return this._super.apply(this,arguments);},});assert.strictEqual(nbSearchRead,1,"should have done one search_read");assert.ok(list.$('tbody tr:first td:contains(yop)').length,"record 1 should be first");assert.ok(list.$('tbody tr:eq(3) td:contains(blip)').length,"record 3 should be first");nbSearchRead=0;await testUtils.dom.click(list.$('thead th:contains(Foo)'));assert.strictEqual(nbSearchRead,1,"should have done one search_read");assert.ok(list.$('tbody tr:first td:contains(blip)').length,"record 3 should be first");assert.ok(list.$('tbody tr:eq(3) td:contains(yop)').length,"record 1 should be first");nbSearchRead=0;await testUtils.dom.click(list.$('thead th:contains(Foo)'));assert.strictEqual(nbSearchRead,1,"should have done one search_read");assert.ok(list.$('tbody tr:first td:contains(yop)').length,"record 3 should be first");assert.ok(list.$('tbody tr:eq(3) td:contains(blip)').length,"record 1 should be first");list.destroy();});QUnit.test('do not sort records when clicking on header with nolabel',async function(assert){assert.expect(6);this.data.foo.fields.foo.sortable=true;let nbSearchRead=0;const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo" nolabel="1"/><field name="int_field"/></tree>',mockRPC:function(route){if(route==='/web/dataset/search_read'){nbSearchRead++;}
return this._super.apply(this,arguments);},});assert.strictEqual(nbSearchRead,1,"should have done one search_read");assert.strictEqual(list.$('.o_data_cell').text(),"yop10blip9gnap17blip-4");await testUtils.dom.click(list.$('thead th[data-name="int_field"]'));assert.strictEqual(nbSearchRead,2,"should have done one other search_read");assert.strictEqual(list.$('.o_data_cell').text(),"blip-4blip9yop10gnap17");await testUtils.dom.click(list.$('thead th[data-name="foo"]'));assert.strictEqual(nbSearchRead,2,"shouldn't have done anymore search_read");assert.strictEqual(list.$('.o_data_cell').text(),"blip-4blip9yop10gnap17");list.destroy();});QUnit.test('use default_order',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree default_order="foo"><field name="foo"/><field name="bar"/></tree>',mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.strictEqual(args.sort,'foo ASC',"should correctly set the sort attribute");}
return this._super.apply(this,arguments);},});assert.ok(list.$('tbody tr:first td:contains(blip)').length,"record 3 should be first");assert.ok(list.$('tbody tr:eq(3) td:contains(yop)').length,"record 1 should be first");list.destroy();});QUnit.test('use more complex default_order',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree default_order="foo, bar desc, int_field">'+'<field name="foo"/><field name="bar"/>'+'</tree>',mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.strictEqual(args.sort,'foo ASC, bar DESC, int_field ASC',"should correctly set the sort attribute");}
return this._super.apply(this,arguments);},});assert.ok(list.$('tbody tr:first td:contains(blip)').length,"record 3 should be first");assert.ok(list.$('tbody tr:eq(3) td:contains(yop)').length,"record 1 should be first");list.destroy();});QUnit.test('use default_order on editable tree: sort on save',async function(assert){assert.expect(8);this.data.foo.records[0].o2m=[1,3];var form=await createView({View:FormView,model:'foo',data:this.data,arch:'<form>'+'<sheet>'+'<field name="o2m">'+'<tree editable="bottom" default_order="display_name">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.ok(form.$('tbody tr:first td:contains(Value 1)').length,"Value 1 should be first");assert.ok(form.$('tbody tr:eq(1) td:contains(Value 3)').length,"Value 3 should be second");var $o2m=form.$('.o_field_widget[name=o2m]');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput($o2m.find('.o_field_widget'),"Value 2");assert.ok(form.$('tbody tr:first td:contains(Value 1)').length,"Value 1 should be first");assert.ok(form.$('tbody tr:eq(1) td:contains(Value 3)').length,"Value 3 should be second");assert.ok(form.$('tbody tr:eq(2) td input').val(),"Value 2 should be third (shouldn't be sorted)");await testUtils.form.clickSave(form);assert.ok(form.$('tbody tr:first td:contains(Value 1)').length,"Value 1 should be first");assert.ok(form.$('tbody tr:eq(1) td:contains(Value 2)').length,"Value 2 should be second (should be sorted after saving)");assert.ok(form.$('tbody tr:eq(2) td:contains(Value 3)').length,"Value 3 should be third");form.destroy();});QUnit.test('use default_order on editable tree: sort on demand',async function(assert){assert.expect(11);this.data.foo.records[0].o2m=[1,3];this.data.bar.fields={name:{string:"Name",type:"char",sortable:true}};this.data.bar.records[0].name="Value 1";this.data.bar.records[2].name="Value 3";var form=await createView({View:FormView,model:'foo',data:this.data,arch:'<form>'+'<sheet>'+'<field name="o2m">'+'<tree editable="bottom" default_order="name">'+'<field name="name"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,});await testUtils.form.clickEdit(form);assert.ok(form.$('tbody tr:first td:contains(Value 1)').length,"Value 1 should be first");assert.ok(form.$('tbody tr:eq(1) td:contains(Value 3)').length,"Value 3 should be second");var $o2m=form.$('.o_field_widget[name=o2m]');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.editInput($o2m.find('.o_field_widget'),"Value 2");assert.ok(form.$('tbody tr:first td:contains(Value 1)').length,"Value 1 should be first");assert.ok(form.$('tbody tr:eq(1) td:contains(Value 3)').length,"Value 3 should be second");assert.ok(form.$('tbody tr:eq(2) td input').val(),"Value 2 should be third (shouldn't be sorted)");await testUtils.dom.click(form.$('.o_form_sheet_bg'));await testUtils.dom.click($o2m.find('.o_column_sortable'));assert.strictEqual(form.$('tbody tr:first').text(),'Value 1',"Value 1 should be first");assert.strictEqual(form.$('tbody tr:eq(1)').text(),'Value 2',"Value 2 should be second (should be sorted after saving)");assert.strictEqual(form.$('tbody tr:eq(2)').text(),'Value 3',"Value 3 should be third");await testUtils.dom.click($o2m.find('.o_column_sortable'));assert.strictEqual(form.$('tbody tr:first').text(),'Value 3',"Value 3 should be first");assert.strictEqual(form.$('tbody tr:eq(1)').text(),'Value 2',"Value 2 should be second (should be sorted after saving)");assert.strictEqual(form.$('tbody tr:eq(2)').text(),'Value 1',"Value 1 should be third");form.destroy();});QUnit.test('use default_order on editable tree: sort on demand in page',async function(assert){assert.expect(4);this.data.bar.fields={name:{string:"Name",type:"char",sortable:true}};var ids=[];for(var i=0;i<45;i++){var id=4+i;ids.push(id);this.data.bar.records.push({id:id,name:"Value "+(id<10?'0':'')+id,});}
this.data.foo.records[0].o2m=ids;var form=await createView({View:FormView,model:'foo',data:this.data,arch:'<form>'+'<sheet>'+'<field name="o2m">'+'<tree editable="bottom" default_order="name">'+'<field name="name"/>'+'</tree>'+'</field>'+'</sheet>'+'</form>',res_id:1,});await cpHelpers.pagerNext('.o_field_widget[name=o2m]');assert.strictEqual(form.$('tbody tr:first').text(),'Value 44',"record 44 should be first");assert.strictEqual(form.$('tbody tr:eq(4)').text(),'Value 48',"record 48 should be last");await testUtils.dom.click(form.$('.o_column_sortable'));assert.strictEqual(form.$('tbody tr:first').text(),'Value 08',"record 48 should be first");assert.strictEqual(form.$('tbody tr:eq(4)').text(),'Value 04',"record 44 should be first");form.destroy();});QUnit.test('can display button in edit mode',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<button name="notafield" type="object" icon="fa-asterisk" class="o_yeah"/>'+'</tree>',});assert.containsN(list,'tbody button[name=notafield]',4);assert.containsN(list,'tbody button[name=notafield].o_yeah',4,"class o_yeah should be set on the four button");list.destroy();});QUnit.test('can display a list with a many2many field',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="m2m"/>'+'</tree>',mockRPC:function(route,args){assert.step(route);return this._super(route,args);},});assert.verifySteps(['/web/dataset/search_read'],"should have done 1 search_read");assert.ok(list.$('td:contains(3 records)').length,"should have a td with correct formatted value");list.destroy();});QUnit.test('list with group_by_no_leaf flag in context',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',context:{group_by_no_leaf:true,}});assert.containsNone(list,'.o_list_buttons',"should not have any buttons");list.destroy();});QUnit.test('display a tooltip on a field',async function(assert){assert.expect(4);var initialDebugMode=odoo.debug;odoo.debug=false;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="bar" widget="toggle_button"/>'+'</tree>',});list.$('th[data-name=foo]').tooltip('show',false);list.$('th[data-name=foo]').trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_string').length,0,"should not have rendered a tooltip");odoo.debug=true;await list.reload();list.$('th[data-name=foo]').tooltip('show',false);list.$('th[data-name=foo]').trigger($.Event('mouseenter'));assert.strictEqual($('.tooltip .oe_tooltip_string').length,1,"should have rendered a tooltip");await list.reload();list.$('th[data-name=bar]').tooltip('show',false);list.$('th[data-name=bar]').trigger($.Event('mouseenter'));assert.containsOnce($,'.oe_tooltip_technical>li[data-item="widget"]','widget should be present for this field');assert.strictEqual($('.oe_tooltip_technical>li[data-item="widget"]')[0].lastChild.wholeText.trim(),'Button (toggle_button)',"widget description should be correct");odoo.debug=initialDebugMode;list.destroy();});QUnit.test('support row decoration',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree decoration-info="int_field > 5">'+'<field name="foo"/><field name="int_field"/>'+'</tree>',});assert.containsN(list,'tbody tr.text-info',3,"should have 3 columns with text-info class");assert.containsN(list,'tbody tr',4,"should have 4 rows");list.destroy();});QUnit.test('support row decoration (with unset numeric values)',async function(assert){assert.expect(2);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom" decoration-danger="int_field &lt; 0">'+'<field name="int_field"/>'+'</tree>',});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsNone(list,'tr.o_data_row.text-danger',"the data row should not have .text-danger decoration (int_field is unset)");await testUtils.fields.editInput(list.$('input[name="int_field"]'),'-3');assert.containsOnce(list,'tr.o_data_row.text-danger',"the data row should have .text-danger decoration (int_field is negative)");list.destroy();});QUnit.test('support row decoration with date',async function(assert){assert.expect(3);this.data.foo.records[0].datetime='2017-02-27 12:51:35';var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree decoration-info="datetime == \'2017-02-27 12:51:35\'" decoration-danger="datetime &gt; \'2017-02-27 12:51:35\' AND datetime &lt; \'2017-02-27 10:51:35\'">'+'<field name="datetime"/><field name="int_field"/>'+'</tree>',});assert.containsOnce(list,'tbody tr.text-info',"should have 1 columns with text-info class with good datetime");assert.containsNone(list,'tbody tr.text-danger',"should have 0 columns with text-danger class with wrong timezone datetime");assert.containsN(list,'tbody tr',4,"should have 4 rows");list.destroy();});QUnit.test('support field decoration',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <field name="foo" decoration-danger="int_field > 5"/>
                    <field name="int_field"/>
                </tree>`,});assert.containsN(list,'tbody tr',4,"should have 4 rows");assert.containsN(list,'tbody td.o_list_char.text-danger',3);assert.containsNone(list,'tbody td.o_list_number.text-danger');list.destroy();});QUnit.test('bounce create button when no data and click on empty area',async function(assert){assert.expect(4);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',viewOptions:{action:{help:'<p class="hello">click to add a record</p>'}},});assert.containsNone(list,'.o_view_nocontent');await testUtils.dom.click(list.$('.o_list_view'));assert.doesNotHaveClass(list.$('.o_list_button_add'),'o_catch_attention');await list.reload({domain:[['id','<',0]]});assert.containsOnce(list,'.o_view_nocontent');await testUtils.dom.click(list.$('.o_view_nocontent'));assert.hasClass(list.$('.o_list_button_add'),'o_catch_attention');list.destroy();});QUnit.test('no content helper when no data',async function(assert){assert.expect(5);var records=this.data.foo.records;this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'}},});assert.containsOnce(list,'.o_view_nocontent',"should display the no content helper");assert.containsNone(list,'table',"should not have a table in the dom");assert.strictEqual(list.$('.o_view_nocontent p.hello:contains(add a partner)').length,1,"should have rendered no content helper from action");this.data.foo.records=records;await list.reload();assert.containsNone(list,'.o_view_nocontent',"should not display the no content helper");assert.containsOnce(list,'table',"should have a table in the dom");list.destroy();});QUnit.test('no nocontent helper when no data and no help',async function(assert){assert.expect(3);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',});assert.containsNone(list,'.o_view_nocontent',"should not display the no content helper");assert.containsNone(list,'tr.o_data_row',"should not have any data row");assert.containsOnce(list,'table',"should have a table in the dom");list.destroy();});QUnit.test("empty list with sample data",async function(assert){assert.expect(19);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree sample="1">
                    <field name="foo"/>
                    <field name="bar"/>
                    <field name="int_field"/>
                    <field name="m2o"/>
                    <field name="m2m" widget="many2many_tags"/>
                    <field name="date"/>
                    <field name="datetime"/>
                </tree>`,domain:[['id','<',0]],viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'}},});assert.hasClass(list.$el,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsN(list,'.o_data_row',10);assert.containsOnce(list,'.o_nocontent_help .hello');const firstRow=list.el.querySelector('.o_data_row');const cells=firstRow.querySelectorAll(':scope > .o_data_cell');assert.strictEqual(cells[0].innerText.trim(),"","Char field should yield an empty element");assert.containsOnce(cells[1],'.custom-checkbox',"Boolean field has been instantiated");assert.notOk(isNaN(cells[2].innerText.trim()),"Intger value is a number");assert.ok(cells[3].innerText.trim(),"Many2one field is a string");const firstM2MTag=cells[4].querySelector(':scope span.o_badge_text').innerText.trim();assert.ok(firstM2MTag.length>0,"Many2many contains at least one string tag");assert.ok(/\d{2}\/\d{2}\/\d{4}/.test(cells[5].innerText.trim()),"Date field should have the right format");assert.ok(/\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}/.test(cells[6].innerText.trim()),"Datetime field should have the right format");const textContent=list.$el.text();await list.reload();assert.strictEqual(textContent,list.$el.text(),'The content should be the same after reloading the view without change');await list.reload({domain:Domain.FALSE_DOMAIN});assert.doesNotHaveClass(list.$el,'o_view_sample_data');assert.containsNone(list,'.o_list_table');assert.containsOnce(list,'.o_nocontent_help .hello');await list.reload({domain:Domain.TRUE_DOMAIN});assert.doesNotHaveClass(list.$el,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsN(list,'.o_data_row',4);assert.containsNone(list,'.o_nocontent_help .hello');list.destroy();});QUnit.test("empty list with sample data: toggle optional field",async function(assert){assert.expect(9);const RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree sample="1">
                    <field name="foo"/>
                    <field name="m2o" optional="hide"/>
                </tree>`,domain:Domain.FALSE_DOMAIN,services:{local_storage:RamStorageService,},});assert.hasClass(list.$el,'o_view_sample_data');assert.ok(list.$('.o_data_row').length>0);assert.hasClass(list.el.querySelector('.o_data_row'),'o_sample_data_disabled');assert.containsN(list,'th',2,"should have 2 th, 1 for selector and 1 for foo");assert.containsOnce(list.$('table'),'.o_optional_columns_dropdown_toggle');await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:first input'));assert.hasClass(list.$el,'o_view_sample_data');assert.ok(list.$('.o_data_row').length>0);assert.hasClass(list.el.querySelector('.o_data_row'),'o_sample_data_disabled');assert.containsN(list,'th',3);list.destroy();});QUnit.test("empty list with sample data: keyboard navigation",async function(assert){assert.expect(11);const list=await createView({arch:`
                <tree sample="1">
                    <field name="foo"/>
                    <field name="bar"/>
                    <field name="int_field"/>
                </tree>`,data:this.data,domain:Domain.FALSE_DOMAIN,model:'foo',View:ListView,});assert.hasClass(list.el.querySelector('.o_data_row'),'o_sample_data_disabled');assert.hasClass(list.el.querySelector('.o_list_table > tfoot'),'o_sample_data_disabled');assert.hasClass(list.el.querySelector('.o_list_table > thead .o_list_record_selector'),'o_sample_data_disabled');assert.containsNone(list.renderer,'input:not([tabindex="-1"])');assert.hasClass(document.activeElement,'o_searchview_input');await testUtils.fields.triggerKeydown(document.activeElement,'down');assert.hasClass(document.activeElement,'o_searchview_input');document.querySelector('.btn.o_list_button_add').focus();assert.hasClass(document.activeElement,'o_list_button_add');await testUtils.fields.triggerKeydown(document.activeElement,'down');assert.hasClass(document.activeElement,'o_list_button_add');await testUtils.fields.triggerKeydown(document.activeElement,'tab');assert.containsNone(document.body,'.oe_tooltip_string');list.el.querySelector(':scope th[data-name="foo"]').focus();assert.ok(document.activeElement.dataset.name==='foo');await testUtils.fields.triggerKeydown(document.activeElement,'down');assert.ok(document.activeElement.dataset.name==='foo');list.destroy();});QUnit.test("non empty list with sample data",async function(assert){assert.expect(6);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree sample="1">
                    <field name="foo"/>
                    <field name="bar"/>
                    <field name="int_field"/>
                </tree>`,domain:Domain.TRUE_DOMAIN,});assert.containsOnce(list,'.o_list_table');assert.containsN(list,'.o_data_row',4);assert.doesNotHaveClass(list.$el,'o_view_sample_data');await list.reload({domain:Domain.FALSE_DOMAIN});assert.containsOnce(list,'.o_list_table');assert.containsNone(list,'.o_data_row');assert.doesNotHaveClass(list.$el,'o_view_sample_data');list.destroy();});QUnit.test('click on header in empty list with sample data',async function(assert){assert.expect(4);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree sample="1">
                    <field name="foo"/>
                    <field name="bar"/>
                    <field name="int_field"/>
                </tree>`,domain:Domain.FALSE_DOMAIN,});assert.hasClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsN(list,'.o_data_row',10);const content=list.$el.text();await testUtils.dom.click(list.$('tr:first .o_column_sortable:first'));assert.strictEqual(list.$el.text(),content,"the content should still be the same");list.destroy();});QUnit.test("non empty editable list with sample data: delete all records",async function(assert){assert.expect(7);const list=await createView({arch:`
                <tree editable="top" sample="1">
                    <field name="foo"/>
                    <field name="bar"/>
                    <field name="int_field"/>
                </tree>`,data:this.data,domain:Domain.TRUE_DOMAIN,model:'foo',View:ListView,viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'},hasActionMenus:true,},});assert.doesNotHaveClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsN(list,'.o_data_row',4);assert.containsNone(list,'.o_nocontent_help');await testUtils.dom.click(list.el.querySelector('thead .o_list_record_selector input'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Delete");await testUtils.dom.click($('.modal-footer .btn-primary'));assert.doesNotHaveClass(list,'o_view_sample_data');assert.containsNone(list,'.o_list_table');assert.containsOnce(list,'.o_nocontent_help');list.destroy();});QUnit.test("empty editable list with sample data: start create record and cancel",async function(assert){assert.expect(10);const list=await createView({arch:`
                <tree editable="top" sample="1">
                    <field name="foo"/>
                    <field name="bar"/>
                    <field name="int_field"/>
                </tree>`,data:this.data,domain:Domain.FALSE_DOMAIN,model:'foo',View:ListView,viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'},},});assert.hasClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsN(list,'.o_data_row',10);assert.containsOnce(list,'.o_nocontent_help');await testUtils.dom.click(list.el.querySelector('.btn.o_list_button_add'));assert.doesNotHaveClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_data_row');await testUtils.dom.click(list.el.querySelector('.btn.o_list_button_discard'));assert.doesNotHaveClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsNone(list,'.o_data_row');assert.containsNone(list,'.o_nocontent_help');list.destroy();});QUnit.test("empty editable list with sample data: create and delete record",async function(assert){assert.expect(13);const list=await createView({arch:`
                <tree editable="top" sample="1">
                    <field name="foo"/>
                    <field name="bar"/>
                    <field name="int_field"/>
                </tree>`,data:this.data,domain:Domain.FALSE_DOMAIN,model:'foo',View:ListView,viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'},hasActionMenus:true,},});assert.hasClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsN(list,'.o_data_row',10);assert.containsOnce(list,'.o_nocontent_help');await testUtils.dom.click(list.el.querySelector('.btn.o_list_button_add'));assert.doesNotHaveClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_data_row');await testUtils.dom.click(list.el.querySelector('.btn.o_list_button_save'));assert.doesNotHaveClass(list,'o_view_sample_data');assert.containsOnce(list,'.o_list_table');assert.containsOnce(list,'.o_data_row');assert.containsNone(list,'.o_nocontent_help');await testUtils.dom.click(list.el.querySelector('.o_data_row input'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Delete");await testUtils.dom.click($('.modal-footer .btn-primary'));assert.doesNotHaveClass(list,'o_view_sample_data');assert.containsNone(list,'.o_list_table');assert.containsOnce(list,'.o_nocontent_help');list.destroy();});QUnit.test('Do not display nocontent when it is an empty html tag',async function(assert){assert.expect(2);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',viewOptions:{action:{help:'<p class="hello"></p>'}},});assert.containsNone(list,'.o_view_nocontent',"should not display the no content helper");assert.containsOnce(list,'table',"should have a table in the dom");list.destroy();});QUnit.test('groupby node with a button',async function(assert){assert.expect(14);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<groupby name="currency_id">'+'<button string="Button 1" type="object" name="button_method"/>'+'</groupby>'+'</tree>',mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},intercepts:{execute_action:function(ev){assert.deepEqual(ev.data.env.currentID,2,'should call with correct id');assert.strictEqual(ev.data.env.model,'res_currency','should call with correct model');assert.strictEqual(ev.data.action_data.name,'button_method',"should call correct method");assert.strictEqual(ev.data.action_data.type,'object','should have correct type');ev.data.on_success();},},});assert.verifySteps(['/web/dataset/search_read']);assert.containsOnce(list,'thead th:not(.o_list_record_selector)',"there should be only one column");await list.update({groupBy:['currency_id']});assert.verifySteps(['web_read_group']);assert.containsN(list,'.o_group_header',2,"there should be 2 group headers");assert.containsNone(list,'.o_group_header button',0,"there should be no button in the header");await testUtils.dom.click(list.$('.o_group_header:eq(0)'));assert.verifySteps(['/web/dataset/search_read']);assert.containsOnce(list,'.o_group_header button');await testUtils.dom.click(list.$('.o_group_header:eq(0) button'));list.destroy();});QUnit.test('groupby node with a button in inner groupbys',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<groupby name="currency_id">'+'<button string="Button 1" type="object" name="button_method"/>'+'</groupby>'+'</tree>',groupBy:['bar','currency_id'],});assert.containsN(list,'.o_group_header',2,"there should be 2 group headers");assert.containsNone(list,'.o_group_header button',"there should be no button in the header");await testUtils.dom.click(list.$('.o_group_header:eq(0)'));assert.containsN(list,'tbody:eq(1) .o_group_header',2,"there should be 2 inner groups header");assert.containsNone(list,'tbody:eq(1) .o_group_header button',"there should be no button in the header");await testUtils.dom.click(list.$('tbody:eq(1) .o_group_header:eq(0)'));assert.containsOnce(list,'.o_group_header button',"there should be one button in the header");list.destroy();});QUnit.test('groupby node with a button with modifiers',async function(assert){assert.expect(11);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<groupby name="currency_id">'+'<field name="position"/>'+'<button string="Button 1" type="object" name="button_method" attrs=\'{"invisible": [("position", "=", "after")]}\'/>'+'</groupby>'+'</tree>',mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='read'&&args.model==='res_currency'){assert.deepEqual(args.args,[[2,1],['position']]);}
return this._super.apply(this,arguments);},groupBy:['currency_id'],});assert.verifySteps(['web_read_group','read']);await testUtils.dom.click(list.$('.o_group_header:eq(0)'));assert.verifySteps(['/web/dataset/search_read']);assert.containsOnce(list,'.o_group_header button.o_invisible_modifier',"the first group (EUR) should have an invisible button");await testUtils.dom.click(list.$('.o_group_header:eq(1)'));assert.verifySteps(['/web/dataset/search_read']);assert.containsN(list,'.o_group_header button',2,"there should be two buttons (one by header)");assert.doesNotHaveClass(list,'.o_group_header:eq(1) button','o_invisible_modifier',"the second header button should be visible");list.destroy();});QUnit.test('reload list view with groupby node',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree expand="1">'+'<field name="foo"/>'+'<groupby name="currency_id">'+'<field name="position"/>'+'<button string="Button 1" type="object" name="button_method" attrs=\'{"invisible": [("position", "=", "after")]}\'/>'+'</groupby>'+'</tree>',groupBy:['currency_id'],});assert.containsOnce(list,'.o_group_header button:not(.o_invisible_modifier)',"there should be one visible button");await list.reload({domain:[]});assert.containsOnce(list,'.o_group_header button:not(.o_invisible_modifier)',"there should still be one visible button");list.destroy();});QUnit.test('editable list view with groupby node and modifiers',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree expand="1" editable="bottom">'+'<field name="foo"/>'+'<groupby name="currency_id">'+'<field name="position"/>'+'<button string="Button 1" type="object" name="button_method" attrs=\'{"invisible": [("position", "=", "after")]}\'/>'+'</groupby>'+'</tree>',groupBy:['currency_id'],});assert.doesNotHaveClass(list.$('.o_data_row:first'),'o_selected_row',"first row should be in readonly mode");await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row',"the row should be in edit mode");await testUtils.fields.triggerKeydown($(document.activeElement),'escape');assert.doesNotHaveClass(list.$('.o_data_row:first'),'o_selected_row',"the row should be back in readonly mode");list.destroy();});QUnit.test('groupby node with edit button',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree expand="1">'+'<field name="foo"/>'+'<groupby name="currency_id">'+'<button string="Button 1" type="edit" name="edit"/>'+'</groupby>'+'</tree>',groupBy:['currency_id'],intercepts:{do_action:function(event){assert.deepEqual(event.data.action,{context:{create:false},res_id:2,res_model:'res_currency',type:'ir.actions.act_window',views:[[false,'form']],flags:{mode:'edit'},},"should trigger do_action with correct action parameter");}},});await testUtils.dom.click(list.$('.o_group_header:eq(0) button'));list.destroy();});QUnit.test('groupby node with subfields, and onchange',async function(assert){assert.expect(1);this.data.foo.onchanges={foo:function(){},};const list=await createView({View:ListView,model:'foo',data:this.data,arch:`<tree editable="bottom" expand="1">
                    <field name="foo"/>
                    <field name="currency_id"/>
                    <groupby name="currency_id">
                        <field name="position" invisible="1"/>
                    </groupby>
                </tree>`,groupBy:['currency_id'],mockRPC:function(route,args){if(args.method==='onchange'){assert.deepEqual(args.args[3],{foo:"1",currency_id:"",},'onchange spec should not follow relation of many2one fields');}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:first'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),"new value");list.destroy();});QUnit.test('list view, editable, without data',async function(assert){assert.expect(12);this.data.foo.records=[];this.data.foo.fields.date.default="2017-02-10";var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree string="Phonecalls" editable="top">'+'<field name="date"/>'+'<field name="m2o"/>'+'<field name="foo"/>'+'<button type="object" icon="fa-plus-square" name="method"/>'+'</tree>',viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'}},mockRPC:function(route,args){if(args.method==='create'){assert.ok(true,"should have created a record");}
return this._super.apply(this,arguments);},});assert.containsOnce(list,'.o_view_nocontent',"should have a no content helper displayed");assert.containsNone(list,'div.table-responsive',"should not have a div.table-responsive");assert.containsNone(list,'table',"should not have rendered a table");await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsNone(list,'.o_view_nocontent',"should not have a no content helper displayed");assert.containsOnce(list,'table',"should have rendered a table");assert.hasClass(list.$('tbody tr:eq(0)'),'o_selected_row',"the date field td should be in edit mode");assert.strictEqual(list.$('tbody tr:eq(0) td:eq(1)').text().trim(),"","the date field td should not have any content");assert.strictEqual(list.$('tr.o_selected_row .o_list_record_selector input').prop('disabled'),true,"record selector checkbox should be disabled while the record is not yet created");assert.strictEqual(list.$('.o_list_button button').prop('disabled'),true,"buttons should be disabled while the record is not yet created");await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('tbody tr:eq(0) .o_list_record_selector input').prop('disabled'),false,"record selector checkbox should not be disabled once the record is created");assert.strictEqual(list.$('.o_list_button button').prop('disabled'),false,"buttons should not be disabled once the record is created");list.destroy();});QUnit.test('list view, editable, with a button',async function(assert){assert.expect(1);this.data.foo.records=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree string="Phonecalls" editable="top">'+'<field name="foo"/>'+'<button string="abc" icon="fa-phone" type="object" name="schedule_another_phonecall"/>'+'</tree>',});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsOnce(list,'table button.o_icon_button i.fa-phone',"should have rendered a button");list.destroy();});QUnit.test('list view with a button without icon',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree string="Phonecalls" editable="top">'+'<field name="foo"/>'+'<button string="abc" type="object" name="schedule_another_phonecall"/>'+'</tree>',});assert.strictEqual(list.$('table button').first().text(),'abc',"should have rendered a button with string attribute as label");list.destroy();});QUnit.test('list view, editable, can discard',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree string="Phonecalls" editable="top">'+'<field name="foo"/>'+'</tree>',});assert.strictEqual(list.$('td:not(.o_list_record_selector) input').length,0,"no input should be in the table");await testUtils.dom.click(list.$('tbody td:not(.o_list_record_selector):first'));assert.strictEqual(list.$('td:not(.o_list_record_selector) input').length,1,"first cell should be editable");assert.ok(list.$buttons.find('.o_list_button_discard').is(':visible'),"discard button should be visible");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.strictEqual(list.$('td:not(.o_list_record_selector) input').length,0,"no input should be in the table");assert.ok(!list.$buttons.find('.o_list_button_discard').is(':visible'),"discard button should not be visible");list.destroy();});QUnit.test('editable list view, click on the list to save',async function(assert){assert.expect(3);this.data.foo.fields.date.default="2017-02-10";this.data.foo.records=[];var createCount=0;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree string="Phonecalls" editable="top">'+'<field name="date"/>'+'</tree>',mockRPC:function(route,args){if(args.method==='create'){createCount++;}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));await testUtils.dom.click(list.$('.o_list_view'));assert.strictEqual(createCount,1,"should have created a record");await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));await testUtils.dom.click(list.$('tfoot'));assert.strictEqual(createCount,2,"should have created a record");await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));await testUtils.dom.click(list.$('tbody tr').last());assert.strictEqual(createCount,3,"should have created a record");list.destroy();});QUnit.test('click on a button in a list view',async function(assert){assert.expect(9);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<button string="a button" name="button_action" icon="fa-car" type="object"/>'+'</tree>',mockRPC:function(route){assert.step(route);return this._super.apply(this,arguments);},intercepts:{execute_action:function(event){assert.deepEqual(event.data.env.currentID,1,'should call with correct id');assert.strictEqual(event.data.env.model,'foo','should call with correct model');assert.strictEqual(event.data.action_data.name,'button_action',"should call correct method");assert.strictEqual(event.data.action_data.type,'object','should have correct type');event.data.on_closed();},},});assert.containsN(list,'tbody .o_list_button',4,"there should be one button per row");assert.containsOnce(list,'tbody .o_list_button:first .o_icon_button .fa.fa-car','buttons should have correct icon');await testUtils.dom.click(list.$('tbody .o_list_button:first > button'));assert.verifySteps(['/web/dataset/search_read','/web/dataset/search_read'],"should have reloaded the view (after the action is complete)");list.destroy();});QUnit.test('invisible attrs in readonly and editable list',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<button string="a button" name="button_action" icon="fa-car" '+'type="object" attrs="{\'invisible\': [(\'id\',\'=\', 1)]}"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'<field name="foo" attrs="{\'invisible\': [(\'id\',\'=\', 1)]}"/>'+'</tree>',});assert.equal(list.$('tbody tr:nth(0) td:nth(4)').html(),"","td that contains an invisible field should be empty");assert.hasClass(list.$('tbody tr:nth(0) td:nth(1) button'),"o_invisible_modifier","button with invisible attrs should be properly hidden");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2)'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(4) input.o_invisible_modifier').length,1,"td that contains an invisible field should not be empty in edition");assert.hasClass(list.$('tbody tr:nth(0) td:nth(1) button'),"o_invisible_modifier","button with invisible attrs should be properly hidden");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(4)'));assert.hasClass(list.$('tbody tr:nth(0)'),'o_selected_row',"first row should be in edition");list.destroy();});QUnit.test('monetary fields are properly rendered',async function(assert){assert.expect(3);var currencies={};_.each(this.data.res_currency.records,function(currency){currencies[currency.id]=currency;});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="id"/>'+'<field name="amount"/>'+'<field name="currency_id" invisible="1"/>'+'</tree>',session:{currencies:currencies,},});assert.containsN(list,'tbody tr:first td',3,"currency_id column should not be in the table");assert.strictEqual(list.$('tbody tr:first td:nth(2)').text().replace(/\s/g,' '),'1200.00 €',"currency_id column should not be in the table");assert.strictEqual(list.$('tbody tr:nth(1) td:nth(2)').text().replace(/\s/g,' '),'$ 500.00',"currency_id column should not be in the table");list.destroy();});QUnit.test('simple list with date and datetime',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="date"/><field name="datetime"/></tree>',session:{getTZOffset:function(){return 120;},},});assert.strictEqual(list.$('td:eq(1)').text(),"01/25/2017","should have formatted the date");assert.strictEqual(list.$('td:eq(2)').text(),"12/12/2016 12:55:05","should have formatted the datetime");list.destroy();});QUnit.test('edit a row by clicking on a readonly field',async function(assert){assert.expect(9);this.data.foo.fields.foo.readonly=true;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field"/></tree>',});assert.hasClass(list.$('.o_data_row:first td:nth(1)'),'o_readonly_modifier',"foo field cells should have class 'o_readonly_modifier'");await testUtils.dom.click(list.$('.o_data_row:first td:nth(1)'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row',"first row should be selected");var $cell=list.$('.o_data_row:first td:nth(1)');assert.hasClass($cell,'o_readonly_modifier');assert.hasClass($cell.parent(),'o_selected_row');assert.strictEqual(list.$('.o_data_row:first td:nth(1) span').text(),'yop',"a widget should have been rendered for readonly fields");assert.hasClass(list.$('.o_data_row:first td:nth(2)').parent(),'o_selected_row',"field 'int_field' should be in edition");assert.strictEqual(list.$('.o_data_row:first td:nth(2) input').length,1,"a widget for field 'int_field should have been rendered'");await testUtils.dom.click(list.$('.o_data_row:first td:nth(1)'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row',"first row should be selected");assert.strictEqual(list.$('.o_data_row:first td:nth(2) input').length,1,"a widget for field 'int_field' should have been rendered (only once)");list.destroy();});QUnit.test('list view with nested groups',async function(assert){assert.expect(42);this.data.foo.records.push({id:5,foo:"blip",int_field:-7,m2o:1});this.data.foo.records.push({id:6,foo:"blip",int_field:5,m2o:2});var nbRPCs={readGroup:0,searchRead:0};var envIDs=[];var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="id"/><field name="int_field"/></tree>',groupBy:['m2o','foo'],mockRPC:function(route,args){if(args.method==='web_read_group'){if(args.kwargs.groupby[0]==='foo'){assert.deepEqual(args.kwargs.domain,[['m2o','=',1]],"nested read_group should be called with correct domain");}
nbRPCs.readGroup++;}else if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,[['foo','=','blip'],['m2o','=',1]],"nested search_read should be called with correct domain");nbRPCs.searchRead++;}
return this._super.apply(this,arguments);},intercepts:{switch_view:function(event){assert.strictEqual(event.data.res_id,4,"'switch_view' event has been triggered");},},});assert.strictEqual(nbRPCs.readGroup,1,"should have done one read_group");assert.strictEqual(nbRPCs.searchRead,0,"should have done no search_read");assert.deepEqual(list.exportState().resIds,envIDs);assert.containsOnce(list,'tbody',"there should be 1 tbody");assert.containsN(list,'.o_group_header',2,"should contain 2 groups at first level");assert.strictEqual(list.$('.o_group_name:first').text(),'Value 1 (4)',"group should have correct name and count");assert.containsN(list,'.o_group_name .fa-caret-right',2,"the carret of closed groups should be right");assert.strictEqual(list.$('.o_group_name:first span').css('padding-left'),'2px',"groups of level 1 should have a 2px padding-left");assert.strictEqual(list.$('.o_group_header:first td:last').text(),'16',"group aggregates are correctly displayed");nbRPCs={readGroup:0,searchRead:0};await testUtils.dom.click(list.$('.o_group_header:first'));assert.strictEqual(nbRPCs.readGroup,1,"should have done one read_group");assert.strictEqual(nbRPCs.searchRead,0,"should have done no search_read");assert.deepEqual(list.exportState().resIds,envIDs);var $openGroup=list.$('tbody:nth(1)');assert.strictEqual(list.$('.o_group_name:first').text(),'Value 1 (4)',"group should have correct name and count (of records, not inner subgroups)");assert.containsN(list,'tbody',3,"there should be 3 tbodys");assert.containsOnce(list,'.o_group_name:first .fa-caret-down',"the carret of open groups should be down");assert.strictEqual($openGroup.find('.o_group_header').length,3,"open group should contain 3 groups");assert.strictEqual($openGroup.find('.o_group_name:nth(2)').text(),'blip (2)',"group should have correct name and count");assert.strictEqual($openGroup.find('.o_group_name:nth(2) span').css('padding-left'),'22px',"groups of level 2 should have a 22px padding-left");assert.strictEqual($openGroup.find('.o_group_header:nth(2) td:last').text(),'-11',"inner group aggregates are correctly displayed");nbRPCs={readGroup:0,searchRead:0};envIDs=[4,5];await testUtils.dom.click($openGroup.find('.o_group_header:nth(2)'));assert.strictEqual(nbRPCs.readGroup,0,"should have done no read_group");assert.strictEqual(nbRPCs.searchRead,1,"should have done one search_read");assert.deepEqual(list.exportState().resIds,envIDs);var $openSubGroup=list.$('tbody:nth(2)');assert.containsN(list,'tbody',4,"there should be 4 tbodys");assert.strictEqual($openSubGroup.find('.o_data_row').length,2,"open subgroup should contain 2 data rows");assert.strictEqual($openSubGroup.find('.o_data_row:first td:last').text(),'-4',"first record in open subgroup should be res_id 4 (with int_field -4)");await testUtils.dom.click($openSubGroup.find('.o_data_row:first'));nbRPCs={readGroup:0,searchRead:0};envIDs=[5,4];await testUtils.dom.click(list.$('thead th:last'));assert.strictEqual(nbRPCs.readGroup,2,"should have done two read_groups");assert.strictEqual(nbRPCs.searchRead,1,"should have done one search_read");assert.deepEqual(list.exportState().resIds,envIDs);$openSubGroup=list.$('tbody:nth(2)');assert.containsN(list,'tbody',4,"there should be 4 tbodys");assert.strictEqual($openSubGroup.find('.o_data_row').length,2,"open subgroup should contain 2 data rows");assert.strictEqual($openSubGroup.find('.o_data_row:first td:last').text(),'-7',"first record in open subgroup should be res_id 5 (with int_field -7)");nbRPCs={readGroup:0,searchRead:0};envIDs=[];await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.strictEqual(nbRPCs.readGroup,0,"should have done no read_group");assert.strictEqual(nbRPCs.searchRead,0,"should have done no search_read");assert.deepEqual(list.exportState().resIds,envIDs);assert.containsOnce(list,'tbody',"there should be 1 tbody");assert.containsN(list,'.o_group_header',2,"should contain 2 groups at first level");assert.containsN(list,'.o_group_name .fa-caret-right',2,"the carret of closed groups should be right");list.destroy();});QUnit.test('grouped list on selection field at level 2',async function(assert){assert.expect(4);this.data.foo.fields.priority={string:"Priority",type:"selection",selection:[[1,"Low"],[2,"Medium"],[3,"High"]],default:1,};this.data.foo.records.push({id:5,foo:"blip",int_field:-7,m2o:1,priority:2});this.data.foo.records.push({id:6,foo:"blip",int_field:5,m2o:1,priority:3});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="id"/><field name="int_field"/></tree>',groupBy:['m2o','priority'],});assert.containsN(list,'.o_group_header',2,"should contain 2 groups at first level");await testUtils.dom.click(list.$('.o_group_header:first'));var $openGroup=list.$('tbody:nth(1)');assert.strictEqual($openGroup.find('tr').length,3,"should have 3 subgroups");assert.strictEqual($openGroup.find('tr').length,3,"should have 3 subgroups");assert.strictEqual($openGroup.find('.o_group_name:first').text(),'Low (3)',"should display the selection name in the group header");list.destroy();});QUnit.test('grouped list with a pager in a group',async function(assert){assert.expect(6);this.data.foo.records[3].bar=true;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],viewOptions:{limit:3,},});var headerHeight=list.$('.o_group_header').css('height');await testUtils.dom.click(list.$('.o_group_header'));assert.strictEqual(list.$('.o_group_header').css('height'),headerHeight,"height of group header shouldn't have changed");assert.hasClass(list.$('.o_group_header th:eq(1) > nav'),'o_pager',"last cell of open group header should have classname 'o_pager'");assert.strictEqual(cpHelpers.getPagerValue('.o_group_header'),'1-3',"pager's value should be correct");assert.containsN(list,'.o_data_row',3,"open group should display 3 records");await cpHelpers.pagerNext('.o_group_header');assert.strictEqual(cpHelpers.getPagerValue('.o_group_header'),'4-4',"pager's value should be correct");assert.containsOnce(list,'.o_data_row',"open group should display 1 record");list.destroy();});QUnit.test('edition: create new line, then discard',async function(assert){assert.expect(11);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="bar"/></tree>',});assert.containsN(list,'tr.o_data_row',4,"should have 4 records");assert.strictEqual(list.$buttons.find('.o_list_button_add:visible').length,1,"create button should be visible");assert.strictEqual(list.$buttons.find('.o_list_button_discard:visible').length,0,"discard button should be hidden");assert.containsN(list,'.o_list_record_selector input:enabled',5);await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.strictEqual(list.$buttons.find('.o_list_button_add:visible').length,0,"create button should be hidden");assert.strictEqual(list.$buttons.find('.o_list_button_discard:visible').length,1,"discard button should be visible");assert.containsNone(list,'.o_list_record_selector input:enabled');await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.containsN(list,'tr.o_data_row',4,"should still have 4 records");assert.strictEqual(list.$buttons.find('.o_list_button_add:visible').length,1,"create button should be visible again");assert.strictEqual(list.$buttons.find('.o_list_button_discard:visible').length,0,"discard button should be hidden again");assert.containsN(list,'.o_list_record_selector input:enabled',5);list.destroy();});QUnit.test('invisible attrs on fields are re-evaluated on field change',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo" attrs="{\'invisible\': [[\'bar\', \'=\', True]]}"/>'+'<field name="bar"/>'+'</tree>',});assert.containsN(list,'tbody td.o_invisible_modifier',3,"there should be 3 invisible foo cells in readonly mode");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(1)'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"].o_invisible_modifier').length,1,"the foo field widget should have been rendered as invisible");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"]:not(.o_invisible_modifier)').length,1,"the foo field widget should have been marked as non-invisible");assert.containsN(list,'tbody td.o_invisible_modifier',2,"the foo field widget parent cell should not be invisible anymore");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"].o_invisible_modifier').length,1,"the foo field widget should have been marked as invisible again");assert.containsN(list,'tbody td.o_invisible_modifier',3,"the foo field widget parent cell should now be invisible again");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));await testUtils.dom.click(list.$('thead'));assert.containsN(list,'tbody td.o_invisible_modifier',2,"there should be 2 invisible foo cells in readonly mode");list.destroy();});QUnit.test('readonly attrs on fields are re-evaluated on field change',async function(assert){assert.expect(9);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo" attrs="{\'readonly\': [[\'bar\', \'=\', True]]}"/>'+'<field name="bar"/>'+'</tree>',});assert.containsN(list,'tbody td.o_readonly_modifier',3,"there should be 3 readonly foo cells in readonly mode");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(1)'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > span[name="foo"]').length,1,"the foo field widget should have been rendered as readonly");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"]').length,1,"the foo field widget should have been rerendered as editable");assert.containsN(list,'tbody td.o_readonly_modifier',2,"the foo field widget parent cell should not be readonly anymore");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > span[name="foo"]').length,1,"the foo field widget should have been rerendered as readonly");assert.containsN(list,'tbody td.o_readonly_modifier',3,"the foo field widget parent cell should now be readonly again");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"]').length,1,"the foo field widget should have been rerendered as editable again");assert.containsN(list,'tbody td.o_readonly_modifier',2,"the foo field widget parent cell should not be readonly again");await testUtils.dom.click(list.$el);assert.containsN(list,'tbody td.o_readonly_modifier',2,"there should be 2 readonly foo cells in readonly mode");list.destroy();});QUnit.test('required attrs on fields are re-evaluated on field change',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo" attrs="{\'required\': [[\'bar\', \'=\', True]]}"/>'+'<field name="bar"/>'+'</tree>',});assert.containsN(list,'tbody td.o_required_modifier',3,"there should be 3 required foo cells in readonly mode");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(1)'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"].o_required_modifier').length,1,"the foo field widget should have been rendered as required");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"]:not(.o_required_modifier)').length,1,"the foo field widget should have been marked as non-required");assert.containsN(list,'tbody td.o_required_modifier',2,"the foo field widget parent cell should not be required anymore");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));assert.strictEqual(list.$('tbody tr:nth(0) td:nth(1) > input[name="foo"].o_required_modifier').length,1,"the foo field widget should have been marked as required again");assert.containsN(list,'tbody td.o_required_modifier',3,"the foo field widget parent cell should now be required again");await testUtils.dom.click(list.$('tbody tr:nth(0) td:nth(2) input'));await testUtils.dom.click(list.$('thead'));assert.containsN(list,'tbody td.o_required_modifier',2,"there should be 2 required foo cells in readonly mode");list.destroy();});QUnit.test('leaving unvalid rows in edition',async function(assert){assert.expect(4);var warnings=0;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo" required="1"/>'+'<field name="bar"/>'+'</tree>',services:{notification:NotificationService.extend({notify:function(params){if(params.type==='danger'){warnings++;}}}),},});var $firstFooTd=list.$('tbody tr:nth(0) td:nth(1)');await testUtils.dom.click($firstFooTd);await testUtils.fields.editInput($firstFooTd.find('input'),"");var $secondFooTd=list.$('tbody tr:nth(1) td:nth(1)');await testUtils.dom.click($secondFooTd);await testUtils.nextTick();assert.strictEqual($firstFooTd.parent('.o_selected_row').length,1,"first line should still be in edition as invalid");assert.containsOnce(list,'tbody tr.o_selected_row',"no other line should be in edition");assert.strictEqual($firstFooTd.find('input.o_field_invalid').length,1,"the required field should be marked as invalid");assert.strictEqual(warnings,1,"a warning should have been displayed");list.destroy();});QUnit.test('open a virtual id',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'event',data:this.data,arch:'<tree><field name="name"/></tree>',});testUtils.mock.intercept(list,'switch_view',function(event){assert.deepEqual(_.pick(event.data,'mode','model','res_id','view_type'),{mode:'readonly',model:'event',res_id:'2-20170808020000',view_type:'form',},"should trigger a switch_view event to the form view for the record virtual id");});testUtils.dom.click(list.$('td:contains(virtual)'));list.destroy();});QUnit.test('pressing enter on last line of editable list view',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',mockRPC:function(route){assert.step(route);return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('td:contains(gnap)'));assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row',"3rd row should be selected");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'enter');assert.hasClass(list.$('tr.o_data_row:eq(3)'),'o_selected_row',"4rd row should be selected");assert.doesNotHaveClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row',"3rd row should no longer be selected");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'enter');assert.containsN(list,'tr.o_data_row',5,"should have created a 5th row");assert.verifySteps(['/web/dataset/search_read','/web/dataset/call_kw/foo/onchange']);list.destroy();});QUnit.test('pressing tab on last cell of editable list view',async function(assert){assert.expect(9);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field"/></tree>',mockRPC:function(route){assert.step(route);return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('td:contains(blip)').last());assert.strictEqual(document.activeElement.name,"foo","focus should be on an input with name = foo");document.activeElement.value="blip-changed";$(document.activeElement).trigger({type:'change'});await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.strictEqual(document.activeElement.name,"int_field","focus should be on an input with name = int_field");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.hasClass(list.$('tr.o_data_row:eq(4)'),'o_selected_row',"5th row should be selected");assert.strictEqual(document.activeElement.name,"foo","focus should be on an input with name = foo");assert.verifySteps(['/web/dataset/search_read','/web/dataset/call_kw/foo/write','/web/dataset/call_kw/foo/read','/web/dataset/call_kw/foo/onchange']);list.destroy();});QUnit.test('navigation with tab and read completes after default_get',async function(assert){assert.expect(8);var onchangeGetPromise=testUtils.makeTestPromise();var readPromise=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field"/></tree>',mockRPC:function(route,args){if(args.method){assert.step(args.method);}
var result=this._super.apply(this,arguments);if(args.method==='read'){return readPromise.then(function(){return result;});}
if(args.method==='onchange'){return onchangeGetPromise.then(function(){return result;});}
return result;},});await testUtils.dom.click(list.$('td:contains(-4)').last());await testUtils.fields.editInput(list.$('tr.o_selected_row input[name="int_field"]'),'1234');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="int_field"]'),'tab');onchangeGetPromise.resolve();assert.containsN(list,'tbody tr.o_data_row',4,"should have 4 data rows");readPromise.resolve();await testUtils.nextTick();assert.containsN(list,'tbody tr.o_data_row',5,"should have 5 data rows");assert.strictEqual(list.$('td:contains(1234)').length,1,"should have a cell with new value");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.hasClass(list.$('tr.o_data_row:eq(4)'),'o_selected_row',"5th row should be selected");assert.verifySteps(['write','read','onchange']);list.destroy();});QUnit.test('display toolbar',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'event',data:this.data,arch:'<tree><field name="name"/></tree>',toolbar:{action:[{model_name:'event',name:'Action event',type:'ir.actions.server',usage:'ir_actions_server',}],print:[],},viewOptions:{hasActionMenus:true,},});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');await testUtils.dom.click(list.$('.o_list_record_selector:first input'));await cpHelpers.toggleActionMenu(list);assert.deepEqual(cpHelpers.getMenuItemTexts(list),['Delete','Action event']);list.destroy();});QUnit.test('execute ActionMenus actions with correct params (single page)',async function(assert){assert.expect(12);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',toolbar:{action:[{id:44,name:'Custom Action',type:'ir.actions.server',}],print:[],},mockRPC:function(route,args){if(route==='/web/action/load'){assert.step(JSON.stringify(args));return Promise.resolve({});}
return this._super(...arguments);},viewOptions:{hasActionMenus:true,},});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'.o_data_row',4);await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsN(list,'.o_list_record_selector input:checked',5);assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Custom Action");await testUtils.dom.click(list.$('tbody .o_list_record_selector:first input'));assert.containsN(list,'.o_list_record_selector input:checked',3);await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Custom Action");await list.reload({domain:[['bar','=',true]]});assert.containsN(list,'.o_data_row',3);assert.containsNone(list,'.o_list_record_selector input:checked');await testUtils.dom.click(list.$('tbody .o_list_record_selector:nth(0) input'));await testUtils.dom.click(list.$('tbody .o_list_record_selector:nth(1) input'));assert.containsN(list,'.o_list_record_selector input:checked',2);await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Custom Action");assert.verifySteps(['{"action_id":44,"context":{"active_id":1,"active_ids":[1,2,3,4],"active_model":"foo","active_domain":[]}}','{"action_id":44,"context":{"active_id":2,"active_ids":[2,3,4],"active_model":"foo","active_domain":[]}}','{"action_id":44,"context":{"active_id":1,"active_ids":[1,2],"active_model":"foo","active_domain":[["bar","=",true]]}}',]);list.destroy();});QUnit.test('execute ActionMenus actions with correct params (multi pages)',async function(assert){assert.expect(13);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="2"><field name="foo"/></tree>',toolbar:{action:[{id:44,name:'Custom Action',type:'ir.actions.server',}],print:[],},mockRPC:function(route,args){if(route==='/web/action/load'){assert.step(JSON.stringify(args));return Promise.resolve({});}
return this._super(...arguments);},viewOptions:{hasActionMenus:true,},});assert.containsNone(list.el,'div.o_control_panel .o_cp_action_menus');assert.containsN(list,'.o_data_row',2);await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsN(list,'.o_list_record_selector input:checked',3);assert.containsOnce(list,'.o_list_selection_box .o_list_select_domain');assert.containsOnce(list.el,'div.o_control_panel .o_cp_action_menus');await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Custom Action");await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));assert.containsN(list,'.o_list_record_selector input:checked',3);await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Custom Action");await list.reload({domain:[['bar','=',true]]});assert.containsNone(list,'.o_list_selection_box .o_list_select_domain');await testUtils.dom.click(list.$('thead .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));assert.containsN(list,'.o_list_record_selector input:checked',3);assert.containsNone(list,'.o_list_selection_box .o_list_select_domain');await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Custom Action");assert.verifySteps(['{"action_id":44,"context":{"active_id":1,"active_ids":[1,2],"active_model":"foo","active_domain":[]}}','{"action_id":44,"context":{"active_id":1,"active_ids":[1,2,3,4],"active_model":"foo","active_domain":[]}}','{"action_id":44,"context":{"active_id":1,"active_ids":[1,2,3],"active_model":"foo","active_domain":[["bar","=",true]]}}',]);list.destroy();});QUnit.test('edit list line after line deletion',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="int_field"/></tree>',});await testUtils.dom.click(list.$('.o_data_row:nth(2) > td:not(.o_list_record_selector)').first());assert.ok(list.$('.o_data_row:nth(2)').is('.o_selected_row'),"third row should be in edition");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.ok(list.$('.o_data_row:nth(0)').is('.o_selected_row'),"first row should be in edition (creation)");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.containsNone(list,'.o_selected_row',"no row should be selected");await testUtils.dom.click(list.$('.o_data_row:nth(2) > td:not(.o_list_record_selector)').first());assert.ok(list.$('.o_data_row:nth(2)').is('.o_selected_row'),"third row should be in edition");assert.containsOnce(list,'.o_selected_row',"no other row should be selected");list.destroy();});QUnit.test('pressing TAB in editable list with several fields [REQUIRE FOCUS]',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_cell:first'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:first .o_data_cell:first input')[0]);await testUtils.fields.triggerKeydown(list.$('.o_selected_row input[name="foo"]'),'tab');assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:first .o_data_cell:last input')[0]);await testUtils.fields.triggerKeydown(list.$('.o_selected_row input[name="int_field"]'),'tab');assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(1) .o_data_cell:first input')[0]);list.destroy();});QUnit.test('pressing SHIFT-TAB in editable list with several fields [REQUIRE FOCUS]',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:nth(2) .o_data_cell:nth(1)'));assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(2) .o_data_cell:last input')[0]);list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(2) .o_data_cell:first input')[0]);list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(1) .o_data_cell:last input')[0]);list.destroy();});QUnit.test('navigation with tab and readonly field (no modification)',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field" readonly="1"/></tree>',});await testUtils.dom.click(list.$('td:contains(yop)').last());await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row',"2nd row should be selected");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row',"3rd row should be selected");list.destroy();});QUnit.test('navigation with tab and readonly field (with modification)',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field" readonly="1"/></tree>',});await testUtils.dom.click(list.$('td:contains(yop)'));testUtils.fields.editAndTrigger($(document.activeElement),'blip-changed',['change']);await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row',"2nd row should be selected");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row',"3rd row should be selected");list.destroy();});QUnit.test('navigation with tab on a list with create="0"',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom" create="0">'+'<field name="display_name"/>'+'</tree>',});assert.containsN(list,'.o_data_row',4,"the list should contain 4 rows");await testUtils.dom.click(list.$('.o_data_row:nth(2) .o_data_cell:first'));assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row',"third row should be in edition");await testUtils.fields.editInput(list.$('.o_selected_row input').eq(1),11);await testUtils.fields.triggerKeydown(list.$('.o_selected_row input[name="display_name"]'),'tab');assert.hasClass(list.$('.o_data_row:nth(3)'),'o_selected_row',"fourth row should be in edition");await testUtils.fields.editInput(list.$('.o_selected_row input').eq(1),11);await testUtils.fields.triggerKeydown(list.$('.o_selected_row input[name="display_name"]'),'tab');assert.hasClass(list.$('.o_data_row:first'),'o_selected_row',"first row should be in edition");list.destroy();});QUnit.test('navigation with tab on a one2many list with create="0"',async function(assert){assert.expect(4);this.data.foo.records[0].o2m=[1,2];var form=await createView({View:FormView,model:'foo',data:this.data,arch:'<form><sheet>'+'<field name="o2m">'+'<tree editable="bottom" create="0">'+'<field name="display_name"/>'+'</tree>'+'</field>'+'<field name="foo"/>'+'</sheet></form>',res_id:1,viewOptions:{mode:'edit',},});assert.containsN(form,'.o_field_widget[name=o2m] .o_data_row',2,"there should be two records in the many2many");await testUtils.dom.click(form.$('.o_field_widget[name=o2m] .o_data_cell:first'));assert.hasClass(form.$('.o_field_widget[name=o2m] .o_data_row:first'),'o_selected_row',"first row should be in edition");await testUtils.fields.triggerKeydown(form.$('.o_field_widget[name=o2m] .o_selected_row input'),'tab');assert.hasClass(form.$('.o_field_widget[name=o2m] .o_data_row:nth(1)'),'o_selected_row',"second row should be in edition");await testUtils.fields.triggerKeydown(form.$('.o_field_widget[name=o2m] .o_selected_row input'),'tab');await testUtils.owlCompatibilityNextTick();assert.strictEqual(document.activeElement,form.$('input[name="foo"]')[0],"the next field should be selected");form.destroy();});QUnit.test('edition, then navigation with tab (with a readonly field)',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field" readonly="1"/></tree>',mockRPC:function(route,args){if(args.method){assert.step(args.method);}
return this._super.apply(this,arguments);},fieldDebounce:1,});await testUtils.dom.click(list.$('td:contains(yop)'));await testUtils.fields.editSelect(list.$('tr.o_selected_row input[name="foo"]'),'new value');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.strictEqual(list.$('tbody tr:first td:contains(new value)').length,1,"should have the new value visible in dom");assert.verifySteps(["write","read"]);list.destroy();});QUnit.test('edition, then navigation with tab (with a readonly field and onchange)',async function(assert){assert.expect(4);this.data.bar.onchanges={o2m:function(){},};this.data.bar.fields.o2m={string:"O2M field",type:"one2many",relation:"foo"};this.data.bar.records[0].o2m=[1,4];var form=await createView({View:FormView,model:'bar',res_id:1,data:this.data,arch:'<form>'+'<group>'+'<field name="display_name"/>'+'<field name="o2m">'+'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="date" readonly="1"/>'+'<field name="int_field"/>'+'</tree>'+'</field>'+'</group>'+'</form>',mockRPC:function(route,args){if(args.method==='onchange'){assert.step(args.method+':'+args.model);}
return this._super.apply(this,arguments);},fieldDebounce:1,viewOptions:{mode:'edit',},});var jq_evspecial_focus_trigger=$.event.special.focus.trigger;$.event.special.focus.trigger=function(){if(this!==document.activeElement&&this.focus){var activeElement=document.activeElement;this.focus();$(activeElement).trigger('change');}};await testUtils.dom.click(form.$('.o_data_cell:contains(yop)'));assert.strictEqual(document.activeElement,form.$('tr.o_selected_row input[name="foo"]')[0],"focus should be on an input with name = foo");await testUtils.fields.editInput(form.$('tr.o_selected_row input[name="foo"]'),'new value');var tabEvent=$.Event("keydown",{which:$.ui.keyCode.TAB});await testUtils.dom.triggerEvents(form.$('tr.o_selected_row input[name="foo"]'),[tabEvent]);assert.strictEqual(document.activeElement,form.$('tr.o_selected_row input[name="int_field"]')[0],"focus should be on an input with name = int_field");$.event.special.focus.trigger=jq_evspecial_focus_trigger;assert.verifySteps(["onchange:bar"],"onchange method should have been called");form.destroy();});QUnit.test('pressing SHIFT-TAB in editable list with a readonly field [REQUIRE FOCUS]',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="int_field" readonly="1"/>'+'<field name="qux"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:nth(2) .o_data_cell:nth(2)'));assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(2) .o_data_cell input[name=qux]')[0]);$(document.activeElement).trigger({type:'keydown',which:$.ui.keyCode.TAB,shiftKey:true});await testUtils.nextTick();assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(2) .o_data_cell input[name=foo]')[0]);list.destroy();});QUnit.test('pressing SHIFT-TAB in editable list with a readonly field in first column [REQUIRE FOCUS]',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="int_field" readonly="1"/>'+'<field name="foo"/>'+'<field name="qux"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:nth(2) .o_data_cell:nth(1)'));assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(2) .o_data_cell input[name=foo]')[0]);$(document.activeElement).trigger({type:'keydown',which:$.ui.keyCode.TAB,shiftKey:true});await testUtils.nextTick();assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(1) .o_data_cell input[name=qux]')[0]);list.destroy();});QUnit.test('pressing SHIFT-TAB in editable list with a readonly field in last column [REQUIRE FOCUS]',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="int_field"/>'+'<field name="foo"/>'+'<field name="qux" readonly="1"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:nth(2) .o_data_cell:first'));assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(2) .o_data_cell input[name=int_field]')[0]);$(document.activeElement).trigger({type:'keydown',which:$.ui.keyCode.TAB,shiftKey:true});await testUtils.nextTick();assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');assert.strictEqual(document.activeElement,list.$('.o_data_row:nth(1) .o_data_cell input[name=foo]')[0]);list.destroy();});QUnit.test('skip invisible fields when navigating list view with TAB',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="bar" invisible="1"/>'+'<field name="int_field"/>'+'</tree>',res_id:1,});await testUtils.dom.click(list.$('td:contains(gnap)'));assert.strictEqual(list.$('input[name="foo"]')[0],document.activeElement,"foo should be focused");await testUtils.fields.triggerKeydown(list.$('input[name="foo"]'),'tab');assert.strictEqual(list.$('input[name="int_field"]')[0],document.activeElement,"int_field should be focused");list.destroy();});QUnit.test('skip buttons when navigating list view with TAB (end)',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<button name="kikou" string="Kikou" type="object"/>'+'</tree>',res_id:1,});await testUtils.dom.click(list.$('tbody tr:eq(2) td:eq(1)'));assert.strictEqual(list.$('tbody tr:eq(2) input[name="foo"]')[0],document.activeElement,"foo should be focused");await testUtils.fields.triggerKeydown(list.$('tbody tr:eq(2) input[name="foo"]'),'tab');assert.strictEqual(list.$('tbody tr:eq(3) input[name="foo"]')[0],document.activeElement,"next line should be selected");list.destroy();});QUnit.test('skip buttons when navigating list view with TAB (middle)',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<button name="kikou" string="Kikou" type="object"/>'+'<field name="foo"/>'+'<button name="kikou" string="Kikou" type="object"/>'+'<field name="int_field"/>'+'</tree>',res_id:1,});await testUtils.dom.click(list.$('tbody tr:eq(2) td:eq(2)'));assert.strictEqual(list.$('tbody tr:eq(2) input[name="foo"]')[0],document.activeElement,"foo should be focused");await testUtils.fields.triggerKeydown(list.$('tbody tr:eq(2) input[name="foo"]'),'tab');assert.strictEqual(list.$('tbody tr:eq(2) input[name="int_field"]')[0],document.activeElement,"int_field should be focused");list.destroy();});QUnit.test('navigation: not moving down with keydown',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',});await testUtils.dom.click(list.$('td:contains(yop)'));assert.hasClass(list.$('tr.o_data_row:eq(0)'),'o_selected_row',"1st row should be selected");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'down');assert.hasClass(list.$('tr.o_data_row:eq(0)'),'o_selected_row',"1st row should still be selected");list.destroy();});QUnit.test('navigation: moving right with keydown from text field does not move the focus',async function(assert){assert.expect(6);this.data.foo.fields.foo.type='text';var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="bar"/>'+'</tree>',});await testUtils.dom.click(list.$('td:contains(yop)'));var textarea=list.$('textarea[name="foo"]')[0];assert.strictEqual(document.activeElement,textarea,"textarea should be focused");assert.strictEqual(textarea.selectionStart,0,"textarea selection start should be at the beginning");assert.strictEqual(textarea.selectionEnd,3,"textarea selection end should be at the end");textarea.selectionStart=3;assert.strictEqual(document.activeElement,textarea,"textarea should still be focused");assert.ok(textarea.selectionStart===3&&textarea.selectionEnd===3,"textarea value ('yop') should not be selected and cursor should be at the end");await testUtils.fields.triggerKeydown($(textarea),'right');assert.strictEqual(document.activeElement,list.$('textarea[name="foo"]')[0],"next field (checkbox) should now be focused");list.destroy();});QUnit.test('discarding changes in a row properly updates the rendering',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'</tree>',});assert.strictEqual(list.$('.o_data_cell:first').text(),"yop","first cell should contain 'yop'");await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.fields.editInput(list.$('input[name="foo"]'),"hello");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.strictEqual($('.modal:visible').length,1,"a modal to ask for discard should be visible");await testUtils.dom.click($('.modal:visible .btn-primary'));assert.strictEqual(list.$('.o_data_cell:first').text(),"yop","first cell should still contain 'yop'");list.destroy();});QUnit.test('numbers in list are right-aligned',async function(assert){assert.expect(2);var currencies={};_.each(this.data.res_currency.records,function(currency){currencies[currency.id]=currency;});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'<field name="qux"/>'+'<field name="amount" widget="monetary"/>'+'<field name="currency_id" invisible="1"/>'+'</tree>',session:{currencies:currencies,},});var nbCellRight=_.filter(list.$('.o_data_row:first > .o_data_cell'),function(el){var style=window.getComputedStyle(el);return style.textAlign==='right';}).length;assert.strictEqual(nbCellRight,2,"there should be two right-aligned cells");await testUtils.dom.click(list.$('.o_data_cell:first'));var nbInputRight=_.filter(list.$('.o_data_row:first > .o_data_cell input'),function(el){var style=window.getComputedStyle(el);return style.textAlign==='right';}).length;assert.strictEqual(nbInputRight,2,"there should be two right-aligned input");list.destroy();});QUnit.test('grouped list with another grouped list parent, click unfold',async function(assert){assert.expect(3);this.data.bar.fields={cornichon:{string:'cornichon',type:'char'},};var rec=this.data.bar.records[0];var newRecs=[];for(var i=0;i<8;i++){var newRec=_.extend({},rec);newRec.id=1+i;newRec.cornichon='extra fin';newRecs.push(newRec);}
this.data.bar.records=newRecs;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="m2o"/></tree>',groupBy:['bar'],archs:{'bar,false,list':'<tree><field name="cornichon"/></tree>','bar,false,search':'<search><filter context="{\'group_by\': \'cornichon\'}" string="cornichon"/></search>',},});await list.update({groupBy:[]});await testUtils.dom.clickFirst(list.$('.o_data_cell'));await testUtils.fields.many2one.searchAndClickItem('m2o',{item:'Search More'});assert.containsOnce($('body'),'.modal-content');assert.containsNone($('body'),'.modal-content .o_group_name','list in modal not grouped');await testUtils.dom.click($('body .modal-content button:contains(Group By)'));await testUtils.dom.click($('body .modal-content .o_menu_item a:contains(cornichon)'));await testUtils.dom.click($('body .modal-content .o_group_header'));assert.containsOnce($('body'),'.modal-content .o_group_open');list.destroy();});QUnit.test('field values are escaped',async function(assert){assert.expect(1);var value='<script>throw Error();</script>';this.data.foo.records[0].foo=value;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/></tree>',});assert.strictEqual(list.$('.o_data_cell:first').text(),value,"value should have been escaped");list.destroy();});QUnit.test('pressing ESC discard the current line changes',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/></tree>',});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsN(list,'tr.o_data_row',5,"should currently adding a 5th data row");await testUtils.fields.triggerKeydown(list.$('input[name="foo"]'),'escape');assert.containsN(list,'tr.o_data_row',4,"should have only 4 data row after escape");assert.containsNone(list,'tr.o_data_row.o_selected_row',"no rows should be selected");assert.ok(!list.$buttons.find('.o_list_button_save').is(':visible'),"should not have a visible save button");list.destroy();});QUnit.test('pressing ESC discard the current line changes (with required)',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo" required="1"/></tree>',});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsN(list,'tr.o_data_row',5,"should currently adding a 5th data row");await testUtils.fields.triggerKeydown(list.$('input[name="foo"]'),'escape');assert.containsN(list,'tr.o_data_row',4,"should have only 4 data row after escape");assert.containsNone(list,'tr.o_data_row.o_selected_row',"no rows should be selected");assert.ok(!list.$buttons.find('.o_list_button_save').is(':visible'),"should not have a visible save button");list.destroy();});QUnit.test('field with password attribute',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo" password="True"/></tree>',});assert.strictEqual(list.$('td.o_data_cell:eq(0)').text(),'***',"should display string as password");assert.strictEqual(list.$('td.o_data_cell:eq(1)').text(),'****',"should display string as password");list.destroy();});QUnit.test('list with handle widget',async function(assert){assert.expect(11);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="int_field" widget="handle"/>'+'<field name="amount" widget="float" digits="[5,0]"/>'+'</tree>',mockRPC:function(route,args){if(route==='/web/dataset/resequence'){assert.strictEqual(args.offset,-4,"should write the sequence starting from the lowest current one");assert.strictEqual(args.field,'int_field',"should write the right field as sequence");assert.deepEqual(args.ids,[4,2,3],"should write the sequence in correct order");return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.strictEqual(list.$('tbody tr:eq(0) td:last').text(),'1200',"default first record should have amount 1200");assert.strictEqual(list.$('tbody tr:eq(1) td:last').text(),'500',"default second record should have amount 500");assert.strictEqual(list.$('tbody tr:eq(2) td:last').text(),'300',"default third record should have amount 300");assert.strictEqual(list.$('tbody tr:eq(3) td:last').text(),'0',"default fourth record should have amount 0");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(3),list.$('tbody tr').first(),{position:'bottom'});assert.strictEqual(list.$('tbody tr:eq(0) td:last').text(),'1200',"new first record should have amount 1200");assert.strictEqual(list.$('tbody tr:eq(1) td:last').text(),'0',"new second record should have amount 0");assert.strictEqual(list.$('tbody tr:eq(2) td:last').text(),'500',"new third record should have amount 500");assert.strictEqual(list.$('tbody tr:eq(3) td:last').text(),'300',"new fourth record should have amount 300");list.destroy();});QUnit.test('result of consecutive resequences is correctly sorted',async function(assert){assert.expect(9);this.data={foo:{fields:{int_field:{string:"int_field",type:"integer",sortable:true}},records:[{id:1,int_field:11},{id:2,int_field:12},{id:3,int_field:13},{id:4,int_field:14},]}};var moves=0;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="int_field" widget="handle"/>'+'<field name="id"/>'+'</tree>',mockRPC:function(route,args){if(route==='/web/dataset/resequence'){if(moves===0){assert.deepEqual(args,{model:"foo",ids:[4,3],offset:13,field:"int_field",});}
if(moves===1){assert.deepEqual(args,{model:"foo",ids:[4,2],offset:12,field:"int_field",});}
if(moves===2){assert.deepEqual(args,{model:"foo",ids:[2,4],offset:12,field:"int_field",});}
if(moves===3){assert.deepEqual(args,{model:"foo",ids:[4,2],offset:12,field:"int_field",});}
moves+=1;}
return this._super.apply(this,arguments);},});assert.strictEqual(list.$('tbody tr td.o_list_number').text(),'1234',"default should be sorted by id");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(3),list.$('tbody tr').eq(2),{position:'top'});assert.strictEqual(list.$('tbody tr td.o_list_number').text(),'1243',"the int_field (sequence) should have been correctly updated");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(2),list.$('tbody tr').eq(1),{position:'top'});assert.deepEqual(list.$('tbody tr td.o_list_number').text(),'1423',"the int_field (sequence) should have been correctly updated");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(1),list.$('tbody tr').eq(3),{position:'top'});assert.deepEqual(list.$('tbody tr td.o_list_number').text(),'1243',"the int_field (sequence) should have been correctly updated");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(2),list.$('tbody tr').eq(1),{position:'top'});assert.deepEqual(list.$('tbody tr td.o_list_number').text(),'1423',"the int_field (sequence) should have been correctly updated");list.destroy();});QUnit.test('editable list with handle widget',async function(assert){assert.expect(12);this.data.foo.records[0].int_field=0;this.data.foo.records[1].int_field=1;this.data.foo.records[2].int_field=2;this.data.foo.records[3].int_field=3;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top" default_order="int_field">'+'<field name="int_field" widget="handle"/>'+'<field name="amount" widget="float" digits="[5,0]"/>'+'</tree>',mockRPC:function(route,args){if(route==='/web/dataset/resequence'){assert.strictEqual(args.offset,1,"should write the sequence starting from the lowest current one");assert.strictEqual(args.field,'int_field',"should write the right field as sequence");assert.deepEqual(args.ids,[4,2,3],"should write the sequence in correct order");}
return this._super.apply(this,arguments);},});assert.strictEqual(list.$('tbody tr:eq(0) td:last').text(),'1200',"default first record should have amount 1200");assert.strictEqual(list.$('tbody tr:eq(1) td:last').text(),'500',"default second record should have amount 500");assert.strictEqual(list.$('tbody tr:eq(2) td:last').text(),'300',"default third record should have amount 300");assert.strictEqual(list.$('tbody tr:eq(3) td:last').text(),'0',"default fourth record should have amount 0");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(3),list.$('tbody tr').first(),{position:'bottom'});assert.strictEqual(list.$('tbody tr:eq(0) td:last').text(),'1200',"new first record should have amount 1200");assert.strictEqual(list.$('tbody tr:eq(1) td:last').text(),'0',"new second record should have amount 0");assert.strictEqual(list.$('tbody tr:eq(2) td:last').text(),'500',"new third record should have amount 500");assert.strictEqual(list.$('tbody tr:eq(3) td:last').text(),'300',"new fourth record should have amount 300");await testUtils.dom.click(list.$('tbody tr:eq(1) td:last'));assert.strictEqual(list.$('tbody tr:eq(1) td:last input').val(),'0',"the edited record should be the good one");list.destroy();});QUnit.test('editable list, handle widget locks and unlocks on sort',async function(assert){assert.expect(6);this.data.foo.fields.amount.sortable=true;this.data.foo.records[0].int_field=0;this.data.foo.records[1].int_field=1;this.data.foo.records[2].int_field=2;this.data.foo.records[3].int_field=3;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top" default_order="int_field">'+'<field name="int_field" widget="handle"/>'+'<field name="amount" widget="float"/>'+'</tree>',});assert.strictEqual(list.$('tbody span[name="amount"]').text(),'1200.00500.00300.000.00',"default should be sorted by int_field");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(3),list.$('tbody tr').first(),{position:'bottom'});assert.strictEqual(list.$('tbody span[name="amount"]').text(),'1200.000.00500.00300.00',"drag and drop should have succeeded, as the handle is unlocked");await testUtils.dom.click(list.$('.o_column_sortable').eq(1));assert.strictEqual(list.$('tbody span[name="amount"]').text(),'0.00300.00500.001200.00',"should have been sorted by amount");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(3),list.$('tbody tr').first(),{position:'bottom'});assert.strictEqual(list.$('tbody span[name="amount"]').text(),'0.00300.00500.001200.00',"drag and drop should have failed as the handle is locked");await testUtils.dom.click(list.$('.o_column_sortable').eq(0));assert.strictEqual(list.$('tbody span[name="amount"]').text(),'1200.000.00500.00300.00',"records should be ordered as per the previous resequence");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(3),list.$('tbody tr').first(),{position:'bottom'});assert.strictEqual(list.$('tbody span[name="amount"]').text(),'1200.00300.000.00500.00',"drag and drop should have worked as the handle is unlocked");list.destroy();});QUnit.test('editable list with handle widget with slow network',async function(assert){assert.expect(15);this.data.foo.records[0].int_field=0;this.data.foo.records[1].int_field=1;this.data.foo.records[2].int_field=2;this.data.foo.records[3].int_field=3;var prom=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="int_field" widget="handle"/>'+'<field name="amount" widget="float" digits="[5,0]"/>'+'</tree>',mockRPC:function(route,args){if(route==='/web/dataset/resequence'){var _super=this._super.bind(this);assert.strictEqual(args.offset,1,"should write the sequence starting from the lowest current one");assert.strictEqual(args.field,'int_field',"should write the right field as sequence");assert.deepEqual(args.ids,[4,2,3],"should write the sequence in correct order");return prom.then(function(){return _super(route,args);});}
return this._super.apply(this,arguments);},});assert.strictEqual(list.$('tbody tr:eq(0) td:last').text(),'1200',"default first record should have amount 1200");assert.strictEqual(list.$('tbody tr:eq(1) td:last').text(),'500',"default second record should have amount 500");assert.strictEqual(list.$('tbody tr:eq(2) td:last').text(),'300',"default third record should have amount 300");assert.strictEqual(list.$('tbody tr:eq(3) td:last').text(),'0',"default fourth record should have amount 0");await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(3),list.$('tbody tr').first(),{position:'bottom'});await testUtils.dom.click(list.$('tbody tr:eq(3) td:last'));await testUtils.nextTick();assert.strictEqual(list.$('tbody tr:eq(3) td:last input').length,0,"shouldn't edit the line before resequence");prom.resolve();await testUtils.nextTick();assert.strictEqual(list.$('tbody tr:eq(3) td:last input').length,1,"should edit the line after resequence");assert.strictEqual(list.$('tbody tr:eq(3) td:last input').val(),'300',"fourth record should have amount 300");await testUtils.fields.editInput(list.$('tbody tr:eq(3) td:last input'),301);await testUtils.dom.click(list.$('tbody tr:eq(0) td:last'));await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(list.$('tbody tr:eq(0) td:last').text(),'1200',"first record should have amount 1200");assert.strictEqual(list.$('tbody tr:eq(1) td:last').text(),'0',"second record should have amount 1");assert.strictEqual(list.$('tbody tr:eq(2) td:last').text(),'500',"third record should have amount 500");assert.strictEqual(list.$('tbody tr:eq(3) td:last').text(),'301',"fourth record should have amount 301");await testUtils.dom.click(list.$('tbody tr:eq(3) td:last'));assert.strictEqual(list.$('tbody tr:eq(3) td:last input').val(),'301',"fourth record should have amount 301");list.destroy();});QUnit.test('list with handle widget, create, move and discard',async function(assert){assert.expect(11);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree editable="bottom">
                    <field name="int_field" widget="handle"/>
                    <field name="foo" required="1"/>
                </tree>`,domain:[['bar','=',false]],});assert.containsOnce(list,'.o_data_row');assert.containsN(list,'tbody tr',4);await testUtils.dom.click(list.$('.o_list_button_add'));assert.containsN(list,'.o_data_row',2);assert.doesNotHaveClass(list.$('.o_data_row:first'),'o_selected_row');assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');await testUtils.dom.dragAndDrop(list.$('.ui-sortable-handle').eq(0),list.$('tbody tr.o_data_row').eq(1),{position:'bottom'});assert.containsN(list,'.o_data_row',2);assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');assert.doesNotHaveClass(list.$('.o_data_row:nth(1)'),'o_selected_row');await testUtils.dom.click(list.$('.o_list_button_discard'));assert.containsOnce(list,'.o_data_row');assert.hasClass(list.$('tbody tr:first'),'o_data_row');assert.containsN(list,'tbody tr',4);list.destroy();});QUnit.test('multiple clicks on Add do not create invalid rows',async function(assert){assert.expect(2);this.data.foo.onchanges={m2o:function(){},};var prom=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="m2o" required="1"/></tree>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){return prom.then(function(){return result;});}
return result;},});assert.containsN(list,'.o_data_row',4,"should contain 4 records");testUtils.dom.click(list.$buttons.find('.o_list_button_add'));testUtils.dom.click(list.$buttons.find('.o_list_button_add'));prom.resolve();await testUtils.nextTick();assert.containsN(list,'.o_data_row',5,"only one record should have been created");list.destroy();});QUnit.test('reference field rendering',async function(assert){assert.expect(4);this.data.foo.records.push({id:5,reference:'res_currency,2',});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="reference"/></tree>',mockRPC:function(route,args){if(args.method==='name_get'){assert.step(args.model);}
return this._super.apply(this,arguments);},});assert.verifySteps(['bar','res_currency'],"should have done 1 name_get by model in reference values");assert.strictEqual(list.$('tbody td:not(.o_list_record_selector)').text(),"Value 1USDEUREUR","should have the display_name of the reference");list.destroy();});QUnit.test('reference field batched in grouped list',async function(assert){assert.expect(7);this.data.foo.records=[{id:1,foo:'1',reference:'bar,1'},{id:2,foo:'1',reference:'bar,2'},{id:3,foo:'1',reference:'res_currency,1'},{id:4,foo:'2',reference:'bar,2'},{id:5,foo:'2',reference:'bar,3'},];const list=await createView({View:ListView,model:'foo',data:this.data,arch:`<tree expand="1">
                       <field name="foo" invisible="1"/>
                       <field name="reference"/>
                   </tree>`,groupBy:['foo'],mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='name_get'){if(args.model==='bar'){assert.deepEqual(args.args[0],[1,2,3]);}
if(args.model==="res.currency"){assert.deepEqual(args.args[0],[1]);}}
return this._super.apply(this,arguments);},});assert.verifySteps(['web_read_group','name_get','name_get',]);assert.containsN(list,'.o_group_header',2);const allNames=Array.from(list.el.querySelectorAll('.o_data_cell'),node=>node.textContent);assert.deepEqual(allNames,['Value 1','Value 2','USD','Value 2','Value 3',]);list.destroy();});QUnit.test('editable list view: contexts are correctly sent',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'</tree>',mockRPC:function(route,args){var context;if(route==='/web/dataset/search_read'){context=args.context;}else{context=args.kwargs.context;}
assert.strictEqual(context.active_field,2,"context should be correct");assert.strictEqual(context.someKey,'some value',"context should be correct");return this._super.apply(this,arguments);},session:{user_context:{someKey:'some value'},},viewOptions:{context:{active_field:2},},});await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),'abc');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));list.destroy();});QUnit.test('editable list view: contexts with multiple edit',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="foo"/>'+'</tree>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/foo/write'||route==='/web/dataset/call_kw/foo/read'){var context=args.kwargs.context;assert.strictEqual(context.active_field,2,"context should be correct");assert.strictEqual(context.someKey,'some value',"context should be correct");}
return this._super.apply(this,arguments);},session:{user_context:{someKey:'some value'},},viewOptions:{context:{active_field:2},},});await testUtils.dom.click(list.$('.o_content input:first'));await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),'legion');await testUtils.dom.click($('.modal-dialog button.btn-primary'));list.destroy();});QUnit.test('editable list view: single edition with selected records',async function(assert){assert.expect(2);const list=await createView({arch:`<tree editable="top" multi_edit="1"><field name="foo"/></tree>`,data:this.data,model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell:first()'));await testUtils.fields.editInput(list.$('.o_data_row:eq(1) .o_data_cell:first() input'),"oui");await testUtils.dom.click($('.o_list_button_save'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell:first()').text(),"yop","First row should remain unchanged");assert.strictEqual(list.$('.o_data_row:eq(1) .o_data_cell:first()').text(),"oui","Second row should have been updated");list.destroy();});QUnit.test('editable list view: multi edition',async function(assert){assert.expect(26);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom" multi_edit="1">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>',mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='write'){assert.deepEqual(args.args,[[1,2],{int_field:666}],"should write on multi records");}else if(args.method==='read'){if(args.args[0].length!==1){assert.deepEqual(args.args,[[1,2],['foo','int_field']],"should batch the read");}}
return this._super.apply(this,arguments);},});assert.verifySteps(['/web/dataset/search_read']);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));assert.hasClass(list.$('.o_data_row:eq(0)'),'o_selected_row',"the first row should be selected");await testUtils.dom.click('body');assert.containsNone(list,'.o_selected_row',"no row should be selected");await testUtils.dom.click($('.o_list_button_add'));assert.verifySteps(['onchange']);await testUtils.fields.editInput(list.$('.o_selected_row .o_field_widget[name=int_field]'),123);assert.containsNone(document.body,'.modal',"the multi edition should not be triggered during creation");await testUtils.dom.click($('.o_list_button_save'));assert.verifySteps(['create','read']);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),666);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));assert.containsOnce(document.body,'.modal',"modal appears when switching cells");await testUtils.dom.click($('.modal .btn:contains(Cancel)'));assert.containsN(list,'.o_list_record_selector input:checked',2,"Selection should remain unchanged");assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),'yop10',"changes have been discarded and row is back to readonly");assert.strictEqual(document.activeElement,list.$('.o_data_row:eq(0) .o_data_cell:eq(1)')[0],"focus should be given to the most recently edited cell after discard");await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),666);await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell:eq(0)'));assert.ok($('.modal').text().includes('those 2 records'),"the number of records should be correctly displayed");await testUtils.dom.click($('.modal .btn-primary'));assert.containsNone(list,'.o_data_cell input.o_field_widget',"no field should be editable anymore");assert.containsNone(list,'.o_list_record_selector input:checked',"no record should be selected anymore");assert.verifySteps(['write','read']);assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),"yop666","the first row should be updated");assert.strictEqual(list.$('.o_data_row:eq(1) .o_data_cell').text(),"blip666","the second row should be updated");assert.containsNone(list,'.o_data_cell input.o_field_widget',"no field should be editable anymore");assert.strictEqual(document.activeElement,list.$('.o_data_row:eq(0) .o_data_cell:eq(1)')[0],"focus should be given to the most recently edited cell after confirm");list.destroy();});QUnit.test('create in multi editable list',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>',intercepts:{switch_view:function(ev){assert.strictEqual(ev.data.view_type,'form');},},});await testUtils.dom.click($('.o_list_button_add'));list.destroy();});QUnit.test('editable list view: multi edition cannot call onchanges',async function(assert){assert.expect(15);this.data.foo.onchanges={foo:function(obj){obj.int_field=obj.foo.length;},};var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>',mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='write'){args.args[1].int_field=args.args[1].foo.length;}
return this._super.apply(this,arguments);},});assert.verifySteps(['/web/dataset/search_read']);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),'hi');assert.containsNone(document.body,'.modal');assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),"hi2");assert.strictEqual(list.$('.o_data_row:eq(1) .o_data_cell').text(),"blip9");assert.verifySteps(['write','read']);assert.containsNone(list,'.o_list_record_selector input:checked');await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),'hello');await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),"hello5");assert.strictEqual(list.$('.o_data_row:eq(1) .o_data_cell').text(),"hello5");assert.verifySteps(['write','read'],"should not perform the onchange in multi edition");list.destroy();});QUnit.test('editable list view: multi edition error and cancellation handling',async function(assert){assert.expect(12);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="foo" required="1"/>'+'<field name="int_field"/>'+'</tree>',});assert.containsN(list,'.o_list_record_selector input:enabled',5);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));assert.containsNone(list,'.o_list_record_selector input:enabled');await testUtils.fields.editInput(list.$('.o_selected_row .o_field_widget[name=foo]'),"abc");await testUtils.dom.click($('.modal .btn:contains("Cancel")'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),'yop10',"first cell should have discarded any change");assert.containsN(list,'.o_list_record_selector input:enabled',5);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));assert.containsNone(list,'.o_list_record_selector input:enabled');await testUtils.fields.editInput(list.$('.o_selected_row .o_field_widget[name=int_field]'),"hahaha");assert.containsOnce(document.body,'.modal',"there should be an opened modal");await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),'yop10',"changes should be discarded");assert.containsN(list,'.o_list_record_selector input:enabled',5);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));assert.containsNone(list,'.o_list_record_selector input:enabled');await testUtils.fields.editInput(list.$('.o_selected_row .o_field_widget[name=foo]'),"");assert.containsOnce(document.body,'.modal',"there should be an opened modal");await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),'yop10',"changes should be discarded");assert.containsN(list,'.o_list_record_selector input:enabled',5);list.destroy();});QUnit.test('multi edition: many2many_tags in many2many field',async function(assert){assert.expect(5);for(let i=4;i<=10;i++){this.data.bar.records.push({id:i,display_name:"Value"+i});}
const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1"><field name="m2m" widget="many2many_tags"/></tree>',archs:{'bar,false,list':'<tree><field name="name"/></tree>','bar,false,search':'<search></search>',},});assert.containsN(list,'.o_list_record_selector input:enabled',5);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell'));await testUtils.fields.many2one.clickOpenDropdown("m2m");await testUtils.fields.many2one.clickItem("m2m","Search More");assert.containsOnce(document.body,'.modal .o_list_view',"should have open the modal");await testUtils.dom.click($('.modal .o_list_view .o_data_row:first'));assert.containsOnce(document.body,".modal [role='alert']","should have open the confirmation modal");assert.containsN(document.body,".modal .o_field_many2manytags .badge",3);assert.strictEqual($(".modal .o_field_many2manytags .badge:last").text().trim(),"Value 3","should have display_name in badge");list.destroy();});QUnit.test('editable list view: multi edition of many2one: set same value',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="foo"/>'+'<field name="m2o"/>'+'</tree>',mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args,[[1,2,3,4],{m2o:1}],"should force write value on all selected records");}
return this._super.apply(this,arguments);},});assert.strictEqual(list.$('.o_list_many2one').text(),"Value 1Value 2Value 1Value 1");await testUtils.dom.click(list.$('thead .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));await testUtils.fields.many2one.searchAndClickItem('m2o',{search:'Value 1'});assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.strictEqual(list.$('.o_list_many2one').text(),"Value 1Value 1Value 1Value 1");list.destroy();});QUnit.test('editable list view: clicking on "Discard changes" in multi edition',async function(assert){assert.expect(2);const list=await createView({arch:`
                <tree editable="top" multi_edit="1">
                    <field name="foo"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:first() .o_data_cell:first()'));list.$('.o_data_row:first() .o_data_cell:first() input').val("oof");const $discardButton=list.$buttons.find('.o_list_button_discard');await testUtils.dom.triggerEvents($discardButton,['mousedown']);await testUtils.dom.triggerEvents(list.$('.o_data_row:first() .o_data_cell:first() input'),['change','blur','focusout']);await testUtils.dom.triggerEvents($discardButton,['focus']);$discardButton[0].dispatchEvent(new MouseEvent('mouseup'));await testUtils.dom.click($discardButton);assert.ok($('.modal').text().includes("Warning"),"Modal should ask to discard changes");await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_row:first() .o_data_cell:first()').text(),"yop");list.destroy();});QUnit.test('editable list view (multi edition): mousedown on "Discard", but mouseup somewhere else',async function(assert){assert.expect(1);const list=await createView({arch:`
                <tree multi_edit="1">
                    <field name="foo"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:first() .o_data_cell:first()'));list.$('.o_data_row:first() .o_data_cell:first() input').val("oof");await testUtils.dom.triggerEvents(list.$buttons.find('.o_list_button_discard'),['mousedown']);await testUtils.dom.triggerEvents(list.$('.o_data_row:first() .o_data_cell:first() input'),['change','blur','focusout']);await testUtils.dom.triggerEvents($(document.body),['focus']);window.dispatchEvent(new MouseEvent('mouseup'));await testUtils.nextTick();assert.ok($('.modal').text().includes("Confirmation"),"Modal should ask to save changes");await testUtils.dom.click($('.modal .btn-primary'));list.destroy();});QUnit.test('editable list view: multi edition with readonly modifiers',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="id"/>'+'<field name="foo"/>'+'<field name="int_field" attrs=\'{"readonly": [("id", ">" , 2)]}\'/>'+'</tree>',mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args,[[1,2],{int_field:666}],"should only write on the valid records");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('th.o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),666);const modalText=$('.modal-body').text().split(" ").filter(w=>w.trim()!=='').join(" ").split("\n").join('');assert.strictEqual(modalText,"Among the 4 selected records, 2 are valid for this update. Are you sure you want to "+"perform the following update on those 2 records ? Field: int_field Update to: 666");assert.strictEqual(document.querySelector('.modal .o_modal_changes .o_field_widget').style.pointerEvents,'none',"pointer events should be deactivated on the demo widget");await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),"1yop666","the first row should be updated");assert.strictEqual(list.$('.o_data_row:eq(1) .o_data_cell').text(),"2blip666","the second row should be updated");list.destroy();});QUnit.test('editable list view: multi edition when the domain is selected',async function(assert){assert.expect(1);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree multi_edit="1" limit="2">
                    <field name="id"/>
                    <field name="int_field"/>
                </tree>`,});await testUtils.dom.click(list.$('th.o_list_record_selector input'));await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),666);assert.ok($('.modal-body').text().includes('This update will only consider the records of the current page.'));list.destroy();});QUnit.test('editable list view: many2one with readonly modifier',async function(assert){assert.expect(2);const list=await createView({arch:`<tree editable="top">
                    <field name="m2o" readonly="1"/>
                    <field name="foo"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));assert.containsOnce(list,'.o_data_row:eq(0) .o_data_cell:eq(0) a[name="m2o"]');assert.strictEqual(document.activeElement,list.$('.o_data_row:eq(0) .o_data_cell:eq(1) input')[0],"focus should go to the char input");list.destroy();});QUnit.test('editable list view: multi edition server error handling',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="foo" required="1"/>'+'</tree>',mockRPC:function(route,args){if(args.method==='write'){return Promise.reject();}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));await testUtils.fields.editInput(list.$('.o_selected_row .o_field_widget[name=foo]'),"abc");await testUtils.dom.click('body');await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),'yop',"first cell should have discarded any change");assert.strictEqual(list.$('.o_data_row:eq(1) .o_data_cell').text(),'blip',"second selected record should not have changed");assert.containsNone(list,'.o_data_cell input.o_field_widget',"no field should be editable anymore");list.destroy();});QUnit.test('editable readonly list view: navigation',async function(assert){assert.expect(6);const list=await createView({arch:`
                <tree multi_edit="1">
                    <field name="foo"/>
                    <field name="int_field"/>
                </tree>`,data:this.data,intercepts:{switch_view:function(event){assert.strictEqual(event.data.res_id,3,"'switch_view' event has been triggered");},},model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(3) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell:eq(1)'));assert.hasClass(list.$('.o_data_row:eq(1)'),'o_selected_row',"the second row should be selected");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input.o_field_widget[name="int_field"]'),'enter');assert.hasClass(list.$('.o_data_row:eq(3)'),'o_selected_row',"the fourth row should be selected");await testUtils.fields.triggerKeydown($(document.activeElement),'tab');await testUtils.fields.triggerKeydown($(document.activeElement),'tab');assert.hasClass(list.$('.o_data_row:eq(1)'),'o_selected_row',"the second row should be selected again");await testUtils.fields.triggerKeydown($(document.activeElement),'tab');await testUtils.fields.triggerKeydown($(document.activeElement),'tab');assert.hasClass(list.$('.o_data_row:eq(3)'),'o_selected_row',"the fourth row should be selected again");await testUtils.dom.click(list.$('.o_data_row:eq(2) .o_data_cell:eq(0)'));assert.containsNone(list,'.o_data_cell input.o_field_widget',"no row should be editable anymore");await testUtils.dom.click(list.$('.o_data_row:eq(2) .o_data_cell:eq(0)'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(3) .o_list_record_selector input'));list.destroy();});QUnit.test('editable list view: multi edition: edit and validate last row',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree multi_edit="1">'+'<field name="foo"/>'+'<field name="int_field"/>'+'</tree>',fieldDebounce:100000,});assert.containsN(list,'.o_data_row',4);await testUtils.dom.click(list.$('.o_list_view thead .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:last .o_data_cell:last'));testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),'666');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row .o_data_cell:last input'),'enter');assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal .btn-primary'));assert.containsN(list,'.o_data_row',4,"should not create a new row as we were in multi edition");list.destroy();});QUnit.test('editable readonly list view: navigation in grouped list',async function(assert){assert.expect(6);const list=await createView({arch:`
                <tree multi_edit="1">
                    <field name="foo"/>
                </tree>`,data:this.data,groupBy:['bar'],intercepts:{switch_view:function(event){assert.strictEqual(event.data.res_id,3,"'switch_view' event has been triggered");},},model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_header:last'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(3) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell:eq(0)'));assert.hasClass(list.$('.o_data_row:eq(1)'),'o_selected_row',"the second row should be selected");await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input.o_field_widget'),'enter');assert.hasClass(list.$('.o_data_row:eq(3)'),'o_selected_row',"the fourth row should be selected");await testUtils.fields.triggerKeydown($(document.activeElement),'tab');assert.hasClass(list.$('.o_data_row:eq(1)'),'o_selected_row',"the second row should be selected again");await testUtils.fields.triggerKeydown($(document.activeElement),'tab');assert.hasClass(list.$('.o_data_row:eq(3)'),'o_selected_row',"the fourth row should be selected again");await testUtils.dom.click(list.$('.o_data_row:eq(2) .o_data_cell:eq(0)'));assert.containsNone(list,'.o_data_cell input.o_field_widget',"no row should be editable anymore");await testUtils.dom.click(list.$('.o_data_row:eq(2) .o_data_cell:eq(0)'));list.destroy();});QUnit.test('editable readonly list view: single edition does not behave like a multi-edition',async function(assert){assert.expect(3);const list=await createView({arch:`
                <tree multi_edit="1">
                    <field name="foo" required="1"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),"");assert.containsOnce($('body'),'.modal',"should have a modal (invalid fields)");await testUtils.dom.click($('.modal button.btn'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=foo]'),"bar");assert.containsNone($('body'),'.modal',"should not have a modal");assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),"bar","the first row should be updated");list.destroy();});QUnit.test('editable readonly list view: multi edition',async function(assert){assert.expect(14);const list=await createView({arch:`<tree multi_edit="1">
                    <field name="foo"/>
                    <field name="int_field"/>
                </tree>`,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='write'){assert.deepEqual(args.args,[[1,2],{int_field:666}],"should write on multi records");}else if(args.method==='read'){if(args.args[0].length!==1){assert.deepEqual(args.args,[[1,2],['foo','int_field']],"should batch the read");}}
return this._super.apply(this,arguments);},model:'foo',View:ListView,});assert.verifySteps(['/web/dataset/search_read']);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_list_record_selector input'));await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),666);await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(0)'));assert.containsOnce(document.body,'.modal',"modal appears when switching cells");await testUtils.dom.click($('.modal .btn:contains(Cancel)'));assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),'yop10',"changes have been discarded and row is back to readonly");await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_data_cell:eq(1)'));await testUtils.fields.editInput(list.$('.o_field_widget[name=int_field]'),666);await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell:eq(0)'));assert.containsOnce(document.body,'.modal',"there should be an opened modal");assert.ok($('.modal').text().includes('those 2 records'),"the number of records should be correctly displayed");await testUtils.dom.click($('.modal .btn-primary'));assert.verifySteps(['write','read']);assert.strictEqual(list.$('.o_data_row:eq(0) .o_data_cell').text(),"yop666","the first row should be updated");assert.strictEqual(list.$('.o_data_row:eq(1) .o_data_cell').text(),"blip666","the second row should be updated");assert.containsNone(list,'.o_data_cell input.o_field_widget',"no field should be editable anymore");list.destroy();});QUnit.test('editable list view: m2m tags in grouped list',async function(assert){assert.expect(2);const list=await createView({arch:`
                <tree editable="top" multi_edit="1">
                    <field name="bar"/>
                    <field name="m2m" widget="many2many_tags"/>
                </tree>`,data:this.data,groupBy:['bar'],model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_group_header:first'));assert.notEqual(list.$('.o_data_row:first').text(),list.$('.o_data_row:last').text(),"First row and last row should have different values");await testUtils.dom.click(list.$('thead .o_list_record_selector:first input'));await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:eq(1)'));await testUtils.dom.click(list.$('.o_selected_row .o_field_many2manytags .o_delete:first'));await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_row:first').text(),list.$('.o_data_row:last').text(),"All rows should have been correctly updated");list.destroy();});QUnit.test('editable list: edit many2one from external link',async function(assert){assert.expect(2);const list=await createView({arch:`
                <tree editable="top" multi_edit="1">
                    <field name="m2o"/>
                </tree>`,archs:{'bar,false,form':'<form string="Bar"><field name="display_name"/></form>',},data:this.data,mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super(route,args);},model:'foo',View:ListView,});await testUtils.dom.click(list.$('thead .o_list_record_selector:first input'));await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:eq(0)'));await testUtils.dom.click(list.$('.o_external_button:first'));await testUtils.fields.editInput($('.modal input:first'),"OOF");await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual($('.modal .o_field_widget[name=m2o]').text(),"OOF","Value of the m2o should be updated in the confirmation dialog");await testUtils.dom.click($('.modal .btn-primary'));assert.strictEqual(list.$('.o_data_cell:first').text(),"OOF","Value of the m2o should be updated in the list");list.destroy();});QUnit.test('editable list with fields with readonly modifier',async function(assert){assert.expect(8);const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree editable="top">
                    <field name="bar"/>
                    <field name="foo" attrs="{'readonly': [['bar','=',True]]}"/>
                    <field name="m2o" attrs="{'readonly': [['bar','=',False]]}"/>
                    <field name="int_field"/>
                </tree>`,});await testUtils.dom.click(list.$('.o_list_button_add'));assert.containsOnce(list,'.o_selected_row');assert.notOk(list.$('.o_selected_row .o_field_boolean input').is(':checked'));assert.doesNotHaveClass(list.$('.o_selected_row .o_list_char'),'o_readonly_modifier');assert.hasClass(list.$('.o_selected_row .o_list_many2one'),'o_readonly_modifier');await testUtils.dom.click(list.$('.o_selected_row .o_field_boolean input'));assert.ok(list.$('.o_selected_row .o_field_boolean input').is(':checked'));assert.hasClass(list.$('.o_selected_row .o_list_char'),'o_readonly_modifier');assert.doesNotHaveClass(list.$('.o_selected_row .o_list_many2one'),'o_readonly_modifier');await testUtils.dom.click(list.$('.o_selected_row .o_field_many2one input'));assert.strictEqual(document.activeElement,list.$('.o_selected_row .o_field_many2one input')[0]);list.destroy();});QUnit.test('editable list with many2one: click out does not discard the row',async function(assert){assert.expect(5);this.data.bar.fields.m2o={string:"M2O field",type:"many2one",relation:"foo"};const form=await createView({View:FormView,model:'foo',data:this.data,arch:`
                <form>
                    <field name="display_name"/>
                    <field name="o2m">
                        <tree editable="bottom">
                            <field name="m2o" required="1"/>
                        </tree>
                    </field>
                </form>`,});assert.containsNone(form,'.o_data_row');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add > a'));assert.containsOnce(form,'.o_data_row');form.$('.o_field_many2one input').focus().val('abcdef').trigger('keyup');await testUtils.nextTick();form.$('.o_field_widget[name="display_name"]').focus().trigger('mousedown');await testUtils.nextTick();assert.containsOnce(document.body,'.modal',"should ask confirmation to create a record");form.$('.o_field_widget[name="display_name"]').trigger('mouseup').trigger('click');await testUtils.nextTick();assert.containsOnce(document.body,'.modal',"modal should still be displayed");assert.containsOnce(form,'.o_data_row',"the row should still be there");form.destroy();});QUnit.test('editable list alongside html field: click out to unselect the row',async function(assert){assert.expect(5);const form=await createView({View:FormView,model:'foo',data:this.data,arch:`
                <form>
                    <field name="text" widget="html"/>
                    <field name="o2m">
                        <tree editable="bottom">
                            <field name="display_name"/>
                        </tree>
                    </field>
                </form>`,});assert.containsNone(form,'.o_data_row');await testUtils.dom.click(form.$('.o_field_x2many_list_row_add > a'));assert.containsOnce(form,'.o_data_row');assert.hasClass(form.$('.o_data_row'),'o_selected_row');await testUtils.dom.click(document.body);assert.containsOnce(form,'.o_data_row');assert.doesNotHaveClass(form.$('.o_data_row'),'o_selected_row');form.destroy();});QUnit.test('list grouped by date:month',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="date"/></tree>',groupBy:['date:month'],});assert.strictEqual(list.$('tbody').text(),"January 2017 (1)Undefined (3)","the group names should be correct");list.destroy();});QUnit.test('grouped list edition with toggle_button widget',async function(assert){assert.expect(3);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="bar" widget="toggle_button"/></tree>',groupBy:['m2o'],mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{bar:false},"should write the correct value");}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsOnce(list,'.o_data_row:first .o_toggle_button_success',"boolean value of the first record should be true");await testUtils.dom.click(list.$('.o_data_row:first .o_icon_button'));assert.strictEqual(list.$('.o_data_row:first .text-muted:not(.o_toggle_button_success)').length,1,"boolean button should have been updated");list.destroy();});QUnit.test('grouped list view, indentation for empty group',async function(assert){assert.expect(3);this.data.foo.fields.priority={string:"Priority",type:"selection",selection:[[1,"Low"],[2,"Medium"],[3,"High"]],default:1,};this.data.foo.records.push({id:5,foo:"blip",int_field:-7,m2o:1,priority:2});this.data.foo.records.push({id:6,foo:"blip",int_field:5,m2o:1,priority:3});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="id"/></tree>',groupBy:['priority','m2o'],mockRPC:function(route,args){if(args.method==='web_read_group'&&args.kwargs.groupby[0]==="m2o"){return Promise.resolve({groups:[{id:8,m2o:[1,"Value 1"],m2o_count:0},{id:2,m2o:[2,"Value 2"],m2o_count:1}],length:1,});}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_group_header:first'));assert.strictEqual(list.$('th.o_group_name').eq(1).children().length,1,"There should be an empty element creating the indentation for the subgroup.");assert.hasClass(list.$('th.o_group_name').eq(1).children().eq(0),'fa',"The first element of the row name should have the fa class");assert.strictEqual(list.$('th.o_group_name').eq(1).children().eq(0).is('span'),true,"The first element of the row name should be a span");list.destroy();});QUnit.test('basic support for widgets',async function(assert){assert.expect(1);var MyWidget=Widget.extend({init:function(parent,dataPoint){this.data=dataPoint.data;},start:function(){this.$el.text(JSON.stringify(this.data));},});widgetRegistry.add('test',MyWidget);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="int_field"/><widget name="test"/></tree>',});assert.strictEqual(list.$('.o_widget').first().text(),'{"foo":"yop","int_field":10,"id":1}',"widget should have been instantiated");list.destroy();delete widgetRegistry.map.test;});QUnit.test('use the limit attribute in arch',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="2"><field name="foo"/></tree>',mockRPC:function(route,args){assert.strictEqual(args.limit,2,'should use the correct limit value');return this._super.apply(this,arguments);},});assert.strictEqual(cpHelpers.getPagerValue(list),'1-2');assert.strictEqual(cpHelpers.getPagerSize(list),'4');assert.containsN(list,'.o_data_row',2,'should display 2 data rows');list.destroy();});QUnit.test('check if the view destroys all widgets and instances',async function(assert){assert.expect(2);var instanceNumber=0;testUtils.mock.patch(mixins.ParentedMixin,{init:function(){instanceNumber++;return this._super.apply(this,arguments);},destroy:function(){if(!this.isDestroyed()){instanceNumber--;}
return this._super.apply(this,arguments);}});var params={View:ListView,model:'foo',data:this.data,arch:'<tree string="Partners">'+'<field name="foo"/>'+'<field name="bar"/>'+'<field name="date"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'<field name="m2o"/>'+'<field name="o2m"/>'+'<field name="m2m"/>'+'<field name="amount"/>'+'<field name="currency_id"/>'+'<field name="datetime"/>'+'<field name="reference"/>'+'</tree>',};var list=await createView(params);assert.ok(instanceNumber>0);list.destroy();assert.strictEqual(instanceNumber,0);testUtils.mock.unpatch(mixins.ParentedMixin);});QUnit.test('concurrent reloads finishing in inverse order',async function(assert){assert.expect(4);var blockSearchRead=false;var prom=testUtils.makeTestPromise();var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',mockRPC:function(route){var result=this._super.apply(this,arguments);if(route==='/web/dataset/search_read'&&blockSearchRead){return prom.then(_.constant(result));}
return result;},});assert.containsN(list,'.o_list_view .o_data_row',4,"list view should contain 4 records");blockSearchRead=true;list.reload({domain:[['foo','=','yop']]});await testUtils.nextTick();assert.containsN(list,'.o_list_view .o_data_row',4,"list view should still contain 4 records (search_read being blocked)");blockSearchRead=false;list.reload({domain:[]});await testUtils.nextTick();assert.containsN(list,'.o_list_view .o_data_row',4,"list view should still contain 4 records");prom.resolve();await testUtils.nextTick();assert.containsN(list,'.o_list_view .o_data_row',4,"list view should still contain 4 records");list.destroy();});QUnit.test('list view on a "noCache" model',async function(assert){assert.expect(9);testUtils.mock.patch(BasicModel,{noCacheModels:BasicModel.prototype.noCacheModels.concat(['foo']),});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="display_name"/>'+'</tree>',mockRPC:function(route,args){if(_.contains(['create','unlink','write'],args.method)){assert.step(args.method);}
return this._super.apply(this,arguments);},viewOptions:{hasActionMenus:true,},});core.bus.on('clear_cache',list,assert.step.bind(assert,'clear_cache'));await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));await testUtils.fields.editInput(list.$('.o_selected_row .o_field_widget'),'some value');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.fields.editInput(list.$('.o_selected_row .o_field_widget'),'new value');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));await testUtils.dom.click(list.$('.o_data_row:first .o_list_record_selector input'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,"Delete");await testUtils.dom.click($('.modal-footer .btn-primary'));assert.verifySteps(['create','clear_cache','write','clear_cache','unlink','clear_cache',]);list.destroy();testUtils.mock.unpatch(BasicModel);assert.verifySteps(['clear_cache']);});QUnit.test('list should ask to scroll to top on page changes',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree limit="3">'+'<field name="display_name"/>'+'</tree>',intercepts:{scrollTo:function(ev){assert.strictEqual(ev.data.top,0,"should ask to scroll to top");assert.step('scroll');},},});await cpHelpers.pagerNext(list);await cpHelpers.pagerPrevious(list);assert.verifySteps(['scroll','scroll'],"should ask to scroll when switching pages");await cpHelpers.setPagerValue(list,'1-2');await testUtils.nextTick();assert.strictEqual(cpHelpers.getPagerValue(list),'1-2');assert.verifySteps([],"should not ask to scroll when changing the limit");await cpHelpers.pagerNext(list);assert.verifySteps(['scroll'],"this is still working after a limit change");list.destroy();});QUnit.test('list with handle field, override default_get, bottom when inline',async function(assert){assert.expect(2);this.data.foo.fields.int_field.default=10;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom" default_order="int_field">'
+'<field name="int_field" widget="handle"/>'
+'<field name="foo"/>'
+'</tree>',});assert.strictEqual($('.o_data_cell').text(),"blipblipyopgnap");var inputText='ninja';await testUtils.dom.click($('.o_list_button_add'));await testUtils.fields.editInput(list.$('.o_input[name="foo"]'),inputText);await testUtils.dom.click($('.o_list_button_save'));await testUtils.dom.click($('.o_list_button_add'));assert.strictEqual($('.o_data_cell').text(),"blipblipyopgnap"+inputText);list.destroy();});QUnit.test('create record on list with modifiers depending on id',async function(assert){assert.expect(8);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="id" invisible="1"/>'+'<field name="foo" attrs="{\'readonly\': [[\'id\',\'!=\',False]]}"/>'+'<field name="int_field" attrs="{\'invisible\': [[\'id\',\'!=\',False]]}"/>'+'</tree>',});await testUtils.dom.click(list.$buttons.find('.o_list_button_add'));assert.containsOnce(list,'.o_selected_row');assert.doesNotHaveClass(list.$('.o_selected_row .o_data_cell:first'),'o_readonly_modifier');assert.doesNotHaveClass(list.$('.o_selected_row .o_data_cell:nth(1)'),'o_invisible_modifier');await testUtils.fields.editInput(list.$('.o_selected_row input[name=foo]'),'some value');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.hasClass(list.$('.o_data_row:first .o_data_cell:first'),'o_readonly_modifier');assert.hasClass(list.$('.o_data_row:first .o_data_cell:nth(1)'),'o_invisible_modifier');await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:first'));assert.containsOnce(list,'.o_selected_row');assert.hasClass(list.$('.o_selected_row .o_data_cell:first'),'o_readonly_modifier');assert.hasClass(list.$('.o_selected_row .o_data_cell:nth(1)'),'o_invisible_modifier');list.destroy();});QUnit.test('readonly boolean in editable list is readonly',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom">'+'<field name="foo"/>'+'<field name="bar" attrs="{\'readonly\': [(\'foo\', \'!=\', \'yop\')]}"/>'+'</tree>',});var $disabledCell=list.$('.o_data_row:eq(1) .o_data_cell:last-child');await testUtils.dom.click($disabledCell.prev());assert.containsOnce($disabledCell,':disabled:checked');var $disabledLabel=$disabledCell.find('.custom-control-label');await testUtils.dom.click($disabledLabel);assert.containsOnce($disabledCell,':checked',"clicking disabled checkbox did not work");assert.ok($(document.activeElement).is('input[type="text"]'),"disabled checkbox is not focused after click");var $enabledCell=list.$('.o_data_row:eq(0) .o_data_cell:last-child');await testUtils.dom.click($enabledCell.prev());assert.containsOnce($enabledCell,':checked:not(:disabled)');var $enabledLabel=$enabledCell.find('.custom-control-label');await testUtils.dom.click($enabledLabel);assert.containsNone($enabledCell,':checked',"clicking enabled checkbox worked and unchecked it");assert.ok($(document.activeElement).is('input[type="checkbox"]'),"enabled checkbox is focused after click");list.destroy();});QUnit.test('grouped list with async widget',async function(assert){assert.expect(4);var prom=testUtils.makeTestPromise();var AsyncWidget=Widget.extend({willStart:function(){return prom;},start:function(){this.$el.text('ready');},});widgetRegistry.add('asyncWidget',AsyncWidget);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><widget name="asyncWidget"/></tree>',groupBy:['int_field'],});assert.containsNone(list,'.o_data_row',"no group should be open");await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsNone(list,'.o_data_row',"should wait for async widgets before opening the group");prom.resolve();await testUtils.nextTick();assert.containsN(list,'.o_data_row',1,"group should be open");assert.strictEqual(list.$('.o_data_row .o_data_cell').text(),'ready',"async widget should be correctly displayed");list.destroy();delete widgetRegistry.map.asyncWidget;});QUnit.test('grouped lists with groups_limit attribute',async function(assert){assert.expect(8);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree groups_limit="3"><field name="foo"/></tree>',groupBy:['int_field'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});assert.containsN(list,'.o_group_header',3);assert.containsNone(list,'.o_data_row');assert.containsOnce(list,'.o_pager');await cpHelpers.pagerNext(list);assert.containsN(list,'.o_group_header',1);assert.containsNone(list,'.o_data_row');assert.verifySteps(['web_read_group','web_read_group',]);list.destroy();});QUnit.test('grouped list with expand attribute',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree expand="1"><field name="foo"/></tree>',groupBy:['bar'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);}});assert.containsN(list,'.o_group_header',2);assert.containsN(list,'.o_data_row',4);assert.strictEqual(list.$('.o_data_cell').text(),'yopblipgnapblip');assert.verifySteps(['web_read_group',]);list.destroy();});QUnit.test('grouped list (two levels) with expand attribute',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree expand="1"><field name="foo"/></tree>',groupBy:['bar','int_field'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);}});assert.containsN(list,'.o_group_header',6);assert.verifySteps(['web_read_group','web_read_group','web_read_group',]);list.destroy();});QUnit.test('grouped lists with expand attribute and a lot of groups',async function(assert){assert.expect(8);for(var i=0;i<15;i++){this.data.foo.records.push({foo:'record '+i,int_field:i});}
var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree expand="1"><field name="foo"/></tree>',groupBy:['int_field'],mockRPC:function(route,args){if(args.method==='web_read_group'){assert.step(args.method);}
return this._super.apply(this,arguments);},});assert.containsN(list,'.o_group_header',10);assert.containsN(list,'.o_data_row',11);assert.containsOnce(list,'.o_pager');await cpHelpers.pagerNext(list);assert.containsN(list,'.o_group_header',7);assert.containsN(list,'.o_data_row',7);assert.verifySteps(['web_read_group','web_read_group',]);list.destroy();});QUnit.test('add filter in a grouped list with a pager',async function(assert){assert.expect(11);const actionManager=await createActionManager({data:this.data,actions:[{id:11,name:'Action 11',res_model:'foo',type:'ir.actions.act_window',views:[[3,'list']],search_view_id:[9,'search'],flags:{context:{group_by:['int_field']},},}],archs:{'foo,3,list':'<tree groups_limit="3"><field name="foo"/></tree>','foo,9,search':`
                    <search>
                        <filter string="Not Bar" name="not bar" domain="[['bar','=',False]]"/>
                    </search>`,},mockRPC:function(route,args){if(args.method==='web_read_group'){assert.step(JSON.stringify(args.kwargs.domain)+', '+args.kwargs.offset);}
return this._super.apply(this,arguments);},});await actionManager.doAction(11);assert.containsOnce(actionManager,'.o_list_view');assert.strictEqual(actionManager.$('.o_pager_counter').text().trim(),'1-3 / 4');assert.containsN(actionManager,'.o_group_header',3);await testUtils.dom.click(actionManager.$('.o_pager_next'));assert.strictEqual(actionManager.$('.o_pager_counter').text().trim(),'4-4 / 4');assert.containsN(actionManager,'.o_group_header',1);await cpHelpers.toggleFilterMenu(actionManager);await cpHelpers.toggleMenuItem(actionManager,0);assert.strictEqual(actionManager.$('.o_pager_counter').text().trim(),'1-1 / 1');assert.containsN(actionManager,'.o_group_header',1);assert.verifySteps(['[], undefined','[], 3','[["bar","=",false]], undefined',]);actionManager.destroy();});QUnit.test('editable grouped lists',async function(assert){assert.expect(4);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_data_cell:first'));assert.containsOnce(list,'.o_selected_row .o_data_cell:first');await testUtils.dom.click($('body'));assert.containsNone(list,'.o_selected_row');await list.reload({groupBy:[]});await testUtils.dom.click(list.$('.o_data_cell:first'));assert.containsOnce(list,'.o_selected_row .o_data_cell:first');await testUtils.dom.click($('body'));assert.containsNone(list,'.o_selected_row');list.destroy();});QUnit.test('grouped lists are editable (ungrouped first)',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="bar"/></tree>',});await testUtils.dom.click(list.$('.o_data_cell:first'));assert.containsOnce(list,'.o_selected_row .o_data_cell:first');await list.reload({groupBy:['bar']});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_data_cell:first'));assert.containsOnce(list,'.o_selected_row .o_data_cell:first');list.destroy();});QUnit.test('char field edition in editable grouped list',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.fields.editAndTrigger(list.$('tr.o_selected_row .o_data_cell:first input[name="foo"]'),'pla','input');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.strictEqual(this.data.foo.records[0].foo,'pla',"the edition should have been properly saved");assert.containsOnce(list,'.o_data_row:first:contains(pla)');list.destroy();});QUnit.test('control panel buttons in editable grouped list views',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],});assert.isNotVisible(list.$buttons.find('.o_list_button_add'));await list.reload({groupBy:[]});assert.isVisible(list.$buttons.find('.o_list_button_add'));list.destroy();});QUnit.test('control panel buttons in multi editable grouped list views',async function(assert){assert.expect(8);const list=await createView({View:ListView,model:'foo',data:this.data,groupBy:['foo'],arch:`<tree multi_edit="1">
                    <field name="foo"/>
                    <field name="int_field"/>
                </tree>`,});assert.containsNone(list,'.o_data_row',"all groups should be closed");assert.isVisible(list.$buttons.find('.o_list_button_add'),"should have a visible Create button");await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',1,"first group should be opened");assert.isVisible(list.$buttons.find('.o_list_button_add'),"should have a visible Create button");await testUtils.dom.click(list.$('.o_data_row:eq(0) .o_list_record_selector input'));assert.containsOnce(list,'.o_data_row:eq(0) .o_list_record_selector input:enabled',"should have selected first record");assert.isVisible(list.$buttons.find('.o_list_button_add'),"should have a visible Create button");await testUtils.dom.click(list.$('.o_group_header:last'));assert.containsN(list,'.o_data_row',2,"two groups should be opened");assert.isVisible(list.$buttons.find('.o_list_button_add'),"should have a visible Create button");list.destroy();});QUnit.test('edit a line and discard it in grouped editable',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="int_field"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_data_row:nth(2) > td:contains(gnap)'));assert.ok(list.$('.o_data_row:nth(2)').is('.o_selected_row'),"third group row should be in edition");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));await testUtils.dom.click(list.$('.o_data_row:nth(0) > td:contains(yop)'));assert.ok(list.$('.o_data_row:eq(0)').is('.o_selected_row'),"first group row should be in edition");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.containsNone(list,'.o_selected_row');await testUtils.dom.click(list.$('.o_data_row:nth(2) > td:contains(gnap)'));assert.containsOnce(list,'.o_selected_row');assert.ok(list.$('.o_data_row:nth(2)').is('.o_selected_row'),"third group row should be in edition");list.destroy();});QUnit.test('add and discard a record in a multi-level grouped list view',async function(assert){assert.expect(7);testUtils.mock.patch(basicFields.FieldChar,{destroy:function(){assert.step('destroy');this._super.apply(this,arguments);},});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo" required="1"/></tree>',groupBy:['foo','bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_header:eq(1)'));assert.hasClass(list.$('.o_group_header:first'),'o_group_open');assert.hasClass(list.$('.o_group_header:eq(1)'),'o_group_open');assert.containsOnce(list,'.o_data_row');await testUtils.dom.click(list.$('.o_group_field_row_add a'));assert.containsN(list,'.o_data_row',2);await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.containsOnce(list,'.o_data_row');assert.verifySteps(['destroy']);testUtils.mock.unpatch(basicFields.FieldChar);list.destroy();});QUnit.test('inputs are disabled when unselecting rows in grouped editable',async function(assert){assert.expect(1);var $input;var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',mockRPC:function(route,args){if(args.method==='write'){assert.strictEqual($input.prop('disabled'),true,"input should be disabled");}
return this._super.apply(this,arguments);},groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('td:contains(yop)'));$input=list.$('tr.o_selected_row input[name="foo"]');await testUtils.fields.editAndTrigger($input,'lemon','input');await testUtils.fields.triggerKeydown($input,'tab');list.destroy();});QUnit.test('pressing ESC in editable grouped list should discard the current line changes',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/><field name="bar"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'tr.o_data_row',3);await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.fields.editAndTrigger(list.$('tr.o_selected_row .o_data_cell:first input[name="foo"]'),'new_value','input');await testUtils.fields.triggerKeydown(list.$('input[name="foo"]'),'escape');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.containsOnce(list,'tbody tr td:contains(yop)');assert.containsN(list,'tr.o_data_row',3);assert.containsNone(list,'tr.o_data_row.o_selected_row');assert.isNotVisible(list.$buttons.find('.o_list_button_save'));list.destroy();});QUnit.test('pressing TAB in editable="bottom" grouped list',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',3,'first group contains 3 rows');await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.containsN(list,'.o_data_row',4,'first group contains 1 row');await testUtils.dom.click(list.$('.o_data_cell:first'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(3)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');list.destroy();});QUnit.test('pressing TAB in editable="top" grouped list',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',3,'first group contains 3 rows');await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.containsN(list,'.o_data_row',4,'first group contains 1 row');await testUtils.dom.click(list.$('.o_data_cell:first'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(3)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');list.destroy();});QUnit.test('pressing TAB in editable grouped list with create=0',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom" create="0"><field name="foo"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',3,'first group contains 3 rows');await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.containsN(list,'.o_data_row',4,'first group contains 1 row');await testUtils.dom.click(list.$('.o_data_cell:first'));assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:nth(3)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.hasClass(list.$('.o_data_row:first'),'o_selected_row');list.destroy();});QUnit.test('pressing SHIFT-TAB in editable="bottom" grouped list',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',3,'first group contains 3 rows');await testUtils.dom.click(list.$('.o_group_header:eq(1)'));assert.containsN(list,'.o_data_row',4,'first group contains 1 row');await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell'));assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('tr.o_data_row:first'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.dom.click(list.$('.o_data_cell:eq(3)'));list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');list.destroy();});QUnit.test('pressing SHIFT-TAB in editable="top" grouped list',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',3,'first group contains 3 rows');await testUtils.dom.click(list.$('.o_group_header:eq(1)'));assert.containsN(list,'.o_data_row',4,'first group contains 1 row');await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell'));assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('tr.o_data_row:first'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.dom.click(list.$('.o_data_cell:eq(3)'));list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');list.destroy();});QUnit.test('pressing SHIFT-TAB in editable grouped list with create="0"',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top" create="0"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',3,'first group contains 3 rows');await testUtils.dom.click(list.$('.o_group_header:eq(1)'));assert.containsN(list,'.o_data_row',4,'first group contains 1 row');await testUtils.dom.click(list.$('.o_data_row:eq(1) .o_data_cell'));assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('tr.o_data_row:first'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.dom.click(list.$('.o_data_cell:eq(3)'));list.$('tr.o_selected_row input').trigger($.Event('keydown',{which:$.ui.keyCode.TAB,shiftKey:true}));await testUtils.nextTick();assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');list.destroy();});QUnit.test('editing then pressing TAB in editable grouped list',async function(assert){assert.expect(19);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsN(list,'.o_data_row',3,'first group contains 3 rows');await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.containsN(list,'.o_data_row',4,'first group contains 1 row');await testUtils.dom.click(list.$('.o_data_row:nth(2) .o_data_cell'));assert.hasClass(list.$('.o_data_row:nth(2)'),'o_selected_row');await testUtils.fields.editInput(list.$('.o_selected_row input[name="foo"]'),'new value');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.containsN(list,'.o_data_row',5);assert.hasClass(list.$('.o_data_row:nth(3)'),'o_selected_row');await testUtils.fields.editInput(list.$('.o_selected_row input[name="foo"]'),'new record');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.containsN(list,'.o_data_row',6);assert.hasClass(list.$('.o_data_row:nth(4)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('.o_selected_row .o_input'),'tab');assert.containsN(list,'.o_data_row',5);assert.hasClass(list.$('.o_data_row:nth(4)'),'o_selected_row');assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','write','read','onchange','create','read','onchange',]);list.destroy();});QUnit.test('editing then pressing TAB (with a readonly field) in grouped list',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/><field name="int_field" readonly="1"/></tree>',mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},groupBy:['bar'],fieldDebounce:1});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('td:contains(yop)'));await testUtils.fields.editAndTrigger(list.$('tr.o_selected_row input[name="foo"]'),'new value','input');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row input[name="foo"]'),'tab');assert.containsOnce(list,'tbody tr td:contains(new value)');assert.verifySteps(['web_read_group','/web/dataset/search_read','write','read',]);list.destroy();});QUnit.test('pressing ENTER in editable="bottom" grouped list view',async function(assert){assert.expect(11);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo"/></tree>',mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.containsN(list,'tr.o_data_row',4);await testUtils.dom.click(list.$('.o_data_row:nth(1) .o_data_cell'));assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row .o_input'),'enter');assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row .o_input'),'enter');assert.containsN(list,'tr.o_data_row',5);assert.hasClass(list.$('tr.o_data_row:eq(3)'),'o_selected_row');assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','onchange',]);list.destroy();});QUnit.test('pressing ENTER in editable="top" grouped list view',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo"/></tree>',mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.containsN(list,'tr.o_data_row',4);await testUtils.dom.click(list.$('.o_data_row:nth(1) .o_data_cell'));assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row .o_input'),'enter');assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row .o_input'),'enter');assert.hasClass(list.$('tr.o_data_row:eq(3)'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read',]);list.destroy();});QUnit.test('pressing ENTER in editable grouped list view with create=0',async function(assert){assert.expect(10);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom" create="0"><field name="foo"/></tree>',mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_header:nth(1)'));assert.containsN(list,'tr.o_data_row',4);await testUtils.dom.click(list.$('.o_data_row:nth(1) .o_data_cell'));assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row .o_input'),'enter');assert.hasClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row');await testUtils.fields.triggerKeydown(list.$('tr.o_selected_row .o_input'),'enter');assert.hasClass(list.$('tr.o_data_row:eq(3)'),'o_selected_row');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(2)'),'o_selected_row');assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read',]);list.destroy();});QUnit.test('cell-level keyboard navigation in non-editable list',async function(assert){assert.expect(16);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo" required="1"/></tree>',intercepts:{switch_view:function(event){assert.strictEqual(event.data.res_id,3,"'switch_view' event has been triggered");},},});assert.ok(document.activeElement.classList.contains('o_searchview_input'),'default focus should be in search view');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'INPUT','focus should now be on the record selector');await testUtils.fields.triggerKeydown($(document.activeElement),'up');assert.ok(document.activeElement.classList.contains('o_searchview_input'),'focus should have come back to the search view');await testUtils.fields.triggerKeydown($(document.activeElement),'down');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'INPUT','focus should now be in first row input');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(document.activeElement.tagName,'TD','focus should now be in field TD');assert.strictEqual(document.activeElement.textContent,'yop','focus should now be in first row field');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(document.activeElement.textContent,'yop','should not cycle at end of line');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'blip','focus should now be in second row field');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'gnap','focus should now be in third row field');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'blip','focus should now be in last row field');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'blip','focus should still be in last row field (arrows do not cycle)');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(document.activeElement.textContent,'blip','focus should still be in last row field (arrows still do not cycle)');await testUtils.fields.triggerKeydown($(document.activeElement),'left');assert.strictEqual(document.activeElement.tagName,'INPUT','focus should now be in last row input');await testUtils.fields.triggerKeydown($(document.activeElement),'left');assert.strictEqual(document.activeElement.tagName,'INPUT','should not cycle at start of line');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(document.activeElement.textContent,'gnap','focus should now be in third row field');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');list.destroy();});QUnit.test('cell-level keyboard navigation in editable grouped list',async function(assert){assert.expect(56);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('td:contains(blip)'));assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row','second row should be opened');var $secondRowInput=list.$('tr.o_data_row:eq(1) td:eq(1) input');assert.strictEqual($secondRowInput.val(),'blip','second record should be in edit mode');await testUtils.fields.editAndTrigger($secondRowInput,'blipbloup','input');assert.strictEqual($secondRowInput.val(),'blipbloup','second record should be changed but not saved yet');await testUtils.fields.triggerKeydown($(document.activeElement),'escape');assert.hasClass($('body'),'modal-open','record has been modified, are you sure modal should be opened');await testUtils.dom.click($('body .modal button span:contains(Ok)'));assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row','second row should be closed');assert.strictEqual(document.activeElement.tagName,'TD','focus is in field td');assert.strictEqual(document.activeElement.textContent,'blip','second field of second record should be focused');assert.strictEqual(list.$('tr.o_data_row:eq(1) td:eq(1)').text(),'blip','change should not have been saved');await testUtils.fields.triggerKeydown($(document.activeElement),'left');assert.strictEqual(document.activeElement.tagName,'INPUT','record selector should be focused');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(document.activeElement.tagName,'TD','focus is in first record td');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');var $firstRowInput=list.$('tr.o_data_row:eq(0) td:eq(1) input');assert.hasClass(list.$('tr.o_data_row:eq(0)'),'o_selected_row','first row should be selected');assert.strictEqual($firstRowInput.val(),'yop','first record should be in edit mode');await testUtils.fields.editAndTrigger($firstRowInput,'Zipadeedoodah','input');assert.strictEqual($firstRowInput.val(),'Zipadeedoodah','first record should be changed but not saved yet');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.strictEqual(list.$('tr.o_data_row:eq(0) td:eq(1)').text(),'Zipadeedoodah','first record should be saved');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(0)'),'o_selected_row','first row should be closed');assert.hasClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row','second row should be opened');assert.strictEqual(list.$('tr.o_data_row:eq(1) td:eq(1) input').val(),'blip','second record should be in edit mode');assert.strictEqual(document.activeElement.value,'blip','second record input should be focused');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(document.activeElement.value,'blip','second record input should still be focused (arrows movements are disabled in edit)');await testUtils.fields.triggerKeydown($(document.activeElement),'down');await testUtils.fields.triggerKeydown($(document.activeElement),'left');assert.strictEqual(document.activeElement.value,'blip','second record input should still be focused (arrows movements are still disabled in edit)');await testUtils.fields.triggerKeydown($(document.activeElement),'escape');assert.doesNotHaveClass(list.$('tr.o_data_row:eq(1)'),'o_selected_row','second row should be closed');assert.strictEqual(document.activeElement.tagName,'TD','focus is in field td');assert.strictEqual(document.activeElement.textContent,'blip','second field of second record should be focused');await testUtils.fields.triggerKeydown($(document.activeElement),'down');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'A','should focus the "Add a line" button');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'false (1)','focus should be on second group header');assert.strictEqual(list.$('tr.o_data_row').length,3,'should have 3 rows displayed');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.strictEqual(list.$('tr.o_data_row').length,4,'should have 4 rows displayed');assert.strictEqual(document.activeElement.textContent,'false (1)','focus should still be on second group header');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'blip','second field of last record should be focused');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'A','should focus the "Add a line" button');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'A','arrow navigation should not cycle (focus still on last row)');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');await testUtils.fields.editAndTrigger($('tr.o_data_row:eq(4) td:eq(1) input'),'cheateur arrete de cheater','input');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.strictEqual(list.$('tr.o_data_row').length,6,'should have 6 rows displayed (new record + new edit line)');await testUtils.fields.triggerKeydown($(document.activeElement),'escape');assert.strictEqual(document.activeElement.tagName,'A','should focus the "Add a line" button');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');await testUtils.fields.triggerKeydown($(document.activeElement),'up');assert.strictEqual(document.activeElement.tagName,'TH','focus is in table header');await testUtils.fields.triggerKeydown($(document.activeElement),'left');assert.strictEqual(document.activeElement.tagName,'INPUT','focus is in header input');await testUtils.fields.triggerKeydown($(document.activeElement),'down');await testUtils.fields.triggerKeydown($(document.activeElement),'down');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(document.activeElement.tagName,'TD','focus is in field td');assert.strictEqual(document.activeElement.textContent,'Zipadeedoodah','second field of first record should be focused');await testUtils.fields.triggerKeydown($(document.activeElement),'up');assert.strictEqual(document.activeElement.textContent,'true (3)','focus should be on first group header');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.strictEqual(list.$('tr.o_data_row').length,2,'should have 2 rows displayed (first group should be closed)');assert.strictEqual(document.activeElement.textContent,'true (3)','focus should still be on first group header');assert.strictEqual(list.$('tr.o_data_row').length,2,'should have 2 rows displayed');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(list.$('tr.o_data_row').length,5,'should have 5 rows displayed');assert.strictEqual(document.activeElement.textContent,'true (3)','focus is still in header');await testUtils.fields.triggerKeydown($(document.activeElement),'right');assert.strictEqual(list.$('tr.o_data_row').length,5,'should have 5 rows displayed');assert.strictEqual(document.activeElement.textContent,'true (3)','focus is still in header');await testUtils.fields.triggerKeydown($(document.activeElement),'left');assert.strictEqual(list.$('tr.o_data_row').length,2,'should have 2 rows displayed');assert.strictEqual(document.activeElement.textContent,'true (3)','focus is still in header');await testUtils.fields.triggerKeydown($(document.activeElement),'left');assert.strictEqual(list.$('tr.o_data_row').length,2,'should have 2 rows displayed');assert.strictEqual(document.activeElement.textContent,'true (3)','focus is still in header');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'false (2)','focus should now be on second group header');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'TD','record td should be focused');assert.strictEqual(document.activeElement.textContent,'blip','second field of first record of second group should be focused');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'cheateur arrete de cheater','second field of last record of second group should be focused');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'A','should focus the "Add a line" button');await testUtils.fields.triggerKeydown($(document.activeElement),'up');assert.strictEqual(document.activeElement.textContent,'cheateur arrete de cheater','second field of last record of second group should be focused (special case: the first td of the "Add a line" line was skipped');await testUtils.fields.triggerKeydown($(document.activeElement),'up');assert.strictEqual(document.activeElement.textContent,'blip','second field of first record of second group should be focused');list.destroy();});QUnit.test('execute group header button with keyboard navigation',async function(assert){assert.expect(13);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<groupby name="m2o">'+'<button type="object" name="some_method" string="Do this"/>'+'</groupby>'+'</tree>',groupBy:['m2o'],intercepts:{execute_action:function(ev){assert.strictEqual(ev.data.action_data.name,'some_method');},},});assert.containsNone(list,'.o_data_row',"all groups should be closed");list.$('.o_list_button_add').focus();assert.ok(document.activeElement.classList.contains('o_list_button_add'));await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'INPUT','focus should now be on the record selector (list header)');await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.textContent,'Value 1 (3)','focus should be on first group header');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.containsN(list,'.o_data_row',3,"first group should be open");await testUtils.fields.triggerKeydown($(document.activeElement),'down');assert.strictEqual(document.activeElement.tagName,'INPUT','focus should be in first row checkbox');await testUtils.fields.triggerKeydown($(document.activeElement),'up');assert.ok(document.activeElement.classList.contains('o_group_name'),'focus should be back on first group header');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.ok(document.activeElement.classList.contains('o_group_name'),'focus should still be on first group header');assert.containsNone(list,'.o_data_row',"first group should now be folded");await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.ok(document.activeElement.classList.contains('o_group_name'),'focus should still be on first group header');assert.containsN(list,'.o_data_row',3,"first group should be open");list.$('.o_group_header .o_group_buttons button:first').focus();assert.strictEqual(document.activeElement.tagName,'BUTTON','focus should be on the group header button');await testUtils.fields.triggerKeydown($(document.activeElement),'enter');assert.containsN(list,'.o_data_row',3,"first group should still be open");list.destroy();});QUnit.test('add a new row in grouped editable="top" list',async function(assert){assert.expect(7);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_field_row_add a'));assert.strictEqual(list.$('.o_selected_row .o_input[name=foo]')[0],document.activeElement,'The first input of the line should have the focus');assert.containsN(list,'tbody:nth(1) .o_data_row',4);await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));await testUtils.dom.click(list.$('.o_group_header:eq(1)'));assert.containsOnce(list,'tbody:nth(3) .o_data_row');await testUtils.dom.click(list.$('.o_group_field_row_add a:eq(1)'));assert.strictEqual(list.$('.o_group_name:eq(1)').text(),'false (2)',"group should have correct name and count");assert.containsN(list,'tbody:nth(3) .o_data_row',2);assert.hasClass(list.$('.o_data_row:nth(3)'),'o_selected_row');await testUtils.fields.editAndTrigger(list.$('tr.o_selected_row input[name="foo"]'),'pla','input');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.containsN(list,'tbody:nth(3) .o_data_row',2);list.destroy();});QUnit.test('add a new row in grouped editable="bottom" list',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_field_row_add a'));assert.hasClass(list.$('.o_data_row:nth(3)'),'o_selected_row');assert.containsN(list,'tbody:nth(1) .o_data_row',4);await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));await testUtils.dom.click(list.$('.o_group_header:eq(1)'));assert.containsOnce(list,'tbody:nth(3) .o_data_row');await testUtils.dom.click(list.$('.o_group_field_row_add a:eq(1)'));assert.hasClass(list.$('.o_data_row:nth(4)'),'o_selected_row');await testUtils.fields.editAndTrigger(list.$('tr.o_selected_row input[name="foo"]'),'pla','input');await testUtils.dom.click(list.$buttons.find('.o_list_button_save'));assert.containsN(list,'tbody:nth(3) .o_data_row',2);list.destroy();});QUnit.test('add and discard a line through keyboard navigation without crashing',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="bottom"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.fields.triggerKeydown(list.$('.o_group_field_row_add'),'enter');assert.containsN(list,'tbody:nth(1) .o_data_row',4,"new data row should be created");await testUtils.dom.click(list.$buttons.find('.o_list_button_discard'));assert.containsN(list,'tbody:nth(1) .o_data_row',3,"new data row should be discarded.");list.destroy();});QUnit.test('editable grouped list with create="0"',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top" create="0"><field name="foo" required="1"/></tree>',groupBy:['bar'],});await testUtils.dom.click(list.$('.o_group_header:first'));assert.containsNone(list,'.o_group_field_row_add a',"Add a line should not be available in readonly");list.destroy();});QUnit.test('add a new row in (selection) grouped editable list',async function(assert){assert.expect(6);this.data.foo.fields.priority={string:"Priority",type:"selection",selection:[[1,"Low"],[2,"Medium"],[3,"High"]],default:1,};this.data.foo.records.push({id:5,foo:"blip",int_field:-7,m2o:1,priority:2});this.data.foo.records.push({id:6,foo:"blip",int_field:5,m2o:1,priority:3});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'<field name="priority"/>'+'<field name="m2o"/>'+'</tree>',groupBy:['priority'],mockRPC:function(route,args){if(args.method==='onchange'){assert.step(args.kwargs.context.default_priority.toString());}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_field_row_add a'));await testUtils.dom.click($('body'));assert.verifySteps(['1']);assert.strictEqual(list.$('.o_data_row .o_data_cell:eq(1)').text(),'Low',"should have a column name with a value from the groupby");await testUtils.dom.click(list.$('.o_group_header:eq(1)'));await testUtils.dom.click(list.$('.o_group_field_row_add a:eq(1)'));await testUtils.dom.click($('body'));assert.strictEqual(list.$('.o_data_row:nth(5) .o_data_cell:eq(1)').text(),'Medium',"should have a column name with a value from the groupby");assert.verifySteps(['2']);list.destroy();});QUnit.test('add a new row in (m2o) grouped editable list',async function(assert){assert.expect(6);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'<field name="m2o"/>'+'</tree>',groupBy:['m2o'],mockRPC:function(route,args){if(args.method==='onchange'){assert.step(args.kwargs.context.default_m2o.toString());}
return this._super.apply(this,arguments);},});await testUtils.dom.click(list.$('.o_group_header:first'));await testUtils.dom.click(list.$('.o_group_field_row_add a'));await testUtils.dom.click($('body'));assert.strictEqual(list.$('tbody:eq(1) .o_data_row:first .o_data_cell:eq(1)').text(),'Value 1',"should have a column name with a value from the groupby");assert.verifySteps(['1']);await testUtils.dom.click(list.$('.o_group_header:eq(1)'));await testUtils.dom.click(list.$('.o_group_field_row_add a:eq(1)'));await testUtils.dom.click($('body'));assert.strictEqual(list.$('tbody:eq(3) .o_data_row:first .o_data_cell:eq(1)').text(),'Value 2',"should have a column name with a value from the groupby");assert.verifySteps(['2']);list.destroy();});QUnit.test('list view with optional fields rendering',async function(assert){assert.expect(12);var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="m2o" optional="hide"/>'+'<field name="amount"/>'+'<field name="reference" optional="hide"/>'+'</tree>',services:{local_storage:RamStorageService,},translateParameters:{direction:'ltr',}});assert.containsN(list,'th',3,"should have 3 th, 1 for selector, 2 for columns");assert.containsOnce(list.$('table'),'.o_optional_columns_dropdown_toggle',"should have the optional columns dropdown toggle inside the table");const optionalFieldsToggler=list.el.querySelector('table').lastElementChild;assert.ok(optionalFieldsToggler.classList.contains('o_optional_columns_dropdown_toggle'),'The optional fields toggler is the second last element');const optionalFieldsDropdown=list.el.querySelector('.o_list_view').lastElementChild;assert.ok(optionalFieldsDropdown.classList.contains('o_optional_columns'),'The optional fields dropdown is the last element');assert.ok(list.$('.o_optional_columns .dropdown-menu').hasClass('dropdown-menu-right'),'In LTR, the dropdown should be anchored to the right and expand to the left');await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));assert.containsN(list,'div.o_optional_columns div.dropdown-item',2,"dropdown have 2 optional field foo with checked and bar with unchecked");await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:first input'));assert.containsN(list,'th',4,"should have 4 th");assert.ok(list.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));assert.strictEqual(list.$('div.o_optional_columns div.dropdown-item:first input:checked')[0],list.$('div.o_optional_columns div.dropdown-item [name="m2o"]')[0],"m2o advanced field check box should be checked in dropdown");await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:first input'));assert.containsN(list,'th',3,"should have 3 th");assert.notOk(list.$('th:contains(M2O field)').is(':visible'),"should not have a visible m2o field");await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));assert.notOk(list.$('div.o_optional_columns div.dropdown-item [name="m2o"]').is(":checked"));list.destroy();});QUnit.test('list view with optional fields rendering in RTL mode',async function(assert){assert.expect(4);var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="m2o" optional="hide"/>'+'<field name="amount"/>'+'<field name="reference" optional="hide"/>'+'</tree>',services:{local_storage:RamStorageService,},translateParameters:{direction:'rtl',}});assert.containsOnce(list.$('table'),'.o_optional_columns_dropdown_toggle',"should have the optional columns dropdown toggle inside the table");const optionalFieldsToggler=list.el.querySelector('table').lastElementChild;assert.ok(optionalFieldsToggler.classList.contains('o_optional_columns_dropdown_toggle'),'The optional fields toggler is the last element');const optionalFieldsDropdown=list.el.querySelector('.o_list_view').lastElementChild;assert.ok(optionalFieldsDropdown.classList.contains('o_optional_columns'),'The optional fields is the last element');assert.ok(list.$('.o_optional_columns .dropdown-menu').hasClass('dropdown-menu-left'),'In RTL, the dropdown should be anchored to the left and expand to the right');list.destroy();});QUnit.test('optional fields do not disappear even after listview reload',async function(assert){assert.expect(7);var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="m2o" optional="hide"/>'+'<field name="amount"/>'+'<field name="reference" optional="hide"/>'+'</tree>',services:{local_storage:RamStorageService,},});assert.containsN(list,'th',3,"should have 3 th, 1 for selector, 2 for columns");await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));assert.notOk(list.$('div.o_optional_columns div.dropdown-item [name="m2o"]').is(":checked"));await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:first input'));assert.containsN(list,'th',4,"should have 4 th 1 for selector, 3 for columns");assert.ok(list.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");await list.reload();assert.containsN(list,'th',4,"should have 4 th 1 for selector, 3 for columns ever after listview reload");assert.ok(list.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field even after listview reload");await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));assert.ok(list.$('div.o_optional_columns div.dropdown-item [name="m2o"]').is(":checked"));list.destroy();});QUnit.test('selection is kept when optional fields are toggled',async function(assert){assert.expect(7);var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="m2o" optional="hide"/>'+'</tree>',services:{local_storage:RamStorageService,},});assert.containsN(list,'th',2);await testUtils.dom.click(list.$('.o_data_row .o_list_record_selector input:first'));assert.containsOnce(list,'.o_list_record_selector input:checked');await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:first input'));assert.containsN(list,'th',3);assert.containsOnce(list,'.o_list_record_selector input:checked');await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsN(list,'.o_list_record_selector input:checked',5);await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:first input'));assert.containsN(list,'th',2);assert.containsN(list,'.o_list_record_selector input:checked',5);list.destroy();});QUnit.test('list view with optional fields and async rendering',async function(assert){assert.expect(14);const prom=testUtils.makeTestPromise();const FieldChar=fieldRegistry.get('char');fieldRegistry.add('asyncwidget',FieldChar.extend({async _render(){assert.ok(true,'the rendering must be async');this._super(...arguments);await prom;},}));const RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});const list=await createView({View:ListView,model:'foo',data:this.data,arch:`
                <tree>
                    <field name="m2o"/>
                    <field name="foo" widget="asyncwidget" optional="hide"/>
                </tree>`,services:{local_storage:RamStorageService,},});assert.containsN(list,'th',2);assert.isNotVisible(list.$('.o_optional_columns_dropdown'));await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));assert.isVisible(list.$('.o_optional_columns_dropdown'));assert.containsNone(list.$('.o_optional_columns_dropdown'),'input:checked');await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:first label'));assert.containsN(list,'th',2);assert.isVisible(list.$('.o_optional_columns_dropdown'));assert.containsNone(list.$('.o_optional_columns_dropdown'),'input:checked');prom.resolve();await testUtils.nextTick();assert.containsN(list,'th',3);assert.isVisible(list.$('.o_optional_columns_dropdown'));assert.containsOnce(list.$('.o_optional_columns_dropdown'),'input:checked');list.destroy();delete fieldRegistry.map.asyncwidget;});QUnit.test('change the viewType of the current action',async function(assert){assert.expect(25);this.actions=[{id:1,name:'Partners Action 1',res_model:'foo',type:'ir.actions.act_window',views:[[1,'kanban']],},{id:2,name:'Partners',res_model:'foo',type:'ir.actions.act_window',views:[[false,'list'],[1,'kanban']],}];this.archs={'foo,1,kanban':'<kanban><templates><t t-name="kanban-box">'+'<div class="oe_kanban_global_click"><field name="foo"/></div>'+'</t></templates></kanban>','foo,false,list':'<tree limit="3">'+'<field name="foo"/>'+'<field name="m2o" optional="hide"/>'+'<field name="o2m" optional="show"/></tree>','foo,false,search':'<search><field name="foo" string="Foo"/></search>',};var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});var actionManager=await testUtils.createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{local_storage:RamStorageService,},});await actionManager.doAction(2);assert.containsOnce(actionManager,'.o_list_view',"should have rendered a list view");assert.containsN(actionManager,'th',3,"should display 3 th (selector + 2 fields)");await testUtils.dom.click(actionManager.$('table .o_optional_columns_dropdown_toggle'));assert.notOk(actionManager.$('div.o_optional_columns div.dropdown-item [name="m2o"]').is(":checked"));assert.ok(actionManager.$('div.o_optional_columns div.dropdown-item [name="o2m"]').is(":checked"));await testUtils.dom.click(actionManager.$('div.o_optional_columns div.dropdown-item:first'));assert.containsN(actionManager,'th',4,"should display 4 th (selector + 3 fields)");assert.ok(actionManager.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");await actionManager.loadState({action:2,view_type:'kanban',});assert.containsNone(actionManager,'.o_list_view',"should not display the list view anymore");assert.containsOnce(actionManager,'.o_kanban_view',"should have switched to the kanban view");await actionManager.loadState({action:2,view_type:'list',});assert.containsNone(actionManager,'.o_kanban_view',"should not display the kanban view anymoe");assert.containsOnce(actionManager,'.o_list_view',"should display the list view");assert.containsN(actionManager,'th',4,"should display 4 th");assert.ok(actionManager.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");assert.ok(actionManager.$('th:contains(O2M field)').is(':visible'),"should have a visible o2m field");await testUtils.dom.click(actionManager.$('table .o_optional_columns_dropdown_toggle'));assert.ok(actionManager.$('div.o_optional_columns div.dropdown-item [name="m2o"]').is(":checked"));assert.ok(actionManager.$('div.o_optional_columns div.dropdown-item [name="o2m"]').is(":checked"));await testUtils.dom.click(actionManager.$('div.o_optional_columns div.dropdown-item:last input'));assert.ok(actionManager.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");assert.notOk(actionManager.$('th:contains(O2M field)').is(':visible'),"should have a visible o2m field");assert.containsN(actionManager,'th',3,"should display 3 th");await actionManager.doAction(1);assert.containsNone(actionManager,'.o_list_view',"should not display the list view anymore");assert.containsOnce(actionManager,'.o_kanban_view',"should have switched to the kanban view");await actionManager.doAction(2);assert.containsNone(actionManager,'.o_kanban_view',"should not havethe kanban view anymoe");assert.containsOnce(actionManager,'.o_list_view',"should display the list view");assert.containsN(actionManager,'th',3,"should display 3 th");assert.ok(actionManager.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");assert.notOk(actionManager.$('th:contains(O2M field)').is(':visible'),"should have a visible o2m field");actionManager.destroy();});QUnit.test('list view with optional fields rendering and local storage mock',async function(assert){assert.expect(12);var forceLocalStorage=true;var Storage=RamStorage.extend({getItem:function(key){assert.step('getItem '+key);return forceLocalStorage?'["m2o"]':this._super.apply(this,arguments);},setItem:function(key,value){assert.step('setItem '+key+' to '+value);return this._super.apply(this,arguments);},});var RamStorageService=AbstractStorageService.extend({storage:new Storage(),});var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="m2o" optional="hide"/>'+'<field name="reference" optional="show"/>'+'</tree>',services:{local_storage:RamStorageService,},view_id:42,});var localStorageKey='optional_fields,foo,list,42,foo,m2o,reference';assert.verifySteps(['getItem '+localStorageKey]);assert.containsN(list,'th',3,"should have 3 th, 1 for selector, 2 for columns");assert.ok(list.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");assert.notOk(list.$('th:contains(Reference Field)').is(':visible'),"should not have a visible reference field");await testUtils.dom.click(list.$('table .o_optional_columns_dropdown_toggle'));assert.containsN(list,'div.o_optional_columns div.dropdown-item',2,"dropdown have 2 optional fields");forceLocalStorage=false;await testUtils.dom.click(list.$('div.o_optional_columns div.dropdown-item:eq(1) input'));assert.verifySteps(['setItem '+localStorageKey+' to ["m2o","reference"]','getItem '+localStorageKey,]);assert.containsN(list,'th',4,"should have 4 th");assert.ok(list.$('th:contains(M2O field)').is(':visible'),"should have a visible m2o field");assert.ok(list.$('th:contains(Reference Field)').is(':visible'),"should have a visible reference field");list.destroy();});QUnit.test("quickcreate in a many2one in a list",async function(assert){assert.expect(2);const list=await createView({arch:'<tree editable="top"><field name="m2o"/></tree>',data:this.data,model:'foo',View:ListView,});await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:first'));const $input=list.$('.o_data_row:first .o_data_cell:first input');await testUtils.fields.editInput($input,"aaa");$input.trigger('keyup');$input.trigger('blur');document.body.click();await testUtils.nextTick();assert.containsOnce(document.body,'.modal',"the quick_create modal should appear");await testUtils.dom.click($('.modal .btn-primary:first'));await testUtils.dom.click(document.body);assert.strictEqual(list.el.getElementsByClassName('o_data_cell')[0].innerHTML,"aaa","value should have been updated");list.destroy();});QUnit.test('float field render with digits attribute on listview',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/><field name="qux" digits="[12,6]"/></tree>',});assert.strictEqual(list.$('td.o_list_number:eq(0)').text(),"0.400000","should contain 6 digits decimal precision");list.destroy();});QUnit.test('editable list: resize column headers',async function(assert){assert.expect(2);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<field name="foo"/>'+'<field name="reference" optional="hide"/>'+'</tree>',});const th=list.el.getElementsByTagName('th')[1];const optionalDropdown=list.el.getElementsByClassName('o_optional_columns')[0];const optionalInitialX=optionalDropdown.getBoundingClientRect().x;const resizeHandle=th.getElementsByClassName('o_resize')[0];const originalWidth=th.offsetWidth;const expectedWidth=Math.floor(originalWidth/2+resizeHandle.offsetWidth/2);const delta=originalWidth-expectedWidth;await testUtils.dom.dragAndDrop(resizeHandle,th,{mousemoveTarget:window,mouseupTarget:window});const optionalFinalX=Math.floor(optionalDropdown.getBoundingClientRect().x);assert.strictEqual(th.offsetWidth,expectedWidth,"header width should be halved (plus half the width of the handle)");assert.strictEqual(optionalFinalX,optionalInitialX-delta,"optional columns dropdown should have moved the same amount");list.destroy();});QUnit.test('resize column with several x2many lists in form group',async function(assert){assert.expect(3);this.data.bar.fields.text={string:"Text field",type:"char"};this.data.foo.records[0].o2m=[1,2];const form=await createView({View:FormView,model:'foo',data:this.data,arch:`
                <form>
                    <group>
                        <field name="o2m">
                            <tree editable="bottom">
                                <field name="display_name"/>
                                <field name="text"/>
                            </tree>
                        </field>
                        <field name="m2m">
                            <tree editable="bottom">
                                <field name="display_name"/>
                                <field name="text"/>
                            </tree>
                        </field>
                    </group>
                </form>`,res_id:1,});const th=form.el.getElementsByTagName('th')[0];const resizeHandle=th.getElementsByClassName('o_resize')[0];const firstTableInitialWidth=form.el.querySelectorAll('.o_field_x2many_list table')[0].offsetWidth;const secondTableInititalWidth=form.el.querySelectorAll('.o_field_x2many_list table')[1].offsetWidth;assert.strictEqual(firstTableInitialWidth,secondTableInititalWidth,"both table columns have same width");await testUtils.dom.dragAndDrop(resizeHandle,form.el.getElementsByTagName('th')[1],{position:"right"});assert.notEqual(firstTableInitialWidth,form.el.querySelectorAll('thead')[0].offsetWidth,"first o2m table is resized and width of table has changed");assert.strictEqual(secondTableInititalWidth,form.el.querySelectorAll('thead')[1].offsetWidth,"second o2m table should not be impacted on first o2m in group resized");form.destroy();});QUnit.test('enter edition in editable list with <widget>',async function(assert){assert.expect(1);var MyWidget=Widget.extend({start:function(){this.$el.html('<i class="fa fa-info"/>');},});widgetRegistry.add('some_widget',MyWidget);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top">'+'<widget name="some_widget"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:nth(1)'));assert.strictEqual(document.activeElement.name,"int_field");list.destroy();delete widgetRegistry.map.test;});QUnit.test('enter edition in editable list with multi_edit = 0',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top" multi_edit="0">'+'<field name="int_field"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:nth(0)'));assert.strictEqual(document.activeElement.name,"int_field");list.destroy();});QUnit.test('enter edition in editable list with multi_edit = 1',async function(assert){assert.expect(1);var list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree editable="top" multi_edit="1">'+'<field name="int_field"/>'+'</tree>',});await testUtils.dom.click(list.$('.o_data_row:first .o_data_cell:nth(0)'));assert.strictEqual(document.activeElement.name,"int_field");list.destroy();});QUnit.test('list view with field component: mounted and willUnmount calls',async function(assert){assert.expect(7);let mountedCalls=0;let willUnmountCalls=0;class MyField extends AbstractFieldOwl{mounted(){mountedCalls++;}
willUnmount(){willUnmountCalls++;}}
MyField.template=owl.tags.xml`<span>Hello World</span>`;fieldRegistryOwl.add('my_owl_field',MyField);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo" widget="my_owl_field"/></tree>',});assert.containsN(list,'.o_data_row',4);assert.strictEqual(mountedCalls,4);assert.strictEqual(willUnmountCalls,0);await list.reload();assert.strictEqual(mountedCalls,8);assert.strictEqual(willUnmountCalls,4);list.destroy();assert.strictEqual(mountedCalls,8);assert.strictEqual(willUnmountCalls,8);});QUnit.test('editable list view: multi edition of owl field component',async function(assert){assert.expect(5);const list=await createView({arch:'<tree multi_edit="1"><field name="bar"/></tree>',data:this.data,model:'foo',View:ListView,});assert.containsN(list,'.o_data_row',4);assert.containsN(list,'.o_data_cell .custom-checkbox input:checked',3);await testUtils.dom.click(list.$('thead .o_list_record_selector input'));assert.containsN(list,'.o_data_row .o_list_record_selector input:checked',4);await testUtils.dom.click(list.$('.o_data_cell:first'));await testUtils.dom.click(list.$('.o_data_cell .o_field_boolean input'));assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.containsNone(list,'.o_data_cell .custom-checkbox input:checked');list.destroy();});QUnit.test("Date in evaluation context works with date field",async function(assert){assert.expect(11);const dateRegex=/^\d{4}-\d{2}-\d{2}$/;const unpatchDate=testUtils.mock.patchDate(1997,0,9,12,0,0);testUtils.mock.patch(BasicModel,{_getEvalContext(){const evalContext=this._super(...arguments);assert.ok(dateRegex.test(evalContext.today));assert.strictEqual(evalContext.current_date,evalContext.today);return evalContext;},});this.data.foo.fields.birthday={string:"Birthday",type:'date'};this.data.foo.records[0].birthday="1997-01-08";this.data.foo.records[1].birthday="1997-01-09";this.data.foo.records[2].birthday="1997-01-10";const list=await createView({arch:`
                <tree>
                    <field name="birthday" decoration-danger="birthday > today"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});assert.containsOnce(list,".o_data_row .text-danger");list.destroy();unpatchDate();testUtils.mock.unpatch(BasicModel);});QUnit.test("Datetime in evaluation context works with datetime field",async function(assert){assert.expect(6);const datetimeRegex=/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/;const unpatchDate=testUtils.mock.patchDate(1997,0,9,12,0,0);testUtils.mock.patch(BasicModel,{_getEvalContext(){const evalContext=this._super(...arguments);assert.ok(datetimeRegex.test(evalContext.now));return evalContext;},});function dateStringDelta(deltaMinutes){const d=new Date(Date.now()+1000*60*deltaMinutes);return`1997-01-${
                String(d.getUTCDate()).padStart(2, '0')
            } ${
                String(d.getUTCHours()).padStart(2, '0')
            }:${
                String(d.getUTCMinutes()).padStart(2, '0')
            }:00`;}
this.data.foo.fields.birthday={string:"Birthday",type:'datetime'};this.data.foo.records[0].birthday=dateStringDelta(-30);this.data.foo.records[1].birthday=dateStringDelta(0);this.data.foo.records[2].birthday=dateStringDelta(+30);const list=await createView({arch:`
                <tree>
                    <field name="birthday" decoration-danger="birthday > now"/>
                </tree>`,data:this.data,model:'foo',View:ListView,});assert.containsOnce(list,".o_data_row .text-danger");list.destroy();unpatchDate();testUtils.mock.unpatch(BasicModel);});QUnit.test("update control panel while list view is mounting",async function(assert){const ControlPanel=require('web.ControlPanel');const ListController=require('web.ListController');let mountedCounterCall=0;ControlPanel.patch('test.ControlPanel',T=>{class ControlPanelPatchTest extends T{mounted(){mountedCounterCall=mountedCounterCall+1;assert.step(`mountedCounterCall-${mountedCounterCall}`);super.mounted(...arguments);}}
return ControlPanelPatchTest;});const MyListView=ListView.extend({config:Object.assign({},ListView.prototype.config,{Controller:ListController.extend({async start(){await this._super(...arguments);this.renderer._updateSelection();},}),}),});assert.expect(2);const list=await createView({View:MyListView,model:'event',data:this.data,arch:'<tree><field name="name"/></tree>',});assert.verifySteps(['mountedCounterCall-1',]);ControlPanel.unpatch('test.ControlPanel');list.destroy();});});});;

/* /web/static/tests/views/pivot_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.pivot_tests',function(require){"use strict";var core=require('web.core');var PivotView=require('web.PivotView');const PivotController=require("web.PivotController");var testUtils=require('web.test_utils');var testUtilsDom=require('web.test_utils_dom');var _t=core._t;const cpHelpers=testUtils.controlPanel;var createActionManager=testUtils.createActionManager;var createView=testUtils.createView;var patchDate=testUtils.mock.patchDate;var getCurrentValues=function(pivot){return pivot.$('.o_pivot_cell_value div').map(function(){return $(this).text();}).get().join();};QUnit.module('Views',{beforeEach:function(){this.data={partner:{fields:{foo:{string:"Foo",type:"integer",searchable:true,group_operator:'sum'},bar:{string:"bar",type:"boolean",store:true,sortable:true},date:{string:"Date",type:"date",store:true,sortable:true},product_id:{string:"Product",type:"many2one",relation:'product',store:true},other_product_id:{string:"Other Product",type:"many2one",relation:'product',store:true},non_stored_m2o:{string:"Non Stored M2O",type:"many2one",relation:'product'},customer:{string:"Customer",type:"many2one",relation:'customer',store:true},computed_field:{string:"Computed and not stored",type:'integer',compute:true,group_operator:'sum'},company_type:{string:"Company Type",type:"selection",selection:[["company","Company"],["individual","individual"]],searchable:true,sortable:true,store:true,},},records:[{id:1,foo:12,bar:true,date:'2016-12-14',product_id:37,customer:1,computed_field:19,company_type:'company',},{id:2,foo:1,bar:true,date:'2016-10-26',product_id:41,customer:2,computed_field:23,company_type:'individual',},{id:3,foo:17,bar:true,date:'2016-12-15',product_id:41,customer:2,computed_field:26,company_type:'company',},{id:4,foo:2,bar:false,date:'2016-04-11',product_id:41,customer:1,computed_field:19,company_type:'individual',},]},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},customer:{fields:{name:{string:"Customer Name",type:"char"}},records:[{id:1,display_name:"First",},{id:2,display_name:"Second",}]},};},},function(){QUnit.module('PivotView');QUnit.test('simple pivot rendering',async function(assert){assert.expect(3);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'<field name="foo" type="measure"/>'+'</pivot>',mockRPC:function(route,args){assert.strictEqual(args.kwargs.lazy,false,"the read_group should be done with the lazy=false option");return this._super.apply(this,arguments);},});assert.hasClass(pivot.$('table'),'o_enable_linking',"table should have classname 'o_enable_linking'");assert.strictEqual(pivot.$('td.o_pivot_cell_value:contains(32)').length,1,"should contain a pivot cell with the sum of all records");pivot.destroy();});QUnit.test('pivot rendering with widget',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'<field name="foo" type="measure" widget="float_time"/>'+'</pivot>',});assert.strictEqual(pivot.$('td.o_pivot_cell_value:contains(32:00)').length,1,"should contain a pivot cell with the sum of all records");pivot.destroy();});QUnit.test('pivot rendering with string attribute on field',async function(assert){assert.expect(1);this.data.partner.fields.foo={string:"Foo",type:"integer",store:true,group_operator:'sum'};var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'<field name="foo" string="BAR" type="measure"/>'+'</pivot>',});assert.strictEqual(pivot.$('.o_pivot_measure_row').text(),"BAR","the displayed name should be the one set in the string attribute");pivot.destroy();});QUnit.test('pivot rendering with string attribute on non stored field',async function(assert){assert.expect(1);this.data.partner.fields.fubar={string:"Fubar",type:"integer",store:false,group_operator:'sum'};var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'<field name="fubar" string="fubar" type="measure"/>'+'</pivot>',});assert.containsOnce(pivot,'.o_pivot','Non stored fields can have a string attribute');pivot.destroy();});QUnit.test('pivot rendering with invisible attribute on field',async function(assert){assert.expect(3);_.extend(this.data.partner.fields,{foo:{string:"Foo",type:"integer",store:true,group_operator:'sum'},foo2:{string:"Foo2",type:"integer",store:true,group_operator:'sum'}});var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'<field name="foo" type="measure"/>'+'<field name="foo2" type="measure" invisible="True"/>'+'</pivot>',});assert.containsOnce(pivot,'.o_pivot_measure_row');assert.containsN(pivot,'.o_cp_bottom_left .dropdown-item',2);await testUtils.dom.click(pivot.$('.o_pivot_header_cell_closed:first'));assert.containsNone(pivot,'.o_pivot_field_menu a[data-field="foo2"]');pivot.destroy();});QUnit.test('pivot view without "string" attribute',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.strictEqual(pivot.title,_t("Untitled"),"should have a valid title");pivot.destroy();});QUnit.test('group headers should have a tooltip',async function(assert){assert.expect(2);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="col"/>'+'<field name="date" type="row"/>'+'</pivot>',});assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:first').attr('data-original-title'),'Date');assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:first').attr('data-original-title'),'Product');pivot.destroy();});QUnit.test('pivot view add computed fields explicitly defined as measure',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="computed_field" type="measure"/>'+'</pivot>',});assert.ok(pivot.measures.computed_field,"measures contains the field 'computed_field'");pivot.destroy();});QUnit.test('clicking on a cell triggers a do_action',async function(assert){assert.expect(2);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</pivot>',intercepts:{do_action:function(ev){assert.deepEqual(ev.data.action,{context:{someKey:true,userContextKey:true},domain:[['product_id','=',37]],name:'Partners',res_model:'partner',target:'current',type:'ir.actions.act_window',view_mode:'list',views:[[false,'list'],[2,'form']],},"should trigger do_action with the correct args");},},session:{user_context:{userContextKey:true},},viewOptions:{action:{views:[{viewID:2,type:'form'},{viewID:5,type:'kanban'},{viewID:false,type:'list'},{viewID:false,type:'pivot'},],},context:{someKey:true,search_default_test:3},title:'Partners',}});assert.hasClass(pivot.$('table'),'o_enable_linking',"table should have classname 'o_enable_linking'");await testUtils.dom.click(pivot.$('.o_pivot_cell_value:contains(12)'));pivot.destroy();});QUnit.test('row and column are highlighted when hovering a cell',async function(assert){assert.expect(11);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'<field name="foo" type="col"/>'+'<field name="product_id" type="row"/>'+'</pivot>',});assert.hasClass(pivot.$('table'),'table-hover',"with className 'table-hover', rows are highlighted (bootstrap)");await testUtils.dom.triggerEvents(pivot.$('th.o_pivot_measure_row:nth(2)'),'mouseover');assert.containsN(pivot,'.o_cell_hover',3);for(var i=0;i<3;i++){assert.hasClass(pivot.$('tbody tr:nth('+i+') td:nth(2)'),'o_cell_hover');}
await testUtils.dom.triggerEvents(pivot.$('th.o_pivot_measure_row:nth(2)'),'mouseout');assert.containsNone(pivot,'.o_cell_hover');await testUtils.dom.triggerEvents(pivot.$('tbody tr:nth(1) td:nth(1)'),'mouseover');assert.containsN(pivot,'.o_cell_hover',3);for(i=0;i<3;i++){assert.hasClass(pivot.$('tbody tr:nth('+i+') td:nth(1)'),'o_cell_hover');}
await testUtils.dom.triggerEvents(pivot.$('tbody tr:nth(1) td:nth(1)'),'mouseout');assert.containsNone(pivot,'.o_cell_hover');pivot.destroy();});QUnit.test('pivot view with disable_linking="True"',async function(assert){assert.expect(2);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot disable_linking="True">'+'<field name="foo" type="measure"/>'+'</pivot>',intercepts:{do_action:function(){assert.ok(false,"should not trigger do_action");},},});assert.doesNotHaveClass(pivot.$('table'),'o_enable_linking',"table should not have classname 'o_enable_linking'");assert.containsOnce(pivot,'.o_pivot_cell_value',"should have one cell");await testUtils.dom.click(pivot.$('.o_pivot_cell_value'));pivot.destroy();});QUnit.test('clicking on the "Total" Cell with time range activated gives the right action domain',async function(assert){assert.expect(2);var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot/>',archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='this_month'/>
                    </search>
                `,},intercepts:{do_action:function(ev){assert.deepEqual(ev.data.action.domain,["&",["date",">=","2016-12-01"],["date","<=","2016-12-31"]],"should trigger do_action with the correct action domain");},},viewOptions:{context:{search_default_date_filter:true,},title:'Partners',},});assert.hasClass(pivot.$('table'),'o_enable_linking',"root node should have classname 'o_enable_linking'");await testUtilsDom.click(pivot.$('.o_pivot_cell_value'));unpatchDate();pivot.destroy();});QUnit.test('clicking on a fake cell value ("empty group") in comparison mode gives an action domain equivalent to [[0,"=",1]]',async function(assert){assert.expect(3);var unpatchDate=patchDate(2016,11,20,1,0,0);this.data.partner.records[0].date='2016-11-15';this.data.partner.records[1].date='2016-11-17';this.data.partner.records[2].date='2016-11-22';this.data.partner.records[3].date='2016-11-03';var first_do_action=true;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'</pivot>',intercepts:{do_action:function(ev){if(first_do_action){assert.deepEqual(ev.data.action.domain,["&",["date",">=","2016-12-01"],["date","<=","2016-12-31"]],"should trigger do_action with the correct action domain");}else{assert.deepEqual(ev.data.action.domain,[[0,"=",1]],"should trigger do_action with the correct action domain");}
first_do_action=false;},},archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='this_month'/>
                    </search>
                `,},viewOptions:{context:{search_default_date_filter:true,},title:'Partners',},});await cpHelpers.toggleComparisonMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date: Previous period');assert.hasClass(pivot.$('table'),'o_enable_linking',"root node should have classname 'o_enable_linking'");pivot.$('.o_pivot_cell_value').eq(1).click();pivot.$('.o_pivot_cell_value').eq(4).click();unpatchDate();pivot.destroy();});QUnit.test('pivot view grouped by date field',async function(assert){assert.expect(2);var data=this.data;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="month" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',mockRPC:function(route,params){var wrong_fields=_.filter(params.kwargs.fields,function(field){return!(field.split(':')[0]in data.partner.fields);});assert.ok(!wrong_fields.length,'fields given to read_group should exist on the model');return this._super.apply(this,arguments);},});pivot.destroy();});QUnit.test('without measures, pivot view uses __count by default',async function(assert){assert.expect(2);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot></pivot>',mockRPC:function(route,args){if(args.method==='read_group'){assert.deepEqual(args.kwargs.fields,['__count'],"should make a read_group with no valid fields");}
return this._super(route,args);}});var $countMeasure=pivot.$buttons.find('.dropdown-item[data-field=__count]:first');assert.hasClass($countMeasure,'selected',"The count measure should be activated");pivot.destroy();});QUnit.test('pivot view can be reloaded',async function(assert){assert.expect(4);var readGroupCount=0;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot></pivot>',mockRPC:function(route,args){if(args.method==='read_group'){readGroupCount++;}
return this._super(route,args);}});assert.strictEqual(pivot.$('td.o_pivot_cell_value:contains(4)').length,1,"should contain a pivot cell with the number of all records");assert.strictEqual(readGroupCount,1,"should have done 1 rpc");await testUtils.pivot.reload(pivot,{domain:[['foo','>',10]]});assert.strictEqual(pivot.$('td.o_pivot_cell_value:contains(2)').length,1,"should contain a pivot cell with the number of remaining records");assert.strictEqual(readGroupCount,2,"should have done 2 rpcs");pivot.destroy();});QUnit.test('pivot view grouped by many2one field',async function(assert){assert.expect(3);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.containsOnce(pivot,'.o_pivot_header_cell_opened',"should have one opened header");assert.strictEqual(pivot.$('.o_pivot_header_cell_closed:contains(xphone)').length,1,"should display one header with 'xphone'");assert.strictEqual(pivot.$('.o_pivot_header_cell_closed:contains(xpad)').length,1,"should display one header with 'xpad'");pivot.destroy();});QUnit.test('basic folding/unfolding',async function(assert){assert.expect(7);var rpcCount=0;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</pivot>',mockRPC:function(){rpcCount++;return this._super.apply(this,arguments);},});assert.containsN(pivot,'tbody tr',3,"should have 3 rows: 1 for the opened header, and 2 for data");await testUtils.dom.click(pivot.$('.o_pivot_header_cell_opened'));assert.containsOnce(pivot,'tbody tr',"should have 1 row");await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed'));assert.containsN(pivot,'.o_pivot_field_menu .dropdown-item[data-field="date"]',6,"should have the date field as proposition (Date, Day, Week, Month, Quarter and Year)");assert.containsOnce(pivot,'.o_pivot_field_menu .dropdown-item[data-field="product_id"]',"should have the product_id field as proposition");assert.containsNone(pivot,'.o_pivot_field_menu .dropdown-item[data-field="non_stored_m2o"]',"should not have the non_stored_m2o field as proposition");await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="date"]:first'));assert.containsN(pivot,'tbody tr',4,"should have 4 rows: one for header, 3 for data");assert.strictEqual(rpcCount,3,"should have done 3 rpcs (initial load) + open header with different groupbys");pivot.destroy();});QUnit.test('more folding/unfolding',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</pivot>',});await testUtils.dom.clickFirst(pivot.$('tbody .o_pivot_header_cell_closed'));pivot.$('.dropdown-menu.show .o_inline_dropdown .dropdown-menu').toggle();await testUtils.nextTick();await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="date"]:contains("Day")'));await testUtils.dom.clickLast(pivot.$('tbody th.o_pivot_header_cell_closed'));assert.containsN(pivot,'tbody tr',7,"should have 7 rows (1 for total, 1 for xphone, 1 for xpad, 4 for data)");pivot.destroy();});QUnit.test('fold and unfold header group',async function(assert){assert.expect(3);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.containsN(pivot,'thead tr',3);await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_opened'));assert.containsN(pivot,'thead tr',2);await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="product_id"]'));assert.containsN(pivot,'thead tr',3);pivot.destroy();});QUnit.test('unfold second header group',async function(assert){assert.expect(4);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.containsN(pivot,'thead tr',3);var values=['12','20','32'];assert.strictEqual(getCurrentValues(pivot),values.join(','));await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed:nth(1)'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="company_type"]'));assert.containsN(pivot,'thead tr',4);values=['12','3','17','32'];assert.strictEqual(getCurrentValues(pivot),values.join(','));pivot.destroy();});QUnit.test('can toggle extra measure',async function(assert){assert.expect(8);var rpcCount=0;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</pivot>',mockRPC:function(){rpcCount++;return this._super.apply(this,arguments);},});assert.containsN(pivot,'.o_pivot_cell_value',3,"should have 3 cells: 1 for the open header, and 2 for data");assert.doesNotHaveClass(pivot.$buttons.find('.dropdown-item[data-field=__count]:first'),'selected',"the __count measure should not be selected");rpcCount=0;await testUtils.pivot.toggleMeasuresDropdown(pivot);await testUtils.pivot.clickMeasure(pivot,'__count');assert.hasClass(pivot.$buttons.find('.dropdown-item[data-field=__count]:first'),'selected',"the __count measure should be selected");assert.containsN(pivot,'.o_pivot_cell_value',6,"should have 6 cells: 2 for the open header, and 4 for data");assert.strictEqual(rpcCount,2,"should have done 2 rpcs to reload data");await testUtils.pivot.clickMeasure(pivot,'__count');assert.doesNotHaveClass(pivot.$buttons.find('.dropdown-item[data-field=__count]:first'),'selected',"the __count measure should not be selected");assert.containsN(pivot,'.o_pivot_cell_value',3,"should have 3 cells: 1 for the open header, and 2 for data");assert.strictEqual(rpcCount,2,"should not have done any extra rpcs");pivot.destroy();});QUnit.test('no content helper when no active measure',async function(assert){assert.expect(4);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'</pivot>',});assert.containsNone(pivot,'.o_view_nocontent',"should not have a no_content_helper");assert.containsOnce(pivot,'table',"should have a table in DOM");await testUtils.pivot.toggleMeasuresDropdown(pivot);await testUtils.pivot.clickMeasure(pivot,'__count');assert.containsOnce(pivot,'.o_view_nocontent',"should have a no_content_helper");assert.containsNone(pivot,'table',"should not have a table in DOM");pivot.destroy();});QUnit.test('no content helper when no data',async function(assert){assert.expect(4);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners">'+'</pivot>',});assert.containsNone(pivot,'.o_view_nocontent',"should not have a no_content_helper");assert.containsOnce(pivot,'table',"should have a table in DOM");await testUtils.pivot.reload(pivot,{domain:[['foo','=',12345]]});assert.containsOnce(pivot,'.o_view_nocontent',"should have a no_content_helper");assert.containsNone(pivot,'table',"should not have a table in DOM");pivot.destroy();});QUnit.test('no content helper when no data, part 2',async function(assert){assert.expect(1);this.data.partner.records=[];var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners"></pivot>',});assert.containsOnce(pivot,'.o_view_nocontent',"should have a no_content_helper");pivot.destroy();});QUnit.test('no content helper when no data, part 3',async function(assert){assert.expect(4);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot string="Partners"></pivot>',viewOptions:{domain:[['foo','=',12345]]},});assert.containsOnce(pivot,'.o_view_nocontent',"should have a no_content_helper");await testUtils.pivot.reload(pivot,{domain:[['foo','=',12345]]});assert.containsOnce(pivot,'.o_view_nocontent',"should still have a no_content_helper");await testUtils.pivot.reload(pivot,{domain:[]});assert.containsNone(pivot,'.o_view_nocontent',"should not have a no_content_helper");await testUtils.dom.clickFirst(pivot.$('.o_pivot_header_cell_closed'));assert.containsOnce(pivot,'.o_pivot_field_menu',"the field selector menu exists");pivot.destroy();});QUnit.test('tries to restore previous state after domain change',async function(assert){assert.expect(5);var rpcCount=0;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'<field name="foo" type="measure"/>'+'</pivot>',mockRPC:function(){rpcCount++;return this._super.apply(this,arguments);},});assert.containsN(pivot,'.o_pivot_cell_value',3,"should have 3 cells: 1 for the open header, and 2 for data");assert.strictEqual(pivot.$('.o_pivot_measure_row:contains(Foo)').length,1,"should have 1 row for measure Foo");await testUtils.pivot.reload(pivot,{domain:[['foo','=',12345]]});rpcCount=0;await testUtils.pivot.reload(pivot,{domain:[]});assert.equal(rpcCount,2,"should have reloaded data");assert.containsN(pivot,'.o_pivot_cell_value',3,"should still have 3 cells: 1 for the open header, and 2 for data");assert.strictEqual(pivot.$('.o_pivot_measure_row:contains(Foo)').length,1,"should still have 1 row for measure Foo");pivot.destroy();});QUnit.test('can be grouped with the update function',async function(assert){assert.expect(4);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.containsOnce(pivot,'.o_pivot_cell_value',"should have only 1 cell");assert.containsOnce(pivot,'tbody tr',"should have 1 rows");await testUtils.pivot.reload(pivot,{groupBy:['product_id']});assert.containsN(pivot,'.o_pivot_cell_value',3,"should have 3 cells");assert.containsN(pivot,'tbody tr',3,"should have 3 rows");pivot.destroy();});QUnit.test('can sort data in a column by clicking on header',async function(assert){assert.expect(3);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'<field name="product_id" type="row"/>'+'</pivot>',});assert.strictEqual($('td.o_pivot_cell_value').text(),"321220","should have proper values in cells (total, result 1, result 2");await testUtils.dom.click(pivot.$('th.o_pivot_measure_row'));assert.strictEqual($('td.o_pivot_cell_value').text(),"321220","should have proper values in cells (total, result 1, result 2");await testUtils.dom.click(pivot.$('th.o_pivot_measure_row'));assert.strictEqual($('td.o_pivot_cell_value').text(),"322012","should have proper values in cells (total, result 2, result 1");pivot.destroy();});QUnit.test('can expand all rows',async function(assert){assert.expect(7);var nbReadGroups=0;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'<field name="product_id" type="row"/>'+'</pivot>',mockRPC:function(route,args){if(args.method==='read_group'){nbReadGroups++;}
return this._super.apply(this,arguments);},});assert.strictEqual(nbReadGroups,2,"should have done 2 read_group RPCS");assert.strictEqual(pivot.$('td.o_pivot_cell_value').text(),"321220","should have proper values in cells (total, result 1, result 2)");nbReadGroups=0;await testUtils.pivot.reload(pivot,{groupBy:['date:days','product_id']});assert.strictEqual(nbReadGroups,3,"should have done 3 read_group RPCS");assert.containsN(pivot,'tbody tr',8,"should have 7 rows (total + 3 for December and 2 for October and April)");await testUtils.dom.clickLast(pivot.$('.o_pivot_header_cell_opened'));await testUtils.dom.clickLast(pivot.$('.o_pivot_header_cell_opened'));assert.containsN(pivot,'tbody tr',6,"should have 6 rows now");nbReadGroups=0;await testUtils.dom.click(pivot.$buttons.find('.o_pivot_expand_button'));assert.strictEqual(nbReadGroups,3,"should have done 3 read_group RPCS");assert.containsN(pivot,'tbody tr',8,"should have 8 rows again");pivot.destroy();});QUnit.test('expand all with a delay',async function(assert){assert.expect(3);var def;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'<field name="product_id" type="row"/>'+'</pivot>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read_group'){return Promise.resolve(def).then(_.constant(result));}
return result;},});await testUtils.pivot.reload(pivot,{groupBy:['date:days','product_id']});assert.containsN(pivot,'tbody tr',8,"should have 7 rows (total + 3 for December and 2 for October and April)");await testUtils.dom.clickLast(pivot.$('.o_pivot_header_cell_opened'));await testUtils.dom.clickLast(pivot.$('.o_pivot_header_cell_opened'));assert.containsN(pivot,'tbody tr',6,"should have 6 rows now");def=testUtils.makeTestPromise();await testUtils.dom.click(pivot.$buttons.find('.o_pivot_expand_button'));await testUtils.nextTick();def.resolve();await testUtils.nextTick();assert.containsN(pivot,'tbody tr',8,"should have 8 rows again");pivot.destroy();});QUnit.test('can download a file',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="month" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',session:{get_file:function(args){assert.strictEqual(args.url,'/web/pivot/export_xlsx',"should call get_file with correct parameters");args.complete();},},});await testUtils.dom.click(pivot.$buttons.find('.o_pivot_download'));pivot.destroy();});QUnit.test('download a file with single measure, measure row displayed in table',async function(assert){assert.expect(1);const pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="month" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',session:{get_file:function(args){const data=JSON.parse(args.data.data);assert.strictEqual(data.measure_headers.length,4,"should have measure_headers in data");args.complete();},},});await testUtils.dom.click(pivot.$buttons.find('.o_pivot_download'));pivot.destroy();});QUnit.test('download button is disabled when there is no data',async function(assert){assert.expect(1);this.data.partner.records=[];var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="month" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.hasAttrValue(pivot.$buttons.find('.o_pivot_download'),'disabled','disabled',"download button should be disabled");pivot.destroy();});QUnit.test('getOwnedQueryParams correctly returns measures and groupbys',async function(assert){assert.expect(3);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="day" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:['date:day'],pivot_measures:['foo'],pivot_row_groupby:[],},},"context should be correct");await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed:nth(1)'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="customer"]:first'));assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:['date:day','customer'],pivot_measures:['foo'],pivot_row_groupby:[],},},"context should be correct");await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="product_id"]:first'));assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:['date:day','customer'],pivot_measures:['foo'],pivot_row_groupby:['product_id'],},},"context should be correct");pivot.destroy();});QUnit.test('correctly remove pivot_ keys from the context',async function(assert){assert.expect(5);this.data.partner.fields.amount={string:"Amount",type:"float",group_operator:'sum'};var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="day" type="col"/>'+'<field name="amount" type="measure"/>'+'</pivot>',viewOptions:{context:{pivot_measures:['foo'],pivot_column_groupby:['customer'],pivot_row_groupby:['product_id'],},},});var reloadParams={context:{},};await pivot.reload(reloadParams);assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:['customer'],pivot_measures:['foo'],pivot_row_groupby:['product_id'],},},"context should be correct");await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_opened'));assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:['customer'],pivot_measures:['foo'],pivot_row_groupby:[],},},"context should be correct");await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_opened'));assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:[],pivot_measures:['foo'],pivot_row_groupby:[],},},"context should be correct");await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="product_id"]:first'));assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:[],pivot_measures:['foo'],pivot_row_groupby:['product_id'],},},"context should be correct");await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="customer"]:first'));assert.deepEqual(pivot.getOwnedQueryParams(),{context:{pivot_column_groupby:['customer'],pivot_measures:['foo'],pivot_row_groupby:['product_id'],},},"context should be correct");pivot.destroy();});QUnit.test('Unload Filter, reset display, load another filter',async function(assert){assert.expect(18);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'</pivot>',viewOptions:{context:{pivot_measures:['foo'],pivot_column_groupby:['customer'],pivot_row_groupby:['product_id'],},},});assert.strictEqual(pivot.$('thead .o_pivot_header_cell_opened').length,1,'The column should be grouped');assert.strictEqual(pivot.$('thead tr:contains("First")').length,1,'There should be a column "First"');assert.strictEqual(pivot.$('thead tr:contains("Second")').length,1,'There should be a column "Second"');assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_opened').length,1,'The row should be grouped');assert.strictEqual(pivot.$('tbody tr:contains("xphone")').length,1,'There should be a row "xphone"');assert.strictEqual(pivot.$('tbody tr:contains("xpad")').length,1,'There should be a row "xpad"');var reloadParams={context:{},};await pivot.reload(reloadParams);await testUtils.dom.click(pivot.$('.o_pivot_header_cell_opened:first'));await testUtils.dom.click(pivot.$('.o_pivot_header_cell_opened'));assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed').length,1,'The column should not be grouped');assert.strictEqual(pivot.$('thead tr:contains("First")').length,0,'There should not be a column "First"');assert.strictEqual(pivot.$('thead tr:contains("Second")').length,0,'There should not be a column "Second"');assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed').length,1,'The row should not be grouped');assert.strictEqual(pivot.$('tbody tr:contains("xphone")').length,0,'There should not be a row "xphone"');assert.strictEqual(pivot.$('tbody tr:contains("xpad")').length,0,'There should not be a row "xpad"');reloadParams={context:{pivot_measures:['foo'],pivot_column_groupby:['customer'],pivot_row_groupby:['product_id'],},};await pivot.reload(reloadParams);assert.strictEqual(pivot.$('thead .o_pivot_header_cell_opened').length,1,'The column should be grouped');assert.strictEqual(pivot.$('thead tr:contains("First")').length,1,'There should be a column "First"');assert.strictEqual(pivot.$('thead tr:contains("Second")').length,1,'There should be a column "Second"');assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_opened').length,1,'The row should be grouped');assert.strictEqual(pivot.$('tbody tr:contains("xphone")').length,1,'There should be a row "xphone"');assert.strictEqual(pivot.$('tbody tr:contains("xpad")').length,1,'There should be a row "xpad"');pivot.destroy();});QUnit.test('Reload, group by columns, reload',async function(assert){assert.expect(2);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot/>',});await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field=customer]'));await pivot.update({domain:[['product_id','=',37]],groupBy:[],context:{}});var expectedContext={pivot_column_groupby:['customer'],pivot_measures:['__count'],pivot_row_groupby:[]};assert.deepEqual(pivot.getOwnedQueryParams(),{context:expectedContext},'Column groupby not lost after first reload');await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field=product_id]'));await pivot.update({domain:[['product_id','=',41]],groupBy:[],context:{}});expectedContext={pivot_column_groupby:['customer','product_id'],pivot_measures:['__count'],pivot_row_groupby:[]};assert.deepEqual(pivot.getOwnedQueryParams(),{context:expectedContext},'Column groupby not lost after second reload');pivot.destroy();});QUnit.test('folded groups remain folded at reload',async function(assert){assert.expect(5);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'<field name="company_type" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',});var values=["29","3","32","12","12","17","3","20",];assert.strictEqual(getCurrentValues(pivot),values.join(','));await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed:nth(1)'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="customer"]'));values=["29","1","2","32","12","12","17","1","2","20",];assert.strictEqual(getCurrentValues(pivot),values.join(','));await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed:nth(1)'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="other_product_id"]'));values=["29","1","2","32","12","12","17","1","2","20","17","1","2","20",];assert.strictEqual(getCurrentValues(pivot),values.join(','));await testUtils.pivot.reload(pivot,{context:{},domain:[],groupBy:[]});assert.strictEqual(getCurrentValues(pivot),values.join(','));await testUtils.dom.click(pivot.$('.o_pivot_expand_button'));values=["12","17","1","2","32","12","12","12","12","17","1","2","20","17","1","2","20",];assert.strictEqual(getCurrentValues(pivot),values.join(','));pivot.destroy();});QUnit.test('Empty results keep groupbys',async function(assert){assert.expect(2);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot/>',});await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field=customer]'));await pivot.update({domain:[['id','=',false]]});var expectedContext={pivot_column_groupby:['customer'],pivot_measures:['__count'],pivot_row_groupby:[]};assert.deepEqual(pivot.getOwnedQueryParams(),{context:expectedContext},'Column groupby not lost after empty results');await pivot.update({domain:[['product_id','=',37]]});assert.deepEqual(pivot.getOwnedQueryParams(),{context:expectedContext},'Column groupby not lost after reload after empty results');pivot.destroy();});QUnit.test('correctly uses pivot_ keys from the context',async function(assert){assert.expect(7);this.data.partner.fields.amount={string:"Amount",type:"float",group_operator:'sum'};var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="day" type="col"/>'+'<field name="amount" type="measure"/>'+'</pivot>',viewOptions:{context:{pivot_measures:['foo'],pivot_column_groupby:['customer'],pivot_row_groupby:['product_id'],},},});assert.containsOnce(pivot,'thead .o_pivot_header_cell_opened',"column: should have one opened header");assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(First)').length,1,"column: should display one closed header with 'First'");assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(Second)').length,1,"column: should display one closed header with 'Second'");assert.containsOnce(pivot,'tbody .o_pivot_header_cell_opened',"row: should have one opened header");assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xphone)').length,1,"row: should display one closed header with 'xphone'");assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xpad)').length,1,"row: should display one closed header with 'xpad'");assert.strictEqual(pivot.$('tbody tr:first td:nth(2)').text(),'32',"selected measure should be foo, with total 32");pivot.destroy();});QUnit.test('clear table cells data after closeGroup',async function(assert){assert.expect(2);const pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot/>',groupBy:['product_id'],});await testUtils.dom.click(pivot.el.querySelector('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.el.querySelectorAll('.o_pivot_field_menu .dropdown-item[data-field="date"]')[0]);this.data.partner.records.find(r=>r.product_id===37).date='2016-10-27';await testUtils.dom.click(pivot.el.querySelector('tbody .o_pivot_header_cell_opened'));await testUtils.dom.click(pivot.el.querySelector('tbody .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.el.querySelector('.o_pivot_field_menu .dropdown-item[data-field="product_id"]'));assert.strictEqual(pivot.el.querySelectorAll('.o_pivot_cell_value')[4].innerText,'');await testUtils.dom.click(pivot.el.querySelector('.o_cp_buttons .o_pivot_flip_button'));await testUtils.dom.click(pivot.el.querySelector('thead .o_pivot_header_cell_opened'));await testUtils.dom.click(pivot.el.querySelector('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.el.querySelector('.o_pivot_field_menu .dropdown-item[data-field="product_id"]'));assert.strictEqual(pivot.el.querySelectorAll('.o_pivot_cell_value')[3].innerText,'');pivot.destroy();});QUnit.test('correctly uses pivot_ keys from the context (at reload)',async function(assert){assert.expect(8);this.data.partner.fields.amount={string:"Amount",type:"float",group_operator:'sum'};var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" interval="day" type="col"/>'+'<field name="amount" type="measure"/>'+'</pivot>',});assert.strictEqual(pivot.$('tbody tr:first td.o_pivot_cell_value:last').text(),'0.00',"the active measure should be amount");var reloadParams={context:{pivot_measures:['foo'],pivot_column_groupby:['customer'],pivot_row_groupby:['product_id'],},};await testUtils.pivot.reload(pivot,reloadParams);assert.containsOnce(pivot,'thead .o_pivot_header_cell_opened',"column: should have one opened header");assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(First)').length,1,"column: should display one closed header with 'First'");assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(Second)').length,1,"column: should display one closed header with 'Second'");assert.containsOnce(pivot,'tbody .o_pivot_header_cell_opened',"row: should have one opened header");assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xphone)').length,1,"row: should display one closed header with 'xphone'");assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xpad)').length,1,"row: should display one closed header with 'xpad'");assert.strictEqual(pivot.$('tbody tr:first td:nth(2)').text(),'32',"selected measure should be foo, with total 32");pivot.destroy();});QUnit.test('correctly use group_by key from the context',async function(assert){assert.expect(7);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="customer" type="col" />'+'<field name="foo" type="measure" />'+'</pivot>',groupBy:['product_id'],});assert.containsOnce(pivot,'thead .o_pivot_header_cell_opened','column: should have one opened header');assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(First)').length,1,'column: should display one closed header with "First"');assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(Second)').length,1,'column: should display one closed header with "Second"');assert.containsOnce(pivot,'tbody .o_pivot_header_cell_opened','row: should have one opened header');assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xphone)').length,1,'row: should display one closed header with "xphone"');assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xpad)').length,1,'row: should display one closed header with "xpad"');assert.strictEqual(pivot.$('tbody tr:first td:nth(2)').text(),'32','selected measure should be foo, with total 32');pivot.destroy();});QUnit.test('correctly uses pivot_row_groupby key with default groupBy from the context',async function(assert){assert.expect(6);this.data.partner.fields.amount={string:"Amount",type:"float",group_operator:'sum'};var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="customer" type="col"/>'+'<field name="date" interval="day" type="row"/>'+'</pivot>',groupBy:['customer'],viewOptions:{context:{pivot_row_groupby:['product_id'],},},});assert.strictEqual(pivot.$('thead .o_pivot_header_cell_opened').length,1,"column: should have one opened header");assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(First)').length,1,"column: should display one closed header with 'First'");assert.strictEqual(pivot.$('thead .o_pivot_header_cell_closed:contains(Second)').length,1,"column: should display one closed header with 'Second'");assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_opened').length,1,"row: should have one opened header");assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xphone)').length,1,"row: should display one closed header with 'xphone'");assert.strictEqual(pivot.$('tbody .o_pivot_header_cell_closed:contains(xpad)').length,1,"row: should display one closed header with 'xpad'");pivot.destroy();});QUnit.test('pivot still handles __count__ measure',async function(assert){assert.expect(2);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot></pivot>',mockRPC:function(route,args){if(args.method==='read_group'){assert.deepEqual(args.kwargs.fields,['__count'],"should make a read_group with field __count");}
return this._super(route,args);},viewOptions:{context:{pivot_measures:['__count__'],},},});var $countMeasure=pivot.$buttons.find('.dropdown-item[data-field=__count]:first');assert.hasClass($countMeasure,'selected',"The count measure should be activated");pivot.destroy();});QUnit.test('not use a many2one as a measure by default',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id"/>'+'<field name="date" interval="month" type="col"/>'+'</pivot>',});assert.notOk(pivot.measures.product_id,"should not have product_id as measure");pivot.destroy();});QUnit.test('use a many2one as a measure with specified additional measure',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id"/>'+'<field name="date" interval="month" type="col"/>'+'</pivot>',viewOptions:{additionalMeasures:['product_id'],},});assert.ok(pivot.measures.product_id,"should have product_id as measure");pivot.destroy();});QUnit.test('pivot view with many2one field as a measure',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="measure"/>'+'<field name="date" interval="month" type="col"/>'+'</pivot>',});assert.strictEqual(pivot.$('table tbody tr').text().trim(),"Total2112","should display product_id count as measure");pivot.destroy();});QUnit.test('m2o as measure, drilling down into data',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="measure"/>'+'</pivot>',});await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed'));pivot.$('.dropdown-menu.show .o_inline_dropdown .dropdown-menu').toggle();await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="date"]:contains("Month")'));assert.strictEqual(pivot.$('.o_pivot_cell_value').text(),'2211','should have loaded the proper data');pivot.destroy();});QUnit.test('pivot view with same many2one field as a measure and grouped by',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'</pivot>',viewOptions:{additionalMeasures:['product_id'],},});await testUtils.pivot.toggleMeasuresDropdown(pivot);await testUtils.pivot.clickMeasure(pivot,'product_id');assert.strictEqual(pivot.$('.o_pivot_cell_value').text(),'421131','should have loaded the proper data');pivot.destroy();});QUnit.test('pivot view with same many2one field as a measure and grouped by (and drill down)',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="measure"/>'+'</pivot>',});await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field="product_id"]:first'));assert.strictEqual(pivot.$('.o_pivot_cell_value').text(),'211','should have loaded the proper data');pivot.destroy();});QUnit.test('Row and column groupbys plus a domain',async function(assert){assert.expect(3);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'</pivot>',});await testUtils.dom.click(pivot.$('thead .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field=customer]:first'));await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field=product_id]:first'));await testUtils.pivot.reload(pivot,{domain:[['product_id','=',41]]});var expectedContext={context:{pivot_column_groupby:['customer'],pivot_measures:['foo'],pivot_row_groupby:['product_id'],},};assert.deepEqual(pivot.getOwnedQueryParams(),expectedContext,'The pivot view should have the right context');var $xpadHeader=pivot.$('tbody .o_pivot_header_cell_closed[data-original-title=Product]');assert.equal($xpadHeader.length,1,'There should be only one product line because of the domain');assert.equal($xpadHeader.text(),'xpad','The product should be the right one');pivot.destroy();});QUnit.test('parallel data loading should discard all but the last one',async function(assert){assert.expect(2);var def;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'</pivot>',mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read_group'){return Promise.resolve(def).then(_.constant(result));}
return result;},});def=testUtils.makeTestPromise();testUtils.pivot.reload(pivot,{groupBy:['product_id']});testUtils.pivot.reload(pivot,{groupBy:['product_id','customer']});await def.resolve();await testUtils.nextTick();assert.containsN(pivot,'.o_pivot_cell_value',6,"should have 6 cells");assert.containsN(pivot,'tbody tr',6,"should have 6 rows");pivot.destroy();});QUnit.test('pivot measures should be alphabetically sorted',async function(assert){assert.expect(2);var data=this.data;data.partner.fields.bouh={string:"bouh",type:"integer",group_operator:'sum'};data.partner.fields.modd={string:"modd",type:"integer",group_operator:'sum'};data.partner.fields.zip={string:"Zip",type:"integer",group_operator:'sum'};var pivot=await createView({View:PivotView,model:"partner",data:data,arch:'<pivot>'+'<field name="zip" type="measure"/>'+'<field name="foo" type="measure"/>'+'<field name="bouh" type="measure"/>'+'<field name="modd" type="measure"/>'+'</pivot>',});assert.strictEqual(pivot.$buttons.find('.o_pivot_measures_list .dropdown-item:first').data('field'),'bouh',"Bouh should be the first measure");assert.strictEqual(pivot.$buttons.find('.o_pivot_measures_list .dropdown-item:last').data('field'),'__count',"Count should be the last measure");pivot.destroy();});QUnit.test('pivot view should use default order for auto sorting',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot default_order="foo asc">'+'<field name="foo" type="measure"/>'+'</pivot>',});assert.hasClass(pivot.$('thead tr:last th:last'),'o_pivot_sort_order_asc',"Last thead should be sorted in ascending order");pivot.destroy();});QUnit.test('pivot view can be flipped',async function(assert){assert.expect(5);var rpcCount=0;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="product_id" type="row"/>'+'</pivot>',mockRPC:function(){rpcCount++;return this._super.apply(this,arguments);},});assert.containsN(pivot,'tbody tr',3,"should have 3 rows: 1 for the open header, and 2 for data");var values=["4","1","3"];assert.strictEqual(getCurrentValues(pivot),values.join());rpcCount=0;await testUtils.dom.click(pivot.$buttons.find('.o_pivot_flip_button'));assert.strictEqual(rpcCount,0,"should not have done any rpc");assert.containsOnce(pivot,'tbody tr',"should have 1 rows: 1 for the main header");values=["1","3","4"];assert.strictEqual(getCurrentValues(pivot),values.join());pivot.destroy();});QUnit.test('rendering of pivot view with comparison',async function(assert){assert.expect(8);this.data.partner.records[0].date='2016-12-15';this.data.partner.records[1].date='2016-12-17';this.data.partner.records[2].date='2016-11-22';this.data.partner.records[3].date='2016-11-03';var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="date" interval="month" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='last_year'/>
                    </search>
                `,},viewOptions:{additionalMeasures:['product_id'],context:{search_default_date_filter:1},},mockRPC:function(){return this._super.apply(this,arguments);},env:{dataManager:{create_filter:async function(filter){assert.deepEqual(filter.context,{pivot_measures:['__count'],pivot_column_groupby:[],pivot_row_groupby:['product_id'],group_by:[],comparison:{comparisonId:"previous_period",comparisonRange:"[\"&\", [\"date\", \">=\", \"2016-11-01\"], [\"date\", \"<=\", \"2016-11-30\"]]",comparisonRangeDescription:"November 2016",fieldDescription:"Date",fieldName:"date",range:"[\"&\", [\"date\", \">=\", \"2016-12-01\"], [\"date\", \"<=\", \"2016-12-31\"]]",rangeDescription:"December 2016"},});}}},});await cpHelpers.toggleComparisonMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date: Previous period');assert.strictEqual(pivot.$('.o_pivot p.o_view_nocontent_empty_folder').length,1);await cpHelpers.toggleFilterMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date');await cpHelpers.toggleMenuItemOption(pivot,'Date','December');await cpHelpers.toggleMenuItemOption(pivot,'Date','2016');await cpHelpers.toggleMenuItemOption(pivot,'Date','2015');assert.containsN(pivot,'.o_pivot thead tr:last th',9,"last header row should contains 9 cells (3*[December 2016, November 2016, Variation]");var values=["19","0","-100%","0","13","100%","19","13","-31.58%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$('.o_pivot .o_pivot_header_cell_closed').eq(2));await testUtils.dom.click(pivot.$('.o_pivot .o_pivot_field_menu a[data-field="product_id"]'));values=["19","0","-100%","0","13","100%","19","13","-31.58%","19","0","-100%","0","1","100%","19","1","-94.74%","0","12","100%","0","12","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.pivot.toggleMeasuresDropdown(pivot);await testUtils.dom.click(pivot.$('.o_control_panel div.o_pivot_measures_list a[data-field="foo"]'));await testUtils.dom.click(pivot.$('.o_control_panel div.o_pivot_measures_list a[data-field="product_id"]'));values=["1","0","-100%","0","2","100%","1","2","100%","1","0","-100%","0","1","100%","1","1","0%","0","1","100%","0","1","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$('.o_control_panel div.o_pivot_measures_list a[data-field="__count"]'));await testUtils.dom.click(pivot.$('.o_control_panel div.o_pivot_measures_list a[data-field="product_id"]'));values=["2","0","-100%","0","2","100%","2","2","0%","2","0","-100%","0","1","100%","2","1","-50%","0","1","100%","0","1","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.clickFirst(pivot.$('.o_pivot .o_pivot_header_cell_opened'));values=["2","2","0%","2","1","-50%","0","1","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await cpHelpers.toggleFavoriteMenu(pivot);await cpHelpers.toggleSaveFavorite(pivot);await cpHelpers.editFavoriteName(pivot,'Fav');await cpHelpers.saveFavorite(pivot);unpatchDate();pivot.destroy();});QUnit.test('export data in excel with comparison',async function(assert){assert.expect(11);this.data.partner.records[0].date='2016-12-15';this.data.partner.records[1].date='2016-12-17';this.data.partner.records[2].date='2016-11-22';this.data.partner.records[3].date='2016-11-03';var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="date" interval="month" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='antepenultimate_month'/>
                    </search>
                `,},viewOptions:{context:{search_default_date_filter:1},},session:{get_file:function(args){var data=JSON.parse(args.data.data);_.each(data.col_group_headers,function(l){var titles=l.map(function(o){return o.title;});assert.step(JSON.stringify(titles));});var measures=data.measure_headers.map(function(o){return o.title;});assert.step(JSON.stringify(measures));var origins=data.origin_headers.map(function(o){return o.title;});assert.step(JSON.stringify(origins));assert.step(String(data.measure_count));assert.step(String(data.origin_count));var valuesLength=data.rows.map(function(o){return o.values.length;});assert.step(JSON.stringify(valuesLength));assert.strictEqual(args.url,'/web/pivot/export_xlsx',"should call get_file with correct parameters");args.complete();},},});await cpHelpers.toggleComparisonMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date: Previous period');assert.strictEqual(pivot.$('.o_pivot p.o_view_nocontent_empty_folder').length,1,"there should be no data");assert.ok(pivot.$('.o_control_panel button.o_pivot_download').prop('disabled'));await cpHelpers.toggleFilterMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date');await cpHelpers.toggleMenuItemOption(pivot,'Date','December');await cpHelpers.toggleMenuItemOption(pivot,'Date','October');await testUtils.dom.click(pivot.$('.o_control_panel button.o_pivot_download'));assert.verifySteps(['["Total",""]','["November 2016","December 2016"]','["Foo","Foo","Foo"]','["November 2016","December 2016","Variation","November 2016","December 2016"'+',"Variation","November 2016","December 2016","Variation"]','1','2','[9]',]);unpatchDate();pivot.destroy();});QUnit.test('rendering of pivot view with comparison and count measure',async function(assert){assert.expect(2);var mockMock=false;var nbReadGroup=0;this.data.partner.records[0].date='2016-12-15';this.data.partner.records[1].date='2016-12-17';this.data.partner.records[2].date='2016-12-22';this.data.partner.records[3].date='2016-12-03';var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot><field name="customer" type="row"/></pivot>',archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='this_month'/>
                    </search>
                `,},viewOptions:{context:{search_default_date_filter:1},},mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read_group'&&mockMock){nbReadGroup++;if(nbReadGroup===4){return Promise.resolve([{}]);}}
return result;},});mockMock=true;await cpHelpers.toggleComparisonMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date: Previous period');var values=["0","4","100%","0","2","100%","0","2","100%"];assert.strictEqual(getCurrentValues(pivot),values.join(','));assert.strictEqual(pivot.$('.o_pivot_header_cell_closed').length,3,"there should be exactly three closed header ('Total','First', 'Second')");unpatchDate();pivot.destroy();});QUnit.test('can sort a pivot view with comparison by clicking on header',async function(assert){assert.expect(6);this.data.partner.records[0].date='2016-12-15';this.data.partner.records[1].date='2016-12-17';this.data.partner.records[2].date='2016-11-22';this.data.partner.records[3].date='2016-11-03';var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="date" interval="day" type="row"/>'+'<field name="company_type" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='this_month'/>
                    </search>
                `,},viewOptions:{additionalMeasures:['product_id'],context:{search_default_date_filter:1},},});await cpHelpers.toggleComparisonMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date: Previous period');var values=["17","12","-29.41%","2","1","-50%","19","13","-31.58%","17","0","-100%","17","0","-100%","2","0","-100%","2","0","-100%","0","12","100%","0","12","100%","0","1","100%","0","1","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$('.o_pivot_measure_row').eq(0));values=["17","12","-29.41%","2","1","-50%","19","13","-31.58%","2","0","-100%","2","0","-100%","0","12","100%","0","12","100%","0","1","100%","0","1","100%","17","0","-100%","17","0","-100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$('.o_pivot_measure_row').eq(0));values=["17","12","-29.41%","2","1","-50%","19","13","-31.58%","17","0","-100%","17","0","-100%","2","0","-100%","2","0","-100%","0","12","100%","0","12","100%","0","1","100%","0","1","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$('.o_pivot_origin_row').eq(3));values=["17","12","-29.41%","2","1","-50%","19","13","-31.58%","17","0","-100%","17","0","-100%","0","12","100%","0","12","100%","0","1","100%","0","1","100%","2","0","-100%","2","0","-100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$('.o_pivot_origin_row').eq(4));values=["17","12","-29.41%","2","1","-50%","19","13","-31.58%","17","0","-100%","17","0","-100%","2","0","-100%","2","0","-100%","0","12","100%","0","12","100%","0","1","100%","0","1","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$('.o_pivot_origin_row').eq(8));values=["17","12","-29.41%","2","1","-50%","19","13","-31.58%","17","0","-100%","17","0","-100%","2","0","-100%","2","0","-100%","0","12","100%","0","12","100%","0","1","100%","0","1","100%"];assert.strictEqual(getCurrentValues(pivot),values.join());unpatchDate();pivot.destroy();});QUnit.test('Click on the measure list but not on a menu item',async function(assert){assert.expect(2);const pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:`<pivot/>`,});await testUtils.dom.click(pivot.el.querySelector('.o_cp_buttons button'));await testUtils.dom.click(pivot.el.querySelector('.o_pivot_measures_list .dropdown-divider'));assert.isVisible(pivot.el.querySelector('.o_pivot_measures_list'));await testUtils.dom.click(pivot.el.querySelector('.o_pivot_measures_list'));assert.isVisible(pivot.el.querySelector('.o_pivot_measures_list'));pivot.destroy();});QUnit.test('Navigation list view for a group and back with breadcrumbs',async function(assert){assert.expect(16);var readGroupCount=0;var actionManager=await createActionManager({data:this.data,archs:{'partner,false,pivot':'<pivot>'+'<field name="customer" type="row"/>'+'</pivot>','partner,false,search':'<search><filter name="bayou" string="Bayou" domain="[(\'foo\',\'=\', 12)]"/></search>','partner,false,list':'<tree><field name="foo"/></tree>','partner,false,form':'<form><field name="foo"/></form>',},intercepts:{do_action:function(event){var action=event.data.action;actionManager.doAction(action);}},mockRPC:function(route,args){if(args.method==='read_group'){assert.step('read_group');const domain=args.kwargs.domain;if([0,1].indexOf(readGroupCount)!==-1){assert.deepEqual(domain,[],'domain empty');}else if([2,3,4,5].indexOf(readGroupCount)!==-1){assert.deepEqual(domain,[['foo','=',12]],'domain conserved when back with breadcrumbs');}
readGroupCount++;}
if(route==='/web/dataset/search_read'){assert.step('search_read');const domain=args.domain;assert.deepEqual(domain,['&',['customer','=',1],['foo','=',12]],'list domain is correct');}
return this._super.apply(this,arguments);},});await actionManager.doAction({res_model:'partner',type:'ir.actions.act_window',views:[[false,'pivot']],});await cpHelpers.toggleFilterMenu(actionManager);await cpHelpers.toggleMenuItem(actionManager,0);await testUtils.nextTick();await testUtilsDom.click(actionManager.$('.o_pivot_cell_value:nth(1)'));await testUtils.nextTick();assert.containsOnce(actionManager,'.o_list_view');await testUtilsDom.click(actionManager.$('.o_control_panel ol.breadcrumb li.breadcrumb-item').eq(0));assert.verifySteps(['read_group','read_group','read_group','read_group','search_read','read_group','read_group']);actionManager.destroy();});QUnit.test('Cell values are kept when flippin a pivot view in comparison mode',async function(assert){assert.expect(2);this.data.partner.records[0].date='2016-12-15';this.data.partner.records[1].date='2016-12-17';this.data.partner.records[2].date='2016-11-22';this.data.partner.records[3].date='2016-11-03';var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="date" interval="day" type="row"/>'+'<field name="company_type" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='this_month'/>
                    </search>
                `,},viewOptions:{additionalMeasures:['product_id'],context:{search_default_date_filter:1},},});await cpHelpers.toggleComparisonMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date: Previous period');var values=["17","12","-29.41%","2","1","-50%","19","13","-31.58%","17","0","-100%","17","0","-100%","2","0","-100%","2","0","-100%","0","12","100%","0","12","100%","0","1","100%","0","1","100%",];assert.strictEqual(getCurrentValues(pivot),values.join());await testUtils.dom.click(pivot.$buttons.find('.o_pivot_flip_button'));values=["17","0","-100%","2","0","-100%","0","12","100%","0","1","100%","19","13","-31.58%","17","0","-100%","0","12","100%","17","12","-29.41%","2","0","-100%","0","1","100%","2","1","-50%"];assert.strictEqual(getCurrentValues(pivot),values.join());unpatchDate();pivot.destroy();});QUnit.test('Flip then compare, table col groupbys are kept',async function(assert){assert.expect(6);this.data.partner.records[0].date='2016-12-15';this.data.partner.records[1].date='2016-12-17';this.data.partner.records[2].date='2016-11-22';this.data.partner.records[3].date='2016-11-03';var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="date" interval="day" type="row"/>'+'<field name="company_type" type="col"/>'+'<field name="foo" type="measure"/>'+'</pivot>',archs:{'partner,false,search':`
                    <search>
                        <filter name="date_filter" date="date" domain="[]" default_period='this_month'/>
                    </search>
                `,},viewOptions:{additionalMeasures:['product_id'],},});assert.strictEqual(pivot.$('th').slice(0,5).text(),['','Total','','Company','individual',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(8).text(),['Total','2016-12-15','2016-12-17','2016-11-22','2016-11-03'].join(''),"The row headers should be as expected");await testUtils.dom.click(pivot.$buttons.find('.o_pivot_flip_button'));assert.strictEqual(pivot.$('th').slice(0,7).text(),['','Total','','2016-12-15','2016-12-17','2016-11-22','2016-11-03',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(12).text(),['Total','Company','individual'].join(''),"The row headers should be as expected");await cpHelpers.toggleFilterMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date');await cpHelpers.toggleMenuItemOption(pivot,'Date','December');await cpHelpers.toggleComparisonMenu(pivot);await cpHelpers.toggleMenuItem(pivot,'Date: Previous period');assert.strictEqual(pivot.$('th').slice(0,7).text(),['','Total','','2016-11-22','2016-11-03','2016-12-15','2016-12-17',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(27).text(),['Total','Company','individual'].join(''),"The row headers should be as expected");unpatchDate();pivot.destroy();});QUnit.test('correctly compute group domain when a date field has false value',async function(assert){assert.expect(1);this.data.partner.records.forEach(r=>r.date=false);var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot o_enable_linking="1">'+'<field name="date" interval="day" type="row"/>'+'</pivot>',intercepts:{do_action:function(ev){assert.deepEqual(ev.data.action.domain,[['date','=',false]]);},},});await testUtils.dom.click($('div .o_value')[1]);unpatchDate();pivot.destroy();});QUnit.test('Does not identify "false" with false as keys when creating group trees',async function(assert){assert.expect(2);this.data.partner.fields.favorite_animal={string:"Favorite animal",type:"char",store:true};this.data.partner.records[0].favorite_animal='Dog';this.data.partner.records[1].favorite_animal='false';this.data.partner.records[2].favorite_animal='Undefined';var unpatchDate=patchDate(2016,11,20,1,0,0);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot o_enable_linking="1">'+'<field name="favorite_animal" type="row"/>'+'</pivot>',});assert.strictEqual(pivot.$('th').slice(0,2).text(),['','Total','',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(3).text(),['Total','Dog','false','Undefined','Undefined'].join(''),"The row headers should be as expected");unpatchDate();pivot.destroy();});QUnit.test('group bys added via control panel and expand Header do not stack',async function(assert){assert.expect(8);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'</pivot>',viewOptions:{additionalMeasures:['product_id'],},});assert.strictEqual(pivot.$('th').slice(0,2).text(),['','Total',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(3).text(),['Total',].join(''),"The row headers should be as expected");await cpHelpers.toggleGroupByMenu(pivot);await cpHelpers.toggleAddCustomGroup(pivot);await cpHelpers.applyGroup(pivot);assert.strictEqual(pivot.$('th').slice(0,2).text(),['','Total',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(3).text(),['Total','Company','individual'].join(''),"The row headers should be as expected");await testUtils.dom.click(pivot.$('tbody .o_pivot_header_cell_closed').eq(0));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field=product_id]:first'));assert.strictEqual(pivot.$('th').slice(0,2).text(),['','Total',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(3).text(),['Total','Company','xphone','xpad','individual'].join(''),"The row headers should be as expected");await cpHelpers.toggleGroupByMenu(pivot);await cpHelpers.toggleAddCustomGroup(pivot);await cpHelpers.selectGroup(pivot,'bar');await cpHelpers.applyGroup(pivot);assert.strictEqual(pivot.$('th').slice(0,2).text(),['','Total',].join(''),"The col headers should be as expected");assert.strictEqual(pivot.$('th').slice(3).text(),['Total','Company','true','individual','true','Undefined'].join(''),"The row headers should be as expected");pivot.destroy();});QUnit.test('display only one dropdown menu',async function(assert){assert.expect(1);var pivot=await createView({View:PivotView,model:'partner',data:this.data,arch:'<pivot>'+'<field name="foo" type="measure"/>'+'</pivot>',viewOptions:{additionalMeasures:['product_id'],},});await testUtils.dom.clickFirst(pivot.$('th.o_pivot_header_cell_closed'));await testUtils.dom.click(pivot.$('.o_pivot_field_menu .dropdown-item[data-field=product_id]:first'));await testUtils.dom.click(pivot.$('th.o_pivot_header_cell_closed')[0]);await testUtils.dom.click(pivot.$('th.o_pivot_header_cell_closed')[1]);assert.containsOnce(pivot,'.o_pivot_field_menu','Only one dropdown should be displayed at a time');pivot.destroy();});QUnit.test('Server order is kept by default',async function(assert){assert.expect(1);let isSecondReadGroup=false;var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="customer" type="row"/>'+'<field name="foo" type="measure"/>'+'</pivot>',mockRPC:function(route,args){if(args.method==='read_group'&&isSecondReadGroup){return Promise.resolve([{customer:[2,'Second'],foo:18,__count:2,__domain:[["customer","=",2]],},{customer:[1,'First'],foo:14,__count:2,__domain:[["customer","=",1]],}]);}
var result=this._super.apply(this,arguments);isSecondReadGroup=true;return result;},});const values=["32","18","14",];assert.strictEqual(getCurrentValues(pivot),values.join());pivot.destroy();});QUnit.test('pivot rendering with boolean field',async function(assert){assert.expect(4);this.data.partner.fields.bar={string:"bar",type:"boolean",store:true,searchable:true,group_operator:'bool_or'};this.data.partner.records=[{id:1,bar:true,date:'2019-12-14'},{id:2,bar:false,date:'2019-05-14'}];var pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" type="row" interval="day"/>'+'<field name="bar" type="col"/>'+'<field name="bar" string="SLA status Failed" type="measure"/>'+'</pivot>',});assert.strictEqual(pivot.$('tbody tr:contains("2019-12-14")').length,1,'There should be a first column');assert.ok(pivot.$('tbody tr:contains("2019-12-14") [type="checkbox"]').is(':checked'),'first column contains checkbox and value should be ticked');assert.strictEqual(pivot.$('tbody tr:contains("2019-05-14")').length,1,'There should be a second column');assert.notOk(pivot.$('tbody tr:contains("2019-05-14") [type="checkbox"]').is(':checked'),"second column should have checkbox that is not checked by default");pivot.destroy();});QUnit.test('Allow to add behaviour to buttons on pivot',async function(assert){assert.expect(2);let _testButtons=(ev)=>{if($(ev.target).hasClass("o_pivot_flip_button")){assert.step("o_pivot_flip_button")}}
PivotController.include({_addIncludedButtons:async function(ev){await this._super(...arguments);_testButtons(ev);},});const pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:'<pivot>'+'<field name="date" type="row" interval="day"/>'+'<field name="bar" type="col"/>'+'</pivot>',});await testUtils.dom.click(pivot.$buttons.find('.o_pivot_flip_button'));assert.verifySteps(["o_pivot_flip_button"]);_testButtons=()=>true;pivot.destroy();});QUnit.test('empty pivot view with action helper',async function(assert){assert.expect(4);const pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:`
                <pivot>
                    <field name="product_id" type="measure"/>
                    <field name="date" interval="month" type="col"/>
                </pivot>`,domain:[['id','<',0]],viewOptions:{action:{help:'<p class="abc">click to add a foo</p>'}},});assert.containsOnce(pivot,'.o_view_nocontent .abc');assert.containsNone(pivot,'table');await pivot.reload({domain:[]});assert.containsNone(pivot,'.o_view_nocontent .abc');assert.containsOnce(pivot,'table');pivot.destroy();});QUnit.test('empty pivot view with sample data',async function(assert){assert.expect(7);const pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:`
                <pivot sample="1">
                    <field name="product_id" type="measure"/>
                    <field name="date" interval="month" type="col"/>
                </pivot>`,domain:[['id','<',0]],viewOptions:{action:{help:'<p class="abc">click to add a foo</p>'}},});assert.hasClass(pivot.el,'o_view_sample_data');assert.containsOnce(pivot,'.o_view_nocontent .abc');assert.containsOnce(pivot,'table.o_sample_data_disabled');await pivot.reload({domain:[]});assert.doesNotHaveClass(pivot.el,'o_view_sample_data');assert.containsNone(pivot,'.o_view_nocontent .abc');assert.containsOnce(pivot,'table');assert.doesNotHaveClass(pivot.$('table'),'o_sample_data_disabled');pivot.destroy();});QUnit.test('non empty pivot view with sample data',async function(assert){assert.expect(7);const pivot=await createView({View:PivotView,model:"partner",data:this.data,arch:`
                <pivot sample="1">
                    <field name="product_id" type="measure"/>
                    <field name="date" interval="month" type="col"/>
                </pivot>`,viewOptions:{action:{help:'<p class="abc">click to add a foo</p>'}},});assert.doesNotHaveClass(pivot.el,'o_view_sample_data');assert.containsNone(pivot,'.o_view_nocontent .abc');assert.containsOnce(pivot,'table');assert.doesNotHaveClass(pivot.$('table'),'o_sample_data_disabled');await pivot.reload({domain:[['id','<',0]]});assert.doesNotHaveClass(pivot.el,'o_view_sample_data');assert.containsOnce(pivot,'.o_view_nocontent .abc');assert.containsNone(pivot,'table');pivot.destroy();});});});;

/* /web/static/tests/views/kanban_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.kanban_tests',function(require){"use strict";var AbstractField=require('web.AbstractField');const Domain=require('web.Domain');var fieldRegistry=require('web.field_registry');const FormRenderer=require("web.FormRenderer");var KanbanColumnProgressBar=require('web.KanbanColumnProgressBar');var kanbanExamplesRegistry=require('web.kanban_examples_registry');var KanbanRenderer=require('web.KanbanRenderer');var KanbanView=require('web.KanbanView');var mixins=require('web.mixins');var testUtils=require('web.test_utils');var Widget=require('web.Widget');var widgetRegistry=require('web.widget_registry');var makeTestPromise=testUtils.makeTestPromise;var nextTick=testUtils.nextTick;const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;QUnit.module('Views',{before:function(){this._initialKanbanProgressBarAnimate=KanbanColumnProgressBar.prototype.ANIMATE;KanbanColumnProgressBar.prototype.ANIMATE=false;},after:function(){KanbanColumnProgressBar.prototype.ANIMATE=this._initialKanbanProgressBarAnimate;},beforeEach:function(){this.data={partner:{fields:{foo:{string:"Foo",type:"char"},bar:{string:"Bar",type:"boolean"},int_field:{string:"int_field",type:"integer",sortable:true},qux:{string:"my float",type:"float"},product_id:{string:"something_id",type:"many2one",relation:"product"},category_ids:{string:"categories",type:"many2many",relation:'category'},state:{string:"State",type:"selection",selection:[["abc","ABC"],["def","DEF"],["ghi","GHI"]]},date:{string:"Date Field",type:'date'},datetime:{string:"Datetime Field",type:'datetime'},image:{string:"Image",type:"binary"},displayed_image_id:{string:"cover",type:"many2one",relation:"ir.attachment"},currency_id:{string:"Currency",type:"many2one",relation:"currency",default:1},salary:{string:"Monetary field",type:"monetary"},},records:[{id:1,bar:true,foo:"yop",int_field:10,qux:0.4,product_id:3,state:"abc",category_ids:[],'image':'R0lGODlhAQABAAD/ACwAAAAAAQABAAACAA==',salary:1750,currency_id:1},{id:2,bar:true,foo:"blip",int_field:9,qux:13,product_id:5,state:"def",category_ids:[6],salary:1500,currency_id:1},{id:3,bar:true,foo:"gnap",int_field:17,qux:-3,product_id:3,state:"ghi",category_ids:[7],salary:2000,currency_id:2},{id:4,bar:false,foo:"blip",int_field:-4,qux:9,product_id:5,state:"ghi",category_ids:[],salary:2222,currency_id:1},]},product:{fields:{id:{string:"ID",type:"integer"},name:{string:"Display Name",type:"char"},},records:[{id:3,name:"hello"},{id:5,name:"xmo"},]},category:{fields:{name:{string:"Category Name",type:"char"},color:{string:"Color index",type:"integer"},},records:[{id:6,name:"gold",color:2},{id:7,name:"silver",color:5},]},'ir.attachment':{fields:{mimetype:{type:"char"},name:{type:"char"},res_model:{type:"char"},res_id:{type:"integer"},},records:[{id:1,name:"1.png",mimetype:'image/png',res_model:'partner',res_id:1},{id:2,name:"2.png",mimetype:'image/png',res_model:'partner',res_id:2},]},'currency':{fields:{symbol:{string:"Symbol",type:"char"},position:{string:"Position",type:"selection",selection:[['after','A'],['before','B']],},},records:[{id:1,display_name:"USD",symbol:'$',position:'before'},{id:2,display_name:"EUR",symbol:'€',position:'after'},],},};},},function(){QUnit.module('KanbanView');QUnit.test('basic ungrouped rendering',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div>'+'<t t-esc="record.foo.value"/>'+'<field name="foo"/>'+'</div>'+'</t></templates></kanban>',mockRPC:function(route,args){assert.ok(args.context.bin_size,"should not request direct binary payload");return this._super(route,args);},});assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_ungrouped');assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_test');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);assert.containsN(kanban,'.o_kanban_ghost',6);assert.containsOnce(kanban,'.o_kanban_record:contains(gnap)');kanban.destroy();});QUnit.test('basic grouped rendering',async function(assert){assert.expect(13);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],mockRPC:function(route,args){if(args.method==='web_read_group'){assert.ok(args.kwargs.lazy,"should use lazy read_group");}
return this._super(route,args);},});assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_grouped');assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_test');assert.containsN(kanban,'.o_kanban_group',2);assert.containsOnce(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',3);assert.containsOnce(kanban,'.o_kanban_header:first .o_kanban_config .o_kanban_toggle_fold');assert.containsNone(kanban,'.o_kanban_header:first .o_kanban_config .o_column_edit');assert.containsNone(kanban,'.o_kanban_header:first .o_kanban_config .o_column_delete');assert.containsNone(kanban,'.o_kanban_header:first .o_kanban_config .o_column_archive_records');assert.containsNone(kanban,'.o_kanban_header:first .o_kanban_config .o_column_unarchive_records');await kanban.reload(kanban);assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',3);kanban.destroy();});QUnit.test('basic grouped rendering with active field (archivable by default)',async function(assert){assert.expect(9);this.data.partner.fields.active={string:'Active',type:'char',default:true};var envIDs=[1,2,3,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="active"/>'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/action_archive'){var partnerIDS=args.args[0];var records=this.data.partner.records
_.each(partnerIDS,function(partnerID){_.find(records,function(record){return record.id===partnerID;}).active=false;})
this.data.partner.records[0].active;return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.containsOnce(kanban,'.o_kanban_header:first .o_kanban_config .o_column_archive_records');assert.containsOnce(kanban,'.o_kanban_header:first .o_kanban_config .o_column_unarchive_records');assert.deepEqual(kanban.exportState().resIds,envIDs);assert.containsN(kanban,'.o_kanban_group:last .o_kanban_record',3);testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_column_archive_records'));assert.containsOnce(document.body,'.modal',"a confirm modal should be displayed");await testUtils.modal.clickButton('Cancel');assert.containsN(kanban,'.o_kanban_group:last .o_kanban_record',3,"still last column should contain 3 records");testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_column_archive_records'));assert.ok($('.modal').length,'a confirm modal should be displayed');await testUtils.modal.clickButton('Ok');assert.containsNone(kanban,'.o_kanban_group:last .o_kanban_record',"last column should not contain any records");envIDs=[4];assert.deepEqual(kanban.exportState().resIds,envIDs);kanban.destroy();});QUnit.test('basic grouped rendering with active field and archive enabled (archivable true)',async function(assert){assert.expect(7);this.data.partner.fields.active={string:'Active',type:'char',default:true};var envIDs=[1,2,3,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" archivable="true">'+'<field name="active"/>'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/action_archive'){var partnerIDS=args.args[0];var records=this.data.partner.records
_.each(partnerIDS,function(partnerID){_.find(records,function(record){return record.id===partnerID;}).active=false;})
this.data.partner.records[0].active;return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.ok(kanban.$('.o_kanban_header:first .o_kanban_config .o_column_archive_records').length,"should be able to archive all the records");assert.ok(kanban.$('.o_kanban_header:first .o_kanban_config .o_column_unarchive_records').length,"should be able to restore all the records");assert.containsN(kanban,'.o_kanban_group:last .o_kanban_record',3,"last column should contain 3 records");envIDs=[4];testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_column_archive_records'));assert.ok($('.modal').length,'a confirm modal should be displayed');await testUtils.modal.clickButton('Cancel');assert.containsN(kanban,'.o_kanban_group:last .o_kanban_record',3,"still last column should contain 3 records");testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_column_archive_records'));assert.ok($('.modal').length,'a confirm modal should be displayed');await testUtils.modal.clickButton('Ok');assert.containsNone(kanban,'.o_kanban_group:last .o_kanban_record',"last column should not contain any records");kanban.destroy();});QUnit.test('basic grouped rendering with active field and hidden archive buttons (archivable false)',async function(assert){assert.expect(2);this.data.partner.fields.active={string:'Active',type:'char',default:true};var envIDs=[1,2,3,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" archivable="false">'+'<field name="active"/>'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});assert.strictEqual(kanban.$('.o_kanban_header:first .o_kanban_config .o_column_archive_records').length,0,"should not be able to archive all the records");assert.strictEqual(kanban.$('.o_kanban_header:first .o_kanban_config .o_column_unarchive_records').length,0,"should not be able to restore all the records");kanban.destroy();});QUnit.test('context can be used in kanban template',async function(assert){assert.expect(2);var form=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates>'+'<t t-name="kanban-box">'+'<div>'+'<t t-if="context.some_key">'+'<field name="foo"/>'+'</t>'+'</div>'+'</t>'+'</templates>'+'</kanban>',context:{some_key:1},domain:[['id','=',1]],});assert.strictEqual(form.$('.o_kanban_record:not(.o_kanban_ghost)').length,1,"there should be one record");assert.strictEqual(form.$('.o_kanban_record span:contains(yop)').length,1,"condition in the kanban template should have been correctly evaluated");form.destroy();});QUnit.test('pager should be hidden in grouped mode',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});assert.containsNone(kanban,'.o_pager');kanban.destroy();});QUnit.test('pager, ungrouped, with default limit',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',mockRPC:function(route,args){assert.strictEqual(args.limit,40,"default limit should be 40 in Kanban");return this._super.apply(this,arguments);},});assert.containsOnce(kanban,'.o_pager');assert.strictEqual(cpHelpers.getPagerSize(kanban),"4","pager's size should be 4");kanban.destroy();});QUnit.test('pager, ungrouped, with limit given in options',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',mockRPC:function(route,args){assert.strictEqual(args.limit,2,"limit should be 2");return this._super.apply(this,arguments);},viewOptions:{limit:2,},});assert.strictEqual(cpHelpers.getPagerValue(kanban),"1-2","pager's limit should be 2");assert.strictEqual(cpHelpers.getPagerSize(kanban),"4","pager's size should be 4");kanban.destroy();});QUnit.test('pager, ungrouped, with limit set on arch and given in options',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" limit="3">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',mockRPC:function(route,args){assert.strictEqual(args.limit,3,"limit should be 3");return this._super.apply(this,arguments);},viewOptions:{limit:2,},});assert.strictEqual(cpHelpers.getPagerValue(kanban),"1-3","pager's limit should be 3");assert.strictEqual(cpHelpers.getPagerSize(kanban),"4","pager's size should be 4");kanban.destroy();});QUnit.test('create in grouped on m2o',async function(assert){assert.expect(5);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.hasClass(kanban.$('.o_kanban_view'),'ui-sortable',"columns are sortable when grouped by a m2o field");assert.hasClass(kanban.$buttons.find('.o-kanban-button-new'),'btn-primary',"'create' button should be btn-primary for grouped kanban with at least one column");assert.hasClass(kanban.$('.o_kanban_view > div:last'),'o_column_quick_create',"column quick create should be enabled when grouped by a many2one field)");await testUtils.kanban.clickCreate(kanban);assert.hasClass(kanban.$('.o_kanban_group:first() > div:nth(1)'),'o_kanban_quick_create',"clicking on create should open the quick_create in the first column");assert.ok(kanban.$('span.o_column_title:contains(hello)').length,"should have a column title with a value from the many2one");kanban.destroy();});QUnit.test('create in grouped on char',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['foo'],});assert.doesNotHaveClass(kanban.$('.o_kanban_view'),'ui-sortable',"columns aren't sortable when not grouped by a m2o field");assert.containsN(kanban,'.o_kanban_group',3,"should have "+3+" columns");assert.strictEqual(kanban.$('.o_kanban_group:first() .o_column_title').text(),"yop","'yop' column should be the first column");assert.doesNotHaveClass(kanban.$('.o_kanban_view > div:last'),'o_column_quick_create',"column quick create should be disabled when not grouped by a many2one field)");kanban.destroy();});QUnit.test('quick create record without quick_create_view',async function(assert){assert.expect(16);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='name_create'){assert.strictEqual(args.args[0],'new partner',"should send the correct value");}
return this._super.apply(this,arguments);},});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain one record");await testUtils.kanban.clickCreate(kanban);var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');assert.strictEqual($quickCreate.length,1,"should have a quick create element in the first column");assert.strictEqual($quickCreate.find('.o_form_view.o_xxs_form_view').length,1,"should have rendered an XXS form view");assert.strictEqual($quickCreate.find('input').length,1,"should have only one input");assert.hasClass($quickCreate.find('input'),'o_required_modifier',"the field should be required");assert.strictEqual($quickCreate.find('input[placeholder=Title]').length,1,"input placeholder should be 'Title'");await testUtils.fields.editInput($quickCreate.find('input'),'new partner');await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should contain two records");assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','onchange','name_create','read','onchange',]);kanban.destroy();});QUnit.test('quick create record with quick_create_view',async function(assert){assert.expect(19);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="state" widget="priority"/>'+'</form>',},groupBy:['bar'],mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='create'){assert.deepEqual(args.args[0],{foo:'new partner',int_field:4,state:'def',},"should send the correct values");}
return this._super.apply(this,arguments);},});assert.containsOnce(kanban,'.o_control_panel','should have one control panel');assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain one record");await testUtils.kanban.clickCreate(kanban);var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');assert.strictEqual($quickCreate.length,1,"should have a quick create element in the first column");assert.strictEqual($quickCreate.find('.o_form_view.o_xxs_form_view').length,1,"should have rendered an XXS form view");assert.containsOnce(kanban,'.o_control_panel','should not have instantiated an extra control panel');assert.strictEqual($quickCreate.find('input').length,2,"should have two inputs");assert.strictEqual($quickCreate.find('.o_field_widget').length,3,"should have rendered three widgets");await testUtils.fields.editInput($quickCreate.find('.o_field_widget[name=foo]'),'new partner');await testUtils.fields.editInput($quickCreate.find('.o_field_widget[name=int_field]'),'4');await testUtils.dom.click($quickCreate.find('.o_field_widget[name=state] .o_priority_star:first'));await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should contain two records");assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','load_views','onchange','create','read','load_views','onchange',]);kanban.destroy();});QUnit.test('quick create record in grouped on m2o (no quick_create_view)',async function(assert){assert.expect(12);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='name_create'){assert.strictEqual(args.args[0],'new partner',"should send the correct value");assert.deepEqual(args.kwargs.context,{default_product_id:3,default_qux:2.5,},"should send the correct context");}
return this._super.apply(this,arguments);},viewOptions:{context:{default_qux:2.5},},});assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should contain two records");await testUtils.kanban.clickCreate(kanban);var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'new partner');await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',3,"first column should contain three records");assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','onchange','name_create','read','onchange',]);kanban.destroy();});QUnit.test('quick create record in grouped on m2o (with quick_create_view)',async function(assert){assert.expect(14);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'<field name="state" widget="priority"/>'+'</form>',},groupBy:['product_id'],mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='create'){assert.deepEqual(args.args[0],{foo:'new partner',int_field:4,state:'def',},"should send the correct values");assert.deepEqual(args.kwargs.context,{default_product_id:3,default_qux:2.5,},"should send the correct context");}
return this._super.apply(this,arguments);},viewOptions:{context:{default_qux:2.5},},});assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should contain two records");await testUtils.kanban.clickCreate(kanban);var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('.o_field_widget[name=foo]'),'new partner');await testUtils.fields.editInput($quickCreate.find('.o_field_widget[name=int_field]'),'4');await testUtils.dom.click($quickCreate.find('.o_field_widget[name=state] .o_priority_star:first'));await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',3,"first column should contain three records");assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','load_views','onchange','create','read','load_views','onchange',]);kanban.destroy();});QUnit.test('quick create record with default values and onchanges',async function(assert){assert.expect(10);this.data.partner.fields.int_field.default=4;this.data.partner.onchanges={foo:function(obj){if(obj.foo){obj.int_field=8;}},};var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</form>',},groupBy:['bar'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await testUtils.kanban.clickCreate(kanban);var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');assert.strictEqual($quickCreate.length,1,"should have a quick create element in the first column");assert.strictEqual($quickCreate.find('.o_field_widget[name=int_field]').val(),'4',"default value should be set");await testUtils.fields.editInput($quickCreate.find('.o_field_widget[name=foo]'),'new partner');assert.strictEqual($quickCreate.find('.o_field_widget[name=int_field]').val(),'8',"onchange should have been triggered");assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','load_views','onchange','onchange',]);kanban.destroy();});QUnit.test('quick create record with quick_create_view: modifiers',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo" required="1"/>'+'<field name="int_field" attrs=\'{"invisible": [["foo", "=", false]]}\'/>'+'</form>',},groupBy:['bar'],});await testUtils.dom.click(kanban.$('.o_kanban_group:first .o_kanban_quick_add'));var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');assert.hasClass($quickCreate.find('.o_field_widget[name=foo]'),'o_required_modifier',"foo field should be required");assert.hasClass($quickCreate.find('.o_field_widget[name=int_field]'),'o_invisible_modifier',"int_field should be invisible");await testUtils.fields.editInput($quickCreate.find('.o_field_widget[name=foo]'),'new partner');assert.doesNotHaveClass($quickCreate.find('.o_field_widget[name=int_field]'),'o_invisible_modifier',"int_field should now be visible");kanban.destroy();});QUnit.test('quick create record and change state in grouped mode',async function(assert){assert.expect(1);this.data.partner.fields.kanban_state={string:"Kanban State",type:"selection",selection:[["normal","Grey"],["done","Green"],["blocked","Red"]],};var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'<div class="oe_kanban_bottom_right">'+'<field name="kanban_state" widget="state_selection"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['foo'],});await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());var $quickAdd=kanban.$('.o_kanban_quick_create');$quickAdd.find('.o_input').val('Test');await testUtils.dom.click($quickAdd.find('.o_kanban_add'));await testUtils.dom.click(kanban.$('.o_status').first());await testUtils.dom.click(kanban.$('.o_selection .dropdown-item:first'));assert.hasClass(kanban.$('.o_status').first(),'o_status_green',"Kanban state should be done (Green)");kanban.destroy();});QUnit.test('window resize should not change quick create form size',async function(assert){assert.expect(2);testUtils.mock.patch(FormRenderer,{start:function(){this._super.apply(this,arguments);window.addEventListener("resize",this._applyFormSizeClass.bind(this));},});const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});await testUtils.dom.click(kanban.el.querySelector('.o_kanban_header .o_kanban_quick_add i'));const quickCreate=kanban.el.querySelector('.o_kanban_quick_create');assert.hasClass(quickCreate.querySelector('.o_form_view'),"o_xxs_form_view");window.dispatchEvent(new Event('resize'));assert.hasClass(quickCreate.querySelector('.o_form_view'),'o_xxs_form_view');kanban.destroy();testUtils.mock.unpatch(FormRenderer);});QUnit.test('quick create record: cancel and validate without using the buttons',async function(assert){assert.expect(8);var nbRecords=4;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});assert.strictEqual(kanban.exportState().resIds.length,nbRecords);await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());var $quickCreate=kanban.$('.o_kanban_quick_create');assert.strictEqual($quickCreate.length,1,"should have a quick create element");$quickCreate.find('input').trigger($.Event('keydown',{keyCode:$.ui.keyCode.ESCAPE,which:$.ui.keyCode.ESCAPE,}));assert.containsNone(kanban,'.o_kanban_quick_create',"should have destroyed the quick create element");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());await testUtils.dom.click(kanban.$('.o_kanban_group .o_kanban_record:first'));assert.containsNone(kanban,'.o_kanban_quick_create',"the quick create should be destroyed when the user clicks outside");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());$quickCreate=kanban.$('.o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'new partner');await testUtils.dom.click(kanban.$('.o_kanban_group .o_kanban_record:first'));assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should not have been destroyed");nbRecords=5;$quickCreate.find('input').trigger($.Event('keydown',{keyCode:$.ui.keyCode.ENTER,which:$.ui.keyCode.ENTER,}));await nextTick();assert.strictEqual(this.data.partner.records.length,5,"should have created a partner");assert.strictEqual(_.last(this.data.partner.records).name,"new partner","should have correct name");assert.strictEqual(kanban.exportState().resIds.length,nbRecords);kanban.destroy();});QUnit.test('quick create record: validate with ENTER',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</form>',},groupBy:['bar'],fieldDebounce:5000,});assert.containsN(kanban,'.o_kanban_record',4,"should have 4 records at the beginning");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());await testUtils.kanban.quickCreate(kanban,'new partner','foo');assert.containsN(kanban,'.o_kanban_record',5,"should have created a new record");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'',"quick create should now be empty");kanban.destroy();});QUnit.test('quick create record: prevent multiple adds with ENTER',async function(assert){assert.expect(9);var prom=makeTestPromise();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</form>',},groupBy:['bar'],fieldDebounce:5000,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='create'){assert.step('create');return prom.then(function(){return result;});}
return result;},});assert.containsN(kanban,'.o_kanban_record',4,"should have 4 records at the beginning");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());var enterEvent={keyCode:$.ui.keyCode.ENTER,which:$.ui.keyCode.ENTER,};await testUtils.fields.editAndTrigger(kanban.$('.o_kanban_quick_create').find('input[name=foo]'),'new partner',['input',$.Event('keydown',enterEvent),$.Event('keydown',enterEvent)]);assert.containsN(kanban,'.o_kanban_record',4,"should not have created the record yet");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'new partner',"quick create should not be empty yet");assert.hasClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be disabled");prom.resolve();await nextTick();assert.containsN(kanban,'.o_kanban_record',5,"should have created a new record");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'',"quick create should now be empty");assert.doesNotHaveClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be enabled");assert.verifySteps(['create']);kanban.destroy();});QUnit.test('quick create record: prevent multiple adds with Add clicked',async function(assert){assert.expect(9);var prom=makeTestPromise();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</form>',},groupBy:['bar'],mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='create'){assert.step('create');return prom.then(function(){return result;});}
return result;},});assert.containsN(kanban,'.o_kanban_record',4,"should have 4 records at the beginning");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create').find('input[name=foo]'),'new partner');await testUtils.dom.click(kanban.$('.o_kanban_quick_create').find('.o_kanban_add'));await testUtils.dom.click(kanban.$('.o_kanban_quick_create').find('.o_kanban_add'));assert.containsN(kanban,'.o_kanban_record',4,"should not have created the record yet");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'new partner',"quick create should not be empty yet");assert.hasClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be disabled");prom.resolve();await nextTick();assert.containsN(kanban,'.o_kanban_record',5,"should have created a new record");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'',"quick create should now be empty");assert.doesNotHaveClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be enabled");assert.verifySteps(['create']);kanban.destroy();});QUnit.test('quick create record: prevent multiple adds with ENTER, with onchange',async function(assert){assert.expect(13);this.data.partner.onchanges={foo:function(obj){obj.int_field+=(obj.foo?3:0);},};var shouldDelayOnchange=false;var prom=makeTestPromise();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</form>',},groupBy:['bar'],mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){assert.step('onchange');if(shouldDelayOnchange){return Promise.resolve(prom).then(function(){return result;});}}
if(args.method==='create'){assert.step('create');assert.deepEqual(_.pick(args.args[0],'foo','int_field'),{foo:'new partner',int_field:3,});}
return result;},fieldDebounce:5000,});assert.containsN(kanban,'.o_kanban_record',4,"should have 4 records at the beginning");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());shouldDelayOnchange=true;var enterEvent={keyCode:$.ui.keyCode.ENTER,which:$.ui.keyCode.ENTER,};await testUtils.fields.editAndTrigger(kanban.$('.o_kanban_quick_create').find('input[name=foo]'),'new partner',['input',$.Event('keydown',enterEvent),$.Event('keydown',enterEvent)]);assert.containsN(kanban,'.o_kanban_record',4,"should not have created the record yet");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'new partner',"quick create should not be empty yet");assert.hasClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be disabled");prom.resolve();await nextTick();assert.containsN(kanban,'.o_kanban_record',5,"should have created a new record");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'',"quick create should now be empty");assert.doesNotHaveClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be enabled");assert.verifySteps(['onchange','onchange','create','onchange',]);kanban.destroy();});QUnit.test('quick create record: click Add to create, with delayed onchange',async function(assert){assert.expect(13);this.data.partner.onchanges={foo:function(obj){obj.int_field+=(obj.foo?3:0);},};var shouldDelayOnchange=false;var prom=makeTestPromise();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/><field name="int_field"/></div>'+'</t></templates></kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'<field name="int_field"/>'+'</form>',},groupBy:['bar'],mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='onchange'){assert.step('onchange');if(shouldDelayOnchange){return Promise.resolve(prom).then(function(){return result;});}}
if(args.method==='create'){assert.step('create');assert.deepEqual(_.pick(args.args[0],'foo','int_field'),{foo:'new partner',int_field:3,});}
return result;},});assert.containsN(kanban,'.o_kanban_record',4,"should have 4 records at the beginning");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());shouldDelayOnchange=true;await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create').find('input[name=foo]'),'new partner');await testUtils.dom.click(kanban.$('.o_kanban_quick_create').find('.o_kanban_add'));assert.containsN(kanban,'.o_kanban_record',4,"should not have created the record yet");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'new partner',"quick create should not be empty yet");assert.hasClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be disabled");prom.resolve();await nextTick();assert.containsN(kanban,'.o_kanban_record',5,"should have created a new record");assert.strictEqual(kanban.$('.o_kanban_quick_create input[name=foo]').val(),'',"quick create should now be empty");assert.doesNotHaveClass(kanban.$('.o_kanban_quick_create'),'o_disabled',"quick create should be enabled");assert.verifySteps(['onchange','onchange','create','onchange',]);kanban.destroy();});QUnit.test('quick create when first column is folded',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});assert.doesNotHaveClass(kanban.$('.o_kanban_group:first'),'o_column_folded',"first column should not be folded");testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:first'));await testUtils.dom.click(kanban.$('.o_kanban_group:first .o_kanban_toggle_fold'));assert.hasClass(kanban.$('.o_kanban_group:first'),'o_column_folded',"first column should be folded");await testUtils.kanban.clickCreate(kanban);assert.doesNotHaveClass(kanban.$('.o_kanban_group:first'),'o_column_folded',"first column should no longer be folded");var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');assert.strictEqual($quickCreate.length,1,"should have added a quick create element in first column");testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:first'));await testUtils.dom.click(kanban.$('.o_kanban_group:first .o_kanban_toggle_fold'));assert.hasClass(kanban.$('.o_kanban_group:first'),'o_column_folded',"first column should be folded");assert.containsNone(kanban,'.o_kanban_quick_create',"there should be no more quick create");kanban.destroy();});QUnit.test('quick create record: cancel when not dirty',async function(assert){assert.expect(11);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain one record");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have kept the quick create open");await testUtils.dom.click(kanban.$('.o_kanban_group .o_kanban_record:first'));assert.containsNone(kanban,'.o_kanban_quick_create',"the quick create should not have been destroyed");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");kanban.$('.o_kanban_quick_create input').trigger($.Event('keydown',{keyCode:$.ui.keyCode.ESCAPE,which:$.ui.keyCode.ESCAPE,}));assert.containsNone(kanban,'.o_kanban_quick_create',"quick create widget should have been removed");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());await testUtils.dom.click(kanban.$('.o_kanban_group .o_kanban_record:first'));assert.containsNone(kanban,'.o_kanban_quick_create',"the quick create should be destroyed when the user clicks outside");assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should still contain one record");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");await testUtils.dom.click(kanban.$('.o_kanban_quick_create'));assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should not have been destroyed when clicked on itself");kanban.destroy();});QUnit.test('quick create record: cancel when modal is opened',async function(assert){assert.expect(3);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="product_id"/>'+'</form>',},groupBy:['bar'],});await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");kanban.$('.o_kanban_quick_create input').val('test').trigger('keyup').trigger('focusout');await nextTick();const $body=kanban.$el.closest('body');assert.hasClass($body,'modal-open',"modal should be opening after m2o focusout");await testUtils.dom.click($body);assert.containsOnce(kanban,'.o_kanban_quick_create',"quick create should stay open while modal is opening");kanban.destroy();});QUnit.test('quick create record: cancel when dirty',async function(assert){assert.expect(7);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain one record");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");var $quickCreate=kanban.$('.o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'some value');await testUtils.dom.click(kanban.$('.o_kanban_group .o_kanban_record:first'));assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should not have been destroyed");$quickCreate.find('input').trigger($.Event('keydown',{keyCode:$.ui.keyCode.ESCAPE,which:$.ui.keyCode.ESCAPE,}));assert.containsNone(kanban,'.o_kanban_quick_create',"quick create widget should have been removed");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");$quickCreate=kanban.$('.o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'some value');await testUtils.dom.click(kanban.$('.o_kanban_quick_create .o_kanban_cancel'));assert.containsNone(kanban,'.o_kanban_quick_create',"the quick create should be destroyed when the user clicks outside");assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should still contain one record");kanban.destroy();});QUnit.test('quick create record and edit in grouped mode',async function(assert){assert.expect(6);var newRecordID;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',mockRPC:function(route,args){var def=this._super.apply(this,arguments);if(args.method==='name_create'){def.then(function(result){newRecordID=result[0];});}
return def;},groupBy:['bar'],intercepts:{switch_view:function(event){assert.strictEqual(event.data.mode,"edit","should trigger 'open_record' event in edit mode");assert.strictEqual(event.data.res_id,newRecordID,"should open the correct record");},},});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain one record");var $quickCreate=kanban.$('.o_kanban_quick_create');await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());$quickCreate=kanban.$('.o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'new partner');await testUtils.dom.click($quickCreate.find('button.o_kanban_edit'));assert.strictEqual(this.data.partner.records.length,5,"should have created a partner");assert.strictEqual(_.last(this.data.partner.records).name,"new partner","should have correct name");assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should now contain two records");kanban.destroy();});QUnit.test('quick create several records in a row',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain one record");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should be open");await testUtils.kanban.quickCreate(kanban,'new partner 1');assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should now contain two records");assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should still be open");await testUtils.kanban.quickCreate(kanban,'new partner 2');assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',3,"first column should now contain three records");assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should still be open");kanban.destroy();});QUnit.test('quick create is disabled until record is created and read',async function(assert){assert.expect(6);var prom=makeTestPromise();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read'){return prom.then(_.constant(result));}
return result;},});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain one record");await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should be open");await testUtils.kanban.quickCreate(kanban,'new partner 1');assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should still contain one record");assert.containsOnce(kanban,'.o_kanban_quick_create.o_disabled',"quick create should be disabled");prom.resolve();await nextTick();assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should now contain two records");assert.strictEqual(kanban.$('.o_kanban_quick_create:not(.o_disabled)').length,1,"quick create should be enabled");kanban.destroy();});QUnit.test('quick create record fail in grouped by many2one',async function(assert){assert.expect(8);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,false,form':'<form string="Partner">'+'<field name="product_id"/>'+'<field name="foo"/>'+'</form>',},groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='name_create'){return Promise.reject({message:{code:200,data:{},message:"Odoo server error",},event:$.Event()});}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"there should be 2 records in first column");await testUtils.kanban.clickCreate(kanban);assert.hasClass(kanban.$('.o_kanban_group:first() > div:nth(1)'),'o_kanban_quick_create',"clicking on create should open the quick_create in the first column");await testUtils.kanban.quickCreate(kanban,'test');assert.strictEqual($('.modal .o_form_view.o_form_editable').length,1,"a form view dialog should have been opened (in edit)");assert.strictEqual($('.modal .o_field_many2one input').val(),'hello',"the correct product_id should already be set");await testUtils.fields.editInput($('.modal input[name=foo]'),'test');await testUtils.modal.clickButton('Save');assert.strictEqual($('.modal').length,0,"the modal should be closed");assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',3,"there should be 3 records in first column");var $firstRecord=kanban.$('.o_kanban_group:first .o_kanban_record:first');assert.strictEqual($firstRecord.text(),'test',"the first record of the first column should be the new one");assert.strictEqual(kanban.$('.o_kanban_quick_create:not(.o_disabled)').length,1,"quick create should be enabled");kanban.destroy();});QUnit.test('quick create record is re-enabled after discard on failure',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,false,form':'<form string="Partner">'+'<field name="product_id"/>'+'<field name="foo"/>'+'</form>',},groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='name_create'){return Promise.reject({message:{code:200,data:{},message:"Odoo server error",},event:$.Event()});}
return this._super.apply(this,arguments);}});await testUtils.kanban.clickCreate(kanban);assert.containsOnce(kanban,'.o_kanban_quick_create',"should have a quick create widget");await testUtils.kanban.quickCreate(kanban,'test');assert.strictEqual($('.modal .o_form_view.o_form_editable').length,1,"a form view dialog should have been opened (in edit)");await testUtils.modal.clickButton('Discard');assert.strictEqual($('.modal').length,0,"the modal should be closed");assert.strictEqual(kanban.$('.o_kanban_quick_create:not(.o_disabled)').length,1,"quick create widget should have been re-enabled");kanban.destroy();});QUnit.test('quick create record fails in grouped by char',async function(assert){assert.expect(7);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,false,form':'<form>'+'<field name="foo"/>'+'</form>',},mockRPC:function(route,args){if(args.method==='name_create'){return Promise.reject({message:{code:200,data:{},message:"Odoo server error",},event:$.Event()});}
if(args.method==='create'){assert.deepEqual(args.args[0],{foo:'yop'},"should write the correct value for foo");assert.deepEqual(args.kwargs.context,{default_foo:'yop',default_name:'test'},"should send the correct default value for foo");}
return this._super.apply(this,arguments);},groupBy:['foo'],});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"there should be 1 record in first column");await testUtils.dom.click(kanban.$('.o_kanban_header:first .o_kanban_quick_add i'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create input'),'test');await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.strictEqual($('.modal .o_form_view.o_form_editable').length,1,"a form view dialog should have been opened (in edit)");assert.strictEqual($('.modal .o_field_widget[name=foo]').val(),'yop',"the correct default value for foo should already be set");await testUtils.modal.clickButton('Save');assert.strictEqual($('.modal').length,0,"the modal should be closed");assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"there should be 2 records in first column");kanban.destroy();});QUnit.test('quick create record fails in grouped by selection',async function(assert){assert.expect(7);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="state"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,false,form':'<form>'+'<field name="state"/>'+'</form>',},mockRPC:function(route,args){if(args.method==='name_create'){return Promise.reject({message:{code:200,data:{},message:"Odoo server error",},event:$.Event()});}
if(args.method==='create'){assert.deepEqual(args.args[0],{state:'abc'},"should write the correct value for state");assert.deepEqual(args.kwargs.context,{default_state:'abc',default_name:'test'},"should send the correct default value for state");}
return this._super.apply(this,arguments);},groupBy:['state'],});assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"there should be 1 record in first column");await testUtils.dom.click(kanban.$('.o_kanban_header:first .o_kanban_quick_add i'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create input'),'test');await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.strictEqual($('.modal .o_form_view.o_form_editable').length,1,"a form view dialog should have been opened (in edit)");assert.strictEqual($('.modal .o_field_widget[name=state]').val(),'"abc"',"the correct default value for state should already be set");await testUtils.modal.clickButton('Save');assert.strictEqual($('.modal').length,0,"the modal should be closed");assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"there should be 2 records in first column");kanban.destroy();});QUnit.test('quick create record in empty grouped kanban',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='web_read_group'){var result={groups:[{__domain:[['product_id','=',3]],product_id_count:0},{__domain:[['product_id','=',5]],product_id_count:0},],length:2,};return Promise.resolve(result);}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_group',2,"there should be 2 columns");assert.containsNone(kanban,'.o_kanban_record',"both columns should be empty");await testUtils.kanban.clickCreate(kanban);assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_quick_create',"should have opened the quick create in the first column");kanban.destroy();});QUnit.test('quick create record in grouped on date(time) field',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'</t></templates>'+'</kanban>',groupBy:['date'],intercepts:{switch_view:function(ev){assert.deepEqual(_.pick(ev.data,'res_id','view_type'),{res_id:undefined,view_type:'form',},"should trigger an event to open the form view (twice)");},},});assert.containsNone(kanban,'.o_kanban_header .o_kanban_quick_add i',"quick create should be disabled when grouped on a date field");await testUtils.kanban.clickCreate(kanban);assert.containsNone(kanban,'.o_kanban_quick_create',"should not have opened the quick create widget");await kanban.reload({groupBy:['datetime']});assert.containsNone(kanban,'.o_kanban_header .o_kanban_quick_add i',"quick create should be disabled when grouped on a datetime field");await testUtils.kanban.clickCreate(kanban);assert.containsNone(kanban,'.o_kanban_quick_create',"should not have opened the quick create widget");kanban.destroy();});QUnit.test('quick create record feature is properly enabled/disabled at reload',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'</t></templates>'+'</kanban>',groupBy:['foo'],});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',3,"quick create should be enabled when grouped on a char field");await kanban.reload({groupBy:['date']});assert.containsNone(kanban,'.o_kanban_header .o_kanban_quick_add i',"quick create should now be disabled (grouped on date field)");await kanban.reload({groupBy:['bar']});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',2,"quick create should be enabled again (grouped on boolean field)");kanban.destroy();});QUnit.test('quick create record in grouped by char field',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'</t></templates>'+'</kanban>',groupBy:['foo'],mockRPC:function(route,args){if(args.method==='name_create'){assert.deepEqual(args.kwargs.context,{default_foo:'yop'},"should send the correct default value for foo");}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',3,"quick create should be enabled when grouped on a char field");assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain 1 record");await testUtils.dom.click(kanban.$('.o_kanban_header:first .o_kanban_quick_add i'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create input'),'new record');await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should now contain 2 records");kanban.destroy();});QUnit.test('quick create record in grouped by boolean field',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],mockRPC:function(route,args){if(args.method==='name_create'){assert.deepEqual(args.kwargs.context,{default_bar:true},"should send the correct default value for bar");}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',2,"quick create should be enabled when grouped on a boolean field");assert.strictEqual(kanban.$('.o_kanban_group:nth(1) .o_kanban_record').length,3,"second column (true) should contain 3 records");await testUtils.dom.click(kanban.$('.o_kanban_header:nth(1) .o_kanban_quick_add i'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create input'),'new record');await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.strictEqual(kanban.$('.o_kanban_group:nth(1) .o_kanban_record').length,4,"second column (true) should now contain 4 records");kanban.destroy();});QUnit.test('quick create record in grouped on selection field',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'</t></templates>'+'</kanban>',mockRPC:function(route,args){if(args.method==='name_create'){assert.deepEqual(args.kwargs.context,{default_state:'abc'},"should send the correct default value for bar");}
return this._super.apply(this,arguments);},groupBy:['state'],});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',3,"quick create should be enabled when grouped on a selection field");assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column (abc) should contain 1 record");await testUtils.dom.click(kanban.$('.o_kanban_header:first .o_kanban_quick_add i'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create input'),'new record');await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column (abc) should contain 2 records");kanban.destroy();});QUnit.test('quick create record in grouped by char field (within quick_create_view)',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="foo"/>'+'</form>',},groupBy:['foo'],mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0],{foo:'yop'},"should write the correct value for foo");assert.deepEqual(args.kwargs.context,{default_foo:'yop'},"should send the correct default value for foo");}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',3,"quick create should be enabled when grouped on a char field");assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column should contain 1 record");await testUtils.dom.click(kanban.$('.o_kanban_header:first .o_kanban_quick_add i'));assert.strictEqual(kanban.$('.o_kanban_quick_create input').val(),'yop',"should have set the correct foo value by default");await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column should now contain 2 records");kanban.destroy();});QUnit.test('quick create record in grouped by boolean field (within quick_create_view)',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<templates><t t-name="kanban-box">'+'<div><field name="bar"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="bar"/>'+'</form>',},groupBy:['bar'],mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0],{bar:true},"should write the correct value for bar");assert.deepEqual(args.kwargs.context,{default_bar:true},"should send the correct default value for bar");}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',2,"quick create should be enabled when grouped on a boolean field");assert.strictEqual(kanban.$('.o_kanban_group:nth(1) .o_kanban_record').length,3,"second column (true) should contain 3 records");await testUtils.dom.click(kanban.$('.o_kanban_header:nth(1) .o_kanban_quick_add i'));assert.ok(kanban.$('.o_kanban_quick_create .o_field_boolean input').is(':checked'),"should have set the correct bar value by default");await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.strictEqual(kanban.$('.o_kanban_group:nth(1) .o_kanban_record').length,4,"second column (true) should now contain 4 records");kanban.destroy();});QUnit.test('quick create record in grouped by selection field (within quick_create_view)',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<templates><t t-name="kanban-box">'+'<div><field name="state"/></div>'+'</t></templates>'+'</kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="state"/>'+'</form>',},groupBy:['state'],mockRPC:function(route,args){if(args.method==='create'){assert.deepEqual(args.args[0],{state:'abc'},"should write the correct value for state");assert.deepEqual(args.kwargs.context,{default_state:'abc'},"should send the correct default value for state");}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_header .o_kanban_quick_add i',3,"quick create should be enabled when grouped on a selection field");assert.containsOnce(kanban,'.o_kanban_group:first .o_kanban_record',"first column (abc) should contain 1 record");await testUtils.dom.click(kanban.$('.o_kanban_header:first .o_kanban_quick_add i'));assert.strictEqual(kanban.$('.o_kanban_quick_create select').val(),'"abc"',"should have set the correct state value by default");await testUtils.dom.click(kanban.$('.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2,"first column (abc) should now contain 2 records");kanban.destroy();});QUnit.test('quick create record while adding a new column',async function(assert){assert.expect(10);var def=testUtils.makeTestPromise();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='name_create'&&args.model==='product'){return def.then(_.constant(result));}
return result;},});assert.containsN(kanban,'.o_kanban_group',2);assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',2);assert.containsOnce(kanban,'.o_column_quick_create');assert.isNotVisible(kanban.$('.o_column_quick_create input'));await testUtils.dom.click(kanban.$('.o_quick_create_folded'));assert.isVisible(kanban.$('.o_column_quick_create input'));await testUtils.fields.editInput(kanban.$('.o_column_quick_create input'),'new column');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group',2);await testUtils.dom.click(kanban.$buttons.find('.o-kanban-button-new'));assert.containsNone(kanban,'.o_kanban_quick_create');def.resolve();await testUtils.nextTick();assert.containsN(kanban,'.o_kanban_group',3);assert.containsOnce(kanban,'.o_kanban_quick_create');await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create input'),'new record');await testUtils.dom.click(kanban.$('.o_kanban_quick_create .o_kanban_add'));assert.containsN(kanban,'.o_kanban_group:first .o_kanban_record',3);kanban.destroy();});QUnit.test('close a column while quick creating a record',async function(assert){assert.expect(6);const def=testUtils.makeTestPromise();const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban on_create="quick_create" quick_create_view="some_view_ref">
                    <templates><t t-name="kanban-box">
                        <div><field name="foo"/></div>
                    </t></templates>
                </kanban>`,archs:{'partner,some_view_ref,form':'<form><field name="int_field"/></form>',},groupBy:['product_id'],async mockRPC(route,args){const result=this._super(...arguments);if(args.method==='load_views'){await def;}
return result;},});assert.containsN(kanban,'.o_kanban_group',2);assert.containsNone(kanban,'.o_column_folded');await testUtils.dom.click(kanban.$('.o_kanban_group:first .o_kanban_quick_add'));assert.containsNone(kanban,'.o_form_view');await testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:first'));await testUtils.dom.click(kanban.$('.o_kanban_group:first .o_kanban_toggle_fold'));assert.containsOnce(kanban,'.o_column_folded');def.resolve();await testUtils.nextTick();assert.containsNone(kanban,'.o_form_view');assert.containsOnce(kanban,'.o_column_folded');kanban.destroy();});QUnit.test('quick create record: open on a column while another column has already one',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});await testUtils.dom.click(kanban.$('.o_kanban_group:nth-child(1) .o_kanban_quick_add'));assert.containsOnce(kanban,'.o_kanban_quick_create');assert.containsOnce(kanban.$('.o_kanban_group:nth-child(1)'),'.o_kanban_quick_create');await testUtils.dom.click(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_quick_add'));assert.containsOnce(kanban,'.o_kanban_quick_create');assert.containsOnce(kanban.$('.o_kanban_group:nth-child(2)'),'.o_kanban_quick_create');await testUtils.dom.click(kanban.$('.o_kanban_group:nth-child(1) .o_kanban_quick_add'));assert.containsOnce(kanban,'.o_kanban_quick_create');assert.containsOnce(kanban.$('.o_kanban_group:nth-child(1)'),'.o_kanban_quick_create');kanban.destroy();});QUnit.test('many2many_tags in kanban views',async function(assert){assert.expect(12);this.data.partner.records[0].category_ids=[6,7];this.data.partner.records[1].category_ids=[7,8];this.data.category.records.push({id:8,name:"hello",color:0,});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<templates><t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<field name="category_ids" widget="many2many_tags" options="{\'color_field\': \'color\'}"/>'+'<field name="foo"/>'+'<field name="state" widget="priority"/>'+'</div>'+'</t></templates>'+'</kanban>',mockRPC:function(route){assert.step(route);return this._super.apply(this,arguments);},intercepts:{switch_view:function(event){assert.deepEqual(_.pick(event.data,'mode','model','res_id','view_type'),{mode:'readonly',model:'partner',res_id:1,view_type:'form',},"should trigger an event to open the clicked record in a form view");},},});var $first_record=kanban.$('.o_kanban_record:first()');assert.strictEqual($first_record.find('.o_field_many2manytags .o_tag').length,2,'first record should contain 2 tags');assert.hasClass($first_record.find('.o_tag:first()'),'o_tag_color_2','first tag should have color 2');assert.verifySteps(['/web/dataset/search_read','/web/dataset/call_kw/category/read'],'two RPC should have been done (one search read and one read for the m2m)');assert.strictEqual(kanban.$('.o_kanban_record').eq(1).find('.o_tag').length,1,'there should be only one tag in second record');await testUtils.dom.click(kanban.$('.o_field_widget.o_priority a.o_priority_star.fa-star-o').first());assert.verifySteps(['/web/dataset/call_kw/partner/write','/web/dataset/call_kw/partner/read','/web/dataset/call_kw/category/read'],'five RPCs should have been done (previous 2, 1 write (triggers a re-render), same 2 at re-render');assert.strictEqual(kanban.$('.o_kanban_record:first()').find('.o_field_many2manytags .o_tag').length,2,'first record should still contain only 2 tags');await testUtils.dom.click(kanban.$('.o_tag:contains(gold):first'));kanban.destroy();});QUnit.test('Do not open record when clicking on `a` with `href`',async function(assert){assert.expect(5);this.data.partner.records=[{id:1,foo:'yop'},];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<templates>'+'<t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<field name="foo"/>'+'<div>'+'<a class="o_test_link" href="#">test link</a>'+'</div>'+'</div>'+'</t>'+'</templates>'+'</kanban>',intercepts:{switch_view:function(){throw new Error("should not switch view");},},doNotDisableAHref:true,});var $record=kanban.$('.o_kanban_record:not(.o_kanban_ghost)');assert.strictEqual($record.length,1,"should display a kanban record");var $testLink=$record.find('a');assert.strictEqual($testLink.length,1,"should contain a link in the kanban record");assert.ok(!!$testLink[0].href,"link inside kanban record should have non-empty href");$(document.body).on('click.o_test',function(ev){assert.notOk(ev.isDefaultPrevented(),"should not prevented browser default behaviour beforehand");assert.strictEqual(ev.target,$testLink[0],"should have clicked on the test link in the kanban record");ev.preventDefault();});await testUtils.dom.click($testLink);$(document.body).off('click.o_test');kanban.destroy();});QUnit.test('o2m loaded in only one batch',async function(assert){assert.expect(9);this.data.subtask={fields:{name:{string:'Name',type:'char'}},records:[{id:1,name:"subtask #1"},{id:2,name:"subtask #2"},]};this.data.partner.fields.subtask_ids={string:'Subtasks',type:'one2many',relation:'subtask'};this.data.partner.records[0].subtask_ids=[1];this.data.partner.records[1].subtask_ids=[2];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="subtask_ids" widget="many2many_tags"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await kanban.reload();assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','read','web_read_group','/web/dataset/search_read','/web/dataset/search_read','read',]);kanban.destroy();});QUnit.test('m2m loaded in only one batch',async function(assert){assert.expect(9);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="category_ids" widget="many2many_tags"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await kanban.reload(kanban);assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','read','web_read_group','/web/dataset/search_read','/web/dataset/search_read','read',]);kanban.destroy();});QUnit.test('fetch reference in only one batch',async function(assert){assert.expect(9);this.data.partner.records[0].ref_product='product,3';this.data.partner.records[1].ref_product='product,5';this.data.partner.fields.ref_product={string:"Reference Field",type:'reference',};var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<field name="ref_product"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await kanban.reload();assert.verifySteps(['web_read_group','/web/dataset/search_read','/web/dataset/search_read','name_get','web_read_group','/web/dataset/search_read','/web/dataset/search_read','name_get',]);kanban.destroy();});QUnit.test('wait x2manys batch fetches to re-render',async function(assert){assert.expect(7);var done=assert.async();var def=Promise.resolve();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="category_ids" widget="many2many_tags"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){var result=this._super(route,args);if(args.method==='read'){return def.then(function(){return result;});}
return result;},});def=testUtils.makeTestPromise();assert.containsN(kanban,'.o_tag',2);assert.containsN(kanban,'.o_kanban_group',2);kanban.update({groupBy:['state']});def.then(async function(){assert.containsN(kanban,'.o_kanban_group',2);await testUtils.nextTick();assert.containsN(kanban,'.o_kanban_group',3);assert.containsN(kanban,'.o_tag',2,'Should display 2 tags after update');assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_tag').text(),'gold','First category should be \'gold\'');assert.strictEqual(kanban.$('.o_kanban_group:eq(2) .o_tag').text(),'silver','Second category should be \'silver\'');kanban.destroy();done();});await testUtils.nextTick();def.resolve();});QUnit.test('can drag and drop a record from one column to the next',async function(assert){assert.expect(9);var resequenceDef=testUtils.makeTestPromise();var envIDs=[1,3,2,4];this.data.partner.fields.sequence={type:'number',string:"Sequence"};var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div class="oe_kanban_global_click"><field name="foo"/>'+'<t t-if="widget.editable"><span class="thisiseditable">edit</span></t>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(route==='/web/dataset/resequence'){assert.ok(true,"should call resequence");return resequenceDef.then(_.constant(true));}
return this._super(route,args);},});assert.containsN(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record',2);assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',2);assert.containsN(kanban,'.thisiseditable',4);assert.deepEqual(kanban.exportState().resIds,envIDs);var $record=kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record:first');var $group=kanban.$('.o_kanban_group:nth-child(2)');envIDs=[3,2,4,1];await testUtils.dom.dragAndDrop($record,$group,{withTrailingClick:true});resequenceDef.resolve();await testUtils.nextTick();assert.containsOnce(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',3);assert.containsN(kanban,'.thisiseditable',4);assert.deepEqual(kanban.exportState().resIds,envIDs);resequenceDef.resolve();kanban.destroy();});QUnit.test('drag and drop a record, grouped by selection',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<templates>'+'<t t-name="kanban-box">'+'<div><field name="state"/></div>'+'</t>'+'</templates>'+'</kanban>',groupBy:['state'],mockRPC:function(route,args){if(route==='/web/dataset/resequence'){assert.ok(true,"should call resequence");return Promise.resolve(true);}
if(args.model==='partner'&&args.method==='write'){assert.deepEqual(args.args[1],{state:'def'});}
return this._super(route,args);},});assert.containsOnce(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsOnce(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record');var $record=kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record:first');var $group=kanban.$('.o_kanban_group:nth-child(2)');await testUtils.dom.dragAndDrop($record,$group);await nextTick();assert.containsNone(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',2);kanban.destroy();});QUnit.test('prevent drag and drop of record if grouped by readonly',async function(assert){assert.expect(12);this.data.partner.fields.foo.readonly=true;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates>'+'<t t-name="kanban-box"><div>'+'<field name="foo"/>'+'<field name="state" readonly="1"/>'+'</div></t>'+'</templates>'+'</kanban>',mockRPC:function(route,args){if(route==='/web/dataset/resequence'){return Promise.resolve();}
if(args.model==='partner'&&args.method==='write'){throw new Error('should not be draggable');}
return this._super(route,args);},});await kanban.update({groupBy:['state']});assert.containsOnce(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsOnce(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record');var $record=kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record:first');var $group=kanban.$('.o_kanban_group:nth-child(2)');await testUtils.dom.dragAndDrop($record,$group);await nextTick();assert.containsOnce(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsOnce(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record');await kanban.update({groupBy:['foo']});assert.containsOnce(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',2);$record=kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record:first');$group=kanban.$('.o_kanban_group:nth-child(2)');await testUtils.dom.dragAndDrop($record,$group);await nextTick();assert.containsOnce(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record');assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',2);var $record1=kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record:eq(0)');var $record2=kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record:eq(1)');assert.strictEqual($record1.text(),"blipDEF","first record should be DEF");assert.strictEqual($record2.text(),"blipGHI","second record should be GHI");await testUtils.dom.dragAndDrop($record2,$record1,{position:'top'});assert.strictEqual(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record:eq(0)').text(),"blipGHI","records should have been resequenced");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record:eq(1)').text(),"blipDEF","records should have been resequenced");kanban.destroy();});QUnit.test('prevent drag and drop if grouped by date/datetime field',async function(assert){assert.expect(5);this.data.partner.records[0].date='2017-01-08';this.data.partner.records[1].date='2017-01-09';this.data.partner.records[2].date='2017-02-08';this.data.partner.records[3].date='2017-02-10';var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['date:month'],});assert.strictEqual(kanban.$('.o_kanban_group').length,2,"should have 2 columns");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record').length,2,"1st column should contain 2 records of January month");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record').length,2,"2nd column should contain 2 records of February month");var $record=kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record:first');var $group=kanban.$('.o_kanban_group:nth-child(2)');await testUtils.dragAndDrop($record,$group);assert.strictEqual(kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record').length,2,"Should remain same records in first column(2 records)");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record').length,2,"Should remain same records in 2nd column(2 record)");kanban.destroy();});QUnit.test('completely prevent drag and drop if records_draggable set to false',async function(assert){assert.expect(6);var envIDs=[1,3,2,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" records_draggable="false">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['product_id'],});assert.containsN(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record',2);assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',2);assert.deepEqual(kanban.exportState().resIds,envIDs);var $record=kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record:first');var $group=kanban.$('.o_kanban_group:nth-child(2)');await testUtils.dom.dragAndDrop($record,$group,{withTrailingClick:true});assert.containsN(kanban,'.o_kanban_group:nth-child(1) .o_kanban_record',2,"First column should still contain 2 records");assert.containsN(kanban,'.o_kanban_group:nth-child(2) .o_kanban_record',2,"Second column should still contain 2 records");assert.deepEqual(kanban.exportState().resIds,envIDs,"Records should not have moved");kanban.destroy();});QUnit.test('prevent drag and drop of record if onchange fails',async function(assert){assert.expect(4);this.data.partner.onchanges={product_id:function(obj){}};var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates>'+'<t t-name="kanban-box"><div>'+'<field name="foo"/>'+'<field name="product_id"/>'+'</div></t>'+'</templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/onchange'){return Promise.reject({});}
return this._super(route,args);},});assert.strictEqual(kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record').length,2,"column should contain 2 records");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record').length,2,"column should contain 2 records");var $record=kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record:first');var $group=kanban.$('.o_kanban_group:nth-child(2)');await testUtils.dom.dragAndDrop($record,$group);assert.strictEqual(kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record').length,2,"column should now contain 2 records");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record').length,2,"column should contain 2 records");kanban.destroy();});QUnit.test('kanban view with default_group_by',async function(assert){assert.expect(7);this.data.partner.records.product_id=1;this.data.product.records.push({id:1,display_name:"third product"});var readGroupCount=0;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" default_group_by="bar">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/web_read_group'){readGroupCount++;var correctGroupBy;if(readGroupCount===2){correctGroupBy=['product_id'];}else{correctGroupBy=['bar'];}
assert.ok(_.isEqual(args.kwargs.groupby,correctGroupBy),"groupby args should be correct");}
return this._super.apply(this,arguments);},});assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_grouped');assert.containsN(kanban,'.o_kanban_group',2,"should have "+2+" columns");await kanban.update({groupBy:['product_id']});assert.containsN(kanban,'.o_kanban_group',2,"should now have "+3+" columns");await kanban.update({groupBy:[]});assert.containsN(kanban,'.o_kanban_group',2,"should have "+2+" columns again");kanban.destroy();});QUnit.test('kanban view not groupable',async function(assert){assert.expect(3);const searchMenuTypesOriginal=KanbanView.prototype.searchMenuTypes;KanbanView.prototype.searchMenuTypes=['filter','favorite'];const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban class="o_kanban_test" default_group_by="bar">
                    <field name="bar"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="foo"/></div>
                        </t>
                    </templates>
                </kanban>
            `,archs:{'partner,false,search':`
                    <search>
                        <filter string="candle" name="itsName" context="{'group_by': 'foo'}"/>
                    </search>
                `,},mockRPC:function(route,args){if(args.method==='read_group'){throw new Error("Should not do a read_group RPC");}
return this._super.apply(this,arguments);},context:{search_default_itsName:1,},});assert.doesNotHaveClass(kanban.$('.o_kanban_view'),'o_kanban_grouped');assert.containsNone(kanban,'.o_control_panel div.o_search_options div.o_group_by_menu');assert.deepEqual(cpHelpers.getFacetTexts(kanban),[]);kanban.destroy();KanbanView.prototype.searchMenuTypes=searchMenuTypesOriginal;});QUnit.test('kanban view with create=False',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" create="0">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',});assert.ok(!kanban.$buttons||!kanban.$buttons.find('.o-kanban-button-new').length,"Create button shouldn't be there");kanban.destroy();});QUnit.test('clicking on a link triggers correct event',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div><a type="edit">Edit</a></div>'+'</t></templates></kanban>',});testUtils.mock.intercept(kanban,'switch_view',function(event){assert.deepEqual(event.data,{view_type:'form',res_id:1,mode:'edit',model:'partner',});});await testUtils.dom.click(kanban.$('a').first());kanban.destroy();});QUnit.test('environment is updated when (un)folding groups',async function(assert){assert.expect(3);var envIDs=[1,3,2,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.deepEqual(kanban.exportState().resIds,envIDs);envIDs=[1,3];await testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_kanban_toggle_fold'));assert.deepEqual(kanban.exportState().resIds,envIDs);envIDs=[1,3,2,4];await testUtils.dom.click(kanban.$('.o_kanban_group:last'));assert.deepEqual(kanban.exportState().resIds,envIDs);kanban.destroy();});QUnit.test('create a column in grouped on m2o',async function(assert){assert.expect(14);var nbRPCs=0;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){nbRPCs++;if(args.method==='name_create'){assert.ok(true,"should call name_create");}
if(route==='/web/dataset/resequence'){assert.ok(true,"should call resequence");return Promise.resolve(true);}
return this._super(route,args);},});assert.containsOnce(kanban,'.o_column_quick_create',"should have a quick create column");assert.notOk(kanban.$('.o_column_quick_create input').is(':visible'),"the input should not be visible");await testUtils.dom.click(kanban.$('.o_quick_create_folded'));assert.ok(kanban.$('.o_column_quick_create input').is(':visible'),"the input should be visible");await kanban.$('.o_column_quick_create input').trigger($.Event('keydown',{keyCode:$.ui.keyCode.ESCAPE,which:$.ui.keyCode.ESCAPE,}));assert.notOk(kanban.$('.o_column_quick_create input').is(':visible'),"the input should not be visible after discard");await testUtils.dom.click(kanban.$('.o_quick_create_folded'));assert.ok(kanban.$('.o_column_quick_create input').is(':visible'),"the input should be visible");await kanban.$('.o_column_quick_create input').val('new value').trigger('input');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));assert.strictEqual(kanban.$('.o_kanban_group:last span:contains(new value)').length,1,"the last column should be the newly created one");assert.ok(_.isNumber(kanban.$('.o_kanban_group:last').data('id')),'the created column should have the correct id');assert.doesNotHaveClass(kanban.$('.o_kanban_group:last'),'o_column_folded','the created column should not be folded');nbRPCs=0;await testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_kanban_toggle_fold'));assert.hasClass(kanban.$('.o_kanban_group:last'),'o_column_folded','the created column should now be folded');await testUtils.dom.click(kanban.$('.o_kanban_group:last'));assert.doesNotHaveClass(kanban.$('.o_kanban_group:last'),'o_column_folded');assert.strictEqual(nbRPCs,0,'no rpc should have been done when folding/unfolding');await testUtils.kanban.clickCreate(kanban);assert.hasClass(kanban.$('.o_kanban_group:first() > div:nth(1)'),'o_kanban_quick_create',"clicking on create should open the quick_create in the first column");kanban.destroy();});QUnit.test('auto fold group when reach the limit',async function(assert){assert.expect(9);var data=this.data;for(var i=0;i<12;i++){data.product.records.push({id:(8+i),name:("column"),});data.partner.records.push({id:(20+i),foo:("dumb entry"),product_id:(8+i),});}
var kanban=await createView({View:KanbanView,model:'partner',data:data,arch:'<kanban class="o_kanban_test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='web_read_group'){return this._super.apply(this,arguments).then(function(result){result.groups[2].__fold=true;result.groups[8].__fold=true;return result;});}
return this._super(route,args);},});assert.doesNotHaveClass(kanban.$('.o_kanban_group:nth-child(2)'),'o_column_folded');assert.doesNotHaveClass(kanban.$('.o_kanban_group:nth-child(4)'),'o_column_folded');assert.doesNotHaveClass(kanban.$('.o_kanban_group:nth-child(10)'),'o_column_folded');assert.hasClass(kanban.$('.o_kanban_group:nth-child(3)'),'o_column_folded');assert.hasClass(kanban.$('.o_kanban_group:nth-child(9)'),'o_column_folded');assert.hasClass(kanban.$('.o_kanban_group:nth-child(13)'),'o_column_folded');assert.hasClass(kanban.$('.o_kanban_group:nth-child(14)'),'o_column_folded');assert.containsN(kanban,'.o_kanban_group:not(.o_column_folded)',10);assert.containsN(kanban,'.o_kanban_group.o_column_folded',4);kanban.destroy();});QUnit.test('hide and display help message (ESC) in kanban quick create',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});await testUtils.dom.click(kanban.$('.o_quick_create_folded'));assert.ok(kanban.$('.o_discard_msg').is(':visible'),'the ESC to discard message is visible');await testUtils.dom.clickFirst(kanban.$('.o_kanban_header'));assert.notOk(kanban.$('.o_discard_msg').is(':visible'),'the ESC to discard message is no longer visible');kanban.destroy();});QUnit.test('delete a column in grouped on m2o',async function(assert){assert.expect(37);testUtils.mock.patch(KanbanRenderer,{_renderGrouped:function(){this._super.apply(this,arguments);if(this.$el.sortable('instance')){this.$el.sortable('option',{delay:0,revert:0});}},});var resequencedIDs;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(route==='/web/dataset/resequence'){resequencedIDs=args.ids;assert.strictEqual(_.reject(args.ids,_.isNumber).length,0,"column resequenced should be existing records with IDs");return Promise.resolve(true);}
if(args.method){assert.step(args.method);}
return this._super(route,args);},});assert.containsN(kanban,'.o_kanban_group',2,"should have two columns");assert.strictEqual(kanban.$('.o_kanban_group:first').data('id'),3,'first column should be [3, "hello"]');assert.strictEqual(kanban.$('.o_kanban_group:last').data('id'),5,'second column should be [5, "xmo"]');assert.strictEqual(kanban.$('.o_kanban_group:last .o_column_title').text(),'xmo','second column should have correct title');assert.containsN(kanban,'.o_kanban_group:last .o_kanban_record',2,"second column should have two records");assert.ok(kanban.$('.o_kanban_group:first .o_kanban_toggle_fold').length,"should be able to fold the column");assert.ok(kanban.$('.o_kanban_group:first .o_column_edit').length,"should be able to edit the column");assert.ok(kanban.$('.o_kanban_group:first .o_column_delete').length,"should be able to delete the column");assert.ok(!kanban.$('.o_kanban_group:first .o_column_archive_records').length,"should not be able to archive all the records");assert.ok(!kanban.$('.o_kanban_group:first .o_column_unarchive_records').length,"should not be able to restore all the records");testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_column_delete'));assert.ok($('.modal').length,'a confirm modal should be displayed');await testUtils.modal.clickButton('Cancel');assert.strictEqual(kanban.$('.o_kanban_group:last').data('id'),5,'column [5, "xmo"] should still be there');testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_column_delete'));assert.ok($('.modal').length,'a confirm modal should be displayed');await testUtils.modal.clickButton('Ok');assert.strictEqual(kanban.$('.o_kanban_group:last').data('id'),3,'last column should now be [3, "hello"]');assert.containsN(kanban,'.o_kanban_group',2,"should still have two columns");assert.ok(!_.isNumber(kanban.$('.o_kanban_group:first').data('id')),'first column should have no id (Undefined column)');assert.ok(kanban.$('.o_kanban_group:first .o_kanban_toggle_fold').length,"should be able to fold the column");assert.ok(!kanban.$('.o_kanban_group:first .o_column_delete').length,'Undefined column could not be deleted');assert.ok(!kanban.$('.o_kanban_group:first .o_column_edit').length,'Undefined column could not be edited');assert.ok(!kanban.$('.o_kanban_group:first .o_column_archive_records').length,"Records of undefined column could not be archived");assert.ok(!kanban.$('.o_kanban_group:first .o_column_unarchive_records').length,"Records of undefined column could not be restored");assert.verifySteps(['web_read_group','unlink','web_read_group']);assert.strictEqual(kanban.renderer.widgets.length,2,"the old widgets should have been correctly deleted");await testUtils.dom.dragAndDrop(kanban.$('.o_column_title:first'),kanban.$('.o_column_title:last'),{position:'right'});assert.strictEqual(resequencedIDs,undefined,"resequencing require at least 2 not Undefined columns");await testUtils.dom.click(kanban.$('.o_column_quick_create .o_quick_create_folded'));kanban.$('.o_column_quick_create input').val('once third column');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));var newColumnID=kanban.$('.o_kanban_group:last').data('id');await testUtils.dom.dragAndDrop(kanban.$('.o_column_title:first'),kanban.$('.o_column_title:last'),{position:'right'});assert.deepEqual([3,newColumnID],resequencedIDs,"moving the Undefined column should not affect order of other columns");await testUtils.dom.dragAndDrop(kanban.$('.o_column_title:first'),kanban.$('.o_column_title:nth(1)'),{position:'right'});await nextTick();assert.deepEqual([newColumnID,3],resequencedIDs,"moved column should be resequenced accordingly");assert.verifySteps(['name_create','read','read','read']);kanban.destroy();testUtils.mock.unpatch(KanbanRenderer);});QUnit.test('create a column, delete it and create another one',async function(assert){assert.expect(5);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.containsN(kanban,'.o_kanban_group',2,"should have two columns");await testUtils.dom.click(kanban.$('.o_column_quick_create .o_quick_create_folded'));kanban.$('.o_column_quick_create input').val('new column 1');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group',3,"should have two columns");testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:last'));await testUtils.dom.click(kanban.$('.o_kanban_group:last .o_column_delete'));await testUtils.modal.clickButton('Ok');assert.containsN(kanban,'.o_kanban_group',2,"should have twos columns");await testUtils.dom.click(kanban.$('.o_column_quick_create .o_quick_create_folded'));kanban.$('.o_column_quick_create input').val('new column 2');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));assert.containsN(kanban,'.o_kanban_group',3,"should have three columns");assert.strictEqual(kanban.$('.o_kanban_group:last span:contains(new column 2)').length,1,"the last column should be the newly created one");kanban.destroy();});QUnit.test('edit a column in grouped on m2o',async function(assert){assert.expect(12);var nbRPCs=0;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],archs:{'product,false,form':'<form string="Product"><field name="display_name"/></form>',},mockRPC:function(route,args){nbRPCs++;return this._super(route,args);},});assert.strictEqual(kanban.$('.o_kanban_group[data-id=5] .o_column_title').text(),'xmo','title of the column should be "xmo"');testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group[data-id=5]'));await testUtils.dom.click(kanban.$('.o_kanban_group[data-id=5] .o_column_edit'));assert.containsOnce(document.body,'.modal .o_form_editable',"a form view should be open in a modal");assert.strictEqual($('.modal .o_form_editable input').val(),'xmo','the name should be "xmo"');await testUtils.fields.editInput($('.modal .o_form_editable input'),'ged');nbRPCs=0;await testUtils.dom.click($('.modal-header .close'));assert.containsNone(document.body,'.modal');assert.strictEqual(kanban.$('.o_kanban_group[data-id=5] .o_column_title').text(),'xmo','title of the column should still be "xmo"');assert.strictEqual(nbRPCs,0,'no RPC should have been done');testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group[data-id=5]'));await testUtils.dom.click(kanban.$('.o_kanban_group[data-id=5] .o_column_edit'));await testUtils.fields.editInput($('.modal .o_form_editable input'),'ged');nbRPCs=0;await testUtils.modal.clickButton('Discard');assert.containsNone(document.body,'.modal');assert.strictEqual(kanban.$('.o_kanban_group[data-id=5] .o_column_title').text(),'xmo','title of the column should still be "xmo"');assert.strictEqual(nbRPCs,0,'no RPC should have been done');testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group[data-id=5]'));await testUtils.dom.click(kanban.$('.o_kanban_group[data-id=5] .o_column_edit'));await testUtils.fields.editInput($('.modal .o_form_editable input'),'ged');nbRPCs=0;await testUtils.modal.clickButton('Save');assert.ok(!$('.modal').length,'the modal should be closed');assert.strictEqual(kanban.$('.o_kanban_group[data-id=5] .o_column_title').text(),'ged','title of the column should be "ged"');assert.strictEqual(nbRPCs,4,'should have done 1 write, 1 read_group and 2 search_read');kanban.destroy();});QUnit.test('edit a column propagates right context',async function(assert){assert.expect(4);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],archs:{'product,false,form':'<form string="Product"><field name="display_name"/></form>',},session:{user_context:{lang:'brol'}},mockRPC:function(route,args){let context;if(route==='/web/dataset/search_read'&&args.model==='partner'){context=args.context;assert.strictEqual(context.lang,'brol','lang is present in context for partner operations');}
if(args.model==='product'){context=args.kwargs.context;assert.strictEqual(context.lang,'brol','lang is present in context for product operations');}
return this._super.apply(this,arguments);},});testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group[data-id=5]'));await testUtils.dom.click(kanban.$('.o_kanban_group[data-id=5] .o_column_edit'));kanban.destroy();});QUnit.test('quick create column should be opened if there is no column',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],domain:[['foo','=','norecord']],});assert.containsNone(kanban,'.o_kanban_group');assert.containsOnce(kanban,'.o_column_quick_create');assert.ok(kanban.$('.o_column_quick_create input').is(':visible'),"the quick create should be opened");kanban.destroy();});QUnit.test('quick create several columns in a row',async function(assert){assert.expect(10);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.containsN(kanban,'.o_kanban_group',2,"should have two columns");assert.containsOnce(kanban,'.o_column_quick_create',"should have a ColumnQuickCreate widget");assert.containsOnce(kanban,'.o_column_quick_create .o_quick_create_folded:visible',"the ColumnQuickCreate should be folded");assert.containsNone(kanban,'.o_column_quick_create .o_quick_create_unfolded:visible',"the ColumnQuickCreate should be folded");await testUtils.dom.click(kanban.$('.o_column_quick_create .o_quick_create_folded'));assert.containsNone(kanban,'.o_column_quick_create .o_quick_create_folded:visible',"the ColumnQuickCreate should be unfolded");assert.containsOnce(kanban,'.o_column_quick_create .o_quick_create_unfolded:visible',"the ColumnQuickCreate should be unfolded");kanban.$('.o_column_quick_create input').val('New Column 1');await testUtils.dom.click(kanban.$('.o_column_quick_create .btn-primary'));assert.containsN(kanban,'.o_kanban_group',3,"should now have three columns");assert.containsNone(kanban,'.o_column_quick_create .o_quick_create_folded:visible',"the ColumnQuickCreate should still be unfolded");assert.containsOnce(kanban,'.o_column_quick_create .o_quick_create_unfolded:visible',"the ColumnQuickCreate should still be unfolded");kanban.$('.o_column_quick_create input').val('New Column 2');await testUtils.dom.click(kanban.$('.o_column_quick_create .btn-primary'));assert.containsN(kanban,'.o_kanban_group',4,"should now have four columns");kanban.destroy();});QUnit.test('quick create column and examples',async function(assert){assert.expect(12);kanbanExamplesRegistry.add('test',{examples:[{name:"A first example",columns:["Column 1","Column 2","Column 3"],description:"Some description",},{name:"A second example",columns:["Col 1","Col 2"],}],});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban examples="test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.containsOnce(kanban,'.o_column_quick_create',"should have a ColumnQuickCreate widget");await testUtils.dom.click(kanban.$('.o_column_quick_create .o_quick_create_folded'));assert.containsOnce(kanban,'.o_column_quick_create .o_kanban_examples:visible',"should have a link to see examples");await testUtils.dom.click(kanban.$('.o_column_quick_create .o_kanban_examples'));assert.strictEqual($('.modal .o_kanban_examples_dialog').length,1,"should have open the examples dialog");assert.strictEqual($('.modal .o_kanban_examples_dialog_nav li').length,2,"should have two examples (in the menu)");assert.strictEqual($('.modal .o_kanban_examples_dialog_nav a').text(),' A first example  A second example ',"example names should be correct");assert.strictEqual($('.modal .o_kanban_examples_dialog_content .tab-pane').length,2,"should have two examples");var $firstPane=$('.modal .o_kanban_examples_dialog_content .tab-pane:first');assert.strictEqual($firstPane.find('.o_kanban_examples_group').length,3,"there should be 3 stages in the first example");assert.strictEqual($firstPane.find('h6').text(),'Column 1Column 2Column 3',"column titles should be correct");assert.strictEqual($firstPane.find('.o_kanban_examples_description').text().trim(),"Some description","the correct description should be displayed");var $secondPane=$('.modal .o_kanban_examples_dialog_content .tab-pane:nth(1)');assert.strictEqual($secondPane.find('.o_kanban_examples_group').length,2,"there should be 2 stages in the second example");assert.strictEqual($secondPane.find('h6').text(),'Col 1Col 2',"column titles should be correct");assert.strictEqual($secondPane.find('.o_kanban_examples_description').text().trim(),"","there should be no description for the second example");kanban.destroy();});QUnit.test('quick create column and examples background with ghostColumns titles',async function(assert){assert.expect(4);this.data.partner.records=[];kanbanExamplesRegistry.add('test',{ghostColumns:["Ghost 1","Ghost 2","Ghost 3","Ghost 4"],examples:[{name:"A first example",columns:["Column 1","Column 2","Column 3"],description:"Some description",},{name:"A second example",columns:["Col 1","Col 2"],}],});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban examples="test">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.containsOnce(kanban,'.o_kanban_example_background',"should have ExamplesBackground when no data");assert.strictEqual(kanban.$('.o_kanban_examples_group h6').text(),'Ghost 1Ghost 2Ghost 3Ghost 4',"ghost title should be correct");assert.containsOnce(kanban,'.o_column_quick_create',"should have a ColumnQuickCreate widget");assert.containsOnce(kanban,'.o_column_quick_create .o_kanban_examples:visible',"should not have a link to see examples as there is no examples registered");kanban.destroy();});QUnit.test('quick create column and examples background without ghostColumns titles',async function(assert){assert.expect(4);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.containsOnce(kanban,'.o_kanban_example_background',"should have ExamplesBackground when no data");assert.strictEqual(kanban.$('.o_kanban_examples_group h6').text(),'Column 1Column 2Column 3Column 4',"ghost title should be correct");assert.containsOnce(kanban,'.o_column_quick_create',"should have a ColumnQuickCreate widget");assert.containsNone(kanban,'.o_column_quick_create .o_kanban_examples:visible',"should not have a link to see examples as there is no examples registered");kanban.destroy();});QUnit.test('nocontent helper after adding a record (kanban with progressbar)',async function(assert){assert.expect(3);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`<kanban >
                    <field name="product_id"/>
                    <progressbar field="foo" colors='{"yop": "success", "gnap": "warning", "blip": "danger"}' sum_field="int_field"/>
                    <templates>
                      <t t-name="kanban-box">
                        <div><field name="foo"/></div>
                      </t>
                    </templates>
                </kanban>`,groupBy:['product_id'],domain:[['foo','=','abcd']],mockRPC:function(route,args){if(args.method==='web_read_group'){const result={groups:[{__domain:[['product_id','=',3]],product_id_count:0,product_id:[3,'hello']},],};return Promise.resolve(result);}
return this._super.apply(this,arguments);},viewOptions:{action:{help:"No content helper",},},});assert.containsOnce(kanban,'.o_view_nocontent',"the nocontent helper is displayed");await testUtils.dom.click(kanban.$('.o_kanban_quick_add'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create .o_input'),'twilight sparkle');await testUtils.dom.click(kanban.$('button.o_kanban_add'));assert.containsNone(kanban,'.o_view_nocontent',"the nocontent helper is not displayed after quick create");await testUtils.dom.click(kanban.$('button.o_kanban_cancel'));assert.containsNone(kanban,'.o_view_nocontent',"the nocontent helper is not displayed after cancelling the quick create");kanban.destroy();});QUnit.test('if view was not grouped at start, it can be grouped and ungrouped',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" on_create="quick_create">'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',});assert.doesNotHaveClass(kanban.$('.o_kanban_view'),'o_kanban_grouped');await kanban.update({groupBy:['product_id']});assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_grouped');await kanban.update({groupBy:[]});assert.doesNotHaveClass(kanban.$('.o_kanban_view'),'o_kanban_grouped');kanban.destroy();});QUnit.test('no content helper when archive all records in kanban group',async function(assert){assert.expect(3);this.data.partner.fields.active={string:'Active',type:'boolean',default:true};this.data.partner.records=this.data.partner.records.slice(0,3);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`<kanban class="o_kanban_test">
                        <field name="active"/>
                        <field name="bar"/>
                        <templates>
                            <t t-name="kanban-box">
                               <div><field name="foo"/></div>
                            </t>
                        </templates>
                    </kanban>`,viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'}},groupBy:['bar'],mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/action_archive'){const partnerIDS=args.args[0];const records=this.data.partner.records;_.each(partnerIDS,function(partnerID){_.find(records,function(record){return record.id===partnerID;}).active=false;});return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_kanban_group:last .o_kanban_record',3);testUtils.kanban.toggleGroupSettings($(kanban.el.querySelector('.o_kanban_group')));await testUtils.dom.click(kanban.el.querySelector('.o_kanban_group .o_column_archive_records'));assert.containsOnce(document.body,'.modal');await testUtils.modal.clickButton('Ok');assert.containsOnce(kanban,'.o_view_nocontent');kanban.destroy();});QUnit.test('no content helper when no data',async function(assert){assert.expect(3);var records=this.data.partner.records;this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div>'+'<t t-esc="record.foo.value"/>'+'<field name="foo"/>'+'</div>'+'</t></templates></kanban>',viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'}},});assert.containsOnce(kanban,'.o_view_nocontent',"should display the no content helper");assert.strictEqual(kanban.$('.o_view_nocontent p.hello:contains(add a partner)').length,1,"should have rendered no content helper from action");this.data.partner.records=records;await kanban.reload();assert.containsNone(kanban,'.o_view_nocontent',"should not display the no content helper");kanban.destroy();});QUnit.test('no nocontent helper for grouped kanban with empty groups',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='web_read_group'){return this._super.apply(this,arguments).then(function(result){_.each(result.groups,function(group){group[args.kwargs.groupby[0]+'_count']=0;});return result;});}
return this._super.apply(this,arguments);},viewOptions:{action:{help:"No content helper",},},});assert.containsN(kanban,'.o_kanban_group',2,"there should be two columns");assert.containsNone(kanban,'.o_kanban_record',"there should be no records");kanban.destroy();});QUnit.test('no nocontent helper for grouped kanban with no records',async function(assert){assert.expect(4);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],viewOptions:{action:{help:"No content helper",},},});assert.containsNone(kanban,'.o_kanban_group',"there should be no columns");assert.containsNone(kanban,'.o_kanban_record',"there should be no records");assert.containsNone(kanban,'.o_view_nocontent',"there should be no nocontent helper (we are in 'column creation mode')");assert.containsOnce(kanban,'.o_column_quick_create',"there should be a column quick create");kanban.destroy();});QUnit.test('no nocontent helper is shown when no longer creating column',async function(assert){assert.expect(3);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],viewOptions:{action:{help:"No content helper",},},});assert.containsNone(kanban,'.o_view_nocontent',"there should be no nocontent helper (we are in 'column creation mode')");kanban.$('.o_column_quick_create .o_input').val('applejack');await testUtils.dom.click(kanban.$('.o_column_quick_create .o_kanban_add'));assert.containsNone(kanban,'.o_view_nocontent',"there should be no nocontent helper (still in 'column creation mode')");kanban.$('.o_column_quick_create .o_input').trigger($.Event('keydown',{keyCode:$.ui.keyCode.ESCAPE,which:$.ui.keyCode.ESCAPE,}));assert.containsOnce(kanban,'.o_view_nocontent',"there should be a nocontent helper");kanban.destroy();});QUnit.test('no nocontent helper is hidden when quick creating a column',async function(assert){assert.expect(2);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='web_read_group'){var result={groups:[{__domain:[['product_id','=',3]],product_id_count:0,product_id:[3,'hello']},],length:1,};return Promise.resolve(result);}
return this._super.apply(this,arguments);},viewOptions:{action:{help:"No content helper",},},});assert.containsOnce(kanban,'.o_view_nocontent',"there should be a nocontent helper");await testUtils.dom.click(kanban.$('.o_kanban_add_column'));assert.containsNone(kanban,'.o_view_nocontent',"there should be no nocontent helper (we are in 'column creation mode')");kanban.destroy();});QUnit.test('remove nocontent helper after adding a record',async function(assert){assert.expect(2);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="name"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='web_read_group'){var result={groups:[{__domain:[['product_id','=',3]],product_id_count:0,product_id:[3,'hello']},],length:1,};return Promise.resolve(result);}
return this._super.apply(this,arguments);},viewOptions:{action:{help:"No content helper",},},});assert.containsOnce(kanban,'.o_view_nocontent',"there should be a nocontent helper");await testUtils.dom.click(kanban.$('.o_kanban_quick_add'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create .o_input'),'twilight sparkle');await testUtils.dom.click(kanban.$('.o_kanban_quick_create button.o_kanban_add'));assert.containsNone(kanban,'.o_view_nocontent',"there should be no nocontent helper (there is now one record)");kanban.destroy();});QUnit.test('remove nocontent helper when adding a record',async function(assert){assert.expect(2);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="name"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='web_read_group'){var result={groups:[{__domain:[['product_id','=',3]],product_id_count:0,product_id:[3,'hello']},],length:1,};return Promise.resolve(result);}
return this._super.apply(this,arguments);},viewOptions:{action:{help:"No content helper",},},});assert.containsOnce(kanban,'.o_view_nocontent',"there should be a nocontent helper");await testUtils.dom.click(kanban.$('.o_kanban_quick_add'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create .o_input'),'twilight sparkle');assert.containsNone(kanban,'.o_view_nocontent',"there should be no nocontent helper (there is now one record)");kanban.destroy();});QUnit.test('nocontent helper is displayed again after canceling quick create',async function(assert){assert.expect(1);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="name"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(args.method==='web_read_group'){var result={groups:[{__domain:[['product_id','=',3]],product_id_count:0,product_id:[3,'hello']},],length:1,};return Promise.resolve(result);}
return this._super.apply(this,arguments);},viewOptions:{action:{help:"No content helper",},},});await testUtils.dom.click(kanban.$('.o_kanban_quick_add'));await testUtils.dom.click(kanban.$('.o_kanban_view'));assert.containsOnce(kanban,'.o_view_nocontent',"there should be again a nocontent helper");kanban.destroy();});QUnit.test('nocontent helper for grouped kanban with no records with no group_create',async function(assert){assert.expect(4);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban group_create="false">'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],viewOptions:{action:{help:"No content helper",},},});assert.containsNone(kanban,'.o_kanban_group',"there should be no columns");assert.containsNone(kanban,'.o_kanban_record',"there should be no records");assert.containsNone(kanban,'.o_view_nocontent',"there should not be a nocontent helper");assert.containsNone(kanban,'.o_column_quick_create',"there should not be a column quick create");kanban.destroy();});QUnit.test('empty grouped kanban with sample data and no columns',async function(assert){assert.expect(3);this.data.partner.records=[];const kanban=await createView({arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:['product_id'],model:'partner',View:KanbanView,viewOptions:{action:{help:"No content helper",},},});assert.containsNone(kanban,'.o_view_nocontent');assert.containsOnce(kanban,'.o_quick_create_unfolded');assert.containsOnce(kanban,'.o_kanban_example_background_container');kanban.destroy();});QUnit.test('empty grouped kanban with sample data and click quick create',async function(assert){assert.expect(11);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="foo"/></div>
                        </t>
                    </templates>
                </kanban>`,groupBy:['product_id'],async mockRPC(route,{kwargs,method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups.forEach(group=>{group[`${kwargs.groupby[0]}_count`]=0;});}
return result;},viewOptions:{action:{help:"No content helper",},},});assert.containsN(kanban,'.o_kanban_group',2,"there should be two columns");assert.hasClass(kanban.$el,'o_view_sample_data');assert.containsOnce(kanban,'.o_view_nocontent');assert.containsN(kanban,'.o_kanban_record',16,"there should be 8 sample records by column");await testUtils.dom.click(kanban.$('.o_kanban_quick_add:first'));assert.doesNotHaveClass(kanban.$el,'o_view_sample_data');assert.containsNone(kanban,'.o_kanban_record');assert.containsNone(kanban,'.o_view_nocontent');assert.containsOnce(kanban.$('.o_kanban_group:first'),'.o_kanban_quick_create');await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create .o_input'),'twilight sparkle');await testUtils.dom.click(kanban.$('.o_kanban_quick_create button.o_kanban_add'));assert.doesNotHaveClass(kanban.$el,'o_view_sample_data');assert.containsOnce(kanban.$('.o_kanban_group:first'),'.o_kanban_record');assert.containsNone(kanban,'.o_view_nocontent');kanban.destroy();});QUnit.test('empty grouped kanban with sample data and cancel quick create',async function(assert){assert.expect(12);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="foo"/></div>
                        </t>
                    </templates>
                </kanban>`,groupBy:['product_id'],async mockRPC(route,{kwargs,method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups.forEach(group=>{group[`${kwargs.groupby[0]}_count`]=0;});}
return result;},viewOptions:{action:{help:"No content helper",},},});assert.containsN(kanban,'.o_kanban_group',2,"there should be two columns");assert.hasClass(kanban.$el,'o_view_sample_data');assert.containsOnce(kanban,'.o_view_nocontent');assert.containsN(kanban,'.o_kanban_record',16,"there should be 8 sample records by column");await testUtils.dom.click(kanban.$('.o_kanban_quick_add:first'));assert.doesNotHaveClass(kanban.$el,'o_view_sample_data');assert.containsNone(kanban,'.o_kanban_record');assert.containsNone(kanban,'.o_view_nocontent');assert.containsOnce(kanban.$('.o_kanban_group:first'),'.o_kanban_quick_create');await testUtils.dom.click(kanban.$('.o_kanban_view'));assert.doesNotHaveClass(kanban.$el,'o_view_sample_data');assert.containsNone(kanban,'.o_kanban_quick_create');assert.containsNone(kanban,'.o_kanban_record');assert.containsOnce(kanban,'.o_view_nocontent');kanban.destroy();});QUnit.test('empty grouped kanban with sample data: keyboard navigation',async function(assert){assert.expect(5);const kanban=await createView({arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                            <field name="state" widget="priority"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:['product_id'],model:'partner',View:KanbanView,async mockRPC(route,{kwargs,method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups.forEach(g=>g.product_id_count=0);}
return result;},});assert.hasClass(kanban.el.querySelector('.o_kanban_record'),'o_sample_data_disabled');assert.hasClass(kanban.el.querySelector('.o_kanban_toggle_fold'),'o_sample_data_disabled');assert.containsNone(kanban.renderer,'[tabindex]:not([tabindex="-1"])');assert.hasClass(document.activeElement,'o_searchview_input');await testUtils.fields.triggerKeydown(document.activeElement,'down');assert.hasClass(document.activeElement,'o_searchview_input');kanban.destroy();});QUnit.test('empty kanban with sample data',async function(assert){assert.expect(6);this.data.partner.records=[];const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="foo"/></div>
                        </t>
                    </templates>
                </kanban>`,viewOptions:{action:{help:"No content helper",},},});assert.hasClass(kanban.$el,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',10,"there should be 10 sample records");assert.containsOnce(kanban,'.o_view_nocontent');await kanban.reload({domain:[['id','<',0]]});assert.doesNotHaveClass(kanban.$el,'o_view_sample_data');assert.containsNone(kanban,'.o_kanban_record:not(.o_kanban_ghost)');assert.containsOnce(kanban,'.o_view_nocontent');kanban.destroy();});QUnit.test('empty grouped kanban with sample data and many2many_tags',async function(assert){assert.expect(6);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="int_field"/>
                                <field name="category_ids" widget="many2many_tags"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,groupBy:['product_id'],async mockRPC(route,{kwargs,method}){assert.step(method||route);const result=await this._super(...arguments);if(method==='web_read_group'){result.groups.forEach(group=>{group[`${kwargs.groupby[0]}_count`]=0;});}
return result;},});assert.containsN(kanban,'.o_kanban_group',2,"there should be 2 'real' columns");assert.hasClass(kanban.$el,'o_view_sample_data');assert.ok(kanban.$('.o_kanban_record').length>=1,"there should be sample records");assert.ok(kanban.$('.o_field_many2manytags .o_tag').length>=1,"there should be tags");assert.verifySteps(["web_read_group"],"should not read the tags");kanban.destroy();});QUnit.test('sample data does not change after reload with sample data',async function(assert){assert.expect(4);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="int_field"/></div>
                        </t>
                    </templates>
                </kanban>`,groupBy:['product_id'],async mockRPC(route,{kwargs,method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups.forEach(group=>{group[`${kwargs.groupby[0]}_count`]=0;});}
return result;},});const columns=kanban.el.querySelectorAll('.o_kanban_group');assert.ok(columns.length>=1,"there should be at least 1 sample column");assert.hasClass(kanban.$el,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_record',16);const kanbanText=kanban.el.innerText;await kanban.reload();assert.strictEqual(kanbanText,kanban.el.innerText,"the content should be the same after reloading the view");kanban.destroy();});QUnit.test('non empty kanban with sample data',async function(assert){assert.expect(5);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="foo"/></div>
                        </t>
                    </templates>
                </kanban>`,viewOptions:{action:{help:"No content helper",},},});assert.doesNotHaveClass(kanban.$el,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);assert.containsNone(kanban,'.o_view_nocontent');await kanban.reload({domain:[['id','<',0]]});assert.doesNotHaveClass(kanban.$el,'o_view_sample_data');assert.containsNone(kanban,'.o_kanban_record:not(.o_kanban_ghost)');kanban.destroy();});QUnit.test('empty grouped kanban with sample data: add a column',async function(assert){assert.expect(6);const kanban=await createView({arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:['product_id'],model:'partner',View:KanbanView,async mockRPC(route,{method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups=this.data.product.records.map(r=>{return{product_id:[r.id,r.display_name],product_id_count:0,__domain:['product_id','=',r.id],};});result.length=result.groups.length;}
return result;},});assert.hasClass(kanban,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_group',2);assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');await testUtils.dom.click(kanban.el.querySelector('.o_kanban_add_column'));await testUtils.fields.editInput(kanban.el.querySelector('.o_kanban_header input'),"Yoohoo");await testUtils.dom.click(kanban.el.querySelector('.btn.o_kanban_add'));assert.hasClass(kanban,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_group',3);assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');kanban.destroy();});QUnit.test('empty grouped kanban with sample data: cannot fold a column',async function(assert){assert.expect(5);const kanban=await createView({arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:['product_id'],model:'partner',View:KanbanView,async mockRPC(route,{kwargs,method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups=result.groups.slice(0,1);result.groups[0][`${kwargs.groupby[0]}_count`]=0;result.length=1;}
return result;},});assert.hasClass(kanban,'o_view_sample_data');assert.containsOnce(kanban,'.o_kanban_group');assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');await testUtils.dom.click(kanban.el.querySelector('.o_kanban_config > a'));assert.hasClass(kanban.el.querySelector('.o_kanban_config .o_kanban_toggle_fold'),'o_sample_data_disabled');assert.hasClass(kanban.el.querySelector('.o_kanban_config .o_kanban_toggle_fold'),'disabled');kanban.destroy();});QUnit.skip('empty grouped kanban with sample data: fold/unfold a column',async function(assert){assert.expect(8);const kanban=await createView({arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:['product_id'],model:'partner',View:KanbanView,async mockRPC(route,{kwargs,method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups=result.groups.slice(0,1);result.groups[0][`${kwargs.groupby[0]}_count`]=0;result.length=1;}
return result;},});assert.hasClass(kanban,'o_view_sample_data');assert.containsOnce(kanban,'.o_kanban_group');assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');await testUtils.dom.click(kanban.el.querySelector('.o_kanban_config > a'));await testUtils.dom.click(kanban.el.querySelector('.dropdown-item.o_kanban_toggle_fold'));assert.containsOnce(kanban,'.o_kanban_group');assert.hasClass(kanban.$('.o_kanban_group'),'o_column_folded');await testUtils.dom.click(kanban.el.querySelector('.o_kanban_group.o_column_folded'));assert.containsOnce(kanban,'.o_kanban_group');assert.doesNotHaveClass(kanban.$('.o_kanban_group'),'o_column_folded');assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');kanban.destroy();});QUnit.test('empty grouped kanban with sample data: delete a column',async function(assert){assert.expect(5);this.data.partner.records=[];let groups=[{product_id:[1,'New'],product_id_count:0,__domain:[],}];const kanban=await createView({arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:['product_id'],model:'partner',View:KanbanView,async mockRPC(route,{method}){let result=await this._super(...arguments);if(method==='web_read_group'){return{groups,length:groups.length,};}
return result;},});assert.hasClass(kanban,'o_view_sample_data');assert.containsOnce(kanban,'.o_kanban_group');assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');groups=[];await testUtils.dom.click(kanban.el.querySelector('.o_kanban_config > a'));await testUtils.dom.click(kanban.el.querySelector('.dropdown-item.o_column_delete'));await testUtils.dom.click(document.querySelector('.modal .btn-primary'));assert.containsNone(kanban,'.o_kanban_group');assert.containsOnce(kanban,'.o_column_quick_create .o_quick_create_unfolded');kanban.destroy();});QUnit.test('empty grouped kanban with sample data: add a column and delete it right away',async function(assert){assert.expect(9);const kanban=await createView({arch:`
                <kanban sample="1">
                    <field name="product_id"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:['product_id'],model:'partner',View:KanbanView,async mockRPC(route,{method}){const result=await this._super(...arguments);if(method==='web_read_group'){result.groups=this.data.product.records.map(r=>{return{product_id:[r.id,r.display_name],product_id_count:0,__domain:['product_id','=',r.id],};});result.length=result.groups.length;}
return result;},});assert.hasClass(kanban,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_group',2);assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');await testUtils.dom.click(kanban.el.querySelector('.o_kanban_add_column'));await testUtils.fields.editInput(kanban.el.querySelector('.o_kanban_header input'),"Yoohoo");await testUtils.dom.click(kanban.el.querySelector('.btn.o_kanban_add'));assert.hasClass(kanban,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_group',3);assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');const newColumn=kanban.el.querySelectorAll('.o_kanban_group')[2];await testUtils.dom.click(newColumn.querySelector('.o_kanban_config > a'));await testUtils.dom.click(newColumn.querySelector('.dropdown-item.o_column_delete'));await testUtils.dom.click(document.querySelector('.modal .btn-primary'));assert.hasClass(kanban,'o_view_sample_data');assert.containsN(kanban,'.o_kanban_group',2);assert.ok(kanban.$('.o_kanban_record').length>0,'should contain sample records');kanban.destroy();});QUnit.test('bounce create button when no data and click on empty area',async function(assert){assert.expect(2);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`<kanban class="o_kanban_test"><templates><t t-name="kanban-box">
                    <div>
                        <t t-esc="record.foo.value"/>
                        <field name="foo"/>
                    </div>
                </t></templates></kanban>`,viewOptions:{action:{help:'<p class="hello">click to add a partner</p>'}},});await testUtils.dom.click(kanban.$('.o_kanban_view'));assert.doesNotHaveClass(kanban.$('.o-kanban-button-new'),'o_catch_attention');await kanban.reload({domain:[['id','<',0]]});await testUtils.dom.click(kanban.$('.o_kanban_view'));assert.hasClass(kanban.$('.o-kanban-button-new'),'o_catch_attention');kanban.destroy();});QUnit.test('buttons with modifiers',async function(assert){assert.expect(2);this.data.partner.records[1].bar=false;var kanban=await createView({View:KanbanView,model:"partner",data:this.data,arch:'<kanban>'+'<field name="foo"/>'+'<field name="bar"/>'+'<field name="state"/>'+'<templates><div t-name="kanban-box">'+'<button class="o_btn_test_1" type="object" name="a1" '+'attrs="{\'invisible\': [[\'foo\', \'!=\', \'yop\']]}"/>'+'<button class="o_btn_test_2" type="object" name="a2" '+'attrs="{\'invisible\': [[\'bar\', \'=\', True]]}" '+'states="abc,def"/>'+'</div></templates>'+'</kanban>',});assert.containsOnce(kanban,".o_btn_test_1","kanban should have one buttons of type 1");assert.containsN(kanban,".o_btn_test_2",3,"kanban should have three buttons of type 2");kanban.destroy();});QUnit.test('button executes action and reloads',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:"partner",data:this.data,arch:'<kanban>'+'<templates><div t-name="kanban-box">'+'<field name="foo"/>'+'<button type="object" name="a1" />'+'</div></templates>'+'</kanban>',mockRPC:function(route){assert.step(route);return this._super.apply(this,arguments);},});assert.ok(kanban.$('button[data-name="a1"]').length,"kanban should have at least one button a1");var count=0;testUtils.mock.intercept(kanban,'execute_action',function(event){count++;event.data.on_closed();});await testUtils.dom.click($('button[data-name="a1"]').first());assert.strictEqual(count,1,"should have triggered a execute action");await testUtils.dom.click($('button[data-name="a1"]').first());assert.strictEqual(count,1,"double-click on kanban actions should be debounced");assert.verifySteps(['/web/dataset/search_read','/web/dataset/call_kw/partner/read'],'a read should be done after the call button to reload the record');kanban.destroy();});QUnit.test('button executes action and check domain',async function(assert){assert.expect(2);var data=this.data;data.partner.fields.active={string:"Active",type:"boolean",default:true};for(var k in this.data.partner.records){data.partner.records[k].active=true;}
var kanban=await createView({View:KanbanView,model:"partner",data:data,arch:'<kanban>'+'<templates><div t-name="kanban-box">'+'<field name="foo"/>'+'<field name="active"/>'+'<button type="object" name="a1" />'+'<button type="object" name="toggle_active" />'+'</div></templates>'+'</kanban>',});testUtils.mock.intercept(kanban,'execute_action',function(event){data.partner.records[0].active=false;event.data.on_closed();});assert.strictEqual(kanban.$('.o_kanban_record:contains(yop)').length,1,"should display 'yop' record");await testUtils.dom.click(kanban.$('.o_kanban_record:contains(yop) button[data-name="toggle_active"]'));assert.strictEqual(kanban.$('.o_kanban_record:contains(yop)').length,0,"should remove 'yop' record from the view");kanban.destroy();});QUnit.test('button executes action with domain field not in view',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:"partner",data:this.data,domain:[['bar','=',true]],arch:'<kanban>'+'<templates><div t-name="kanban-box">'+'<field name="foo"/>'+'<button type="object" name="a1" />'+'<button type="object" name="toggle_action" />'+'</div></templates>'+'</kanban>',});testUtils.mock.intercept(kanban,'execute_action',function(event){event.data.on_closed();});try{await testUtils.dom.click(kanban.$('.o_kanban_record:contains(yop) button[data-name="toggle_action"]'));assert.strictEqual(true,true,'Everything went fine');}catch(e){assert.strictEqual(true,false,'Error triggered at action execution');}
kanban.destroy();});QUnit.test('rendering date and datetime',async function(assert){assert.expect(2);this.data.partner.records[0].date="2017-01-25";this.data.partner.records[1].datetime="2016-12-12 10:55:05";var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="date"/>'+'<field name="datetime"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<t t-esc="record.date.raw_value"/>'+'<t t-esc="record.datetime.raw_value"/>'+'</div>'+'</t></templates>'+'</kanban>',});assert.strictEqual(kanban.$('div.o_kanban_record:contains(Wed Jan 25)').length,1,"should have formatted the date");assert.strictEqual(kanban.$('div.o_kanban_record:contains(Mon Dec 12)').length,1,"should have formatted the datetime");kanban.destroy();});QUnit.test('evaluate conditions on relational fields',async function(assert){assert.expect(3);this.data.partner.records[0].product_id=false;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="product_id"/>'+'<field name="category_ids"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<button t-if="!record.product_id.raw_value" class="btn_a">A</button>'+'<button t-if="!record.category_ids.raw_value.length" class="btn_b">B</button>'+'</div>'+'</t></templates>'+'</kanban>',});assert.strictEqual($('.o_kanban_record:not(.o_kanban_ghost)').length,4,"there should be 4 records");assert.strictEqual($('.o_kanban_record:not(.o_kanban_ghost) .btn_a').length,1,"only 1 of them should have the 'Action' button");assert.strictEqual($('.o_kanban_record:not(.o_kanban_ghost) .btn_b').length,2,"only 2 of them should have the 'Action' button");kanban.destroy();});QUnit.test('resequence columns in grouped by m2o',async function(assert){assert.expect(6);this.data.product.fields.sequence={string:"Sequence",type:"integer"};var envIDs=[1,3,2,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});assert.hasClass(kanban.$('.o_kanban_view'),'ui-sortable',"columns should be sortable");assert.containsN(kanban,'.o_kanban_group',2,"should have two columns");assert.strictEqual(kanban.$('.o_kanban_group:first').data('id'),3,"first column should be id 3 before resequencing");assert.deepEqual(kanban.exportState().resIds,envIDs);envIDs=[2,4,1,3];kanban._onResequenceColumn({data:{ids:[5,3]}});await nextTick();await kanban.update({},{reload:false});assert.strictEqual(kanban.$('.o_kanban_group:first').data('id'),5,"first column should be id 5 after resequencing");assert.deepEqual(kanban.exportState().resIds,envIDs);kanban.destroy();});QUnit.test('properly evaluate more complex domains',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="foo"/>'+'<field name="bar"/>'+'<field name="category_ids"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div>'+'<field name="foo"/>'+'<button type="object" attrs="{\'invisible\':[\'|\', (\'bar\',\'=\',True), (\'category_ids\', \'!=\', [])]}" class="btn btn-primary float-right" name="channel_join_and_get_info">Join</button>'+'</div>'+'</t>'+'</templates>'+'</kanban>',});assert.containsOnce(kanban,'button.oe_kanban_action_button',"only one button should be visible");kanban.destroy();});QUnit.test('edit the kanban color with the colorpicker',async function(assert){assert.expect(5);var writeOnColor;this.data.category.records[0].color=12;var kanban=await createView({View:KanbanView,model:'category',data:this.data,arch:'<kanban>'+'<field name="color"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div color="color">'+'<div class="o_dropdown_kanban dropdown">'+'<a class="dropdown-toggle o-no-caret btn" data-toggle="dropdown" href="#">'+'<span class="fa fa-bars fa-lg"/>'+'</a>'+'<ul class="dropdown-menu" role="menu">'+'<li>'+'<ul class="oe_kanban_colorpicker"/>'+'</li>'+'</ul>'+'</div>'+'<field name="name"/>'+'</div>'+'</t>'+'</templates>'+'</kanban>',mockRPC:function(route,args){if(args.method==='write'&&'color'in args.args[1]){writeOnColor=true;}
return this._super.apply(this,arguments);},});var $firstRecord=kanban.$('.o_kanban_record:first()');assert.containsNone(kanban,'.o_kanban_record.oe_kanban_color_12',"no record should have the color 12");assert.strictEqual($firstRecord.find('.oe_kanban_colorpicker').length,1,"there should be a color picker");assert.strictEqual($firstRecord.find('.oe_kanban_colorpicker').children().length,12,"the color picker should have 12 children (the colors)");testUtils.kanban.toggleRecordDropdown($firstRecord);await testUtils.dom.click($firstRecord.find('.oe_kanban_colorpicker a.oe_kanban_color_9'));assert.ok(writeOnColor,"should write on the color field");$firstRecord=kanban.$('.o_kanban_record:first()');assert.ok($firstRecord.is('.oe_kanban_color_9'),"the first record should have the color 9");kanban.destroy();});QUnit.test('load more records in column',async function(assert){assert.expect(13);var envIDs=[1,2,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],viewOptions:{limit:2,},mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(args.limit+' - '+args.offset);}
return this._super.apply(this,arguments);},});assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,2,"there should be 2 records in the column");assert.deepEqual(kanban.exportState().resIds,envIDs);envIDs=[1,2,3,4];await testUtils.dom.click(kanban.$('.o_kanban_group:eq(1)').find('.o_kanban_load_more'));assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,3,"there should now be 3 records in the column");assert.verifySteps(['2 - undefined','2 - undefined','2 - 2'],"the records should be correctly fetched");assert.deepEqual(kanban.exportState().resIds,envIDs);await kanban.reload();assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,3,"there should still be 3 records in the column after reload");assert.deepEqual(kanban.exportState().resIds,envIDs);assert.verifySteps(['4 - undefined','2 - undefined']);kanban.destroy();});QUnit.test('load more records in column with x2many',async function(assert){assert.expect(10);this.data.partner.records[0].category_ids=[7];this.data.partner.records[1].category_ids=[];this.data.partner.records[2].category_ids=[6];this.data.partner.records[3].category_ids=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="category_ids"/>'+'<field name="foo"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],viewOptions:{limit:2,},mockRPC:function(route,args){if(args.model==='category'&&args.method==='read'){assert.step(String(args.args[0]));}
if(route==='/web/dataset/search_read'){if(args.limit){assert.strictEqual(args.limit,2,"the limit should be correctly set");}
if(args.offset){assert.strictEqual(args.offset,2,"the offset should be correctly set at load more");}}
return this._super.apply(this,arguments);},});assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,2,"there should be 2 records in the column");assert.verifySteps(['7'],"only the appearing category should be fetched");await testUtils.dom.click(kanban.$('.o_kanban_group:eq(1)').find('.o_kanban_load_more'));assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,3,"there should now be 3 records in the column");assert.verifySteps(['6'],"the other categories should not be fetched");kanban.destroy();});QUnit.test('update buttons after column creation',async function(assert){assert.expect(2);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['product_id'],});assert.isNotVisible(kanban.$buttons.find('.o-kanban-button-new'),"Create button should be hidden");await testUtils.dom.click(kanban.$('.o_column_quick_create'));kanban.$('.o_column_quick_create input').val('new column');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));assert.isVisible(kanban.$buttons.find('.o-kanban-button-new'),"Create button should now be visible");kanban.destroy();});QUnit.test('group_by_tooltip option when grouping on a many2one',async function(assert){assert.expect(12);delete this.data.partner.records[3].product_id;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban default_group_by="bar">'+'<field name="bar"/>'+'<field name="product_id" '+'options=\'{"group_by_tooltip": {"name": "Kikou"}}\'/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',mockRPC:function(route,args){if(route==='/web/dataset/call_kw/product/read'){assert.strictEqual(args.args[0].length,2,"read on two groups");assert.deepEqual(args.args[1],['display_name','name'],"should read on specified fields on the group by relation");}
return this._super.apply(this,arguments);},});assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_grouped',"should have classname 'o_kanban_grouped'");assert.containsN(kanban,'.o_kanban_group',2,"should have "+2+" columns");await kanban.update({groupBy:['product_id']});assert.containsN(kanban,'.o_kanban_group',3,"should have "+3+" columns");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(1) .o_kanban_record').length,1,"column should contain 1 record(s)");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(2) .o_kanban_record').length,2,"column should contain 2 record(s)");assert.strictEqual(kanban.$('.o_kanban_group:nth-child(3) .o_kanban_record').length,1,"column should contain 1 record(s)");assert.ok(kanban.$('.o_kanban_group:first span.o_column_title:contains(Undefined)').length,"first column should have a default title for when no value is provided");assert.ok(!kanban.$('.o_kanban_group:first .o_kanban_header_title').data('original-title'),"tooltip of first column should not defined, since group_by_tooltip title and the many2one field has no value");assert.ok(kanban.$('.o_kanban_group:eq(1) span.o_column_title:contains(hello)').length,"second column should have a title with a value from the many2one");assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_header_title').data('original-title'),"<div>Kikou</br>hello</div>","second column should have a tooltip with the group_by_tooltip title and many2one field value");kanban.destroy();});QUnit.test('move a record then put it again in the same column',async function(assert){assert.expect(6);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'</t></templates></kanban>',groupBy:['product_id'],});await testUtils.dom.click(kanban.$('.o_column_quick_create'));kanban.$('.o_column_quick_create input').val('column1');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));await testUtils.dom.click(kanban.$('.o_column_quick_create'));kanban.$('.o_column_quick_create input').val('column2');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));await testUtils.dom.click(kanban.$('.o_kanban_group:eq(1) .o_kanban_quick_add i'));var $quickCreate=kanban.$('.o_kanban_group:eq(1) .o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'new partner');await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record').length,0,"column should contain 0 record");assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,1,"column should contain 1 records");var $record=kanban.$('.o_kanban_group:eq(1) .o_kanban_record:eq(0)');var $group=kanban.$('.o_kanban_group:eq(0)');await testUtils.dom.dragAndDrop($record,$group);await nextTick();assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record').length,1,"column should contain 1 records");assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,0,"column should contain 0 records");$record=kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(0)');$group=kanban.$('.o_kanban_group:eq(1)');await testUtils.dom.dragAndDrop($record,$group);await nextTick();assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record').length,0,"column should contain 0 records");assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_record').length,1,"column should contain 1 records");kanban.destroy();});QUnit.test('resequence a record twice',async function(assert){assert.expect(10);this.data.partner.records=[];var nbResequence=0;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="display_name"/></div>'+'</t></templates></kanban>',groupBy:['product_id'],mockRPC:function(route){if(route==='/web/dataset/resequence'){nbResequence++;return Promise.resolve();}
return this._super.apply(this,arguments);},});await testUtils.dom.click(kanban.$('.o_column_quick_create'));kanban.$('.o_column_quick_create input').val('column1');await testUtils.dom.click(kanban.$('.o_column_quick_create button.o_kanban_add'));await testUtils.dom.click(kanban.$('.o_kanban_group:eq(0) .o_kanban_quick_add i'));var $quickCreate=kanban.$('.o_kanban_group:eq(0) .o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'record1');await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));await testUtils.dom.click(kanban.$('.o_kanban_group:eq(0) .o_kanban_quick_add i'));$quickCreate=kanban.$('.o_kanban_group:eq(0) .o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('input'),'record2');await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record').length,2,"column should contain 2 records");assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(0)').text(),"record2","records should be correctly ordered");assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(1)').text(),"record1","records should be correctly ordered");var $record1=kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(1)');var $record2=kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(0)');await testUtils.dom.dragAndDrop($record1,$record2,{position:'top'});assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record').length,2,"column should contain 2 records");assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(0)').text(),"record1","records should be correctly ordered");assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(1)').text(),"record2","records should be correctly ordered");await testUtils.dom.dragAndDrop($record2,$record1,{position:'top'});assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record').length,2,"column should contain 2 records");assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(0)').text(),"record2","records should be correctly ordered");assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(1)').text(),"record1","records should be correctly ordered");assert.strictEqual(nbResequence,2,"should have resequenced twice");kanban.destroy();});QUnit.test('basic support for widgets',async function(assert){assert.expect(1);var MyWidget=Widget.extend({init:function(parent,dataPoint){this.data=dataPoint.data;},start:function(){this.$el.text(JSON.stringify(this.data));},});widgetRegistry.add('test',MyWidget);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div>'+'<t t-esc="record.foo.value"/>'+'<field name="foo" blip="1"/>'+'<widget name="test"/>'+'</div>'+'</t></templates></kanban>',});assert.strictEqual(kanban.$('.o_widget:eq(2)').text(),'{"foo":"gnap","id":3}',"widget should have been instantiated");kanban.destroy();delete widgetRegistry.map.test;});QUnit.test('subwidgets with on_attach_callback when changing record color',async function(assert){assert.expect(3);var counter=0;var MyTestWidget=AbstractField.extend({on_attach_callback:function(){counter++;},});fieldRegistry.add('test_widget',MyTestWidget);var kanban=await createView({View:KanbanView,model:'category',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="color"/>'+'<templates>'+'<t t-name="kanban-box">'+'<div color="color">'+'<div class="o_dropdown_kanban dropdown">'+'<a class="dropdown-toggle o-no-caret btn" data-toggle="dropdown" href="#">'+'<span class="fa fa-bars fa-lg"/>'+'</a>'+'<ul class="dropdown-menu" role="menu">'+'<li>'+'<ul class="oe_kanban_colorpicker"/>'+'</li>'+'</ul>'+'</div>'+'<field name="name" widget="test_widget"/>'+'</div>'+'</t>'+'</templates>'+'</kanban>',});assert.strictEqual(counter,2,"on_attach_callback should have been called twice");var $firstRecord=kanban.$('.o_kanban_record:first()');testUtils.kanban.toggleRecordDropdown($firstRecord);await testUtils.dom.click($firstRecord.find('.oe_kanban_colorpicker a.oe_kanban_color_9'));$firstRecord=kanban.$('.o_kanban_record:first()');assert.hasClass($firstRecord,'oe_kanban_color_9');assert.strictEqual(counter,3,"on_attach_callback method should be called 3 times");delete fieldRegistry.map.test_widget;kanban.destroy();});QUnit.test('column progressbars properly work',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\' sum_field="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],});assert.containsN(kanban,'.o_kanban_counter',this.data.product.records.length,"kanban counters should have been created");assert.strictEqual(parseInt(kanban.$('.o_kanban_counter_side').last().text()),36,"counter should display the sum of int_field values");kanban.destroy();});QUnit.test('column progressbars: "false" bar is clickable',async function(assert){assert.expect(8);this.data.partner.records.push({id:5,bar:true,foo:false,product_id:5,state:"ghi"});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\'/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],});assert.containsN(kanban,'.o_kanban_group',2);assert.strictEqual(kanban.$('.o_kanban_counter:last .o_kanban_counter_side').text(),"4");assert.containsN(kanban,'.o_kanban_counter_progress:last .progress-bar',4);assert.containsOnce(kanban,'.o_kanban_counter_progress:last .progress-bar[data-filter="__false"]',"should have false kanban color");assert.hasClass(kanban.$('.o_kanban_counter_progress:last .progress-bar[data-filter="__false"]'),'bg-muted-full');await testUtils.dom.click(kanban.$('.o_kanban_counter_progress:last .progress-bar[data-filter="__false"]'));assert.hasClass(kanban.$('.o_kanban_counter_progress:last .progress-bar[data-filter="__false"]'),'progress-bar-animated');assert.hasClass(kanban.$('.o_kanban_group:last'),'o_kanban_group_show_muted');assert.strictEqual(kanban.$('.o_kanban_counter:last .o_kanban_counter_side').text(),"1");kanban.destroy();});QUnit.test('column progressbars: "false" bar with sum_field',async function(assert){assert.expect(4);this.data.partner.records.push({id:5,bar:true,foo:false,int_field:15,product_id:5,state:"ghi"});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<field name="foo"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\' sum_field="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],});assert.containsN(kanban,'.o_kanban_group',2);assert.strictEqual(kanban.$('.o_kanban_counter:last .o_kanban_counter_side').text(),"51");await testUtils.dom.click(kanban.$('.o_kanban_counter_progress:last .progress-bar[data-filter="__false"]'));assert.hasClass(kanban.$('.o_kanban_counter_progress:last .progress-bar[data-filter="__false"]'),'progress-bar-animated');assert.strictEqual(kanban.$('.o_kanban_counter:last .o_kanban_counter_side').text(),"15");kanban.destroy();});QUnit.test('column progressbars should not crash in non grouped views',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\' sum_field="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',mockRPC:function(route,args){assert.step(route);return this._super(route,args);},});assert.strictEqual(kanban.$('.o_kanban_record').text(),'namenamenamename',"should have renderer 4 records");assert.verifySteps(['/web/dataset/search_read'],"no read on progress bar data is done");kanban.destroy();});QUnit.test('column progressbars: creating a new column should create a new progressbar',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="product_id"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\'/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],});var nbProgressBars=kanban.$('.o_kanban_counter').length;var $columnQuickCreate=kanban.$('.o_column_quick_create');await testUtils.dom.click($columnQuickCreate.find('.o_quick_create_folded'));$columnQuickCreate.find('input').val('test');await testUtils.dom.click($columnQuickCreate.find('.btn-primary'));assert.containsN(kanban,'.o_kanban_counter',nbProgressBars+1,"a new column with a new column progressbar should have been created");kanban.destroy();});QUnit.test('column progressbars on quick create properly update counter',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\'/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],});var initialCount=parseInt(kanban.$('.o_kanban_counter_side:first').text());await testUtils.dom.click(kanban.$('.o_kanban_quick_add:first'));await testUtils.fields.editInput(kanban.$('.o_kanban_quick_create input'),'Test');await testUtils.dom.click(kanban.$('.o_kanban_add'));var lastCount=parseInt(kanban.$('.o_kanban_counter_side:first').text());await nextTick();await nextTick();assert.strictEqual(lastCount,initialCount+1,"kanban counters should have updated on quick create");kanban.destroy();});QUnit.test('column progressbars are working with load more',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,domain:[['bar','=',true]],arch:'<kanban limit="1">'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\'/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="id"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],});await testUtils.dom.click(kanban.$('.o_kanban_group').find('.o_kanban_load_more'));await testUtils.dom.click(kanban.$('.o_kanban_group').find('.o_kanban_load_more'));var shownIDs=_.map(kanban.$('.o_kanban_record'),function(record){return parseInt(record.innerText);});assert.deepEqual(shownIDs,[1,2,3],"intended records are loaded");kanban.destroy();});QUnit.test('column progressbars on archiving records update counter',async function(assert){assert.expect(4);this.data.partner.fields.active={string:'Active',type:'char',default:true};var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="active"/>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\' sum_field="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/action_archive'){var partnerIDS=args.args[0];var records=this.data.partner.records;_.each(partnerIDS,function(partnerID){_.find(records,function(record){return record.id===partnerID;}).active=false;});this.data.partner.records[0].active;return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_counter_side').text(),"36","counter should contain the correct value");assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_counter_progress > .progress-bar:first').data('originalTitle'),"1 yop","the counter progressbars should be correctly displayed");testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:eq(1)'));await testUtils.dom.click(kanban.$('.o_column_archive_records:visible'));await testUtils.dom.click($('.modal-footer button:first'));assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_counter_side').text(),"0","counter should contain the correct value");assert.strictEqual(kanban.$('.o_kanban_group:eq(1) .o_kanban_counter_progress > .progress-bar:first').data('originalTitle'),"0 yop","the counter progressbars should have been correctly updated");kanban.destroy();});QUnit.test('kanban with progressbars: correctly update env when archiving records',async function(assert){assert.expect(2);this.data.partner.fields.active={string:'Active',type:'char',default:true};var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="active"/>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\' sum_field="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/action_archive'){var partnerIDS=args.args[0];var records=this.data.partner.records
_.each(partnerIDS,function(partnerID){_.find(records,function(record){return record.id===partnerID;}).active=false;})
this.data.partner.records[0].active;return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.deepEqual(kanban.exportState().resIds,[1,2,3,4]);testUtils.kanban.toggleGroupSettings(kanban.$('.o_kanban_group:first'));await testUtils.dom.click(kanban.$('.o_column_archive_records:visible'));await testUtils.dom.click($('.modal-footer button:first'));assert.deepEqual(kanban.exportState().resIds,[1,2,3]);kanban.destroy();});QUnit.test('RPCs when (re)loading kanban view progressbars',async function(assert){assert.expect(9);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\' sum_field="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await kanban.reload();assert.verifySteps(['web_read_group','read_progress_bar','/web/dataset/search_read','/web/dataset/search_read','web_read_group','read_progress_bar','/web/dataset/search_read','/web/dataset/search_read',]);kanban.destroy();});QUnit.test('drag & drop records grouped by m2o with progressbar',async function(assert){assert.expect(4);this.data.partner.records[0].product_id=false;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\'/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="int_field"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['product_id'],mockRPC:function(route,args){if(route==='/web/dataset/resequence'){return Promise.resolve(true);}
return this._super(route,args);},});assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_counter_side').text(),"1","counter should contain the correct value");await testUtils.dom.dragAndDrop(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(0)'),kanban.$('.o_kanban_group:eq(1)'));await nextTick();assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_counter_side').text(),"0","counter should contain the correct value");await testUtils.dom.dragAndDrop(kanban.$('.o_kanban_group:eq(1) .o_kanban_record:eq(2)'),kanban.$('.o_kanban_group:eq(0)'));await nextTick();assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_counter_side').text(),"1","counter should contain the correct value");await testUtils.dom.dragAndDrop(kanban.$('.o_kanban_group:eq(0) .o_kanban_record:eq(0)'),kanban.$('.o_kanban_group:eq(1)'));await nextTick();assert.strictEqual(kanban.$('.o_kanban_group:eq(0) .o_kanban_counter_side').text(),"0","counter should contain the correct value");kanban.destroy();});QUnit.test('progress bar subgroup count recompute',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\'/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="foo"/>'+'</div>'+'</t></templates>'+'</kanban>',groupBy:['bar'],});var $secondGroup=kanban.$('.o_kanban_group:eq(1)');var initialCount=parseInt($secondGroup.find('.o_kanban_counter_side').text());assert.strictEqual(initialCount,3,"Initial count should be Three");await testUtils.dom.click($secondGroup.find('.bg-success-full'));var lastCount=parseInt($secondGroup.find('.o_kanban_counter_side').text());assert.strictEqual(lastCount,1,"kanban counters should vary according to what subgroup is selected");kanban.destroy();});QUnit.test('column progressbars on quick create with quick_create_view are updated',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create" quick_create_view="some_view_ref">'+'<field name="int_field"/>'+'<progressbar field="foo" colors=\'{"yop": "success", "gnap": "warning", "blip": "danger"}\' sum_field="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates>'+'</kanban>',archs:{'partner,some_view_ref,form':'<form>'+'<field name="int_field"/>'+'</form>',},groupBy:['bar'],});var initialCount=parseInt(kanban.$('.o_kanban_counter_side:first').text());await testUtils.kanban.clickCreate(kanban);var $quickCreate=kanban.$('.o_kanban_group:first .o_kanban_quick_create');await testUtils.fields.editInput($quickCreate.find('.o_field_widget[name=int_field]'),'44');await testUtils.dom.click($quickCreate.find('button.o_kanban_add'));var lastCount=parseInt(kanban.$('.o_kanban_counter_side:first').text());assert.strictEqual(lastCount,initialCount+44,"kanban counters should have been updated on quick create");kanban.destroy();});QUnit.test('keep adding quickcreate in first column after a record from this column was moved',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban on_create="quick_create">'+'<field name="int_field"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',groupBy:['foo'],mockRPC:function(route,args){if(route==='/web/dataset/resequence'){return Promise.resolve(true);}
return this._super(route,args);},});var $quickCreateGroup;var $groups;await _quickCreateAndTest();await testUtils.dom.dragAndDrop($groups.first().find('.o_kanban_record:first'),$groups.eq(1));await _quickCreateAndTest();kanban.destroy();async function _quickCreateAndTest(){await testUtils.kanban.clickCreate(kanban);$quickCreateGroup=kanban.$('.o_kanban_quick_create').closest('.o_kanban_group');$groups=kanban.$('.o_kanban_group');assert.strictEqual($quickCreateGroup[0],$groups[0],"quick create should have been added in the first column");}});QUnit.test('test displaying image (URL, image field not set)',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="id"/>'+'<templates><t t-name="kanban-box"><div>'+'<img t-att-src="kanban_image(\'partner\', \'image\', record.id.raw_value)"/>'+'</div></t></templates>'+'</kanban>',});var imageOnRecord=kanban.$('img[data-src*="/web/image"][data-src*="&id=1"]');assert.strictEqual(imageOnRecord.length,1,"partner with image display image by url");kanban.destroy();});QUnit.test('test displaying image (binary & placeholder)',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="id"/>'+'<field name="image"/>'+'<templates><t t-name="kanban-box"><div>'+'<img t-att-src="kanban_image(\'partner\', \'image\', record.id.raw_value)"/>'+'</div></t></templates>'+'</kanban>',mockRPC:function(route,args){if(route==='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACAA=='){assert.ok("The view's image should have been fetched.");return Promise.resolve();}
return this._super.apply(this,arguments);},});var images=kanban.el.querySelectorAll('img');var placeholders=[];for(var[index,img]of images.entries()){if(img.dataset.src.indexOf(this.data.partner.records[index].image)===-1){placeholders.push(img);}}
assert.strictEqual(placeholders.length,this.data.partner.records.length-1,"partner with no image should display the placeholder");kanban.destroy();});QUnit.test('test displaying image (for another record)',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="id"/>'+'<field name="image"/>'+'<templates><t t-name="kanban-box"><div>'+'<img t-att-src="kanban_image(\'partner\', \'image\', 1)"/>'+'</div></t></templates>'+'</kanban>',mockRPC:function(route,args){if(route==='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACAA=='){assert.ok("The view's image should have been fetched.");return Promise.resolve();}
return this._super.apply(this,arguments);},});var imageOnRecord=kanban.$('img[data-src*="/web/image"][data-src*="&id=1"]');assert.strictEqual(imageOnRecord.length,this.data.partner.records.length-1,"display image by url when requested for another record");kanban.destroy();});QUnit.test('check if the view destroys all widgets and instances',async function(assert){assert.expect(2);var instanceNumber=0;testUtils.mock.patch(mixins.ParentedMixin,{init:function(){instanceNumber++;return this._super.apply(this,arguments);},destroy:function(){if(!this.isDestroyed()){instanceNumber--;}
return this._super.apply(this,arguments);}});var params={View:KanbanView,model:'partner',data:this.data,arch:'<kanban string="Partners">'+'<field name="foo"/>'+'<field name="bar"/>'+'<field name="int_field"/>'+'<field name="qux"/>'+'<field name="product_id"/>'+'<field name="category_ids"/>'+'<field name="state"/>'+'<field name="date"/>'+'<field name="datetime"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates>'+'</kanban>',};var kanban=await createView(params);assert.ok(instanceNumber>0);kanban.destroy();assert.strictEqual(instanceNumber,0);testUtils.mock.unpatch(mixins.ParentedMixin);});QUnit.test('grouped kanban becomes ungrouped when clearing domain then clearing groupby',async function(assert){assert.expect(4);var prom=makeTestPromise();var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',domain:[['foo','=','norecord']],groupBy:['bar'],mockRPC:function(route,args){var result=this._super(route,args);if(args.method==='web_read_group'){var isFirstUpdate=_.isEmpty(args.kwargs.domain)&&args.kwargs.groupby&&args.kwargs.groupby[0]==='bar';if(isFirstUpdate){return prom.then(function(){return result;});}}
return result;},});assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_grouped',"the kanban view should be grouped");assert.doesNotHaveClass(kanban.$('.o_kanban_view'),'o_kanban_ungrouped',"the kanban view should not be ungrouped");kanban.update({domain:[]});kanban.update({groupBy:false});prom.resolve();await nextTick();assert.doesNotHaveClass(kanban.$('.o_kanban_view'),'o_kanban_grouped',"the kanban view should not longer be grouped");assert.hasClass(kanban.$('.o_kanban_view'),'o_kanban_ungrouped',"the kanban view should have become ungrouped");kanban.destroy();});QUnit.test('quick_create on grouped kanban without column',async function(assert){assert.expect(1);this.data.partner.records=[];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test" group_create="0" on_create="quick_create"><templates><t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'</div>'+'</t></templates></kanban>',groupBy:['product_id'],intercepts:{switch_view:function(event){assert.ok(true,"switch_view was called instead of quick_create");},},});await testUtils.kanban.clickCreate(kanban);kanban.destroy();});QUnit.test('keyboard navigation on kanban basic rendering',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div>'+'<t t-esc="record.foo.value"/>'+'<field name="foo"/>'+'</div>'+'</t></templates></kanban>',});var $fisrtCard=kanban.$('.o_kanban_record:first');var $secondCard=kanban.$('.o_kanban_record:eq(1)');$fisrtCard.focus();assert.strictEqual(document.activeElement,$fisrtCard[0],"the kanban cards are focussable");$fisrtCard.trigger($.Event('keydown',{which:$.ui.keyCode.RIGHT,keyCode:$.ui.keyCode.RIGHT,}));assert.strictEqual(document.activeElement,$secondCard[0],"the second card should be focussed");$secondCard.trigger($.Event('keydown',{which:$.ui.keyCode.LEFT,keyCode:$.ui.keyCode.LEFT,}));assert.strictEqual(document.activeElement,$fisrtCard[0],"the first card should be focussed");kanban.destroy();});QUnit.test('keyboard navigation on kanban grouped rendering',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['bar'],});var $firstColumnFisrtCard=kanban.$('.o_kanban_record:first');var $secondColumnFirstCard=kanban.$('.o_kanban_group:eq(1) .o_kanban_record:first');var $secondColumnSecondCard=kanban.$('.o_kanban_group:eq(1) .o_kanban_record:eq(1)');$firstColumnFisrtCard.focus();$firstColumnFisrtCard.trigger($.Event('keydown',{which:$.ui.keyCode.RIGHT,keyCode:$.ui.keyCode.RIGHT,}));assert.strictEqual(document.activeElement,$secondColumnFirstCard[0],"RIGHT should select the first card of the next column");$secondColumnFirstCard.trigger($.Event('keydown',{which:$.ui.keyCode.DOWN,keyCode:$.ui.keyCode.DOWN,}));assert.strictEqual(document.activeElement,$secondColumnSecondCard[0],"DOWN should select the second card of the current column");$secondColumnSecondCard.trigger($.Event('keydown',{which:$.ui.keyCode.LEFT,keyCode:$.ui.keyCode.LEFT,}));assert.strictEqual(document.activeElement,$firstColumnFisrtCard[0],"LEFT should select the first card of the first column");kanban.destroy();});QUnit.test('keyboard navigation on kanban grouped rendering with empty columns',async function(assert){assert.expect(2);var data=this.data;data.partner.records[1].state="abc";var kanban=await createView({View:KanbanView,model:'partner',data:data,arch:'<kanban class="o_kanban_test">'+'<field name="bar"/>'+'<templates><t t-name="kanban-box">'+'<div><field name="foo"/></div>'+'</t></templates></kanban>',groupBy:['state'],mockRPC:function(route,args){if(args.method==='web_read_group'){return this._super.apply(this,arguments).then(function(result){result.groups.splice(1,0,{state_count:0,state:'def',__domain:[["state","=","def"]]});result.groups.splice(1,0,{state_count:0,state:'def',__domain:[["state","=","def"]]});result.groups.unshift({state_count:0,state:'def',__domain:[["state","=","def"]]});result.groups.push({state_count:0,state:'def',__domain:[["state","=","def"]]});return result;});}
return this._super.apply(this,arguments);},});var $yop=kanban.$('.o_kanban_record:first');var $gnap=kanban.$('.o_kanban_group:eq(4) .o_kanban_record:first');$yop.focus();$yop.trigger($.Event('keydown',{which:$.ui.keyCode.RIGHT,keyCode:$.ui.keyCode.RIGHT,}));assert.strictEqual(document.activeElement,$gnap[0],"RIGHT should select the first card of the next column that has a card");$gnap.trigger($.Event('keydown',{which:$.ui.keyCode.LEFT,keyCode:$.ui.keyCode.LEFT,}));assert.strictEqual(document.activeElement,$yop[0],"LEFT should select the first card of the first column that has a card");kanban.destroy();});QUnit.test('keyboard navigation on kanban when the focus is on a link that '+'has an action and the kanban has no oe_kanban_global_... class',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div><a type="edit">Edit</a></div>'+'</t></templates></kanban>',});testUtils.mock.intercept(kanban,'switch_view',function(event){assert.deepEqual(event.data,{view_type:'form',res_id:1,mode:'edit',model:'partner',},'When selecting focusing a card and hitting ENTER, the first link or button is clicked');});kanban.$('.o_kanban_record').first().focus().trigger($.Event('keydown',{keyCode:$.ui.keyCode.ENTER,which:$.ui.keyCode.ENTER,}));await testUtils.nextTick();kanban.destroy();});QUnit.test('asynchronous rendering of a field widget (ungrouped)',async function(assert){assert.expect(4);var fooFieldProm=makeTestPromise();var FieldChar=fieldRegistry.get('char');fieldRegistry.add('asyncwidget',FieldChar.extend({willStart:function(){return fooFieldProm;},start:function(){this.$el.html('LOADED');},}));var kanbanController;testUtils.createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div><field name="foo" widget="asyncwidget"/></div>'+'</t></templates></kanban>',}).then(function(kanban){kanbanController=kanban;});assert.strictEqual($('.o_kanban_record').length,0,"kanban view is not ready yet");fooFieldProm.resolve();await nextTick();assert.strictEqual($('.o_kanban_record').text(),"LOADEDLOADEDLOADEDLOADED");fooFieldProm=makeTestPromise();kanbanController.reload({domain:[['id','=',1]]});await nextTick();assert.strictEqual($('.o_kanban_record').text(),"LOADEDLOADEDLOADEDLOADED");fooFieldProm.resolve();await nextTick();assert.strictEqual($('.o_kanban_record').text(),"LOADED");kanbanController.destroy();delete fieldRegistry.map.asyncWidget;});QUnit.test('asynchronous rendering of a field widget (grouped)',async function(assert){assert.expect(4);var fooFieldProm=makeTestPromise();var FieldChar=fieldRegistry.get('char');fieldRegistry.add('asyncwidget',FieldChar.extend({willStart:function(){return fooFieldProm;},start:function(){this.$el.html('LOADED');},}));var kanbanController;testUtils.createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div><field name="foo" widget="asyncwidget"/></div>'+'</t></templates></kanban>',groupBy:['foo'],}).then(function(kanban){kanbanController=kanban;});assert.strictEqual($('.o_kanban_record').length,0,"kanban view is not ready yet");fooFieldProm.resolve();await nextTick();assert.strictEqual($('.o_kanban_record').text(),"LOADEDLOADEDLOADEDLOADED");fooFieldProm=makeTestPromise();kanbanController.reload({domain:[['id','=',1]]});await nextTick();assert.strictEqual($('.o_kanban_record').text(),"LOADEDLOADEDLOADEDLOADED");fooFieldProm.resolve();await nextTick();assert.strictEqual($('.o_kanban_record').text(),"LOADED");kanbanController.destroy();delete fieldRegistry.map.asyncWidget;});QUnit.test('asynchronous rendering of a field widget with display attr',async function(assert){assert.expect(3);var fooFieldDef=makeTestPromise();var FieldChar=fieldRegistry.get('char');fieldRegistry.add('asyncwidget',FieldChar.extend({willStart:function(){return fooFieldDef;},start:function(){this.$el.html('LOADED');},}));var kanbanController;testUtils.createAsyncView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div><field name="foo" display="right" widget="asyncwidget"/></div>'+'</t></templates></kanban>',}).then(function(kanban){kanbanController=kanban;});assert.containsNone(document.body,'.o_kanban_record');fooFieldDef.resolve();await nextTick();assert.strictEqual(kanbanController.$('.o_kanban_record').text(),"LOADEDLOADEDLOADEDLOADED");assert.hasClass(kanbanController.$('.o_kanban_record:first .o_field_char'),'float-right');kanbanController.destroy();delete fieldRegistry.map.asyncWidget;});QUnit.test('asynchronous rendering of a widget',async function(assert){assert.expect(2);var widgetDef=makeTestPromise();widgetRegistry.add('asyncwidget',Widget.extend({willStart:function(){return widgetDef;},start:function(){this.$el.html('LOADED');},}));var kanbanController;testUtils.createAsyncView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div><widget name="asyncwidget"/></div>'+'</t></templates></kanban>',}).then(function(kanban){kanbanController=kanban;});assert.containsNone(document.body,'.o_kanban_record');widgetDef.resolve();await nextTick();assert.strictEqual(kanbanController.$('.o_kanban_record .o_widget').text(),"LOADEDLOADEDLOADEDLOADED");kanbanController.destroy();delete widgetRegistry.map.asyncWidget;});QUnit.test('update kanban with asynchronous field widget',async function(assert){assert.expect(3);var fooFieldDef=makeTestPromise();var FieldChar=fieldRegistry.get('char');fieldRegistry.add('asyncwidget',FieldChar.extend({willStart:function(){return fooFieldDef;},start:function(){this.$el.html('LOADED');},}));var kanban=await testUtils.createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test"><templates><t t-name="kanban-box">'+'<div><field name="foo" widget="asyncwidget"/></div>'+'</t></templates></kanban>',domain:[['id','=','0']],});assert.containsNone(kanban,'.o_kanban_record:not(.o_kanban_ghost)');kanban.update({domain:[]});assert.containsNone(kanban,'.o_kanban_record:not(.o_kanban_ghost)');fooFieldDef.resolve();await nextTick();assert.strictEqual(kanban.$('.o_kanban_record').text(),"LOADEDLOADEDLOADEDLOADED");kanban.destroy();delete widgetRegistry.map.asyncWidget;});QUnit.test('set cover image',async function(assert){assert.expect(6);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<templates>'+'<t t-name="kanban-box">'+'<div>'+'<field name="name"/>'+'<div class="o_dropdown_kanban dropdown">'+'<a class="dropdown-toggle o-no-caret btn" data-toggle="dropdown" href="#">'+'<span class="fa fa-bars fa-lg"/>'+'</a>'+'<div class="dropdown-menu" role="menu">'+'<a type="set_cover" data-field="displayed_image_id" class="dropdown-item">Set Cover Image</a>'+'</div>'+'</div>'+'<div>'+'<field name="displayed_image_id" widget="attachment_image"/>'+'</div>'+'</div>'+'</t>'+'</templates>'+'</kanban>',mockRPC:function(route,args){if(args.model==='partner'&&args.method==='write'){assert.step(String(args.args[0][0]));return this._super(route,args);}
return this._super(route,args);},});var $firstRecord=kanban.$('.o_kanban_record:first');testUtils.kanban.toggleRecordDropdown($firstRecord);await testUtils.dom.click($firstRecord.find('[data-type=set_cover]'));assert.containsNone($firstRecord,'img',"Initially there is no image.");await testUtils.dom.click($('.modal').find("img[data-id='1']"));await testUtils.modal.clickButton('Select');assert.containsOnce(kanban,'img[data-src*="/web/image/1"]');var $secondRecord=kanban.$('.o_kanban_record:nth(1)');testUtils.kanban.toggleRecordDropdown($secondRecord);await testUtils.dom.click($secondRecord.find('[data-type=set_cover]'));$('.modal').find("img[data-id='2']").dblclick();await testUtils.nextTick();assert.containsOnce(kanban,'img[data-src*="/web/image/2"]');assert.verifySteps(["1","2"],"should writes on both kanban records");kanban.destroy();});QUnit.test('ungrouped kanban with handle field',async function(assert){assert.expect(4);var envIDs=[1,2,3,4];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<field name="int_field" widget="handle" />'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="foo"/>'+'</div>'+'</t></templates></kanban>',mockRPC:function(route,args){if(route==='/web/dataset/resequence'){assert.deepEqual(args.ids,envIDs,"should write the sequence in correct order");return Promise.resolve(true);}
return this._super(route,args);},});assert.hasClass(kanban.$('.o_kanban_view'),'ui-sortable');assert.strictEqual(kanban.$('.o_kanban_record:not(.o_kanban_ghost)').text(),'yopblipgnapblip');var $record=kanban.$('.o_kanban_view .o_kanban_record:first');var $to=kanban.$('.o_kanban_view .o_kanban_record:nth-child(4)');envIDs=[2,3,4,1];await testUtils.dom.dragAndDrop($record,$to,{position:"bottom"});assert.strictEqual(kanban.$('.o_kanban_record:not(.o_kanban_ghost)').text(),'blipgnapblipyop');kanban.destroy();});QUnit.test('ungrouped kanban without handle field',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban>'+'<templates><t t-name="kanban-box">'+'<div>'+'<field name="foo"/>'+'</div>'+'</t></templates></kanban>',mockRPC:function(route,args){if(route==='/web/dataset/resequence'){assert.ok(false,"should not trigger a resequencing");}
return this._super(route,args);},});assert.doesNotHaveClass(kanban.$('.o_kanban_view'),'ui-sortable');assert.strictEqual(kanban.$('.o_kanban_record:not(.o_kanban_ghost)').text(),'yopblipgnapblip');var $draggedRecord=kanban.$('.o_kanban_view .o_kanban_record:first');var $to=kanban.$('.o_kanban_view .o_kanban_record:nth-child(4)');await testUtils.dom.dragAndDrop($draggedRecord,$to,{position:"bottom"});assert.strictEqual(kanban.$('.o_kanban_record:not(.o_kanban_ghost)').text(),'yopblipgnapblip');kanban.destroy();});QUnit.test('click on image field in kanban with oe_kanban_global_click',async function(assert){assert.expect(2);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban class="o_kanban_test">'+'<templates><t t-name="kanban-box">'+'<div class="oe_kanban_global_click">'+'<field name="image" widget="image"/>'+'</div>'+'</t></templates>'+'</kanban>',mockRPC:function(route){if(route.startsWith('data:image')){return Promise.resolve();}
return this._super.apply(this,arguments);},intercepts:{switch_view:function(event){assert.deepEqual(_.pick(event.data,'mode','model','res_id','view_type'),{mode:'readonly',model:'partner',res_id:1,view_type:'form',},"should trigger an event to open the clicked record in a form view");},},});assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);await testUtils.dom.click(kanban.$('.o_field_image').first());kanban.destroy();});QUnit.test('kanban view with boolean field',async function(assert){assert.expect(2);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="bar"/></div>
                        </t>
                    </templates>
                </kanban>`,});assert.containsN(kanban,'.o_kanban_record:contains(True)',3);assert.containsOnce(kanban,'.o_kanban_record:contains(False)');kanban.destroy();});QUnit.test('kanban view with boolean widget',async function(assert){assert.expect(1);const kanban=await testUtils.createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div><field name="bar" widget="boolean"/></div>
                        </t>
                    </templates>
                </kanban>
            `,});assert.containsOnce(kanban.el.querySelector('.o_kanban_record'),'div.custom-checkbox.o_field_boolean');kanban.destroy();});QUnit.test('kanban view with monetary and currency fields without widget',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <field name="currency_id"/>
                    <templates><t t-name="kanban-box">
                        <div><field name="salary"/></div>
                    </t></templates>
                </kanban>`,session:{currencies:_.indexBy(this.data.currency.records,'id'),},});const kanbanRecords=kanban.el.querySelectorAll('.o_kanban_record:not(.o_kanban_ghost)');assert.deepEqual([...kanbanRecords].map(r=>r.innerText),['$ 1750.00','$ 1500.00','2000.00 €','$ 2222.00']);kanban.destroy();});QUnit.test("quick create: keyboard navigation to buttons",async function(assert){assert.expect(2);const kanban=await createView({arch:`
                <kanban on_create="quick_create">
                    <field name="bar"/>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="display_name"/>
                        </div>
                    </templates>
                </kanban>`,data:this.data,groupBy:["bar"],model:"partner",View:KanbanView,});await testUtils.kanban.clickCreate(kanban);assert.containsOnce(kanban,".o_kanban_group:first .o_kanban_quick_create");const $displayName=kanban.$(".o_kanban_quick_create .o_field_widget[name=display_name]");await testUtils.fields.editInput($displayName,"aaa");await testUtils.dom.triggerEvent($displayName,"keydown",{keyCode:$.ui.keyCode.TAB,which:$.ui.keyCode.TAB,});assert.hasClass(document.activeElement,"btn btn-primary o_kanban_add");kanban.destroy();});});});;

/* /web/static/tests/views/calendar_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.calendar_tests',function(require){"use strict";var AbstractStorageService=require('web.AbstractStorageService');var CalendarView=require('web.CalendarView');var CalendarRenderer=require('web.CalendarRenderer');var Dialog=require('web.Dialog');var ViewDialogs=require('web.view_dialogs');var fieldUtils=require('web.field_utils');var mixins=require('web.mixins');var RamStorage=require('web.RamStorage');var testUtils=require('web.test_utils');var session=require('web.session');var createActionManager=testUtils.createActionManager;CalendarRenderer.include({getAvatars:function(){var res=this._super.apply(this,arguments);for(var k in res){res[k]=res[k].replace(/src="([^"]+)"/,'data-src="\$1"');}
return res;}});var createCalendarView=testUtils.createCalendarView;var initialDate=new Date(2016,11,12,8,0,0);initialDate=new Date(initialDate.getTime()-initialDate.getTimezoneOffset()*60*1000);function _preventScroll(ev){ev.stopImmediatePropagation();}
QUnit.module('Views',{beforeEach:function(){window.addEventListener('scroll',_preventScroll,true);session.uid=-1;this.data={event:{fields:{id:{string:"ID",type:"integer"},user_id:{string:"user",type:"many2one",relation:'user',default:session.uid},partner_id:{string:"user",type:"many2one",relation:'partner',related:'user_id.partner_id',default:1},name:{string:"name",type:"char"},start_date:{string:"start date",type:"date"},stop_date:{string:"stop date",type:"date"},start:{string:"start datetime",type:"datetime"},stop:{string:"stop datetime",type:"datetime"},delay:{string:"delay",type:"float"},allday:{string:"allday",type:"boolean"},partner_ids:{string:"attendees",type:"one2many",relation:'partner',default:[[6,0,[1]]]},type:{string:"type",type:"integer"},event_type_id:{string:"Event_Type",type:"many2one",relation:'event_type'},color:{string:"Color",type:"integer",related:'event_type_id.color'},},records:[{id:1,user_id:session.uid,partner_id:1,name:"event 1",start:"2016-12-11 00:00:00",stop:"2016-12-11 00:00:00",allday:false,partner_ids:[1,2,3],type:1},{id:2,user_id:session.uid,partner_id:1,name:"event 2",start:"2016-12-12 10:55:05",stop:"2016-12-12 14:55:05",allday:false,partner_ids:[1,2],type:3},{id:3,user_id:4,partner_id:4,name:"event 3",start:"2016-12-12 15:55:05",stop:"2016-12-12 16:55:05",allday:false,partner_ids:[1],type:2},{id:4,user_id:session.uid,partner_id:1,name:"event 4",start:"2016-12-14 15:55:05",stop:"2016-12-14 18:55:05",allday:true,partner_ids:[1],type:2},{id:5,user_id:4,partner_id:4,name:"event 5",start:"2016-12-13 15:55:05",stop:"2016-12-20 18:55:05",allday:false,partner_ids:[2,3],type:2},{id:6,user_id:session.uid,partner_id:1,name:"event 6",start:"2016-12-18 08:00:00",stop:"2016-12-18 09:00:00",allday:false,partner_ids:[3],type:3},{id:7,user_id:session.uid,partner_id:1,name:"event 7",start:"2016-11-14 08:00:00",stop:"2016-11-16 17:00:00",allday:false,partner_ids:[2],type:1},],check_access_rights:function(){return Promise.resolve(true);}},user:{fields:{id:{string:"ID",type:"integer"},display_name:{string:"Displayed name",type:"char"},partner_id:{string:"partner",type:"many2one",relation:'partner'},image:{string:"image",type:"integer"},},records:[{id:session.uid,display_name:"user 1",partner_id:1},{id:4,display_name:"user 4",partner_id:4},]},partner:{fields:{id:{string:"ID",type:"integer"},display_name:{string:"Displayed name",type:"char"},image:{string:"image",type:"integer"},},records:[{id:1,display_name:"partner 1",image:'AAA'},{id:2,display_name:"partner 2",image:'BBB'},{id:3,display_name:"partner 3",image:'CCC'},{id:4,display_name:"partner 4",image:'DDD'}]},event_type:{fields:{id:{string:"ID",type:"integer"},display_name:{string:"Displayed name",type:"char"},color:{string:"Color",type:"integer"},},records:[{id:1,display_name:"Event Type 1",color:1},{id:2,display_name:"Event Type 2",color:2},{id:3,display_name:"Event Type 3 (color 4)",color:4},]},filter_partner:{fields:{id:{string:"ID",type:"integer"},user_id:{string:"user",type:"many2one",relation:'user'},partner_id:{string:"partner",type:"many2one",relation:'partner'},},records:[{id:1,user_id:session.uid,partner_id:1},{id:2,user_id:session.uid,partner_id:2},{id:3,user_id:4,partner_id:3}]},};},afterEach:function(){window.removeEventListener('scroll',_preventScroll,true);},},function(){QUnit.module('CalendarView');var archs={"event,false,form":'<form>'+'<field name="name"/>'+'<field name="allday"/>'+'<group attrs=\'{"invisible": [["allday","=",True]]}\' >'+'<field name="start"/>'+'<field name="stop"/>'+'</group>'+'<group attrs=\'{"invisible": [["allday","=",False]]}\' >'+'<field name="start_date"/>'+'<field name="stop_date"/>'+'</group>'+'</form>',"event,1,form":'<form>'+'<field name="allday" invisible="1"/>'+'<field name="start" attrs=\'{"invisible": [["allday","=",false]]}\'/>'+'<field name="stop" attrs=\'{"invisible": [["allday","=",true]]}\'/>'+'</form>',};QUnit.test('simple calendar rendering',async function(assert){assert.expect(24);this.data.event.records.push({id:8,user_id:session.uid,partner_id:false,name:"event 7",start:"2016-12-18 09:00:00",stop:"2016-12-18 10:00:00",allday:false,partner_ids:[2],type:1});var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'<field name="partner_id" filters="1" invisible="1"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},});assert.ok(calendar.$('.o_calendar_view').find('.fc-view-container').length,"should instance of fullcalendar");var $sidebar=calendar.$('.o_calendar_sidebar');assert.containsN(calendar,'.fc-event',9,"should display 9 events on the week (4 event + 5 days event)");assert.containsN($sidebar,'tr:has(.ui-state-active) td',7,"week scale should highlight 7 days in mini calendar");await testUtils.dom.click(calendar.$buttons.find('.o_calendar_button_day'));assert.containsN(calendar,'.fc-event',2,"should display 2 events on the day");assert.containsOnce($sidebar,'.o_selected_range',"should highlight the target day in mini calendar");await testUtils.dom.click(calendar.$buttons.find('.o_calendar_button_month'));assert.containsN(calendar,'.fc-event',7,"should display 7 events on the month (5 events + 2 week event - 1 'event 6' is filtered + 1 'Undefined event')");assert.containsN($sidebar,'td a',31,"month scale should highlight all days in mini calendar");assert.containsN($sidebar,'.o_calendar_filter',2,"should display 2 filters");var $typeFilter=$sidebar.find('.o_calendar_filter:has(h5:contains(user))');assert.ok($typeFilter.length,"should display 'user' filter");assert.containsN($typeFilter,'.o_calendar_filter_item',3,"should display 3 filter items for 'user'");assert.strictEqual($typeFilter.find('.o_calendar_filter_item:last').data('value'),false,"filters having false value should be displayed at last in filter items");assert.strictEqual($typeFilter.find('.o_calendar_filter_item:last .o_cw_filter_title').text(),"Undefined","filters having false value should display 'Undefined' string");assert.strictEqual($typeFilter.find('.o_calendar_filter_item:last label img').length,0,"filters having false value should not have any user image");var $attendeesFilter=$sidebar.find('.o_calendar_filter:has(h5:contains(attendees))');assert.ok($attendeesFilter.length,"should display 'attendees' filter");assert.containsN($attendeesFilter,'.o_calendar_filter_item',3,"should display 3 filter items for 'attendees' who use write_model (2 saved + Everything)");assert.ok($attendeesFilter.find('.o_field_many2one').length,"should display one2many search bar for 'attendees' filter");assert.containsN(calendar,'.fc-event',7,"should display 7 events ('event 5' counts for 2 because it spans two weeks and thus generate two fc-event elements)");await testUtils.dom.click(calendar.$('.o_calendar_filter input[type="checkbox"]').first());assert.containsN(calendar,'.fc-event',4,"should now only display 4 event");await testUtils.dom.click(calendar.$('.o_calendar_filter input[type="checkbox"]').eq(1));assert.containsNone(calendar,'.fc-event',"should not display any event anymore");await testUtils.dom.click($sidebar.find('input[type="text"]'));assert.strictEqual($('ul.ui-autocomplete li:not(.o_m2o_dropdown_option)').length,2,"should display 2 choices in one2many autocomplete");await testUtils.dom.click($('ul.ui-autocomplete li:first'));assert.containsN($sidebar,'.o_calendar_filter:has(h5:contains(attendees)) .o_calendar_filter_item',4,"should display 4 filter items for 'attendees'");await testUtils.dom.click($sidebar.find('input[type="text"]'));assert.strictEqual($('ul.ui-autocomplete li:not(.o_m2o_dropdown_option)').text(),"partner 4","should display the last choice in one2many autocomplete");await testUtils.dom.click($sidebar.find('.o_calendar_filter_item .o_remove').first(),{allowInvisible:true});assert.ok($('.modal-footer button.btn:contains(Ok)').length,"should display the confirm message");await testUtils.dom.click($('.modal-footer button.btn:contains(Ok)'));assert.containsN($sidebar,'.o_calendar_filter:has(h5:contains(attendees)) .o_calendar_filter_item',3,"click on remove then should display 3 filter items for 'attendees'");calendar.destroy();});QUnit.test('delete attribute on calendar doesn\'t show delete button in popover',async function(assert){assert.expect(2);const calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'delete="0" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},});await testUtils.dom.click(calendar.$('.fc-event:contains(event 4) .fc-content'));assert.containsOnce(calendar,'.o_cw_popover',"should open a popover clicking on event");assert.containsNone(calendar,'.o_cw_popover .o_cw_popover_delete',"should not have the 'Delete' Button");calendar.destroy();});QUnit.test('breadcrumbs are updated with the displayed period',async function(assert){assert.expect(4);var archs={'event,1,calendar':'<calendar date_start="start" date_stop="stop" all_day="allday"/>','event,false,search':'<search></search>',};var actions=[{id:1,flags:{initialDate:initialDate,},name:'Meetings Test',res_model:'event',type:'ir.actions.act_window',views:[[1,'calendar']],}];var actionManager=await createActionManager({actions:actions,archs:archs,data:this.data,});await actionManager.doAction(1);await testUtils.nextTick();assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Meetings Test (Dec 11 – 17, 2016)',"should display the current week");await testUtils.dom.click($('.o_control_panel .o_calendar_button_day'));assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Meetings Test (December 12, 2016)',"should display the current day");await testUtils.dom.click($('.o_control_panel .o_calendar_button_month'));assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Meetings Test (December 2016)',"should display the current month");await testUtils.dom.click($('.o_control_panel .o_calendar_button_year'));assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Meetings Test (2016)',"should display the current year");actionManager.destroy();});QUnit.test('create and change events',async function(assert){assert.expect(28);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="month"/>',archs:archs,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{name:'event 4 modified'},"should update the record");}
return this._super.apply(this,arguments);},viewOptions:{initialDate:initialDate,},});assert.ok(calendar.$('.fc-dayGridMonth-view').length,"should display in month mode");await testUtils.dom.click(calendar.$('.fc-event:contains(event 4) .fc-content'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");assert.ok(calendar.$('.o_cw_popover .o_cw_popover_edit').length,"popover should have an edit button");assert.ok(calendar.$('.o_cw_popover .o_cw_popover_delete').length,"popover should have a delete button");assert.ok(calendar.$('.o_cw_popover .o_cw_popover_close').length,"popover should have a close button");await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_edit'));assert.ok($('.modal-body').length,"should open the form view in dialog when click on event");await testUtils.fields.editInput($('.modal-body input:first'),'event 4 modified');await testUtils.dom.click($('.modal-footer button.btn:contains(Save)'));assert.notOk($('.modal-body').length,"save button should close the modal");var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();assert.ok($('.modal-sm').length,"should open the quick create dialog");await testUtils.fields.editInput($('.modal-body input:first'),'new event in quick create');await testUtils.dom.click($('.modal-footer button.btn:contains(Create)'));assert.strictEqual(calendar.$('.fc-event:contains(new event in quick create)').length,1,"should display the new record after quick create");assert.containsN(calendar,'td.fc-event-container[colspan]',2,"should the new record have only one day");testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();assert.ok($('.modal-sm').length,"should open the quick create dialog");await testUtils.fields.editInput($('.modal-body input:first'),'new event in quick create validated by pressing enter key.');$('.modal-body input:first').val('new event in quick create validated by pressing enter key.').trigger($.Event('keyup',{keyCode:$.ui.keyCode.ENTER})).trigger($.Event('keyup',{keyCode:$.ui.keyCode.ENTER}));await testUtils.nextTick();assert.containsOnce(calendar,'.fc-event:contains(new event in quick create validated by pressing enter key.)',"should display the new record by pressing enter key");$cell=calendar.$('.fc-day-grid .fc-row:eq(4) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();assert.strictEqual($('.modal-sm').length,1,"should open the quick create dialog");testUtils.fields.editInput($('.modal-body input:first'),'coucou');await testUtils.dom.click($('.modal-footer button.btn:contains(Edit)'));assert.strictEqual($('.modal-lg .o_form_view').length,1,"should open the slow create dialog");assert.strictEqual($('.modal-lg .modal-title').text(),"Create: Events","should use the string attribute as modal title");assert.strictEqual($('.modal-lg .o_form_view input[name="name"]').val(),"coucou","should have set the name from the quick create dialog");await testUtils.dom.click($('.modal-lg button.btn:contains(Save)'));assert.strictEqual(calendar.$('.fc-event:contains(coucou)').length,1,"should display the new record with string attribute");$cell=calendar.$('.fc-day-grid .fc-row:eq(3) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell.next(),"mousemove");testUtils.dom.triggerMouseEvent($cell.next(),"mouseup");await testUtils.nextTick();testUtils.fields.editInput($('.modal-dialog input:first'),'new event in quick create 2');await testUtils.dom.click($('.modal-footer button.btn:contains(Edit)'));assert.strictEqual($('.modal-lg input:first').val(),'new event in quick create 2',"should open the formViewDialog with default values");await testUtils.dom.click($('.modal-lg button.btn:contains(Save)'));assert.notOk($('.modal').length,"should close dialogs");var $newevent2=calendar.$('.fc-event:contains(new event in quick create 2)');assert.ok($newevent2.length,"should display the 2 days new record");assert.hasAttrValue($newevent2.closest('.fc-event-container'),'colspan',"2","the new record should have 2 days");await testUtils.dom.click(calendar.$('.fc-event:contains(new event in quick create 2) .fc-content'));var $popover_description=calendar.$('.o_cw_popover .o_cw_body .list-group-item');assert.strictEqual($popover_description.children()[1].textContent,'December 20-21, 2016',"The popover description should indicate the correct range");assert.strictEqual($popover_description.children()[2].textContent,'(2 days)',"The popover description should indicate 2 days");await testUtils.dom.click(calendar.$('.o_cw_popover .fa-close'));await testUtils.dom.click(calendar.$('.fc-event:contains(event 4) .fc-content'));await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_delete'));assert.ok($('.modal-footer button.btn:contains(Ok)').length,"should display the confirm message");await testUtils.dom.click($('.modal-footer button.btn:contains(Ok)'));assert.notOk(calendar.$('.fc-event:contains(event 4) .fc-content').length,"the record should be deleted");assert.containsN(calendar,'.fc-event-container .fc-event',10,"should display 10 events");await testUtils.dom.click(calendar.$buttons.find('.o_calendar_button_next'));assert.containsNone(calendar,'.fc-event-container .fc-event',"should display 0 events");calendar.destroy();});QUnit.test('quickcreate switching to actual create for required fields',async function(assert){assert.expect(4);var event=$.Event();var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="create"){return Promise.reject({message:{code:200,data:{},message:"Odoo server error",},event:event});}
return this._super(route,args);},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();assert.strictEqual($('.modal-sm .modal-title').text(),'Create: Events',"should open the quick create dialog");await testUtils.fields.editInput($('.modal-body input:first'),'new event in quick create');await testUtils.dom.click($('.modal-footer button.btn:contains(Create)'));await testUtils.nextTick();assert.ok(event.isDefaultPrevented(),"fail deferred event should have been default-prevented");assert.strictEqual($('.modal-lg .modal-title').text(),'Create: Events',"should have switched to a bigger modal for an actual create rather than quickcreate");assert.strictEqual($('.modal-lg main .o_form_view.o_form_editable').length,1,"should open the full event form view in a dialog");calendar.destroy();});QUnit.test('open multiple event form at the same time',async function(assert){assert.expect(2);var prom=testUtils.makeTestPromise();var counter=0;testUtils.mock.patch(ViewDialogs.FormViewDialog,{open:function(){counter++;this.options=_.omit(this.options,'fields_view');return this._super.apply(this,arguments);},loadFieldView:function(){var self=this;var args=arguments;var _super=this._super;return prom.then(function(){return _super.apply(self,args);});},});var event=$.Event();var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'event_open_popup="true" '+'date_start="start" '+'quick_add="False" '+'date_stop="stop" '+'all_day="allday" '+'mode="month">'+'<field name="name"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');for(var i=0;i<5;i++){await testUtils.dom.triggerMouseEvent($cell,"mousedown");await testUtils.dom.triggerMouseEvent($cell,"mouseup");}
prom.resolve();await testUtils.nextTick();assert.equal(counter,5,"there should had been 5 attemps to open a modal");assert.containsOnce($('body'),'.modal',"there should be only one open modal");calendar.destroy();});QUnit.test('create event with timezone in week mode European locale',async function(assert){assert.expect(5);this.data.event.records=[];var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week">'+'<field name="name"/>'+'<field name="start"/>'+'<field name="allday"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},translateParameters:{time_format:"%H:%M:%S",},mockRPC:function(route,args){if(args.method==="create"){assert.deepEqual(args.kwargs.context,{"default_start":"2016-12-13 06:00:00","default_stop":"2016-12-13 08:00:00","default_allday":null},"should send the context to create events");}
return this._super(route,args);},},{positionalClicks:true});var top=calendar.$('.fc-axis:contains(8:00)').offset().top+5;var left=calendar.$('.fc-day:eq(2)').offset().left+5;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mousemove");assert.strictEqual(calendar.$('.fc-content .fc-time').text(),"8:00 - 10:00","should display the time in the calendar sticker");await testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mouseup");await testUtils.nextTick();await testUtils.fields.editInput($('.modal input:first'),'new event');await testUtils.dom.click($('.modal button.btn:contains(Create)'));var $newevent=calendar.$('.fc-event:contains(new event)');assert.strictEqual($newevent.find('.o_event_title').text(),"new event","should display the new event with title");assert.deepEqual($newevent[0].fcSeg.eventRange.def.extendedProps.record,{display_name:"new event",start:fieldUtils.parse.datetime("2016-12-13 06:00:00",this.data.event.fields.start,{isUTC:true}),stop:fieldUtils.parse.datetime("2016-12-13 08:00:00",this.data.event.fields.stop,{isUTC:true}),allday:false,name:"new event",id:1},"the new record should have the utc datetime (quickCreate)");await testUtils.dom.click($newevent);await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_delete'));await testUtils.dom.click($('.modal button.btn-primary:contains(Ok)'));assert.containsNone(calendar,'.fc-content',"should delete the record");calendar.destroy();});QUnit.test('default week start (US)',function(assert){assert.expect(3);var done=assert.async();createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week">'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,[["start","<=","2016-12-17 23:59:59"],["stop",">=","2016-12-11 00:00:00"]],'The domain to search events in should be correct');}
return this._super.apply(this,arguments);}}).then(function(calendar){assert.strictEqual(calendar.$('.fc-day-header').first().text(),"Sun 11","The first day of the week should be Sunday");assert.strictEqual(calendar.$('.fc-day-header').last().text(),"Sat 17","The last day of the week should be Saturday");calendar.destroy();done();});});QUnit.test('European week start',function(assert){assert.expect(3);var done=assert.async();createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week">'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},translateParameters:{week_start:1,},mockRPC:function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,[["start","<=","2016-12-18 23:59:59"],["stop",">=","2016-12-12 00:00:00"]],'The domain to search events in should be correct');}
return this._super.apply(this,arguments);}}).then(function(calendar){assert.strictEqual(calendar.$('.fc-day-header').first().text(),"Mon 12","The first day of the week should be Monday");assert.strictEqual(calendar.$('.fc-day-header').last().text(),"Sun 18","The last day of the week should be Sunday");calendar.destroy();done();});});QUnit.test('week numbering',function(assert){assert.expect(1);var done=assert.async();createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week">'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},translateParameters:{week_start:7,},}).then(function(calendar){assert.strictEqual(calendar.$('.fc-week-number').text(),"Week 51","We should be on the 51st week");calendar.destroy();done();});});QUnit.test('render popover',async function(assert){assert.expect(14);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week">'+'<field name="name" string="Custom Name"/>'+'<field name="partner_id"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},});await testUtils.dom.click($('.fc-event:contains(event 4)'));assert.containsOnce(calendar,'.o_cw_popover',"should open a popover clicking on event");assert.strictEqual(calendar.$('.o_cw_popover .popover-header').text(),'event 4',"popover should have a title 'event 4'");assert.containsOnce(calendar,'.o_cw_popover .o_cw_popover_edit',"popover should have an edit button");assert.containsOnce(calendar,'.o_cw_popover .o_cw_popover_delete',"popover should have a delete button");assert.containsOnce(calendar,'.o_cw_popover .o_cw_popover_close',"popover should have a close button");assert.strictEqual(calendar.$('.o_cw_popover .list-group-item:first b.text-capitalize').text(),'Wednesday, December 14, 2016',"should display date 'Wednesday, December 14, 2016'");assert.containsN(calendar,'.o_cw_popover .o_cw_popover_fields_secondary .list-group-item',2,"popover should have a two fields");assert.containsOnce(calendar,'.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:first .o_field_char',"should apply char widget");assert.strictEqual(calendar.$('.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:first strong').text(),'Custom Name : ',"label should be a 'Custom Name'");assert.strictEqual(calendar.$('.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:first .o_field_char').text(),'event 4',"value should be a 'event 4'");assert.containsOnce(calendar,'.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:last .o_form_uri',"should apply m20 widget");assert.strictEqual(calendar.$('.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:last strong').text(),'user : ',"label should be a 'user'");assert.strictEqual(calendar.$('.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:last .o_form_uri').text(),'partner 1',"value should be a 'partner 1'");await testUtils.dom.click($('.o_cw_popover .o_cw_popover_close'));assert.containsNone(calendar,'.o_cw_popover',"should close a popover");calendar.destroy();});QUnit.test('render popover with modifiers',async function(assert){assert.expect(3);this.data.event.fields.priority={string:"Priority",type:"selection",selection:[['0','Normal'],['1','Important']],};var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week">'+'<field name="priority" widget="priority" readonly="1"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},});await testUtils.dom.click($('.fc-event:contains(event 4)'));assert.containsOnce(calendar,'.o_cw_popover',"should open a popover clicking on event");assert.containsOnce(calendar,'.o_cw_popover .o_priority span.o_priority_star',"priority field should not be editable");await testUtils.dom.click($('.o_cw_popover .o_cw_popover_close'));assert.containsNone(calendar,'.o_cw_popover',"should close a popover");calendar.destroy();});QUnit.test('attributes hide_date and hide_time',async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'hide_date="true" '+'hide_time="true" '+'mode="month">'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},});await testUtils.dom.click($('.fc-event:contains(event 4)'));assert.containsNone(calendar,'.o_cw_popover .list-group-item',"popover should not contain date/time");calendar.destroy();});QUnit.test('create event with timezone in week mode with formViewDialog European locale',async function(assert){assert.expect(8);this.data.event.records=[];this.data.event.onchanges={allday:function(obj){if(obj.allday){obj.start_date=obj.start&&obj.start.split(' ')[0]||obj.start_date;obj.stop_date=obj.stop&&obj.stop.split(' ')[0]||obj.stop_date||obj.start_date;}else{obj.start=obj.start_date&&(obj.start_date+' 00:00:00')||obj.start;obj.stop=obj.stop_date&&(obj.stop_date+' 00:00:00')||obj.stop||obj.start;}}};var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week">'+'<field name="name"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},translateParameters:{time_format:"%H:%M:%S",},mockRPC:function(route,args){if(args.method==="create"){assert.deepEqual(args.kwargs.context,{"default_name":"new event","default_start":"2016-12-13 06:00:00","default_stop":"2016-12-13 08:00:00","default_allday":null},"should send the context to create events");}
if(args.method==="write"){assert.deepEqual(args.args[1],expectedEvent,"should move the event");}
return this._super(route,args);},},{positionalClicks:true});var top=calendar.$('.fc-axis:contains(8:00)').offset().top+5;var left=calendar.$('.fc-day:eq(2)').offset().left+5;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mouseup");await testUtils.nextTick();await testUtils.fields.editInput($('.modal input:first'),'new event');await testUtils.dom.click($('.modal button.btn:contains(Edit)'));assert.strictEqual($('.o_field_widget[name="start"] input').val(),"12/13/2016 08:00:00","should display the datetime");await testUtils.dom.click($('.modal-lg .o_field_boolean[name="allday"] input'));await testUtils.nextTick();assert.strictEqual($('input[name="start_date"]').val(),"12/13/2016","should display the date");await testUtils.dom.click($('.modal-lg .o_field_boolean[name="allday"] input'));assert.strictEqual($('.o_field_widget[name="start"] input').val(),"12/13/2016 02:00:00","should display the datetime from the date with the timezone");testUtils.dom.openDatepicker($('.o_field_widget[name="start"].o_datepicker'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="togglePicker"]'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hours td.hour:contains(08)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="close"]'));testUtils.dom.openDatepicker($('.o_field_widget[name="stop"].o_datepicker'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="togglePicker"]'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hours td.hour:contains(10)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="close"]'));await testUtils.dom.click($('.modal-lg button.btn:contains(Save)'));var $newevent=calendar.$('.fc-event:contains(new event)');assert.strictEqual($newevent.find('.o_event_title').text(),"new event","should display the new event with title");assert.deepEqual($newevent[0].fcSeg.eventRange.def.extendedProps.record,{display_name:"new event",start:fieldUtils.parse.datetime("2016-12-13 06:00:00",this.data.event.fields.start,{isUTC:true}),stop:fieldUtils.parse.datetime("2016-12-13 08:00:00",this.data.event.fields.stop,{isUTC:true}),allday:false,name:"new event",id:1},"the new record should have the utc datetime (formViewDialog)");var pos=calendar.$('.fc-content').offset();left=pos.left+5;top=pos.top+5;var expectedEvent={"allday":false,"start":"2016-12-12 06:00:00","stop":"2016-12-12 08:00:00"};testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");left=calendar.$('.fc-day:eq(1)').offset().left+15;testUtils.dom.triggerPositionalMouseEvent(left,top,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top,"mouseup");await testUtils.nextTick();expectedEvent={"allday":true,"start":"2016-12-12 00:00:00","stop":"2016-12-12 00:00:00"};testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");top=calendar.$('.fc-day:eq(1)').offset().top+15;testUtils.dom.triggerPositionalMouseEvent(left,top,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top,"mouseup");await testUtils.nextTick();calendar.destroy();});QUnit.test('create event with timezone in week mode American locale',async function(assert){assert.expect(5);this.data.event.records=[];var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week">'+'<field name="name"/>'+'<field name="start"/>'+'<field name="allday"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},translateParameters:{time_format:"%I:%M:%S",},mockRPC:function(route,args){if(args.method==="create"){assert.deepEqual(args.kwargs.context,{"default_start":"2016-12-13 06:00:00","default_stop":"2016-12-13 08:00:00","default_allday":null},"should send the context to create events");}
return this._super(route,args);},},{positionalClicks:true});var top=calendar.$('.fc-axis:contains(8am)').offset().top+5;var left=calendar.$('.fc-day:eq(2)').offset().left+5;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mousemove");assert.strictEqual(calendar.$('.fc-content .fc-time').text(),"8:00 - 10:00","should display the time in the calendar sticker");testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mouseup");await testUtils.nextTick();testUtils.fields.editInput($('.modal input:first'),'new event');await testUtils.dom.click($('.modal button.btn:contains(Create)'));var $newevent=calendar.$('.fc-event:contains(new event)');assert.strictEqual($newevent.find('.o_event_title').text(),"new event","should display the new event with title");assert.deepEqual($newevent[0].fcSeg.eventRange.def.extendedProps.record,{display_name:"new event",start:fieldUtils.parse.datetime("2016-12-13 06:00:00",this.data.event.fields.start,{isUTC:true}),stop:fieldUtils.parse.datetime("2016-12-13 08:00:00",this.data.event.fields.stop,{isUTC:true}),allday:false,name:"new event",id:1},"the new record should have the utc datetime (quickCreate)");await testUtils.dom.click($newevent);await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_delete'));await testUtils.dom.click($('.modal button.btn-primary:contains(Ok)'));assert.containsNone(calendar,'.fc-content',"should delete the record");calendar.destroy();});QUnit.test('fetch event when being in timezone',async function(assert){assert.expect(3);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week" >'+'<field name="name"/>'+'<field name="start"/>'+'<field name="allday"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 660;},},mockRPC:async function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,[["start","<=","2016-12-17 12:59:59"],["stop",">=","2016-12-10 13:00:00"]],'The domain should contain the right range');}
return this._super(route,args);},});assert.strictEqual(calendar.$('.fc-day-header:first').text(),'Sun 11','The calendar start date should be 2016-12-11');assert.strictEqual(calendar.$('.fc-day-header:last()').text(),'Sat 17','The calendar start date should be 2016-12-17');calendar.destroy();});QUnit.test('create event with timezone in week mode with formViewDialog American locale',async function(assert){assert.expect(8);this.data.event.records=[];this.data.event.onchanges={allday:function(obj){if(obj.allday){obj.start_date=obj.start&&obj.start.split(' ')[0]||obj.start_date;obj.stop_date=obj.stop&&obj.stop.split(' ')[0]||obj.stop_date||obj.start_date;}else{obj.start=obj.start_date&&(obj.start_date+' 00:00:00')||obj.start;obj.stop=obj.stop_date&&(obj.stop_date+' 00:00:00')||obj.stop||obj.start;}}};var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week">'+'<field name="name"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},translateParameters:{time_format:"%I:%M:%S",},mockRPC:function(route,args){if(args.method==="create"){assert.deepEqual(args.kwargs.context,{"default_name":"new event","default_start":"2016-12-13 06:00:00","default_stop":"2016-12-13 08:00:00","default_allday":null},"should send the context to create events");}
if(args.method==="write"){assert.deepEqual(args.args[1],expectedEvent,"should move the event");}
return this._super(route,args);},},{positionalClicks:true});var top=calendar.$('.fc-axis:contains(8am)').offset().top+5;var left=calendar.$('.fc-day:eq(2)').offset().left+5;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top+60,"mouseup");await testUtils.nextTick();testUtils.fields.editInput($('.modal input:first'),'new event');await testUtils.dom.click($('.modal button.btn:contains(Edit)'));assert.strictEqual($('.o_field_widget[name="start"] input').val(),"12/13/2016 08:00:00","should display the datetime");await testUtils.dom.click($('.modal-lg .o_field_boolean[name="allday"] input'));assert.strictEqual($('.o_field_widget[name="start_date"] input').val(),"12/13/2016","should display the date");await testUtils.dom.click($('.modal-lg .o_field_boolean[name="allday"] input'));assert.strictEqual($('.o_field_widget[name="start"] input').val(),"12/13/2016 02:00:00","should display the datetime from the date with the timezone");testUtils.dom.openDatepicker($('.o_field_widget[name="start"].o_datepicker'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="togglePicker"]'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hours td.hour:contains(08)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="close"]'));testUtils.dom.openDatepicker($('.o_field_widget[name="stop"].o_datepicker'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="togglePicker"]'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hours td.hour:contains(10)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="close"]'));await testUtils.dom.click($('.modal-lg button.btn:contains(Save)'));var $newevent=calendar.$('.fc-event:contains(new event)');assert.strictEqual($newevent.find('.o_event_title').text(),"new event","should display the new event with title");assert.deepEqual($newevent[0].fcSeg.eventRange.def.extendedProps.record,{display_name:"new event",start:fieldUtils.parse.datetime("2016-12-13 06:00:00",this.data.event.fields.start,{isUTC:true}),stop:fieldUtils.parse.datetime("2016-12-13 08:00:00",this.data.event.fields.stop,{isUTC:true}),allday:false,name:"new event",id:1},"the new record should have the utc datetime (formViewDialog)");var pos=calendar.$('.fc-content').offset();left=pos.left+5;top=pos.top+5;var expectedEvent={"allday":false,"start":"2016-12-12 06:00:00","stop":"2016-12-12 08:00:00"};testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");left=calendar.$('.fc-day:eq(1)').offset().left+15;testUtils.dom.triggerPositionalMouseEvent(left,top,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top,"mouseup");await testUtils.nextTick();expectedEvent={"allday":true,"start":"2016-12-12 00:00:00","stop":"2016-12-12 00:00:00"};testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");top=calendar.$('.fc-day:eq(1)').offset().top+15;testUtils.dom.triggerPositionalMouseEvent(left,top,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top,"mouseup");await testUtils.nextTick();calendar.destroy();});QUnit.test('check calendar week column timeformat',async function(assert){assert.expect(2);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar date_start="start"/>',archs:archs,viewOptions:{initialDate:initialDate,},translateParameters:{time_format:"%I:%M:%S",},});assert.strictEqual(calendar.$('.fc-axis:contains(8am)').length,1,"calendar should show according to timeformat");assert.strictEqual(calendar.$('.fc-axis:contains(11pm)').length,1,"event time format should 12 hour");calendar.destroy();});QUnit.test('create all day event in week mode',async function(assert){assert.expect(3);this.data.event.records=[];var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week">'+'<field name="name"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},},{positionalClicks:true});var pos=calendar.$('.fc-bg td:eq(4)').offset();try{testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
pos=calendar.$('.fc-bg td:eq(5)').offset();testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousemove");testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mouseup");await testUtils.nextTick();testUtils.fields.editInput($('.modal input:first'),'new event');await testUtils.dom.click($('.modal button.btn:contains(Create)'));var $newevent=calendar.$('.fc-event:contains(new event)');assert.strictEqual($newevent.text().replace(/[\s\n\r]+/g,''),"newevent","should display the new event with time and title");assert.hasAttrValue($newevent.parent(),'colspan',"2","should appear over two days.");assert.deepEqual($newevent[0].fcSeg.eventRange.def.extendedProps.record,{display_name:"new event",start:fieldUtils.parse.datetime("2016-12-14 00:00:00",this.data.event.fields.start,{isUTC:true}),stop:fieldUtils.parse.datetime("2016-12-15 00:00:00",this.data.event.fields.stop,{isUTC:true}),allday:true,name:"new event",id:1},"the new record should have the utc datetime (quickCreate)");calendar.destroy();});QUnit.test('create event with default context (no quickCreate)',async function(assert){assert.expect(3);this.data.event.records=[];const calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`<calendar
                class="o_calendar_test"
                date_start="start"
                date_stop="stop"
                mode="week"
                all_day="allday"
                quick_add="False"/>`,archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset(){return 120;},},context:{default_name:'New',},intercepts:{do_action(ev){assert.step('do_action');assert.deepEqual(ev.data.action.context,{default_name:"New",default_start:"2016-12-14 00:00:00",default_stop:"2016-12-15 00:00:00",default_allday:true,},"should send the correct data to create events");},},},{positionalClicks:true});var pos=calendar.$('.fc-bg td:eq(4)').offset();try{testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
pos=calendar.$('.fc-bg td:eq(5)').offset();testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousemove");testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mouseup");assert.verifySteps(['do_action']);calendar.destroy();});QUnit.test('create all day event in week mode (no quickCreate)',async function(assert){assert.expect(1);this.data.event.records=[];var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week" '+'all_day="allday" '+'quick_add="False"/>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},intercepts:{do_action:function(event){assert.deepEqual(event.data.action.context,{default_start:"2016-12-14 00:00:00",default_stop:"2016-12-15 00:00:00",default_allday:true,},"should send the correct data to create events");},},},{positionalClicks:true});var pos=calendar.$('.fc-bg td:eq(4)').offset();try{testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
pos=calendar.$('.fc-bg td:eq(5)').offset();testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousemove");testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mouseup");calendar.destroy();});QUnit.test('create event in month mode',async function(assert){assert.expect(4);this.data.event.records=[];var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'mode="month">'+'<field name="name"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},mockRPC:function(route,args){if(args.method==="create"){assert.deepEqual(args.args[0],{"name":"new event","start":"2016-12-14 05:00:00","stop":"2016-12-15 17:00:00",},"should send the correct data to create events");}
return this._super(route,args);},},{positionalClicks:true});var pos=calendar.$('.fc-bg td:eq(17)').offset();try{testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
pos=calendar.$('.fc-bg td:eq(18)').offset();testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mousemove");testUtils.dom.triggerPositionalMouseEvent(pos.left+15,pos.top+15,"mouseup");await testUtils.nextTick();testUtils.fields.editInput($('.modal input:first'),'new event');await testUtils.dom.click($('.modal button.btn:contains(Create)'));var $newevent=calendar.$('.fc-event:contains(new event)');assert.strictEqual($newevent.text().replace(/[\s\n\r]+/g,''),"newevent","should display the new event with time and title");assert.hasAttrValue($newevent.parent(),'colspan',"2","should appear over two days.");assert.deepEqual($newevent[0].fcSeg.eventRange.def.extendedProps.record,{display_name:"new event",start:fieldUtils.parse.datetime("2016-12-14 05:00:00",this.data.event.fields.start,{isUTC:true}),stop:fieldUtils.parse.datetime("2016-12-15 17:00:00",this.data.event.fields.stop,{isUTC:true}),name:"new event",id:1},"the new record should have the utc datetime (quickCreate)");calendar.destroy();});QUnit.test('use mini calendar',async function(assert){assert.expect(12);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week"/>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return 120;},},});assert.containsOnce(calendar,'.fc-timeGridWeek-view',"should be in week mode");assert.containsN(calendar,'.fc-event',9,"should display 9 events on the week (4 event + 5 days event)");await testUtils.dom.click(calendar.$('.o_calendar_mini a:contains(19)'));assert.containsOnce(calendar,'.fc-timeGridWeek-view',"should be in week mode");assert.containsN(calendar,'.fc-event',4,"should display 4 events on the week (1 event + 3 days event)");await testUtils.dom.click(calendar.$('.o_calendar_mini a:contains(18)'));assert.containsOnce(calendar,'.fc-timeGridDay-view',"should be in day mode");assert.containsN(calendar,'.fc-event',2,"should display 2 events on the day");await testUtils.dom.click(calendar.$('.o_calendar_mini a:contains(18)'));assert.containsOnce(calendar,'.fc-dayGridMonth-view',"should be in month mode");assert.containsN(calendar,'.fc-event',7,"should display 7 events on the month (event 5 is on multiple weeks and generates to .fc-event)");await testUtils.dom.click(calendar.$('.o_calendar_mini a:contains(18)'));assert.containsOnce(calendar,'.fc-timeGridWeek-view',"should be in week mode");assert.containsN(calendar,'.fc-event',4,"should display 4 events on the week (1 event + 3 days event)");await testUtils.dom.click(calendar.$('.o_calendar_mini a:contains(18)'));assert.containsOnce(calendar,'.fc-timeGridDay-view',"should be in day mode");assert.containsN(calendar,'.fc-event',2,"should display 2 events on the day");calendar.destroy();});QUnit.test('rendering, with many2many',async function(assert){assert.expect(5);this.data.event.fields.partner_ids.type='many2many';this.data.event.records[0].partner_ids=[1,2,3,4,5];this.data.partner.records.push({id:5,display_name:"partner 5",image:'EEE'});var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday"> '+'<field name="partner_ids" widget="many2many_tags_avatar" avatar_field="image" write_model="filter_partner" write_field="partner_id"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},});assert.containsN(calendar,'.o_calendar_filter_items .o_cw_filter_avatar',3,"should have 3 avatars in the side bar");await testUtils.dom.click(calendar.$('.fc-event:first'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");assert.strictEqual(calendar.$('.o_cw_popover').find('img').length,1,"should have 1 avatar");await testUtils.dom.click(calendar.$('.fc-event:eq(1)'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");assert.strictEqual(calendar.$('.o_cw_popover').find('img').length,5,"should have 5 avatar");calendar.destroy();});QUnit.test('open form view',async function(assert){assert.expect(3);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="get_formview_id"){return Promise.resolve('A view');}
return this._super(route,args);},});testUtils.mock.intercept(calendar,'do_action',function(event){assert.deepEqual(event.data.action,{type:"ir.actions.act_window",res_id:4,res_model:"event",views:[['A view',"form"]],target:"current",context:{}},"should open the form view");});await testUtils.dom.click(calendar.$('.fc-event:contains(event 4) .fc-content'));await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_edit'));var $cell=calendar.$('.fc-day-grid .fc-row:eq(4) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();testUtils.fields.editInput($('.modal-body input:first'),'coucou');testUtils.mock.intercept(calendar,'do_action',function(event){assert.deepEqual(event.data.action,{type:"ir.actions.act_window",res_model:"event",views:[[false,"form"]],target:"current",context:{"default_name":"coucou","default_start":"2016-12-27 00:00:00","default_stop":"2016-12-27 00:00:00","default_allday":true}},"should open the form view with the context default values");});testUtils.dom.click($('.modal button.btn:contains(Edit)'));calendar.destroy();assert.strictEqual($('#ui-datepicker-div:empty').length,0,"should have a clean body");});QUnit.test('create and edit event in month mode (all_day: false)',async function(assert){assert.expect(2);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'date_start="start" '+'date_stop="stop" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return-240;},},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(4) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();await testUtils.fields.editInput($('.modal-body input:first'),'coucou');testUtils.mock.intercept(calendar,'do_action',function(event){assert.deepEqual(event.data.action,{type:"ir.actions.act_window",res_model:"event",views:[[false,"form"]],target:"current",context:{"default_name":"coucou","default_start":"2016-12-27 11:00:00","default_stop":"2016-12-27 23:00:00",}},"should open the form view with the context default values");});await testUtils.dom.click($('.modal button.btn:contains(Edit)'));calendar.destroy();assert.strictEqual($('#ui-datepicker-div:empty').length,0,"should have a clean body");});QUnit.test('show start time of single day event for month mode',async function(assert){assert.expect(4);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return-240;},},});assert.strictEqual(calendar.$('.fc-event:contains(event 2) .fc-content .fc-time').text(),"06:55","should have a correct time 06:55 AM in month mode");assert.strictEqual(calendar.$('.fc-event:contains(event 4) .fc-content .fc-time').text(),"","should not display a time for all day event");assert.strictEqual(calendar.$('.fc-event:contains(event 5) .fc-content .fc-time').text(),"","should not display a time for multiple days event");await testUtils.dom.click(calendar.$('.o_calendar_button_week'));assert.strictEqual(calendar.$('.fc-event:contains(event 2) .fc-content .fc-time').text(),"","should not show time in week mode as week mode already have time on y-axis");calendar.destroy();});QUnit.test('start time should not shown for date type field',async function(assert){assert.expect(1);this.data.event.fields.start.type="date";var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'date_start="start" '+'date_stop="stop" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return-240;},},});assert.strictEqual(calendar.$('.fc-event:contains(event 2) .fc-content .fc-time').text(),"","should not show time for date type field");calendar.destroy();});QUnit.test('start time should not shown in month mode if hide_time is true',async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'date_start="start" '+'date_stop="stop" '+'hide_time="True" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return-240;},},});assert.strictEqual(calendar.$('.fc-event:contains(event 2) .fc-content .fc-time').text(),"","should not show time for hide_time attribute");calendar.destroy();});QUnit.test('readonly date_start field',async function(assert){assert.expect(4);this.data.event.fields.start.readonly=true;var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="get_formview_id"){return Promise.resolve(false);}
return this._super(route,args);},});assert.containsNone(calendar,'.fc-resizer',"should not have resize button");testUtils.mock.intercept(calendar,'do_action',function(event){assert.deepEqual(event.data.action,{type:"ir.actions.act_window",res_id:4,res_model:"event",views:[[false,"form"]],target:"current",context:{}},"should open the form view");});await testUtils.dom.click(calendar.$('.fc-event:contains(event 4) .fc-content'));await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_edit'));var $cell=calendar.$('.fc-day-grid .fc-row:eq(4) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();await testUtils.fields.editInput($('.modal-body input:first'),'coucou');testUtils.mock.intercept(calendar,'do_action',function(event){assert.deepEqual(event.data.action,{type:"ir.actions.act_window",res_model:"event",views:[[false,"form"]],target:"current",context:{"default_name":"coucou","default_start":"2016-12-27 00:00:00","default_stop":"2016-12-27 00:00:00","default_allday":true}},"should open the form view with the context default values");});await testUtils.dom.click($('.modal button.btn:contains(Edit)'));calendar.destroy();assert.strictEqual($('#ui-datepicker-div:empty').length,0,"should have a clean body");});QUnit.test('"all" filter',async function(assert){assert.expect(6);var interval=[["start","<=","2016-12-17 23:59:59"],["stop",">=","2016-12-11 00:00:00"],];var domains=[interval.concat([["partner_ids","in",[2,1]]]),interval.concat([["partner_ids","in",[1]]]),interval,];var i=0;var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'</calendar>',viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,domains[i]);i++;}
return this._super.apply(this,arguments);},});assert.containsN(calendar,'.fc-event',9,"should display 9 events on the week");await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-id=2] input'));assert.containsN(calendar,'.fc-event',4,"should display 4 events on the week");await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-value=all] input'));assert.containsN(calendar,'.fc-event',9,"should display 9 events on the week");calendar.destroy();});QUnit.test('Add filters and specific color',async function(assert){assert.expect(5);this.data.event.records.push({id:8,user_id:4,partner_id:1,name:"event 8",start:"2016-12-11 09:00:00",stop:"2016-12-11 10:00:00",allday:false,partner_ids:[1,2,3],event_type_id:3,color:4},{id:9,user_id:4,partner_id:1,name:"event 9",start:"2016-12-11 19:00:00",stop:"2016-12-11 20:00:00",allday:false,partner_ids:[1,2,3],event_type_id:1,color:1},);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week" '+'color="color">'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'<field name="event_type_id" filters="1" color="color"/>'+'</calendar>',viewOptions:{initialDate:initialDate,},});assert.containsN(calendar,'.o_calendar_filter',2,"should display 2 filters");var $typeFilter=calendar.$('.o_calendar_filter:has(h5:contains(Event_Type))');assert.ok($typeFilter.length,"should display 'Event Type' filter");assert.containsN($typeFilter,'.o_calendar_filter_item',3,"should display 3 filter items for 'Event Type'");assert.containsOnce($typeFilter,'.o_calendar_filter_item[data-value=3].o_cw_filter_color_4',"Filter for event type 3 must have the color 4");assert.containsOnce(calendar,'.fc-event[data-event-id=8].o_calendar_color_4',"Event of event type 3 must have the color 4");calendar.destroy();});QUnit.test('create event with filters',async function(assert){assert.expect(7);this.data.event.fields.user_id.default=5;this.data.event.fields.partner_id.default=3;this.data.user.records.push({id:5,display_name:"user 5",partner_id:3});var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'<field name="partner_id" filters="1" invisible="1"/>'+'</calendar>',viewOptions:{initialDate:initialDate,},},{positionalClicks:true});await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-value=4] input'));assert.containsN(calendar,'.o_calendar_filter_item',5,"should display 5 filter items");assert.containsN(calendar,'.fc-event',3,"should display 3 events");var left=calendar.$('.fc-bg td:eq(4)').offset().left+15;var top=calendar.$('.fc-slats tr:eq(12) td:first').offset().top+15;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
testUtils.dom.triggerPositionalMouseEvent(left,top+200,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top+200,"mouseup");await testUtils.nextTick();await testUtils.fields.editInput($('.modal-body input:first'),'coucou');await testUtils.dom.click($('.modal-footer button.btn:contains(Create)'));assert.containsN(calendar,'.o_calendar_filter_item',6,"should add the missing filter (active)");assert.containsN(calendar,'.fc-event',4,"should display the created item");await testUtils.nextTick();this.data.event.fields.user_id.default=4;this.data.event.fields.partner_id.default=4;left=calendar.$('.fc-bg td:eq(3)').offset().left+15;top=calendar.$('.fc-slats tr:eq(12) td:first').offset().top+15;testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");testUtils.dom.triggerPositionalMouseEvent(left,top+200,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top+200,"mouseup");await testUtils.nextTick();testUtils.fields.editInput($('.modal-body input:first'),'coucou 2');await testUtils.dom.click($('.modal-footer button.btn:contains(Create)'));assert.containsN(calendar,'.o_calendar_filter_item',6,"should have the same filters");assert.containsN(calendar,'.fc-event',4,"should not display the created item");await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-value=4] input'));assert.containsN(calendar,'.fc-event',11,"should display all records");calendar.destroy();});QUnit.test('create event with filters (no quickCreate)',async function(assert){assert.expect(4);this.data.event.fields.user_id.default=5;this.data.event.fields.partner_id.default=3;this.data.user.records.push({id:5,display_name:"user 5",partner_id:3});var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'<field name="partner_id" filters="1" invisible="1"/>'+'</calendar>',archs:{"event,false,form":'<form>'+'<group>'+'<field name="name"/>'+'<field name="start"/>'+'<field name="stop"/>'+'<field name="user_id"/>'+'<field name="partner_id" invisible="1"/>'+'</group>'+'</form>',},viewOptions:{initialDate:initialDate,},},{positionalClicks:true});await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-value=4] input'));assert.containsN(calendar,'.o_calendar_filter_item',5,"should display 5 filter items");assert.containsN(calendar,'.fc-event',3,"should display 3 events");await testUtils.nextTick();var left=calendar.$('.fc-bg td:eq(4)').offset().left+15;var top=calendar.$('.fc-slats tr:eq(12) td:first').offset().top+15;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
testUtils.dom.triggerPositionalMouseEvent(left,top+200,"mousemove");testUtils.dom.triggerPositionalMouseEvent(left,top+200,"mouseup");await testUtils.nextTick();await testUtils.fields.editInput($('.modal-body input:first'),'coucou');await testUtils.dom.click($('.modal-footer button.btn:contains(Edit)'));await testUtils.dom.click($('.modal-footer button.btn:contains(Save)'));assert.containsN(calendar,'.o_calendar_filter_item',6,"should add the missing filter (active)");assert.containsN(calendar,'.fc-event',4,"should display the created item");calendar.destroy();});QUnit.test('Update event with filters',async function(assert){assert.expect(6);var records=this.data.user.records;records.push({id:5,display_name:"user 5",partner_id:3});this.data.event.onchanges={user_id:function(obj){obj.partner_id=_.findWhere(records,{id:obj.user_id}).partner_id;}};var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'<field name="partner_id" filters="1" invisible="1"/>'+'</calendar>',archs:{"event,false,form":'<form>'+'<group>'+'<field name="name"/>'+'<field name="start"/>'+'<field name="stop"/>'+'<field name="user_id"/>'+'<field name="partner_ids" widget="many2many_tags"/>'+'</group>'+'</form>',},viewOptions:{initialDate:initialDate,},});await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-value=4] input'));assert.containsN(calendar,'.o_calendar_filter_item',5,"should display 5 filter items");assert.containsN(calendar,'.fc-event',3,"should display 3 events");await testUtils.dom.click(calendar.$('.fc-event:contains(event 2) .fc-content'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_edit'));assert.strictEqual($('.modal .modal-title').text(),'Open: event 2',"dialog should have a valid title");await testUtils.dom.click($('.modal .o_field_widget[name="user_id"] input'));await testUtils.dom.click($('.ui-menu-item a:contains(user 5)').trigger('mouseenter'));await testUtils.dom.click($('.modal button.btn:contains(Save)'));assert.containsN(calendar,'.o_calendar_filter_item',6,"should add the missing filter (active)");assert.containsN(calendar,'.fc-event',3,"should display the updated item");calendar.destroy();});QUnit.test('change pager with filters',async function(assert){assert.expect(3);this.data.user.records.push({id:5,display_name:"user 5",partner_id:3});this.data.event.records.push({id:8,user_id:5,partner_id:3,name:"event 8",start:"2016-12-06 04:00:00",stop:"2016-12-06 08:00:00",allday:false,partner_ids:[1,2,3],type:1},{id:9,user_id:session.uid,partner_id:1,name:"event 9",start:"2016-12-07 04:00:00",stop:"2016-12-07 08:00:00",allday:false,partner_ids:[1,2,3],type:1},{id:10,user_id:4,partner_id:4,name:"event 10",start:"2016-12-08 04:00:00",stop:"2016-12-08 08:00:00",allday:false,partner_ids:[1,2,3],type:1});var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'<field name="partner_id" filters="1" invisible="1"/>'+'</calendar>',viewOptions:{initialDate:initialDate,},});await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-value=4] input'));await testUtils.dom.click($('.o_calendar_button_prev'));assert.containsN(calendar,'.o_calendar_filter_item',6,"should display 6 filter items");assert.containsN(calendar,'.fc-event',2,"should display 2 events");assert.strictEqual(calendar.$('.fc-event .o_event_title').text().replace(/\s/g,''),"event8event9","should display 2 events");calendar.destroy();});QUnit.test('ensure events are still shown if filters give an empty domain',async function(assert){assert.expect(2);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar mode="week" date_start="start">'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'</calendar>',viewOptions:{initialDate:initialDate,},});assert.containsN(calendar,'.fc-event',5,"should display 5 events");await testUtils.dom.click(calendar.$('.o_calendar_filter_item[data-value=all] input[type=checkbox]'));assert.containsN(calendar,'.fc-event',5,"should display 5 events");calendar.destroy();});QUnit.test('events starting at midnight',async function(assert){assert.expect(3);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar mode="week" date_start="start"/>',viewOptions:{initialDate:initialDate,},translateParameters:{time_format:"%H:%M:%S",},},{positionalClicks:true});assert.ok(calendar.$('.fc-scroller')[0].scrollTop>0,"should scroll to 6:00 by default (this is true at least for resolutions up to 1900x1600)");calendar.$('.fc-scroller')[0].scrollTop=0;var top=calendar.$('.fc-axis:contains(0:00)').offset().top+5;var left=calendar.$('.fc-day:eq(2)').offset().left+5;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");testUtils.dom.triggerPositionalMouseEvent(left,top,"mouseup");await testUtils.nextTick();}catch(e){calendar.destroy();throw new Error('The test failed to simulate a click on the screen.'+'Your screen is probably too small or your dev tools are open.');}
assert.ok($('.modal-dialog.modal-sm').length,"should open the quick create dialog");testUtils.fields.editInput($('.modal-body input:first'),'new event in quick create');await testUtils.dom.click($('.modal-footer button.btn:contains(Create)'));assert.strictEqual(calendar.$('.fc-event:contains(new event in quick create)').length,1,"should display the new record after quick create dialog");calendar.destroy();});QUnit.test('set event as all day when field is date',async function(assert){assert.expect(2);this.data.event.records[0].start_date="2016-12-14";var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start_date" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return-480;}},});assert.containsOnce(calendar,'.fc-day-grid .fc-event-container',"should be one event in the all day row");assert.strictEqual(moment(calendar.model.data.data[0].r_start).date(),14,"the date should be 14");calendar.destroy();});QUnit.test('set event as all day when field is date (without all_day mapping)',async function(assert){assert.expect(1);this.data.event.records[0].start_date="2016-12-14";var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`<calendar date_start="start_date" mode="week"></calendar>`,archs:archs,viewOptions:{initialDate:initialDate,},});assert.containsOnce(calendar,'.fc-day-grid .fc-event-container',"should be one event in the all day row");calendar.destroy();});QUnit.test('quickcreate avoid double event creation',async function(assert){assert.expect(1);var createCount=0;var prom=testUtils.makeTestPromise();var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){var result=this._super(route,args);if(args.method==="create"){createCount++;return prom.then(_.constant(result));}
return result;},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();var $input=$('.modal input:first');await testUtils.fields.editInput($input,'new event in quick create');$input.trigger($.Event('keyup',{which:$.ui.keyCode.ENTER,keyCode:$.ui.keyCode.ENTER,}));await testUtils.nextTick();await testUtils.dom.click($('.modal-footer button:first'));prom.resolve();await testUtils.nextTick();assert.strictEqual(createCount,1,"should create only one event");calendar.destroy();});QUnit.test('check if the view destroys all widgets and instances',async function(assert){assert.expect(2);var instanceNumber=0;testUtils.mock.patch(mixins.ParentedMixin,{init:function(){instanceNumber++;return this._super.apply(this,arguments);},destroy:function(){if(!this.isDestroyed()){instanceNumber--;}
return this._super.apply(this,arguments);}});var params={View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'event_open_popup="true" '+'date_start="start_date" '+'all_day="allday" '+'mode="week" '+'attendee="partner_ids" '+'color="partner_id">'+'<filter name="user_id" avatar_field="image"/>'+'<field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},};var calendar=await createCalendarView(params);assert.ok(instanceNumber>0);calendar.destroy();assert.strictEqual(instanceNumber,0);testUtils.mock.unpatch(mixins.ParentedMixin);});QUnit.test('create an event (async dialog) [REQUIRE FOCUS]',async function(assert){assert.expect(3);var prom=testUtils.makeTestPromise();testUtils.mock.patch(Dialog,{open:function(){var _super=this._super.bind(this);prom.then(_super);return this;},});var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'event_open_popup="true" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();assert.strictEqual($('.modal').length,0,"should not have opened the dialog yet");prom.resolve();await testUtils.nextTick();assert.strictEqual($('.modal').length,1,"should have opened the dialog");assert.strictEqual($('.modal input')[0],document.activeElement,"should focus the input in the dialog");calendar.destroy();testUtils.mock.unpatch(Dialog);});QUnit.test('calendar is configured to have no groupBy menu',async function(assert){assert.expect(1);var archs={'event,1,calendar':'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'all_day="allday"/>','event,false,search':'<search></search>',};var actions=[{id:1,name:'some action',res_model:'event',type:'ir.actions.act_window',views:[[1,'calendar']]}];var actionManager=await createActionManager({actions:actions,archs:archs,data:this.data,});await actionManager.doAction(1);assert.containsNone(actionManager.$('.o_control_panel .o_search_options span.fa.fa-bars'),"the control panel has no groupBy menu");actionManager.destroy();});QUnit.test('timezone does not affect current day',async function(assert){assert.expect(2);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar date_start="start_date"/>',archs:archs,viewOptions:{initialDate:initialDate,},session:{getTZOffset:function(){return-2400;},},});var $sidebar=calendar.$('.o_calendar_sidebar');assert.strictEqual($sidebar.find('.ui-datepicker-current-day').text(),"12","should highlight the target day");await testUtils.dom.click($sidebar.find('.ui-datepicker-current-day').prev());assert.strictEqual($sidebar.find('.ui-datepicker-current-day').text(),"11","should highlight the selected day");calendar.destroy();});QUnit.test('timezone does not affect drag and drop',async function(assert){assert.expect(10);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar date_start="start" mode="month">'+'<field name="name"/>'+'<field name="start"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="write"){assert.deepEqual(args.args[0],[6],"event 6 is moved")
assert.deepEqual(args.args[1].start,"2016-11-29 08:00:00","event moved to 27th nov 16h00 +40 hours timezone")}
return this._super(route,args);},session:{getTZOffset:function(){return-2400;},},});assert.strictEqual(calendar.$('.fc-event:eq(0)').text().replace(/\s/g,''),"08:00event1");await testUtils.dom.click(calendar.$('.fc-event:eq(0)'));assert.strictEqual(calendar.$('.o_field_widget[name="start"]').text(),"12/09/2016 08:00:00");assert.strictEqual(calendar.$('.fc-event:eq(5)').text().replace(/\s/g,''),"16:00event6");await testUtils.dom.click(calendar.$('.fc-event:eq(5)'));assert.strictEqual(calendar.$('.o_field_widget[name="start"]').text(),"12/16/2016 16:00:00");await testUtils.dragAndDrop(calendar.$('.fc-event').eq(5),calendar.$('.fc-day-top').first());await testUtils.nextTick();assert.strictEqual(calendar.$('.fc-event:eq(0)').text().replace(/\s/g,''),"16:00event6");await testUtils.dom.click(calendar.$('.fc-event:eq(0)'));assert.strictEqual(calendar.$('.o_field_widget[name="start"]').text(),"11/27/2016 16:00:00");assert.strictEqual(calendar.$('.fc-event:eq(1)').text().replace(/\s/g,''),"08:00event1");await testUtils.dom.click(calendar.$('.fc-event:eq(1)'));assert.strictEqual(calendar.$('.o_field_widget[name="start"]').text(),"12/09/2016 08:00:00");calendar.destroy();});QUnit.test('timzeone does not affect calendar with date field',async function(assert){assert.expect(11);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar date_start="start_date" mode="month">'+'<field name="name"/>'+'<field name="start_date"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="create"){assert.strictEqual(args.args[0].start_date,"2016-12-20 00:00:00");}
if(args.method==="write"){assert.step(args.args[1].start_date);}
return this._super(route,args);},session:{getTZOffset:function(){return 120;},},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(3) .fc-day:eq(2)');await testUtils.triggerMouseEvent($cell,"mousedown");await testUtils.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();var $input=$('.modal-body input:first');await testUtils.fields.editInput($input,"An event");await testUtils.dom.click($('.modal button.btn:contains(Create)'));await testUtils.nextTick();await testUtils.dom.click(calendar.$('.fc-event:contains(An event)'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");assert.strictEqual(calendar.$('.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:last .o_field_date').text(),'12/20/2016',"should have correct start date");await testUtils.dragAndDrop(calendar.$('.fc-event').first(),calendar.$('.fc-day-top').first());await testUtils.nextTick();assert.verifySteps(["2016-11-27 00:00:00"]);await testUtils.dom.click(calendar.$('.fc-event:contains(An event)'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");assert.strictEqual(calendar.$('.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:last .o_field_date').text(),'11/27/2016',"should have correct start date");await testUtils.dragAndDrop(calendar.$('.fc-event').first(),calendar.$('.fc-day-top').last());await testUtils.nextTick();assert.verifySteps(["2017-01-07 00:00:00"]);await testUtils.dom.click(calendar.$('.fc-event:contains(An event)'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");assert.strictEqual(calendar.$('.o_cw_popover .o_cw_popover_fields_secondary .list-group-item:last .o_field_date').text(),'01/07/2017',"should have correct start date");calendar.destroy();});QUnit.test("drag and drop on month mode",async function(assert){assert.expect(2);const calendar=await createCalendarView({arch:`<calendar date_start="start" date_stop="stop" mode="month" event_open_popup="true" quick_add="False">
                    <field name="name"/>
                    <field name="partner_id"/>
                </calendar>`,archs:archs,data:this.data,model:'event',View:CalendarView,viewOptions:{initialDate:initialDate},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(3) .fc-day:eq(2)');testUtils.triggerMouseEvent($cell,"mousedown");testUtils.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();var $input=$('.modal-body input:first');await testUtils.fields.editInput($input,"An event");await testUtils.dom.click($('.modal button.btn-primary'));await testUtils.nextTick();await testUtils.dragAndDrop(calendar.$('.fc-event:contains("An event")'),calendar.$('.fc-day-grid .fc-row:eq(3) .fc-day-top:eq(1)'));await testUtils.nextTick();await testUtils.dom.click(calendar.$('.fc-event:contains("An event")'));assert.containsOnce(calendar,'.popover:contains("07:00")',"start hour shouldn't have been changed");assert.containsOnce(calendar,'.popover:contains("19:00")',"end hour shouldn't have been changed");calendar.destroy();});QUnit.test("drag and drop on month mode with all_day mapping",async function(assert){assert.expect(2);const calendar=await createCalendarView({arch:`<calendar date_start="start" date_stop="stop" mode="month" event_open_popup="true" quick_add="False" all_day="allday">
                    <field name="name"/>
                    <field name="partner_id"/>
                </calendar>`,archs:archs,data:this.data,model:'event',View:CalendarView,viewOptions:{initialDate:initialDate},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(3) .fc-day:eq(2)');testUtils.triggerMouseEvent($cell,"mousedown");testUtils.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();var $input=$('.modal-body input:first');await testUtils.fields.editInput($input,"An event");await testUtils.dom.click($('.o_field_widget[name="allday"] input'));await testUtils.nextTick();testUtils.dom.openDatepicker($('.o_field_widget[name="start"].o_datepicker'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="togglePicker"]'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hours td.hour:contains(07)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="close"]'));testUtils.dom.openDatepicker($('.o_field_widget[name="stop"].o_datepicker'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="togglePicker"]'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker .timepicker-hour'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .timepicker-hours td.hour:contains(19)'));await testUtils.dom.click($('.bootstrap-datetimepicker-widget .picker-switch a[data-action="close"]'));await testUtils.dom.click($('.modal button.btn-primary'));await testUtils.nextTick();await testUtils.dom.dragAndDrop(calendar.$('.fc-event:contains("An event")'),calendar.$('.fc-day-grid .fc-row:eq(3) .fc-day-top:eq(1)'));await testUtils.nextTick();await testUtils.dom.click(calendar.$('.fc-event:contains("An event")'));assert.containsOnce(calendar,'.popover:contains("07:00")',"start hour shouldn't have been changed");assert.containsOnce(calendar,'.popover:contains("19:00")',"end hour shouldn't have been changed");calendar.destroy();});QUnit.test('drag and drop on month mode with date_start and date_delay',async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar date_start="start" date_delay="delay" mode="month">'+'<field name="name"/>'+'<field name="start"/>'+'<field name="delay"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="write"){assert.equal(args.args[1].delay,undefined)}
return this._super(route,args);},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(3) .fc-day:eq(2)');await testUtils.triggerMouseEvent($cell,"mousedown");await testUtils.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();var $input=$('.modal-body input:first');await testUtils.fields.editInput($input,"An event");await testUtils.dom.click($('.modal button.btn:contains(Create)'));await testUtils.nextTick();await testUtils.dragAndDrop(calendar.$('.fc-event').first(),calendar.$('.fc-day-top').first());await testUtils.nextTick();calendar.destroy();});QUnit.test('form_view_id attribute works (for creating events)',async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="month" '+'form_view_id="42"/>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="create"){return Promise.reject('None shall pass!');}
return this._super(route,args);},intercepts:{do_action:function(event){assert.strictEqual(event.data.action.views[0][0],42,"should do a do_action with view id 42");},},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');await testUtils.dom.triggerMouseEvent($cell,"mousedown");await testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();var $input=$('.modal-body input:first');await testUtils.fields.editInput($input,"It's just a fleshwound");await testUtils.dom.click($('.modal button.btn:contains(Create)'));await testUtils.nextTick();calendar.destroy();});QUnit.test('form_view_id attribute works with popup (for creating events)',async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="month" '+'event_open_popup="true" '+'quick_add="false" '+'form_view_id="1">'+'<field name="name"/>'+'</calendar>',archs:archs,viewOptions:{initialDate:initialDate,},mockRPC:function(route,args){if(args.method==="load_views"){assert.strictEqual(args.kwargs.views[0][0],1,"should load view with id 1");}
return this._super(route,args);},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');await testUtils.dom.triggerMouseEvent($cell,"mousedown");await testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();calendar.destroy();});QUnit.test('calendar fallback to form view id in action if necessary',async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,action:{views:[{viewID:1,type:'kanban'},{viewID:43,type:'form'}]}},mockRPC:function(route,args){if(args.method==="create"){return Promise.reject('None shall pass!');}
return this._super(route,args);},intercepts:{do_action:function(event){assert.strictEqual(event.data.action.views[0][0],43,"should do a do_action with view id 43");},},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();var $input=$('.modal-body input:first');await testUtils.fields.editInput($input,"It's just a fleshwound");await testUtils.dom.click($('.modal button.btn:contains(Create)'));calendar.destroy();});QUnit.test('fullcalendar initializes with right locale',async function(assert){assert.expect(1);var initialLocale=moment.locale();moment.defineLocale('zz',{longDateFormat:{L:'DD/MM/YYYY'},weekdaysShort:["zz1.","zz2.","zz3.","zz4.","zz5.","zz6.","zz7."],});var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week"/>',archs:archs,viewOptions:{initialDate:initialDate,action:{views:[{viewID:1,type:'kanban'},{viewID:43,type:'form'}]}},});assert.strictEqual(calendar.$('.fc-day-header:first').text(),"zz1. 11",'The day should be in the given locale specific format');moment.locale(initialLocale);calendar.destroy();});QUnit.test('default week start (US) month mode',async function(assert){assert.expect(8);var initDate=new Date(2019,8,12,8,0,0);initDate=new Date(initDate.getTime()-initDate.getTimezoneOffset()*60*1000);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="month">'+'</calendar>',archs:archs,viewOptions:{initialDate:initDate,},mockRPC:function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,[["start","<=","2019-10-12 23:59:59"],["stop",">=","2019-09-01 00:00:00"]],'The domain to search events in should be correct');}
return this._super.apply(this,arguments);}});assert.strictEqual(calendar.$('.fc-day-header').first().text(),"Sunday","The first day of the week should be Sunday");assert.strictEqual(calendar.$('.fc-day-header').last().text(),"Saturday","The last day of the week should be Saturday");var $firstDay=calendar.$('.fc-day-top').first();assert.strictEqual($firstDay.find('.fc-week-number').text(),"36","The number of the week should be correct");assert.strictEqual($firstDay.find('.fc-day-number').text(),"1","The first day of the week should be 2019-09-01");assert.strictEqual($firstDay.data('date'),"2019-09-01","The first day of the week should be 2019-09-01");var $lastDay=calendar.$('.fc-day-top').last();assert.strictEqual($lastDay.text(),"12","The last day of the week should be 2019-10-12");assert.strictEqual($lastDay.data('date'),"2019-10-12","The last day of the week should be 2019-10-12");calendar.destroy();});QUnit.test('European week start month mode',async function(assert){assert.expect(8);var initDate=new Date(2019,8,15,8,0,0);initDate=new Date(initDate.getTime()-initDate.getTimezoneOffset()*60*1000);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="month">'+'</calendar>',archs:archs,viewOptions:{initialDate:initDate,},translateParameters:{week_start:1,},mockRPC:function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,[["start","<=","2019-10-06 23:59:59"],["stop",">=","2019-08-26 00:00:00"]],'The domain to search events in should be correct');}
return this._super.apply(this,arguments);}});assert.strictEqual(calendar.$('.fc-day-header').first().text(),"Monday","The first day of the week should be Monday");assert.strictEqual(calendar.$('.fc-day-header').last().text(),"Sunday","The last day of the week should be Sunday");var $firstDay=calendar.$('.fc-day-top').first();assert.strictEqual($firstDay.find('.fc-week-number').text(),"35","The number of the week should be correct");assert.strictEqual($firstDay.find('.fc-day-number').text(),"26","The first day of the week should be 2019-09-01");assert.strictEqual($firstDay.data('date'),"2019-08-26","The first day of the week should be 2019-08-26");var $lastDay=calendar.$('.fc-day-top').last();assert.strictEqual($lastDay.text(),"6","The last day of the week should be 2019-10-06");assert.strictEqual($lastDay.data('date'),"2019-10-06","The last day of the week should be 2019-10-06");calendar.destroy();});QUnit.test('Monday week start week mode',async function(assert){assert.expect(3);var initDate=new Date(2019,8,15,8,0,0);initDate=new Date(initDate.getTime()-initDate.getTimezoneOffset()*60*1000);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week">'+'</calendar>',archs:archs,viewOptions:{initialDate:initDate,},translateParameters:{week_start:1,},mockRPC:function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,[["start","<=","2019-09-15 23:59:59"],["stop",">=","2019-09-09 00:00:00"]],'The domain to search events in should be correct');}
return this._super.apply(this,arguments);}});assert.strictEqual(calendar.$('.fc-day-header').first().text(),"Mon 9","The first day of the week should be Monday the 9th");assert.strictEqual(calendar.$('.fc-day-header').last().text(),"Sun 15","The last day of the week should be Sunday the 15th");calendar.destroy();});QUnit.test('Saturday week start week mode',async function(assert){assert.expect(3);var initDate=new Date(2019,8,12,8,0,0);initDate=new Date(initDate.getTime()-initDate.getTimezoneOffset()*60*1000);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'date_start="start" '+'date_stop="stop" '+'mode="week">'+'</calendar>',archs:archs,viewOptions:{initialDate:initDate,},translateParameters:{week_start:6,},mockRPC:function(route,args){if(args.method==='search_read'&&args.model==='event'){assert.deepEqual(args.kwargs.domain,[["start","<=","2019-09-13 23:59:59"],["stop",">=","2019-09-07 00:00:00"]],'The domain to search events in should be correct');}
return this._super.apply(this,arguments);}});assert.strictEqual(calendar.$('.fc-day-header').first().text(),"Sat 7","The first day of the week should be Saturday the 7th");assert.strictEqual(calendar.$('.fc-day-header').last().text(),"Fri 13","The last day of the week should be Friday the 13th");calendar.destroy();});QUnit.test('edit record and attempt to create a record with "create" attribute set to false',async function(assert){assert.expect(8);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'event_open_popup="true" '+'create="false" '+'date_start="start" '+'date_stop="stop" '+'mode="month"/>',archs:archs,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{name:'event 4 modified'},"should update the record");}
return this._super.apply(this,arguments);},viewOptions:{initialDate:initialDate,},});await testUtils.dom.click(calendar.$('.fc-event:contains(event 4) .fc-content'));assert.ok(calendar.$('.o_cw_popover').length,"should open a popover clicking on event");assert.ok(calendar.$('.o_cw_popover .o_cw_popover_edit').length,"popover should have an edit button");assert.ok(calendar.$('.o_cw_popover .o_cw_popover_delete').length,"popover should have a delete button");assert.ok(calendar.$('.o_cw_popover .o_cw_popover_close').length,"popover should have a close button");await testUtils.dom.click(calendar.$('.o_cw_popover .o_cw_popover_edit'));assert.ok($('.modal-body').length,"should open the form view in dialog when click on edit");await testUtils.fields.editInput($('.modal-body input:first'),'event 4 modified');await testUtils.dom.click($('.modal-footer button.btn:contains(Save)'));assert.notOk($('.modal-body').length,"save button should close the modal");var $cell=calendar.$('.fc-day-grid .fc-row:eq(2) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();assert.notOk($('.modal-sm').length,"shouldn't open a quick create dialog for creating a new event with create attribute set to false");calendar.destroy();});QUnit.test('attempt to create record with "create" and "quick_add" attributes set to false',async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:'<calendar class="o_calendar_test" '+'string="Events" '+'create="false" '+'event_open_popup="true" '+'quick_add="false" '+'date_start="start" '+'date_stop="stop" '+'mode="month"/>',archs:archs,viewOptions:{initialDate:initialDate,},});var $cell=calendar.$('.fc-day-grid .fc-row:eq(5) .fc-day:eq(2)');testUtils.dom.triggerMouseEvent($cell,"mousedown");testUtils.dom.triggerMouseEvent($cell,"mouseup");await testUtils.nextTick();assert.strictEqual($('.modal').length,0,"shouldn't open a form view for creating a new event with create attribute set to false");calendar.destroy();});QUnit.test('attempt to create multiples events and the same day and check the ordering on month view',async function(assert){assert.expect(3);var initDate=new Date(2020,2,12,8,0,0);this.data.event.records=[{id:1,name:"Second event",start:"2020-03-12 05:00:00",stop:"2020-03-12 07:00:00",allday:false},{id:2,name:"First event",start:"2020-03-12 02:00:00",stop:"2020-03-12 03:00:00",allday:false},{id:3,name:"Third event",start:"2020-03-12 08:00:00",stop:"2020-03-12 09:00:00",allday:false},];var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`<calendar date_start="start" date_stop="stop" all_day="allday" mode="month" />`,archs:archs,viewOptions:{initialDate:initDate,},});assert.ok(calendar.$('.o_calendar_view').find('.fc-view-container').length,"should display in the calendar");assert.strictEqual(calendar.$('.o_event_title').length,3,"3 events should be available");assert.strictEqual(calendar.$('.o_event_title').first().text(),'First event',"First event should be on top");calendar.destroy();});QUnit.test("drag and drop 24h event on week mode",async function(assert){assert.expect(1);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`
                <calendar
                    event_open_popup="true"
                    quick_add="False"
                    date_start="start"
                    date_stop="stop"
                    all_day="allday"
                    mode="week"
                 />
            `,archs:archs,viewOptions:{initialDate:initialDate,},},{positionalClicks:true});var top=calendar.$('.fc-axis:contains(8:00)').offset().top+5;var left=calendar.$('.fc-day:eq(2)').offset().left+5;try{testUtils.dom.triggerPositionalMouseEvent(left,top,"mousedown");}catch(e){calendar.destroy();throw new Error('The test fails to simulate a click in the screen. Your screen is probably too small or your dev tools is open.');}
top=calendar.$('.fc-axis:contains(8:00)').offset().top-5;var leftNextDay=calendar.$('.fc-day:eq(3)').offset().left+5;testUtils.dom.triggerPositionalMouseEvent(leftNextDay,top,"mousemove");await testUtils.dom.triggerPositionalMouseEvent(leftNextDay,top,"mouseup");await testUtils.nextTick();assert.equal($('.o_field_boolean.o_field_widget[name=allday] input').is(':checked'),false,"The event must not have the all_day active");await testUtils.dom.click($('.modal button.btn:contains(Discard)'));calendar.destroy();});QUnit.test('correctly display year view',async function(assert){assert.expect(27);const calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`
                <calendar
                    create="false"
                    event_open_popup="true"
                    date_start="start"
                    date_stop="stop"
                    all_day="allday"
                    mode="year"
                    attendee="partner_ids"
                    color="partner_id"
                >
                    <field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>
                    <field name="partner_id" filters="1" invisible="1"/>
                </calendar>`,archs:archs,viewOptions:{initialDate:initialDate,},},{positionalClicks:true});assert.containsN(calendar,'.fc-month',12);assert.strictEqual(calendar.el.querySelector('.fc-month:first-child .fc-header-toolbar').textContent,'Jan 2016');assert.containsN(calendar.el,'.fc-bgevent',7,'There should be 6 events displayed but there is 1 split on 2 weeks');async function clickDate(date){const el=calendar.el.querySelector(`.fc-day-top[data-date="${date}"]`);el.scrollIntoView();testUtils.dom.triggerMouseEvent(el,"mousedown");testUtils.dom.triggerMouseEvent(el,"mouseup");await testUtils.nextTick();}
assert.notOk(calendar.el.querySelector('.fc-day-top[data-date="2016-11-17"]').classList.contains('fc-has-event'));await clickDate('2016-11-17');assert.containsNone(calendar,'.o_cw_popover');assert.ok(calendar.el.querySelector('.fc-day-top[data-date="2016-11-16"]').classList.contains('fc-has-event'));await clickDate('2016-11-16');assert.containsOnce(calendar,'.o_cw_popover');let popoverText=calendar.el.querySelector('.o_cw_popover').textContent.replace(/\s{2,}/g,' ').trim();assert.strictEqual(popoverText,'November 14-16, 2016 event 7');await testUtils.dom.click(calendar.el.querySelector('.o_cw_popover_close'));assert.containsNone(calendar,'.o_cw_popover');assert.ok(calendar.el.querySelector('.fc-day-top[data-date="2016-11-14"]').classList.contains('fc-has-event'));await clickDate('2016-11-14');assert.containsOnce(calendar,'.o_cw_popover');popoverText=calendar.el.querySelector('.o_cw_popover').textContent.replace(/\s{2,}/g,' ').trim();assert.strictEqual(popoverText,'November 14-16, 2016 event 7');await testUtils.dom.click(calendar.el.querySelector('.o_cw_popover_close'));assert.containsNone(calendar,'.o_cw_popover');assert.notOk(calendar.el.querySelector('.fc-day-top[data-date="2016-11-13"]').classList.contains('fc-has-event'));await clickDate('2016-11-13');assert.containsNone(calendar,'.o_cw_popover');assert.notOk(calendar.el.querySelector('.fc-day-top[data-date="2016-12-10"]').classList.contains('fc-has-event'));await clickDate('2016-12-10');assert.containsNone(calendar,'.o_cw_popover');assert.ok(calendar.el.querySelector('.fc-day-top[data-date="2016-12-12"]').classList.contains('fc-has-event'));await clickDate('2016-12-12');assert.containsOnce(calendar,'.o_cw_popover');popoverText=calendar.el.querySelector('.o_cw_popover').textContent.replace(/\s{2,}/g,' ').trim();assert.strictEqual(popoverText,'December 12, 2016 event 2 event 3');await testUtils.dom.click(calendar.el.querySelector('.o_cw_popover_close'));assert.containsNone(calendar,'.o_cw_popover');assert.ok(calendar.el.querySelector('.fc-day-top[data-date="2016-12-14"]').classList.contains('fc-has-event'));await clickDate('2016-12-14');assert.containsOnce(calendar,'.o_cw_popover');popoverText=calendar.el.querySelector('.o_cw_popover').textContent.replace(/\s{2,}/g,' ').trim();assert.strictEqual(popoverText,'December 14, 2016 event 4 December 13-20, 2016 event 5');await testUtils.dom.click(calendar.el.querySelector('.o_cw_popover_close'));assert.containsNone(calendar,'.o_cw_popover');assert.notOk(calendar.el.querySelector('.fc-day-top[data-date="2016-12-21"]').classList.contains('fc-has-event'));await clickDate('2016-12-21');assert.containsNone(calendar,'.o_cw_popover');calendar.destroy();});QUnit.test('toggle filters in year view',async function(assert){assert.expect(42);const calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`
                <calendar
                    event_open_popup="true"
                    date_start="start"
                    date_stop="stop"
                    all_day="allday"
                    mode="year"
                    attendee="partner_ids"
                    color="partner_id"
                >
                    <field name="partner_ids" write_model="filter_partner" write_field="partner_id"/>
                    <field name="partner_id" filters="1" invisible="1"/>
                '</calendar>`,archs:archs,viewOptions:{initialDate:initialDate,},});function checkEvents(countMap){for(const[id,count]of Object.entries(countMap)){assert.containsN(calendar,`.fc-bgevent[data-event-id="${id}"]`,count);}}
checkEvents({1:1,2:1,3:1,4:1,5:2,7:1,});await testUtils.dom.click(calendar.el.querySelector('#o_cw_filter_collapse_attendees .o_calendar_filter_item[data-value="2"] label'));checkEvents({1:1,2:1,3:1,4:1,5:0,7:0,});await testUtils.dom.click(calendar.el.querySelector('#o_cw_filter_collapse_user .o_calendar_filter_item[data-value="1"] label'));checkEvents({1:0,2:0,3:1,4:0,5:0,7:0,});await testUtils.dom.click(calendar.el.querySelector('#o_cw_filter_collapse_user .o_calendar_filter_item[data-value="4"] label'));checkEvents({1:0,2:0,3:0,4:0,5:0,7:0,});await testUtils.dom.click(calendar.el.querySelector('#o_cw_filter_collapse_attendees .o_calendar_filter_item[data-value="1"] label'));checkEvents({1:0,2:0,3:0,4:0,5:0,7:0,});await testUtils.dom.click(calendar.el.querySelector('#o_cw_filter_collapse_attendees .o_calendar_filter_item[data-value="2"] label'));checkEvents({1:0,2:0,3:0,4:0,5:0,7:0,});await testUtils.dom.click(calendar.el.querySelector('#o_cw_filter_collapse_user .o_calendar_filter_item[data-value="4"] label'));checkEvents({1:0,2:0,3:0,4:0,5:2,7:0,});calendar.destroy();});QUnit.test('allowed scales',async function(assert){assert.expect(8);let calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`<calendar
                    date_start="start"
                    date_stop="stop"
                    all_day="allday"/>`,archs:archs,viewOptions:{initialDate:initialDate,},});assert.containsOnce(calendar,'.o_calendar_scale_buttons .o_calendar_button_day');assert.containsOnce(calendar,'.o_calendar_scale_buttons .o_calendar_button_week');assert.containsOnce(calendar,'.o_calendar_scale_buttons .o_calendar_button_month');assert.containsOnce(calendar,'.o_calendar_scale_buttons .o_calendar_button_year');calendar.destroy();calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`<calendar
                    date_start="start"
                    date_stop="stop"
                    all_day="allday"
                    scales="day,week"/>`,archs:archs,viewOptions:{initialDate:initialDate,},});assert.containsOnce(calendar,'.o_calendar_scale_buttons .o_calendar_button_day');assert.containsOnce(calendar,'.o_calendar_scale_buttons .o_calendar_button_week');assert.containsNone(calendar,'.o_calendar_scale_buttons .o_calendar_button_month');assert.containsNone(calendar,'.o_calendar_scale_buttons .o_calendar_button_year');calendar.destroy();});QUnit.test('click outside the popup should close it',async function(assert){assert.expect(4);var calendar=await createCalendarView({View:CalendarView,model:'event',data:this.data,arch:`<calendar
                    create="false"
                    event_open_popup="true"
                    quick_add="false"
                    date_start="start"
                    date_stop="stop"
                    all_day="allday"
                    mode="month"/>`,archs:archs,viewOptions:{initialDate:initialDate,},});assert.containsNone(calendar,'.o_cw_popover');await testUtils.dom.click(calendar.el.querySelector('.fc-event .fc-content'));assert.containsOnce(calendar,'.o_cw_popover','open popup when click on event');await testUtils.dom.click(calendar.el.querySelector('.o_cw_body'));assert.containsOnce(calendar,'.o_cw_popover','keep popup openned when click inside popup');await testUtils.dom.click(calendar.el.querySelector('.o_content'));assert.containsNone(calendar,'.o_cw_popover','close popup when click outside popup');calendar.destroy();});});});;

/* /web/static/tests/views/qweb_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.qweb_view_tests',function(require){"use strict";var utils=require('web.test_utils');QUnit.module("Views",{},function(){QUnit.module("QWeb");QUnit.test("basic",async function(assert){assert.expect(14);var am=await utils.createActionManager({data:{test:{fields:{},records:[],}},archs:{'test,5,qweb':'<div id="xxx"><t t-esc="ok"/></div>','test,false,search':'<search/>'},mockRPC:function(route,args){if(/^\/web\/dataset\/call_kw/.test(route)){switch(_.str.sprintf('%(model)s.%(method)s',args)){case'test.qweb_render_view':assert.step('fetch');assert.equal(args.kwargs.view_id,5);return Promise.resolve('<div>foo'+'<div data-model="test" data-method="wheee" data-id="42" data-other="5">'+'<a type="toggle" class="fa fa-caret-right">Unfold</a>'+'</div>'+'</div>');case'test.wheee':assert.step('unfold');assert.deepEqual(args.args,[42]);assert.deepEqual(args.kwargs,{other:5});return Promise.resolve('<div id="sub">ok</div>');}}
return this._super.apply(this,arguments);}});try{var resolved=false;am.doAction({type:'ir.actions.act_window',views:[[false,'qweb']],res_model:'test',}).then(function(){resolved=true;});assert.ok(!resolved,"Action cannot be resolved synchronously");await utils.nextTick();assert.ok(resolved,"Action is resolved asynchronously");var $content=am.$('.o_content');assert.ok(/^\s*foo/.test($content.text()));await utils.dom.click($content.find('[type=toggle]'));assert.equal($content.find('div#sub').text(),'ok','should have unfolded the sub-item');await utils.dom.click($content.find('[type=toggle]'));assert.equal($content.find('div#sub').length,0,"should have removed the sub-item");await utils.dom.click($content.find('[type=toggle]'));assert.verifySteps(['fetch','unfold','unfold']);}finally{am.destroy();}});});});;

/* /web/static/tests/views/abstract_model_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.abstract_model_tests',function(require){"use strict";const AbstractModel=require('web.AbstractModel');const Domain=require('web.Domain');QUnit.module('Views',{},function(){QUnit.module('AbstractModel');QUnit.test('leave sample mode when unknown route is called on sample server',async function(assert){assert.expect(4);const Model=AbstractModel.extend({_isEmpty(){return true;},async __load(){if(this.isSampleModel){await this._rpc({model:'partner',method:'unknown'});}},});const model=new Model(null,{modelName:'partner',fields:{},useSampleModel:true,SampleModel:Model,});assert.ok(model.useSampleModel);assert.notOk(model._isInSampleMode);await model.load({});assert.notOk(model.useSampleModel);assert.notOk(model._isInSampleMode);model.destroy();});QUnit.test("don't cath general error on sample server in sample mode",async function(assert){assert.expect(5);const error=new Error();const Model=AbstractModel.extend({_isEmpty(){return true;},async __reload(){if(this.isSampleModel){await this._rpc({model:'partner',method:'read_group'});}},async _rpc(){throw error;},});const model=new Model(null,{modelName:'partner',fields:{},useSampleModel:true,SampleModel:Model,});assert.ok(model.useSampleModel);assert.notOk(model._isInSampleMode);await model.load({});assert.ok(model.useSampleModel);assert.ok(model._isInSampleMode);async function reloadModel(){try{await model.reload();}catch(e){assert.strictEqual(e,error);}}
await reloadModel();model.destroy();});QUnit.test('fetch sample data: concurrency',async function(assert){assert.expect(3);const Model=AbstractModel.extend({_isEmpty(){return true;},__get(){return{isSample:!!this.isSampleModel};},});const model=new Model(null,{modelName:'partner',fields:{},useSampleModel:true,SampleModel:Model,});await model.load({domain:Domain.FALSE_DOMAIN,});const beforeReload=model.get(null,{withSampleData:true});const reloaded=model.reload(null,{domain:Domain.TRUE_DOMAIN});const duringReload=model.get(null,{withSampleData:true});await reloaded;const afterReload=model.get(null,{withSampleData:true});assert.strictEqual(beforeReload.isSample,true,"Sample data flag must be true before reload");assert.strictEqual(duringReload.isSample,true,"Sample data flag must be true during reload");assert.strictEqual(afterReload.isSample,false,"Sample data flag must be true after reload");});});});;

/* /web/static/tests/views/basic_model_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.basic_model_tests',function(require){"use strict";var BasicModel=require('web.BasicModel');var FormView=require('web.FormView');var testUtils=require('web.test_utils');var createModel=testUtils.createModel;var createView=testUtils.createView;QUnit.module('Views',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"STRING",type:'char'},x_active:{string:"Custom Active",type:'boolean',default:true},active:{string:"Active",type:'boolean',default:true},total:{string:"Total",type:'integer'},foo:{string:"Foo",type:'char'},bar:{string:"Bar",type:'integer'},qux:{string:"Qux",type:'many2one',relation:'partner'},product_id:{string:"Favorite product",type:'many2one',relation:'product'},product_ids:{string:"Favorite products",type:'one2many',relation:'product'},category:{string:"Category M2M",type:'many2many',relation:'partner_type'},date:{string:"Date Field",type:'date'},reference:{string:"Reference Field",type:'reference',selection:[["product","Product"],["partner_type","Partner Type"],["partner","Partner"]]},},records:[{id:1,foo:'blip',bar:1,product_id:37,category:[12],display_name:"first partner",date:"2017-01-25"},{id:2,foo:'gnap',bar:2,product_id:41,display_name:"second partner"},],onchanges:{},},product:{fields:{display_name:{string:"Product Display Name",type:"char"},name:{string:"Product Name",type:"char"},category:{string:"Category M2M",type:'many2many',relation:'partner_type'},active:{string:"Active",type:'boolean',default:true},},records:[{id:37,display_name:"xphone"},{id:41,display_name:"xpad"}]},partner_type:{fields:{display_name:{string:"Partner Type",type:"char"},date:{string:"Date Field",type:'date'},x_active:{string:"Custom Active",type:'boolean',default:true},},records:[{id:12,display_name:"gold",date:"2017-01-25"},{id:14,display_name:"silver"},{id:15,display_name:"bronze"}]},partner_title:{fields:{display_name:{string:"Partner Title",type:'char'},},records:[{id:42,display_name:"Dr."},]}};this.data.partner.fields.category.relatedFields=$.extend(true,{},this.data.partner_type.fields);this.params={res_id:2,modelName:'partner',fields:this.data.partner.fields,};},},function(){QUnit.module('BasicModel');QUnit.test('can process x2many commands',async function(assert){assert.expect(6);this.data.partner.fields.product_ids.default=[[0,0,{category:[]}]];const form=await createView({View:FormView,model:'partner',data:this.data,arch:`
                    <form>
                        <field name="product_ids"/>
                    </form>
                `,archs:{'product,false,list':`
                        <tree>
                            <field name="display_name"/>
                        </tree>
                    `,'product,false,kanban':`
                        <kanban>
                            <templates><t t-name="kanban-box">
                                <div><field name="display_name"/></div>
                            </t></templates>
                        </kanban>
                    `,},viewOptions:{mode:'edit',},mockRPC(route,args){assert.step(args.method);return this._super.apply(this,arguments);},});assert.verifySteps(['load_views','onchange',]);assert.containsOnce(form,'.o_field_x2many_list','should have rendered a x2many list');assert.containsOnce(form,'.o_data_row','should have added 1 record as default');assert.containsOnce(form,'.o_field_x2many_list_row_add','should have rendered a x2many add row on list');form.destroy();});QUnit.test('can load a record',async function(assert){assert.expect(7);this.params.fieldNames=['foo'];this.params.context={active_field:2};var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.deepEqual(args.kwargs.context,{active_field:2,bin_size:true,someKey:'some value',},"should have sent the correct context");return this._super.apply(this,arguments);},session:{user_context:{someKey:'some value'},}});assert.strictEqual(model.get(1),null,"should return null for non existing key");var resultID=await model.load(this.params);assert.strictEqual(typeof resultID,'string',"result should be a valid id");var record=model.get(resultID);assert.strictEqual(record.res_id,2,"res_id read should be the same as asked");assert.strictEqual(record.type,'record',"should be of type 'record'");assert.strictEqual(record.data.foo,"gnap","should correctly read value");assert.strictEqual(record.data.bar,undefined,"should not fetch the field 'bar'");model.destroy();});QUnit.test('rejects loading a record with invalid id',async function(assert){assert.expect(1);this.params.res_id=99;var model=await createModel({Model:BasicModel,data:this.data,});try{await model.load(this.params);}
catch(e){assert.ok("load should return a rejected deferred for an invalid id");}
model.destroy();});QUnit.test('notify change with many2one',async function(assert){assert.expect(2);this.params.fieldNames=['foo','qux'];var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.qux,false,"qux field should be false");await model.notifyChanges(resultID,{qux:{id:1,display_name:"hello"}});record=model.get(resultID);assert.strictEqual(record.data.qux.data.id,1,"qux field should be 1");model.destroy();});QUnit.test('notify change on many2one: unset and reset same value',async function(assert){assert.expect(3);this.data.partner.records[1].qux=1;this.params.fieldNames=['qux'];var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.qux.data.id,1,"qux value should be 1");await model.notifyChanges(resultID,{qux:false});record=model.get(resultID);assert.strictEqual(record.data.qux,false,"qux should be unset");await model.notifyChanges(resultID,{qux:{id:1,display_name:'second_partner'}});record=model.get(resultID);assert.strictEqual(record.data.qux.data.id,1,"qux value should be 1 again");model.destroy();});QUnit.test('write on a many2one',async function(assert){assert.expect(4);var self=this;this.params.fieldNames=['product_id'];var rpcCount=0;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){rpcCount++;return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_id.data.display_name,'xpad',"should be initialized with correct value");await model.notifyChanges(resultID,{product_id:{id:37,display_name:'xphone'}});record=model.get(resultID);assert.strictEqual(record.data.product_id.data.display_name,'xphone',"should be changed with correct value");await model.save(resultID);assert.strictEqual(self.data.partner.records[1].product_id,37,"should have really saved the data");assert.strictEqual(rpcCount,3,"should have done 3 rpc: 1 read, 1 write, 1 read");model.destroy();});QUnit.test('basic onchange',async function(assert){assert.expect(5);this.data.partner.fields.foo.onChange=true;this.data.partner.onchanges.foo=function(obj){obj.bar=obj.foo.length;};this.params.fieldNames=['foo','bar'];this.params.context={hello:'world'};var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='onchange'){var context=args.kwargs.context;assert.deepEqual(context,{hello:'world'},"context should be sent by the onchange");}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.foo,'gnap',"foo field is properly initialized");assert.strictEqual(record.data.bar,2,"bar field is properly initialized");await model.notifyChanges(resultID,{foo:'mary poppins'});record=model.get(resultID);assert.strictEqual(record.data.foo,'mary poppins',"onchange has been applied");assert.strictEqual(record.data.bar,12,"onchange has been applied");model.destroy();});QUnit.test('onchange with a many2one',async function(assert){assert.expect(5);this.data.partner.fields.product_id.onChange=true;this.data.partner.onchanges.product_id=function(obj){if(obj.product_id===37){obj.foo="space lollipop";}};this.params.fieldNames=['foo','product_id'];var rpcCount=0;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='onchange'){assert.strictEqual(args.args[2],"product_id","should send the only changed field as a string, not a list");}
rpcCount++;return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.foo,'gnap',"foo field is properly initialized");assert.strictEqual(record.data.product_id.data.id,41,"product_id field is properly initialized");await model.notifyChanges(resultID,{product_id:{id:37,display_name:'xphone'}});record=model.get(resultID);assert.strictEqual(record.data.foo,'space lollipop',"onchange has been applied");assert.strictEqual(rpcCount,2,"should have done 2 rpc: 1 read and 1 onchange");model.destroy();});QUnit.test('onchange on a one2many not in view (fieldNames)',async function(assert){assert.expect(6);this.data.partner.fields.foo.onChange=true;this.data.partner.onchanges.foo=function(obj){obj.bar=obj.foo.length;obj.product_ids=[];};this.params.fieldNames=['foo'];var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.foo,'gnap',"foo field is properly initialized");assert.strictEqual(record.data.bar,undefined,"bar field is not loaded");assert.strictEqual(record.data.product_ids,undefined,"product_ids field is not loaded");await model.notifyChanges(resultID,{foo:'mary poppins'});record=model.get(resultID);assert.strictEqual(record.data.foo,'mary poppins',"onchange has been applied");assert.strictEqual(record.data.bar,12,"onchange has been applied");assert.strictEqual(record.data.product_ids,undefined,"onchange on product_ids (one2many) has not been applied");model.destroy();});QUnit.test('notifyChange on a one2many',async function(assert){assert.expect(9);this.data.partner.records[1].product_ids=[37];this.params.fieldNames=['product_ids'];var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='name_get'){assert.strictEqual(args.model,'product');}
return this._super(route,args);},});var o2mParams={modelName:'product',fields:this.data.product.fields,fieldNames:['display_name'],};var resultID=await model.load(this.params);var newRecordID=await model.load(o2mParams);var record=model.get(resultID);var x2mListID=record.data.product_ids.id;assert.strictEqual(record.data.product_ids.count,1,"there should be one record in the relation");await model.notifyChanges(resultID,{product_ids:{operation:'ADD',id:newRecordID}});assert.deepEqual(model.localData[x2mListID]._changes,[{operation:'ADD',id:newRecordID,}],"_changes should be correct");record=model.get(resultID);assert.strictEqual(record.data.product_ids.count,2,"there should be two records in the relation");await model.notifyChanges(resultID,{product_ids:{operation:'UPDATE',id:newRecordID}});assert.deepEqual(model.localData[x2mListID]._changes,[{operation:'ADD',id:newRecordID,},{operation:'UPDATE',id:newRecordID,}],"_changes should be correct");record=model.get(resultID);assert.strictEqual(record.data.product_ids.count,2,"there should be two records in the relation");var existingRecordID=record.data.product_ids.data[0].id;await model.notifyChanges(resultID,{product_ids:{operation:'DELETE',ids:[existingRecordID]}});assert.deepEqual(model.localData[x2mListID]._changes,[{operation:'ADD',id:newRecordID,},{operation:'UPDATE',id:newRecordID,},{operation:'DELETE',id:existingRecordID,}],"_changes should be correct");record=model.get(resultID);assert.strictEqual(record.data.product_ids.count,1,"there should be one record in the relation");await model.notifyChanges(resultID,{product_ids:{operation:'DELETE',ids:[newRecordID]}});assert.deepEqual(model.localData[x2mListID]._changes,[{operation:'DELETE',id:existingRecordID,}],"_changes should be correct");record=model.get(resultID);assert.strictEqual(record.data.product_ids.count,0,"there should be no record in the relation");model.destroy();});QUnit.test('notifyChange on a many2one, without display_name',async function(assert){assert.expect(3);this.params.fieldNames=['product_id'];var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='name_get'){assert.strictEqual(args.model,'product');}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_id.data.display_name,'xpad',"product_id field is set to xpad");await model.notifyChanges(resultID,{product_id:{id:37}});record=model.get(resultID);assert.strictEqual(record.data.product_id.data.display_name,'xphone',"display_name should have been fetched");model.destroy();});QUnit.test('onchange on a char with an unchanged many2one',async function(assert){assert.expect(2);this.data.partner.fields.foo.onChange=true;this.data.partner.onchanges.foo=function(obj){obj.foo=obj.foo+" alligator";};this.params.fieldNames=['foo','product_id'];var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='onchange'){assert.strictEqual(args.args[1].product_id,41,"should send correct value");}
return this._super(route,args);},});var resultID=await model.load(this.params);await model.notifyChanges(resultID,{foo:'cookie'});var record=model.get(resultID);assert.strictEqual(record.data.foo,'cookie alligator',"onchange has been applied");model.destroy();});QUnit.test('onchange on a char with another many2one not set to a value',async function(assert){assert.expect(2);this.data.partner.records[0].product_id=false;this.data.partner.fields.foo.onChange=true;this.data.partner.onchanges.foo=function(obj){obj.foo=obj.foo+" alligator";};this.params.fieldNames=['foo','product_id'];this.params.res_id=1;var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_id,false,"product_id is not set");await model.notifyChanges(resultID,{foo:'cookie'});record=model.get(resultID);assert.strictEqual(record.data.foo,'cookie alligator',"onchange has been applied");model.destroy();});QUnit.test('can get a many2many',async function(assert){assert.expect(3);this.params.res_id=1;this.params.fieldsInfo={default:{category:{fieldsInfo:{default:{display_name:{}}},relatedFields:{display_name:{type:"char"}},viewType:'default',},},};var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.category.data[0].res_id,12,"should have loaded many2many res_ids");assert.strictEqual(record.data.category.data[0].data.display_name,"gold","should have loaded many2many display_name");record=model.get(resultID,{raw:true});assert.deepEqual(record.data.category,[12],"with option raw, category should only return ids");model.destroy();});QUnit.test('can use command add and get many2many value with date field',async function(assert){assert.expect(2);this.params.fieldsInfo={default:{category:{fieldsInfo:{default:{date:{}}},relatedFields:{date:{type:"date"}},viewType:'default',},},};var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var changes={category:{operation:'ADD_M2M',ids:[{id:12}]}};await model.notifyChanges(resultID,changes);var record=model.get(resultID);assert.strictEqual(record.data.category.data.length,1,"should have added one category");assert.strictEqual(record.data.category.data[0].data.date instanceof moment,true,"should have a date parsed in a moment object");model.destroy();});QUnit.test('many2many with ADD_M2M command and context with parent key',async function(assert){assert.expect(1);this.data.partner_type.fields.some_char={type:"char"};this.params.fieldsInfo={default:{category:{fieldsInfo:{default:{some_char:{context:"{'a': parent.foo}"}}},relatedFields:{some_char:{type:"char"}},viewType:'default',},foo:{},},};var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var changes={category:{operation:'ADD_M2M',ids:[{id:12}]}};await model.notifyChanges(resultID,changes);var record=model.get(resultID);var categoryRecord=record.data.category.data[0];assert.deepEqual(categoryRecord.getContext({fieldName:'some_char'}),{a:'gnap'},"should properly evaluate context");model.destroy();});QUnit.test('can fetch a list',async function(assert){assert.expect(4);this.params.fieldNames=['foo'];this.params.domain=[];this.params.groupedBy=[];this.params.res_id=undefined;this.params.context={active_field:2};var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.strictEqual(args.context.active_field,2,"should have sent the correct context");return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.type,'list',"record fetched should be a list");assert.strictEqual(record.data.length,2,"should have fetched 2 records");assert.strictEqual(record.data[0].data.foo,'blip',"first record should have 'blip' in foo field");model.destroy();});QUnit.test('fetch x2manys in list, with not too many rpcs',async function(assert){assert.expect(3);this.data.partner.records[0].category=[12,15];this.data.partner.records[1].category=[12,14];this.params.fieldNames=['category'];this.params.domain=[];this.params.groupedBy=[];this.params.res_id=undefined;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.step(route);return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data[0].data.category.data.length,2,"first record should have 2 categories loaded");assert.verifySteps(["/web/dataset/search_read"],"should have done 2 rpc (searchread and read category)");model.destroy();});QUnit.test('can make a default_record with the help of onchange',async function(assert){assert.expect(5);this.params.context={};this.params.fieldNames=['product_id','category','product_ids'];this.params.res_id=undefined;this.params.type='record';var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.step(args.method);return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_id,false,"m2o default value should be false");assert.deepEqual(record.data.product_ids.data,[],"o2m default should be []");assert.deepEqual(record.data.category.data,[],"m2m default should be []");assert.verifySteps(['onchange']);model.destroy();});QUnit.test('default_get returning a non requested field',async function(assert){assert.expect(2);this.params.context={};this.params.fieldNames=['category'];this.params.res_id=undefined;this.params.type='record';var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){var result=this._super(route,args);if(args.method==='default_get'){result.product_ids=[[6,0,[37,41]]];}
return result;},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.ok('category'in record.data,"should have processed 'category'");assert.notOk('product_ids'in record.data,"should have ignored 'product_ids'");model.destroy();});QUnit.test('can make a default_record with default relational values',async function(assert){assert.expect(6);this.data.partner.fields.product_id.default=37;this.data.partner.fields.product_ids.default=[[0,false,{name:'xmac'}],[0,false,{name:'xcloud'}]];this.data.partner.fields.category.default=[[6,false,[12,14]]];this.params.fieldNames=['product_id','category','product_ids'];this.params.res_id=undefined;this.params.type='record';this.params.fieldsInfo={form:{category:{},product_id:{},product_ids:{fieldsInfo:{default:{name:{}},},relatedFields:this.data.product.fields,viewType:'default',},},};this.params.viewType='form';var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.step(args.method);return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.deepEqual(record.data.product_id.data.display_name,'xphone',"m2o default should be xphone");assert.deepEqual(record.data.product_ids.data.length,2,"o2m default should have two records");assert.deepEqual(record.data.product_ids.data[0].data.name,'xmac',"first o2m default value should be xmac");assert.deepEqual(record.data.category.res_ids,[12,14],"m2m default should be [12, 14]");assert.verifySteps(['onchange']);model.destroy();});QUnit.test('default_record, with onchange on many2one',async function(assert){assert.expect(1);this.data.partner.onchanges.product_id=true;this.params.context={};this.params.fieldNames=['product_id'];this.params.res_id=undefined;this.params.type='record';var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{product_id:false}});}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_id,false,"m2o default value should be false");model.destroy();});QUnit.test('default record: batch namegets on same model and res_id',async function(assert){assert.expect(3);var rpcCount=0;var fields=this.data.partner.fields;fields.other_product_id=_.extend({},fields.product_id);fields.product_id.default=37;fields.other_product_id.default=41;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){rpcCount++;return this._super(route,args);},});var params={context:{},fieldNames:['other_product_id','product_id'],fields:fields,modelName:'partner',type:'record',};var resultID=await model.load(params);var record=model.get(resultID);assert.strictEqual(record.data.product_id.data.display_name,"xphone","should have fetched correct name");assert.strictEqual(record.data.other_product_id.data.display_name,"xpad","should have fetched correct name");assert.strictEqual(rpcCount,1,"should have done 1 rpc: onchange");model.destroy();});QUnit.test('undoing a change keeps the record dirty',async function(assert){assert.expect(4);this.params.fieldNames=['foo'];var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.foo,"gnap","foo field should properly be set");assert.ok(!model.isDirty(resultID),"record should not be dirty");await model.notifyChanges(resultID,{foo:"hello"});assert.ok(model.isDirty(resultID),"record should be dirty");await model.notifyChanges(resultID,{foo:"gnap"});assert.ok(model.isDirty(resultID),"record should be dirty");model.destroy();});QUnit.test('isDirty works correctly on list made empty',async function(assert){assert.expect(3);this.params.fieldNames=['category'];this.params.res_id=1;var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);var category_value=record.data.category;assert.ok(_.isObject(category_value),"category field should have been fetched");assert.strictEqual(category_value.data.length,1,"category field should contain one record");await model.notifyChanges(resultID,{category:{operation:'DELETE',ids:[category_value.data[0].id],}});assert.ok(model.isDirty(resultID),"record should be considered dirty");model.destroy();});QUnit.test('can duplicate a record',async function(assert){assert.expect(4);this.params.fieldNames=['foo'];var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.display_name,"second partner","record should have correct display name");assert.strictEqual(record.data.foo,"gnap","foo should be set to correct value");var duplicateID=await model.duplicateRecord(resultID);var duplicate=model.get(duplicateID);assert.strictEqual(duplicate.data.display_name,"second partner (copy)","record should have been duplicated");assert.strictEqual(duplicate.data.foo,"gnap","foo should be set to correct value");model.destroy();});QUnit.test('record with many2one set to some value, then set it to none',async function(assert){assert.expect(3);this.params.fieldNames=['product_id'];var self=this;var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_id.data.display_name,'xpad',"product_id should be set");await model.notifyChanges(resultID,{product_id:false});record=model.get(resultID);assert.strictEqual(record.data.product_id,false,"product_id should not be set");await model.save(resultID);assert.strictEqual(self.data.partner.records[1].product_id,false,"should have saved the new product_id value");model.destroy();});QUnit.test('internal state of groups remains when reloading',async function(assert){assert.expect(10);this.params.fieldNames=['foo'];this.params.domain=[];this.params.limit=80;this.params.groupedBy=['product_id'];this.params.res_id=undefined;var filterEnabled=false;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='web_read_group'&&filterEnabled){return this._super.apply(this,arguments).then(function(result){result.groups[0].product_id_count=0;return result;});}
return this._super.apply(this,arguments);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.length,2,"should have 2 groups");var groupID=record.data[0].id;assert.strictEqual(model.localData[groupID].parentID,resultID,"parentID should be correctly set on groups");await model.toggleGroup(groupID);record=model.get(resultID);assert.ok(record.data[0].isOpen,"first group should be open");assert.strictEqual(record.data[0].data.length,1,"first group should have one record");assert.strictEqual(record.data[0].limit,80,"limit should be 80 by default");model.localData[record.data[0].id].limit=10;await model.reload(resultID);record=model.get(resultID);assert.ok(record.data[0].isOpen,"first group should still be open");assert.strictEqual(record.data[0].data.length,1,"first group should still have one record");assert.strictEqual(record.data[0].limit,10,"new limit should have been kept");filterEnabled=true;await model.reload(resultID);record=model.get(resultID);assert.strictEqual(record.data[0].count,0,"first group's count should be 0");assert.strictEqual(record.data[0].data.length,0,"first group's data should be empty'");model.destroy();});QUnit.test('group on date field with magic grouping method',async function(assert){assert.expect(1);this.params.fieldNames=['foo'];this.params.groupedBy=['date:month'];this.params.res_id=undefined;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='web_read_group'){assert.deepEqual(args.kwargs.fields,['foo','date'],"should have correctly trimmed the magic grouping info from the field name");}
return this._super.apply(this,arguments);},});await model.load(this.params);model.destroy();});QUnit.test('read group when grouped by a selection field',async function(assert){assert.expect(5);this.data.partner.fields.selection={type:'selection',selection:[['a','A'],['b','B']],};this.data.partner.records[0].selection='a';var model=await createModel({Model:BasicModel,data:this.data,});var params={modelName:'partner',fields:this.data.partner.fields,fieldNames:['foo'],groupedBy:['selection'],};var resultID=await model.load(params);var dataPoint=model.get(resultID);assert.strictEqual(dataPoint.data.length,2,"should have two groups");var groupFalse=_.findWhere(dataPoint.data,{value:false});assert.ok(groupFalse,"should have a group for value false");assert.deepEqual(groupFalse.domain,[['selection','=',false]],"group's domain should be correct");var groupA=_.findWhere(dataPoint.data,{value:'A'});assert.ok(groupA,"should have a group for value 'a'");assert.deepEqual(groupA.domain,[['selection','=','a']],"group's domain should be correct");model.destroy();});QUnit.test('create record, then save',async function(assert){assert.expect(5);this.params.fieldNames=['product_ids'];this.params.res_id=undefined;this.params.type='record';this.params.context={active_field:2};var id;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='create'){assert.notOk('product_ids'in args.args[0],"should not have any value");assert.notOk('category'in args.args[0],"should not have other fields");assert.strictEqual(args.kwargs.context.active_field,2,"record's context should be correctly passed");}
var result=this._super(route,args);if(args.method==='create'){result.then(function(res){id=res;});}
return result;},});var resultID=await model.load(this.params);var record=model.get(resultID);await model.save(record.id,{reload:false});record=model.get(resultID);assert.strictEqual(record.res_id,id,"should have correct id from server");assert.strictEqual(record.data.id,id,"should have correct id from server");model.destroy();});QUnit.test('write commands on a one2many',async function(assert){assert.expect(4);this.data.partner.records[1].product_ids=[37];this.params.fieldNames=['product_ids'];var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[0],[2],"should write on res_id = 2");var commands=args.args[1].product_ids;assert.deepEqual(commands[0],[4,37,false],"first command should be a 4");assert.strictEqual(commands[1][0],0,"second command should be a 0");}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID,{raw:true});assert.deepEqual(record.data.product_ids,[37],"should have correct initial value");var relatedRecordID=await model.makeRecord('product',[{name:'name',string:"Product Name",type:"char",value:"xpod"}]);await model.notifyChanges(record.id,{product_ids:{operation:"ADD",id:relatedRecordID}});await model.save(record.id);model.destroy();});QUnit.test('create commands on a one2many',async function(assert){assert.expect(3);var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){return this._super(route,args);},});this.params.fieldsInfo={default:{product_ids:{fieldsInfo:{default:{display_name:{type:'string'},}},viewType:'default',}}};this.params.res_id=undefined;this.params.type='record';var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_ids.data.length,0,"one2many should start with a list of length 0");await model.notifyChanges(record.id,{product_ids:{operation:"CREATE",data:{display_name:'coucou',},},});record=model.get(resultID);assert.strictEqual(record.data.product_ids.data.length,1,"one2many should be a list of length 1");assert.strictEqual(record.data.product_ids.data[0].data.display_name,"coucou","one2many should have correct data");model.destroy();});QUnit.test('onchange with a one2many on a new record',async function(assert){assert.expect(4);this.data.partner.fields.total.default=50;this.data.partner.fields.product_ids.onChange=true;this.data.partner.onchanges.product_ids=function(obj){obj.total+=100;};this.params.fieldNames=['total','product_ids'];this.params.res_id=undefined;this.params.type='record';this.params.fieldsInfo={form:{product_ids:{fieldsInfo:{default:{name:{}},},relatedFields:this.data.product.fields,viewType:'default',},total:{},},};this.params.viewType='form';var o2mRecordParams={fields:this.data.product.fields,fieldNames:['name'],modelName:'product',type:'record',};var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='onchange'&&args.args[1].total===150){assert.deepEqual(args.args[1].product_ids,[[0,args.args[1].product_ids[0][1],{name:"xpod"}]],"Should have sent the create command in the onchange");}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.product_ids.data.length,0,"one2many should start with a list of length 0");var relatedRecordID=await model.load(o2mRecordParams);await model.notifyChanges(relatedRecordID,{name:'xpod'});await model.notifyChanges(resultID,{product_ids:{operation:"ADD",id:relatedRecordID}});record=model.get(resultID);assert.strictEqual(record.data.product_ids.data.length,1,"one2many should be a list of length 1");assert.strictEqual(record.data.product_ids.data[0].data.name,"xpod","one2many should have correct data");model.destroy();});QUnit.test('dates are properly loaded and parsed (record)',async function(assert){assert.expect(2);var model=await createModel({Model:BasicModel,data:this.data,});var params={fieldNames:['date'],fields:this.data.partner.fields,modelName:'partner',res_id:1,};await model.load(params).then(function(resultID){var record=model.get(resultID);assert.ok(record.data.date instanceof moment,"fetched date field should have been formatted");});params.res_id=2;await model.load(params).then(function(resultID){var record=model.get(resultID);assert.strictEqual(record.data.date,false,"unset date field should be false");});model.destroy();});QUnit.test('dates are properly loaded and parsed (list)',async function(assert){assert.expect(2);var model=await createModel({Model:BasicModel,data:this.data,});var params={fieldNames:['date'],fields:this.data.partner.fields,modelName:'partner',type:'list',};await model.load(params).then(function(resultID){var record=model.get(resultID);var firstRecord=record.data[0];var secondRecord=record.data[1];assert.ok(firstRecord.data.date instanceof moment,"fetched date field should have been formatted");assert.strictEqual(secondRecord.data.date,false,"if date is not set, it should be false");});model.destroy();});QUnit.test('dates are properly loaded and parsed (default_get)',async function(assert){assert.expect(1);var model=await createModel({Model:BasicModel,data:this.data,});var params={fieldNames:['date'],fields:this.data.partner.fields,modelName:'partner',type:'record',};await model.load(params).then(function(resultID){var record=model.get(resultID);assert.strictEqual(record.data.date,false,"date default value should be false");});model.destroy();});QUnit.test('default_get on x2many may return a list of ids',async function(assert){assert.expect(1);this.data.partner.fields.category.default=[12,14];var model=await createModel({Model:BasicModel,data:this.data,});var params={fieldNames:['category'],fields:this.data.partner.fields,modelName:'partner',type:'record',};await model.load(params).then(function(resultID){var record=model.get(resultID);assert.ok(_.isEqual(record.data.category.res_ids,[12,14]),"category field should have correct default value");});model.destroy();});QUnit.test('default_get: fetch many2one with default (empty & not) inside x2manys',async function(assert){assert.expect(3);this.data.partner.fields.category_m2o={type:'many2one',relation:'partner_type',};this.data.partner.fields.o2m={string:"O2M",type:'one2many',relation:'partner',default:[[6,0,[]],[0,0,{category_m2o:false,o2m:[]}],[0,0,{category_m2o:12,o2m:[]}],],};var model=await createModel({Model:BasicModel,data:this.data,});var params={fieldNames:['o2m'],fields:this.data.partner.fields,fieldsInfo:{form:{o2m:{relatedFields:this.data.partner.fields,fieldsInfo:{list:{category_m2o:{relatedFields:{display_name:{}},},},},viewType:'list',},},},modelName:'partner',type:'record',viewType:'form',};var resultID=await model.load(params);var record=model.get(resultID);assert.strictEqual(record.data.o2m.count,2,"o2m field should contain 2 records");assert.strictEqual(record.data.o2m.data[0].data.category_m2o,false,"first category field should be empty");assert.strictEqual(record.data.o2m.data[1].data.category_m2o.data.display_name,"gold","second category field should have been correctly fetched");model.destroy();});QUnit.test('default_get: fetch x2manys inside x2manys',async function(assert){assert.expect(3);this.data.partner.fields.o2m={string:"O2M",type:'one2many',relation:'partner',default:[[6,0,[1]]],};var model=await createModel({Model:BasicModel,data:this.data,});var params={fieldNames:['o2m'],fields:this.data.partner.fields,fieldsInfo:{form:{o2m:{relatedFields:this.data.partner.fields,fieldsInfo:{list:{category:{relatedFields:{display_name:{}},},},},viewType:'list',},},},modelName:'partner',type:'record',viewType:'form',};var resultID=await model.load(params);var record=model.get(resultID);assert.strictEqual(record.data.o2m.count,1,"o2m field should contain 1 record");var categoryList=record.data.o2m.data[0].data.category;assert.strictEqual(categoryList.count,1,"category field should contain 1 record");assert.strictEqual(categoryList.data[0].data.display_name,'gold',"category records should have been fetched");model.destroy();});QUnit.test('contexts and domains can be properly fetched',async function(assert){assert.expect(8);this.data.partner.fields.product_id.context="{'hello': 'world', 'test': foo}";this.data.partner.fields.product_id.domain="[['hello', 'like', 'world'], ['test', 'like', foo]]";var model=await createModel({Model:BasicModel,data:this.data,});this.params.fieldNames=['product_id','foo'];var resultID=await model.load(this.params);var recordPartner=model.get(resultID);assert.strictEqual(typeof recordPartner.getContext,"function","partner record should have a getContext function");assert.strictEqual(typeof recordPartner.getDomain,"function","partner record should have a getDomain function");assert.deepEqual(recordPartner.getContext(),{},"asking for a context without a field name should fetch the session/user/view context");assert.deepEqual(recordPartner.getDomain(),[],"asking for a domain without a field name should fetch the session/user/view domain");assert.deepEqual(recordPartner.getContext({fieldName:"product_id"}),{hello:"world",test:"gnap"},"asking for a context with a field name should fetch the field context (evaluated)");assert.deepEqual(recordPartner.getDomain({fieldName:"product_id"}),[["hello","like","world"],["test","like","gnap"]],"asking for a domain with a field name should fetch the field domain (evaluated)");model.destroy();model=await createModel({Model:BasicModel,data:this.data,});this.params.fieldsInfo={default:{foo:{},product_id:{context:"{'hello2': 'world', 'test2': foo}",domain:"[['hello2', 'like', 'world'], ['test2', 'like', foo]]",},}};resultID=await model.load(this.params);recordPartner=model.get(resultID);assert.deepEqual(recordPartner.getContext({fieldName:"product_id"}),{hello2:"world",test2:"gnap"},"field context should have been overridden by xml attribute");assert.deepEqual(recordPartner.getDomain({fieldName:"product_id"}),[["hello2","like","world"],["test2","like","gnap"]],"field domain should have been overridden by xml attribute");model.destroy();});QUnit.test('dont write on readonly fields (write and create)',async function(assert){assert.expect(6);this.params.fieldNames=['foo','bar'];this.data.partner.fields.foo.onChange=true;this.data.partner.onchanges.foo=function(obj){obj.bar=obj.foo.length;};this.params.fieldsInfo={default:{foo:{},bar:{modifiers:{readonly:true,},},}};var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{foo:"verylongstring"},"should only save foo field");}
if(args.method==='create'){assert.deepEqual(args.args[0],{foo:"anotherverylongstring"},"should only save foo field");}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.bar,2,"should be initialized with correct value");await model.notifyChanges(resultID,{foo:"verylongstring"});record=model.get(resultID);assert.strictEqual(record.data.bar,14,"should be changed with correct value");await model.save(resultID);delete this.params.res_id;resultID=await model.load(this.params);record=model.get(resultID);assert.strictEqual(record.data.bar,0,"should be initialized with correct value (0 as integer)");await model.notifyChanges(resultID,{foo:"anotherverylongstring"});record=model.get(resultID);assert.strictEqual(record.data.bar,21,"should be changed with correct value");await model.save(resultID);model.destroy();});QUnit.test('dont write on readonly fields unless save attribute is set',async function(assert){assert.expect(6);this.params.fieldNames=['foo','bar'];this.data.partner.fields.foo.onChange=true;this.data.partner.onchanges.foo=function(obj){obj.bar=obj.foo.length;};this.params.fieldsInfo={default:{foo:{},bar:{modifiers:{readonly:true,},force_save:true,},}};var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='write'){assert.deepEqual(args.args[1],{bar:14,foo:"verylongstring"},"should only save foo field");}
if(args.method==='create'){assert.deepEqual(args.args[0],{bar:21,foo:"anotherverylongstring"},"should only save foo field");}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data.bar,2,"should be initialized with correct value");await model.notifyChanges(resultID,{foo:"verylongstring"});record=model.get(resultID);assert.strictEqual(record.data.bar,14,"should be changed with correct value");await model.save(resultID);delete this.params.res_id;resultID=await model.load(this.params);record=model.get(resultID);assert.strictEqual(record.data.bar,0,"should be initialized with correct value (0 as integer)");await model.notifyChanges(resultID,{foo:"anotherverylongstring"});record=model.get(resultID);assert.strictEqual(record.data.bar,21,"should be changed with correct value");await model.save(resultID);model.destroy();});QUnit.test('default_get with one2many values',async function(assert){assert.expect(1);var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){if(args.method==='default_get'){return Promise.resolve({product_ids:[[0,0,{"name":"xdroid"}]]});}
return this._super(route,args);},});var params={fieldNames:['product_ids'],fields:this.data.partner.fields,modelName:'partner',type:'record',fieldsInfo:{form:{product_ids:{fieldsInfo:{default:{name:{}},},relatedFields:this.data.product.fields,viewType:'default',},},},viewType:'form',};var resultID=await model.load(params);assert.strictEqual(typeof resultID,'string',"result should be a valid id");model.destroy();});QUnit.test('call makeRecord with a pre-fetched many2one field',async function(assert){assert.expect(3);var rpcCount=0;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){rpcCount++;return this._super(route,args);},});model.makeRecord('coucou',[{name:'partner_id',relation:'partner',type:'many2one',value:[1,'first partner'],}],{partner_id:{options:{no_open:true,},},}).then(function(recordID){var record=model.get(recordID);assert.deepEqual(record.fieldsInfo.default.partner_id,{options:{no_open:true}},"makeRecord should have generated the fieldsInfo");assert.deepEqual(record.data.partner_id.data,{id:1,display_name:'first partner'},"many2one should contain the partner with id 1");assert.strictEqual(rpcCount,0,"makeRecord should not have done any rpc");});model.destroy();});QUnit.test('call makeRecord with a many2many field',async function(assert){assert.expect(5);var rpcCount=0;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){rpcCount++;return this._super(route,args);},});var recordID=await model.makeRecord('coucou',[{name:'partner_ids',fields:[{name:'id',type:'integer',},{name:'display_name',type:'char',}],relation:'partner',type:'many2many',value:[1,2],}]);var record=model.get(recordID);assert.deepEqual(record.fieldsInfo.default.partner_ids,{},"makeRecord should have generated the fieldsInfo");assert.strictEqual(record.data.partner_ids.count,2,"there should be 2 elements in the many2many");assert.strictEqual(record.data.partner_ids.data.length,2,"many2many should be a list of length 2");assert.deepEqual(record.data.partner_ids.data[0].data,{id:1,display_name:'first partner'},"many2many should contain the partner with id 1");assert.strictEqual(rpcCount,1,"makeRecord should have done 1 rpc");model.destroy();});QUnit.test('call makeRecord with a pre-fetched many2many field',async function(assert){assert.expect(5);var rpcCount=0;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){rpcCount++;return this._super(route,args);},});var recordID=await model.makeRecord('coucou',[{name:'partner_ids',fields:[{name:'id',type:'integer',},{name:'display_name',type:'char',}],relation:'partner',type:'many2many',value:[{id:1,display_name:"first partner",},{id:2,display_name:"second partner",}],}]);var record=model.get(recordID);assert.deepEqual(record.fieldsInfo.default.partner_ids,{},"makeRecord should have generated the fieldsInfo");assert.strictEqual(record.data.partner_ids.count,2,"there should be 2 elements in the many2many");assert.strictEqual(record.data.partner_ids.data.length,2,"many2many should be a list of length 2");assert.deepEqual(record.data.partner_ids.data[0].data,{id:1,display_name:'first partner'},"many2many should contain the partner with id 1");assert.strictEqual(rpcCount,0,"makeRecord should not have done any rpc");model.destroy();});QUnit.test('call makeRecord with a selection field',async function(assert){assert.expect(4);var rpcCount=0;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){rpcCount++;return this._super.apply(this,arguments);},});var recordID=await model.makeRecord('partner',[{name:'status',string:'Status',type:'selection',selection:[['draft','Draft'],['done','Done'],['failed','Failed']],value:'done',}]);var record=model.get(recordID);assert.deepEqual(record.fieldsInfo.default.status,{},"makeRecord should have generated the fieldsInfo");assert.strictEqual(record.data.status,'done',"should have a value 'done'");assert.strictEqual(record.fields.status.selection.length,3,"should have 3 keys for selection");assert.strictEqual(rpcCount,0,"makeRecord should have done 0 rpc");model.destroy();});QUnit.test('call makeRecord with a reference field',async function(assert){assert.expect(2);let rpcCount=0;const model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){rpcCount++;return this._super(route,args);},});const field=this.data.partner.fields.reference;const recordID=await model.makeRecord('coucou',[{name:'reference',type:'reference',selection:field.selection,value:'product,37',}]);const record=model.get(recordID);assert.deepEqual(record.data.reference.data,{id:37,display_name:'xphone'});assert.strictEqual(rpcCount,1);model.destroy();});QUnit.test('check id, active_id, active_ids, active_model values in record\'s context',async function(assert){assert.expect(2);this.data.partner.fields.product_id.context="{'id': id, 'active_id': active_id, 'active_ids': active_ids, 'active_model': active_model}";var model=await createModel({Model:BasicModel,data:this.data,});this.params.fieldNames=['product_id'];var resultID=await model.load(this.params);var recordPartner=model.get(resultID);assert.deepEqual(recordPartner.getContext({fieldName:"product_id"}),{id:2,active_id:2,active_ids:[2],active_model:"partner"},"wrong values for id, active_id, active_ids or active_model");this.params.res_id=undefined;resultID=await model.load(this.params);recordPartner=model.get(resultID);assert.deepEqual(recordPartner.getContext({fieldName:"product_id"}),{id:false,active_id:false,active_ids:[],active_model:"partner"},"wrong values for id, active_id, active_ids or active_model. Have to be defined even if there is no record.");model.destroy();});QUnit.test('load model with many2many field properly fetched',async function(assert){assert.expect(2);this.params.fieldNames=['category'];this.params.res_id=1;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.step(args.method);return this._super(route,args);},});await model.load(this.params);assert.verifySteps(['read'],"there should be only one read");model.destroy();});QUnit.test('data should contain all fields in view, default being false',async function(assert){assert.expect(1);this.data.partner.fields.product_ids.default=[[6,0,[]],[0,0,{name:'new'}],];this.data.product.fields.date={string:"Date",type:"date"};var params={fieldNames:['product_ids'],modelName:'partner',fields:this.data.partner.fields,fieldsInfo:{form:{product_ids:{relatedFields:this.data.product.fields,fieldsInfo:{list:{name:{},date:{}}},viewType:'list',}},},res_id:undefined,type:'record',viewType:'form',};var model=await createModel({Model:BasicModel,data:this.data,});await model.load(params).then(function(resultID){var record=model.get(resultID);assert.strictEqual(record.data.product_ids.data[0].data.date,false,"date value should be in data, and should be false");});model.destroy();});QUnit.test('changes are discarded when reloading from a new record',async function(assert){assert.expect(2);this.data.partner.fields.foo.default='default';var model=await createModel({Model:BasicModel,data:this.data,});var params=_.extend(this.params,{res_id:undefined,type:'record',fieldNames:['foo'],});var resultID=await model.load(params);var record=model.get(resultID);assert.strictEqual(record.data.foo,'default',"should be the default value");resultID=await model.reload(record.id,{currentId:2});record=model.get(resultID);assert.strictEqual(record.data.foo,'gnap',"should be the value of record 2");model.destroy();});QUnit.test('has a proper evaluation context',async function(assert){assert.expect(6);const unpatchDate=testUtils.mock.patchDate(1997,0,9,12,0,0);this.params.fieldNames=Object.keys(this.data.partner.fields);this.params.res_id=1;var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);const{evalContext}=model.get(resultID);assert.strictEqual(typeof evalContext.datetime,"object");assert.strictEqual(typeof evalContext.relativedelta,"object");assert.strictEqual(typeof evalContext.time,"object");assert.strictEqual(typeof evalContext.context_today,"function");assert.strictEqual(typeof evalContext.tz_offset,"function");const blackListedKeys=["time","datetime","relativedelta","context_today","tz_offset",];for(const key of blackListedKeys){delete evalContext[key];}
assert.deepEqual(evalContext,{active:true,active_id:1,active_ids:[1],active_model:"partner",bar:1,category:[12],current_company_id:false,current_date:moment().format('YYYY-MM-DD'),today:moment().format('YYYY-MM-DD'),now:moment().utc().format('YYYY-MM-DD HH:mm:ss'),date:"2017-01-25",display_name:"first partner",foo:"blip",id:1,product_id:37,product_ids:[],qux:false,reference:false,total:0,x_active:true,},"should use the proper eval context");model.destroy();unpatchDate();});QUnit.test('x2manys in contexts and domains are correctly evaluated',async function(assert){assert.expect(4);this.data.partner.records[0].product_ids=[37,41];this.params.fieldNames=Object.keys(this.data.partner.fields);this.params.fieldsInfo={form:{qux:{context:"{'category': category, 'product_ids': product_ids}",domain:"[['id', 'in', category], ['id', 'in', product_ids]]",relatedFields:this.data.partner.fields,},category:{relatedFields:this.data.partner_type.fields,},product_ids:{relatedFields:this.data.product.fields,},},};this.params.viewType='form';this.params.res_id=1;var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);var context=record.getContext({fieldName:'qux'});var domain=record.getDomain({fieldName:'qux'});assert.deepEqual(context,{category:[12],product_ids:[37,41],},"x2many values in context manipulated client-side should be lists of ids");assert.strictEqual(JSON.stringify(context),"{\"category\":[[6,false,[12]]],\"product_ids\":[[4,37,false],[4,41,false]]}","x2many values in context sent to the server should be commands");assert.deepEqual(domain,[['id','in',[12]],['id','in',[37,41]],],"x2many values in domains should be lists of ids");assert.strictEqual(JSON.stringify(domain),"[[\"id\",\"in\",[12]],[\"id\",\"in\",[37,41]]]","x2many values in domains should be lists of ids");model.destroy();});QUnit.test('fetch references in list, with not too many rpcs',async function(assert){assert.expect(5);this.data.partner.records[0].reference='product,37';this.data.partner.records[1].reference='product,41';this.params.fieldNames=['reference'];this.params.domain=[];this.params.groupedBy=[];this.params.res_id=undefined;var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.step(route);if(route==="/web/dataset/call_kw/product/name_get"){assert.deepEqual(args.args,[[37,41]],"the name_get should contain the product ids");}
return this._super(route,args);},});var resultID=await model.load(this.params);var record=model.get(resultID);assert.strictEqual(record.data[0].data.reference.data.display_name,"xphone","name_get should have been correctly fetched");assert.verifySteps(["/web/dataset/search_read","/web/dataset/call_kw/product/name_get"],"should have done 2 rpc (searchread and name_get for product)");model.destroy();});QUnit.test('reload a new record',async function(assert){assert.expect(6);this.params.context={};this.params.fieldNames=['product_id','category','product_ids'];this.params.res_id=undefined;this.params.type='record';var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route,args){assert.step(args.method);return this._super(route,args);},});var recordID=await model.load(this.params);recordID=await model.reload(recordID);assert.verifySteps(['onchange','onchange']);var record=model.get(recordID);assert.strictEqual(record.data.product_id,false,"m2o default value should be false");assert.deepEqual(record.data.product_ids.data,[],"o2m default should be []");assert.deepEqual(record.data.category.data,[],"m2m default should be []");model.destroy();});QUnit.test('default_get with value false for a one2many',async function(assert){assert.expect(1);this.data.partner.fields.product_ids.default=false;this.params.fieldNames=['product_ids'];this.params.res_id=undefined;this.params.type='record';var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);assert.deepEqual(record.data.product_ids.data,[],"o2m default should be []");model.destroy();});QUnit.test('only x2many lists (static) should be sorted client-side',async function(assert){assert.expect(1);this.params.modelName='partner_type';this.params.res_id=undefined;this.params.orderedBy=[{name:'display_name',asc:true}];var model=await createModel({Model:BasicModel,data:this.data,mockRPC:function(route){if(route==='/web/dataset/search_read'){return Promise.resolve({length:3,records:[{id:12,display_name:"gold",date:"2017-01-25"},{id:15,display_name:"bronze"},{id:14,display_name:"silver"},],});}
return this._super.apply(this,arguments);},});var resultID=await model.load(this.params);var list=model.get(resultID);assert.deepEqual(_.map(list.data,'res_id'),[12,15,14],"should have kept the order from the server");model.destroy();});QUnit.test('onchange on a boolean field',async function(assert){assert.expect(2);var newFields={foobool:{type:'boolean',string:'foobool',},foobool2:{type:'boolean',string:'foobool2',},};_.extend(this.data.partner.fields,newFields);this.data.partner.fields.foobool.onChange=true;this.data.partner.onchanges.foobool=function(obj){if(obj.foobool){obj.foobool2=true;}};this.data.partner.records[0].foobool=false;this.data.partner.records[0].foobool2=true;this.params.res_id=1;this.params.fieldNames=['foobool','foobool2'];this.params.fields=this.data.partner.fields;var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var record=model.get(resultID);await model.notifyChanges(resultID,{foobool2:false});record=model.get(resultID);assert.strictEqual(record.data.foobool2,false,"foobool2 field should be false");await model.notifyChanges(resultID,{foobool:true});record=model.get(resultID);assert.strictEqual(record.data.foobool2,true,"foobool2 field should be true");model.destroy();});QUnit.test('notifyChange DELETE_ALL on a one2many',async function(assert){assert.expect(5);this.data.partner.records[1].product_ids=[37,38];this.params.fieldNames=['product_ids'];var model=await createModel({Model:BasicModel,data:this.data,});var o2mParams={modelName:'product',fields:this.data.product.fields,};var resultID=await model.load(this.params);var newRecordID=await model.load(o2mParams);var record=model.get(resultID);var x2mListID=record.data.product_ids.id;assert.strictEqual(record.data.product_ids.count,2,"there should be two records in the relation");await model.notifyChanges(resultID,{product_ids:{operation:'ADD',id:newRecordID}});assert.deepEqual(model.localData[x2mListID]._changes,[{operation:'ADD',id:newRecordID,}],"_changes should be correct");record=model.get(resultID);assert.strictEqual(record.data.product_ids.count,3,"there should be three records in the relation");await model.notifyChanges(resultID,{product_ids:{operation:'DELETE_ALL'}});assert.deepEqual(model.localData[x2mListID]._changes,[{id:37,operation:"DELETE"},{id:38,operation:"DELETE"}],"_changes should contain the two 'DELETE' operations");record=model.get(resultID);assert.strictEqual(record.data.product_ids.count,0,"there should be no more records in the relation");model.destroy();});QUnit.test('notifyChange MULTI on a one2many',async function(assert){assert.expect(4);this.data.partner.records[1].product_ids=[37,38];this.params.fieldNames=['product_ids'];var model=await createModel({Model:BasicModel,data:this.data,});var o2mParams={modelName:'product',fields:this.data.product.fields,};var resultID=await model.load(this.params);var newRecordID=await model.load(o2mParams);var record=model.get(resultID);var x2mListID=record.data.product_ids.id;assert.strictEqual(record.data.product_ids.count,2,"there should be two records in the relation");await model.notifyChanges(resultID,{product_ids:{operation:'MULTI',commands:[{operation:'DELETE_ALL'},{operation:'ADD',id:newRecordID}]}});assert.deepEqual(model.localData[x2mListID]._changes,[{id:37,operation:"DELETE"},{id:38,operation:"DELETE"},{operation:'ADD',id:newRecordID,}],"_changes should be correct");record=model.get(resultID);assert.strictEqual(record.data.product_ids.count,1,"there should be one record in the relation");assert.strictEqual(record.data.product_ids.data[0].id,newRecordID,"the id should match");});QUnit.test('notifyChange MULTI on a many2many',async function(assert){assert.expect(3);this.params.fieldsInfo={default:{category:{fieldsInfo:{default:{some_char:{context:"{'a': parent.foo}"}}},relatedFields:{some_char:{type:"char"}},viewType:'default',},foo:{},},};var model=await createModel({Model:BasicModel,data:this.data,});var resultID=await model.load(this.params);var changes={category:{operation:'MULTI',commands:[{operation:'ADD_M2M',ids:[{id:23},{id:24},{id:25}]},{operation:'ADD_M2M',ids:[{id:26}]}]}};await model.notifyChanges(resultID,changes);var record=model.get(resultID);var categoryRecord=record.data.category;assert.strictEqual(categoryRecord.data.length,4,"there should 2 records in the relation");await model.notifyChanges(resultID,{category:{operation:'MULTI',commands:[{operation:'DELETE_ALL'},{operation:'ADD_M2M',ids:[{id:27}]}]}});record=model.get(resultID);categoryRecord=record.data.category;assert.strictEqual(categoryRecord.data.length,1,"there should 1 record in the relation");assert.strictEqual(record.data.category.data[0].data.id,27,"the id should match");model.destroy();});QUnit.test('identify correct active field',async function(assert){assert.expect(4);var model=await createModel({Model:BasicModel,data:this.data,});this.params.res_id=37;this.params.modelName='product'
this.params.fields=this.data.product.fields;var resultID=await model.load(this.params);var record=model.get(resultID);assert.equal(model.getActiveField(record),'active','should have returned "active" field name');this.params.res_id=42;this.params.modelName='partner_title';this.params.fields=this.data.partner_title.fields;var resultID=await model.load(this.params);var record=model.get(resultID);assert.equal(model.getActiveField(record),undefined,'should not have returned any field name');this.params.res_id=12;this.params.modelName='partner_type';this.params.fields=this.data.partner_type.fields;var resultID=await model.load(this.params);var record=model.get(resultID);assert.equal(model.getActiveField(record),'x_active','should have returned "x_active" field name');this.params.res_id=1;this.params.modelName='partner';this.params.fields=this.data.partner.fields;var resultID=await model.load(this.params);var record=model.get(resultID);assert.equal(model.getActiveField(record),'active','should have returned "active" field name');});});});;

/* /web/static/tests/views/abstract_view_banner_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.abstract_view_banner_tests',function(require){"use strict";var AbstractRenderer=require('web.AbstractRenderer');var AbstractView=require('web.AbstractView');var testUtils=require('web.test_utils');var createView=testUtils.createView;var TestRenderer=AbstractRenderer.extend({_renderView:function(){this.$el.addClass('test_content');return this._super();},});var TestView=AbstractView.extend({type:'test',config:_.extend({},AbstractView.prototype.config,{Renderer:TestRenderer}),});var test_css_url='/test_assetsbundle/static/src/css/test_cssfile1.css';QUnit.module('Views',{beforeEach:function(){this.data={test_model:{fields:{},records:[],},};},afterEach:function(){$('head link[href$="'+test_css_url+'"]').remove();}},function(){QUnit.module('BasicRenderer');QUnit.test("The banner should be fetched from the route",function(assert){var done=assert.async();assert.expect(6);var banner_html=`
                <div class="modal o_onboarding_modal o_technical_modal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-footer">
                                <a type="action" class="btn btn-primary" data-dismiss="modal"
                                data-toggle="collapse" href=".o_onboarding_container">
                                    Remove
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="o_onboarding_container collapse show">
                    <div class="o_onboarding_wrap">
                        <a href="#" data-toggle="modal" data-target=".o_onboarding_modal"
                           class="float-right o_onboarding_btn_close">
                            <i class="fa fa-times" title="Close the onboarding panel" />
                        </a>
                    </div>
                    <div>
                        <link type="text/css" href="`+test_css_url+`" rel="stylesheet">
                        <div class="hello_banner">Here is the banner</div>
                    </div>
                </div>`;createView({View:TestView,model:'test_model',data:this.data,arch:'<test banner_route="/module/hello_banner"/>',mockRPC:function(route,args){if(route==='/module/hello_banner'){assert.step(route);return Promise.resolve({html:banner_html});}
return this._super(route,args);},}).then(async function(view){var $banner=view.$('.hello_banner');assert.strictEqual($banner.length,1,"The view should contain the response from the controller.");assert.verifySteps(['/module/hello_banner'],"The banner should be fetched.");var $head_link=$('head link[href$="'+test_css_url+'"]');assert.strictEqual($head_link.length,1,"The stylesheet should have been added to head.");var $banner_link=$('link[href$="'+test_css_url+'"]',$banner);assert.strictEqual($banner_link.length,0,"The stylesheet should have been removed from the banner.");await testUtils.dom.click(view.$('.o_onboarding_btn_close'));await testUtils.dom.click(view.$('.o_technical_modal .btn-primary:contains("Remove")'));assert.strictEqual(view.$('.o_onboarding_container.show').length,0,"Banner should be removed from the view");view.destroy();done();});});});});;

/* /web/static/tests/views/kanban_model_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.kanban_model_tests',function(require){"use strict";var KanbanModel=require('web.KanbanModel');var testUtils=require('web.test_utils');var createModel=testUtils.createModel;QUnit.module('Views',{beforeEach:function(){this.data={partner:{fields:{active:{string:"Active",type:"boolean",default:true},display_name:{string:"STRING",type:'char'},foo:{string:"Foo",type:'char'},bar:{string:"Bar",type:'integer'},qux:{string:"Qux",type:'many2one',relation:'partner'},product_id:{string:"Favorite product",type:'many2one',relation:'product'},product_ids:{string:"Favorite products",type:'one2many',relation:'product'},category:{string:"Category M2M",type:'many2many',relation:'partner_type'},},records:[{id:1,foo:'blip',bar:1,product_id:37,category:[12],display_name:"first partner"},{id:2,foo:'gnap',bar:2,product_id:41,display_name:"second partner"},],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char"}},records:[{id:37,display_name:"xphone"},{id:41,display_name:"xpad"}]},partner_type:{fields:{display_name:{string:"Partner Type",type:"char"}},records:[{id:12,display_name:"gold"},{id:14,display_name:"silver"},{id:15,display_name:"bronze"}]},};this.data.partner.fields.category.relatedFields=$.extend(true,{},this.data.partner_type.fields);this.params={fields:this.data.partner.fields,limit:40,modelName:'partner',openGroupByDefault:true,viewType:'kanban',};},},function(){QUnit.module('KanbanModel');QUnit.test('load grouped + add a new group',async function(assert){var done=assert.async();assert.expect(22);var calledRoutes={};var model=await createModel({Model:KanbanModel,data:this.data,mockRPC:function(route){if(!(route in calledRoutes)){calledRoutes[route]=1;}else{calledRoutes[route]++;}
return this._super.apply(this,arguments);},});var params=_.extend(this.params,{groupedBy:['product_id'],fieldNames:['foo'],});model.load(params).then(async function(resultID){var state=model.get(resultID);assert.ok(_.isEqual(state.groupedBy,['product_id']),'should be grouped by "product_id"');assert.strictEqual(state.data.length,2,'should have found 2 groups');assert.strictEqual(state.count,2,'both groups contain one record');var xphoneGroup=_.findWhere(state.data,{res_id:37});assert.strictEqual(xphoneGroup.model,'partner','group should have correct model');assert.ok(xphoneGroup,'should have a group for res_id 37');assert.ok(xphoneGroup.isOpen,'"xphone" group should be open');assert.strictEqual(xphoneGroup.value,'xphone','group 37 should be "xphone"');assert.strictEqual(xphoneGroup.count,1,'"xphone" group should have one record');assert.strictEqual(xphoneGroup.data.length,1,'should have fetched the records in the group');assert.ok(_.isEqual(xphoneGroup.domain[0],['product_id','=',37]),'domain should be correct');assert.strictEqual(xphoneGroup.limit,40,'limit in a group should be 40');await model.createGroup('xpod',resultID);state=model.get(resultID);assert.strictEqual(state.data.length,3,'should now have 3 groups');assert.strictEqual(state.count,2,'there are still 2 records');var xpodGroup=_.findWhere(state.data,{value:'xpod'});assert.strictEqual(xpodGroup.model,'partner','new group should have correct model');assert.ok(xpodGroup,'should have an "xpod" group');assert.ok(xpodGroup.isOpen,'new group should be open');assert.strictEqual(xpodGroup.count,0,'new group should contain no record');assert.ok(_.isEqual(xpodGroup.domain[0],['product_id','=',xpodGroup.res_id]),'new group should have correct domain');assert.strictEqual(Object.keys(calledRoutes).length,3,'three different routes have been called');var nbReadGroups=calledRoutes['/web/dataset/call_kw/partner/web_read_group'];var nbSearchRead=calledRoutes['/web/dataset/search_read'];var nbNameCreate=calledRoutes['/web/dataset/call_kw/product/name_create'];assert.strictEqual(nbReadGroups,1,'should have done 1 read_group');assert.strictEqual(nbSearchRead,2,'should have done 2 search_read');assert.strictEqual(nbNameCreate,1,'should have done 1 name_create');model.destroy();done();});});QUnit.test('archive/restore a column',async function(assert){var done=assert.async();assert.expect(4);var model=await createModel({Model:KanbanModel,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/action_archive'){this.data.partner.records[0].active=false;return Promise.resolve();}
return this._super.apply(this,arguments);},});var params=_.extend(this.params,{groupedBy:['product_id'],fieldNames:['foo'],});model.load(params).then(async function(resultID){var state=model.get(resultID);var xphoneGroup=_.findWhere(state.data,{res_id:37});var xpadGroup=_.findWhere(state.data,{res_id:41});assert.strictEqual(xphoneGroup.count,1,'xphone group has one record');assert.strictEqual(xpadGroup.count,1,'xpad group has one record');var recordIDs=xphoneGroup.data.map(record=>record.res_id);await model.actionArchive(recordIDs,xphoneGroup.id);state=model.get(resultID);xphoneGroup=_.findWhere(state.data,{res_id:37});assert.strictEqual(xphoneGroup.count,0,'xphone group has no record anymore');xpadGroup=_.findWhere(state.data,{res_id:41});assert.strictEqual(xpadGroup.count,1,'xpad group still has one record');model.destroy();done();});});QUnit.test('kanban model does not allow nested groups',async function(assert){var done=assert.async();assert.expect(2);var model=await createModel({Model:KanbanModel,data:this.data,mockRPC:function(route,args){if(args.method==='web_read_group'){assert.deepEqual(args.kwargs.groupby,['product_id'],"the second level of groupBy should have been removed");}
return this._super.apply(this,arguments);},});var params=_.extend(this.params,{groupedBy:['product_id','qux'],fieldNames:['foo'],});model.load(params).then(function(resultID){var state=model.get(resultID);assert.deepEqual(state.groupedBy,['product_id'],"the second level of groupBy should have been removed");model.destroy();done();});});QUnit.test('resequence columns and records',async function(assert){var done=assert.async();assert.expect(8);this.data.product.fields.sequence={string:"Sequence",type:"integer"};this.data.partner.fields.sequence={string:"Sequence",type:"integer"};this.data.partner.records.push({id:3,foo:'aaa',product_id:37});var nbReseq=0;var model=await createModel({Model:KanbanModel,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/resequence'){nbReseq++;if(nbReseq===1){assert.deepEqual(args.ids,[41,37],"ids should be correct");assert.strictEqual(args.model,'product',"model should be correct");}else if(nbReseq===2){assert.deepEqual(args.ids,[3,1],"ids should be correct");assert.strictEqual(args.model,'partner',"model should be correct");}}
return this._super.apply(this,arguments);},});var params=_.extend(this.params,{groupedBy:['product_id'],fieldNames:['foo'],});model.load(params).then(function(stateID){var state=model.get(stateID);assert.strictEqual(state.data[0].res_id,37,"first group should be res_id 37");return model.resequence('product',[41,37],stateID);}).then(function(stateID){var state=model.get(stateID);assert.strictEqual(state.data[0].res_id,41,"first group should be res_id 41 after resequencing");assert.strictEqual(state.data[1].data[0].res_id,1,"first record should be res_id 1");return model.resequence('partner',[3,1],state.data[1].id);}).then(function(groupID){var group=model.get(groupID);assert.strictEqual(group.data[0].res_id,3,"first record should be res_id 3 after resequencing");model.destroy();done();});});QUnit.test('add record to group',async function(assert){var done=assert.async();assert.expect(8);var self=this;var model=await createModel({Model:KanbanModel,data:this.data,});var params=_.extend(this.params,{groupedBy:['product_id'],fieldNames:['foo'],});model.load(params).then(function(stateID){self.data.partner.records.push({id:3,foo:'new record',product_id:37});var state=model.get(stateID);assert.deepEqual(state.res_ids,[1,2],"state should have the correct res_ids");assert.strictEqual(state.count,2,"state should have the correct count");assert.strictEqual(state.data[0].count,1,"first group should contain one record");return model.addRecordToGroup(state.data[0].id,3).then(function(){var state=model.get(stateID);assert.deepEqual(state.res_ids,[3,1,2],"state should have the correct res_ids");assert.strictEqual(state.count,3,"state should have the correct count");assert.deepEqual(state.data[0].res_ids,[3,1],"new record's id should have been added to the res_ids");assert.strictEqual(state.data[0].count,2,"first group should now contain two records");assert.strictEqual(state.data[0].data[0].data.foo,'new record',"new record should have been fetched");});}).then(function(){model.destroy();done();})});QUnit.test('call get (raw: true) before loading x2many data',async function(assert){var done=assert.async();assert.expect(2);this.data.partner.records[1].product_ids=[37,41];this.params.fieldsInfo={kanban:{product_ids:{fieldsInfo:{default:{display_name:{},color:{}},},relatedFields:this.data.product.fields,viewType:'default',},},};this.params.viewType='kanban';this.params.groupedBy=['foo'];var block;var def=testUtils.makeTestPromise();var model=await createModel({Model:KanbanModel,data:this.data,mockRPC:function(route){var result=this._super.apply(this,arguments);if(route==='/web/dataset/search_read'&&block){block=false;return Promise.all([def]).then(_.constant(result));}
return result;},});model.load(this.params).then(function(handle){block=true;model.reload(handle,{});var state=model.get(handle,{raw:true});assert.strictEqual(state.count,2);def.resolve();state=model.get(handle,{raw:true});assert.strictEqual(state.count,2);}).then(function(){model.destroy();done();});});});});;

/* /web/static/tests/views/view_dialogs_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.view_dialogs_tests',function(require){"use strict";var dialogs=require('web.view_dialogs');var ListController=require('web.ListController');var testUtils=require('web.test_utils');var Widget=require('web.Widget');var FormView=require('web.FormView');const cpHelpers=testUtils.controlPanel;var createView=testUtils.createView;async function createParent(params){var widget=new Widget();params.server=await testUtils.mock.addMockEnvironment(widget,params);return widget;}
QUnit.module('Views',{beforeEach:function(){this.data={partner:{fields:{display_name:{string:"Displayed name",type:"char"},foo:{string:"Foo",type:'char'},bar:{string:"Bar",type:"boolean"},instrument:{string:'Instruments',type:'many2one',relation:'instrument'},},records:[{id:1,foo:'blip',display_name:'blipblip',bar:true},{id:2,foo:'ta tata ta ta',display_name:'macgyver',bar:false},{id:3,foo:'piou piou',display_name:"Jack O'Neill",bar:true},],},instrument:{fields:{name:{string:"name",type:"char"},badassery:{string:'level',type:'many2many',relation:'badassery',domain:[['level','=','Awsome']]},},},badassery:{fields:{level:{string:'level',type:"char"},},records:[{id:1,level:'Awsome'},],},product:{fields:{name:{string:"name",type:"char"},partner:{string:'Doors',type:'one2many',relation:'partner'},},records:[{id:1,name:'The end'},],},};},},function(){QUnit.module('view_dialogs');QUnit.test('formviewdialog buttons in footer are positioned properly',async function(assert){assert.expect(2);var parent=await createParent({data:this.data,archs:{'partner,false,form':'<form string="Partner">'+'<sheet>'+'<group><field name="foo"/></group>'+'<footer><button string="Custom Button" type="object" class="btn-primary"/></footer>'+'</sheet>'+'</form>',},});new dialogs.FormViewDialog(parent,{res_model:'partner',res_id:1,}).open();await testUtils.nextTick();assert.notOk($('.modal-body button').length,"should not have any button in body");assert.strictEqual($('.modal-footer button').length,1,"should have only one button in footer");parent.destroy();});QUnit.test('formviewdialog buttons in footer are not duplicated',async function(assert){assert.expect(2);this.data.partner.fields.poney_ids={string:"Poneys",type:"one2many",relation:'partner'};this.data.partner.records[0].poney_ids=[];var parent=await createParent({data:this.data,archs:{'partner,false,form':'<form string="Partner">'+'<field name="poney_ids"><tree editable="top"><field name="display_name"/></tree></field>'+'<footer><button string="Custom Button" type="object" class="btn-primary"/></footer>'+'</form>',},});new dialogs.FormViewDialog(parent,{res_model:'partner',res_id:1,}).open();await testUtils.nextTick();assert.strictEqual($('.modal button.btn-primary').length,1,"should have 1 buttons in modal");await testUtils.dom.click($('.o_field_x2many_list_row_add a'));await testUtils.fields.triggerKeydown($('input.o_input'),'escape');assert.strictEqual($('.modal button.btn-primary').length,1,"should still have 1 buttons in modal");parent.destroy();});QUnit.test('SelectCreateDialog use domain, group_by and search default',async function(assert){assert.expect(3);var search=0;var parent=await createParent({data:this.data,archs:{'partner,false,list':'<tree string="Partner">'+'<field name="display_name"/>'+'<field name="foo"/>'+'</tree>','partner,false,search':'<search>'+'<field name="foo" filter_domain="[(\'display_name\',\'ilike\',self), (\'foo\',\'ilike\',self)]"/>'+'<group expand="0" string="Group By">'+'<filter name="groupby_bar" context="{\'group_by\' : \'bar\'}"/>'+'</group>'+'</search>',},mockRPC:function(route,args){if(args.method==='web_read_group'){assert.deepEqual(args.kwargs,{context:{search_default_foo:"piou",search_default_groupby_bar:true,},domain:["&",["display_name","like","a"],"&",["display_name","ilike","piou"],["foo","ilike","piou"]],fields:["display_name","foo","bar"],groupby:["bar"],orderby:'',lazy:true,limit:80,},"should search with the complete domain (domain + search), and group by 'bar'");}
if(search===0&&route==='/web/dataset/search_read'){search++;assert.deepEqual(args,{context:{search_default_foo:"piou",search_default_groupby_bar:true,bin_size:true},domain:["&",["display_name","like","a"],"&",["display_name","ilike","piou"],["foo","ilike","piou"]],fields:["display_name","foo"],model:"partner",limit:80,sort:""},"should search with the complete domain (domain + search)");}else if(search===1&&route==='/web/dataset/search_read'){assert.deepEqual(args,{context:{search_default_foo:"piou",search_default_groupby_bar:true,bin_size:true},domain:[["display_name","like","a"]],fields:["display_name","foo"],model:"partner",limit:80,sort:""},"should search with the domain");}
return this._super.apply(this,arguments);},});var dialog;new dialogs.SelectCreateDialog(parent,{no_create:true,readonly:true,res_model:'partner',domain:[['display_name','like','a']],context:{search_default_groupby_bar:true,search_default_foo:'piou',},}).open().then(function(result){dialog=result;});await testUtils.nextTick();await cpHelpers.removeFacet('.modal',"Bar");await cpHelpers.removeFacet('.modal');parent.destroy();});QUnit.test('SelectCreateDialog correctly evaluates domains',async function(assert){assert.expect(1);var parent=await createParent({data:this.data,archs:{'partner,false,list':'<tree string="Partner">'+'<field name="display_name"/>'+'<field name="foo"/>'+'</tree>','partner,false,search':'<search>'+'<field name="foo"/>'+'</search>',},mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,[['id','=',2]],"should have correctly evaluated the domain");}
return this._super.apply(this,arguments);},session:{user_context:{uid:2},},});new dialogs.SelectCreateDialog(parent,{no_create:true,readonly:true,res_model:'partner',domain:"[['id', '=', uid]]",}).open();await testUtils.nextTick();parent.destroy();});QUnit.test('SelectCreateDialog list view in readonly',async function(assert){assert.expect(1);var parent=await createParent({data:this.data,archs:{'partner,false,list':'<tree string="Partner" editable="bottom">'+'<field name="display_name"/>'+'<field name="foo"/>'+'</tree>','partner,false,search':'<search/>'},});var dialog;new dialogs.SelectCreateDialog(parent,{res_model:'partner',}).open().then(function(result){dialog=result;});await testUtils.nextTick();await testUtils.dom.click(dialog.$('.o_list_view tbody tr:first td:not(.o_list_record_selector):first'));assert.equal(dialog.$('.o_list_view tbody tr:first td:not(.o_list_record_selector):first input').length,0,"list view should not be editable in a SelectCreateDialog");parent.destroy();});QUnit.test('SelectCreateDialog cascade x2many in create mode',async function(assert){assert.expect(5);var form=await createView({View:FormView,model:'product',data:this.data,arch:'<form>'+'<field name="name"/>'+'<field name="partner" widget="one2many" >'+'<tree editable="top">'+'<field name="display_name"/>'+'<field name="instrument"/>'+'</tree>'+'</field>'+'</form>',res_id:1,archs:{'partner,false,form':'<form>'+'<field name="name"/>'+'<field name="instrument" widget="one2many" mode="tree"/>'+'</form>','instrument,false,form':'<form>'+'<field name="name"/>'+'<field name="badassery">'+'<tree>'+'<field name="level"/>'+'</tree>'+'</field>'+'</form>','badassery,false,list':'<tree>'+'<field name="level"/>'+'</tree>','badassery,false,search':'<search>'+'<field name="level"/>'+'</search>',},mockRPC:function(route,args){if(route==='/web/dataset/call_kw/partner/get_formview_id'){return Promise.resolve(false);}
if(route==='/web/dataset/call_kw/instrument/get_formview_id'){return Promise.resolve(false);}
if(route==='/web/dataset/call_kw/instrument/create'){assert.deepEqual(args.args,[{badassery:[[6,false,[1]]],name:"ABC"}],'The method create should have been called with the right arguments');return Promise.resolve(false);}
return this._super(route,args);},});await testUtils.form.clickEdit(form);await testUtils.dom.click(form.$('.o_field_x2many_list_row_add a'));await testUtils.fields.many2one.createAndEdit("instrument");var $modal=$('.modal-lg');assert.equal($modal.length,1,'There should be one modal');await testUtils.dom.click($modal.find('.o_field_x2many_list_row_add a'));var $modals=$('.modal-lg');assert.equal($modals.length,2,'There should be two modals');var $second_modal=$modals.not($modal);await testUtils.dom.click($second_modal.find('.o_list_table.table.table-sm.table-striped.o_list_table_ungrouped .o_data_row input[type=checkbox]'));await testUtils.dom.click($second_modal.find('.o_select_button'));$modal=$('.modal-lg');assert.equal($modal.length,1,'There should be one modal');assert.equal($modal.find('.o_data_cell').text(),'Awsome','There should be one item in the list of the modal');await testUtils.dom.click($modal.find('.btn.btn-primary'));form.destroy();});QUnit.test('Form dialog and subview with _view_ref contexts',async function(assert){assert.expect(2);this.data.instrument.records=[{id:1,name:'Tromblon',badassery:[1]}];this.data.partner.records[0].instrument=1;var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="name"/>'+'<field name="instrument" context="{\'tree_view_ref\': \'some_tree_view\'}"/>'+'</form>',res_id:1,archs:{'instrument,false,form':'<form>'+'<field name="name"/>'+'<field name="badassery" context="{\'tree_view_ref\': \'some_other_tree_view\'}"/>'+'</form>','badassery,false,list':'<tree>'+'<field name="level"/>'+'</tree>',},viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super(route,args);},interceptsPropagate:{load_views:function(ev){var evaluatedContext=ev.data.context;if(ev.data.modelName==='instrument'){assert.deepEqual(evaluatedContext,{tree_view_ref:'some_tree_view'},'The correct _view_ref should have been sent to the server, first time');}
if(ev.data.modelName==='badassery'){assert.deepEqual(evaluatedContext,{base_model_name:'instrument',tree_view_ref:'some_other_tree_view',},'The correct _view_ref should have been sent to the server for the subview');}},},});await testUtils.dom.click(form.$('.o_field_widget[name="instrument"] button.o_external_button'));form.destroy();});QUnit.test('SelectCreateDialog: save current search',async function(assert){assert.expect(4);testUtils.mock.patch(ListController,{getOwnedQueryParams:function(){return{context:{shouldBeInFilterContext:true,},};},});var parent=await createParent({data:this.data,archs:{'partner,false,list':'<tree>'+'<field name="display_name"/>'+'</tree>','partner,false,search':'<search>'+'<filter name="bar" help="Bar" domain="[(\'bar\', \'=\', True)]"/>'+'</search>',},env:{dataManager:{create_filter:function(filter){assert.strictEqual(filter.domain,`[("bar", "=", True)]`,"should save the correct domain");const expectedContext={group_by:[],shouldBeInFilterContext:true,};assert.deepEqual(filter.context,expectedContext,"should save the correct context");},}},});var dialog;new dialogs.SelectCreateDialog(parent,{context:{shouldNotBeInFilterContext:false},res_model:'partner',}).open().then(function(result){dialog=result;});await testUtils.nextTick();assert.containsN(dialog,'.o_data_row',3,"should contain 3 records");await cpHelpers.toggleFilterMenu('.modal');await cpHelpers.toggleMenuItem('.modal',"Bar");assert.containsN(dialog,'.o_data_row',2,"should contain 2 records");await cpHelpers.toggleFavoriteMenu('.modal');await cpHelpers.toggleSaveFavorite('.modal');await cpHelpers.editFavoriteName('.modal',"some name");await cpHelpers.saveFavorite('.modal');testUtils.mock.unpatch(ListController);parent.destroy();});QUnit.test('propagate can_create onto the search popup o2m',async function(assert){assert.expect(4);this.data.instrument.records=[{id:1,name:'Tromblon1'},{id:2,name:'Tromblon2'},{id:3,name:'Tromblon3'},{id:4,name:'Tromblon4'},{id:5,name:'Tromblon5'},{id:6,name:'Tromblon6'},{id:7,name:'Tromblon7'},{id:8,name:'Tromblon8'},];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form>'+'<field name="name"/>'+'<field name="instrument" can_create="false"/>'+'</form>',res_id:1,archs:{'instrument,false,list':'<tree>'+'<field name="name"/>'+'</tree>','instrument,false,search':'<search>'+'<field name="name"/>'+'</search>',},viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='get_formview_id'){return Promise.resolve(false);}
return this._super(route,args);},});await testUtils.fields.many2one.clickOpenDropdown('instrument');assert.containsNone(form,'.ui-autocomplete a:contains(Start typing...)');await testUtils.fields.editInput(form.el.querySelector(".o_field_many2one[name=instrument] input"),"a");assert.containsNone(form,'.ui-autocomplete a:contains(Create and Edit)');await testUtils.fields.editInput(form.el.querySelector(".o_field_many2one[name=instrument] input"),"");await testUtils.fields.many2one.clickItem('instrument','Search More...');var $modal=$('.modal-dialog.modal-lg');assert.strictEqual($modal.length,1,'Modal present');assert.strictEqual($modal.find('.modal-footer button').text(),"Cancel",'Only the cancel button is present in modal');form.destroy();});QUnit.test('formviewdialog is not closed when button handlers return a rejected promise',async function(assert){assert.expect(3);this.data.partner.fields.poney_ids={string:"Poneys",type:"one2many",relation:'partner'};this.data.partner.records[0].poney_ids=[];var reject=true;var parent=await createParent({data:this.data,archs:{'partner,false,form':'<form string="Partner">'+'<field name="poney_ids"><tree><field name="display_name"/></tree></field>'+'</form>',},});new dialogs.FormViewDialog(parent,{res_model:'partner',res_id:1,buttons:[{text:'Click me !',classes:"btn-secondary o_form_button_magic",close:true,click:function(){return reject?Promise.reject():Promise.resolve();},}],}).open();await testUtils.nextTick();assert.strictEqual($('.modal').length,1,"should have a modal displayed");await testUtils.dom.click($('.modal .o_form_button_magic'));assert.strictEqual($('.modal').length,1,"modal should still be opened");reject=false;await testUtils.dom.click($('.modal .o_form_button_magic'));assert.strictEqual($('.modal').length,0,"modal should be closed");parent.destroy();});});});;

/* /web/static/tests/views/search_panel_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define("web/static/tests/views/search_panel_tests.js",function(require){"use strict";const FormView=require('web.FormView');const KanbanView=require('web.KanbanView');const ListView=require('web.ListView');const testUtils=require('web.test_utils');const SearchPanel=require("web/static/src/js/views/search_panel.js");const cpHelpers=testUtils.controlPanel;const createActionManager=testUtils.createActionManager;const createView=testUtils.createView;function getCounters(view){return[...view.el.querySelectorAll('.o_search_panel_counter')].map(counter=>Number(counter.innerText.trim()));}
function toggleFold(widget,text){const headers=[...widget.el.querySelectorAll(".o_search_panel_category_value header")];const target=headers.find((header)=>header.innerText.trim().startsWith(text));return testUtils.dom.click(target);}
QUnit.module('Views',{beforeEach:function(){this.data={partner:{fields:{foo:{string:"Foo",type:'char'},bar:{string:"Bar",type:'boolean'},int_field:{string:"Int Field",type:'integer',group_operator:'sum'},company_id:{string:"company",type:'many2one',relation:'company'},company_ids:{string:"Companies",type:'many2many',relation:'company'},category_id:{string:"category",type:'many2one',relation:'category'},state:{string:"State",type:'selection',selection:[['abc',"ABC"],['def',"DEF"],['ghi',"GHI"]]},},records:[{id:1,bar:true,foo:"yop",int_field:1,company_ids:[3],company_id:3,state:'abc',category_id:6},{id:2,bar:true,foo:"blip",int_field:2,company_ids:[3],company_id:5,state:'def',category_id:7},{id:3,bar:true,foo:"gnap",int_field:4,company_ids:[],company_id:3,state:'ghi',category_id:7},{id:4,bar:false,foo:"blip",int_field:8,company_ids:[5],company_id:5,state:'ghi',category_id:7},]},company:{fields:{name:{string:"Display Name",type:'char'},parent_id:{string:'Parent company',type:'many2one',relation:'company'},category_id:{string:'Category',type:'many2one',relation:'category'},},records:[{id:3,name:"asustek",category_id:6},{id:5,name:"agrolait",category_id:7},],},category:{fields:{name:{string:"Category Name",type:'char'},},records:[{id:6,name:"gold"},{id:7,name:"silver"},]},};this.actions=[{id:1,name:'Partners',res_model:'partner',type:'ir.actions.act_window',views:[[false,'kanban'],[false,'list'],[false,'pivot'],[false,'form']],},{id:2,name:'Partners',res_model:'partner',type:'ir.actions.act_window',views:[[false,'form']],}];this.archs={'partner,false,list':'<tree><field name="foo"/></tree>','partner,false,kanban':`<kanban>
                    <templates>
                        <div t-name="kanban-box" class="oe_kanban_global_click">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,'partner,false,form':`<form>
                    <button name="1" type="action" string="multi view"/>
                    <field name="foo"/>
                </form>`,'partner,false,pivot':'<pivot><field name="int_field" type="measure"/></pivot>','partner,false,search':`<search>
                    <searchpanel>
                        <field name="company_id" enable_counters="1" expand="1"/>
                        <field name="category_id" select="multi" enable_counters="1" expand="1"/>
                    </searchpanel>
                </search>`,};},},function(){QUnit.module('SearchPanel');QUnit.test('basic rendering',async function(assert){assert.expect(16);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method+' on '+args.model);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                            <field name="category_id" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});assert.containsOnce(kanban,'.o_content.o_controller_with_searchpanel > .o_search_panel');assert.containsOnce(kanban,'.o_content.o_controller_with_searchpanel > .o_kanban_view');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',4);assert.containsN(kanban,'.o_search_panel_section',2);var $firstSection=kanban.$('.o_search_panel_section:first');assert.hasClass($firstSection.find('.o_search_panel_section_header i'),'fa-folder');assert.containsOnce($firstSection,'.o_search_panel_section_header:contains(company)');assert.containsN($firstSection,'.o_search_panel_category_value',3);assert.containsOnce($firstSection,'.o_search_panel_category_value:first .active');assert.strictEqual($firstSection.find('.o_search_panel_category_value').text().replace(/\s/g,''),'Allasustek2agrolait2');var $secondSection=kanban.$('.o_search_panel_section:nth(1)');assert.hasClass($secondSection.find('.o_search_panel_section_header i'),'fa-filter');assert.containsOnce($secondSection,'.o_search_panel_section_header:contains(category)');assert.containsN($secondSection,'.o_search_panel_filter_value',2);assert.strictEqual($secondSection.find('.o_search_panel_filter_value').text().replace(/\s/g,''),'gold1silver3');assert.verifySteps(['search_panel_select_range on partner','search_panel_select_multi_range on partner',]);kanban.destroy();});QUnit.test('sections with custom icon and color',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" icon="fa-car" color="blue" enable_counters="1"/>
                            <field name="state" select="multi" icon="fa-star" color="#000" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});assert.hasClass(kanban.$('.o_search_panel_section_header:first i'),'fa-car');assert.hasAttrValue(kanban.$('.o_search_panel_section_header:first i'),'style="{color: blue}"');assert.hasClass(kanban.$('.o_search_panel_section_header:nth(1) i'),'fa-star');assert.hasAttrValue(kanban.$('.o_search_panel_section_header:nth(1) i'),'style="{color: #000}"');kanban.destroy();});QUnit.test('sections with attr invisible="1" are ignored',async function(assert){assert.expect(3);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`<kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                            <field name="state" select="multi" invisible="1" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method||route);}
return this._super.apply(this,arguments);},});assert.containsOnce(kanban,'.o_search_panel_section');assert.verifySteps(['search_panel_select_range',]);kanban.destroy();});QUnit.test('categories and filters order is kept',async function(assert){assert.expect(4);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                            <field name="category_id" select="multi" enable_counters="1"/>
                            <field name="state" enable_counters="1"/>
                        </searchpanel>
                    </search>`,}});assert.containsN(kanban,'.o_search_panel_section',3);assert.strictEqual(kanban.$('.o_search_panel_section_header:nth(0)').text().trim(),'company');assert.strictEqual(kanban.$('.o_search_panel_section_header:nth(1)').text().trim(),'category');assert.strictEqual(kanban.$('.o_search_panel_section_header:nth(2)').text().trim(),'State');kanban.destroy();});QUnit.test('specify active category value in context and manually change category',async function(assert){assert.expect(5);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                            <field name="state" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},context:{searchpanel_default_company_id:false,searchpanel_default_state:'ghi',},});assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value header.active label')].map(el=>el.innerText),['All','GHI']);await testUtils.dom.click(kanban.el.querySelectorAll('.o_search_panel_category_value header')[4]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value header.active label')].map(el=>el.innerText),['All','ABC']);assert.verifySteps(['[["state","=","ghi"]]','[["state","=","abc"]]']);kanban.destroy();});QUnit.test('use category (on many2one) to refine search',async function(assert){assert.expect(14);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},domain:[['bar','=',true]],});await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(1) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',2);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:first header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',3);assert.verifySteps(['[["bar","=",true]]','["&",["bar","=",true],["company_id","child_of",3]]','["&",["bar","=",true],["company_id","child_of",5]]','[["bar","=",true]]',]);kanban.destroy();});QUnit.test('use category (on selection) to refine search',async function(assert){assert.expect(14);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(1) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(3) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(3) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',2);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:first header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);assert.verifySteps(['[]','[["state","=","abc"]]','[["state","=","ghi"]]','[]',]);kanban.destroy();});QUnit.test('category has been archived',async function(assert){assert.expect(2);this.data.company.fields.active={type:'boolean',string:'Archived'};this.data.company.records=[{name:'Company 5',id:5,active:true,},{name:'child of 5 archived',parent_id:5,id:666,active:false,},{name:'child of 666',parent_id:666,id:777,active:true,}];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                  <templates>
                    <t t-name="kanban-box">
                      <div>
                        <field name="foo"/>
                      </div>
                    </t>
                  </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},mockRPC:async function(route,args){if(route==='/web/dataset/call_kw/partner/search_panel_select_range'){var results=await this._super.apply(this,arguments);results.values=results.values.filter(rec=>rec.active!==false);return Promise.resolve(results);}
return this._super.apply(this,arguments);},});assert.containsN(kanban,'.o_search_panel_category_value',2,'The number of categories should be 2: All and Company 5');assert.containsNone(kanban,'.o_toggle_fold > i','None of the categories should have children');kanban.destroy();});QUnit.test('use two categories to refine search',async function(assert){assert.expect(14);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                            <field name="state" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},domain:[['bar','=',true]],});assert.containsN(kanban,'.o_search_panel_section',2);assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',3);await testUtils.dom.click([...kanban.el.querySelectorAll('.o_search_panel_category_value header .o_search_panel_label_title')].filter(el=>el.innerText==='asustek'));assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',2);await testUtils.dom.click([...kanban.el.querySelectorAll('.o_search_panel_category_value header .o_search_panel_label_title')].filter(el=>el.innerText==='ABC'));assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click([...kanban.el.querySelectorAll('.o_search_panel_category_value header .o_search_panel_label_title')].filter(el=>el.innerText==='GHI'));assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click(kanban.$('.o_search_panel_section:first .o_search_panel_category_value:first header'));assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click(kanban.$('.o_search_panel_section:nth(1) .o_search_panel_category_value:first header'));assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',3);assert.verifySteps(['[["bar","=",true]]','["&",["bar","=",true],["company_id","child_of",3]]','["&",["bar","=",true],"&",["company_id","child_of",3],["state","=","abc"]]','["&",["bar","=",true],"&",["company_id","child_of",3],["state","=","ghi"]]','["&",["bar","=",true],["state","=","ghi"]]','[["bar","=",true]]',]);kanban.destroy();});QUnit.test('category with parent_field',async function(assert){assert.expect(33);this.data.company.records.push({id:40,name:'child company 1',parent_id:5});this.data.company.records.push({id:41,name:'child company 2',parent_id:5});this.data.partner.records[1].company_id=40;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},});assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);assert.containsN(kanban,'.o_search_panel_category_value',3);assert.containsOnce(kanban,'.o_search_panel_category_value .o_toggle_fold > i');await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) > header'));await testUtils.dom.click(kanban.$('.o_search_panel_category_value:first > header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);assert.containsN(kanban,'.o_search_panel_category_value',5);assert.containsN(kanban,'.o_search_panel_category_value .o_search_panel_category_value',2);await testUtils.dom.click(kanban.$('.o_search_panel_category_value .o_search_panel_category_value:first header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value .o_search_panel_category_value:first .active');assert.containsOnce(kanban,'.o_kanban_record:not(.o_kanban_ghost)');await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) > header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsOnce(kanban,'.o_kanban_record:not(.o_kanban_ghost)');await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) > header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsN(kanban,'.o_search_panel_category_value',3);assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) > header'));await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) > header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsN(kanban,'.o_search_panel_category_value',3);assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);assert.verifySteps(['[]','[["company_id","child_of",5]]','[]','[["company_id","child_of",40]]','[["company_id","child_of",5]]',]);kanban.destroy();});QUnit.test('category with no parent_field',async function(assert){assert.expect(10);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="category_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);assert.containsN(kanban,'.o_search_panel_category_value',3);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(1) .active');assert.containsOnce(kanban,'.o_kanban_record:not(.o_kanban_ghost)');assert.verifySteps(['[]','[["category_id","=",6]]',]);kanban.destroy();});QUnit.test('can (un)fold parent category values',async function(assert){assert.expect(7);this.data.company.records.push({id:40,name:'child company 1',parent_id:5});this.data.company.records.push({id:41,name:'child company 2',parent_id:5});this.data.partner.records[1].company_id=40;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},});assert.strictEqual(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i').length,1,"'agrolait' should be displayed as a parent category value");assert.hasClass(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i'),'fa-caret-right',"'agrolait' should be folded");assert.containsN(kanban,'.o_search_panel_category_value',3);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i'));assert.hasClass(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i'),'fa-caret-down',"'agrolait' should be open");assert.containsN(kanban,'.o_search_panel_category_value',5);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i'));assert.hasClass(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i'),'fa-caret-right',"'agrolait' should be folded");assert.containsN(kanban,'.o_search_panel_category_value',3);kanban.destroy();});QUnit.test('fold status is kept at reload',async function(assert){assert.expect(4);this.data.company.records.push({id:40,name:'child company 1',parent_id:5});this.data.company.records.push({id:41,name:'child company 2',parent_id:5});this.data.partner.records[1].company_id=40;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},});await testUtils.dom.click(kanban.$('.o_search_panel_category_value:contains(agrolait) > header'));assert.hasClass(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i'),'fa-caret-down',"'agrolait' should be open");assert.containsN(kanban,'.o_search_panel_category_value',5);await kanban.reload({});assert.hasClass(kanban.$('.o_search_panel_category_value:contains(agrolait) .o_toggle_fold > i'),'fa-caret-down',"'agrolait' should be open");assert.containsN(kanban,'.o_search_panel_category_value',5);kanban.destroy();});QUnit.test('concurrency: delayed search_reads',async function(assert){assert.expect(19);var def;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));return Promise.resolve(def).then(_.constant(result));}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},domain:[['bar','=',true]],});assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',3);def=testUtils.makeTestPromise();var asustekDef=def;await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(1) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',3);def=testUtils.makeTestPromise();var agrolaitDef=def;await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',3);asustekDef.resolve();await testUtils.nextTick();assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',3);agrolaitDef.resolve();await testUtils.nextTick();assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);assert.verifySteps(['[["bar","=",true]]','["&",["bar","=",true],["company_id","child_of",3]]','["&",["bar","=",true],["company_id","child_of",5]]',]);kanban.destroy();});QUnit.test("concurrency: single category",async function(assert){assert.expect(12);let prom=testUtils.makeTestPromise();const kanbanPromise=createView({arch:`
                <kanban>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,archs:{"partner,false,search":`
                    <search>
                        <filter name="Filter" domain="[('id', '=', 1)]"/>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},context:{searchpanel_default_company_id:[5],},data:this.data,async mockRPC(route,args){const _super=this._super.bind(this);if(route!=="/web/dataset/search_read"){await prom;}
assert.step(args.method||route);return _super(...arguments);},model:'partner',View:KanbanView,});await testUtils.nextTick();assert.verifySteps([]);prom.resolve();const kanban=await kanbanPromise;assert.verifySteps(["search_panel_select_range","/web/dataset/search_read",]);prom=testUtils.makeTestPromise();await testUtils.controlPanel.toggleFilterMenu(kanban);await testUtils.controlPanel.toggleMenuItem(kanban,0);assert.verifySteps([]);prom.resolve();await testUtils.nextTick();assert.verifySteps(["search_panel_select_range","/web/dataset/search_read",]);prom=testUtils.makeTestPromise();await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.verifySteps(["/web/dataset/search_read"]);prom.resolve();await testUtils.nextTick();assert.verifySteps(["search_panel_select_range"]);kanban.destroy();});QUnit.test("concurrency: category and filter",async function(assert){assert.expect(5);let prom=testUtils.makeTestPromise();const kanbanPromise=createView({arch:`
                <kanban>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,archs:{"partner,false,search":`
                    <search>
                        <searchpanel>
                            <field name="category_id" enable_counters="1"/>
                            <field name="company_id" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,async mockRPC(route,args){const _super=this._super.bind(this);if(route!=="/web/dataset/search_read"){await prom;}
assert.step(args.method||route);return _super(...arguments);},model:'partner',View:KanbanView,});await testUtils.nextTick();assert.verifySteps(["/web/dataset/search_read"]);prom.resolve();const kanban=await kanbanPromise;assert.verifySteps(["search_panel_select_range","search_panel_select_multi_range",]);kanban.destroy();});QUnit.test("concurrency: category and filter with a domain",async function(assert){assert.expect(5);let prom=testUtils.makeTestPromise();const kanbanPromise=createView({arch:`
                <kanban>
                    <templates>
                        <div t-name="kanban-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </kanban>`,archs:{"partner,false,search":`
                    <search>
                        <searchpanel>
                            <field name="category_id" enable_counters="1"/>
                            <field name="company_id" select="multi" domain="[['category_id', '=', category_id]]" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,async mockRPC(route,args){const _super=this._super.bind(this);if(route!=="/web/dataset/search_read"){await prom;}
assert.step(args.method||route);return _super(...arguments);},model:'partner',View:KanbanView,});await testUtils.nextTick();assert.verifySteps([]);prom.resolve();const kanban=await kanbanPromise;assert.verifySteps(["search_panel_select_range","search_panel_select_multi_range","/web/dataset/search_read",]);kanban.destroy();});QUnit.test('concurrency: misordered get_filters',async function(assert){assert.expect(15);var def;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='search_panel_select_multi_range'){return Promise.resolve(def).then(_.constant(result));}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" enable_counters="1"/>
                            <field name="company_id" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',4);def=testUtils.makeTestPromise();var abcDef=def;await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(1) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',1);def=testUtils.makeTestPromise();var ghiDef=def;await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(3) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(3) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',2);ghiDef.resolve();await testUtils.nextTick();assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(3) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',2);abcDef.resolve();await testUtils.nextTick();assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(3) .active');assert.containsN(kanban,'.o_kanban_record:not(.o_kanban_ghost)',2);kanban.destroy();});QUnit.test('concurrency: delayed get_filter',async function(assert){assert.expect(3);var def;var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='search_panel_select_multi_range'){return Promise.resolve(def).then(_.constant(result));}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <filter name="Filter" domain="[('id', '=', 1)]"/>
                        <searchpanel>
                            <field name="company_id" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',4);def=testUtils.makeTestPromise();await cpHelpers.toggleFilterMenu(kanban);await cpHelpers.toggleMenuItem(kanban,0);await testUtils.nextTick();assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',4);def.resolve();await testUtils.nextTick();assert.containsOnce(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)');kanban.destroy();});QUnit.test('use filter (on many2one) to refine search',async function(assert){assert.expect(32);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='search_panel_select_multi_range'){var keys=['field_name','group_by','comodel_domain','search_domain','category_domain'];assert.deepEqual(_.pick(args.kwargs,keys),{group_by:false,comodel_domain:[],search_domain:[['bar','=',true]],category_domain:[],});assert.step(JSON.stringify(args.kwargs.filter_domain));}
if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},domain:[['bar','=',true]],});assert.containsN(kanban,'.o_search_panel_filter_value',2);assert.containsNone(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolait1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',3);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:first input'));assert.containsOnce(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolait1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',2);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:nth(1) input'));assert.containsN(kanban,'.o_search_panel_filter_value input:checked',2);assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolait1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',3);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:first input'));assert.containsOnce(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolait1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:nth(1) input'));assert.containsNone(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolait1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',3);assert.verifySteps(['[]','[["bar","=",true]]','[]','["&",["bar","=",true],["company_id","in",[3]]]','[]','["&",["bar","=",true],["company_id","in",[3,5]]]','[]','["&",["bar","=",true],["company_id","in",[5]]]','[]','[["bar","=",true]]',]);kanban.destroy();});QUnit.test('use filter (on selection) to refine search',async function(assert){assert.expect(32);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='search_panel_select_multi_range'){var keys=['group_by','comodel_domain','search_domain','category_domain'];assert.deepEqual(_.pick(args.kwargs,keys),{group_by:false,comodel_domain:[],search_domain:[['bar','=',true]],category_domain:[],});assert.step(JSON.stringify(args.kwargs.filter_domain));}
if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" select="multi" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},domain:[['bar','=',true]],});assert.containsN(kanban,'.o_search_panel_filter_value',3);assert.containsNone(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'ABC1DEF1GHI1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',3);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:first input'));assert.containsOnce(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'ABC1DEF1GHI1');assert.containsOnce(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',1);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:nth(1) input'));assert.containsN(kanban,'.o_search_panel_filter_value input:checked',2);assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'ABC1DEF1GHI1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',2);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:first input'));assert.containsOnce(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'ABC1DEF1GHI1');assert.containsOnce(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)');await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:nth(1) input'));assert.containsNone(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'ABC1DEF1GHI1');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',3);assert.verifySteps(['[]','[["bar","=",true]]','[]','["&",["bar","=",true],["state","in",["abc"]]]','[]','["&",["bar","=",true],["state","in",["abc","def"]]]','[]','["&",["bar","=",true],["state","in",["def"]]]','[]','[["bar","=",true]]',]);kanban.destroy();});QUnit.test("only reload categories and filters when domains change (counters disabled, selection)",async function(assert){assert.expect(8);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <filter name="Filter" domain="[('id', '&lt;', 5)]"/>
                        <searchpanel>
                            <field name="state" expand="1"/>
                            <field name="company_id" select="multi" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},viewOptions:{limit:2,},});assert.verifySteps(['search_panel_select_range','search_panel_select_multi_range',]);await cpHelpers.pagerNext(kanban);assert.verifySteps([]);await cpHelpers.toggleFilterMenu(kanban);await cpHelpers.toggleMenuItem(kanban,0);assert.verifySteps(['search_panel_select_multi_range',]);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.verifySteps(['search_panel_select_multi_range',]);kanban.destroy();});QUnit.test("only reload categories and filters when domains change (counters disabled, many2one)",async function(assert){assert.expect(8);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <filter name="domain" domain="[('id', '&lt;', 5)]"/>
                        <searchpanel>
                            <field name="category_id" expand="1"/>
                            <field name="company_id" select="multi" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},viewOptions:{limit:2,},});assert.verifySteps(['search_panel_select_range','search_panel_select_multi_range',]);await cpHelpers.pagerNext(kanban);assert.verifySteps([]);await cpHelpers.toggleFilterMenu(kanban);await cpHelpers.toggleMenuItem(kanban,0);assert.verifySteps(['search_panel_select_multi_range',]);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.verifySteps(['search_panel_select_multi_range',]);kanban.destroy();});QUnit.test('category counters',async function(assert){assert.expect(16);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
if(route==="/web/dataset/call_kw/partner/search_panel_select_range"){assert.step(args.args[0]);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <filter name="Filter" domain="[('id', '&lt;', 3)]"/>
                        <searchpanel>
                            <field name="state" enable_counters="1" expand="1"/>
                            <field name="company_id" expand="1"/>
                        </searchpanel>
                    </search>`,},viewOptions:{limit:2,},});assert.verifySteps(['search_panel_select_range','state','search_panel_select_range','company_id',]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC1","DEF1","GHI2","All","asustek","agrolait"]);await cpHelpers.pagerNext(kanban);assert.verifySteps([]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC1","DEF1","GHI2","All","asustek","agrolait"]);await cpHelpers.toggleFilterMenu(kanban);await cpHelpers.toggleMenuItem(kanban,0);assert.verifySteps(['search_panel_select_range','state',]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC1","DEF1","GHI","All","asustek","agrolait"]);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC1","DEF1","GHI","All","asustek","agrolait"]);assert.verifySteps(['search_panel_select_range','state',]);kanban.destroy();});QUnit.test('category selection without counters',async function(assert){assert.expect(10);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
if(route==="/web/dataset/call_kw/partner/search_panel_select_range"){assert.step(args.args[0]);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <filter name="Filter" domain="[('id', '&lt;', 3)]"/>
                        <searchpanel>
                            <field name="state" expand="1"/>
                        </searchpanel>
                    </search>`,},viewOptions:{limit:2,},});assert.verifySteps(['search_panel_select_range','state',]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC","DEF","GHI"]);await cpHelpers.pagerNext(kanban);assert.verifySteps([]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC","DEF","GHI"]);await cpHelpers.toggleFilterMenu(kanban);await cpHelpers.toggleMenuItem(kanban,0);assert.verifySteps([]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC","DEF","GHI"]);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value')].map(e=>e.innerText.replace(/\s/g,'')),["All","ABC","DEF","GHI"]);assert.verifySteps([]);kanban.destroy();});QUnit.test('filter with groupby',async function(assert){assert.expect(42);this.data.company.records.push({id:11,name:'camptocamp',category_id:7});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='search_panel_select_multi_range'){var keys=['group_by','comodel_domain','search_domain','category_domain'];assert.deepEqual(_.pick(args.kwargs,keys),{group_by:'category_id',comodel_domain:[],search_domain:[['bar','=',true]],category_domain:[],});assert.step(JSON.stringify(args.kwargs.filter_domain));}
if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" groupby="category_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},domain:[['bar','=',true]],});assert.containsN(kanban,'.o_search_panel_filter_group',2);assert.containsOnce(kanban,'.o_search_panel_filter_group:first .o_search_panel_filter_value');assert.containsN(kanban,'.o_search_panel_filter_group:nth(1) .o_search_panel_filter_value',2);assert.containsNone(kanban,'.o_search_panel_filter_value input:checked');assert.strictEqual(kanban.$('.o_search_panel_filter_group > header > div > label').text().replace(/\s/g,''),'goldsilver');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolait1camptocamp');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',3);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:first input'));assert.containsOnce(kanban,'.o_search_panel_filter_value input:checked');var firstGroupCheckbox=kanban.$('.o_search_panel_filter_group:first > header > div > input').get(0);assert.strictEqual(firstGroupCheckbox.checked,true,"first group checkbox should be checked");assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolaitcamptocamp');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',2);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:nth(1) input'));assert.containsN(kanban,'.o_search_panel_filter_value input:checked',2);var secondGroupCheckbox=kanban.$('.o_search_panel_filter_group:nth(1) > header > div > input').get(0);assert.strictEqual(secondGroupCheckbox.checked,false,"second group checkbox should not be checked");assert.strictEqual(secondGroupCheckbox.indeterminate,true,"second group checkbox should be indeterminate");assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustekagrolaitcamptocamp');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',0);await testUtils.dom.click(kanban.$('.o_search_panel_filter_value:nth(2) input'));assert.containsN(kanban,'.o_search_panel_filter_value input:checked',3);secondGroupCheckbox=kanban.$('.o_search_panel_filter_group:nth(1) > header > div > input').get(0);assert.strictEqual(secondGroupCheckbox.checked,true,"second group checkbox should be checked");assert.strictEqual(secondGroupCheckbox.indeterminate,false,"second group checkbox should not be indeterminate");assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustekagrolaitcamptocamp');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',0);await testUtils.dom.click(kanban.$('.o_search_panel_filter_group:nth(1) > header > div > input'));assert.containsOnce(kanban,'.o_search_panel_filter_value input:checked');secondGroupCheckbox=kanban.$('.o_search_panel_filter_group:nth(1) > header > div > input').get(0);assert.strictEqual(secondGroupCheckbox.checked,false,"second group checkbox should not be checked");assert.strictEqual(secondGroupCheckbox.indeterminate,false,"second group checkbox should not be indeterminate");assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolaitcamptocamp');assert.containsN(kanban,'.o_kanban_view .o_kanban_record:not(.o_kanban_ghost)',2);assert.verifySteps(['[]','[["bar","=",true]]','[]','["&",["bar","=",true],["company_id","in",[3]]]','[]','["&",["bar","=",true],"&",["company_id","in",[3]],["company_id","in",[5]]]','[]','["&",["bar","=",true],"&",["company_id","in",[3]],["company_id","in",[5,11]]]','[]','["&",["bar","=",true],["company_id","in",[3]]]',]);kanban.destroy();});QUnit.test('filter with domain',async function(assert){assert.expect(3);this.data.company.records.push({id:40,name:'child company 1',parent_id:3});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='search_panel_select_multi_range'){assert.deepEqual(args.kwargs,{group_by:false,category_domain:[],expand:true,filter_domain:[],search_domain:[],comodel_domain:[['parent_id','=',false]],group_domain:[],enable_counters:true,limit:200,});}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" domain="[('parent_id','=',False)]" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},});assert.containsN(kanban,'.o_search_panel_filter_value',2);assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),'asustek2agrolait2');kanban.destroy();});QUnit.test('filter with domain depending on category',async function(assert){assert.expect(22);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='search_panel_select_multi_range'){var keys=['group_by','search_domain','filter_domain'];assert.deepEqual(_.pick(args.kwargs,keys),{group_by:false,filter_domain:[],search_domain:[],});assert.step(JSON.stringify(args.kwargs.category_domain));assert.step(JSON.stringify(args.kwargs.comodel_domain));}
return result;},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="category_id" enable_counters="1"/>
                            <field name="company_id" select="multi" domain="[['category_id', '=', category_id]]" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.containsOnce(kanban,'.o_search_panel_category_value .active');assert.containsOnce(kanban,'.o_search_panel_category_value:nth(1) .active');assert.containsOnce(kanban,'.o_search_panel_filter_value');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),"asustek1");await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(2) header'));assert.containsOnce(kanban,'.o_search_panel_category_value:nth(2) .active');assert.containsOnce(kanban,'.o_search_panel_filter_value');assert.strictEqual(kanban.$('.o_search_panel_filter_value').text().replace(/\s/g,''),"agrolait2");await testUtils.dom.click(kanban.$('.o_search_panel_category_value:first header'));assert.containsOnce(kanban,'.o_search_panel_category_value:first .active');assert.containsNone(kanban,'.o_search_panel_filter_value');assert.verifySteps(['[]','[["category_id","=",false]]','[["category_id","=",6]]','[["category_id","=",6]]','[["category_id","=",7]]','[["category_id","=",7]]','[]','[["category_id","=",false]]',]);kanban.destroy();});QUnit.test('specify active filter values in context',async function(assert){assert.expect(4);var expectedDomain=["&",['company_id','in',[5]],['state','in',['abc','ghi']],];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" enable_counters="1"/>
                            <field name="state" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,expectedDomain);}
return this._super.apply(this,arguments);},context:{searchpanel_default_company_id:[5],searchpanel_default_state:['abc','ghi'],},});assert.containsN(kanban,'.o_search_panel_filter_value input:checked',3);expectedDomain=[['state','in',['abc','ghi']]];await testUtils.dom.click(kanban.$('.o_search_panel_filter:first .o_search_panel_filter_value:nth(1) input'));assert.containsN(kanban,'.o_search_panel_filter_value input:checked',2);kanban.destroy();});QUnit.test('retrieved filter value from context does not exist',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,[["company_id","in",[3]]]);}
return this._super.apply(this,arguments);},context:{searchpanel_default_company_id:[1,3],},});kanban.destroy();});QUnit.test('filter with groupby and default values in context',async function(assert){assert.expect(2);this.data.company.records.push({id:11,name:'camptocamp',category_id:7});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" groupby="category_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.deepEqual(args.domain,[['company_id','in',[5]]]);}
return this._super.apply(this,arguments);},context:{searchpanel_default_company_id:[5],},});var secondGroupCheckbox=kanban.$('.o_search_panel_filter_group:nth(1) > header > div > input').get(0);assert.strictEqual(secondGroupCheckbox.indeterminate,true);kanban.destroy();});QUnit.test('Does not confuse false and "false" groupby values',async function(assert){assert.expect(6);this.data.company.fields.char_field={string:"Char Field",type:'char'};this.data.company.records=[{id:3,name:'A',char_field:false,},{id:5,name:'B',char_field:'false',}];var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`<kanban>
                    <templates><t t-name="kanban-box">
                        <div>
                            <field name="foo"/>
                        </div>
                    </t></templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" groupby="char_field"/>
                        </searchpanel>
                    </search>`,},});assert.containsOnce(kanban,'.o_search_panel_section');var $firstSection=kanban.$('.o_search_panel_section');assert.containsOnce($firstSection,'.o_search_panel_filter_group');assert.strictEqual($firstSection.find('.o_search_panel_filter_group').text().replace(/\s/g,''),'falseB');assert.containsOnce($firstSection.find('.o_search_panel_filter_group'),'.o_search_panel_filter_value');assert.containsN($firstSection,'.o_search_panel_filter_value',2);assert.strictEqual($firstSection.find('.o_search_panel_filter_value').text().replace(/\s/g,''),'BA');kanban.destroy();});QUnit.test('tests conservation of category record order',async function(assert){assert.expect(1);this.data.company.records.push({id:56,name:'highID',category_id:6});this.data.company.records.push({id:2,name:'lowID',category_id:6});var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1" expand="1"/>
                            <field name="category_id" select="multi" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},});var $firstSection=kanban.$('.o_search_panel_section:first');assert.strictEqual($firstSection.find('.o_search_panel_category_value').text().replace(/\s/g,''),'Allasustek2agrolait2highIDlowID');kanban.destroy();});QUnit.test('search panel is available on list and kanban by default',async function(assert){assert.expect(8);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_kanban_view');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_search_panel');await cpHelpers.switchView(actionManager,'pivot');await testUtils.nextTick();assert.containsOnce(actionManager,'.o_content .o_pivot');assert.containsNone(actionManager,'.o_content .o_search_panel');await cpHelpers.switchView(actionManager,'list');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_list_view');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_search_panel');await testUtils.dom.click(actionManager.$('.o_data_row .o_data_cell:first'));assert.containsOnce(actionManager,'.o_content .o_form_view');assert.containsNone(actionManager,'.o_content .o_search_panel');actionManager.destroy();});QUnit.test('search panel with view_types attribute',async function(assert){assert.expect(6);this.archs['partner,false,search']=`<search>
                <searchpanel view_types="kanban,pivot">
                    <field name="company_id" enable_counters="1"/>
                    <field name="category_id" select="multi" enable_counters="1"/>
                </searchpanel>
            </search>`;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_kanban_view');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_search_panel');await cpHelpers.switchView(actionManager,'list');assert.containsOnce(actionManager,'.o_content .o_list_view');assert.containsNone(actionManager,'.o_content .o_search_panel');await cpHelpers.switchView(actionManager,'pivot');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_pivot');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_search_panel');actionManager.destroy();});QUnit.test('search panel state is shared between views',async function(assert){assert.expect(16);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},});await actionManager.doAction(1);assert.hasClass(actionManager.$('.o_search_panel_category_value:first header'),'active');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',4);await testUtils.dom.click(actionManager.$('.o_search_panel_category_value:nth(1) header'));assert.hasClass(actionManager.$('.o_search_panel_category_value:nth(1) header'),'active');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',2);await cpHelpers.switchView(actionManager,'list');assert.hasClass(actionManager.$('.o_search_panel_category_value:nth(1) header'),'active');assert.containsN(actionManager,'.o_data_row',2);await testUtils.dom.click(actionManager.$('.o_search_panel_category_value:nth(2) header'));assert.hasClass(actionManager.$('.o_search_panel_category_value:nth(2) header'),'active');assert.containsN(actionManager,'.o_data_row',2);await cpHelpers.switchView(actionManager,'kanban');assert.hasClass(actionManager.$('.o_search_panel_category_value:nth(2) header'),'active');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',2);assert.verifySteps(['[]','[["company_id","child_of",3]]','[["company_id","child_of",3]]','[["company_id","child_of",5]]','[["company_id","child_of",5]]',]);actionManager.destroy();});QUnit.test('search panel filters are kept between switch views',async function(assert){assert.expect(17);const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(args.domain));}
return this._super.apply(this,arguments);},});await actionManager.doAction(1);assert.containsNone(actionManager,'.o_search_panel_filter_value input:checked');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',4);await testUtils.dom.click(actionManager.$('.o_search_panel_filter input[type="checkbox"]:nth(0)'));assert.containsOnce(actionManager,'.o_search_panel_filter_value input:checked');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',1);await cpHelpers.switchView(actionManager,'list');assert.containsOnce(actionManager,'.o_search_panel_filter_value input:checked');assert.containsN(actionManager,'.o_data_row',1);await testUtils.dom.click(actionManager.$('.o_search_panel_filter input[type="checkbox"]:nth(1)'));assert.containsN(actionManager,'.o_search_panel_filter_value input:checked',2);assert.containsN(actionManager,'.o_data_row',4);await cpHelpers.switchView(actionManager,'kanban');assert.containsN(actionManager,'.o_search_panel_filter_value input:checked',2);assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',4);await testUtils.dom.click(actionManager.$(".o_kanban_record:nth(0)"));await testUtils.dom.click(actionManager.$(".breadcrumb-item:nth(0)"));assert.verifySteps(['[]','[["category_id","in",[6]]]','[["category_id","in",[6]]]','[["category_id","in",[6,7]]]','[["category_id","in",[6,7]]]','[["category_id","in",[6,7]]]',]);actionManager.destroy();});QUnit.test('search panel filters are kept when switching to a view with no search panel',async function(assert){assert.expect(13);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_kanban_view');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_search_panel');assert.containsNone(actionManager,'.o_search_panel_filter_value input:checked');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',4);await testUtils.dom.click(actionManager.$('.o_search_panel_filter input[type="checkbox"]:nth(0)'));assert.containsOnce(actionManager,'.o_search_panel_filter_value input:checked');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',1);await cpHelpers.switchView(actionManager,'pivot');assert.containsOnce(actionManager,'.o_content .o_pivot');assert.containsNone(actionManager,'.o_content .o_search_panel');assert.strictEqual(actionManager.$('.o_pivot_cell_value').text(),'15');await cpHelpers.switchView(actionManager,'list');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_list_view');assert.containsOnce(actionManager,'.o_content.o_controller_with_searchpanel .o_search_panel');assert.containsOnce(actionManager,'.o_search_panel_filter_value input:checked');assert.containsN(actionManager,'.o_data_row',1);actionManager.destroy();});QUnit.test('after onExecuteAction, selects "All" as default category value',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(2);await testUtils.dom.click(actionManager.$('.o_form_view button:contains("multi view")'));assert.containsOnce(actionManager,'.o_kanban_view');assert.containsOnce(actionManager,'.o_search_panel');assert.containsOnce(actionManager,'.o_search_panel_category_value:first .active');assert.verifySteps([]);actionManager.destroy();});QUnit.test('search panel is not instantiated if stated in context',async function(assert){assert.expect(2);this.actions[0].context={search_panel:false};var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(2);await testUtils.dom.click(actionManager.$('.o_form_view button:contains("multi view")'));assert.containsOnce(actionManager,'.o_kanban_view');assert.containsNone(actionManager,'.o_search_panel');actionManager.destroy();});QUnit.test('categories and filters are not reloaded when switching between views',async function(assert){assert.expect(3);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
return this._super.apply(this,arguments);},});await actionManager.doAction(1);await cpHelpers.switchView(actionManager,'list');await cpHelpers.switchView(actionManager,'kanban');assert.verifySteps(['search_panel_select_range','search_panel_select_multi_range',]);actionManager.destroy();});QUnit.test('scroll position is kept when switching between controllers',async function(assert){assert.expect(6);const originalDebounce=SearchPanel.scrollDebounce;SearchPanel.scrollDebounce=0;for(var i=10;i<20;i++){this.data.category.records.push({id:i,name:"Cat "+i});}
var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});actionManager.$el.css('max-height',300);async function scroll(top){actionManager.el.querySelector(".o_search_panel").scrollTop=top;await testUtils.nextTick();}
await actionManager.doAction(1);assert.containsOnce(actionManager,'.o_content .o_kanban_view');assert.strictEqual(actionManager.$('.o_search_panel').scrollTop(),0);await scroll(50);await cpHelpers.switchView(actionManager,'list');assert.containsOnce(actionManager,'.o_content .o_list_view');assert.strictEqual(actionManager.$('.o_search_panel').scrollTop(),50);await scroll(30);await cpHelpers.switchView(actionManager,'kanban');assert.containsOnce(actionManager,'.o_content .o_kanban_view');assert.strictEqual(actionManager.$('.o_search_panel').scrollTop(),30);actionManager.destroy();SearchPanel.scrollDebounce=originalDebounce;});QUnit.test('search panel is not instantiated in dialogs',async function(assert){assert.expect(2);this.data.company.records=[{id:1,name:'Company1'},{id:2,name:'Company2'},{id:3,name:'Company3'},{id:4,name:'Company4'},{id:5,name:'Company5'},{id:6,name:'Company6'},{id:7,name:'Company7'},{id:8,name:'Company8'},];var form=await createView({View:FormView,model:'partner',data:this.data,arch:'<form><field name="company_id"/></form>',archs:{'company,false,list':'<tree><field name="name"/></tree>','company,false,search':`<search>
                        <field name="name"/>
                        <searchpanel>
                            <field name="category_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});await testUtils.fields.many2one.clickOpenDropdown('company_id');await testUtils.fields.many2one.clickItem('company_id','Search More');assert.containsOnce(document.body,'.modal .o_list_view');assert.containsNone(document.body,'.modal .o_search_panel');form.destroy();});QUnit.test("Reload categories with counters when filter values are selected",async function(assert){assert.expect(8);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="category_id" enable_counters="1"/>
                            <field name="state" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});assert.verifySteps(['search_panel_select_range',"search_panel_select_multi_range",]);assert.deepEqual(getCounters(kanban),[1,3,1,1,2]);await testUtils.dom.click(kanban.el.querySelector('.o_search_panel_filter_value input'));assert.deepEqual(getCounters(kanban),[1,1,1,2]);assert.verifySteps(['search_panel_select_range',"search_panel_select_multi_range",]);kanban.destroy();});QUnit.test("many2one: select one, expand, hierarchize, counters",async function(assert){assert.expect(5);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',3);assert.containsOnce(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1]);await toggleFold(kanban,"agrolait");assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',5);assert.deepEqual(getCounters(kanban),[2,1,1]);kanban.destroy();});QUnit.test("many2one: select one, no expand, hierarchize, counters",async function(assert){assert.expect(5);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',3);assert.containsOnce(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1]);await toggleFold(kanban,"agrolait");assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',4);assert.deepEqual(getCounters(kanban),[2,1,1]);kanban.destroy();});QUnit.test("many2one: select one, expand, no hierarchize, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" hierarchize="0" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',5);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1,1]);kanban.destroy();});QUnit.test("many2one: select one, no expand, no hierarchize, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" hierarchize="0" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1,1]);kanban.destroy();});QUnit.test("many2one: select one, expand, hierarchize, no counters",async function(assert){assert.expect(5);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',3);assert.containsOnce(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);await toggleFold(kanban,"agrolait");assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',5);assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2one: select one, no expand, hierarchize, no counters",async function(assert){assert.expect(5);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',3);assert.containsOnce(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);await toggleFold(kanban,"agrolait");assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',4);assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2one: select one, expand, no hierarchize, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" hierarchize="0" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',5);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2one: select one, no expand, no hierarchize, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:50,name:'agrobeurre',parent_id:5});this.data.company.records.push({id:51,name:'agrocrèmefraiche',parent_id:5});this.data.partner.records[1].company_id=50;const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" hierarchize="0"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2one: select multi, expand, groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" groupby="category_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',5);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,2]);kanban.destroy();});QUnit.test("many2one: select multi, no expand, groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" groupby="category_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,2]);kanban.destroy();});QUnit.test("many2one: select multi, expand, no groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,2]);kanban.destroy();});QUnit.test("many2one: select multi, no expand, no groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',2);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,2]);kanban.destroy();});QUnit.test("many2one: select multi, expand, groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" groupby="category_id" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',5);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2one: select multi, no expand, groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" groupby="category_id"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2one: select multi, expand, no groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2one: select multi, no expand, no groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',2);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2many: select multi, expand, groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi" groupby="category_id" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',5);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1]);kanban.destroy();});QUnit.test("many2many: select multi, no expand, groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi" groupby="category_id" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1]);kanban.destroy();});QUnit.test("many2many: select multi, expand, no groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1]);kanban.destroy();});QUnit.test("many2many: select multi, no expand, no groupby, counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',2);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[2,1]);kanban.destroy();});QUnit.test("many2many: select multi, expand, groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi" groupby="category_id" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',5);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2many: select multi, no expand, groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi" groupby="category_id"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2many: select multi, expand, no groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("many2many: select multi, no expand, no groupby, no counters",async function(assert){assert.expect(3);this.data.company.records.push({id:666,name:"Mordor Inc.",category_id:6});const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_ids" select="multi"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',2);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("selection: select one, expand, counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[1,2]);kanban.destroy();});QUnit.test("selection: select one, no expand, counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[1,2]);kanban.destroy();});QUnit.test("selection: select one, expand, no counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',4);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("selection: select one, no expand, no counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_field .o_search_panel_category_value',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("selection: select multi, expand, counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" select="multi" enable_counters="1" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[1,2]);kanban.destroy();});QUnit.test("selection: select multi, no expand, counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',2);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[1,2]);kanban.destroy();});QUnit.test("selection: select multi, expand, no counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" select="multi" expand="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',3);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("selection: select multi, no expand, no counters",async function(assert){assert.expect(3);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="state" select="multi"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',2);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[]);kanban.destroy();});QUnit.test("selection: select multi, no expand, counters, extra_domain",async function(assert){assert.expect(5);this.data.partner.records.shift();const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id"/>
                            <field name="state" select="multi" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsN(kanban,'.o_search_panel_label',5);assert.containsNone(kanban,'.o_toggle_fold > i');assert.deepEqual(getCounters(kanban),[1,2]);await toggleFold(kanban,"asustek");assert.containsN(kanban,'.o_search_panel_label',5);assert.deepEqual(getCounters(kanban),[1]);kanban.destroy();});QUnit.test("reached limit for a category",async function(assert){assert.expect(6);const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" limit="2"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsOnce(kanban,'.o_search_panel_section');assert.containsOnce(kanban,'.o_search_panel_section_header');assert.strictEqual(kanban.el.querySelector('.o_search_panel_section_header').innerText,"COMPANY");assert.containsOnce(kanban,'section div.alert.alert-warning');assert.strictEqual(kanban.el.querySelector('section div.alert.alert-warning').innerText,"Too many items to display.");assert.containsNone(kanban,'.o_search_panel_category_value');kanban.destroy();});QUnit.test("reached limit for a filter",async function(assert){assert.expect(6);const kanban=await createView({arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="company_id" select="multi" limit="2"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:'partner',View:KanbanView,});assert.containsOnce(kanban,'.o_search_panel_section');assert.containsOnce(kanban,'.o_search_panel_section_header');assert.strictEqual(kanban.el.querySelector('.o_search_panel_section_header').innerText,"COMPANY");assert.containsOnce(kanban,'section div.alert.alert-warning');assert.strictEqual(kanban.el.querySelector('section div.alert.alert-warning').innerText,"Too many items to display.");assert.containsNone(kanban,'.o_search_panel_filter_value');kanban.destroy();});QUnit.test("a selected value becomming invalid should no more impact the view",async function(assert){assert.expect(13);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <filter name="filter_on_def" string="DEF" domain="[('state', '=', 'def')]"/>
                        <searchpanel>
                            <field name="state" enable_counters="1"/>
                        </searchpanel>
                    </search>`,},});assert.verifySteps(['search_panel_select_range',]);assert.containsN(kanban,'.o_kanban_record span',4);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.verifySteps(['search_panel_select_range',]);assert.containsOnce(kanban,'.o_kanban_record span');assert.strictEqual(kanban.el.querySelector('.o_kanban_record span').innerText,'yop');await testUtils.controlPanel.toggleFilterMenu(kanban);await testUtils.controlPanel.toggleMenuItem(kanban,'DEF');assert.verifySteps(['search_panel_select_range',]);const firstCategoryValue=kanban.el.querySelector('.o_search_panel_category_value header');assert.strictEqual(firstCategoryValue.innerText,'All');assert.hasClass(firstCategoryValue,'active',"the value 'All' should be selected since ABC is no longer a valid value with respect to search domain");assert.containsOnce(kanban,'.o_kanban_record span');assert.strictEqual(kanban.el.querySelector('.o_kanban_record span').innerText,'blip');kanban.destroy();});QUnit.test("Categories with default attributes should be udpated when external domain changes",async function(assert){assert.expect(8);const kanban=await createView({View:KanbanView,model:'partner',data:this.data,mockRPC:function(route,args){if(args.method&&args.method.includes('search_panel_')){assert.step(args.method);}
return this._super.apply(this,arguments);},arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="foo"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,archs:{'partner,false,search':`
                    <search>
                        <filter name="filter_on_def" string="DEF" domain="[('state', '=', 'def')]"/>
                        <searchpanel>
                            <field name="state"/>
                        </searchpanel>
                    </search>`,},});assert.verifySteps(['search_panel_select_range',]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value header label')].map(el=>el.innerText),['All','ABC','DEF','GHI']);await testUtils.dom.click(kanban.$('.o_search_panel_category_value:nth(1) header'));assert.verifySteps([]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value header label')].map(el=>el.innerText),['All','ABC','DEF','GHI']);await testUtils.controlPanel.toggleFilterMenu(kanban);await testUtils.controlPanel.toggleMenuItem(kanban,'DEF');assert.verifySteps(['search_panel_select_range',]);assert.deepEqual([...kanban.el.querySelectorAll('.o_search_panel_category_value header label')].map(el=>el.innerText),['All','DEF']);kanban.destroy();});QUnit.test("Category with counters and filter with domain",async function(assert){assert.expect(2);const list=await createView({arch:'<tree><field name="foo"/></tree>',archs:{'partner,false,search':`
                    <search>
                        <searchpanel>
                            <field name="category_id" enable_counters="1"/>
                            <field name="company_id" select="multi" domain="[['category_id', '=', category_id]]"/>
                        </searchpanel>
                    </search>`,},data:this.data,model:"partner",services:this.services,View:ListView,});assert.containsN(list,".o_data_row",4);assert.strictEqual(list.$(".o_search_panel_category_value").text().replace(/\s/g,""),"Allgoldsilver","Category counters should be empty if a filter has a domain attribute");list.destroy();});});});;

/* /web/static/tests/core/ajax_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.ajax_tests',function(require){"use strict";var ajax=require('web.ajax');QUnit.module('core',function(){var test_css_url='/test_assetsbundle/static/src/css/test_cssfile1.css';var test_link_selector='link[href="'+test_css_url+'"]';QUnit.module('ajax',{beforeEach:function(){$(test_link_selector).remove();},afterEach:function(){$(test_link_selector).remove();}});QUnit.test('loadCSS',function(assert){var done=assert.async();assert.expect(2);ajax.loadCSS(test_css_url).then(function(){var $links=$(test_link_selector);assert.strictEqual($links.length,1,"The css should be added to the dom.");ajax.loadCSS(test_css_url).then(function(){var $links=$(test_link_selector);assert.strictEqual($links.length,1,"The css should have been added only once.");done();});});});});});;

/* /web/static/tests/core/registry_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.registry_tests',function(require){"use strict";var Registry=require('web.Registry');QUnit.module('core',{},function(){QUnit.module('Registry');QUnit.test('key set',function(assert){assert.expect(1);var registry=new Registry();var foo={};registry.add('foo',foo);assert.strictEqual(registry.get('foo'),foo);});QUnit.test('get initial keys',function(assert){assert.expect(1);var registry=new Registry({a:1,});assert.deepEqual(registry.keys(),['a'],"keys on prototype should be returned");});QUnit.test('get initial entries',function(assert){assert.expect(1);var registry=new Registry({a:1,});assert.deepEqual(registry.entries(),{a:1,},"entries on prototype should be returned");});QUnit.test('multiget',function(assert){assert.expect(1);var foo={};var bar={};var registry=new Registry({foo:foo,bar:bar,});assert.strictEqual(registry.getAny(['qux','grault','bar','foo']),bar,"Registry getAny should find first defined key");});QUnit.test('keys and values are properly ordered',function(assert){assert.expect(2);var registry=new Registry();registry.add('fred','foo',3).add('george','bar',2).add('ronald','qux',4);assert.deepEqual(registry.keys(),['george','fred','ronald']);assert.deepEqual(registry.values(),['bar','foo','qux']);});QUnit.test("predicate prevents invalid values",function(assert){assert.expect(5);const predicate=value=>typeof value==="number";const registry=new Registry(null,predicate);registry.onAdd((key)=>assert.step(key));assert.ok(registry.add("age",23));assert.throws(()=>registry.add("name","Fred"),new Error(`Value of key "name" does not pass the addition predicate.`));assert.deepEqual(registry.entries(),{age:23});assert.verifySteps(["age"]);});});});;

/* /web/static/tests/core/py_utils_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.py_utils_tests',function(require){"use strict";var Context=require('web.Context');var pyUtils=require('web.py_utils');var time=require('web.time');const r=String.raw;QUnit.assert.checkAST=function(expr,message){var ast=pyUtils._getPyJSAST(expr);var formattedAST=pyUtils._formatAST(ast);this.pushResult({result:expr===formattedAST,actual:formattedAST,expected:expr,message:message});};QUnit.module('core',function(){QUnit.module('py_utils');QUnit.test('simple python expression',function(assert){assert.expect(2);var result=pyUtils.py_eval("True and False");assert.strictEqual(result,false,"should properly evaluate basic expression");result=pyUtils.py_eval("a + b",{a:1,b:41});assert.strictEqual(result,42,"should properly evaluate basic sum");});QUnit.test('simple arithmetic',function(assert){assert.expect(3);var result=pyUtils.py_eval("1 + 2");assert.strictEqual(result,3,"should properly evaluate sum");result=pyUtils.py_eval("42 % 5");assert.strictEqual(result,2,"should properly evaluate modulo operator");result=pyUtils.py_eval("2 ** 3");assert.strictEqual(result,8,"should properly evaluate power operator");});QUnit.test('not prefix',function(assert){assert.expect(3);assert.ok(py.eval('not False'));assert.ok(py.eval('not foo',{foo:false}));assert.ok(py.eval('not a in b',{a:3,b:[1,2,4,8]}));});function makeTimeCheck(assert){var context=pyUtils.context();return function(expr,func,message){var d0=new Date();var result=py.eval(expr,context);var d1=new Date();assert.ok(func(d0)<=result&&result<=func(d1),message);};}
function makeEq(assert,c2){var ctx=pyUtils.context();var c=_.extend({td:ctx.datetime.timedelta},c2||{});return function(a,b,message){assert.ok(py.eval(a+' == '+b,c),message);};}
QUnit.test('strftime',function(assert){assert.expect(3);var check=makeTimeCheck(assert);check("time.strftime('%Y')",function(d){return String(d.getFullYear());});check("time.strftime('%Y')+'-01-30'",function(d){return String(d.getFullYear())+'-01-30';});check("time.strftime('%Y-%m-%d %H:%M:%S')",function(d){return _.str.sprintf('%04d-%02d-%02d %02d:%02d:%02d',d.getUTCFullYear(),d.getUTCMonth()+1,d.getUTCDate(),d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds());});});QUnit.test('context_today',function(assert){assert.expect(1);var check=makeTimeCheck(assert,pyUtils);check("context_today().strftime('%Y-%m-%d')",function(d){return String(_.str.sprintf('%04d-%02d-%02d',d.getFullYear(),d.getMonth()+1,d.getDate()));});});QUnit.test('timedelta.test_constructor',function(assert){assert.expect(16);var eq=makeEq(assert);eq('td()','td(weeks=0, days=0, hours=0, minutes=0, seconds=0, '+'milliseconds=0, microseconds=0)');eq('td(1)','td(days=1)');eq('td(0, 1)','td(seconds=1)');eq('td(0, 0, 1)','td(microseconds=1)');eq('td(weeks=1)','td(days=7)');eq('td(days=1)','td(hours=24)');eq('td(hours=1)','td(minutes=60)');eq('td(minutes=1)','td(seconds=60)');eq('td(seconds=1)','td(milliseconds=1000)');eq('td(milliseconds=1)','td(microseconds=1000)');eq('td(weeks=1.0/7)','td(days=1)');eq('td(days=1.0/24)','td(hours=1)');eq('td(hours=1.0/60)','td(minutes=1)');eq('td(minutes=1.0/60)','td(seconds=1)');eq('td(seconds=0.001)','td(milliseconds=1)');eq('td(milliseconds=0.001)','td(microseconds=1)');});QUnit.test('timedelta.test_computations',function(assert){assert.expect(28);var c=pyUtils.context();var zero=py.float.fromJSON(0);var eq=makeEq(assert,{a:py.PY_call(c.datetime.timedelta,[py.float.fromJSON(7)]),b:py.PY_call(c.datetime.timedelta,[zero,py.float.fromJSON(60)]),c:py.PY_call(c.datetime.timedelta,[zero,zero,py.float.fromJSON(1000)]),});eq('a+b+c','td(7, 60, 1000)');eq('a-b','td(6, 24*3600 - 60)');eq('-a','td(-7)');eq('+a','td(7)');eq('-b','td(-1, 24*3600 - 60)');eq('-c','td(-1, 24*3600 - 1, 999000)');eq('td(6, 24*3600)','a');eq('td(0, 0, 60*1000000)','b');eq('a*10','td(70)');eq('a*10','10*a');eq('b*10','td(0, 600)');eq('10*b','td(0, 600)');eq('c*10','td(0, 0, 10000)');eq('10*c','td(0, 0, 10000)');eq('a*-1','-a');eq('b*-2','-b-b');eq('c*-2','-c+-c');eq('b*(60*24)','(b*60)*24');eq('b*(60*24)','(60*b)*24');eq('c*1000','td(0, 1)');eq('1000*c','td(0, 1)');eq('a//7','td(1)');eq('b//10','td(0, 6)');eq('c//1000','td(0, 0, 1)');eq('a//10','td(0, 7*24*360)');eq('a//3600000','td(0, 0, 7*24*1000)');eq('td(999999999, 86399, 999999) - td(999999999, 86399, 999998)','td(0, 0, 1)');eq('td(999999999, 1, 1) - td(999999999, 1, 0)','td(0, 0, 1)');});QUnit.test('timedelta.test_basic_attributes',function(assert){assert.expect(3);var ctx=pyUtils.context();assert.strictEqual(py.eval('datetime.timedelta(1, 7, 31).days',ctx),1);assert.strictEqual(py.eval('datetime.timedelta(1, 7, 31).seconds',ctx),7);assert.strictEqual(py.eval('datetime.timedelta(1, 7, 31).microseconds',ctx),31);});QUnit.test('timedelta.test_total_seconds',function(assert){assert.expect(6);var c={timedelta:pyUtils.context().datetime.timedelta};assert.strictEqual(py.eval('timedelta(365).total_seconds()',c),31536000);assert.strictEqual(py.eval('timedelta(seconds=123456.789012).total_seconds()',c),123456.789012);assert.strictEqual(py.eval('timedelta(seconds=-123456.789012).total_seconds()',c),-123456.789012);assert.strictEqual(py.eval('timedelta(seconds=0.123456).total_seconds()',c),0.123456);assert.strictEqual(py.eval('timedelta().total_seconds()',c),0);assert.strictEqual(py.eval('timedelta(seconds=1000000).total_seconds()',c),1e6);});QUnit.test('timedelta.test_str',function(assert){assert.expect(10);var c={td:pyUtils.context().datetime.timedelta};assert.strictEqual(py.eval('str(td(1))',c),"1 day, 0:00:00");assert.strictEqual(py.eval('str(td(-1))',c),"-1 day, 0:00:00");assert.strictEqual(py.eval('str(td(2))',c),"2 days, 0:00:00");assert.strictEqual(py.eval('str(td(-2))',c),"-2 days, 0:00:00");assert.strictEqual(py.eval('str(td(hours=12, minutes=58, seconds=59))',c),"12:58:59");assert.strictEqual(py.eval('str(td(hours=2, minutes=3, seconds=4))',c),"2:03:04");assert.strictEqual(py.eval('str(td(weeks=-30, hours=23, minutes=12, seconds=34))',c),"-210 days, 23:12:34");assert.strictEqual(py.eval('str(td(milliseconds=1))',c),"0:00:00.001000");assert.strictEqual(py.eval('str(td(microseconds=3))',c),"0:00:00.000003");assert.strictEqual(py.eval('str(td(days=999999999, hours=23, minutes=59, seconds=59, microseconds=999999))',c),"999999999 days, 23:59:59.999999");});QUnit.test('timedelta.test_massive_normalization',function(assert){assert.expect(3);var td=py.PY_call(pyUtils.context().datetime.timedelta,{microseconds:py.float.fromJSON(-1)});assert.strictEqual(td.days,-1);assert.strictEqual(td.seconds,24*3600-1);assert.strictEqual(td.microseconds,999999);});QUnit.test('timedelta.test_bool',function(assert){assert.expect(5);var c={td:pyUtils.context().datetime.timedelta};assert.ok(py.eval('bool(td(1))',c));assert.ok(py.eval('bool(td(0, 1))',c));assert.ok(py.eval('bool(td(0, 0, 1))',c));assert.ok(py.eval('bool(td(microseconds=1))',c));assert.ok(py.eval('bool(not td(0))',c));});QUnit.test('date.test_computations',function(assert){assert.expect(31);var d=pyUtils.context().datetime;var a=d.date.fromJSON(2002,1,31);var b=d.date.fromJSON(1956,1,31);assert.strictEqual(py.eval('(a - b).days',{a:a,b:b}),46*365+12);assert.strictEqual(py.eval('(a - b).seconds',{a:a,b:b}),0);assert.strictEqual(py.eval('(a - b).microseconds',{a:a,b:b}),0);var day=py.PY_call(d.timedelta,[py.float.fromJSON(1)]);var week=py.PY_call(d.timedelta,[py.float.fromJSON(7)]);a=d.date.fromJSON(2002,3,2);var ctx={a:a,day:day,week:week,date:d.date};assert.ok(py.eval('a + day == date(2002, 3, 3)',ctx));assert.ok(py.eval('day + a == date(2002, 3, 3)',ctx));assert.ok(py.eval('a - day == date(2002, 3, 1)',ctx));assert.ok(py.eval('-day + a == date(2002, 3, 1)',ctx));assert.ok(py.eval('a + week == date(2002, 3, 9)',ctx));assert.ok(py.eval('a - week == date(2002, 2, 23)',ctx));assert.ok(py.eval('a + 52*week == date(2003, 3, 1)',ctx));assert.ok(py.eval('a - 52*week == date(2001, 3, 3)',ctx));assert.ok(py.eval('(a + week) - a == week',ctx));assert.ok(py.eval('(a + day) - a == day',ctx));assert.ok(py.eval('(a - week) - a == -week',ctx));assert.ok(py.eval('(a - day) - a == -day',ctx));assert.ok(py.eval('a - (a + week) == -week',ctx));assert.ok(py.eval('a - (a + day) == -day',ctx));assert.ok(py.eval('a - (a - week) == week',ctx));assert.ok(py.eval('a - (a - day) == day',ctx));assert.throws(function(){py.eval('a + 1',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('a - 1',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('1 + a',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('1 - a',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('day - a',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('day * a',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('a * day',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('day // a',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('a // day',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('a * a',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('a // a',ctx);},/^Error: TypeError:/);assert.throws(function(){py.eval('a + a',ctx);},/^Error: TypeError:/);});QUnit.test('add',function(assert){assert.expect(2);assert.strictEqual(py.eval("(datetime.datetime(2017, 4, 18, 9, 32, 15).add(hours=2, minutes=30, "+"seconds=10)).strftime('%Y-%m-%d %H:%M:%S')",pyUtils.context()),'2017-04-18 12:02:25');assert.strictEqual(py.eval("(datetime.date(2017, 4, 18).add(months=1, years=3, days=5))"+".strftime('%Y-%m-%d')",pyUtils.context()),'2020-05-23');});QUnit.test('subtract',function(assert){assert.expect(2);assert.strictEqual(py.eval("(datetime.datetime(2017, 4, 18, 9, 32, 15).subtract(hours=1, minutes=5, "+"seconds=33)).strftime('%Y-%m-%d %H:%M:%S')",pyUtils.context()),'2017-04-18 08:26:42');assert.strictEqual(py.eval("(datetime.date(2017, 4, 18).subtract(years=5, months=1, days=1))"+".strftime('%Y-%m-%d')",pyUtils.context()),'2012-03-17');})
QUnit.test('start_of/end_of',function(assert){assert.expect(26);var datetime=pyUtils.context().datetime;var _date=datetime.date.fromJSON(2281,10,11);var _datetime=datetime.datetime.fromJSON(2281,10,11,22,33,44);var ctx={_date:_date,_datetime:_datetime,date:datetime.date,datetime:datetime.datetime};assert.ok(py.eval('_date.start_of("year") == date(2281, 1, 1)',ctx));assert.ok(py.eval('_date.start_of("quarter") == date(2281, 10, 1)',ctx));assert.ok(py.eval('_date.start_of("month") == date(2281, 10, 1)',ctx));assert.ok(py.eval('_date.start_of("week") == date(2281, 10, 10)',ctx));assert.ok(py.eval('_date.start_of("day") == date(2281, 10, 11)',ctx));assert.throws(function(){py.eval('_date.start_of("hour")',ctx);},/^Error: ValueError:/);assert.ok(py.eval('_datetime.start_of("year") == datetime(2281, 1, 1)',ctx));assert.ok(py.eval('_datetime.start_of("quarter") == datetime(2281, 10, 1)',ctx));assert.ok(py.eval('_datetime.start_of("month") == datetime(2281, 10, 1)',ctx));assert.ok(py.eval('_datetime.start_of("week") == datetime(2281, 10, 10)',ctx));assert.ok(py.eval('_datetime.start_of("day") == datetime(2281, 10, 11)',ctx));assert.ok(py.eval('_datetime.start_of("hour") == datetime(2281, 10, 11, 22, 0, 0)',ctx));assert.throws(function(){py.eval('_datetime.start_of("cheese")',ctx);},/^Error: ValueError:/);assert.ok(py.eval('_date.end_of("year") == date(2281, 12, 31)',ctx));assert.ok(py.eval('_date.end_of("quarter") == date(2281, 12, 31)',ctx));assert.ok(py.eval('_date.end_of("month") == date(2281, 10, 31)',ctx));assert.ok(py.eval('_date.end_of("week") == date(2281, 10, 16)',ctx));assert.ok(py.eval('_date.end_of("day") == date(2281, 10, 11)',ctx));assert.throws(function(){py.eval('_date.start_of("hour")',ctx);},/^Error: ValueError:/);assert.ok(py.eval('_datetime.end_of("year") == datetime(2281, 12, 31, 23, 59, 59)',ctx));assert.ok(py.eval('_datetime.end_of("quarter") == datetime(2281, 12, 31, 23, 59, 59)',ctx));assert.ok(py.eval('_datetime.end_of("month") == datetime(2281, 10, 31, 23, 59, 59)',ctx));assert.ok(py.eval('_datetime.end_of("week") == datetime(2281, 10, 16, 23, 59, 59)',ctx));assert.ok(py.eval('_datetime.end_of("day") == datetime(2281, 10, 11, 23, 59, 59)',ctx));assert.ok(py.eval('_datetime.end_of("hour") == datetime(2281, 10, 11, 22, 59, 59)',ctx));assert.throws(function(){py.eval('_datetime.end_of("cheese")',ctx);},/^Error: ValueError:/);});QUnit.test('relativedelta',function(assert){assert.expect(7);assert.strictEqual(py.eval("(datetime.date(2012, 2, 15) + relativedelta(days=-1)).strftime('%Y-%m-%d 23:59:59')",pyUtils.context()),"2012-02-14 23:59:59");assert.strictEqual(py.eval("(datetime.date(2012, 2, 15) + relativedelta(days=1)).strftime('%Y-%m-%d')",pyUtils.context()),"2012-02-16");assert.strictEqual(py.eval("(datetime.date(2012, 2, 15) + relativedelta(days=-1)).strftime('%Y-%m-%d')",pyUtils.context()),"2012-02-14");assert.strictEqual(py.eval("(datetime.date(2012, 2, 1) + relativedelta(days=-1)).strftime('%Y-%m-%d')",pyUtils.context()),'2012-01-31');assert.strictEqual(py.eval("(datetime.date(2015,2,5)+relativedelta(days=-6,weekday=0)).strftime('%Y-%m-%d')",pyUtils.context()),'2015-02-02');assert.strictEqual(py.eval("(datetime.date(2018, 2, 1) + relativedelta(years=7, months=42, days=42)).strftime('%Y-%m-%d')",pyUtils.context()),'2028-09-12');assert.strictEqual(py.eval("(datetime.date(2018, 2, 1) + relativedelta(years=-7, months=-42, days=-42)).strftime('%Y-%m-%d')",pyUtils.context()),'2007-06-20');});QUnit.test('timedelta',function(assert){assert.expect(4);assert.strictEqual(py.eval("(datetime.datetime(2017, 2, 15, 1, 7, 31) + datetime.timedelta(days=1)).strftime('%Y-%m-%d %H:%M:%S')",pyUtils.context()),"2017-02-16 01:07:31");assert.strictEqual(py.eval("(datetime.datetime(2012, 2, 15, 1, 7, 31) - datetime.timedelta(hours=1)).strftime('%Y-%m-%d %H:%M:%S')",pyUtils.context()),"2012-02-15 00:07:31");assert.strictEqual(py.eval("(datetime.datetime(2012, 2, 15, 1, 7, 31) + datetime.timedelta(hours=-1)).strftime('%Y-%m-%d %H:%M:%S')",pyUtils.context()),"2012-02-15 00:07:31");assert.strictEqual(py.eval("(datetime.datetime(2012, 2, 15, 1, 7, 31) + datetime.timedelta(minutes=100)).strftime('%Y-%m-%d %H:%M:%S')",pyUtils.context()),"2012-02-15 02:47:31");});QUnit.test('datetime.tojson',function(assert){assert.expect(7);var result=py.eval('datetime.datetime(2012, 2, 15, 1, 7, 31)',pyUtils.context());assert.ok(result instanceof Date);assert.strictEqual(result.getFullYear(),2012);assert.strictEqual(result.getMonth(),1);assert.strictEqual(result.getDate(),15);assert.strictEqual(result.getHours(),1);assert.strictEqual(result.getMinutes(),7);assert.strictEqual(result.getSeconds(),31);});QUnit.test('datetime.combine',function(assert){assert.expect(2);var result=py.eval('datetime.datetime.combine(datetime.date(2012, 2, 15),'+'                          datetime.time(1, 7, 13))'+'   .strftime("%Y-%m-%d %H:%M:%S")',pyUtils.context());assert.strictEqual(result,"2012-02-15 01:07:13");result=py.eval('datetime.datetime.combine(datetime.date(2012, 2, 15),'+'                          datetime.time())'+'   .strftime("%Y-%m-%d %H:%M:%S")',pyUtils.context());assert.strictEqual(result,'2012-02-15 00:00:00');});QUnit.test('datetime.replace',function(assert){assert.expect(1);var result=py.eval('datetime.datetime(2012, 2, 15, 1, 7, 13)'+'   .replace(hour=0, minute=0, second=0)'+'   .strftime("%Y-%m-%d %H:%M:%S")',pyUtils.context());assert.strictEqual(result,"2012-02-15 00:00:00");});QUnit.test('conditional expressions',function(assert){assert.expect(2);assert.strictEqual(py.eval('1 if a else 2',{a:true}),1);assert.strictEqual(py.eval('1 if a else 2',{a:false}),2);});QUnit.module('py_utils (eval domain contexts)',{beforeEach:function(){this.user_context={uid:1,lang:'en_US',tz:false,};},});QUnit.test('empty, basic',function(assert){assert.expect(3);var result=pyUtils.eval_domains_and_contexts({contexts:[this.user_context],domains:[],});assert.deepEqual(result.context,{lang:'en_US',tz:false,uid:1});assert.deepEqual(result.domain,[]);assert.deepEqual(result.group_by,[]);});QUnit.test('context_merge_00',function(assert){assert.expect(1);var ctx=[{"__contexts":[{"lang":"en_US","tz":false,"uid":1},{"active_id":8,"active_ids":[8],"active_model":"sale.order","bin_raw":true,"default_composition_mode":"comment","default_model":"sale.order","default_res_id":8,"default_template_id":18,"default_use_template":true,"edi_web_url_view":"faaaake","lang":"en_US","mark_so_as_sent":null,"show_address":null,"tz":false,"uid":null},{}],"__eval_context":null,"__ref":"compound_context"},{"active_id":9,"active_ids":[9],"active_model":"mail.compose.message"}];var result=pyUtils.eval_domains_and_contexts({contexts:ctx,domins:[],});assert.deepEqual(result.context,{active_id:9,active_ids:[9],active_model:'mail.compose.message',bin_raw:true,default_composition_mode:'comment',default_model:'sale.order',default_res_id:8,default_template_id:18,default_use_template:true,edi_web_url_view:"faaaake",lang:'en_US',mark_so_as_sent:null,show_address:null,tz:false,uid:null});});QUnit.test('context_merge_01',function(assert){assert.expect(1);var ctx=[{"__contexts":[{"lang":"en_US","tz":false,"uid":1},{"default_attachment_ids":[],"default_body":"","default_model":"res.users","default_parent_id":false,"default_res_id":1},{}],"__eval_context":null,"__ref":"compound_context"}];var result=pyUtils.eval_domains_and_contexts({contexts:ctx,domains:[],});assert.deepEqual(result.context,{"default_attachment_ids":[],"default_body":"","default_model":"res.users","default_parent_id":false,"default_res_id":1,"lang":"en_US","tz":false,"uid":1});});QUnit.test('domain with time',function(assert){assert.expect(1);var result=pyUtils.eval_domains_and_contexts({domains:[[['type','=','contract']],["|",["state","in",["open","draft"]],[["type","=","contract"],["state","=","pending"]]],"['|', '&', ('date', '!=', False), ('date', '<=', time.strftime('%Y-%m-%d')), ('is_overdue_quantity', '=', True)]",[['user_id','=',1]]],contexts:[],});var d=new Date();var today=_.str.sprintf("%04d-%02d-%02d",d.getUTCFullYear(),d.getUTCMonth()+1,d.getUTCDate());assert.deepEqual(result.domain,[["type","=","contract"],"|",["state","in",["open","draft"]],[["type","=","contract"],["state","=","pending"]],"|","&",["date","!=",false],["date","<=",today],["is_overdue_quantity","=",true],["user_id","=",1]]);});QUnit.test('conditional context',function(assert){assert.expect(2);var d={__ref:'domain',__debug:"[('company_id', '=', context.get('company_id',False))]"};var result1=pyUtils.eval_domains_and_contexts({domains:[d],contexts:[],});assert.deepEqual(result1.domain,[['company_id','=',false]]);var result2=pyUtils.eval_domains_and_contexts({domains:[d],contexts:[],eval_context:{company_id:42},});assert.deepEqual(result2.domain,[['company_id','=',42]]);});QUnit.test('substitution in context',function(assert){assert.expect(1);var c="{'default_opportunity_id': active_id, 'default_duration': 1.0, 'lng': lang}";var cc=new Context(c);cc.set_eval_context({active_id:42});var result=pyUtils.eval_domains_and_contexts({domains:[],contexts:[this.user_context,cc]});assert.deepEqual(result.context,{lang:"en_US",tz:false,uid:1,default_opportunity_id:42,default_duration:1.0,lng:"en_US"});});QUnit.test('date',function(assert){assert.expect(1);var d="[('state','!=','cancel'),('opening_date','>',context_today().strftime('%Y-%m-%d'))]";var result=pyUtils.eval_domains_and_contexts({domains:[d],contexts:[],});var date=new Date();var today=_.str.sprintf("%04d-%02d-%02d",date.getFullYear(),date.getMonth()+1,date.getDate());assert.deepEqual(result.domain,[['state','!=','cancel'],['opening_date','>',today]]);});QUnit.test('delta',function(assert){assert.expect(1);var d="[('type','=','in'),('day','<=', time.strftime('%Y-%m-%d')),('day','>',(context_today()-datetime.timedelta(days=15)).strftime('%Y-%m-%d'))]";var result=pyUtils.eval_domains_and_contexts({domains:[d],contexts:[],});var date=new Date();var today=_.str.sprintf("%04d-%02d-%02d",date.getFullYear(),date.getMonth()+1,date.getDate());date.setDate(date.getDate()-15);var ago_15_d=_.str.sprintf("%04d-%02d-%02d",date.getFullYear(),date.getMonth()+1,date.getDate());assert.deepEqual(result.domain,[['type','=','in'],['day','<=',today],['day','>',ago_15_d]]);});QUnit.test('horror from the deep',function(assert){assert.expect(1);var cs=[{"__ref":"compound_context","__contexts":[{"__ref":"context","__debug":"{'k': 'foo,' + str(context.get('test_key', False))}"},{"__ref":"compound_context","__contexts":[{"lang":"en_US","tz":false,"uid":1},{"lang":"en_US","tz":false,"uid":1,"active_model":"sale.order","default_type":"out","show_address":1,"contact_display":"partner_address","active_ids":[9],"active_id":9},{}],"__eval_context":null},{"active_id":8,"active_ids":[8],"active_model":"stock.picking.out"},{"__ref":"context","__debug":"{'default_ref': 'stock.picking.out,'+str(context.get('active_id', False))}","__id":"54d6ad1d6c45"}],"__eval_context":null}];var result=pyUtils.eval_domains_and_contexts({domains:[],contexts:cs,});assert.deepEqual(result.context,{k:'foo,False',lang:'en_US',tz:false,uid:1,active_model:'stock.picking.out',active_id:8,active_ids:[8],default_type:'out',show_address:1,contact_display:'partner_address',default_ref:'stock.picking.out,8'});});QUnit.module('py_utils (contexts)');QUnit.test('context_recursive',function(assert){assert.expect(3);var context_to_eval=[{__ref:'context',__debug:'{"foo": context.get("bar", "qux")}'}];assert.deepEqual(pyUtils.eval('contexts',context_to_eval,{bar:"ok"}),{foo:'ok'});assert.deepEqual(pyUtils.eval('contexts',context_to_eval,{bar:false}),{foo:false});assert.deepEqual(pyUtils.eval('contexts',context_to_eval),{foo:'qux'});});QUnit.test('context_sequences',function(assert){assert.expect(1);var active_id=4;var result=pyUtils.eval('contexts',[{"__contexts":[{"department_id":false,"lang":"en_US","project_id":false,"section_id":false,"tz":false,"uid":1},{"search_default_create_uid":1},{}],"__eval_context":null,"__ref":"compound_context"},{"active_id":active_id,"active_ids":[active_id],"active_model":"purchase.requisition"},{"__debug":"{'record_id' : active_id}","__id":"63e8e9bff8a6","__ref":"context"}]);assert.deepEqual(result,{department_id:false,lang:'en_US',project_id:false,section_id:false,tz:false,uid:1,search_default_create_uid:1,active_id:active_id,active_ids:[active_id],active_model:'purchase.requisition',record_id:active_id});});QUnit.test('non-literal_eval_contexts',function(assert){assert.expect(1);var result=pyUtils.eval('contexts',[{"__ref":"compound_context","__contexts":[{"__ref":"context","__debug":"{'move_type':parent.move_type}","__id":"462b9dbed42f"}],"__eval_context":{"__ref":"compound_context","__contexts":[{"__ref":"compound_context","__contexts":[{"__ref":"context","__debug":"{'move_type': move_type}","__id":"16a04ed5a194"}],"__eval_context":{"__ref":"compound_context","__contexts":[{"lang":"en_US","tz":false,"uid":1,"journal_type":"sale","section_id":false,"default_move_type":"out_invoice","move_type":"out_invoice","department_id":false},{"id":false,"journal_id":10,"number":false,"move_type":"out_invoice","currency_id":1,"partner_id":4,"fiscal_position_id":false,"invoice_date":false,"date":false,"payment_term_id":false,"reference":false,"account_id":440,"name":false,"invoice_line_ids":[],"tax_line_ids":[],"amount_untaxed":0,"amount_tax":0,"reconciled":false,"amount_total":0,"state":"draft","amount_residual":0,"company_id":1,"date_due":false,"user_id":1,"partner_bank_id":false,"origin":false,"move_id":false,"comment":false,"payment_ids":[[6,false,[]]],"active_id":false,"active_ids":[],"active_model":"account.move","parent":{}}],"__eval_context":null}},{"id":false,"product_id":4,"name":"[PC1] Basic PC","quantity":1,"uom_id":1,"price_unit":100,"account_id":853,"discount":0,"account_analytic_id":false,"company_id":false,"note":false,"invoice_line_tax_ids":[[6,false,[1]]],"active_id":false,"active_ids":[],"active_model":"account.move.line","parent":{"id":false,"journal_id":10,"number":false,"move_type":"out_invoice","currency_id":1,"partner_id":4,"fiscal_position_id":false,"invoice_date":false,"date":false,"payment_term_id":false,"reference":false,"account_id":440,"name":false,"tax_line_ids":[],"amount_untaxed":0,"amount_tax":0,"reconciled":false,"amount_total":0,"state":"draft","amount_residual":0,"company_id":1,"date_due":false,"user_id":1,"partner_bank_id":false,"origin":false,"move_id":false,"comment":false,"payment_ids":[[6,false,[]]]}}],"__eval_context":null}}]);assert.deepEqual(result,{move_type:'out_invoice'});});QUnit.test('return-input-value',function(assert){assert.expect(1);var result=pyUtils.eval('contexts',[{__ref:'compound_context',__contexts:["{'line_id': line_id , 'journal_id': journal_id }"],__eval_context:{__ref:'compound_context',__contexts:[{__ref:'compound_context',__contexts:[{lang:'en_US',tz:'Europe/Paris',uid:1},{lang:'en_US',tz:'Europe/Paris',uid:1},{}],__eval_context:null,},{active_id:false,active_ids:[],active_model:'account.move',amount:0,company_id:1,id:false,journal_id:14,line_id:[[0,false,{account_id:55,amount_currency:0,analytic_account_id:false,credit:0,currency_id:false,date_maturity:false,debit:0,name:"dscsd",partner_id:false,tax_line_id:false,}]],name:'/',narration:false,parent:{},partner_id:false,date:'2011-01-1',ref:false,state:'draft',to_check:false,}],__eval_context:null,},}]);assert.deepEqual(result,{journal_id:14,line_id:[[0,false,{account_id:55,amount_currency:0,analytic_account_id:false,credit:0,currency_id:false,date_maturity:false,debit:0,name:"dscsd",partner_id:false,tax_line_id:false,}]],});});QUnit.module('py_utils (domains)');QUnit.test('current_date',function(assert){assert.expect(1);var current_date=time.date_to_str(new Date());var result=pyUtils.eval('domains',[[],{"__ref":"domain","__debug":"[('name','>=',current_date),('name','<=',current_date)]","__id":"5dedcfc96648"}],pyUtils.context());assert.deepEqual(result,[['name','>=',current_date],['name','<=',current_date]]);});QUnit.test('context_freevar',function(assert){assert.expect(3);var domains_to_eval=[{__ref:'domain',__debug:'[("foo", "=", context.get("bar", "qux"))]'},[['bar','>=',42]]];assert.deepEqual(pyUtils.eval('domains',domains_to_eval,{bar:"ok"}),[['foo','=','ok'],['bar','>=',42]]);assert.deepEqual(pyUtils.eval('domains',domains_to_eval,{bar:false}),[['foo','=',false],['bar','>=',42]]);assert.deepEqual(pyUtils.eval('domains',domains_to_eval),[['foo','=','qux'],['bar','>=',42]]);});QUnit.module('py_utils (groupbys)');QUnit.test('groupbys_00',function(assert){assert.expect(1);var result=pyUtils.eval('groupbys',[{group_by:'foo'},{group_by:['bar','qux']},{group_by:null},{group_by:'grault'}]);assert.deepEqual(result,['foo','bar','qux','grault']);});QUnit.test('groupbys_01',function(assert){assert.expect(1);var result=pyUtils.eval('groupbys',[{group_by:'foo'},{__ref:'context',__debug:'{"group_by": "bar"}'},{group_by:'grault'}]);assert.deepEqual(result,['foo','bar','grault']);});QUnit.test('groupbys_02',function(assert){assert.expect(1);var result=pyUtils.eval('groupbys',[{group_by:'foo'},{__ref:'compound_context',__contexts:[{group_by:'bar'}],__eval_context:null},{group_by:'grault'}]);assert.deepEqual(result,['foo','bar','grault']);});QUnit.test('groupbys_03',function(assert){assert.expect(1);var result=pyUtils.eval('groupbys',[{group_by:'foo'},{__ref:'compound_context',__contexts:[{__ref:'context',__debug:'{"group_by": value}'}],__eval_context:{value:'bar'}},{group_by:'grault'}]);assert.deepEqual(result,['foo','bar','grault']);});QUnit.test('groupbys_04',function(assert){assert.expect(1);var result=pyUtils.eval('groupbys',[{group_by:'foo'},{__ref:'compound_context',__contexts:[{__ref:'context',__debug:'{"group_by": value}'}],__eval_context:{value:'bar'}},{group_by:'grault'}],{value:'bar'});assert.deepEqual(result,['foo','bar','grault']);});QUnit.test('groupbys_05',function(assert){assert.expect(1);var result=pyUtils.eval('groupbys',[{group_by:'foo'},{__ref:'context',__debug:'{"group_by": value}'},{group_by:'grault'}],{value:'bar'});assert.deepEqual(result,['foo','bar','grault']);});QUnit.module('pyutils (_formatAST)');QUnit.test("basic values",function(assert){assert.expect(6);assert.checkAST("1","integer value");assert.checkAST("1.4","float value");assert.checkAST("-12","negative integer value");assert.checkAST("True","boolean");assert.checkAST(`"some string"`,"a string");assert.checkAST("None","None");});QUnit.test("dictionary",function(assert){assert.expect(3);assert.checkAST("{}","empty dictionary");assert.checkAST(`{"a": 1}`,"dictionary with a single key");assert.checkAST(`d["a"]`,"get a value in a dictionary");});QUnit.test("list",function(assert){assert.expect(2);assert.checkAST("[]","empty list");assert.checkAST("[1]","list with one value");});QUnit.test("tuple",function(assert){assert.expect(2);assert.checkAST("()","empty tuple");assert.checkAST("(1, 2)","basic tuple");});QUnit.test("simple arithmetic",function(assert){assert.expect(15);assert.checkAST("1 + 2","addition");assert.checkAST("+(1 + 2)","other addition, prefix");assert.checkAST("1 - 2","substraction");assert.checkAST("-1 - 2","other substraction");assert.checkAST("-(1 + 2)","other substraction");assert.checkAST("1 + 2 + 3","addition of 3 integers");assert.checkAST("a + b","addition of two variables");assert.checkAST("42 % 5","modulo operator");assert.checkAST("a * 10","multiplication");assert.checkAST("a ** 10","**");assert.checkAST("~10","bitwise not");assert.checkAST("~(10 + 3)","bitwise not");assert.checkAST("a * (1 + 2)","multiplication and addition");assert.checkAST("(a + b) * 43","addition and multiplication");assert.checkAST("a // 10","integer division");});QUnit.test("boolean operators",function(assert){assert.expect(6);assert.checkAST("True and False","boolean operator");assert.checkAST("True or False","boolean operator or");assert.checkAST("(True or False) and False","boolean operators and and or");assert.checkAST("not False","not prefix");assert.checkAST("not foo","not prefix with variable");assert.checkAST("not a in b","not prefix with expression");});QUnit.test("conditional expression",function(assert){assert.expect(2);assert.checkAST("1 if a else 2");assert.checkAST("[] if a else 2");});QUnit.test("other operators",function(assert){assert.expect(7);assert.checkAST("x == y","== operator");assert.checkAST("x != y","!= operator");assert.checkAST("x < y","< operator");assert.checkAST("x is y","is operator");assert.checkAST("x is not y","is and not operator");assert.checkAST("x in y","in operator");assert.checkAST("x not in y","not in operator");});QUnit.test("equality",function(assert){assert.expect(1);assert.checkAST("a == b","simple equality");});QUnit.test("strftime",function(assert){assert.expect(3);assert.checkAST(`time.strftime("%Y")`,"strftime with year");assert.checkAST(`time.strftime("%Y") + "-01-30"`,"strftime with year");assert.checkAST(`time.strftime("%Y-%m-%d %H:%M:%S")`,"strftime with year");});QUnit.test("context_today",function(assert){assert.expect(1);assert.checkAST(`context_today().strftime("%Y-%m-%d")`,"context today call");});QUnit.test("function call",function(assert){assert.expect(5);assert.checkAST("td()","simple call");assert.checkAST("td(a, b, c)","simple call with args");assert.checkAST('td(days = 1)',"simple call with kwargs");assert.checkAST('f(1, 2, days = 1)',"mixing args and kwargs");assert.checkAST('str(td(2))',"function call in function call");});QUnit.test("various expressions",function(assert){assert.expect(3);assert.checkAST('(a - b).days',"substraction and .days");assert.checkAST('a + day == date(2002, 3, 3)');var expr=`[("type", "=", "in"), ("day", "<=", time.strftime("%Y-%m-%d")), ("day", ">", (context_today() - datetime.timedelta(days = 15)).strftime("%Y-%m-%d"))]`;assert.checkAST(expr);});QUnit.test('escaping support',function(assert){assert.expect(4);assert.strictEqual(py.eval(r`"\x61"`),"a","hex escapes");assert.strictEqual(py.eval(r`"\\abc"`),r`\abc`,"escaped backslash");assert.checkAST(r`"\\abc"`,"escaped backslash AST check");const{_getPyJSAST,_formatAST}=pyUtils;const a=r`'foo\\abc"\''`;const b=_formatAST(_getPyJSAST(_formatAST(_getPyJSAST(a))));assert.strictEqual(b,r`"foo\\abc\"'"`);});QUnit.module('pyutils (_normalizeDomain)');QUnit.assert.checkNormalization=function(domain,normalizedDomain){normalizedDomain=normalizedDomain||domain;var result=pyUtils.normalizeDomain(domain);this.pushResult({result:result===normalizedDomain,actual:result,expected:normalizedDomain});};QUnit.test("return simple (normalized) domains",function(assert){assert.expect(3);assert.checkNormalization("[]");assert.checkNormalization(`[("a", "=", 1)]`);assert.checkNormalization(`["!", ("a", "=", 1)]`);});QUnit.test("properly add the & in a non normalized domain",function(assert){assert.expect(1);assert.checkNormalization(`[("a", "=", 1), ("b", "=", 2)]`,`["&", ("a", "=", 1), ("b", "=", 2)]`);});QUnit.test("normalize domain with ! operator",function(assert){assert.expect(1);assert.checkNormalization(`["!", ("a", "=", 1), ("b", "=", 2)]`,`["&", "!", ("a", "=", 1), ("b", "=", 2)]`);});QUnit.module('pyutils (assembleDomains)');QUnit.assert.checkAssemble=function(domains,operator,domain){domain=pyUtils.normalizeDomain(domain);var result=pyUtils.assembleDomains(domains,operator);this.pushResult({result:result===domain,actual:result,expected:domain});};QUnit.test("assemble domains",function(assert){assert.expect(7);assert.checkAssemble([],'&',"[]");assert.checkAssemble(["[('a', '=', 1)]"],null,"[('a', '=', 1)]");assert.checkAssemble(["[('a', '=', '1'), ('b', '!=', 2)]"],'AND',"['&',('a', '=', '1'), ('b', '!=', 2)]");assert.checkAssemble(["[('a', '=', '1')]","[]"],'AND',"[('a', '=', '1')]");assert.checkAssemble(["[('a', '=', '1')]","[('b', '<=', 3)]"],'AND',"['&',('a', '=', '1'),('b','<=', 3)]");assert.checkAssemble(["[('a', '=', '1'), ('c', 'in', [4, 5])]","[('b', '<=', 3)]"],'OR',"['|', '&',('a', '=', '1'),('c', 'in', [4, 5]),('b','<=', 3)]");assert.checkAssemble(["[('user_id', '=', uid)]"],null,"[('user_id', '=', uid)]");});});});;

/* /web/static/tests/core/class_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.class_tests',function(require){"use strict";var Class=require('web.Class');QUnit.module('core',{},function(){QUnit.module('Class');QUnit.test('Basic class creation',function(assert){assert.expect(2);var C=Class.extend({foo:function(){return this.somevar;}});var i=new C();i.somevar=3;assert.ok(i instanceof C);assert.strictEqual(i.foo(),3);});QUnit.test('Class initialization',function(assert){assert.expect(2);var C1=Class.extend({init:function(){this.foo=3;}});var C2=Class.extend({init:function(arg){this.foo=arg;}});var i1=new C1(),i2=new C2(42);assert.strictEqual(i1.foo,3);assert.strictEqual(i2.foo,42);});QUnit.test('Inheritance',function(assert){assert.expect(3);var C0=Class.extend({foo:function(){return 1;}});var C1=C0.extend({foo:function(){return 1+this._super();}});var C2=C1.extend({foo:function(){return 1+this._super();}});assert.strictEqual(new C0().foo(),1);assert.strictEqual(new C1().foo(),2);assert.strictEqual(new C2().foo(),3);});QUnit.test('In-place extension',function(assert){assert.expect(4);var C0=Class.extend({foo:function(){return 3;},qux:function(){return 3;},bar:3});C0.include({foo:function(){return 5;},qux:function(){return 2+this._super();},bar:5,baz:5});assert.strictEqual(new C0().bar,5);assert.strictEqual(new C0().baz,5);assert.strictEqual(new C0().foo(),5);assert.strictEqual(new C0().qux(),5);});QUnit.test('In-place extension and inheritance',function(assert){assert.expect(4);var C0=Class.extend({foo:function(){return 1;},bar:function(){return 1;}});var C1=C0.extend({foo:function(){return 1+this._super();}});assert.strictEqual(new C1().foo(),2);assert.strictEqual(new C1().bar(),1);C1.include({foo:function(){return 2+this._super();},bar:function(){return 1+this._super();}});assert.strictEqual(new C1().foo(),4);assert.strictEqual(new C1().bar(),2);});QUnit.test('In-place extensions alter existing instances',function(assert){assert.expect(4);var C0=Class.extend({foo:function(){return 1;},bar:function(){return 1;}});var i=new C0();assert.strictEqual(i.foo(),1);assert.strictEqual(i.bar(),1);C0.include({foo:function(){return 2;},bar:function(){return 2+this._super();}});assert.strictEqual(i.foo(),2);assert.strictEqual(i.bar(),3);});QUnit.test('In-place extension of subclassed types',function(assert){assert.expect(3);var C0=Class.extend({foo:function(){return 1;},bar:function(){return 1;}});var C1=C0.extend({foo:function(){return 1+this._super();},bar:function(){return 1+this._super();}});var i=new C1();assert.strictEqual(i.foo(),2);C0.include({foo:function(){return 2;},bar:function(){return 2+this._super();}});assert.strictEqual(i.foo(),3);assert.strictEqual(i.bar(),4);});});});;

/* /web/static/tests/core/rpc_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.rpc_tests',function(require){"use strict";var rpc=require('web.rpc');QUnit.module('core',{},function(){QUnit.module('RPC Builder');QUnit.test('basic rpc (route)',function(assert){assert.expect(1);var query=rpc.buildQuery({route:'/my/route',});assert.strictEqual(query.route,'/my/route',"should have the proper route");});QUnit.test('rpc on route with parameters',function(assert){assert.expect(1);var query=rpc.buildQuery({route:'/my/route',params:{hey:'there',model:'test'},});assert.deepEqual(query.params,{hey:'there',model:'test'},"should transfer the proper parameters");});QUnit.test('basic rpc, with no context',function(assert){assert.expect(1);var query=rpc.buildQuery({model:'partner',method:'test',kwargs:{},});assert.notOk(query.params.kwargs.context,"does not automatically add a context");});QUnit.test('basic rpc, with context',function(assert){assert.expect(1);var query=rpc.buildQuery({model:'partner',method:'test',context:{a:1},});assert.deepEqual(query.params.kwargs.context,{a:1},"properly transfer the context");});QUnit.test('basic rpc, with context, part 2',function(assert){assert.expect(1);var query=rpc.buildQuery({model:'partner',method:'test',kwargs:{context:{a:1}},});assert.deepEqual(query.params.kwargs.context,{a:1},"properly transfer the context");});QUnit.test('basic rpc (method of model)',function(assert){assert.expect(3);var query=rpc.buildQuery({model:'partner',method:'test',kwargs:{context:{a:1}},});assert.strictEqual(query.route,'/web/dataset/call_kw/partner/test',"should call the proper route");assert.strictEqual(query.params.model,'partner',"should correctly specify the model");assert.strictEqual(query.params.method,'test',"should correctly specify the method");});QUnit.test('rpc with args and kwargs',function(assert){assert.expect(4);var query=rpc.buildQuery({model:'partner',method:'test',args:['arg1',2],kwargs:{k:78},});assert.strictEqual(query.route,'/web/dataset/call_kw/partner/test',"should call the proper route");assert.strictEqual(query.params.args[0],'arg1',"should call with correct args");assert.strictEqual(query.params.args[1],2,"should call with correct args");assert.strictEqual(query.params.kwargs.k,78,"should call with correct kargs");});QUnit.test('search_read controller',function(assert){assert.expect(1);var query=rpc.buildQuery({route:'/web/dataset/search_read',model:'partner',domain:['a','=',1],fields:['name'],limit:32,offset:2,orderBy:[{name:'yop',asc:true},{name:'aa',asc:false}],});assert.deepEqual(query.params,{context:{},domain:['a','=',1],fields:['name'],limit:32,offset:2,model:'partner',sort:'yop ASC, aa DESC',},"should have correct args");});QUnit.test('search_read method',function(assert){assert.expect(1);var query=rpc.buildQuery({model:'partner',method:'search_read',domain:['a','=',1],fields:['name'],limit:32,offset:2,orderBy:[{name:'yop',asc:true},{name:'aa',asc:false}],});assert.deepEqual(query.params,{args:[],kwargs:{domain:['a','=',1],fields:['name'],offset:2,limit:32,order:'yop ASC, aa DESC'},method:'search_read',model:'partner'},"should have correct kwargs");});QUnit.test('search_read with args',function(assert){assert.expect(1);var query=rpc.buildQuery({model:'partner',method:'search_read',args:[['a','=',1],['name'],2,32,'yop ASC, aa DESC',]});assert.deepEqual(query.params,{args:[['a','=',1],['name'],2,32,'yop ASC, aa DESC'],kwargs:{},method:'search_read',model:'partner'},"should have correct args");});QUnit.test('read_group',function(assert){assert.expect(2);var query=rpc.buildQuery({model:'partner',method:'read_group',domain:['a','=',1],fields:['name'],groupBy:['product_id'],context:{abc:'def'},lazy:true,});assert.deepEqual(query.params,{args:[],kwargs:{context:{abc:'def'},domain:['a','=',1],fields:['name'],groupby:['product_id'],lazy:true,},method:'read_group',model:'partner',},"should have correct args");assert.equal(query.route,'/web/dataset/call_kw/partner/read_group',"should call correct route");});QUnit.test('read_group with kwargs',function(assert){assert.expect(1);var query=rpc.buildQuery({model:'partner',method:'read_group',domain:['a','=',1],fields:['name'],groupBy:['product_id'],lazy:false,kwargs:{context:{abc:'def'}}});assert.deepEqual(query.params,{args:[],kwargs:{context:{abc:'def'},domain:['a','=',1],fields:['name'],groupby:['product_id'],lazy:false,},method:'read_group',model:'partner',},"should have correct args");});QUnit.test('read_group with no domain, nor fields',function(assert){assert.expect(7);var query=rpc.buildQuery({model:'partner',method:'read_group',});assert.deepEqual(query.params.kwargs.domain,[],"should have [] as default domain");assert.deepEqual(query.params.kwargs.fields,[],"should have false as default fields");assert.deepEqual(query.params.kwargs.groupby,[],"should have false as default groupby");assert.deepEqual(query.params.kwargs.offset,undefined,"should not enforce a default value for offst");assert.deepEqual(query.params.kwargs.limit,undefined,"should not enforce a default value for limit");assert.deepEqual(query.params.kwargs.orderby,undefined,"should not enforce a default value for orderby");assert.deepEqual(query.params.kwargs.lazy,undefined,"should not enforce a default value for lazy");});QUnit.test('read_group with args and kwargs',function(assert){assert.expect(9);var query=rpc.buildQuery({model:'partner',method:'read_group',kwargs:{domain:['name','=','saucisse'],fields:['category_id'],groupby:['country_id'],},});assert.deepEqual(query.params.kwargs.domain,['name','=','saucisse'],"should have ['name', '=', 'saucisse'] category_id as default domain");assert.deepEqual(query.params.kwargs.fields,['category_id'],"should have category_id as default fields");assert.deepEqual(query.params.kwargs.groupby,['country_id'],"should have country_id as default groupby");var query=rpc.buildQuery({model:'partner',method:'read_group',args:[['name','=','saucisse']],kwargs:{fields:['category_id'],groupby:['country_id'],},});assert.deepEqual(query.params.kwargs.domain,undefined,"should not enforce a default value for domain");assert.deepEqual(query.params.kwargs.fields,['category_id'],"should have category_id as default fields");assert.deepEqual(query.params.kwargs.groupby,['country_id'],"should have country_id as default groupby");var query=rpc.buildQuery({model:'partner',method:'read_group',args:[['name','=','saucisse'],['category_id'],['country_id']],});assert.deepEqual(query.params.kwargs.domain,undefined,"should not enforce a default value for domain");assert.deepEqual(query.params.kwargs.fields,undefined,"should not enforce a default value for  fields");assert.deepEqual(query.params.kwargs.groupby,undefined,"should not enforce a default value for  groupby");});QUnit.test('search_read with no domain, nor fields',function(assert){assert.expect(5);var query=rpc.buildQuery({model:'partner',method:'search_read',});assert.deepEqual(query.params.kwargs.domain,undefined,"should not enforce a default value for domain");assert.deepEqual(query.params.kwargs.fields,undefined,"should not enforce a default value for fields");assert.deepEqual(query.params.kwargs.offset,undefined,"should not enforce a default value for offset");assert.deepEqual(query.params.kwargs.limit,undefined,"should not enforce a default value for limit");assert.deepEqual(query.params.kwargs.order,undefined,"should not enforce a default value for orderby");});QUnit.test('search_read controller with no domain, nor fields',function(assert){assert.expect(5);var query=rpc.buildQuery({model:'partner',route:'/web/dataset/search_read',});assert.deepEqual(query.params.domain,undefined,"should not enforce a default value for domain");assert.deepEqual(query.params.fields,undefined,"should not enforce a default value for fields");assert.deepEqual(query.params.offset,undefined,"should not enforce a default value for groupby");assert.deepEqual(query.params.limit,undefined,"should not enforce a default value for limit");assert.deepEqual(query.params.sort,undefined,"should not enforce a default value for order");});});});;

/* /web/static/tests/core/domain_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.domain_tests',function(require){"use strict";var Domain=require('web.Domain');QUnit.module('core',{},function(){QUnit.module('domain');QUnit.test("empty",function(assert){assert.expect(1);assert.ok(new Domain([]).compute({}));});QUnit.test("basic",function(assert){assert.expect(3);var fields={a:3,group_method:'line',select1:'day',rrule_type:'monthly',};assert.ok(new Domain([['a','=',3]]).compute(fields));assert.ok(new Domain([['group_method','!=','count']]).compute(fields));assert.ok(new Domain([['select1','=','day'],['rrule_type','=','monthly']]).compute(fields));});QUnit.test("or",function(assert){assert.expect(3);var web={section_id:null,user_id:null,member_ids:null,};var currentDomain=['|',['section_id','=',42],'|',['user_id','=',3],['member_ids','in',[3]]];assert.ok(new Domain(currentDomain).compute(_.extend({},web,{section_id:42})));assert.ok(new Domain(currentDomain).compute(_.extend({},web,{user_id:3})));assert.ok(new Domain(currentDomain).compute(_.extend({},web,{member_ids:3})));});QUnit.test("not",function(assert){assert.expect(2);var fields={a:5,group_method:'line',};assert.ok(new Domain(['!',['a','=',3]]).compute(fields));assert.ok(new Domain(['!',['group_method','=','count']]).compute(fields));});QUnit.test("domains initialized with a number",function(assert){assert.expect(2);assert.ok(new Domain(1).compute({}));assert.notOk(new Domain(0).compute({}));});QUnit.test("invalid domains should not succeed",function(assert){assert.expect(3);assert.throws(()=>new Domain(['|',['hr_presence_state','=','absent']]),/invalid domain .* \(missing 1 segment/);assert.throws(()=>new Domain(['|','|',['hr_presence_state','=','absent'],['attendance_state','=','checked_in']]),/invalid domain .* \(missing 1 segment/);assert.throws(()=>new Domain(['&',['composition_mode','!=','mass_post']]),/invalid domain .* \(missing 1 segment/);});QUnit.test("domain <=> condition",function(assert){assert.expect(3);var domain=['|','|','|','&',['doc.amount','>',33],['doc.toto','!=',null],'&',['doc.bidule.active','=',true],['truc','in',[2,3]],['gogo','=','gogo value'],['gogo','!=',false]];var condition='((doc.amount > 33 and doc.toto is not None or doc.bidule.active is True and truc in [2,3]) or gogo == "gogo value") or gogo';assert.equal(Domain.prototype.domainToCondition(domain),condition);assert.deepEqual(Domain.prototype.conditionToDomain(condition),domain);assert.deepEqual(Domain.prototype.conditionToDomain('doc and toto is None or not tata'),['|','&',['doc','!=',false],['toto','=',null],['tata','=',false]]);});QUnit.test("condition 'a field is set' does not convert to a domain",function(assert){assert.expect(1);var expected=[["doc.blabla","!=",false]];var condition="doc.blabla";var actual=Domain.prototype.conditionToDomain(condition);assert.deepEqual(actual,expected);});QUnit.test("condition with a function should fail",function(assert){assert.expect(1);var condition="doc.blabla()";assert.throws(function(){Domain.prototype.conditionToDomain(condition);});});QUnit.test("empty condition should not fail",function(assert){assert.expect(2);var condition="";var actual=Domain.prototype.conditionToDomain(condition);assert.strictEqual(typeof(actual),typeof([]));assert.strictEqual(actual.length,0);});QUnit.test("undefined condition should not fail",function(assert){assert.expect(2);var condition=undefined;var actual=Domain.prototype.conditionToDomain(condition);assert.strictEqual(typeof(actual),typeof([]));assert.strictEqual(actual.length,0);});QUnit.test("compute true domain",function(assert){assert.expect(1);assert.ok(new Domain(Domain.TRUE_DOMAIN).compute({}));});QUnit.test("compute false domain",function(assert){assert.expect(1);assert.notOk(new Domain(Domain.FALSE_DOMAIN).compute({}));});});});;

/* /web/static/tests/core/data_comparison_utils_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.data_comparison_utils_tests',function(require){"use strict";var dataComparisonUtils=require('web.dataComparisonUtils');var DateClasses=dataComparisonUtils.DateClasses;QUnit.module('dataComparisonUtils',function(){QUnit.module('DateClasses');QUnit.test('main parameters are correctly computed',function(assert){assert.expect(30);var dateClasses;dateClasses=new DateClasses([['2019']]);assert.strictEqual(dateClasses.referenceIndex,0);assert.strictEqual(dateClasses.dateClass(0,'2019'),0);assert.deepEqual(dateClasses.dateClassMembers(0),['2019']);dateClasses=new DateClasses([['2018','2019']]);assert.strictEqual(dateClasses.referenceIndex,0);assert.strictEqual(dateClasses.dateClass(0,'2018'),0);assert.strictEqual(dateClasses.dateClass(0,'2019'),1);assert.deepEqual(dateClasses.dateClassMembers(0),['2018']);assert.deepEqual(dateClasses.dateClassMembers(1),['2019']);dateClasses=new DateClasses([['2019'],[]]);assert.strictEqual(dateClasses.referenceIndex,0);assert.strictEqual(dateClasses.dateClass(0,'2019'),0);assert.deepEqual(dateClasses.dateClassMembers(0),['2019']);dateClasses=new DateClasses([[],['2019']]);assert.strictEqual(dateClasses.referenceIndex,1);assert.strictEqual(dateClasses.dateClass(1,'2019'),0);assert.deepEqual(dateClasses.dateClassMembers(0),['2019']);dateClasses=new DateClasses([['2019'],['2018','2019']]);assert.strictEqual(dateClasses.referenceIndex,0);assert.strictEqual(dateClasses.dateClass(0,'2019'),0);assert.strictEqual(dateClasses.dateClass(1,'2018'),0);assert.strictEqual(dateClasses.dateClass(1,'2019'),1);assert.deepEqual(dateClasses.dateClassMembers(0),['2019','2018']);assert.deepEqual(dateClasses.dateClassMembers(1),['2019']);dateClasses=new DateClasses([['2019'],['2017','2018','2020'],['2017','2019']]);assert.strictEqual(dateClasses.referenceIndex,0);assert.strictEqual(dateClasses.dateClass(0,'2019'),0);assert.strictEqual(dateClasses.dateClass(1,'2017'),0);assert.strictEqual(dateClasses.dateClass(1,'2018'),1);assert.strictEqual(dateClasses.dateClass(1,'2020'),2);assert.strictEqual(dateClasses.dateClass(2,'2017'),0);assert.strictEqual(dateClasses.dateClass(2,'2019'),1);assert.deepEqual(dateClasses.dateClassMembers(0),['2019','2017']);assert.deepEqual(dateClasses.dateClassMembers(1),['2018','2019']);assert.deepEqual(dateClasses.dateClassMembers(2),['2020']);});QUnit.test('two overlapping datesets and classes representatives',function(assert){assert.expect(4);var dateClasses=new DateClasses([['March 2017'],['February 2017','March 2017']]);assert.strictEqual(dateClasses.representative(0,0),'March 2017');assert.strictEqual(dateClasses.representative(0,1),'February 2017');assert.strictEqual(dateClasses.representative(1,0),undefined);assert.strictEqual(dateClasses.representative(1,1),'March 2017');});});});;

/* /web/static/tests/core/math_utils_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.math_utils_tests',function(require){"use strict";var mathUtils=require('web.mathUtils');var cartesian=mathUtils.cartesian;QUnit.module('mathUtils',function(){QUnit.module('cartesian');QUnit.test('cartesian product of zero arrays',function(assert){assert.expect(1);assert.deepEqual(cartesian(),[undefined],"the unit of the product is a singleton");});QUnit.test('cartesian product of a single array',function(assert){assert.expect(5);assert.deepEqual(cartesian([]),[]);assert.deepEqual(cartesian([1]),[1],"we don't want unecessary brackets");assert.deepEqual(cartesian([1,2]),[1,2]);assert.deepEqual(cartesian([[1,2]]),[[1,2]],"the internal structure of elements should be preserved");assert.deepEqual(cartesian([[1,2],[3,[2]]]),[[1,2],[3,[2]]],"the internal structure of elements should be preserved");});QUnit.test('cartesian product of two arrays',function(assert){assert.expect(5);assert.deepEqual(cartesian([],[]),[]);assert.deepEqual(cartesian([1],[]),[]);assert.deepEqual(cartesian([1],[2]),[[1,2]]);assert.deepEqual(cartesian([1,2],[3]),[[1,3],[2,3]]);assert.deepEqual(cartesian([[1],4],[2,[3]]),[[[1],2],[[1],[3]],[4,2],[4,[3]]],"the internal structure of elements should be preserved");});QUnit.test('cartesian product of three arrays',function(assert){assert.expect(4);assert.deepEqual(cartesian([],[],[]),[]);assert.deepEqual(cartesian([1],[],[2,5]),[]);assert.deepEqual(cartesian([1],[2],[3]),[[1,2,3]],"we should have no unecessary brackets, we want elements to be 'triples'");assert.deepEqual(cartesian([[1],2],[3],[4]),[[[1],3,4],[2,3,4]],"the internal structure of elements should be preserved");});QUnit.test('cartesian product of four arrays',function(assert){assert.expect(1);assert.deepEqual(cartesian([1],[2],[3],[4]),[[1,2,3,4]]);});});});;

/* /web/static/tests/core/mixins_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.mixins_tests',function(require){"use strict";var testUtils=require('web.test_utils');var Widget=require('web.Widget');QUnit.module('core',{},function(){QUnit.module('mixins');QUnit.test('perform a do_action properly',function(assert){assert.expect(3);var done=assert.async();var widget=new Widget();testUtils.mock.intercept(widget,'do_action',function(event){assert.strictEqual(event.data.action,'test.some_action_id',"should have sent proper action name");assert.deepEqual(event.data.options,{clear_breadcrumbs:true},"should have sent proper options");event.data.on_success();});widget.do_action('test.some_action_id',{clear_breadcrumbs:true}).then(function(){assert.ok(true,'deferred should have been resolved');widget.destroy();done();});});});});;

/* /web/static/tests/core/patch_mixin_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define("web.patchMixin_tests",function(require){"use strict";const patchMixin=require('web.patchMixin');QUnit.module('core',{},function(){QUnit.module('patchMixin',{},function(){QUnit.test('basic use',function(assert){assert.expect(4);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});const a=new A();a.f();assert.ok(a instanceof A);assert.verifySteps(['A.constructor','A.f',]);});QUnit.test('simple patch',function(assert){assert.expect(5);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch',T=>class extends T{constructor(){super();assert.step('patch.constructor');}
f(){super.f();assert.step('patch.f');}});(new A()).f();assert.verifySteps(['A.constructor','patch.constructor','A.f','patch.f',]);});QUnit.test('two patches on same base class',function(assert){assert.expect(7);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch1',T=>class extends T{constructor(){super();assert.step('patch1.constructor');}
f(){super.f();assert.step('patch1.f');}});A.patch('patch2',T=>class extends T{constructor(){super();assert.step('patch2.constructor');}
f(){super.f();assert.step('patch2.f');}});(new A()).f();assert.verifySteps(['A.constructor','patch1.constructor','patch2.constructor','A.f','patch1.f','patch2.f',]);});QUnit.test('two patches with same name on same base class',function(assert){assert.expect(1);const A=patchMixin(class{});A.patch('patch',T=>class extends T{});assert.throws(()=>{A.patch('patch',T=>class extends T{});});});QUnit.test('unpatch',function(assert){assert.expect(8);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch',T=>class extends T{constructor(){super();assert.step('patch.constructor');}
f(){super.f();assert.step('patch.f');}});(new A()).f();assert.verifySteps(['A.constructor','patch.constructor','A.f','patch.f',]);A.unpatch('patch');(new A()).f();assert.verifySteps(['A.constructor','A.f',]);});QUnit.test('unpatch 2',function(assert){assert.expect(12);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch1',T=>class extends T{constructor(){super();assert.step('patch1.constructor');}
f(){super.f();assert.step('patch1.f');}});A.patch('patch2',T=>class extends T{constructor(){super();assert.step('patch2.constructor');}
f(){super.f();assert.step('patch2.f');}});(new A()).f();assert.verifySteps(['A.constructor','patch1.constructor','patch2.constructor','A.f','patch1.f','patch2.f',]);A.unpatch('patch1');(new A()).f();assert.verifySteps(['A.constructor','patch2.constructor','A.f','patch2.f',]);});QUnit.test('unpatch inexistent',function(assert){assert.expect(1);const A=patchMixin(class{});A.patch('patch',T=>class extends T{});A.unpatch('patch');assert.throws(()=>{A.unpatch('inexistent-patch');});});QUnit.test('patch for specialization',function(assert){assert.expect(1);let args=[];const A=patchMixin(class{constructor(){args=['A',...arguments];}});A.patch('patch',T=>class extends T{constructor(){super('patch',...arguments);}});new A('instantiation');assert.deepEqual(args,['A','patch','instantiation']);});QUnit.test('instance fields',function(assert){assert.expect(1);const A=patchMixin(class{constructor(){this.x=['A'];}});A.patch('patch',T=>class extends T{constructor(){super();this.x.push('patch');}});const a=new A();assert.deepEqual(a.x,['A','patch']);});QUnit.test('call instance method defined in patch',function(assert){assert.expect(3);const A=patchMixin(class{});assert.notOk((new A()).f);A.patch('patch',T=>class extends T{f(){assert.step('patch.f');}});(new A()).f();assert.verifySteps(['patch.f']);});QUnit.test('class methods',function(assert){assert.expect(7);const A=patchMixin(class{static f(){assert.step('A');}});A.f();assert.verifySteps(['A']);A.patch('patch',T=>class extends T{static f(){super.f();assert.step('patch');}});A.f();assert.verifySteps(['A','patch']);A.unpatch('patch');A.f();assert.verifySteps(['A']);});QUnit.test('class fields',function(assert){assert.expect(4);class A{}
A.foo=['A'];A.bar='A';const PatchableA=patchMixin(A);PatchableA.patch('patch',T=>{class Patch extends T{}
Patch.foo=[...T.foo,'patched A'];Patch.bar='patched A';return Patch;});assert.deepEqual(PatchableA.foo,['A','patched A']);assert.strictEqual(PatchableA.bar,'patched A');PatchableA.unpatch('patch');assert.deepEqual(PatchableA.foo,['A']);assert.strictEqual(PatchableA.bar,'A');});QUnit.test('lazy patch',function(assert){assert.expect(4);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});const a=new A();A.patch('patch',T=>class extends T{constructor(){super();assert.step('patch.constructor');}
f(){super.f();assert.step('patch.f');}});a.f();assert.verifySteps(['A.constructor','A.f','patch.f',]);});QUnit.module('inheritance');QUnit.test('inheriting a patchable class',function(assert){assert.expect(8);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});class B extends A{constructor(){super();assert.step('B.constructor');}
f(){super.f();assert.step('B.f');}}
(new A()).f();assert.verifySteps(['A.constructor','A.f',]);(new B()).f();assert.verifySteps(['A.constructor','B.constructor','A.f','B.f',]);});QUnit.test('inheriting a patchable class that has patch',function(assert){assert.expect(12);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch',T=>class extends T{constructor(){super();assert.step('patch.constructor');}
f(){super.f();assert.step('patch.f');}});class B extends A{constructor(){super();assert.step('B.constructor');}
f(){super.f();assert.step('B.f');}}
(new A()).f();assert.verifySteps(['A.constructor','patch.constructor','A.f','patch.f',]);(new B()).f();assert.verifySteps(['A.constructor','patch.constructor','B.constructor','A.f','patch.f','B.f',]);});QUnit.test('patch inherited patchable class',function(assert){assert.expect(10);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});const B=patchMixin(class extends A{constructor(){super();assert.step('B.constructor');}
f(){super.f();assert.step('B.f');}});B.patch('patch',T=>class extends T{constructor(){super();assert.step('patch.constructor');}
f(){super.f();assert.step('patch.f');}});(new A()).f();assert.verifySteps(['A.constructor','A.f',]);(new B()).f();assert.verifySteps(['A.constructor','B.constructor','patch.constructor','A.f','B.f','patch.f',]);});QUnit.test('patch inherited patched class',function(assert){assert.expect(14);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch',T=>class extends T{constructor(){super();assert.step('A.patch.constructor');}
f(){super.f();assert.step('A.patch.f');}});const B=patchMixin(class extends A{constructor(){super();assert.step('B.constructor');}
f(){super.f();assert.step('B.f');}});B.patch('patch',T=>class extends T{constructor(){super();assert.step('B.patch.constructor');}
f(){super.f();assert.step('B.patch.f');}});const a=new A();a.f();assert.verifySteps(['A.constructor','A.patch.constructor','A.f','A.patch.f',]);const b=new B();b.f();assert.verifySteps(['A.constructor','A.patch.constructor','B.constructor','B.patch.constructor','A.f','A.patch.f','B.f','B.patch.f',]);});QUnit.test('unpatch inherited patched class',function(assert){assert.expect(15);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch',T=>class extends T{constructor(){super();assert.step('A.patch.constructor');}
f(){super.f();assert.step('A.patch.f');}});const B=patchMixin(class extends A{constructor(){super();assert.step('B.constructor');}
f(){super.f();assert.step('B.f');}});B.patch('patch',T=>class extends T{constructor(){super();assert.step('B.patch.constructor');}
f(){super.f();assert.step('B.patch.f');}});A.unpatch('patch');(new A()).f();assert.verifySteps(['A.constructor','A.f',]);(new B()).f();assert.verifySteps(['A.constructor','B.constructor','B.patch.constructor','A.f','B.f','B.patch.f',]);B.unpatch('patch');(new B()).f();assert.verifySteps(['A.constructor','B.constructor','A.f','B.f',]);});QUnit.test('unpatch inherited patched class 2',function(assert){assert.expect(12);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});A.patch('patch',T=>class extends T{constructor(){super();assert.step('A.patch.constructor');}
f(){super.f();assert.step('A.patch.f');}});const B=patchMixin(class extends A{constructor(){super();assert.step('B.constructor');}
f(){super.f();assert.step('B.f');}});B.patch('patch',T=>class extends T{constructor(){super();assert.step('B.patch.constructor');}
f(){super.f();assert.step('B.patch.f');}});B.unpatch('patch');(new B()).f();assert.verifySteps(['A.constructor','A.patch.constructor','B.constructor','A.f','A.patch.f','B.f',]);A.unpatch('patch');(new B()).f();assert.verifySteps(['A.constructor','B.constructor','A.f','B.f',]);});QUnit.test('class methods',function(assert){assert.expect(12);const A=patchMixin(class{static f(){assert.step('A');}});const B=patchMixin(class extends A{static f(){super.f();assert.step('B');}});A.patch('patch',T=>class extends T{static f(){super.f();assert.step('A.patch');}});B.patch('patch',T=>class extends T{static f(){super.f();assert.step('B.patch');}});B.f();assert.verifySteps(['A','A.patch','B','B.patch']);A.unpatch('patch');B.f();assert.verifySteps(['A','B','B.patch']);B.unpatch('patch');B.f();assert.verifySteps(['A','B']);});QUnit.test('class fields',function(assert){assert.expect(3);class A{}
A.foo=['A'];A.bar='A';const PatchableA=patchMixin(A);class B extends PatchableA{}
B.foo=[...PatchableA.foo,'B'];B.bar='B';const PatchableB=patchMixin(B);PatchableA.patch('patch',T=>{class Patch extends T{}
Patch.foo=[...T.foo,'patched A'];Patch.bar='patched A';return Patch;});PatchableB.patch('patch',T=>{class Patch extends T{}
Patch.foo=[...T.foo,'patched B'];Patch.bar='patched B';return Patch;});assert.deepEqual(PatchableB.foo,['A','B','patched B']);assert.deepEqual(PatchableA.foo,['A','patched A']);assert.strictEqual(PatchableB.bar,'patched B');});QUnit.test('inheritance and lazy patch',function(assert){assert.expect(6);const A=patchMixin(class{constructor(){assert.step('A.constructor');}
f(){assert.step('A.f');}});class B extends A{constructor(){super();assert.step('B.constructor');}
f(){super.f();assert.step('B.f');}}
const b=new B();A.patch('patch',T=>class extends T{constructor(){super();assert.step('patch.constructor');}
f(){super.f();assert.step('patch.f');}});b.f();assert.verifySteps(['A.constructor','B.constructor','A.f','patch.f','B.f',]);});QUnit.test('patch not patchable class that inherits patchable class',function(assert){assert.expect(1);const A=patchMixin(class{});class B extends A{}
assert.throws(()=>{B.patch('patch',T=>class extends T{});});});});});});;

/* /web/static/tests/core/time_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.time_tests',function(require){"use strict";var time=require('web.time');QUnit.module('core',{},function(){QUnit.module('Time utils');QUnit.test('Parse server datetime',function(assert){assert.expect(4);var date=time.str_to_datetime("2009-05-04 12:34:23");assert.deepEqual([date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds()],[2009,5-1,4,12,34,23]);assert.deepEqual([date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(),date.getSeconds()],[2009,5-1,4,12-(date.getTimezoneOffset()/60),34,23]);var date2=time.str_to_datetime('2011-12-10 00:00:00');assert.deepEqual([date2.getUTCFullYear(),date2.getUTCMonth(),date2.getUTCDate(),date2.getUTCHours(),date2.getUTCMinutes(),date2.getUTCSeconds()],[2011,12-1,10,0,0,0]);var date3=time.str_to_datetime("2009-05-04 12:34:23.84565");assert.deepEqual([date3.getUTCFullYear(),date3.getUTCMonth(),date3.getUTCDate(),date3.getUTCHours(),date3.getUTCMinutes(),date3.getUTCSeconds(),date3.getUTCMilliseconds()],[2009,5-1,4,12,34,23,845]);});QUnit.test('Parse server datetime on 31',function(assert){assert.expect(1);var wDate=window.Date;try{window.Date=function(v){if(_.isUndefined(v)){v='2013-10-31 12:34:56';}
return new wDate(v);};var date=time.str_to_datetime('2013-11-11 02:45:21');assert.deepEqual([date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds()],[2013,11-1,11,2,45,21]);}
finally{window.Date=wDate;}});QUnit.test('Parse server date',function(assert){assert.expect(1);var date=time.str_to_date("2009-05-04");assert.deepEqual([date.getFullYear(),date.getMonth(),date.getDate()],[2009,5-1,4]);});QUnit.test('Parse server date on 31',function(assert){assert.expect(1);var wDate=window.Date;try{window.Date=function(v){if(_.isUndefined(v)){v='2013-10-31 12:34:56';}
return new wDate(v);};var date=time.str_to_date('2013-11-21');assert.deepEqual([date.getFullYear(),date.getMonth(),date.getDate()],[2013,11-1,21]);}
finally{window.Date=wDate;}});QUnit.test('Parse server time',function(assert){assert.expect(2);var date=time.str_to_time("12:34:23");assert.deepEqual([date.getHours(),date.getMinutes(),date.getSeconds()],[12,34,23]);date=time.str_to_time("12:34:23.5467");assert.deepEqual([date.getHours(),date.getMinutes(),date.getSeconds(),date.getMilliseconds()],[12,34,23,546]);});QUnit.test('Format server datetime',function(assert){assert.expect(1);var date=new Date();date.setUTCFullYear(2009);date.setUTCMonth(5-1);date.setUTCDate(4);date.setUTCHours(12);date.setUTCMinutes(34);date.setUTCSeconds(23);assert.strictEqual(time.datetime_to_str(date),"2009-05-04 12:34:23");});QUnit.test('Format server date',function(assert){assert.expect(1);var date=new Date();date.setUTCFullYear(2009);date.setUTCMonth(5-1);date.setUTCDate(4);date.setUTCHours(0);date.setUTCMinutes(0);date.setUTCSeconds(0);assert.strictEqual(time.date_to_str(date),"2009-05-04");});QUnit.test('Format server time',function(assert){assert.expect(1);var date=new Date();date.setUTCFullYear(1970);date.setUTCMonth(1-1);date.setUTCDate(1);date.setUTCHours(0);date.setUTCMinutes(0);date.setUTCSeconds(0);date.setHours(12);date.setMinutes(34);date.setSeconds(23);assert.strictEqual(time.time_to_str(date),"12:34:23");});});});;

/* /web/static/tests/core/concurrency_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.concurrency_tests',function(require){"use strict";var concurrency=require('web.concurrency');var testUtils=require('web.test_utils');var makeTestPromise=testUtils.makeTestPromise;var makeTestPromiseWithAssert=testUtils.makeTestPromiseWithAssert;QUnit.module('core',{},function(){QUnit.module('concurrency');QUnit.test('mutex: simple scheduling',async function(assert){assert.expect(5);var mutex=new concurrency.Mutex();var prom1=makeTestPromiseWithAssert(assert,'prom1');var prom2=makeTestPromiseWithAssert(assert,'prom2');mutex.exec(function(){return prom1;});mutex.exec(function(){return prom2;});assert.verifySteps([]);await prom1.resolve();assert.verifySteps(['ok prom1']);await prom2.resolve();assert.verifySteps(['ok prom2']);});QUnit.test('mutex: simpleScheduling2',async function(assert){assert.expect(5);var mutex=new concurrency.Mutex();var prom1=makeTestPromiseWithAssert(assert,'prom1');var prom2=makeTestPromiseWithAssert(assert,'prom2');mutex.exec(function(){return prom1;});mutex.exec(function(){return prom2;});assert.verifySteps([]);await prom2.resolve();assert.verifySteps(['ok prom2']);await prom1.resolve();assert.verifySteps(['ok prom1']);});QUnit.test('mutex: reject',async function(assert){assert.expect(7);var mutex=new concurrency.Mutex();var prom1=makeTestPromiseWithAssert(assert,'prom1');var prom2=makeTestPromiseWithAssert(assert,'prom2');var prom3=makeTestPromiseWithAssert(assert,'prom3');mutex.exec(function(){return prom1;}).catch(function(){});mutex.exec(function(){return prom2;}).catch(function(){});mutex.exec(function(){return prom3;}).catch(function(){});assert.verifySteps([]);prom1.resolve();await testUtils.nextMicrotaskTick();assert.verifySteps(['ok prom1']);prom2.catch(function(){assert.verifySteps(['ko prom2']);});prom2.reject({name:"sdkjfmqsjdfmsjkdfkljsdq"});await testUtils.nextMicrotaskTick();prom3.resolve();await testUtils.nextMicrotaskTick();assert.verifySteps(['ok prom3']);});QUnit.test('mutex: getUnlockedDef checks',async function(assert){assert.expect(9);var mutex=new concurrency.Mutex();var prom1=makeTestPromiseWithAssert(assert,'prom1');var prom2=makeTestPromiseWithAssert(assert,'prom2');mutex.getUnlockedDef().then(function(){assert.step('mutex unlocked (1)');});await testUtils.nextMicrotaskTick();assert.verifySteps(['mutex unlocked (1)']);mutex.exec(function(){return prom1;});await testUtils.nextMicrotaskTick();mutex.getUnlockedDef().then(function(){assert.step('mutex unlocked (2)');});assert.verifySteps([]);mutex.exec(function(){return prom2;});await testUtils.nextMicrotaskTick();assert.verifySteps([]);await prom1.resolve();assert.verifySteps(['ok prom1']);prom2.resolve();await testUtils.nextTick();assert.verifySteps(['ok prom2','mutex unlocked (2)']);});QUnit.test('DropPrevious: basic usecase',async function(assert){assert.expect(4);var dp=new concurrency.DropPrevious();var prom1=makeTestPromise(assert,'prom1');var prom2=makeTestPromise(assert,'prom2');dp.add(prom1).then(()=>assert.step('should not go here')).catch(()=>assert.step("rejected dp1"));dp.add(prom2).then(()=>assert.step("ok dp2"));await testUtils.nextMicrotaskTick();assert.verifySteps(['rejected dp1']);prom2.resolve();await testUtils.nextMicrotaskTick();assert.verifySteps(['ok dp2']);});QUnit.test('DropPrevious: resolve first before last',async function(assert){assert.expect(4);var dp=new concurrency.DropPrevious();var prom1=makeTestPromise(assert,'prom1');var prom2=makeTestPromise(assert,'prom2');dp.add(prom1).then(()=>assert.step('should not go here')).catch(()=>assert.step("rejected dp1"));dp.add(prom2).then(()=>assert.step("ok dp2"));await testUtils.nextMicrotaskTick();assert.verifySteps(['rejected dp1']);prom1.resolve();prom2.resolve();await testUtils.nextMicrotaskTick();assert.verifySteps(['ok dp2']);});QUnit.test('DropMisordered: resolve all correctly ordered, sync',async function(assert){assert.expect(1);var dm=new concurrency.DropMisordered(),flag=false;var d1=makeTestPromise();var d2=makeTestPromise();var r1=dm.add(d1),r2=dm.add(d2);Promise.all([r1,r2]).then(function(){flag=true;});d1.resolve();d2.resolve();await testUtils.nextTick();assert.ok(flag);});QUnit.test("DropMisordered: don't resolve mis-ordered, sync",async function(assert){assert.expect(4);var dm=new concurrency.DropMisordered(),done1=false,done2=false,fail1=false,fail2=false;var d1=makeTestPromise();var d2=makeTestPromise();dm.add(d1).then(function(){done1=true;}).catch(function(){fail1=true;});dm.add(d2).then(function(){done2=true;}).catch(function(){fail2=true;});d2.resolve();d1.resolve();await testUtils.nextMicrotaskTick();assert.ok(!done1);assert.ok(!fail1);assert.ok(done2);assert.ok(!fail2);});QUnit.test('DropMisordered: fail mis-ordered flag, sync',async function(assert){assert.expect(4);var dm=new concurrency.DropMisordered(true),done1=false,done2=false,fail1=false,fail2=false;var d1=makeTestPromise();var d2=makeTestPromise();dm.add(d1).then(function(){done1=true;}).catch(function(){fail1=true;});dm.add(d2).then(function(){done2=true;}).catch(function(){fail2=true;});d2.resolve();d1.resolve();await testUtils.nextMicrotaskTick();assert.ok(!done1);assert.ok(fail1);assert.ok(done2);assert.ok(!fail2);});QUnit.test('DropMisordered: resolve all correctly ordered, async',function(assert){var done=assert.async();assert.expect(1);var dm=new concurrency.DropMisordered();var d1=makeTestPromise();var d2=makeTestPromise();var r1=dm.add(d1),r2=dm.add(d2);setTimeout(function(){d1.resolve();},10);setTimeout(function(){d2.resolve();},20);Promise.all([r1,r2]).then(function(){assert.ok(true);done();});});QUnit.test("DropMisordered: don't resolve mis-ordered, async",function(assert){var done=assert.async();assert.expect(4);var dm=new concurrency.DropMisordered(),done1=false,done2=false,fail1=false,fail2=false;var d1=makeTestPromise();var d2=makeTestPromise();dm.add(d1).then(function(){done1=true;}).catch(function(){fail1=true;});dm.add(d2).then(function(){done2=true;}).catch(function(){fail2=true;});setTimeout(function(){d1.resolve();},20);setTimeout(function(){d2.resolve();},10);setTimeout(function(){assert.ok(!done1);assert.ok(!fail1);assert.ok(done2);assert.ok(!fail2);done();},30);});QUnit.test('DropMisordered: fail mis-ordered flag, async',function(assert){var done=assert.async();assert.expect(4);var dm=new concurrency.DropMisordered(true),done1=false,done2=false,fail1=false,fail2=false;var d1=makeTestPromise();var d2=makeTestPromise();dm.add(d1).then(function(){done1=true;}).catch(function(){fail1=true;});dm.add(d2).then(function(){done2=true;}).catch(function(){fail2=true;});setTimeout(function(){d1.resolve();},20);setTimeout(function(){d2.resolve();},10);setTimeout(function(){assert.ok(!done1);assert.ok(fail1);assert.ok(done2);assert.ok(!fail2);done();},30);});QUnit.test('MutexedDropPrevious: simple',async function(assert){assert.expect(5);var m=new concurrency.MutexedDropPrevious();var d1=makeTestPromise();d1.then(function(){assert.step("d1 resolved");});m.exec(function(){return d1;}).then(function(result){assert.step("p1 done");assert.strictEqual(result,'d1');});assert.verifySteps([]);d1.resolve('d1');await testUtils.nextMicrotaskTick();assert.verifySteps(["d1 resolved","p1 done"]);});QUnit.test('MutexedDropPrevious: d2 arrives after d1 resolution',async function(assert){assert.expect(8);var m=new concurrency.MutexedDropPrevious();var d1=makeTestPromiseWithAssert(assert,'d1');m.exec(function(){return d1;}).then(function(){assert.step("p1 resolved");});assert.verifySteps([]);d1.resolve('d1');await testUtils.nextMicrotaskTick();assert.verifySteps(['ok d1','p1 resolved']);var d2=makeTestPromiseWithAssert(assert,'d2');m.exec(function(){return d2;}).then(function(){assert.step("p2 resolved");});assert.verifySteps([]);d2.resolve('d2');await testUtils.nextMicrotaskTick();assert.verifySteps(['ok d2','p2 resolved']);});QUnit.test('MutexedDropPrevious: p1 does not return a deferred',async function(assert){assert.expect(7);var m=new concurrency.MutexedDropPrevious();m.exec(function(){return 42;}).then(function(){assert.step("p1 resolved");});assert.verifySteps([]);await testUtils.nextMicrotaskTick();assert.verifySteps(['p1 resolved']);var d2=makeTestPromiseWithAssert(assert,'d2');m.exec(function(){return d2;}).then(function(){assert.step("p2 resolved");});assert.verifySteps([]);d2.resolve('d2');await testUtils.nextMicrotaskTick();assert.verifySteps(['ok d2','p2 resolved']);});QUnit.test('MutexedDropPrevious: p2 arrives before p1 resolution',async function(assert){assert.expect(8);var m=new concurrency.MutexedDropPrevious();var d1=makeTestPromiseWithAssert(assert,'d1');m.exec(function(){return d1;}).catch(function(){assert.step("p1 rejected");});assert.verifySteps([]);var d2=makeTestPromiseWithAssert(assert,'d2');m.exec(function(){return d2;}).then(function(){assert.step("p2 resolved");});assert.verifySteps([]);d1.resolve('d1');await testUtils.nextMicrotaskTick();assert.verifySteps(['p1 rejected','ok d1']);d2.resolve('d2');await testUtils.nextMicrotaskTick();assert.verifySteps(['ok d2','p2 resolved']);});QUnit.test('MutexedDropPrevious: 3 arrives before 2 initialization',async function(assert){assert.expect(10);var m=new concurrency.MutexedDropPrevious();var d1=makeTestPromiseWithAssert(assert,'d1');var d3=makeTestPromiseWithAssert(assert,'d3');m.exec(function(){return d1;}).catch(function(){assert.step('p1 rejected');});m.exec(function(){assert.ok(false,"should not execute this function");}).catch(function(){assert.step('p2 rejected');});m.exec(function(){return d3;}).then(function(result){assert.strictEqual(result,'d3');assert.step('p3 resolved');});assert.verifySteps([]);await testUtils.nextMicrotaskTick();assert.verifySteps(['p1 rejected','p2 rejected']);d1.resolve('d1');await testUtils.nextMicrotaskTick();assert.verifySteps(['ok d1']);d3.resolve('d3');await testUtils.nextTick();assert.verifySteps(['ok d3','p3 resolved']);});QUnit.test('MutexedDropPrevious: 3 arrives after 2 initialization',async function(assert){assert.expect(15);var m=new concurrency.MutexedDropPrevious();var d1=makeTestPromiseWithAssert(assert,'d1');var d2=makeTestPromiseWithAssert(assert,'d2');var d3=makeTestPromiseWithAssert(assert,'d3');m.exec(function(){assert.step('execute d1');return d1;}).catch(function(){assert.step('p1 rejected');});m.exec(function(){assert.step('execute d2');return d2;}).catch(function(){assert.step('p2 rejected');});assert.verifySteps(['execute d1']);await testUtils.nextMicrotaskTick();assert.verifySteps(['p1 rejected']);d1.resolve('d1');await testUtils.nextMicrotaskTick();assert.verifySteps(['ok d1','execute d2']);m.exec(function(){assert.step('execute d3');return d3;}).then(function(){assert.step('p3 resolved');});await testUtils.nextMicrotaskTick();assert.verifySteps(['p2 rejected']);d2.resolve();await testUtils.nextMicrotaskTick();assert.verifySteps(['ok d2','execute d3']);d3.resolve();await testUtils.nextTick();assert.verifySteps(['ok d3','p3 resolved']);});QUnit.test('MutexedDropPrevious: 2 in then of 1 with 3',async function(assert){assert.expect(9);var m=new concurrency.MutexedDropPrevious();var d1=makeTestPromiseWithAssert(assert,'d1');var d2=makeTestPromiseWithAssert(assert,'d2');var d3=makeTestPromiseWithAssert(assert,'d3');var p3;m.exec(function(){return d1;}).catch(function(){assert.step('p1 rejected');p3=m.exec(function(){return d3;}).then(function(){assert.step('p3 resolved');});return p3;});await testUtils.nextTick();assert.verifySteps([]);m.exec(function(){assert.ok(false,'should not execute this function');return d2;}).catch(function(){assert.step('p2 rejected');});await testUtils.nextTick();assert.verifySteps(['p1 rejected','p2 rejected']);d1.resolve('d1');await testUtils.nextTick();assert.verifySteps(['ok d1']);d3.resolve('d3');await testUtils.nextTick();assert.verifySteps(['ok d3','p3 resolved']);});});});;

/* /web/static/tests/core/util_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.util_tests',function(require){"use strict";var utils=require('web.utils');QUnit.module('core',{},function(){QUnit.module('utils');QUnit.test('groupBy',function(assert){assert.expect(7);const{groupBy}=utils;assert.throws(()=>groupBy({}),new TypeError(`list is not iterable`));assert.throws(()=>groupBy([],true),new Error(`Expected criterion of type 'string' or 'function' and got 'boolean'`));assert.throws(()=>groupBy([],3),new Error(`Expected criterion of type 'string' or 'function' and got 'number'`));assert.throws(()=>groupBy([],{}),new Error(`Expected criterion of type 'string' or 'function' and got 'object'`));assert.deepEqual(groupBy(["a","b",1,true]),{1:[1],a:["a"],b:["b"],true:[true],});assert.deepEqual(groupBy([{x:"a"},{x:"a"},{x:"b"}],"x"),{a:[{x:"a"},{x:"a"}],b:[{x:"b"}],});assert.deepEqual(groupBy(["a","b",1,true],(x)=>`el${x}`),{ela:["a"],elb:["b"],el1:[1],eltrue:[true],});});QUnit.test('intersperse',function(assert){assert.expect(27);var intersperse=utils.intersperse;assert.strictEqual(intersperse("",[]),"");assert.strictEqual(intersperse("0",[]),"0");assert.strictEqual(intersperse("012",[]),"012");assert.strictEqual(intersperse("1",[]),"1");assert.strictEqual(intersperse("12",[]),"12");assert.strictEqual(intersperse("123",[]),"123");assert.strictEqual(intersperse("1234",[]),"1234");assert.strictEqual(intersperse("123456789",[]),"123456789");assert.strictEqual(intersperse("&ab%#@1",[]),"&ab%#@1");assert.strictEqual(intersperse("0",[]),"0");assert.strictEqual(intersperse("0",[1]),"0");assert.strictEqual(intersperse("0",[2]),"0");assert.strictEqual(intersperse("0",[200]),"0");assert.strictEqual(intersperse("12345678",[0],'.'),'12345678');assert.strictEqual(intersperse("",[1],'.'),'');assert.strictEqual(intersperse("12345678",[1],'.'),'1234567.8');assert.strictEqual(intersperse("12345678",[1],'.'),'1234567.8');assert.strictEqual(intersperse("12345678",[2],'.'),'123456.78');assert.strictEqual(intersperse("12345678",[2,1],'.'),'12345.6.78');assert.strictEqual(intersperse("12345678",[2,0],'.'),'12.34.56.78');assert.strictEqual(intersperse("12345678",[-1,2],'.'),'12345678');assert.strictEqual(intersperse("12345678",[2,-1],'.'),'123456.78');assert.strictEqual(intersperse("12345678",[2,0,1],'.'),'12.34.56.78');assert.strictEqual(intersperse("12345678",[2,0,0],'.'),'12.34.56.78');assert.strictEqual(intersperse("12345678",[2,0,-1],'.'),'12.34.56.78');assert.strictEqual(intersperse("12345678",[3,3,3,3],'.'),'12.345.678');assert.strictEqual(intersperse("12345678",[3,0],'.'),'12.345.678');});QUnit.test('is_bin_size',function(assert){assert.expect(3);var is_bin_size=utils.is_bin_size;assert.strictEqual(is_bin_size('Cg=='),false);assert.strictEqual(is_bin_size('2.5 Mb'),true);assert.strictEqual(is_bin_size('64.2 Кб'),true);});QUnit.test('unaccent',function(assert){assert.expect(3);var singleCharacters=utils.unaccent("ⱮɀꝾƶⱵȥ");var doubledCharacters=utils.unaccent("ǱǄꝎꜩꝡƕ");var caseSensetiveCharacters=utils.unaccent("ⱮɀꝾƶⱵȥ",true);assert.strictEqual("mzgzhz",singleCharacters);assert.strictEqual("dzdzootzvyhv",doubledCharacters);assert.strictEqual("MzGzHz",caseSensetiveCharacters);});QUnit.test('human_number',function(assert){assert.expect(26);var human_number=utils.human_number;assert.strictEqual(human_number(1020,2,1),'1.02k');assert.strictEqual(human_number(1020000,2,2),'1020k');assert.strictEqual(human_number(10200000,2,2),'10.2M');assert.strictEqual(human_number(1020,2,1),'1.02k');assert.strictEqual(human_number(1002,2,1),'1k');assert.strictEqual(human_number(101,2,1),'101');assert.strictEqual(human_number(64.2,2,1),'64');assert.strictEqual(human_number(1e+18),'1E');assert.strictEqual(human_number(1e+21,2,1),'1e+21');assert.strictEqual(human_number(1.0045e+22,2,1),'1e+22');assert.strictEqual(human_number(1.0045e+22,3,1),'1.005e+22');assert.strictEqual(human_number(1.012e+43,2,1),'1.01e+43');assert.strictEqual(human_number(1.012e+43,2,2),'1.01e+43');assert.strictEqual(human_number(-1020,2,1),'-1.02k');assert.strictEqual(human_number(-1020000,2,2),'-1020k');assert.strictEqual(human_number(-10200000,2,2),'-10.2M');assert.strictEqual(human_number(-1020,2,1),'-1.02k');assert.strictEqual(human_number(-1002,2,1),'-1k');assert.strictEqual(human_number(-101,2,1),'-101');assert.strictEqual(human_number(-64.2,2,1),'-64');assert.strictEqual(human_number(-1e+18),'-1E');assert.strictEqual(human_number(-1e+21,2,1),'-1e+21');assert.strictEqual(human_number(-1.0045e+22,2,1),'-1e+22');assert.strictEqual(human_number(-1.0045e+22,3,1),'-1.004e+22');assert.strictEqual(human_number(-1.012e+43,2,1),'-1.01e+43');assert.strictEqual(human_number(-1.012e+43,2,2),'-1.01e+43');});QUnit.test('patch a class',function(assert){assert.expect(4);class Parent{foo(){return'Parent foo';}}
class Child extends Parent{bar(){return'Child bar';}}
const removePatch=utils.patch(Child,'patch',{foo(){return this._super()+' patch foo';},bar(){return this._super()+' patch bar';}})
const child=new Child();assert.strictEqual(child.foo(),'Parent foo patch foo')
assert.strictEqual(child.bar(),'Child bar patch bar')
removePatch();assert.strictEqual(child.foo(),'Parent foo');assert.strictEqual(child.bar(),'Child bar');})
QUnit.test('round_decimals',function(assert){assert.expect(21);var round_di=utils.round_decimals;assert.strictEqual(String(round_di(1.0,0)),'1');assert.strictEqual(String(round_di(1.0,1)),'1');assert.strictEqual(String(round_di(1.0,2)),'1');assert.strictEqual(String(round_di(1.0,3)),'1');assert.strictEqual(String(round_di(1.0,4)),'1');assert.strictEqual(String(round_di(1.0,5)),'1');assert.strictEqual(String(round_di(1.0,6)),'1');assert.strictEqual(String(round_di(1.0,7)),'1');assert.strictEqual(String(round_di(1.0,8)),'1');assert.strictEqual(String(round_di(0.5,0)),'1');assert.strictEqual(String(round_di(-0.5,0)),'-1');assert.strictEqual(String(round_di(2.6745,3)),'2.6750000000000003');assert.strictEqual(String(round_di(-2.6745,3)),'-2.6750000000000003');assert.strictEqual(String(round_di(2.6744,3)),'2.674');assert.strictEqual(String(round_di(-2.6744,3)),'-2.674');assert.strictEqual(String(round_di(0.0004,3)),'0');assert.strictEqual(String(round_di(-0.0004,3)),'0');assert.strictEqual(String(round_di(357.4555,3)),'357.456');assert.strictEqual(String(round_di(-357.4555,3)),'-357.456');assert.strictEqual(String(round_di(457.4554,3)),'457.455');assert.strictEqual(String(round_di(-457.4554,3)),'-457.455');});QUnit.test('round_precision',function(assert){assert.expect(26);var round_pr=utils.round_precision;assert.strictEqual(String(round_pr(1.0,1)),'1');assert.strictEqual(String(round_pr(1.0,0.1)),'1');assert.strictEqual(String(round_pr(1.0,0.01)),'1');assert.strictEqual(String(round_pr(1.0,0.001)),'1');assert.strictEqual(String(round_pr(1.0,0.0001)),'1');assert.strictEqual(String(round_pr(1.0,0.00001)),'1');assert.strictEqual(String(round_pr(1.0,0.000001)),'1');assert.strictEqual(String(round_pr(1.0,0.0000001)),'1');assert.strictEqual(String(round_pr(1.0,0.00000001)),'1');assert.strictEqual(String(round_pr(0.5,1)),'1');assert.strictEqual(String(round_pr(-0.5,1)),'-1');assert.strictEqual(String(round_pr(2.6745,0.001)),'2.6750000000000003');assert.strictEqual(String(round_pr(-2.6745,0.001)),'-2.6750000000000003');assert.strictEqual(String(round_pr(2.6744,0.001)),'2.674');assert.strictEqual(String(round_pr(-2.6744,0.001)),'-2.674');assert.strictEqual(String(round_pr(0.0004,0.001)),'0');assert.strictEqual(String(round_pr(-0.0004,0.001)),'0');assert.strictEqual(String(round_pr(357.4555,0.001)),'357.456');assert.strictEqual(String(round_pr(-357.4555,0.001)),'-357.456');assert.strictEqual(String(round_pr(457.4554,0.001)),'457.455');assert.strictEqual(String(round_pr(-457.4554,0.001)),'-457.455');assert.strictEqual(String(round_pr(-457.4554,0.05)),'-457.45000000000005');assert.strictEqual(String(round_pr(457.444,0.5)),'457.5');assert.strictEqual(String(round_pr(457.3,5)),'455');assert.strictEqual(String(round_pr(457.5,5)),'460');assert.strictEqual(String(round_pr(457.1,3)),'456');});QUnit.test('sortBy',function(assert){assert.expect(27);const{sortBy}=utils;const bools=[true,false,true];const ints=[2,1,5];const strs=['b','a','z'];const objbools=[{x:true},{x:false},{x:true}];const objints=[{x:2},{x:1},{x:5}];const objstrss=[{x:'b'},{x:'a'},{x:'z'}];assert.throws(()=>sortBy({}),new TypeError(`array.slice is not a function`));assert.throws(()=>sortBy([Symbol('b'),Symbol('a')]),new TypeError(`Cannot convert a Symbol value to a number`));assert.throws(()=>sortBy(ints,true),new Error(`Expected criterion of type 'string' or 'function' and got 'boolean'`));assert.throws(()=>sortBy(ints,3),new Error(`Expected criterion of type 'string' or 'function' and got 'number'`));assert.throws(()=>sortBy(ints,{}),new Error(`Expected criterion of type 'string' or 'function' and got 'object'`));const toSort=[2,3,1];sortBy(toSort);assert.deepEqual(toSort,[2,3,1]);assert.deepEqual(sortBy([]),[]);assert.deepEqual(sortBy(ints),[1,2,5]);assert.deepEqual(sortBy(bools),[false,true,true]);assert.deepEqual(sortBy(strs),['a','b','z']);assert.deepEqual(sortBy(objbools),[{x:true},{x:false},{x:true}]);assert.deepEqual(sortBy(objints),[{x:2},{x:1},{x:5}]);assert.deepEqual(sortBy(objstrss),[{x:'b'},{x:'a'},{x:'z'}]);const prop='x';assert.deepEqual(sortBy([],prop),[]);assert.deepEqual(sortBy(ints,prop),[2,1,5]);assert.deepEqual(sortBy(bools,prop),[true,false,true]);assert.deepEqual(sortBy(strs,prop),['b','a','z']);assert.deepEqual(sortBy(objbools,prop),[{x:false},{x:true},{x:true}]);assert.deepEqual(sortBy(objints,prop),[{x:1},{x:2},{x:5}]);assert.deepEqual(sortBy(objstrss,prop),[{x:'a'},{x:'b'},{x:'z'}]);const getter=obj=>obj.x;assert.deepEqual(sortBy([],getter),[]);assert.deepEqual(sortBy(ints,getter),[2,1,5]);assert.deepEqual(sortBy(bools,getter),[true,false,true]);assert.deepEqual(sortBy(strs,getter),['b','a','z']);assert.deepEqual(sortBy(objbools,getter),[{x:false},{x:true},{x:true}]);assert.deepEqual(sortBy(objints,getter),[{x:1},{x:2},{x:5}]);assert.deepEqual(sortBy(objstrss,getter),[{x:'a'},{x:'b'},{x:'z'}]);});});});;

/* /web/static/tests/core/widget_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.widget_tests',function(require){"use strict";var AjaxService=require('web.AjaxService');var core=require('web.core');var Dialog=require('web.Dialog');var QWeb=require('web.QWeb');var Widget=require('web.Widget');var testUtils=require('web.test_utils');QUnit.module('core',{},function(){QUnit.module('Widget');QUnit.test('proxy (String)',function(assert){assert.expect(1);var W=Widget.extend({exec:function(){this.executed=true;}});var w=new W();var fn=w.proxy('exec');fn();assert.ok(w.executed,'should execute the named method in the right context');w.destroy();});QUnit.test('proxy (String)(*args)',function(assert){assert.expect(2);var W=Widget.extend({exec:function(arg){this.executed=arg;}});var w=new W();var fn=w.proxy('exec');fn(42);assert.ok(w.executed,"should execute the named method in the right context");assert.strictEqual(w.executed,42,"should be passed the proxy's arguments");w.destroy();});QUnit.test('proxy (String), include',function(assert){assert.expect(1);var W=Widget.extend({exec:function(){this.executed=1;}});var w=new W();var fn=w.proxy('exec');W.include({exec:function(){this.executed=2;}});fn();assert.strictEqual(w.executed,2,"should be lazily resolved");w.destroy();});QUnit.test('proxy (Function)',function(assert){assert.expect(1);var w=new(Widget.extend({}))();var fn=w.proxy(function(){this.executed=true;});fn();assert.ok(w.executed,"should set the function's context (like Function#bind)");w.destroy();});QUnit.test('proxy (Function)(*args)',function(assert){assert.expect(1);var w=new(Widget.extend({}))();var fn=w.proxy(function(arg){this.executed=arg;});fn(42);assert.strictEqual(w.executed,42,"should be passed the proxy's arguments");w.destroy();});QUnit.test('renderElement, no template, default',function(assert){assert.expect(7);var widget=new(Widget.extend({}))();assert.strictEqual(widget.$el,undefined,"should not have a root element");widget.renderElement();assert.ok(widget.$el,"should have generated a root element");assert.strictEqual(widget.$el,widget.$el,"should provide $el alias");assert.ok(widget.$el.is(widget.el),"should provide raw DOM alias");assert.strictEqual(widget.el.nodeName,'DIV',"should have generated the default element");assert.strictEqual(widget.el.attributes.length,0,"should not have generated any attribute");assert.ok(_.isEmpty(widget.$el.html(),"should not have generated any content"));widget.destroy();});QUnit.test('no template, custom tag',function(assert){assert.expect(1);var widget=new(Widget.extend({tagName:'ul'}))();widget.renderElement();assert.strictEqual(widget.el.nodeName,'UL',"should have generated the custom element tag");widget.destroy();});QUnit.test('no template, @id',function(assert){assert.expect(3);var widget=new(Widget.extend({id:'foo'}))();widget.renderElement();assert.strictEqual(widget.el.attributes.length,1,"should have one attribute");assert.hasAttrValue(widget.$el,'id','foo',"should have generated the id attribute");assert.strictEqual(widget.el.id,'foo',"should also be available via property");widget.destroy();});QUnit.test('no template, @className',function(assert){assert.expect(2);var widget=new(Widget.extend({className:'oe_some_class'}))();widget.renderElement();assert.strictEqual(widget.el.className,'oe_some_class',"should have the right property");assert.hasAttrValue(widget.$el,'class','oe_some_class',"should have the right attribute");widget.destroy();});QUnit.test('no template, bunch of attributes',function(assert){assert.expect(9);var widget=new(Widget.extend({attributes:{'id':'some_id','class':'some_class','data-foo':'data attribute','clark':'gable','spoiler':'snape kills dumbledore'}}))();widget.renderElement();assert.strictEqual(widget.el.attributes.length,5,"should have all the specified attributes");assert.strictEqual(widget.el.id,'some_id');assert.hasAttrValue(widget.$el,'id','some_id');assert.strictEqual(widget.el.className,'some_class');assert.hasAttrValue(widget.$el,'class','some_class');assert.hasAttrValue(widget.$el,'data-foo','data attribute');assert.strictEqual(widget.$el.data('foo'),'data attribute');assert.hasAttrValue(widget.$el,'clark','gable');assert.hasAttrValue(widget.$el,'spoiler','snape kills dumbledore');widget.destroy();});QUnit.test('template',function(assert){assert.expect(3);core.qweb.add_template('<no>'+'<t t-name="test.widget.template">'+'<ol>'+'<li t-foreach="5" t-as="counter" '+'t-attf-class="class-#{counter}">'+'<input/>'+'<t t-esc="counter"/>'+'</li>'+'</ol>'+'</t>'+'</no>');var widget=new(Widget.extend({template:'test.widget.template'}))();widget.renderElement();assert.strictEqual(widget.el.nodeName,'OL');assert.strictEqual(widget.$el.children().length,5);assert.strictEqual(widget.el.textContent,'01234');widget.destroy();});QUnit.test('repeated',async function(assert){assert.expect(4);var $fix=$("#qunit-fixture");core.qweb.add_template('<no>'+'<t t-name="test.widget.template">'+'<p><t t-esc="widget.value"/></p>'+'</t>'+'</no>');var widget=new(Widget.extend({template:'test.widget.template'}))();widget.value=42;await widget.appendTo($fix).then(function(){assert.strictEqual($fix.find('p').text(),'42',"DOM fixture should contain initial value");assert.strictEqual(widget.$el.text(),'42',"should set initial value");widget.value=36;widget.renderElement();assert.strictEqual($fix.find('p').text(),'36',"DOM fixture should use new value");assert.strictEqual(widget.$el.text(),'36',"should set new value");});widget.destroy();});QUnit.module('Widgets, with QWeb',{beforeEach:function(){this.oldQWeb=core.qweb;core.qweb=new QWeb();core.qweb.add_template('<no>'+'<t t-name="test.widget.template">'+'<ol>'+'<li t-foreach="5" t-as="counter" '+'t-attf-class="class-#{counter}">'+'<input/>'+'<t t-esc="counter"/>'+'</li>'+'</ol>'+'</t>'+'</no>');},afterEach:function(){core.qweb=this.oldQWeb;},});QUnit.test('basic-alias',function(assert){assert.expect(1);var widget=new(Widget.extend({template:'test.widget.template'}))();widget.renderElement();assert.ok(widget.$('li:eq(3)').is(widget.$el.find('li:eq(3)')),"should do the same thing as calling find on the widget root");widget.destroy();});QUnit.test('delegate',async function(assert){assert.expect(5);var a=[];var widget=new(Widget.extend({template:'test.widget.template',events:{'click':function(){a[0]=true;assert.strictEqual(this,widget,"should trigger events in widget");},'click li.class-3':'class3','change input':function(){a[2]=true;}},class3:function(){a[1]=true;}}))();widget.renderElement();await testUtils.dom.click(widget.$el,{allowInvisible:true});await testUtils.dom.click(widget.$('li:eq(3)'),{allowInvisible:true});await testUtils.fields.editAndTrigger(widget.$('input:last'),'foo','change');for(var i=0;i<3;++i){assert.ok(a[i],"should pass test "+i);}
widget.destroy();});QUnit.test('undelegate',async function(assert){assert.expect(4);var clicked=false;var newclicked=false;var widget=new(Widget.extend({template:'test.widget.template',events:{'click li':function(){clicked=true;}}}))();widget.renderElement();widget.$el.on('click','li',function(){newclicked=true;});await testUtils.dom.clickFirst(widget.$('li'),{allowInvisible:true});assert.ok(clicked,"should trigger bound events");assert.ok(newclicked,"should trigger bound events");clicked=newclicked=false;widget._undelegateEvents();await testUtils.dom.clickFirst(widget.$('li'),{allowInvisible:true});assert.ok(!clicked,"undelegate should unbind events delegated");assert.ok(newclicked,"undelegate should only unbind events it created");widget.destroy();});QUnit.module('Widget, and async stuff');QUnit.test("alive(alive)",async function(assert){assert.expect(1);var widget=new(Widget.extend({}));await widget.start().then(function(){return widget.alive(Promise.resolve());}).then(function(){assert.ok(true);});widget.destroy();});QUnit.test("alive(dead)",function(assert){assert.expect(1);var widget=new(Widget.extend({}));return new Promise(function(resolve,reject){widget.start().then(function(){widget.destroy();var promise=Promise.resolve();promise.then(function(){return Promise.resolve();}).then(function(){assert.ok(true);resolve();});return widget.alive(promise);}).then(function(){reject();assert.ok(false,"alive() should not terminate by default");}).catch(function(){reject();assert.ok(false,"alive() should not terminate by default");});});});QUnit.test("alive(alive, true)",async function(assert){assert.expect(1);var widget=new(Widget.extend({}));await widget.start().then(function(){return widget.alive(Promise.resolve(),true);}).then(function(){assert.ok(true);});widget.destroy();});QUnit.test("alive(dead, true)",function(assert){assert.expect(1);var done=assert.async();var widget=new(Widget.extend({}));widget.start().then(function(){widget.destroy();return widget.alive(Promise.resolve(),true);}).then(function(){assert.ok(false,"alive(p, true) should fail its promise");done();},function(){assert.ok(true,"alive(p, true) should fail its promise");done();});});QUnit.test("calling _rpc on destroyed widgets",async function(assert){assert.expect(3);var def;var parent=new Widget();await testUtils.mock.addMockEnvironment(parent,{session:{rpc:function(){def=testUtils.makeTestPromise();def.abort=def.reject;return def;},},services:{ajax:AjaxService},});var widget=new Widget(parent);widget._rpc({route:'/a/route'}).then(function(){assert.ok(true,"The ajax call should be resolve");});def.resolve();await testUtils.nextMicrotaskTick();def=null;widget._rpc({route:'/a/route'}).then(function(){throw Error("Calling _rpc on a destroyed widget should return a "+"promise that remains pending forever");}).catch(function(){throw Error("Calling _rpc on a destroyed widget should return a "+"promise that remains pending forever");});widget.destroy();def.resolve();await testUtils.nextMicrotaskTick();def=null;widget._rpc({route:'/a/route'}).then(function(){throw Error("Calling _rpc on a destroyed widget should return a "+"promise that remains pending forever");}).catch(function(){throw Error("Calling _rpc on a destroyed widget should return a "+"promise that remains pending forever");});assert.ok(!def,"trigger_up is not performed and the call returns a "+"promise that remains pending forever");assert.ok(true,"there should be no crash when calling _rpc on a destroyed widget");parent.destroy();});QUnit.test('start is not called when widget is destroyed',function(assert){assert.expect(0);const $fix=$("#qunit-fixture");const MyWidget=Widget.extend({start:function(){assert.ok(false,'Should not call start method');},});const widget=new MyWidget();widget.appendTo($fix);widget.destroy();const divEl=document.createElement('div');$fix[0].appendChild(divEl);const widget2=new MyWidget();widget2.attachTo(divEl);widget2.destroy();});QUnit.test("don't destroy twice widget's children",function(assert){assert.expect(2);var parent=new Widget();var child=new(Widget.extend({destroy:function(){assert.step('destroy');}}))(parent);parent.destroy();assert.verifySteps(['destroy'],"child should have been detroyed only once");});QUnit.module('Widgets, Dialog');QUnit.test("don't close dialog on backdrop click",async function(assert){assert.expect(3);var dialog=new Dialog(null);dialog.open();await dialog.opened();assert.strictEqual($('.modal.show').length,1,"a dialog should have opened");var $backdrop=$('.modal-backdrop');assert.strictEqual($backdrop.length,1,"the dialog should have a modal backdrop");testUtils.dom.click('.modal.show');assert.strictEqual($('.modal.show').length,1,"the dialog should still be opened");dialog.close();});});});;

/* /web/static/tests/core/dialog_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.dialog_tests',function(require){"use strict";var Dialog=require('web.Dialog');var testUtils=require('web.test_utils');var Widget=require('web.Widget');var ESCAPE_KEY=$.Event("keyup",{which:27});async function createEmptyParent(debug){var widget=new Widget();await testUtils.mock.addMockEnvironment(widget,{debug:debug||false,});return widget;}
QUnit.module('core',{},function(){QUnit.module('Dialog');QUnit.test("Closing custom dialog using buttons calls standard callback",async function(assert){assert.expect(3);var testPromise=testUtils.makeTestPromiseWithAssert(assert,'custom callback');var parent=await createEmptyParent();new Dialog(parent,{buttons:[{text:"Close",classes:'btn-primary',close:true,click:testPromise.resolve,},],$content:$('<main/>'),onForceClose:testPromise.reject,}).open();assert.verifySteps([]);await testUtils.nextTick();await testUtils.dom.click($('.modal[role="dialog"] .btn-primary'));testPromise.then(()=>{assert.verifySteps(['ok custom callback']);});parent.destroy();});QUnit.test("Closing custom dialog without using buttons calls force close callback",async function(assert){assert.expect(3);var testPromise=testUtils.makeTestPromiseWithAssert(assert,'custom callback');var parent=await createEmptyParent();new Dialog(parent,{buttons:[{text:"Close",classes:'btn-primary',close:true,click:testPromise.reject,},],$content:$('<main/>'),onForceClose:testPromise.resolve,}).open();assert.verifySteps([]);await testUtils.nextTick();await testUtils.dom.triggerEvents($('.modal[role="dialog"]'),[ESCAPE_KEY]);testPromise.then(()=>{assert.verifySteps(['ok custom callback']);});parent.destroy();});QUnit.test("Closing confirm dialog without using buttons calls cancel callback",async function(assert){assert.expect(3);var testPromise=testUtils.makeTestPromiseWithAssert(assert,'confirm callback');var parent=await createEmptyParent();var options={confirm_callback:testPromise.reject,cancel_callback:testPromise.resolve,};Dialog.confirm(parent,"",options);assert.verifySteps([]);await testUtils.nextTick();await testUtils.dom.triggerEvents($('.modal[role="dialog"]'),[ESCAPE_KEY]);testPromise.then(()=>{assert.verifySteps(['ok confirm callback']);});parent.destroy();});QUnit.test("Closing alert dialog without using buttons calls confirm callback",async function(assert){assert.expect(3);var testPromise=testUtils.makeTestPromiseWithAssert(assert,'alert callback');var parent=await createEmptyParent();var options={confirm_callback:testPromise.resolve,};Dialog.alert(parent,"",options);assert.verifySteps([]);await testUtils.nextTick();await testUtils.dom.triggerEvents($('.modal[role="dialog"]'),[ESCAPE_KEY]);testPromise.then(()=>{assert.verifySteps(['ok alert callback']);});parent.destroy();});QUnit.test("Ensure on_attach_callback and on_detach_callback are properly called",async function(assert){assert.expect(4);const TestDialog=Dialog.extend({on_attach_callback(){assert.step('on_attach_callback');},on_detach_callback(){assert.step('on_detach_callback');},});const parent=await createEmptyParent();const dialog=new TestDialog(parent,{buttons:[{text:"Close",classes:'btn-primary',close:true,},],$content:$('<main/>'),}).open();await dialog.opened();assert.verifySteps(['on_attach_callback']);await testUtils.dom.click($('.modal[role="dialog"] .btn-primary'));assert.verifySteps(['on_detach_callback']);parent.destroy();});});});;

/* /web/static/tests/core/owl_dialog_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.owl_dialog_tests',function(require){"use strict";const LegacyDialog=require('web.Dialog');const makeTestEnvironment=require('web.test_env');const Dialog=require('web.OwlDialog');const testUtils=require('web.test_utils');const{Component,tags,useState}=owl;const EscapeKey={key:'Escape',keyCode:27,which:27};const{xml}=tags;QUnit.module('core',{},function(){QUnit.module('OwlDialog');QUnit.test("Rendering of all props",async function(assert){assert.expect(35);class SubComponent extends Component{_onClick(){assert.step('subcomponent_clicked');}}
SubComponent.template=xml`<div class="o_subcomponent" t-esc="props.text" t-on-click="_onClick"/>`;class Parent extends Component{constructor(){super(...arguments);this.state=useState({textContent:"sup"});}
_onButtonClicked(ev){assert.step('button_clicked');}
_onDialogClosed(){assert.step('dialog_closed');}}
Parent.components={Dialog,SubComponent};Parent.env=makeTestEnvironment();Parent.template=xml`
                <Dialog
                    backdrop="state.backdrop"
                    contentClass="state.contentClass"
                    fullscreen="state.fullscreen"
                    renderFooter="state.renderFooter"
                    renderHeader="state.renderHeader"
                    size="state.size"
                    subtitle="state.subtitle"
                    technical="state.technical"
                    title="state.title"
                    t-on-dialog-closed="_onDialogClosed"
                    >
                    <SubComponent text="state.textContent"/>
                    <t t-set="buttons">
                        <button class="btn btn-primary" t-on-click="_onButtonClicked">The Button</button>
                    </t>
                </Dialog>`;const parent=new Parent();await parent.mount(testUtils.prepareTarget());const dialog=document.querySelector('.o_dialog');async function changeProps(key,value){parent.state[key]=value;await testUtils.nextTick();}
assert.containsOnce(dialog,'.modal.o_technical_modal');assert.hasClass(dialog.querySelector('.modal .modal-dialog'),'modal-lg');assert.containsOnce(dialog,'.modal-header > button.close');assert.containsOnce(dialog,'.modal-footer > button.btn.btn-primary');assert.strictEqual(dialog.querySelector('.modal-body').innerText.trim(),"sup","Subcomponent should match with its given text");dialog.querySelector('.btn-primary').blur();assert.containsNone(document.body,'.modal-backdrop');assert.notEqual(window.getComputedStyle(dialog.querySelector('.modal')).backgroundColor,'rgba(0, 0, 0, 0)');await testUtils.dom.click(dialog.querySelector('.modal'));assert.strictEqual(document.activeElement,dialog.querySelector('.btn-primary'),"Button should be focused when clicking on backdrop");assert.verifySteps([]);dialog.querySelector('.btn-primary').blur();await changeProps('backdrop',false);assert.containsNone(document.body,'.modal-backdrop');assert.strictEqual(window.getComputedStyle(dialog.querySelector('.modal')).backgroundColor,'rgba(0, 0, 0, 0)');await testUtils.dom.click(dialog.querySelector('.modal'));assert.notEqual(document.activeElement,dialog.querySelector('.btn-primary'),"Button should not be focused when clicking on backdrop 'false'");assert.verifySteps([]);await changeProps('backdrop',true);assert.containsNone(document.body,'.modal-backdrop');assert.notEqual(window.getComputedStyle(dialog.querySelector('.modal')).backgroundColor,'rgba(0, 0, 0, 0)');await testUtils.dom.click(dialog.querySelector('.modal'));assert.notEqual(document.activeElement,dialog.querySelector('.btn-primary'),"Button should not be focused when clicking on backdrop 'true'");assert.verifySteps(['dialog_closed']);await changeProps('contentClass','my_dialog_class');assert.hasClass(dialog.querySelector('.modal-content'),'my_dialog_class');assert.doesNotHaveClass(dialog.querySelector('.modal'),'o_modal_full');await changeProps('fullscreen',true);assert.hasClass(dialog.querySelector('.modal'),'o_modal_full');await changeProps('size','extra-large');assert.strictEqual(dialog.querySelector('.modal-dialog').className,'modal-dialog modal-xl',"Modal should have taken the class modal-xl");await changeProps('size','medium');assert.strictEqual(dialog.querySelector('.modal-dialog').className,'modal-dialog',"Modal should not have any additionnal class with 'medium'");await changeProps('size','small');assert.strictEqual(dialog.querySelector('.modal-dialog').className,'modal-dialog modal-sm',"Modal should have taken the class modal-sm");await changeProps('subtitle',"The Subtitle");assert.strictEqual(dialog.querySelector('span.o_subtitle').innerText.trim(),"The Subtitle","Subtitle should match with its given text");assert.hasClass(dialog.querySelector('.modal'),'o_technical_modal');await changeProps('technical',false);assert.doesNotHaveClass(dialog.querySelector('.modal'),'o_technical_modal');assert.strictEqual(dialog.querySelector('h4.modal-title').innerText.trim(),"Odoo"+"The Subtitle","Title should match with its default text");await changeProps('title',"The Title");assert.strictEqual(dialog.querySelector('h4.modal-title').innerText.trim(),"The Title"+"The Subtitle","Title should match with its given text");await testUtils.dom.click(dialog.querySelector('.modal-footer .btn-primary'));await changeProps('renderFooter',false);assert.containsNone(dialog,'.modal-footer');await changeProps('renderHeader',false);assert.containsNone(dialog,'.header');await changeProps('textContent',"wassup");assert.strictEqual(dialog.querySelector('.o_subcomponent').innerText.trim(),"wassup","Subcomponent should match with its given text");await testUtils.dom.click(dialog.querySelector('.o_subcomponent'));assert.verifySteps(['button_clicked','subcomponent_clicked']);parent.destroy();});QUnit.test("Interactions between multiple dialogs",async function(assert){assert.expect(22);class Parent extends Component{constructor(){super(...arguments);this.dialogIds=useState([]);}
_onDialogClosed(id){assert.step(`dialog_${id}_closed`);this.dialogIds.splice(this.dialogIds.findIndex(d=>d===id),1);}}
Parent.components={Dialog};Parent.env=makeTestEnvironment();Parent.template=xml`
                <div>
                    <Dialog t-foreach="dialogIds" t-as="dialogId" t-key="dialogId"
                        contentClass="'dialog_' + dialogId"
                        t-on-dialog-closed="_onDialogClosed(dialogId)"
                    />
                </div>`;const parent=new Parent();await parent.mount(testUtils.prepareTarget());parent.dialogIds.push(1);await testUtils.nextTick();new LegacyDialog(null,{}).open();await testUtils.nextTick();new LegacyDialog(null,{}).open();await testUtils.nextTick();parent.dialogIds.push(4);await testUtils.nextTick();parent.dialogIds.push(5);await testUtils.nextTick();const unopenedModal=new LegacyDialog(null,{});await testUtils.nextTick();unopenedModal.close();let modals=document.querySelectorAll('.modal');assert.notOk(modals[modals.length-1].classList.contains('o_inactive_modal'),"last dialog should have the active class");assert.notOk(modals[modals.length-1].classList.contains('o_legacy_dialog'),"active dialog should not have the legacy class");assert.containsN(document.body,'.o_dialog',3);assert.containsN(document.body,'.o_legacy_dialog',2);await testUtils.dom.triggerEvent(modals[modals.length-1],'keydown',EscapeKey);modals=document.querySelectorAll('.modal');assert.notOk(modals[modals.length-1].classList.contains('o_inactive_modal'),"last dialog should have the active class");assert.notOk(modals[modals.length-1].classList.contains('o_legacy_dialog'),"active dialog should not have the legacy class");assert.containsN(document.body,'.o_dialog',2);assert.containsN(document.body,'.o_legacy_dialog',2);await testUtils.dom.click(modals[modals.length-1].querySelector('.btn.btn-primary'));modals=document.querySelectorAll('.modal');assert.containsOnce(document.body,'.modal.o_legacy_dialog:not(.o_inactive_modal)',"active dialog should have the legacy class");assert.containsOnce(document.body,'.o_dialog');assert.containsN(document.body,'.o_legacy_dialog',2);await testUtils.dom.triggerEvent(modals[modals.length-1],'keydown',EscapeKey);modals=document.querySelectorAll('.modal');assert.containsOnce(document.body,'.modal.o_legacy_dialog:not(.o_inactive_modal)',"active dialog should have the legacy class");assert.containsOnce(document.body,'.o_dialog');assert.containsOnce(document.body,'.o_legacy_dialog');await testUtils.dom.click(modals[modals.length-1].querySelector('.close'));modals=document.querySelectorAll('.modal');assert.notOk(modals[modals.length-1].classList.contains('o_inactive_modal'),"last dialog should have the active class");assert.notOk(modals[modals.length-1].classList.contains('o_legacy_dialog'),"active dialog should not have the legacy class");assert.containsOnce(document.body,'.o_dialog');assert.containsNone(document.body,'.o_legacy_dialog');parent.unmount();assert.containsNone(document.body,'.modal');assert.verifySteps(['dialog_5_closed','dialog_4_closed']);parent.destroy();});});QUnit.test("Z-index toggling and interactions",async function(assert){assert.expect(3);function createCustomModal(className){const $modal=$(`<div role="dialog" class="${className}" tabindex="-1">
                    <div class="modal-dialog medium">
                        <div class="modal-content">
                            <main class="modal-body">The modal body</main>
                        </div>
                    </div>
                </div>`).appendTo('body').modal();const modal=$modal[0];modal.destroy=function(){$modal.modal('hide');this.remove();};return modal;}
class Parent extends Component{constructor(){super(...arguments);this.state=useState({showSecondDialog:true});}}
Parent.components={Dialog};Parent.env=makeTestEnvironment();Parent.template=xml`
            <div>
                <Dialog/>
                <Dialog t-if="state.showSecondDialog"/>
            </div>`;const parent=new Parent();await parent.mount(testUtils.prepareTarget());const frontEndModal=createCustomModal('modal');const backEndModal=createCustomModal('modal o_technical_modal');const owlIndexBefore=getComputedStyle(document.querySelector('.o_dialog .modal')).zIndex;const feZIndexBefore=getComputedStyle(frontEndModal).zIndex;const beZIndexBefore=getComputedStyle(backEndModal).zIndex;parent.state.showSecondDialog=false;await testUtils.nextTick();assert.ok(owlIndexBefore<getComputedStyle(document.querySelector('.o_dialog .modal')).zIndex,"z-index of the owl dialog should be incremented since the active modal was destroyed");assert.strictEqual(feZIndexBefore,getComputedStyle(frontEndModal).zIndex,"z-index of front-end modals should not be impacted by Owl Dialog activity system");assert.strictEqual(beZIndexBefore,getComputedStyle(backEndModal).zIndex,"z-index of custom back-end modals should not be impacted by Owl Dialog activity system");parent.destroy();frontEndModal.destroy();backEndModal.destroy();});});;

/* /web/static/tests/core/popover_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.popover_tests',function(require){'use strict';const makeTestEnvironment=require('web.test_env');const Popover=require('web.Popover');const testUtils=require('web.test_utils');const{Component,tags,hooks}=owl;const{useRef,useState}=hooks;const{xml}=tags;QUnit.module('core',{},function(){QUnit.module('Popover');QUnit.test('Basic rendering & props',async function(assert){assert.expect(11);class SubComponent extends Component{}
SubComponent.template=xml`
                <div class="o_subcomponent" style="width: 280px;" t-esc="props.text"/>
            `;class Parent extends Component{constructor(){super(...arguments);this.state=useState({position:'right',title:'👋',textContent:'sup',});this.popoverRef=useRef('popoverRef');}}
Parent.components={SubComponent};Parent.env=makeTestEnvironment();Parent.template=xml`
                <div>
                    <button id="passiveTarget">🚫</button>
                    <Popover t-ref="popoverRef"
                        position="state.position"
                        title="state.title"
                        >
                        <t t-set="opened">
                            <SubComponent text="state.textContent"/>
                        </t>
                        <button id="target">
                            Notice me, senpai 👀
                        </button>
                    </Popover>
                </div>`;const parent=new Parent();const fixture=testUtils.prepareTarget();fixture.style.top='300px';fixture.style.left='150px';fixture.style.width='300px';async function changeProps(key,value){parent.state[key]=value;await testUtils.nextTick();}
function pointsTo(popover,element,position){const hasCorrectClass=popover.classList.contains(`o_popover--${position}`);const expectedPosition=Popover.computePositioningData(popover,element)[position];const correctLeft=parseFloat(popover.style.left)===Math.round(expectedPosition.left*100)/100;const correctTop=parseFloat(popover.style.top)===Math.round(expectedPosition.top*100)/100;return hasCorrectClass&&correctLeft&&correctTop;}
await parent.mount(fixture);const body=document.querySelector('body');let popover,title;assert.containsNone(body,'.o_popover');await testUtils.dom.click('#target');assert.containsOnce(body,'.o_popover');assert.containsOnce(body,'.o_subcomponent');assert.containsOnce(body,'.o_popover--right');await testUtils.dom.click('#passiveTarget');assert.containsNone(body,'.o_popover');await testUtils.dom.click('#target');popover=document.querySelector('.o_popover');title=popover.querySelector('.o_popover_header').innerText.trim();assert.strictEqual(title,'👋');await changeProps('title','🤔');title=popover.querySelector('.o_popover_header').innerText.trim();assert.strictEqual(title,'🤔','The title of the popover should have changed.');const element=parent.popoverRef.el;assert.ok(pointsTo(document.querySelector('.o_popover'),element,parent.state.position),'Popover should be visually aligned with its target');await changeProps('position','bottom');assert.ok(pointsTo(document.querySelector('.o_popover'),element,parent.state.position),'Popover should be bottomed positioned');await changeProps('textContent','wassup');assert.strictEqual(popover.querySelector('.o_subcomponent').innerText.trim(),'wassup','Subcomponent should match with its given text');await testUtils.dom.click('#passiveTarget');await changeProps('position','left');await testUtils.dom.click('#target');assert.ok(pointsTo(document.querySelector('.o_popover'),element,'right'),"Popover should be right-positioned because it doesn't fit left");await testUtils.dom.click('#passiveTarget');parent.destroy();});QUnit.test('Multiple popovers',async function(assert){assert.expect(9);class Parent extends Component{}
Parent.components={Popover};Parent.env=makeTestEnvironment();Parent.template=xml`
                <div>
                    <Popover>
                        <button id="firstTarget">👋</button>
                        <t t-set="opened">
                            <p id="firstContent">first popover</p>
                        </t>
                    </Popover>
                    <br/>
                    <Popover>
                        <button id="secondTarget">👏</button>
                        <t t-set="opened">
                            <p id="secondContent">second popover</p>
                        </t>
                    </Popover>
                    <br/>
                    <span id="dismissPopovers">💀</span>
                </div>`;const parent=new Parent();const fixture=testUtils.prepareTarget();const body=document.querySelector('body');await parent.mount(fixture);assert.containsNone(body,'.o_popover');await testUtils.dom.click('#firstTarget');assert.containsOnce(body,'#firstContent');assert.containsNone(body,'#secondContent');await testUtils.dom.click('#dismissPopovers');assert.containsNone(body,'.o_popover');await testUtils.dom.click('#firstTarget');assert.containsOnce(body,'#firstContent');assert.containsNone(body,'#secondContent');await testUtils.dom.click('#secondTarget');assert.containsNone(body,'#firstContent');assert.containsOnce(body,'#secondContent');await testUtils.dom.click('#dismissPopovers');assert.containsNone(body,'.o_popover');parent.destroy();});QUnit.test('toggle',async function(assert){assert.expect(4);class Parent extends Component{}
Object.assign(Parent,{env:makeTestEnvironment(),template:xml`
                    <div>
                        <Popover>
                            <button id="open">Open</button>
                            <t t-set="opened">
                                Opened!
                            </t>
                        </Popover>
                    </div>
                `,});const parent=new Parent();const fixture=testUtils.prepareTarget();await parent.mount(fixture);const body=document.querySelector('body');assert.containsOnce(body,'#open');assert.containsNone(body,'.o_popover');await testUtils.dom.click('#open');assert.containsOnce(body,'.o_popover');await testUtils.dom.click('#open');assert.containsNone(body,'.o_popover');parent.destroy();});QUnit.test('close event',async function(assert){assert.expect(7);class Content extends Component{}
Content.template=xml`
                <button id="close" t-on-click="trigger('o-popover-close')">
                    Close
                </button>
            `;class Parent extends Component{}
Object.assign(Parent,{components:{Content},env:makeTestEnvironment(),template:xml`
                    <div>
                        <Popover>
                            <button id="open">Open</button>
                            <t t-set="opened">
                                <Content/>
                            </t>
                        </Popover>
                    </div>
                `,});const parent=new Parent();const fixture=testUtils.prepareTarget();await parent.mount(fixture);const body=document.querySelector('body');assert.containsOnce(body,'#open');assert.containsNone(body,'.o_popover');assert.containsNone(body,'#close');await testUtils.dom.click('#open');assert.containsOnce(body,'.o_popover');assert.containsOnce(body,'#close');await testUtils.dom.click('#close');assert.containsNone(body,'.o_popover');assert.containsNone(body,'#close');parent.destroy();});});});;

/* /web/static/tests/core/dom_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.dom_tests',function(require){"use strict";var dom=require('web.dom');var testUtils=require('web.test_utils');function prepareAutoresizeTextArea(options){options=options||{};var $textarea=$('<textarea>');$textarea.css('box-sizing','border-box');$textarea.css({padding:options.padding||0,borderTopWidth:options.borderTopWidth||0,borderBottomWidth:options.borderBottomWidth||0,});$textarea.appendTo($('#qunit-fixture'));dom.autoresize($textarea,{min_height:1});return $textarea;}
QUnit.module('core',{},function(){QUnit.module('dom',{},function(){QUnit.module('autoresize',{afterEach:function(){$('#qunit-fixture').find('textarea').remove();},});QUnit.test('autoresize (border-box): no padding + no border',function(assert){assert.expect(3);var $textarea=prepareAutoresizeTextArea();assert.strictEqual($('textarea').length,2,"there should be two textareas in the DOM");$textarea=$('textarea:eq(0)');var $fixedTextarea=$('textarea:eq(1)');assert.strictEqual($textarea.css('height'),$fixedTextarea[0].scrollHeight+'px',"autoresized textarea should have height of fixed textarea + padding (0 line)");testUtils.fields.editInput($textarea,'a\nb\nc\nd');assert.strictEqual($textarea.css('height'),$fixedTextarea[0].scrollHeight+'px',"autoresized textarea should have height of fixed textarea + padding (4 lines)");});QUnit.test('autoresize (border-box): padding + no border',function(assert){assert.expect(3);var $textarea=prepareAutoresizeTextArea({padding:10});assert.strictEqual($('textarea').length,2,"there should be two textareas in the DOM");$textarea=$('textarea:eq(0)');var $fixedTextarea=$('textarea:eq(1)');var expectedTextAreaHeight=$fixedTextarea[0].scrollHeight+2*10;assert.strictEqual($textarea.css('height'),expectedTextAreaHeight+'px',"autoresized textarea should have height of fixed textarea + padding (0 line)");testUtils.fields.editInput($textarea,'a\nb\nc\nd');expectedTextAreaHeight=$fixedTextarea[0].scrollHeight+2*10;assert.strictEqual($textarea.css('height'),expectedTextAreaHeight+'px',"autoresized textarea should have height of fixed textarea + padding (4 lines)");});QUnit.test('autoresize (border-box): no padding + border',function(assert){assert.expect(3);var $textarea=prepareAutoresizeTextArea({borderTopWidth:2,borderBottomWidth:3,});assert.strictEqual($('textarea').length,2,"there should be two textareas in the DOM");$textarea=$('textarea:eq(0)');var $fixedTextarea=$('textarea:eq(1)');var expectedTextAreaHeight=$fixedTextarea[0].scrollHeight+(2+3);assert.strictEqual($textarea.css('height'),expectedTextAreaHeight+'px',"autoresized textarea should have height of fixed textarea + border (0 line)");testUtils.fields.editInput($textarea,'a\nb\nc\nd');expectedTextAreaHeight=$fixedTextarea[0].scrollHeight+(2+3);assert.strictEqual($textarea.css('height'),expectedTextAreaHeight+'px',"autoresized textarea should have height of fixed textarea + border (4 lines)");});QUnit.test('autoresize (border-box): padding + border',function(assert){assert.expect(3);var $textarea=prepareAutoresizeTextArea({padding:10,borderTopWidth:2,borderBottomWidth:3,});assert.strictEqual($('textarea').length,2,"there should be two textareas in the DOM");$textarea=$('textarea:eq(0)');var $fixedTextarea=$('textarea:eq(1)');var expectedTextAreaHeight=$fixedTextarea[0].scrollHeight+(2*10+2+3);assert.strictEqual($textarea.css('height'),expectedTextAreaHeight+'px',"autoresized textarea should have height of fixed textarea + border (0 line)");testUtils.fields.editInput($textarea,'a\nb\nc\nd');expectedTextAreaHeight=$fixedTextarea[0].scrollHeight+(2*10+2+3);assert.strictEqual($textarea.css('height'),expectedTextAreaHeight+'px',"autoresized textarea should have height of fixed textarea + border (4 lines)");});});});});;

/* /web/static/tests/chrome/action_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.action_manager_tests',function(require){"use strict";var ActionManager=require('web.ActionManager');var ReportClientAction=require('report.client_action');var Notification=require('web.Notification');var NotificationService=require('web.NotificationService');var AbstractAction=require('web.AbstractAction');var AbstractStorageService=require('web.AbstractStorageService');var BasicFields=require('web.basic_fields');var core=require('web.core');var ListController=require('web.ListController');var StandaloneFieldManagerMixin=require('web.StandaloneFieldManagerMixin');var RamStorage=require('web.RamStorage');var ReportService=require('web.ReportService');var SessionStorageService=require('web.SessionStorageService');var testUtils=require('web.test_utils');var WarningDialog=require('web.CrashManager').WarningDialog;var Widget=require('web.Widget');var createActionManager=testUtils.createActionManager;const cpHelpers=testUtils.controlPanel;const{xml}=owl.tags;QUnit.module('ActionManager',{beforeEach:function(){this.data={partner:{fields:{foo:{string:"Foo",type:"char"},bar:{string:"Bar",type:"many2one",relation:'partner'},o2m:{string:"One2Many",type:"one2many",relation:'partner',relation_field:'bar'},},records:[{id:1,display_name:"First record",foo:"yop",bar:2,o2m:[2,3]},{id:2,display_name:"Second record",foo:"blip",bar:1,o2m:[1,4,5]},{id:3,display_name:"Third record",foo:"gnap",bar:1,o2m:[]},{id:4,display_name:"Fourth record",foo:"plop",bar:2,o2m:[]},{id:5,display_name:"Fifth record",foo:"zoup",bar:2,o2m:[]},],},pony:{fields:{name:{string:'Name',type:'char'},},records:[{id:4,name:'Twilight Sparkle'},{id:6,name:'Applejack'},{id:9,name:'Fluttershy'}],},};this.actions=[{id:1,name:'Partners Action 1',res_model:'partner',type:'ir.actions.act_window',views:[[1,'kanban']],},{id:2,type:'ir.actions.server',},{id:3,name:'Partners',res_model:'partner',type:'ir.actions.act_window',views:[[false,'list'],[1,'kanban'],[false,'form']],},{id:4,name:'Partners Action 4',res_model:'partner',type:'ir.actions.act_window',views:[[1,'kanban'],[2,'list'],[false,'form']],},{id:5,name:'Create a Partner',res_model:'partner',target:'new',type:'ir.actions.act_window',views:[[false,'form']],},{id:6,name:'Partner',res_id:2,res_model:'partner',target:'inline',type:'ir.actions.act_window',views:[[false,'form']],},{id:7,name:"Some Report",report_name:'some_report',report_type:'qweb-pdf',type:'ir.actions.report',},{id:8,name:'Favorite Ponies',res_model:'pony',type:'ir.actions.act_window',views:[[false,'list'],[false,'form']],},{id:9,name:'A Client Action',tag:'ClientAction',type:'ir.actions.client',},{id:10,type:'ir.actions.act_window_close',},{id:11,name:"Another Report",report_name:'another_report',report_type:'qweb-pdf',type:'ir.actions.report',close_on_report_download:true,},{id:12,name:"Some HTML Report",report_name:'some_report',report_type:'qweb-html',type:'ir.actions.report',}];this.archs={'partner,1,kanban':'<kanban><templates><t t-name="kanban-box">'+'<div class="oe_kanban_global_click"><field name="foo"/></div>'+'</t></templates></kanban>','partner,false,list':'<tree><field name="foo"/></tree>','partner,2,list':'<tree limit="3"><field name="foo"/></tree>','pony,false,list':'<tree><field name="name"/></tree>','partner,false,form':'<form>'+'<header>'+'<button name="object" string="Call method" type="object"/>'+'<button name="4" string="Execute action" type="action"/>'+'</header>'+'<group>'+'<field name="display_name"/>'+'<field name="foo"/>'+'</group>'+'</form>','pony,false,form':'<form>'+'<field name="name"/>'+'</form>','partner,false,search':'<search><field name="foo" string="Foo"/></search>','partner,1,search':'<search>'+'<filter name="bar" help="Bar" domain="[(\'bar\', \'=\', 1)]"/>'+'</search>','pony,false,search':'<search></search>',};},},function(){QUnit.module('Misc');QUnit.test('breadcrumbs and actions with target inline',async function(assert){assert.expect(3);this.actions[3].views=[[false,'form']];this.actions[3].target='inline';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(4);assert.ok(!$('.o_control_panel').is(':visible'),"control panel should not be visible");await actionManager.doAction(1,{clear_breadcrumbs:true});assert.ok($('.o_control_panel').is(':visible'),"control panel should now be visible");assert.strictEqual($('.o_control_panel .breadcrumb').text(),"Partners Action 1","should have only one current action visible in breadcrumbs");actionManager.destroy();});QUnit.test('no widget memory leaks when doing some action stuff',async function(assert){assert.expect(1);var delta=0;testUtils.mock.patch(Widget,{init:function(){delta++;this._super.apply(this,arguments);},destroy:function(){delta--;this._super.apply(this,arguments);},});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(8);var n=delta;await actionManager.doAction(4);await cpHelpers.switchView(actionManager,'list');await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));await testUtils.dom.click($('.o_control_panel .breadcrumb a:first'));assert.strictEqual(delta,n,"should have properly destroyed all other widgets");actionManager.destroy();testUtils.mock.unpatch(Widget);});QUnit.test('no widget memory leaks when executing actions in dialog',async function(assert){assert.expect(1);var delta=0;testUtils.mock.patch(Widget,{init:function(){delta++;this._super.apply(this,arguments);},destroy:function(){if(!this.isDestroyed()){delta--;}
this._super.apply(this,arguments);},});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});var n=delta;await actionManager.doAction(5);await actionManager.doAction({type:'ir.actions.act_window_close'});assert.strictEqual(delta,n,"should have properly destroyed all widgets");actionManager.destroy();testUtils.mock.unpatch(Widget);});QUnit.test('no memory leaks when executing an action while switching view',async function(assert){assert.expect(1);var def;var delta=0;testUtils.mock.patch(Widget,{init:function(){delta+=1;this._super.apply(this,arguments);},destroy:function(){delta-=1;this._super.apply(this,arguments);},});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read'){return Promise.resolve(def).then(_.constant(result));}
return result;},});await actionManager.doAction(4);var n=delta;await actionManager.doAction(3,{clear_breadcrumbs:true});def=testUtils.makeTestPromise();await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));await actionManager.doAction(4,{clear_breadcrumbs:true});def.resolve();await testUtils.nextTick();assert.strictEqual(n,delta,"all widgets of action 3 should have been destroyed");actionManager.destroy();testUtils.mock.unpatch(Widget);});QUnit.test('no memory leaks when executing an action while loading views',async function(assert){assert.expect(1);var def;var delta=0;testUtils.mock.patch(Widget,{init:function(){delta+=1;this._super.apply(this,arguments);},destroy:function(){delta-=1;this._super.apply(this,arguments);},});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='load_views'){return Promise.resolve(def).then(_.constant(result));}
return result;},});await actionManager.doAction(4);var n=delta;def=testUtils.makeTestPromise();actionManager.doAction(3,{clear_breadcrumbs:true});actionManager.doAction(4,{clear_breadcrumbs:true});def.resolve();await testUtils.nextTick();assert.strictEqual(n,delta,"all widgets of action 3 should have been destroyed");actionManager.destroy();testUtils.mock.unpatch(Widget);});QUnit.test('no memory leaks when executing an action while loading data of default view',async function(assert){assert.expect(1);var def;var delta=0;testUtils.mock.patch(Widget,{init:function(){delta+=1;this._super.apply(this,arguments);},destroy:function(){delta-=1;this._super.apply(this,arguments);},});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route){var result=this._super.apply(this,arguments);if(route==='/web/dataset/search_read'){return Promise.resolve(def).then(_.constant(result));}
return result;},});await actionManager.doAction(4);var n=delta;def=testUtils.makeTestPromise();actionManager.doAction(3,{clear_breadcrumbs:true});actionManager.doAction(4,{clear_breadcrumbs:true});def.resolve();await testUtils.nextTick();assert.strictEqual(n,delta,"all widgets of action 3 should have been destroyed");actionManager.destroy();testUtils.mock.unpatch(Widget);});QUnit.test('action with "no_breadcrumbs" set to true',async function(assert){assert.expect(2);_.findWhere(this.actions,{id:4}).context={no_breadcrumbs:true};var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");await actionManager.doAction(4);assert.strictEqual($('.o_control_panel .breadcrumb-item').length,0,"the breadcrumbs should be empty");actionManager.destroy();});QUnit.test('on_reverse_breadcrumb handler is correctly called',async function(assert){assert.expect(3);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));await actionManager.doAction(4);await testUtils.dom.click($('.o_control_panel .breadcrumb a:first'));assert.verifySteps([]);await actionManager.doAction(4,{on_reverse_breadcrumb:function(){assert.step('on_reverse_breadcrumb');}});await testUtils.dom.click($('.o_control_panel .breadcrumb a:first'));assert.verifySteps(['on_reverse_breadcrumb']);actionManager.destroy();});QUnit.test('handles "history_back" event',async function(assert){assert.expect(2);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(4);await actionManager.doAction(3);actionManager.trigger_up('history_back');await testUtils.nextTick();assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners Action 4',"breadcrumbs should display the display_name of the action");actionManager.destroy();});QUnit.test('stores and restores scroll position',async function(assert){assert.expect(7);var left;var top;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{getScrollPosition:function(ev){assert.step('getScrollPosition');ev.data.callback({left:left,top:top});},scrollTo:function(ev){assert.step('scrollTo left '+ev.data.left+', top '+ev.data.top);},},});assert.step('execute action 3');await actionManager.doAction(3);left=50;top=100;assert.step('execute action 4');await actionManager.doAction(4);assert.step('go back to action 3');await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.verifySteps(['execute action 3','execute action 4','getScrollPosition','go back to action 3','getScrollPosition','scrollTo left 50, top 100',]);actionManager.destroy();});QUnit.test('executing an action with target != "new" closes all dialogs',async function(assert){assert.expect(4);this.archs['partner,false,form']='<form>'+'<field name="o2m">'+'<tree><field name="foo"/></tree>'+'<form><field name="foo"/></form>'+'</field>'+'</form>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_view');await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_form_view');await testUtils.dom.click(actionManager.$('.o_form_view .o_data_row:first'));assert.containsOnce(document.body,'.modal .o_form_view');await actionManager.doAction(1);assert.containsNone(document.body,'.modal');actionManager.destroy();});QUnit.test('executing an action with target "new" does not close dialogs',async function(assert){assert.expect(4);this.archs['partner,false,form']='<form>'+'<field name="o2m">'+'<tree><field name="foo"/></tree>'+'<form><field name="foo"/></form>'+'</field>'+'</form>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_view');await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_form_view');await testUtils.dom.click(actionManager.$('.o_form_view .o_data_row:first'));assert.containsOnce(document.body,'.modal .o_form_view');await actionManager.doAction(5);assert.containsN(document.body,'.modal .o_form_view',2);actionManager.destroy();});QUnit.test('executing a window action with onchange warning does not hide it',async function(assert){assert.expect(2);this.archs['partner,false,form']=`
            <form>
              <field name="foo"/>
            </form>`;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(args.method==='onchange'){return Promise.resolve({value:{},warning:{title:"Warning",message:"Everything is alright",type:'dialog',},});}
return this._super.apply(this,arguments);},intercepts:{warning:function(event){new WarningDialog(actionManager,{title:event.data.title,},event.data).open();},},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_button_add'));assert.containsOnce($,'.modal.o_technical_modal.show',"Warning modal should be opened");await testUtils.dom.click($('.modal.o_technical_modal.show button.close'));assert.containsNone($,'.modal.o_technical_modal.show',"Warning modal should be closed");actionManager.destroy();});QUnit.module('Push State');QUnit.test('properly push state',async function(assert){assert.expect(3);var stateDescriptions=[{action:4,model:"partner",title:"Partners Action 4",view_type:"kanban"},{action:8,model:"pony",title:"Favorite Ponies",view_type:"list"},{action:8,id:4,model:"pony",title:"Twilight Sparkle",view_type:"form"},];var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{push_state:function(event){var descr=stateDescriptions.shift();assert.deepEqual(_.extend({},event.data.state),descr,"should notify the environment of new state");},},});await actionManager.doAction(4);await actionManager.doAction(8);await testUtils.dom.click(actionManager.$('tr.o_data_row:first'));actionManager.destroy();});QUnit.test('push state after action is loaded, not before',async function(assert){assert.expect(5);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{push_state:function(){assert.step('push_state');},},mockRPC:function(route){assert.step(route);return this._super.apply(this,arguments);},});await actionManager.doAction(4);assert.verifySteps(['/web/action/load','/web/dataset/call_kw/partner','/web/dataset/search_read','push_state']);actionManager.destroy();});QUnit.test('do not push state for actions in target=new',async function(assert){assert.expect(3);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{push_state:function(){assert.step('push_state');},},});await actionManager.doAction(4);assert.verifySteps(['push_state']);await actionManager.doAction(5);assert.verifySteps([]);actionManager.destroy();});QUnit.test('do not push state when action fails',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{push_state:function(){assert.step('push_state');},},mockRPC:function(route,args){if(args.method==='read'){return Promise.reject();}
return this._super.apply(this,arguments);},});await actionManager.doAction(8);assert.verifySteps(['push_state']);await testUtils.dom.click(actionManager.$('tr.o_data_row:first'));assert.verifySteps([]);assert.containsOnce(actionManager,'.o_list_view',"there should still be a list view in dom");actionManager.destroy();});QUnit.module('Load State');QUnit.test('should not crash on invalid state',async function(assert){assert.expect(2);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.loadState({res_model:'partner',});assert.strictEqual(actionManager.$el.text(),'',"should display nothing");assert.verifySteps([]);actionManager.destroy();});QUnit.test('properly load client actions',async function(assert){assert.expect(2);var ClientAction=AbstractAction.extend({start:function(){this.$el.text('Hello World');this.$el.addClass('o_client_action_test');},});core.action_registry.add('HelloWorldTest',ClientAction);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.loadState({action:'HelloWorldTest',});assert.strictEqual(actionManager.$('.o_client_action_test').text(),'Hello World',"should have correctly rendered the client action");assert.verifySteps([]);actionManager.destroy();delete core.action_registry.map.HelloWorldTest;});QUnit.test('properly load act window actions',async function(assert){assert.expect(6);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.loadState({action:1,});assert.strictEqual($('.o_control_panel').length,1,"should have rendered a control panel");assert.containsOnce(actionManager,'.o_kanban_view',"should have rendered a kanban view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('properly load records',async function(assert){assert.expect(5);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.loadState({id:2,model:'partner',});assert.containsOnce(actionManager,'.o_form_view',"should have rendered a form view");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Second record',"should have opened the second record");assert.verifySteps(['load_views','read',]);actionManager.destroy();});QUnit.test('properly load default record',async function(assert){assert.expect(5);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.loadState({action:3,id:"",model:'partner',view_type:'form',});assert.containsOnce(actionManager,'.o_form_view',"should have rendered a form view");assert.verifySteps(['/web/action/load','load_views','onchange',]);actionManager.destroy();});QUnit.test('load requested view for act window actions',async function(assert){assert.expect(6);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.loadState({action:3,view_type:'kanban',});assert.containsNone(actionManager,'.o_list_view',"should not have rendered a list view");assert.containsOnce(actionManager,'.o_kanban_view',"should have rendered a kanban view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('lazy load multi record view if mono record one is requested',async function(assert){assert.expect(11);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.loadState({action:3,id:2,view_type:'form',});assert.containsNone(actionManager,'.o_list_view',"should not have rendered a list view");assert.containsOnce(actionManager,'.o_form_view',"should have rendered a form view");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Second record',"breadcrumbs should contain the display_name of the opened record");await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.containsOnce(actionManager,'.o_list_view',"should now display the list view");assert.containsNone(actionManager,'.o_form_view',"should not display the form view anymore");assert.verifySteps(['/web/action/load','load_views','read','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('lazy load multi record view with previous action',async function(assert){assert.expect(6);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(4);assert.strictEqual($('.o_control_panel .breadcrumb li').length,1,"there should be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb li').text(),'Partners Action 4',"breadcrumbs should contain the display_name of the opened record");await actionManager.doAction(3,{resID:2,viewType:'form',});assert.strictEqual($('.o_control_panel .breadcrumb li').length,3,"there should be three controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb li').text(),'Partners Action 4PartnersSecond record',"the breadcrumb elements should be correctly ordered");await testUtils.dom.click($('.o_control_panel .breadcrumb a:last'));assert.strictEqual($('.o_control_panel .breadcrumb li').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb li').text(),'Partners Action 4Partners',"the breadcrumb elements should be correctly ordered");actionManager.destroy();});QUnit.test('lazy loaded multi record view with failing mono record one',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(args.method==='read'){return Promise.reject();}
return this._super.apply(this,arguments);},});await actionManager.loadState({action:3,id:2,view_type:'form',}).then(function(){assert.ok(false,'should not resolve the deferred');}).catch(function(){assert.ok(true,'should reject the deferred');});assert.containsNone(actionManager,'.o_form_view');assert.containsNone(actionManager,'.o_list_view');await actionManager.doAction(1);assert.containsOnce(actionManager,'.o_kanban_view');actionManager.destroy();});QUnit.test('change the viewType of the current action',async function(assert){assert.expect(13);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_view',"should have rendered a list view");await actionManager.loadState({action:3,view_type:'kanban',});assert.containsNone(actionManager,'.o_list_view',"should not display the list view anymore");assert.containsOnce(actionManager,'.o_kanban_view',"should have switched to the kanban view");await actionManager.loadState({action:3,id:4,view_type:'form',});assert.containsNone(actionManager,'.o_kanban_view',"should not display the kanban view anymore");assert.containsOnce(actionManager,'.o_form_view',"should have switched to the form view");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Fourth record',"should have opened the requested record");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','/web/dataset/search_read','read',]);actionManager.destroy();});QUnit.test('change the id of the current action',async function(assert){assert.expect(11);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_form_view',"should have rendered a form view");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'First record',"should have opened the first record");await actionManager.loadState({action:3,id:4,view_type:'form',});assert.containsOnce(actionManager,'.o_form_view',"should still display the form view");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Fourth record',"should have switched to the requested record");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','read','read',]);actionManager.destroy();});QUnit.test('should not push a loaded state',async function(assert){assert.expect(3);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{push_state:function(){assert.step('push_state');},},});await actionManager.loadState({action:3});assert.verifySteps([],"should not push the loaded state");await testUtils.dom.click(actionManager.$('tr.o_data_row:first'));assert.verifySteps(['push_state'],"should push the state of it changes afterwards");actionManager.destroy();});QUnit.test('should not push a loaded state of a client action',async function(assert){assert.expect(4);var ClientAction=AbstractAction.extend({init:function(parent,action,options){this._super.apply(this,arguments);this.controllerID=options.controllerID;},start:function(){var self=this;var $button=$('<button>').text('Click Me!');$button.on('click',function(){self.trigger_up('push_state',{controllerID:self.controllerID,state:{someValue:'X'},});});this.$el.append($button);return this._super.apply(this,arguments);},});core.action_registry.add('ClientAction',ClientAction);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{push_state:function(ev){assert.step('push_state');assert.deepEqual(ev.data.state,{action:9,someValue:'X',title:'A Client Action',});},},});await actionManager.loadState({action:9});assert.verifySteps([],"should not push the loaded state");await testUtils.dom.click(actionManager.$('button'));assert.verifySteps(['push_state'],"should push the state of it changes afterwards");actionManager.destroy();});QUnit.test('change a param of an ir.actions.client in the url',async function(assert){assert.expect(7);var ClientAction=AbstractAction.extend({hasControlPanel:true,init:function(parent,action){this._super.apply(this,arguments);var context=action.context;this.a=context.params&&context.params.a||'default value';},start:function(){assert.step('start');this.$('.o_content').text(this.a);this.$el.addClass('o_client_action');this.trigger_up('push_state',{controllerID:this.controllerID,state:{a:this.a},});return this._super.apply(this,arguments);},});core.action_registry.add('ClientAction',ClientAction);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(9);assert.strictEqual(actionManager.$('.o_client_action .o_content').text(),'default value',"should have rendered the client action");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");await actionManager.loadState({action:9,a:'new value',});assert.strictEqual(actionManager.$('.o_client_action .o_content').text(),'new value',"should have rerendered the client action with the correct param");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should still be one controller in the breadcrumbs");assert.verifySteps(['start','start']);actionManager.destroy();delete core.action_registry.map.ClientAction;});QUnit.test('load a window action without id (in a multi-record view)',async function(assert){assert.expect(14);var RamStorageService=AbstractStorageService.extend({storage:new RamStorage(),});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{session_storage:RamStorageService,},mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});testUtils.mock.intercept(actionManager,'call_service',function(ev){if(ev.data.service==='session_storage'){assert.step(ev.data.method);}},true);await actionManager.doAction(4);assert.containsOnce(actionManager,'.o_kanban_view',"should display a kanban view");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners Action 4',"breadcrumbs should display the display_name of the action");await actionManager.loadState({model:'partner',view_type:'list',});assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners Action 4',"should still be in the same action");assert.containsNone(actionManager,'.o_kanban_view',"should no longer display a kanban view");assert.containsOnce(actionManager,'.o_list_view',"should display a list view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','setItem','getItem','load_views','/web/dataset/search_read','setItem',]);actionManager.destroy();});QUnit.module('Concurrency management');QUnit.test('drop previous actions if possible',async function(assert){assert.expect(6);var def=testUtils.makeTestPromise();var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route){var result=this._super.apply(this,arguments);assert.step(route);if(route==='/web/action/load'){return def.then(_.constant(result));}
return result;},});actionManager.doAction(4);actionManager.doAction(8);def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_list_view','there should be a list view in DOM');assert.verifySteps(['/web/action/load','/web/action/load','/web/dataset/call_kw/pony','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('handle switching view and switching back on slow network',async function(assert){assert.expect(8);var def=testUtils.makeTestPromise();var defs=[Promise.resolve(),def,Promise.resolve()];var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route){assert.step(route);var result=this._super.apply(this,arguments);if(route==='/web/dataset/search_read'){var def=defs.shift();return def.then(_.constant(result));}
return result;},});await actionManager.doAction(4);await cpHelpers.switchView(actionManager,'list');await cpHelpers.switchView(actionManager,'kanban');assert.verifySteps(["/web/action/load","/web/dataset/call_kw/partner","/web/dataset/search_read","/web/dataset/search_read","/web/dataset/search_read"]);def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_kanban_view',"there should be a kanban view in dom");assert.containsNone(actionManager,'.o_list_view',"there should not be a list view in dom");actionManager.destroy();});QUnit.test('when an server action takes too much time...',async function(assert){assert.expect(1);var def=testUtils.makeTestPromise();var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route){if(route==='/web/action/run'){return def.then(_.constant(1));}
return this._super.apply(this,arguments);},});actionManager.doAction(2);actionManager.doAction(4);def.resolve();await testUtils.nextTick();assert.strictEqual($('.o_control_panel .breadcrumb-item.active').text(),'Partners Action 4','action 4 should be loaded');actionManager.destroy();});QUnit.test('clicking quickly on breadcrumbs...',async function(assert){assert.expect(1);var def=Promise.resolve();var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read'){return def.then(_.constant(result));}
return result;},});await actionManager.doAction(4);await testUtils.dom.click(actionManager.$('.o_kanban_record:first'));actionManager.doAction(8);def=testUtils.makeTestPromise();await testUtils.nextTick();await testUtils.dom.click($('.o_control_panel .breadcrumb-item:eq(1)'));await testUtils.dom.click($('.o_control_panel .breadcrumb-item:eq(0)'));def.resolve();await testUtils.nextTick();assert.strictEqual($('.o_control_panel .breadcrumb-item.active').text(),'Partners Action 4','action 4 should be loaded and visible');actionManager.destroy();});QUnit.test('execute a new action while loading a lazy-loaded controller',async function(assert){assert.expect(15);var def;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);assert.step(args.method||route);if(route==='/web/dataset/search_read'&&args.model==='partner'){return Promise.resolve(def).then(_.constant(result));}
return result;},});await actionManager.loadState({action:4,id:2,view_type:'form',});assert.containsOnce(actionManager,'.o_form_view',"should display the form view of action 4");def=testUtils.makeTestPromise();await testUtils.nextTick();await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.containsOnce(actionManager,'.o_form_view',"should still display the form view of action 4");await actionManager.doAction(8,{clear_breadcrumbs:true});assert.containsOnce(actionManager,'.o_list_view',"should display action 8");assert.containsNone(actionManager,'.o_form_view',"should no longer display the form view");assert.verifySteps(['/web/action/load','load_views','read','/web/dataset/search_read','/web/action/load','load_views','/web/dataset/search_read',]);def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_list_view',"should still display action 8");assert.containsNone(actionManager,'.o_kanban_view',"should not display the kanban view of action 4");assert.verifySteps([]);actionManager.destroy();});QUnit.test('execute a new action while handling a call_button',async function(assert){assert.expect(16);var self=this;var def=testUtils.makeTestPromise();var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);if(route==='/web/dataset/call_button'){return def.then(_.constant(self.actions[0]));}
return this._super.apply(this,arguments);},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_form_view',"should display the form view of action 3");await testUtils.dom.click(actionManager.$('.o_form_view button:contains(Call method)'));assert.containsOnce(actionManager,'.o_form_view',"should still display the form view of action 3");await actionManager.doAction(8,{clear_breadcrumbs:true});assert.containsOnce(actionManager,'.o_list_view',"should display the list view of action 8");assert.containsNone(actionManager,'.o_form_view',"should no longer display the form view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','read','object','/web/action/load','load_views','/web/dataset/search_read',]);def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_list_view',"should still display the list view of action 8");assert.containsNone(actionManager,'.o_kanban_view',"should not display action 1");assert.verifySteps([]);actionManager.destroy();});QUnit.test('execute a new action while switching to another controller',async function(assert){assert.expect(15);var def;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);if(args.method==='read'){assert.ok(true,"A 'read' should have been done. Check test's comment though.");return Promise.resolve(def).then(_.constant(result));}
assert.step(args.method||route);return result;},});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_view',"should display the list view of action 3");def=testUtils.makeTestPromise();await testUtils.nextTick();testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_list_view',"should still display the list view of action 3");await actionManager.doAction(4,{clear_breadcrumbs:true});assert.containsOnce(actionManager,'.o_kanban_view',"should display the kanban view of action 8");assert.containsNone(actionManager,'.o_list_view',"should no longer display the list view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','/web/action/load','load_views','/web/dataset/search_read',]);def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_kanban_view',"should still display the kanban view of action 8");assert.containsNone(actionManager,'.o_form_view',"should not display the form view of action 3");assert.verifySteps([]);actionManager.destroy();});QUnit.test('execute a new action while loading views',async function(assert){assert.expect(10);var def;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);assert.step(args.method||route);if(args.method==='load_views'){return Promise.resolve(def).then(_.constant(result));}
return result;},});def=testUtils.makeTestPromise();actionManager.doAction(3);assert.containsNone(actionManager,'.o_list_view',"should not display the list view of action 3");await testUtils.nextTick();actionManager.doAction(4);def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_kanban_view',"should display the kanban view of action 4");assert.containsNone(actionManager,'.o_list_view',"should not display the list view of action 3");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.verifySteps(['/web/action/load','load_views','/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('execute a new action while loading data of default view',async function(assert){assert.expect(11);var def;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var result=this._super.apply(this,arguments);assert.step(args.method||route);if(route==='/web/dataset/search_read'){return Promise.resolve(def).then(_.constant(result));}
return result;},});def=testUtils.makeTestPromise();actionManager.doAction(3);assert.containsNone(actionManager,'.o_list_view',"should not display the list view of action 3");await testUtils.nextTick();actionManager.doAction(4);def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_kanban_view',"should display the kanban view of action 4");assert.containsNone(actionManager,'.o_list_view',"should not display the list view of action 3");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('open a record while reloading the list view',async function(assert){assert.expect(12);var def;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route){var result=this._super.apply(this,arguments);if(route==='/web/dataset/search_read'){return Promise.resolve(def).then(_.constant(result));}
return result;},});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_view',"should display the list view");assert.containsN(actionManager,'.o_list_view .o_data_row',5,"list view should contain 5 records");assert.strictEqual($('.o_control_panel .o_list_buttons').length,1,"list view buttons should be displayed in control panel");def=testUtils.makeTestPromise();await testUtils.nextTick();await cpHelpers.switchView(actionManager,'list');assert.containsN(actionManager,'.o_list_view .o_data_row',5,"list view should still contain 5 records");assert.strictEqual($('.o_control_panel .o_list_buttons').length,1,"list view buttons should still be displayed in control panel");await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_form_view',"should display the form view");assert.strictEqual($('.o_control_panel .o_list_buttons').length,0,"list view buttons should no longer be displayed in control panel");assert.strictEqual($('.o_control_panel .o_form_buttons_view').length,1,"form view buttons should be displayed instead");def.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_form_view',"should display the form view");assert.containsNone(actionManager,'.o_list_view',"should not display the list view");assert.strictEqual($('.o_control_panel .o_list_buttons').length,0,"list view buttons should still not be displayed in control panel");assert.strictEqual($('.o_control_panel .o_form_buttons_view').length,1,"form view buttons should still be displayed instead");actionManager.destroy();});QUnit.module('Client Actions');QUnit.test('can execute client actions from tag name',async function(assert){assert.expect(3);var ClientAction=AbstractAction.extend({start:function(){this.$el.text('Hello World');this.$el.addClass('o_client_action_test');},});core.action_registry.add('HelloWorldTest',ClientAction);var actionManager=await createActionManager({mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);}});await actionManager.doAction('HelloWorldTest');assert.strictEqual($('.o_control_panel:visible').length,0,"shouldn't have rendered a control panel");assert.strictEqual(actionManager.$('.o_client_action_test').text(),'Hello World',"should have correctly rendered the client action");assert.verifySteps([]);actionManager.destroy();delete core.action_registry.map.HelloWorldTest;});QUnit.test('client action with control panel',async function(assert){assert.expect(4);var ClientAction=AbstractAction.extend({hasControlPanel:true,start:async function(){this.$('.o_content').text('Hello World');this.$el.addClass('o_client_action_test');this.controlPanelProps.title='Hello';await this._super.apply(this,arguments);},});core.action_registry.add('HelloWorldTest',ClientAction);var actionManager=await createActionManager();await actionManager.doAction('HelloWorldTest');assert.strictEqual($('.o_control_panel:visible').length,1,"should have rendered a control panel");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Hello',"breadcrumbs should still display the title of the controller");assert.strictEqual(actionManager.$('.o_client_action_test .o_content').text(),'Hello World',"should have correctly rendered the client action");actionManager.destroy();delete core.action_registry.map.HelloWorldTest;});QUnit.test('state is pushed for client actions',async function(assert){assert.expect(3);const ClientAction=AbstractAction.extend({getTitle:function(){return'a title';},getState:function(){return{foo:'baz'};}});const actionManager=await createActionManager({intercepts:{push_state:function(ev){const expectedState={action:'HelloWorldTest',foo:'baz',title:'a title'};assert.deepEqual(ev.data.state,expectedState,"should include a complete state description, including custom state");assert.step('push state');},},});core.action_registry.add('HelloWorldTest',ClientAction);await actionManager.doAction('HelloWorldTest');assert.verifySteps(['push state']);actionManager.destroy();delete core.action_registry.map.HelloWorldTest;});QUnit.test('action can use a custom control panel',async function(assert){assert.expect(1);class CustomControlPanel extends owl.Component{}
CustomControlPanel.template=xml`
            <div class="custom-control-panel">My custom control panel</div>
        `
const ClientAction=AbstractAction.extend({hasControlPanel:true,config:{ControlPanel:CustomControlPanel},});const actionManager=await createActionManager();core.action_registry.add('HelloWorldTest',ClientAction);await actionManager.doAction('HelloWorldTest');assert.containsOnce(actionManager,'.custom-control-panel',"should have a custom control panel");actionManager.destroy();delete core.action_registry.map.HelloWorldTest;});QUnit.test('breadcrumb is updated on title change',async function(assert){assert.expect(2);var ClientAction=AbstractAction.extend({hasControlPanel:true,events:{click:function(){this.updateControlPanel({title:'new title'});},},start:async function(){this.$('.o_content').text('Hello World');this.$el.addClass('o_client_action_test');this.controlPanelProps.title='initial title';await this._super.apply(this,arguments);},});var actionManager=await createActionManager();core.action_registry.add('HelloWorldTest',ClientAction);await actionManager.doAction('HelloWorldTest');assert.strictEqual($('ol.breadcrumb').text(),"initial title","should have initial title as breadcrumb content");await testUtils.dom.click(actionManager.$('.o_client_action_test'));assert.strictEqual($('ol.breadcrumb').text(),"new title","should have updated title as breadcrumb content");actionManager.destroy();delete core.action_registry.map.HelloWorldTest;});QUnit.test('test display_notification client action',async function(assert){assert.expect(6);testUtils.mock.patch(Notification,{_animation:false,});const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{notification:NotificationService,},});await actionManager.doAction(1);assert.containsOnce(actionManager,'.o_kanban_view');await actionManager.doAction({type:'ir.actions.client',tag:'display_notification',params:{title:'title',message:'message',sticky:true,}});const notificationSelector='.o_notification_manager .o_notification';assert.containsOnce(document.body,notificationSelector,'a notification should be present');const notificationElement=document.body.querySelector(notificationSelector);assert.strictEqual(notificationElement.querySelector('.o_notification_title').textContent,'title',"the notification should have the correct title");assert.strictEqual(notificationElement.querySelector('.o_notification_content').textContent,'message',"the notification should have the correct message");assert.containsOnce(actionManager,'.o_kanban_view');await testUtils.dom.click(notificationElement.querySelector('.o_notification_close'));assert.containsNone(document.body,notificationSelector,"the notification should be destroy ");actionManager.destroy();testUtils.mock.unpatch(Notification);});QUnit.module('Server actions');QUnit.test('can execute server actions from db ID',async function(assert){assert.expect(9);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);if(route==='/web/action/run'){assert.strictEqual(args.action_id,2,"should call the correct server action");return Promise.resolve(1);}
return this._super.apply(this,arguments);},});await actionManager.doAction(2);assert.strictEqual($('.o_control_panel:visible').length,1,"should have rendered a control panel");assert.containsOnce(actionManager,'.o_kanban_view',"should have rendered a kanban view");assert.verifySteps(['/web/action/load','/web/action/run','/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('handle server actions returning false',async function(assert){assert.expect(9);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);if(route==='/web/action/run'){return Promise.resolve(false);}
return this._super.apply(this,arguments);},});await actionManager.doAction(5,{on_close:assert.step.bind(assert,'close handler'),});assert.strictEqual($('.o_technical_modal .o_form_view').length,1,"should have rendered a form view in a modal");await actionManager.doAction(2);assert.strictEqual($('.o_technical_modal').length,0,"should have closed the modal");assert.verifySteps(['/web/action/load','load_views','onchange','/web/action/load','/web/action/run','close handler',]);actionManager.destroy();});QUnit.module('Report actions');QUnit.test('can execute report actions from db ID',async function(assert){assert.expect(5);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{report:ReportService,},mockRPC:function(route,args){assert.step(args.method||route);if(route==='/report/check_wkhtmltopdf'){return Promise.resolve('ok');}
return this._super.apply(this,arguments);},session:{get_file:async function(params){assert.step(params.url);params.success();params.complete();return true;},},});await actionManager.doAction(7,{on_close:function(){assert.step('on_close');},});await testUtils.nextTick();assert.verifySteps(['/web/action/load','/report/check_wkhtmltopdf','/report/download','on_close',]);actionManager.destroy();});QUnit.test('report actions can close modals and reload views',async function(assert){assert.expect(8);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{report:ReportService,},mockRPC:function(route,args){if(route==='/report/check_wkhtmltopdf'){return Promise.resolve('ok');}
return this._super.apply(this,arguments);},session:{get_file:async function(params){assert.step(params.url);params.success();params.complete();return true;},},});await actionManager.doAction(5,{on_close:function(){assert.step('on_close');},});assert.strictEqual($('.o_technical_modal .o_form_view').length,1,"should have rendered a form view in a modal");await actionManager.doAction(7,{on_close:function(){assert.step('on_printed');},});assert.strictEqual($('.o_technical_modal .o_form_view').length,1,"The modal should still exist");await actionManager.doAction(11);assert.strictEqual($('.o_technical_modal .o_form_view').length,0,"the modal should have been closed after the action report");assert.verifySteps(['/report/download','on_printed','/report/download','on_close',]);actionManager.destroy();});QUnit.test('should trigger a notification if wkhtmltopdf is to upgrade',async function(assert){assert.expect(5);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{report:ReportService,notification:NotificationService.extend({notify:function(params){assert.step(params.type||'notification');}}),},mockRPC:function(route,args){assert.step(args.method||route);if(route==='/report/check_wkhtmltopdf'){return Promise.resolve('upgrade');}
return this._super.apply(this,arguments);},session:{get_file:async function(params){assert.step(params.url);params.success();params.complete();return true;},},});await actionManager.doAction(7);assert.verifySteps(['/web/action/load','/report/check_wkhtmltopdf','warning','/report/download',]);actionManager.destroy();});QUnit.test('should open the report client action if wkhtmltopdf is broken',async function(assert){assert.expect(7);testUtils.mock.patch(ReportClientAction,{start:function(){var self=this;return this._super.apply(this,arguments).then(function(){self._rpc({route:self.iframe.getAttribute('src')});self.iframe.setAttribute('src','about:blank');});}});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{report:ReportService,notification:NotificationService.extend({notify:function(params){assert.step(params.type||'notification');}})},mockRPC:function(route,args){assert.step(args.method||route);if(route==='/report/check_wkhtmltopdf'){return Promise.resolve('broken');}
if(route.includes('/report/html/some_report')){return Promise.resolve();}
return this._super.apply(this,arguments);},session:{get_file:function(params){assert.step(params.url);return true;},},});await actionManager.doAction(7);assert.containsOnce(actionManager,'.o_report_iframe',"should have opened the report client action");assert.containsOnce(actionManager,'.o_cp_buttons .o_report_buttons .o_report_print');assert.verifySteps(['/web/action/load','/report/check_wkhtmltopdf','warning','/report/html/some_report?context=%7B%7D',]);actionManager.destroy();testUtils.mock.unpatch(ReportClientAction);});QUnit.test('send context in case of html report',async function(assert){assert.expect(4);testUtils.mock.patch(ReportClientAction,{start:function(){var self=this;return this._super.apply(this,arguments).then(function(){self._rpc({route:self.iframe.getAttribute('src')});self.iframe.setAttribute('src','about:blank');});}});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{report:ReportService,notification:NotificationService.extend({notify:function(params){assert.step(params.type||'notification');}})},mockRPC:function(route,args){assert.step(args.method||route);if(route.includes('/report/html/some_report')){return Promise.resolve();}
return this._super.apply(this,arguments);},session:{user_context:{some_key:2,}},});await actionManager.doAction(12);assert.containsOnce(actionManager,'.o_report_iframe',"should have opened the report client action");assert.verifySteps(['/web/action/load','/report/html/some_report?context=%7B%22some_key%22%3A2%7D',]);actionManager.destroy();testUtils.mock.unpatch(ReportClientAction);});QUnit.test('crashmanager service called on failed report download actions',async function(assert){assert.expect(1);var actionManager=await createActionManager({data:this.data,actions:this.actions,services:{report:ReportService,},mockRPC:function(route){if(route==='/report/check_wkhtmltopdf'){return Promise.resolve('ok');}
return this._super.apply(this,arguments);},session:{get_file:function(params){params.error({data:{name:'error',arguments:['could not download file'],}});params.complete();},},});try{await actionManager.doAction(11);}catch(e){assert.strictEqual(e,undefined);}
actionManager.destroy();});QUnit.module('Window Actions');QUnit.test('can execute act_window actions from db ID',async function(assert){assert.expect(6);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(1);assert.strictEqual($('.o_control_panel').length,1,"should have rendered a control panel");assert.containsOnce(actionManager,'.o_kanban_view',"should have rendered a kanban view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('sidebar is present in list view',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){var res=this._super.apply(this,arguments);if(args.method==='load_views'){assert.strictEqual(args.kwargs.options.toolbar,true,"should ask for toolbar information");return res.then(function(fieldsViews){fieldsViews.list.toolbar={print:[{name:"Print that record"}],};return fieldsViews;});}
return res;},});await actionManager.doAction(3);assert.containsNone(actionManager,'.o_cp_action_menus');await testUtils.dom.clickFirst(actionManager.$('input.custom-control-input'));assert.isVisible(actionManager.$('.o_cp_action_menus button.o_dropdown_toggler_btn:contains("Print")'));assert.isVisible(actionManager.$('.o_cp_action_menus button.o_dropdown_toggler_btn:contains("Action")'));actionManager.destroy();});QUnit.test('can switch between views',async function(assert){assert.expect(18);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_view',"should display the list view");await cpHelpers.switchView(actionManager,'kanban');assert.containsNone(actionManager,'.o_list_view',"should no longer display the list view");assert.containsOnce(actionManager,'.o_kanban_view',"should display the kanban view");await cpHelpers.switchView(actionManager,'list');assert.containsOnce(actionManager,'.o_list_view',"should display the list view");assert.containsNone(actionManager,'.o_kanban_view',"should no longer display the kanban view");await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsNone(actionManager,'.o_list_view',"should no longer display the list view");assert.containsOnce(actionManager,'.o_form_view',"should display the form view");assert.strictEqual(actionManager.$('.o_field_widget[name=foo]').text(),'yop',"should have opened the correct record");await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.containsOnce(actionManager,'.o_list_view',"should display the list view");assert.containsNone(actionManager,'.o_form_view',"should no longer display the form view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','/web/dataset/search_read','/web/dataset/search_read','read','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('orderedBy in context is not propagated when executing another action',async function(assert){assert.expect(6);this.data.partner.fields.foo.sortable=true;this.archs['partner,false,form']='<header>'+'<button name="8" string="Execute action" type="action"/>'+'</header>';var searchReadCount=1;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){if(searchReadCount===1){assert.strictEqual(args.model,'partner');assert.notOk(args.sort);}
if(searchReadCount===2){assert.strictEqual(args.model,'partner');assert.strictEqual(args.sort,"foo ASC");}
if(searchReadCount===3){assert.strictEqual(args.model,'pony');assert.notOk(args.sort);}
searchReadCount+=1;}
return this._super.apply(this,arguments);},});await actionManager.doAction(3);var searchData={domains:[[["foo","=","yop"]]],contexts:[{orderedBy:[],}],};actionManager.trigger_up('search',searchData);await testUtils.dom.click(actionManager.$('.o_list_view th.o_column_sortable'));await testUtils.dom.click(actionManager.$('.o_data_cell:first'));await testUtils.dom.click(actionManager.$('.o_form_view button'));actionManager.destroy();});QUnit.test('breadcrumbs are updated when switching between views',async function(assert){assert.expect(15);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners',"breadcrumbs should display the display_name of the action");await cpHelpers.switchView(actionManager,'kanban');assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should still be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners',"breadcrumbs should still display the display_name of the action");await testUtils.dom.click(actionManager.$('.o_kanban_view .o_kanban_record:first'));await testUtils.nextTick();assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'First record',"breadcrumbs should contain the display_name of the opened record");await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners',"breadcrumbs should display the display_name of the action");await cpHelpers.switchView(actionManager,'list');assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should still be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners',"breadcrumbs should still display the display_name of the action");await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'First record',"breadcrumbs should contain the display_name of the opened record");await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.containsOnce(actionManager,'.o_list_view',"should be back on list view");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item').text(),'Partners',"breadcrumbs should display the display_name of the action");actionManager.destroy();});QUnit.test('switch buttons are updated when switching between views',async function(assert){assert.expect(13);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.containsN(actionManager,'.o_control_panel button.o_switch_view',2,"should have two switch buttons (list and kanban)");assert.containsOnce(actionManager,'.o_control_panel button.o_switch_view.active',"should have only one active button");assert.hasClass($('.o_control_panel .o_switch_view:first'),'o_list',"list switch button should be the first one");assert.hasClass($('.o_control_panel .o_switch_view.o_list'),'active',"list should be the active view");await cpHelpers.switchView(actionManager,'kanban');assert.containsN(actionManager,'.o_control_panel .o_switch_view',2,"should still have two switch buttons (list and kanban)");assert.containsOnce(actionManager,'.o_control_panel .o_switch_view.active',"should still have only one active button");assert.hasClass($('.o_control_panel .o_switch_view:first'),'o_list',"list switch button should still be the first one");assert.hasClass($('.o_control_panel .o_switch_view.o_kanban'),'active',"kanban should now be the active view");await cpHelpers.switchView(actionManager,'list');assert.containsN(actionManager,'.o_control_panel .o_switch_view',2,"should still have two switch buttons (list and kanban)");assert.hasClass($('.o_control_panel .o_switch_view.o_list'),'active',"list should now be the active view");await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsNone(actionManager,'.o_control_panel .o_switch_view',"should not have any switch buttons");await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.containsN(actionManager,'.o_control_panel .o_switch_view',2,"should have two switch buttons (list and kanban)");assert.hasClass($('.o_control_panel .o_switch_view.o_list'),'active',"list should be the active view");actionManager.destroy();});QUnit.test('pager is updated when switching between views',async function(assert){assert.expect(10);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(4);assert.strictEqual($('.o_control_panel .o_pager_value').text(),'1-5',"value should be correct for kanban");assert.strictEqual($('.o_control_panel .o_pager_limit').text(),'5',"limit should be correct for kanban");await cpHelpers.switchView(actionManager,'list');assert.strictEqual($('.o_control_panel .o_pager_value').text(),'1-3',"value should be correct for list");assert.strictEqual($('.o_control_panel .o_pager_limit').text(),'5',"limit should be correct for list");await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.strictEqual($('.o_control_panel .o_pager_value').text(),'1',"value should be correct for form");assert.strictEqual($('.o_control_panel .o_pager_limit').text(),'3',"limit should be correct for form");await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.strictEqual($('.o_control_panel .o_pager_value').text(),'1-3',"value should be correct for list");assert.strictEqual($('.o_control_panel .o_pager_limit').text(),'5',"limit should be correct for list");await cpHelpers.switchView(actionManager,'kanban');assert.strictEqual($('.o_control_panel .o_pager_value').text(),'1-5',"value should be correct for kanban");assert.strictEqual($('.o_control_panel .o_pager_limit').text(),'5',"limit should be correct for kanban");actionManager.destroy();});QUnit.test("domain is kept when switching between views",async function(assert){assert.expect(5);this.actions[2].search_view_id=[1,'a custom search view'];var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.containsN(actionManager,'.o_data_row',5);await cpHelpers.toggleFilterMenu(actionManager);await cpHelpers.toggleMenuItem(actionManager,"Bar");assert.containsN(actionManager,'.o_data_row',2);await cpHelpers.switchView(actionManager,'kanban');assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',2);await testUtils.dom.click(actionManager.$('.o_searchview .o_facet_remove'));assert.containsN(actionManager,'.o_kanban_record:not(.o_kanban_ghost)',5);await cpHelpers.switchView(actionManager,'list');assert.containsN(actionManager,'.o_data_row',5);actionManager.destroy();});QUnit.test('there is no flickering when switching between views',async function(assert){assert.expect(20);var def;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(){var result=this._super.apply(this,arguments);return Promise.resolve(def).then(_.constant(result));},});await actionManager.doAction(3);def=testUtils.makeTestPromise();await cpHelpers.switchView(actionManager,'kanban');assert.containsOnce(actionManager,'.o_list_view',"should still display the list view");assert.containsNone(actionManager,'.o_kanban_view',"shouldn't display the kanban view yet");def.resolve();await testUtils.nextTick();assert.containsNone(actionManager,'.o_list_view',"shouldn't display the list view anymore");assert.containsOnce(actionManager,'.o_kanban_view',"should now display the kanban view");def=testUtils.makeTestPromise();await cpHelpers.switchView(actionManager,'list');assert.containsOnce(actionManager,'.o_kanban_view',"should still display the kanban view");assert.containsNone(actionManager,'.o_list_view',"shouldn't display the list view yet");def.resolve();await testUtils.nextTick();assert.containsNone(actionManager,'.o_kanban_view',"shouldn't display the kanban view anymore");assert.containsOnce(actionManager,'.o_list_view',"should now display the list view");def=testUtils.makeTestPromise();await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_list_view',"should still display the list view");assert.containsNone(actionManager,'.o_form_view',"shouldn't display the form view yet");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should still be one controller in the breadcrumbs");def.resolve();await testUtils.nextTick();assert.containsNone(actionManager,'.o_list_view',"should no longer display the list view");assert.containsOnce(actionManager,'.o_form_view',"should display the form view");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");def=testUtils.makeTestPromise();await testUtils.dom.click($('.o_control_panel .breadcrumb a'));assert.containsOnce(actionManager,'.o_form_view',"should still display the form view");assert.containsNone(actionManager,'.o_list_view',"shouldn't display the list view yet");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should still be two controllers in the breadcrumbs");def.resolve();await testUtils.nextTick();assert.containsNone(actionManager,'.o_form_view',"should no longer display the form view");assert.containsOnce(actionManager,'.o_list_view',"should display the list view");assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");actionManager.destroy();});QUnit.test('breadcrumbs are updated when display_name changes',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'First record',"breadcrumbs should contain the display_name of the opened record");await testUtils.dom.click($('.o_control_panel .o_form_button_edit'));await testUtils.fields.editInput(actionManager.$('.o_field_widget[name=display_name]'),'New name');await testUtils.dom.click($('.o_control_panel .o_form_button_save'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should still be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'New name',"breadcrumbs should contain the display_name of the opened record");actionManager.destroy();});QUnit.test('reverse breadcrumb works on accesskey "b"',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));await testUtils.dom.click(actionManager.$('.o_form_view button:contains(Execute action)'));assert.containsN(actionManager,'.o_control_panel .breadcrumb li',3);var $previousBreadcrumb=actionManager.$('.o_control_panel .breadcrumb li.active').prev();assert.strictEqual($previousBreadcrumb.attr("accesskey"),"b","previous breadcrumb should have accessKey 'b'");await testUtils.dom.click($previousBreadcrumb);assert.containsN(actionManager,'.o_control_panel .breadcrumb li',2);var $previousBreadcrumb=actionManager.$('.o_control_panel .breadcrumb li.active').prev();assert.strictEqual($previousBreadcrumb.attr("accesskey"),"b","previous breadcrumb should have accessKey 'b'");actionManager.destroy();});QUnit.test('reload previous controller when discarding a new record',async function(assert){assert.expect(8);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(3);await testUtils.dom.click($('.o_control_panel .o_list_button_add'));assert.containsOnce(actionManager,'.o_form_view.o_form_editable',"should have opened the form view in edit mode");await testUtils.dom.click($('.o_control_panel .o_form_button_cancel'));assert.containsOnce(actionManager,'.o_list_view',"should have switched back to the list view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','onchange','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('requests for execute_action of type object are handled',async function(assert){assert.expect(10);var self=this;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);if(route==='/web/dataset/call_button'){assert.deepEqual(args,{args:[[1]],kwargs:{context:{some_key:2}},method:'object',model:'partner',},"should call route with correct arguments");var record=_.findWhere(self.data.partner.records,{id:args.args[0][0]});record.foo='value changed';return Promise.resolve(false);}
return this._super.apply(this,arguments);},session:{user_context:{some_key:2,}},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.strictEqual(actionManager.$('.o_field_widget[name=foo]').text(),'yop',"check initial value of 'yop' field");await testUtils.dom.click(actionManager.$('.o_form_view button:contains(Call method)'));assert.strictEqual(actionManager.$('.o_field_widget[name=foo]').text(),'value changed',"'yop' has been changed by the server, and should be updated in the UI");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','read','object','read',]);actionManager.destroy();});QUnit.test('requests for execute_action of type action are handled',async function(assert){assert.expect(11);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two parts in the breadcrumbs");await testUtils.dom.click(actionManager.$('.o_form_view button:contains(Execute action)'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,3,"the returned action should have been stacked over the previous one");assert.containsOnce(actionManager,'.o_kanban_view',"the returned action should have been executed");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','read','/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('requests for execute_action of type object: disable buttons',async function(assert){assert.expect(2);var def;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/call_button'){return Promise.resolve(false);}else if(args.method==='read'){var result=this._super.apply(this,arguments);return Promise.resolve(def).then(_.constant(result));}
return this._super.apply(this,arguments);},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));def=testUtils.makeTestPromise();await testUtils.dom.click(actionManager.$('.o_form_view button:contains(Call method)'));assert.strictEqual(actionManager.$('.o_form_view button:contains(Call method)').attr('disabled'),'disabled','buttons should be disabled');def.resolve();await testUtils.nextTick();assert.strictEqual(actionManager.$('.o_form_view button:contains(Call method)').attr('disabled'),undefined,'buttons should be disabled')
actionManager.destroy();});QUnit.test('can open different records from a multi record view',async function(assert){assert.expect(11);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'First record',"breadcrumbs should contain the display_name of the opened record");assert.strictEqual(actionManager.$('.o_field_widget[name=foo]').text(),'yop',"should have opened the correct record");await testUtils.dom.click($('.o_control_panel .breadcrumb a'));await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:nth(1)'));assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Second record',"breadcrumbs should contain the display_name of the opened record");assert.strictEqual(actionManager.$('.o_field_widget[name=foo]').text(),'blip',"should have opened the correct record");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','read','/web/dataset/search_read','read',]);actionManager.destroy();});QUnit.test('restore previous view state when switching back',async function(assert){assert.expect(5);this.actions[2].views.unshift([false,'graph']);this.archs['partner,false,graph']='<graph></graph>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.hasClass($('.o_control_panel  .fa-bar-chart-o'),'active',"bar chart button is active");assert.doesNotHaveClass($('.o_control_panel  .fa-area-chart'),'active',"line chart button is not active");await testUtils.dom.click($('.o_control_panel  .fa-area-chart'));assert.hasClass($('.o_control_panel  .fa-area-chart'),'active',"line chart button is now active");await cpHelpers.switchView(actionManager,'kanban');assert.strictEqual($('.o_control_panel  .fa-area-chart').length,0,"graph buttons are no longer in control panel");await cpHelpers.switchView(actionManager,'graph');assert.hasClass($('.o_control_panel  .fa-area-chart'),'active',"line chart button is still active");actionManager.destroy();});QUnit.test('view switcher is properly highlighted in graph view',async function(assert){assert.expect(4);this.actions[2].views.splice(1,1,[false,'graph']);this.archs['partner,false,graph']='<graph></graph>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.hasClass($('.o_control_panel .o_switch_view.o_list'),'active',"list button in control panel is active");assert.doesNotHaveClass($('.o_control_panel .o_switch_view.o_graph'),'active',"graph button in control panel is not active");await cpHelpers.switchView(actionManager,'graph');assert.doesNotHaveClass($('.o_control_panel .o_switch_view.o_list'),'active',"list button in control panel is not active");assert.hasClass($('.o_control_panel .o_switch_view.o_graph'),'active',"graph button in control panel is active");actionManager.destroy();});QUnit.test('can interact with search view',async function(assert){assert.expect(2);this.archs['partner,false,search']='<search>'+'<group>'+'<filter name="foo" string="foo" context="{\'group_by\': \'foo\'}"/>'+'</group>'+'</search>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.doesNotHaveClass(actionManager.$('.o_list_table'),'o_list_table_grouped',"list view is not grouped");await testUtils.dom.click($('.o_control_panel .o_cp_bottom_right button:contains(Group By)'));await testUtils.dom.click($('.o_control_panel .o_group_by_menu a:first'));assert.hasClass(actionManager.$('.o_list_table'),'o_list_table_grouped','list view is now grouped');actionManager.destroy();});QUnit.test('can open a many2one external window',async function(assert){assert.expect(8);this.data.partner.records[0].bar=2;this.archs['partner,false,search']='<search>'+'<group>'+'<filter name="foo" string="foo" context="{\'group_by\': \'foo\'}"/>'+'</group>'+'</search>';this.archs['partner,false,form']='<form>'+'<group>'+'<field name="foo"/>'+'<field name="bar"/>'+'</group>'+'</form>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(route);if(args.method==="get_formview_id"){return Promise.resolve(false);}
return this._super.apply(this,arguments);},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_data_row:first'));await testUtils.dom.click($('.o_control_panel .o_form_button_edit'));await testUtils.dom.click(actionManager.$('.o_external_button'));assert.verifySteps(['/web/action/load','/web/dataset/call_kw/partner','/web/dataset/search_read','/web/dataset/call_kw/partner/read','/web/dataset/call_kw/partner/get_formview_id','/web/dataset/call_kw/partner','/web/dataset/call_kw/partner/read']);actionManager.destroy();});QUnit.test('ask for confirmation when leaving a "dirty" view',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(4);await testUtils.dom.click(actionManager.$('.o_kanban_record:first'));await testUtils.dom.click($('.o_control_panel button.o_form_button_edit'));await testUtils.fields.editInput(actionManager.$('input[name="foo"]'),'pinkypie');await testUtils.dom.click($('.o_control_panel .breadcrumb-item:first a'));assert.strictEqual($('.modal .modal-body').text(),"The record has been modified, your changes will be discarded. Do you want to proceed?","should display a modal dialog to confirm discard action");await testUtils.dom.click($('.modal .modal-footer button.btn-secondary'));assert.containsOnce(actionManager,'.o_form_view',"should still be in form view");await testUtils.dom.click($('.o_control_panel .breadcrumb-item:first a'));await testUtils.dom.click($('.modal .modal-footer button.btn-primary'));assert.containsNone(actionManager,'.o_form_view',"should no longer be in form view");assert.containsOnce(actionManager,'.o_kanban_view',"should be in kanban view");actionManager.destroy();});QUnit.test('limit set in action is passed to each created controller',async function(assert){assert.expect(2);_.findWhere(this.actions,{id:3}).limit=2;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.containsN(actionManager,'.o_data_row',2,"should only display 2 record");await cpHelpers.switchView(actionManager,'kanban');assert.strictEqual(actionManager.$('.o_kanban_record:not(.o_kanban_ghost)').length,2,"should only display 2 record");actionManager.destroy();});QUnit.test('go back to a previous action using the breadcrumbs',async function(assert){assert.expect(10);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'First record',"breadcrumbs should contain the display_name of the opened record");await actionManager.doAction(4);assert.strictEqual($('.o_control_panel .breadcrumb-item').length,3,"there should be three controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Partners Action 4',"breadcrumbs should contain the name of the current action");await testUtils.dom.click($('.o_control_panel .breadcrumb a:nth(1)'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'First record',"breadcrumbs should contain the display_name of the opened record");await actionManager.doAction(4);assert.strictEqual($('.o_control_panel .breadcrumb-item').length,3,"there should be three controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Partners Action 4',"breadcrumbs should contain the name of the current action");await testUtils.dom.click($('.o_control_panel .breadcrumb a:first'));assert.strictEqual($('.o_control_panel .breadcrumb-item').length,1,"there should be one controller in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Partners',"breadcrumbs should contain the name of the current action");actionManager.destroy();});QUnit.test('form views are restored in readonly when coming back in breadcrumbs',async function(assert){assert.expect(2);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));await testUtils.dom.click($('.o_control_panel .o_form_button_edit'));assert.hasClass(actionManager.$('.o_form_view'),'o_form_editable');await actionManager.doAction(4);await testUtils.dom.clickLast($('.o_control_panel .breadcrumb a'));await testUtils.nextTick();assert.hasClass(actionManager.$('.o_form_view'),'o_form_readonly');actionManager.destroy();});QUnit.test('honor group_by specified in actions context',async function(assert){assert.expect(5);_.findWhere(this.actions,{id:3}).context="{'group_by': 'bar'}";this.archs['partner,false,search']='<search>'+'<group>'+'<filter name="foo" string="foo" context="{\'group_by\': \'foo\'}"/>'+'</group>'+'</search>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_table_grouped',"should be grouped");assert.containsN(actionManager,'.o_group_header',2,"should be grouped by 'bar' (two groups) at first load");await testUtils.dom.click($('.o_control_panel .o_cp_bottom_right button:contains(Group By)'));await testUtils.dom.click($('.o_control_panel .o_group_by_menu a:first'));assert.containsN(actionManager,'.o_group_header',5,"should be grouped by 'foo' (five groups)");await testUtils.dom.click($('.o_control_panel .o_searchview .o_facet_remove'));assert.containsOnce(actionManager,'.o_list_table_grouped',"should still be grouped");assert.containsN(actionManager,'.o_group_header',2,"should be grouped by 'bar' (two groups) at reload");actionManager.destroy();});QUnit.test('switch request to unknown view type',async function(assert){assert.expect(7);this.actions.push({id:33,name:'Partners',res_model:'partner',type:'ir.actions.act_window',views:[[false,'list'],[1,'kanban']],});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(33);assert.containsOnce(actionManager,'.o_list_view',"should display the list view");testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_list_view',"should still display the list view");assert.containsNone(actionManager,'.o_form_view',"should not display the form view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read',]);actionManager.destroy();});QUnit.test('save current search',async function(assert){assert.expect(4);testUtils.mock.patch(ListController,{getOwnedQueryParams:function(){return{context:{shouldBeInFilterContext:true,}};},});this.actions.push({id:33,context:{shouldNotBeInFilterContext:false,},name:'Partners',res_model:'partner',search_view_id:[1,'a custom search view'],type:'ir.actions.act_window',views:[[false,'list']],});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,env:{dataManager:{create_filter:function(filter){assert.strictEqual(filter.domain,`[("bar", "=", 1)]`,"should save the correct domain");const expectedContext={group_by:[],shouldBeInFilterContext:true,};assert.deepEqual(filter.context,expectedContext,"should save the correct context");},}},});await actionManager.doAction(33);assert.containsN(actionManager,'.o_data_row',5,"should contain 5 records");await cpHelpers.toggleFilterMenu(actionManager);await cpHelpers.toggleMenuItem(actionManager,"Bar");assert.containsN(actionManager,'.o_data_row',2);await cpHelpers.toggleFavoriteMenu(actionManager);await cpHelpers.toggleSaveFavorite(actionManager);await cpHelpers.editFavoriteName(actionManager,"some name");await cpHelpers.saveFavorite(actionManager);testUtils.mock.unpatch(ListController);actionManager.destroy();});QUnit.test('list with default_order and favorite filter with no orderedBy',async function(assert){assert.expect(5);this.archs['partner,1,list']='<tree default_order="foo desc"><field name="foo"/></tree>';this.actions.push({id:100,name:'Partners',res_model:'partner',type:'ir.actions.act_window',views:[[1,'list'],[false,'form']],});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,favoriteFilters:[{user_id:[2,"Mitchell Admin"],name:'favorite filter',id:5,context:{},sort:'[]',domain:'[("bar", "=", 1)]'}],});await actionManager.doAction(100);assert.strictEqual(actionManager.$('.o_list_view tr.o_data_row .o_data_cell').text(),'zoupyopplopgnapblip','record should be in descending order as default_order applies');await cpHelpers.toggleFavoriteMenu(actionManager);await cpHelpers.toggleMenuItem(actionManager,"favorite filter");assert.strictEqual(actionManager.$('.o_control_panel .o_facet_values').text().trim(),'favorite filter','favorite filter should be applied');assert.strictEqual(actionManager.$('.o_list_view tr.o_data_row .o_data_cell').text(),'gnapblip','record should still be in descending order after default_order applied');await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));await testUtils.dom.click(actionManager.$('.o_control_panel .breadcrumb a:eq(0)'));assert.strictEqual(actionManager.$('.o_list_view tr.o_data_row .o_data_cell').text(),'gnapblip','order of records should not be changed, while coming back through breadcrumb');await cpHelpers.removeFacet(actionManager,0);assert.strictEqual(actionManager.$('.o_list_view tr.o_data_row .o_data_cell').text(),'zoupyopplopgnapblip','order of records should not be changed, after removing current filter');actionManager.destroy();});QUnit.test("search menus are still available when switching between actions",async function(assert){assert.expect(3);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);assert.isVisible(actionManager.el.querySelector('.o_search_options .o_dropdown.o_filter_menu'),"the search options should be available");await actionManager.doAction(3);assert.isVisible(actionManager.el.querySelector('.o_search_options .o_dropdown.o_filter_menu'),"the search options should be available");await testUtils.dom.click($('.o_control_panel .breadcrumb a:first'));assert.isVisible(actionManager.el.querySelector('.o_search_options .o_dropdown.o_filter_menu'),"the search options should be available");actionManager.destroy();});QUnit.test("current act_window action is stored in session_storage",async function(assert){assert.expect(1);var expectedAction=_.extend({},_.findWhere(this.actions,{id:3}),{context:{},});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{session_storage:SessionStorageService.extend({setItem:function(key,value){assert.strictEqual(value,JSON.stringify(expectedAction),"should store the executed action in the sessionStorage");},}),},});await actionManager.doAction(3);actionManager.destroy();});QUnit.test("store evaluated context of current action in session_storage",async function(assert){assert.expect(1);var expectedAction=_.extend({},_.findWhere(this.actions,{id:4}),{context:{active_model:'partner',active_id:1,active_ids:[1],},});var checkSessionStorage=false;var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,services:{session_storage:SessionStorageService.extend({setItem:function(key,value){if(checkSessionStorage){assert.strictEqual(value,JSON.stringify(expectedAction),"should correctly store the executed action in the sessionStorage");}},}),},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));checkSessionStorage=true;await testUtils.dom.click(actionManager.$('.o_form_view button:contains(Execute action)'));actionManager.destroy();});QUnit.test("destroy action with lazy loaded controller",async function(assert){assert.expect(6);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.loadState({action:3,id:2,view_type:'form',});assert.containsNone(actionManager,'.o_list_view');assert.containsOnce(actionManager,'.o_form_view');assert.strictEqual($('.o_control_panel .breadcrumb-item').length,2,"there should be two controllers in the breadcrumbs");assert.strictEqual($('.o_control_panel .breadcrumb-item:last').text(),'Second record',"breadcrumbs should contain the display_name of the opened record");await actionManager.doAction(1,{clear_breadcrumbs:true});assert.containsNone(actionManager,'.o_form_view');assert.containsOnce(actionManager,'.o_kanban_view');actionManager.destroy();});QUnit.test('execute action from dirty, new record, and come back',async function(assert){assert.expect(17);this.data.partner.fields.bar.default=1;this.archs['partner,false,form']='<form>'+'<field name="foo"/>'+'<field name="bar" readonly="1"/>'+'</form>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='get_formview_action'){return Promise.resolve({res_id:1,res_model:'partner',type:'ir.actions.act_window',views:[[false,'form']],});}
return this._super.apply(this,arguments);},intercepts:{do_action:function(ev){actionManager.doAction(ev.data.action,{});},},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_button_add'));assert.containsOnce(actionManager,'.o_form_view.o_form_editable');assert.containsOnce(actionManager,'.o_form_uri:contains(First record)');assert.strictEqual(actionManager.$('.o_control_panel .breadcrumb-item').text(),"PartnersNew");await testUtils.fields.editInput(actionManager.$('input[name=foo]'),'val');await testUtils.dom.click(actionManager.$('.o_form_uri:contains(First record)'));assert.containsOnce($('body'),'.modal');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));assert.containsOnce(actionManager,'.o_form_view.o_form_readonly');assert.strictEqual(actionManager.$('.o_control_panel .breadcrumb-item').text(),"PartnersNewFirst record");await testUtils.dom.click(actionManager.$('.o_control_panel .breadcrumb-item:nth(1) a'));assert.containsOnce(actionManager,'.o_form_view.o_form_editable');assert.strictEqual(actionManager.$('.o_control_panel .breadcrumb-item').text(),"PartnersNew");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','onchange','get_formview_action','load_views','read','onchange',]);actionManager.destroy();});QUnit.test('execute a contextual action from a form view',async function(assert){assert.expect(4);const contextualAction=this.actions.find(action=>action.id===8);contextualAction.context="{}";const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:async function(route,args){const res=await this._super(...arguments);if(args.method==='load_views'&&args.model==='partner'){assert.strictEqual(args.kwargs.options.toolbar,true,"should ask for toolbar information");res.form.toolbar={action:[contextualAction],print:[],};}
return res;},intercepts:{do_action:function(ev){actionManager.doAction(ev.data.action,{});},},});await actionManager.doAction(3);assert.containsOnce(actionManager,'.o_list_view');await testUtils.dom.click(actionManager.$('.o_data_row:first'));assert.containsOnce(actionManager,'.o_form_view');await cpHelpers.toggleActionMenu(actionManager);await cpHelpers.toggleMenuItem(actionManager,"Favorite Ponies");assert.containsOnce(actionManager,'.o_list_view');actionManager.destroy();});QUnit.module('Actions in target="new"');QUnit.test('can execute act_window actions in target="new"',async function(assert){assert.expect(7);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(5);assert.strictEqual($('.o_technical_modal .o_form_view').length,1,"should have rendered a form view in a modal");assert.hasClass($('.o_technical_modal .modal-body'),'o_act_window',"dialog main element should have classname 'o_act_window'");assert.hasClass($('.o_technical_modal .o_form_view'),'o_form_editable',"form view should be in edit mode");assert.verifySteps(['/web/action/load','load_views','onchange',]);actionManager.destroy();});QUnit.test('chained action on_close',async function(assert){assert.expect(3);function on_close(){assert.step('Close Action');};var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(5,{on_close:on_close});await actionManager.doAction(5);assert.verifySteps([]);await actionManager.doAction(10);assert.verifySteps(['Close Action']);actionManager.destroy();});QUnit.test('footer buttons are moved to the dialog footer',async function(assert){assert.expect(3);this.archs['partner,false,form']='<form>'+'<field name="display_name"/>'+'<footer>'+'<button string="Create" type="object" class="infooter"/>'+'</footer>'+'</form>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(5);assert.containsNone($('.o_technical_modal .modal-body'),'button.infooter',"the button should not be in the body");assert.containsOnce($('.o_technical_modal .modal-footer'),'button.infooter',"the button should be in the footer");assert.containsOnce($('.o_technical_modal .modal-footer'),'button',"the modal footer should only contain one button");actionManager.destroy();});QUnit.test("Button with `close` attribute closes dialog",async function(assert){assert.expect(2);const actions=[{id:4,name:"Partners Action 4",res_model:"partner",type:"ir.actions.act_window",views:[[false,"form"]],},{id:5,name:"Create a Partner",res_model:"partner",target:"new",type:"ir.actions.act_window",views:[["view_ref","form"]],},];const actionManager=await createActionManager({actions,archs:{"partner,false,form":`
                    <form>
                        <header>
                            <button string="Open dialog" name="5" type="action"/>
                        </header>
                    </form>
                `,"partner,view_ref,form":`
                    <form>
                        <footer>
                            <button string="I close the dialog" name="some_method" type="object" close="1"/>
                        </footer>
                    </form>
                `,"partner,false,search":"<search></search>",},data:this.data,mockRPC:async function(route,args){if(route==="/web/dataset/call_button"&&args.method==="some_method"){return{tag:"display_notification",type:"ir.actions.client"};}
return this._super(...arguments);},});await actionManager.doAction(4);await testUtils.dom.click(`button[name="5"]`);assert.strictEqual($(".modal").length,1,"It should display a modal");await testUtils.dom.click(`button[name="some_method"]`);assert.strictEqual($(".modal").length,0,"It should have closed the modal");actionManager.destroy();});QUnit.test('on_attach_callback is called for actions in target="new"',async function(assert){assert.expect(4);var ClientAction=AbstractAction.extend({on_attach_callback:function(){assert.step('on_attach_callback');assert.ok(actionManager.currentDialogController,"the currentDialogController should have been set already");},start:function(){this.$el.addClass('o_test');},});core.action_registry.add('test',ClientAction);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction({tag:'test',target:'new',type:'ir.actions.client',});assert.strictEqual($('.modal .o_test').length,1,"should have rendered the client action in a dialog");assert.verifySteps(['on_attach_callback']);actionManager.destroy();delete core.action_registry.map.test;});QUnit.module('Actions in target="inline"');QUnit.test('form views for actions in target="inline" open in edit mode',async function(assert){assert.expect(5);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},});await actionManager.doAction(6);assert.containsOnce(actionManager,'.o_form_view.o_form_editable',"should have rendered a form view in edit mode");assert.verifySteps(['/web/action/load','load_views','read',]);actionManager.destroy();});QUnit.module('Actions in target="fullscreen"');QUnit.test('correctly execute act_window actions in target="fullscreen"',async function(assert){assert.expect(7);this.actions[0].target='fullscreen';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){assert.step(args.method||route);return this._super.apply(this,arguments);},intercepts:{toggle_fullscreen:function(){assert.step('toggle_fullscreen');},},});await actionManager.doAction(1);assert.strictEqual($('.o_control_panel').length,1,"should have rendered a control panel");assert.containsOnce(actionManager,'.o_kanban_view',"should have rendered a kanban view");assert.verifySteps(['/web/action/load','load_views','/web/dataset/search_read','toggle_fullscreen',]);actionManager.destroy();});QUnit.test('fullscreen on action change: back to a "current" action',async function(assert){assert.expect(3);this.actions[0].target='fullscreen';this.archs['partner,false,form']='<form>'+'<button name="1" type="action" class="oe_stat_button" />'+'</form>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{toggle_fullscreen:function(ev){var fullscreen=ev.data.fullscreen;switch(toggleFullscreenCalls){case 0:assert.strictEqual(fullscreen,false);break;case 1:assert.strictEqual(fullscreen,true);break;case 2:assert.strictEqual(fullscreen,false);break;}},},});var toggleFullscreenCalls=0;await actionManager.doAction(6);toggleFullscreenCalls=1;await testUtils.dom.click(actionManager.$('button[name=1]'));toggleFullscreenCalls=2;await testUtils.dom.click(actionManager.$('.breadcrumb li a:first'));actionManager.destroy();});QUnit.test('fullscreen on action change: all "fullscreen" actions',async function(assert){assert.expect(3);this.actions[5].target='fullscreen';this.archs['partner,false,form']='<form>'+'<button name="1" type="action" class="oe_stat_button" />'+'</form>';var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{toggle_fullscreen:function(ev){var fullscreen=ev.data.fullscreen;assert.strictEqual(fullscreen,true);},},});await actionManager.doAction(6);await testUtils.dom.click(actionManager.$('button[name=1]'));await testUtils.dom.click(actionManager.$('.breadcrumb li a:first'));actionManager.destroy();});QUnit.module('"ir.actions.act_window_close" actions');QUnit.test('close the currently opened dialog',async function(assert){assert.expect(2);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(5);assert.strictEqual($('.o_technical_modal .o_form_view').length,1,"should have rendered a form view in a modal");await actionManager.doAction({type:'ir.actions.act_window_close',});assert.strictEqual($('.o_technical_modal').length,0,"should have closed the modal");actionManager.destroy();});QUnit.test('execute "on_close" only if there is no dialog to close',async function(assert){assert.expect(3);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(5);var options={on_close:assert.step.bind(assert,'on_close'),};await actionManager.doAction({type:'ir.actions.act_window_close'},options);assert.verifySteps([]);await actionManager.doAction({type:'ir.actions.act_window_close'},options);assert.verifySteps(['on_close']);actionManager.destroy();});QUnit.test('doAction resolved with an action',async function(assert){assert.expect(4);this.actions.push({id:21,name:'A Close Action',type:'ir.actions.act_window_close',});var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(21).then(function(action){assert.ok(action,"doAction should be resolved with an action");assert.strictEqual(action.id,21,"should be resolved with correct action id");assert.strictEqual(action.name,'A Close Action',"should be resolved with correct action name");assert.strictEqual(action.type,'ir.actions.act_window_close',"should be resolved with correct action type");actionManager.destroy();});});QUnit.test('close action with provided infos',async function(assert){assert.expect(1);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});var options={on_close:function(infos){assert.strictEqual(infos,'just for testing',"should have the correct close infos");}};await actionManager.doAction({type:'ir.actions.act_window_close',infos:'just for testing',},options);actionManager.destroy();});QUnit.test('history back calls on_close handler of dialog action',async function(assert){assert.expect(2);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(this.actions[4],{on_close:function(){assert.step('on_close');},});actionManager.trigger_up('history_back');assert.verifySteps(['on_close'],"should have called the on_close handler");actionManager.destroy();});QUnit.test('properly drop client actions after new action is initiated',async function(assert){assert.expect(1);var slowWillStartDef=testUtils.makeTestPromise();var ClientAction=AbstractAction.extend({willStart:function(){return slowWillStartDef;},});core.action_registry.add('slowAction',ClientAction);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});actionManager.doAction('slowAction');actionManager.doAction(4);slowWillStartDef.resolve();await testUtils.nextTick();assert.containsOnce(actionManager,'.o_kanban_view','should have loaded a kanban view');actionManager.destroy();delete core.action_registry.map.slowAction;});QUnit.test('abstract action does not crash on navigation_moves',async function(assert){assert.expect(1);var ClientAction=AbstractAction.extend({});core.action_registry.add('ClientAction',ClientAction);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction('ClientAction');actionManager.trigger_up('navigation_move',{direction:'down'});assert.ok(true);actionManager.destroy();delete core.action_registry.ClientAction;});QUnit.test('fields in abstract action does not crash on navigation_moves',async function(assert){assert.expect(1);var inputWidget;var secondInputWidget;var ClientAction=AbstractAction.extend(StandaloneFieldManagerMixin,{init:function(){this._super.apply(this,arguments);StandaloneFieldManagerMixin.init.call(this);},start:function(){var _self=this;return this.model.makeRecord('partner',[{name:'display_name',type:'char',}]).then(function(recordID){var record=_self.model.get(recordID);inputWidget=new BasicFields.InputField(_self,'display_name',record,{mode:'edit',});_self._registerWidget(recordID,'display_name',inputWidget);secondInputWidget=new BasicFields.InputField(_self,'display_name',record,{mode:'edit',});secondInputWidget.attrs={className:"secondField"};_self._registerWidget(recordID,'display_name',secondInputWidget);inputWidget.appendTo(_self.$el);secondInputWidget.appendTo(_self.$el);});}});core.action_registry.add('ClientAction',ClientAction);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction('ClientAction');inputWidget.$el[0].focus();var event=$.Event('keydown',{which:$.ui.keyCode.TAB,keyCode:$.ui.keyCode.TAB,});$(inputWidget.$el[0]).trigger(event);assert.notOk(event.isDefaultPrevented(),"the keyboard event default should not be prevented");actionManager.destroy();delete core.action_registry.ClientAction;});QUnit.test('web client is not deadlocked when a view crashes',async function(assert){assert.expect(3);var readOnFirstRecordDef=testUtils.makeTestPromise();var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(args.method==='read'&&args.args[0][0]===1){return readOnFirstRecordDef;}
return this._super.apply(this,arguments);}});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));readOnFirstRecordDef.reject("not working as intended");assert.containsOnce(actionManager,'.o_list_view',"there should still be a list view in dom");await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:eq(2)'));assert.containsNone(actionManager,'.o_list_view',"there should not be a list view in dom");assert.containsOnce(actionManager,'.o_form_view',"there should be a form view in dom");actionManager.destroy();});QUnit.test('data-mobile attribute on action button, in desktop',async function(assert){assert.expect(2);testUtils.mock.patch(ActionManager,{doAction(action,options){assert.strictEqual(options.plop,undefined);return this._super(...arguments);},});this.archs['partner,75,kanban']=`
            <kanban>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <field name="display_name"/>
                            <button
                                name="1"
                                string="Execute action"
                                type="action"
                                data-mobile='{"plop": 28}'/>
                        </div>
                    </t>
                </templates>
            </kanban>`;this.actions.push({id:100,name:'action 100',res_model:'partner',type:'ir.actions.act_window',views:[[75,'kanban']],});const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data});await actionManager.doAction(100,{});await testUtils.dom.click(actionManager.$('button[data-mobile]:first'));actionManager.destroy();testUtils.mock.unpatch(ActionManager);});QUnit.module('Search View Action');QUnit.test('search view should keep focus during do_search',async function(assert){assert.expect(5);var searchPromise=testUtils.makeTestPromise();var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(route,args){if(route==='/web/dataset/search_read'){assert.step('search_read '+args.domain);if(_.isEqual(args.domain,[['foo','ilike','m']])){return searchPromise.then(this._super.bind(this,route,args));}}
return this._super.apply(this,arguments);},});await actionManager.doAction(3);await cpHelpers.editSearch(actionManager,"m");await cpHelpers.validateSearch(actionManager);assert.verifySteps(["search_read ","search_read foo,ilike,m"]);await cpHelpers.editSearch(actionManager,"o");searchPromise.resolve();await cpHelpers.validateSearch(actionManager);assert.verifySteps(["search_read |,foo,ilike,m,foo,ilike,o"]);actionManager.destroy();});QUnit.test('Call twice clearUncommittedChanges in a row does not display twice the discard warning',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,intercepts:{clear_uncommitted_changes:function(){actionManager.clearUncommittedChanges();},},});await actionManager.doAction(3);await testUtils.dom.click(actionManager.$('.o_list_view .o_data_row:first'));assert.containsOnce(actionManager,'.o_form_view.o_form_readonly');await testUtils.dom.click($('.o_control_panel .o_form_button_edit'));assert.containsOnce(actionManager,'.o_form_view.o_form_editable');await testUtils.fields.editInput(actionManager.$('input[name=foo]'),'val');actionManager.trigger_up('clear_uncommitted_changes');await testUtils.nextTick();assert.containsOnce($('body'),'.modal');await testUtils.dom.click($('.modal .modal-footer .btn-primary'));actionManager.trigger_up('clear_uncommitted_changes');await testUtils.nextTick();assert.containsNone($('body'),'.modal');actionManager.destroy();});});});;

/* /web/static/tests/chrome/keyboard_navigation_mixin_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.keyboard_navigation_mixin_tests',function(require){"use strict";var KeyboardNavigationMixin=require('web.KeyboardNavigationMixin');var testUtils=require('web.test_utils');var Widget=require('web.Widget');QUnit.module('KeyboardNavigationMixin',function(){QUnit.test('aria-keyshortcuts is added on elements with accesskey',async function(assert){assert.expect(1);var $target=$('#qunit-fixture');var KeyboardWidget=Widget.extend(KeyboardNavigationMixin,{init:function(){this._super.apply(this,arguments);KeyboardNavigationMixin.init.call(this);},start:function(){KeyboardNavigationMixin.start.call(this);var $button=$('<button>').text('Click Me!').attr('accesskey','o');this.$el.append($button);return this._super.apply(this,arguments);},destroy:function(){KeyboardNavigationMixin.destroy.call(this);return this._super(...arguments);},});var parent=await testUtils.createParent({});var w=new KeyboardWidget(parent);await w.appendTo($target);var e=new Event("keydown");e.key='';e.altKey=true;w.$el[0].dispatchEvent(e);assert.ok(w.$el.find('button[aria-keyshortcuts]')[0],'the aria-keyshortcuts is set on the button');parent.destroy();});QUnit.test('keep CSS position absolute for parent of overlay',async function(assert){assert.expect(1);var $target=$('#qunit-fixture');var $button;var KeyboardWidget=Widget.extend(KeyboardNavigationMixin,{init:function(){this._super.apply(this,arguments);KeyboardNavigationMixin.init.call(this);},start:function(){KeyboardNavigationMixin.start.call(this);$button=$('<button>').text('Click Me!').attr('accesskey','o');this.$el.append($button);return this._super.apply(this,arguments);},destroy:function(){KeyboardNavigationMixin.destroy.call(this);return this._super(...arguments);},});var parent=await testUtils.createParent({});var w=new KeyboardWidget(parent);await w.appendTo($target);$button.css('position','absolute');var e=new Event("keydown");e.key='';e.altKey=true;w.$el[0].dispatchEvent(e);assert.strictEqual($button.css('position'),'absolute',"should not have kept the CSS position of the button");parent.destroy();});});});;

/* /web/static/tests/chrome/menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.menu_tests',function(require){"use strict";const testUtils=require('web.test_utils');const Menu=require('web.Menu');const SystrayMenu=require('web.SystrayMenu');const Widget=require('web.Widget');QUnit.module('chrome',{},function(){QUnit.module('Menu');QUnit.test('Systray on_attach_callback is called',async function(assert){assert.expect(4);const parent=await testUtils.createParent({});const Widget1=Widget.extend({on_attach_callback:()=>assert.step('on_attach_callback widget1')});const Widget2=Widget.extend({on_attach_callback:()=>assert.step('on_attach_callback widget2')});SystrayMenu.Items=[Widget1,Widget2];testUtils.mock.patch(SystrayMenu,{on_attach_callback:function(){assert.step('on_attach_callback systray');this._super(...arguments);}});const menu=new Menu(parent,{children:[]});await menu.appendTo($('#qunit-fixture'));assert.verifySteps(['on_attach_callback systray','on_attach_callback widget1','on_attach_callback widget2',]);testUtils.mock.unpatch(SystrayMenu);parent.destroy();});});});;

/* /web/static/tests/chrome/user_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.user_menu_tests',function(require){"use strict";var testUtils=require('web.test_utils');var UserMenu=require('web.UserMenu');var Widget=require('web.Widget');QUnit.module('chrome',{},function(){QUnit.module('UserMenu');QUnit.test('basic rendering',async function(assert){assert.expect(3);var parent=new Widget();await testUtils.mock.addMockEnvironment(parent,{});var userMenu=new UserMenu(parent);await userMenu.appendTo($('body'));assert.strictEqual($('.o_user_menu').length,1,"should have a user menu in the DOM");assert.hasClass(userMenu.$el,'o_user_menu',"user menu in DOM should be from user menu widget instantiation");assert.containsOnce(userMenu,'.dropdown-item[data-menu="shortcuts"]',"should have a 'Shortcuts' item");userMenu.destroy();parent.destroy();});});});;

/* /web/static/tests/chrome/systray_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.systray_tests',function(require){"use strict";var testUtils=require('web.test_utils');var SystrayMenu=require('web.SystrayMenu');var Widget=require('web.Widget');QUnit.test('Adding async components to the registry respects the sequence',async function(assert){assert.expect(2);var parent=await testUtils.createParent({});var prom=testUtils.makeTestPromise();var synchronousFirstWidget=Widget.extend({sequence:3,start:function(){this.$el.addClass('first');}});var asynchronousSecondWidget=Widget.extend({sequence:1,willStart:function(){return prom;},start:function(){this.$el.addClass('second');}});SystrayMenu.Items=[synchronousFirstWidget,asynchronousSecondWidget];var menu=new SystrayMenu(parent);menu.appendTo($('#qunit-fixture'));await testUtils.nextTick();prom.resolve();await testUtils.nextTick();assert.hasClass(menu.$('div:eq(0)'),'first');assert.hasClass(menu.$('div:eq(1)'),'second');parent.destroy();})});;

/* /web/static/tests/components/custom_checkbox_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.custom_checkbox_tests',function(require){"use strict";const CustomCheckbox=require('web.CustomCheckbox');const testUtils=require('web.test_utils');const{createComponent,dom:testUtilsDom}=testUtils;QUnit.module('Components',{},function(){QUnit.module('CustomCheckbox');QUnit.test('test checkbox: default values',async function(assert){assert.expect(6);const checkbox=await createComponent(CustomCheckbox,{});assert.containsOnce(checkbox.el,'input');assert.containsNone(checkbox.el,'input:disabled');assert.containsOnce(checkbox.el,'label');const input=checkbox.el.querySelector('input');assert.notOk(input.checked,'checkbox should be unchecked');assert.ok(input.id.startsWith('checkbox-comp-'));await testUtilsDom.click(checkbox.el.querySelector('label'));assert.ok(input.checked,'checkbox should be checked');checkbox.destroy();});QUnit.test('test checkbox: custom values',async function(assert){assert.expect(6);const checkbox=await createComponent(CustomCheckbox,{props:{id:'my-custom-checkbox',disabled:true,value:true,text:'checkbox',}});assert.containsOnce(checkbox.el,'input');assert.containsOnce(checkbox.el,'input:disabled');assert.containsOnce(checkbox.el,'label');const input=checkbox.el.querySelector('input');assert.ok(input.checked,'checkbox should be checked');assert.strictEqual(input.id,'my-custom-checkbox');assert.ok(input.checked,'checkbox should be checked');checkbox.destroy();});});});;

/* /web/static/tests/components/custom_file_input_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.custom_file_input_tests',function(require){"use strict";const CustomFileInput=require('web.CustomFileInput');const testUtils=require('web.test_utils');const{createComponent}=testUtils;QUnit.module('Components',{},function(){QUnit.module('CustomFileInput');QUnit.test("Upload a file: default props",async function(assert){assert.expect(6);const customFileInput=await createComponent(CustomFileInput,{env:{services:{async httpRequest(route,params){assert.deepEqual(params,{csrf_token:odoo.csrf_token,ufile:[],});assert.step(route);return'[]';},},},});const input=customFileInput.el.querySelector('input');assert.strictEqual(customFileInput.el.innerText.trim().toUpperCase(),"CHOOSE FILE","File input total text should match its given inner element's text");assert.strictEqual(input.accept,'*',"Input should accept all files by default");await testUtils.dom.triggerEvent(input,'change');assert.notOk(input.multiple,"'multiple' attribute should not be set");assert.verifySteps(['/web/binary/upload']);customFileInput.destroy();});QUnit.test("Upload a file: custom attachment",async function(assert){assert.expect(6);const customFileInput=await createComponent(CustomFileInput,{env:{services:{async httpRequest(route,params){assert.deepEqual(params,{id:5,model:'res.model',csrf_token:odoo.csrf_token,ufile:[],});assert.step(route);return'[]';},},},props:{accepted_file_extensions:'.png',action:'/web/binary/upload_attachment',id:5,model:'res.model',multi_upload:true,},intercepts:{'uploaded':ev=>assert.strictEqual(ev.detail.files.length,0,"'files' property should be an empty array"),},});const input=customFileInput.el.querySelector('input');assert.strictEqual(input.accept,'.png',"Input should now only accept pngs");await testUtils.dom.triggerEvent(input,'change');assert.ok(input.multiple,"'multiple' attribute should be set");assert.verifySteps(['/web/binary/upload_attachment']);customFileInput.destroy();});});});;

/* /web/static/tests/components/datepicker_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.datepicker_tests',function(require){"use strict";const{DatePicker,DateTimePicker}=require('web.DatePickerOwl');const testUtils=require('web.test_utils');const time=require('web.time');const{createComponent}=testUtils;QUnit.module('Components',{},function(){QUnit.module('DatePicker');QUnit.test("basic rendering",async function(assert){assert.expect(8);const picker=await createComponent(DatePicker,{props:{date:moment('01/09/1997')},});assert.containsOnce(picker,'input.o_input.o_datepicker_input');assert.containsOnce(picker,'span.o_datepicker_button');assert.containsNone(document.body,'div.bootstrap-datetimepicker-widget');const input=picker.el.querySelector('input.o_input.o_datepicker_input');assert.strictEqual(input.value,'01/09/1997',"Value should be the one given");assert.strictEqual(input.dataset.target,`#${picker.el.id}`,"DatePicker id should match its input target");await testUtils.dom.click(input);assert.containsOnce(document.body,'div.bootstrap-datetimepicker-widget .datepicker');assert.containsNone(document.body,'div.bootstrap-datetimepicker-widget .timepicker');assert.strictEqual(document.querySelector('.datepicker .day.active').dataset.day,'01/09/1997',"Datepicker should have set the correct day");picker.destroy();});QUnit.test("pick a date",async function(assert){assert.expect(5);const picker=await createComponent(DatePicker,{props:{date:moment('01/09/1997')},intercepts:{'datetime-changed':ev=>{assert.step('datetime-changed');assert.strictEqual(ev.detail.date.format('MM/DD/YYYY'),'02/08/1997',"Event should transmit the correct date");},}});const input=picker.el.querySelector('.o_datepicker_input');await testUtils.dom.click(input);await testUtils.dom.click(document.querySelector('.datepicker th.next'));assert.verifySteps([]);await testUtils.dom.click(document.querySelectorAll('.datepicker table td')[15]);assert.strictEqual(input.value,'02/08/1997');assert.verifySteps(['datetime-changed']);picker.destroy();});QUnit.test("enter a date value",async function(assert){assert.expect(5);const picker=await createComponent(DatePicker,{props:{date:moment('01/09/1997')},intercepts:{'datetime-changed':ev=>{assert.step('datetime-changed');assert.strictEqual(ev.detail.date.format('MM/DD/YYYY'),'02/08/1997',"Event should transmit the correct date");},}});const input=picker.el.querySelector('.o_datepicker_input');assert.verifySteps([]);await testUtils.fields.editAndTrigger(input,'02/08/1997',['change']);assert.verifySteps(['datetime-changed']);await testUtils.dom.click(input);assert.strictEqual(document.querySelector('.datepicker .day.active').dataset.day,'02/08/1997',"Datepicker should have set the correct day");picker.destroy();});QUnit.test("Date format is correctly set",async function(assert){assert.expect(2);testUtils.patch(time,{getLangDateFormat:()=>"YYYY/MM/DD"});const picker=await createComponent(DatePicker,{props:{date:moment('01/09/1997')},});const input=picker.el.querySelector('.o_datepicker_input');assert.strictEqual(input.value,'1997/01/09');await testUtils.dom.click(input);assert.strictEqual(input.value,'1997/01/09');picker.destroy();testUtils.unpatch(time);});QUnit.module('DateTimePicker');QUnit.test("basic rendering",async function(assert){assert.expect(11);const picker=await createComponent(DateTimePicker,{props:{date:moment('01/09/1997 12:30:01')},});assert.containsOnce(picker,'input.o_input.o_datepicker_input');assert.containsOnce(picker,'span.o_datepicker_button');assert.containsNone(document.body,'div.bootstrap-datetimepicker-widget');const input=picker.el.querySelector('input.o_input.o_datepicker_input');assert.strictEqual(input.value,'01/09/1997 12:30:01',"Value should be the one given");assert.strictEqual(input.dataset.target,`#${picker.el.id}`,"DateTimePicker id should match its input target");await testUtils.dom.click(input);assert.containsOnce(document.body,'div.bootstrap-datetimepicker-widget .datepicker');assert.containsOnce(document.body,'div.bootstrap-datetimepicker-widget .timepicker');assert.strictEqual(document.querySelector('.datepicker .day.active').dataset.day,'01/09/1997',"Datepicker should have set the correct day");assert.strictEqual(document.querySelector('.timepicker .timepicker-hour').innerText.trim(),'12',"Datepicker should have set the correct hour");assert.strictEqual(document.querySelector('.timepicker .timepicker-minute').innerText.trim(),'30',"Datepicker should have set the correct minute");assert.strictEqual(document.querySelector('.timepicker .timepicker-second').innerText.trim(),'01',"Datepicker should have set the correct second");picker.destroy();});QUnit.test("pick a date and time",async function(assert){assert.expect(5);const picker=await createComponent(DateTimePicker,{props:{date:moment('01/09/1997 12:30:01')},intercepts:{'datetime-changed':ev=>{assert.step('datetime-changed');assert.strictEqual(ev.detail.date.format('MM/DD/YYYY HH:mm:ss'),'02/08/1997 15:45:05',"Event should transmit the correct date");},}});const input=picker.el.querySelector('input.o_input.o_datepicker_input');await testUtils.dom.click(input);await testUtils.dom.click(document.querySelector('.datepicker th.next'));await testUtils.dom.click(document.querySelectorAll('.datepicker table td')[15]);await testUtils.dom.click(document.querySelector('a[title="Select Time"]'));await testUtils.dom.click(document.querySelector('.timepicker .timepicker-hour'));await testUtils.dom.click(document.querySelectorAll('.timepicker .hour')[15]);await testUtils.dom.click(document.querySelector('.timepicker .timepicker-minute'));await testUtils.dom.click(document.querySelectorAll('.timepicker .minute')[9]);await testUtils.dom.click(document.querySelector('.timepicker .timepicker-second'));assert.verifySteps([]);await testUtils.dom.click(document.querySelectorAll('.timepicker .second')[1]);assert.strictEqual(input.value,'02/08/1997 15:45:05');assert.verifySteps(['datetime-changed']);picker.destroy();});QUnit.test("enter a datetime value",async function(assert){assert.expect(9);const picker=await createComponent(DateTimePicker,{props:{date:moment('01/09/1997 12:30:01')},intercepts:{'datetime-changed':ev=>{assert.step('datetime-changed');assert.strictEqual(ev.detail.date.format('MM/DD/YYYY HH:mm:ss'),'02/08/1997 15:45:05',"Event should transmit the correct date");},}});const input=picker.el.querySelector('.o_datepicker_input');assert.verifySteps([]);await testUtils.fields.editAndTrigger(input,'02/08/1997 15:45:05',['change']);assert.verifySteps(['datetime-changed']);await testUtils.dom.click(input);assert.strictEqual(input.value,'02/08/1997 15:45:05');assert.strictEqual(document.querySelector('.datepicker .day.active').dataset.day,'02/08/1997',"Datepicker should have set the correct day");assert.strictEqual(document.querySelector('.timepicker .timepicker-hour').innerText.trim(),'15',"Datepicker should have set the correct hour");assert.strictEqual(document.querySelector('.timepicker .timepicker-minute').innerText.trim(),'45',"Datepicker should have set the correct minute");assert.strictEqual(document.querySelector('.timepicker .timepicker-second').innerText.trim(),'05',"Datepicker should have set the correct second");picker.destroy();});QUnit.test("Date time format is correctly set",async function(assert){assert.expect(2);testUtils.patch(time,{getLangDatetimeFormat:()=>"hh:mm:ss YYYY/MM/DD"});const picker=await createComponent(DateTimePicker,{props:{date:moment('01/09/1997 12:30:01')},});const input=picker.el.querySelector('.o_datepicker_input');assert.strictEqual(input.value,'12:30:01 1997/01/09');await testUtils.dom.click(input);assert.strictEqual(input.value,'12:30:01 1997/01/09');picker.destroy();testUtils.unpatch(time);});});});;

/* /web/static/tests/components/pager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.pager_tests',function(require){"use strict";const Pager=require('web.Pager');const testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;const{createComponent}=testUtils;QUnit.module('Components',{},function(){QUnit.module('Pager');QUnit.test('basic interactions',async function(assert){assert.expect(2);const pager=await createComponent(Pager,{props:{currentMinimum:1,limit:4,size:10,},intercepts:{'pager-changed':function(ev){Object.assign(this.state,ev.detail);},},});assert.strictEqual(cpHelpers.getPagerValue(pager),"1-4","currentMinimum should be set to 1");await cpHelpers.pagerNext(pager);assert.strictEqual(cpHelpers.getPagerValue(pager),"5-8","currentMinimum should now be 5");pager.destroy();});QUnit.test('edit the pager',async function(assert){assert.expect(4);const pager=await createComponent(Pager,{props:{currentMinimum:1,limit:4,size:10,},intercepts:{'pager-changed':function(ev){Object.assign(this.state,ev.detail);},},});await testUtils.dom.click(pager.el.querySelector('.o_pager_value'));assert.containsOnce(pager,'input',"the pager should contain an input");assert.strictEqual(cpHelpers.getPagerValue(pager),"1-4","the input should have correct value");await cpHelpers.setPagerValue(pager,"1-6");assert.containsNone(pager,'input',"the pager should not contain an input anymore");assert.strictEqual(cpHelpers.getPagerValue(pager),"1-6","the limit should have been updated");pager.destroy();});QUnit.test("keydown on pager with same value",async function(assert){assert.expect(7);const pager=await createComponent(Pager,{props:{currentMinimum:1,limit:4,size:10,},intercepts:{"pager-changed":()=>assert.step("pager-changed"),},});await testUtils.dom.click(pager.el.querySelector('.o_pager_value'));assert.containsOnce(pager,"input");assert.strictEqual(cpHelpers.getPagerValue(pager),"1-4");assert.verifySteps([]);await testUtils.dom.triggerEvent(pager.el.querySelector('input'),"keydown",{key:"Enter"});assert.containsNone(pager,"input");assert.strictEqual(cpHelpers.getPagerValue(pager),"1-4");assert.verifySteps(["pager-changed"]);pager.destroy();});QUnit.test('pager value formatting',async function(assert){assert.expect(8);const pager=await createComponent(Pager,{props:{currentMinimum:1,limit:4,size:10,},intercepts:{'pager-changed':function(ev){Object.assign(this.state,ev.detail);},},});assert.strictEqual(cpHelpers.getPagerValue(pager),"1-4","Initial value should be correct");async function inputAndAssert(input,expected,reason){await cpHelpers.setPagerValue(pager,input);assert.strictEqual(cpHelpers.getPagerValue(pager),expected,`Pager value should be "${expected}" when given "${input}": ${reason}`);}
await inputAndAssert("4-4","4","values are squashed when minimum = maximum");await inputAndAssert("1-11","1-10","maximum is floored to size when out of range");await inputAndAssert("20-15","10","combination of the 2 assertions above");await inputAndAssert("6-5","10","fallback to previous value when minimum > maximum");await inputAndAssert("definitelyValidNumber","10","fallback to previous value if not a number");await inputAndAssert(" 1 ,  2   ","1-2","value is normalized and accepts several separators");await inputAndAssert("3  8","3-8","value accepts whitespace(s) as a separator");pager.destroy();});QUnit.test('pager disabling',async function(assert){assert.expect(9);const reloadPromise=testUtils.makeTestPromise();const pager=await createComponent(Pager,{props:{currentMinimum:1,limit:4,size:10,},intercepts:{'pager-changed':async function(ev){await reloadPromise;Object.assign(this.state,ev.detail);},},});const pagerButtons=pager.el.querySelectorAll('button');await cpHelpers.pagerNext(pager);await cpHelpers.pagerNext(pager);await testUtils.dom.click(pager.el.querySelector('.o_pager_value'));assert.strictEqual(pagerButtons.length,2,"the two buttons should be displayed");assert.ok(pagerButtons[0].disabled,"'previous' is disabled");assert.ok(pagerButtons[1].disabled,"'next' is disabled");assert.strictEqual(pager.el.querySelector('.o_pager_value').tagName,'SPAN',"pager edition is prevented");reloadPromise.resolve();await testUtils.nextTick();assert.strictEqual(pagerButtons.length,2,"the two buttons should be displayed");assert.notOk(pagerButtons[0].disabled,"'previous' is enabled");assert.notOk(pagerButtons[1].disabled,"'next' is enabled");assert.strictEqual(cpHelpers.getPagerValue(pager),"5-8","value has been updated");await testUtils.dom.click(pager.el.querySelector('.o_pager_value'));assert.strictEqual(pager.el.querySelector('.o_pager_value').tagName,'INPUT',"pager edition is re-enabled");pager.destroy();});});});;

/* /web/static/tests/components/action_menus_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.action_menus_tests',function(require){"use strict";const ActionMenus=require('web.ActionMenus');const Registry=require('web.Registry');const testUtils=require('web.test_utils');const{Component}=owl;const cpHelpers=testUtils.controlPanel;const{createComponent}=testUtils;QUnit.module('Components',{beforeEach(){this.action={res_model:'hobbit',};this.view={type:'form',};this.props={activeIds:[23],context:{},items:{action:[{action:{id:1},name:"What's taters, precious ?",id:1},],print:[{action:{id:2},name:"Po-ta-toes",id:2},],other:[{description:"Boil'em",callback(){}},{description:"Mash'em",callback(){}},{description:"Stick'em in a stew",url:'#stew'},],},};this.actionMenusRegistry=ActionMenus.registry;ActionMenus.registry=new Registry();},afterEach(){ActionMenus.registry=this.actionMenusRegistry;},},function(){QUnit.module('ActionMenus');QUnit.test('basic interactions',async function(assert){assert.expect(10);const actionMenus=await createComponent(ActionMenus,{env:{action:this.action,view:this.view,},props:this.props,});const dropdowns=actionMenus.el.getElementsByClassName('o_dropdown');assert.strictEqual(dropdowns.length,2,"ActionMenus should contain 2 menus");assert.strictEqual(dropdowns[0].querySelector('.o_dropdown_title').innerText.trim(),"Print");assert.strictEqual(dropdowns[1].querySelector('.o_dropdown_title').innerText.trim(),"Action");assert.containsNone(actionMenus,'.o_dropdown_menu');await cpHelpers.toggleActionMenu(actionMenus,"Action");assert.containsOnce(actionMenus,'.o_dropdown_menu');assert.containsN(actionMenus,'.o_dropdown_menu .o_menu_item',4);const actionsTexts=[...dropdowns[1].querySelectorAll('.o_menu_item')].map(el=>el.innerText.trim());assert.deepEqual(actionsTexts,["Boil'em","Mash'em","Stick'em in a stew","What's taters, precious ?",],"callbacks should appear before actions");await cpHelpers.toggleActionMenu(actionMenus,"Print");assert.containsOnce(actionMenus,'.o_dropdown_menu');assert.containsN(actionMenus,'.o_dropdown_menu .o_menu_item',1);await cpHelpers.toggleActionMenu(actionMenus,"Print");assert.containsNone(actionMenus,'.o_dropdown_menu');actionMenus.destroy();});QUnit.test("empty action menus",async function(assert){assert.expect(1);ActionMenus.registry.add("test",{Component,getProps:()=>false});this.props.items={};const actionMenus=await createComponent(ActionMenus,{env:{action:this.action,view:this.view,},props:this.props,});assert.containsNone(actionMenus,".o_cp_action_menus > *");actionMenus.destroy();});QUnit.test('execute action',async function(assert){assert.expect(4);const actionMenus=await createComponent(ActionMenus,{env:{action:this.action,view:this.view,},props:this.props,intercepts:{'do-action':ev=>assert.step('do-action'),},async mockRPC(route,args){switch(route){case'/web/action/load':const expectedContext={active_id:23,active_ids:[23],active_model:'hobbit',};assert.deepEqual(args.context,expectedContext);assert.step('load-action');return{context:{},flags:{}};default:return this._super(...arguments);}},});await cpHelpers.toggleActionMenu(actionMenus,"Action");await cpHelpers.toggleMenuItem(actionMenus,"What's taters, precious ?");assert.verifySteps(['load-action','do-action']);actionMenus.destroy();});QUnit.test('execute callback action',async function(assert){assert.expect(2);const callbackPromise=testUtils.makeTestPromise();this.props.items.other[0].callback=function(items){assert.strictEqual(items.length,1);assert.strictEqual(items[0].description,"Boil'em");callbackPromise.resolve();};const actionMenus=await createComponent(ActionMenus,{env:{action:this.action,view:this.view,},props:this.props,async mockRPC(route,args){switch(route){case'/web/action/load':throw new Error("No action should be loaded.");default:return this._super(...arguments);}},});await cpHelpers.toggleActionMenu(actionMenus,"Action");await cpHelpers.toggleMenuItem(actionMenus,"Boil'em");await callbackPromise;actionMenus.destroy();});QUnit.test('execute print action',async function(assert){assert.expect(4);const actionMenus=await createComponent(ActionMenus,{env:{action:this.action,view:this.view,},intercepts:{'do-action':ev=>assert.step('do-action'),},props:this.props,async mockRPC(route,args){switch(route){case'/web/action/load':const expectedContext={active_id:23,active_ids:[23],active_model:'hobbit',};assert.deepEqual(args.context,expectedContext);assert.step('load-action');return{context:{},flags:{}};default:return this._super(...arguments);}},});await cpHelpers.toggleActionMenu(actionMenus,"Print");await cpHelpers.toggleMenuItem(actionMenus,"Po-ta-toes");assert.verifySteps(['load-action','do-action']);actionMenus.destroy();});QUnit.test('execute url action',async function(assert){assert.expect(2);const actionMenus=await createComponent(ActionMenus,{env:{action:this.action,services:{navigate(url){assert.step(url);},},view:this.view,},props:this.props,async mockRPC(route,args){switch(route){case'/web/action/load':throw new Error("No action should be loaded.");default:return this._super(...arguments);}},});await cpHelpers.toggleActionMenu(actionMenus,"Action");await cpHelpers.toggleMenuItem(actionMenus,"Stick'em in a stew");assert.verifySteps(['#stew']);actionMenus.destroy();});});});;

/* /web/static/tests/components/dropdown_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.dropdown_menu_tests',function(require){"use strict";const DropdownMenu=require('web.DropdownMenu');const testUtils=require('web.test_utils');const{createComponent}=testUtils;QUnit.module('Components',{beforeEach:function(){this.items=[{isActive:false,description:'Some Item',id:1,groupId:1,groupNumber:1,options:[{description:"First Option",groupNumber:1,id:1},{description:"Second Option",groupNumber:2,id:2},],},{isActive:true,description:'Some other Item',id:2,groupId:2,groupNumber:2,},];},},function(){QUnit.module('DropdownMenu');QUnit.test('simple rendering and basic interactions',async function(assert){assert.expect(8);const dropdown=await createComponent(DropdownMenu,{props:{items:this.items,title:"Dropdown",},});assert.strictEqual(dropdown.el.querySelector('button').innerText.trim(),"Dropdown");assert.containsNone(dropdown,'ul.o_dropdown_menu');await testUtils.dom.click(dropdown.el.querySelector('button'));assert.containsN(dropdown,'.dropdown-divider, .dropdown-item',3,'should have 3 elements counting the divider');const itemEls=dropdown.el.querySelectorAll('.o_menu_item > .dropdown-item');assert.strictEqual(itemEls[0].innerText.trim(),'Some Item');assert.doesNotHaveClass(itemEls[0],'selected');assert.hasClass(itemEls[1],'selected');const dropdownElements=dropdown.el.querySelectorAll('.o_menu_item *');for(const dropdownEl of dropdownElements){await testUtils.dom.click(dropdownEl);}
assert.containsOnce(dropdown,'ul.o_dropdown_menu',"Clicking on any item of the dropdown should not close it");await testUtils.dom.click(document.body);assert.containsNone(dropdown,'ul.o_dropdown_menu',"Clicking outside of the dropdown should close it");dropdown.destroy();});QUnit.test('only one dropdown rendering at same time (owl vs bootstrap dropdown)',async function(assert){assert.expect(12);const bsDropdown=document.createElement('div');bsDropdown.innerHTML=`<div class="dropdown">
                <button class="btn dropdown-toggle" type="button" 
                        data-toggle="dropdown" aria-expanded="false">
                    BS Dropdown button
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">BS Action</a>
                </div>
            </div>`;document.body.append(bsDropdown);const dropdown=await createComponent(DropdownMenu,{props:{items:this.items,title:"Dropdown",},});await testUtils.dom.click(dropdown.el.querySelector('button'));assert.hasClass(dropdown.el.querySelector('.dropdown-menu'),'show');assert.doesNotHaveClass(bsDropdown.querySelector('.dropdown-menu'),'show');assert.isVisible(dropdown.el.querySelector('.dropdown-menu'),"owl dropdown menu should be visible");assert.isNotVisible(bsDropdown.querySelector('.dropdown-menu'),"bs dropdown menu should not be visible");await testUtils.dom.click(bsDropdown.querySelector('.btn.dropdown-toggle'));assert.doesNotHaveClass(dropdown.el,'show');assert.containsNone(dropdown.el,'.dropdown-menu',"owl dropdown menu should not be set inside the dom");assert.hasClass(bsDropdown.querySelector('.dropdown-menu'),'show');assert.isVisible(bsDropdown.querySelector('.dropdown-menu'),"bs dropdown menu should be visible");await testUtils.dom.click(document.body);assert.doesNotHaveClass(dropdown.el,'show');assert.containsNone(dropdown.el,'.dropdown-menu',"owl dropdown menu should not be set inside the dom");assert.doesNotHaveClass(bsDropdown.querySelector('.dropdown-menu'),'show');assert.isNotVisible(bsDropdown.querySelector('.dropdown-menu'),"bs dropdown menu should not be visible");bsDropdown.remove();dropdown.destroy();});QUnit.test('click on an item without options should toggle it',async function(assert){assert.expect(7);delete this.items[0].options;const dropdown=await createComponent(DropdownMenu,{props:{items:this.items},intercepts:{'item-selected':function(ev){assert.strictEqual(ev.detail.item.id,1);this.state.items[0].isActive=!this.state.items[0].isActive;},}});await testUtils.dom.click(dropdown.el.querySelector('button'));const firstItemEl=dropdown.el.querySelector('.o_menu_item > a');assert.doesNotHaveClass(firstItemEl,'selected');await testUtils.dom.click(firstItemEl);assert.hasClass(firstItemEl,'selected');assert.isVisible(firstItemEl);await testUtils.dom.click(firstItemEl);assert.doesNotHaveClass(firstItemEl,'selected');assert.isVisible(firstItemEl);dropdown.destroy();});QUnit.test('click on an item should not change url',async function(assert){assert.expect(1);delete this.items[0].options;const initialHref=window.location.href;const dropdown=await createComponent(DropdownMenu,{props:{items:this.items},});await testUtils.dom.click(dropdown.el.querySelector('button'));await testUtils.dom.click(dropdown.el.querySelector('.o_menu_item > a'));assert.strictEqual(window.location.href,initialHref,"the url should not have changed after a click on an item");dropdown.destroy();});QUnit.test('options rendering',async function(assert){assert.expect(6);const dropdown=await createComponent(DropdownMenu,{props:{items:this.items},});await testUtils.dom.click(dropdown.el.querySelector('button'));assert.containsN(dropdown,'.dropdown-divider, .dropdown-item',3);const firstItemEl=dropdown.el.querySelector('.o_menu_item > a');assert.hasClass(firstItemEl.querySelector('i'),'o_icon_right fa fa-caret-right');await testUtils.dom.click(firstItemEl);assert.hasClass(firstItemEl.querySelector('i'),'o_icon_right fa fa-caret-down');assert.containsN(dropdown,'.dropdown-divider, .dropdown-item',6);await testUtils.dom.click(firstItemEl);assert.hasClass(firstItemEl.querySelector('i'),'o_icon_right fa fa-caret-right');assert.containsN(dropdown,'.dropdown-divider, .dropdown-item',3);dropdown.destroy();});QUnit.test('close menu closes also submenus',async function(assert){assert.expect(2);const dropdown=await createComponent(DropdownMenu,{props:{items:this.items},});await testUtils.dom.click(dropdown.el.querySelector('button'));await testUtils.dom.click(dropdown.el.querySelector('.o_menu_item a'));assert.containsN(dropdown,'.dropdown-divider, .dropdown-item',6);await testUtils.dom.click(dropdown.el.querySelector('button'));await testUtils.dom.click(dropdown.el.querySelector('button'));assert.containsN(dropdown,'.dropdown-divider, .dropdown-item',3);dropdown.destroy();});QUnit.test('click on an option should trigger the event "item_option_clicked" with appropriate data',async function(assert){assert.expect(18);let eventNumber=0;const dropdown=await createComponent(DropdownMenu,{props:{items:this.items},intercepts:{'item-selected':function(ev){eventNumber++;const{option}=ev.detail;assert.strictEqual(ev.detail.item.id,1);if(eventNumber===1){assert.strictEqual(option.id,1);this.state.items[0].isActive=true;this.state.items[0].options[0].isActive=true;}
if(eventNumber===2){assert.strictEqual(option.id,2);this.state.items[0].options[1].isActive=true;}
if(eventNumber===3){assert.strictEqual(option.id,1);this.state.items[0].options[0].isActive=false;}
if(eventNumber===4){assert.strictEqual(option.id,2);this.state.items[0].isActive=false;this.state.items[0].options[1].isActive=false;}},}});await testUtils.dom.click(dropdown.el.querySelector('button'));assert.containsN(dropdown,'.dropdown-divider, .o_menu_item',3);await testUtils.dom.click(dropdown.el.querySelector('.o_menu_item > a'));let optionELs=dropdown.el.querySelectorAll('.o_menu_item .o_item_option > a');await testUtils.dom.click(optionELs[0]);assert.hasClass(dropdown.el.querySelector('.o_menu_item > a'),'selected');optionELs=dropdown.el.querySelectorAll('.o_menu_item .o_item_option > a');assert.hasClass(optionELs[0],'selected');assert.doesNotHaveClass(optionELs[1],'selected');await testUtils.dom.click(optionELs[1]);assert.hasClass(dropdown.el.querySelector('.o_menu_item > a'),'selected');optionELs=dropdown.el.querySelectorAll('.o_menu_item .o_item_option > a');assert.hasClass(optionELs[0],'selected');assert.hasClass(optionELs[1],'selected');await testUtils.dom.click(optionELs[0]);await testUtils.dom.click(optionELs[1]);assert.doesNotHaveClass(dropdown.el.querySelector('.o_menu_item > a'),'selected');optionELs=dropdown.el.querySelectorAll('.o_menu_item .o_item_option > a');assert.doesNotHaveClass(optionELs[0],'selected');assert.doesNotHaveClass(optionELs[1],'selected');dropdown.destroy();});QUnit.test('keyboard navigation',async function(assert){assert.expect(12);async function navigate(key,global){const which={Enter:13,Escape:27,ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,}[key];const target=global?document.body:document.activeElement;await testUtils.dom.triggerEvent(target,'keydown',{key,which});if(key==='Enter'){await testUtils.dom.click(target);}}
const dropdown=await createComponent(DropdownMenu,{props:{items:this.items},});dropdown.el.querySelector('button').focus();await testUtils.dom.click(dropdown.el.querySelector('button'));await navigate('ArrowDown');assert.strictEqual(document.activeElement,dropdown.el.querySelector('.o_menu_item a'));assert.containsNone(dropdown,'.o_item_option');await navigate('ArrowRight');assert.strictEqual(document.activeElement,dropdown.el.querySelector('.o_menu_item a'));assert.containsN(dropdown,'.o_item_option',2);await navigate('ArrowDown');assert.strictEqual(document.activeElement,dropdown.el.querySelector('.o_item_option a'));await navigate('ArrowLeft');assert.strictEqual(document.activeElement,dropdown.el.querySelector('.o_menu_item a'));assert.containsNone(dropdown,'.o_item_option');await navigate('Enter');assert.strictEqual(document.activeElement,dropdown.el.querySelector('.o_menu_item a'));assert.containsN(dropdown,'.o_item_option',2);await navigate('ArrowDown');await navigate('Escape');await testUtils.nextTick();assert.strictEqual(dropdown.el.querySelector('.o_menu_item a'),document.activeElement);assert.containsNone(dropdown,'.o_item_option');await navigate('Escape',true);assert.containsNone(dropdown,'ul.o_dropdown_menu',"Dropdown should be folded");dropdown.destroy();});QUnit.test('interactions between multiple dropdowns',async function(assert){assert.expect(7);const props={items:this.items};class Parent extends owl.Component{constructor(){super(...arguments);this.state=owl.useState(props);}}
Parent.components={DropdownMenu};Parent.template=owl.tags.xml`
                <div>
                    <DropdownMenu class="first" title="'First'" items="state.items"/>
                    <DropdownMenu class="second" title="'Second'" items="state.items"/>
                </div>`;const parent=new Parent();await parent.mount(testUtils.prepareTarget(),{position:'first-child'});const[menu1,menu2]=parent.el.querySelectorAll('.o_dropdown');assert.containsNone(parent,'.o_dropdown_menu');await testUtils.dom.click(menu1.querySelector('button'));assert.containsOnce(parent,'.o_dropdown_menu');assert.containsOnce(parent,'.o_dropdown.first .o_dropdown_menu');await testUtils.dom.click(menu2.querySelector('button'));assert.containsOnce(parent,'.o_dropdown_menu');assert.containsOnce(parent,'.o_dropdown.second .o_dropdown_menu');await testUtils.dom.click(menu2.querySelector('.o_menu_item a'));await testUtils.dom.click(menu1.querySelector('button'));assert.containsOnce(parent,'.o_dropdown_menu');assert.containsOnce(parent,'.o_dropdown.first .o_dropdown_menu');parent.destroy();});QUnit.test("dropdown doesn't get close on mousedown inside and mouseup outside dropdown",async function(assert){assert.expect(5);const items=this.items;class Parent extends owl.Component{constructor(){super(...arguments);this.items=items;}}
Parent.components={DropdownMenu};Parent.template=owl.tags.xml`
                <div>
                    <DropdownMenu class="first" title="'First'" items="items"/>
                </div>`;const parent=new Parent();await parent.mount(testUtils.prepareTarget(),{position:"first-child"});const menu=parent.el.querySelector(".o_dropdown");assert.doesNotHaveClass(menu,"show","dropdown should not be open");await testUtils.dom.click(menu.querySelector("button"));assert.hasClass(menu,"show","dropdown should be open");const firstItemEl=menu.querySelector(".o_menu_item > a");await testUtils.dom.click(firstItemEl);assert.hasClass(firstItemEl.querySelector("i"),"o_icon_right fa fa-caret-down");firstItemEl.parentElement.querySelector(".o_menu_item_options .o_item_option a").focus();await testUtils.dom.triggerEvents(parent.el,"click");assert.hasClass(menu,"show","dropdown should still be open");assert.hasClass(firstItemEl.querySelector("i"),"o_icon_right fa fa-caret-down");parent.destroy();});});});;

/* /web/static/tests/control_panel/control_panel_model_extension_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define("web/static/tests/control_panel/control_panel_model_extension_tests.js",function(require){"use strict";const ActionModel=require("web/static/src/js/views/action_model.js");const makeTestEnvironment=require('web.test_env');function createModel(params={}){const archs=(params.arch&&{search:params.arch,})||{};const{ControlPanel:controlPanelInfo,}=ActionModel.extractArchInfo(archs);const extensions={ControlPanel:{context:params.context,archNodes:controlPanelInfo.children,dynamicFilters:params.dynamicFilters,favoriteFilters:params.favoriteFilters,env:makeTestEnvironment(),fields:params.fields,},};const model=new ActionModel(extensions);return model;}
function sanitizeFilters(model){const cpme=model.extensions[0].find((ext)=>ext.constructor.name==="ControlPanelModelExtension");const filters=Object.values(cpme.state.filters);return filters.map(filter=>{const copy=Object.assign({},filter);delete copy.groupId;delete copy.groupNumber;delete copy.id;return copy;});}
QUnit.module('ControlPanelModelExtension',{beforeEach(){this.fields={display_name:{string:"Displayed name",type:'char'},foo:{string:"Foo",type:"char",default:"My little Foo Value",store:true,sortable:true},date_field:{string:"Date",type:"date",store:true,sortable:true},float_field:{string:"Float",type:"float"},bar:{string:"Bar",type:"many2one",relation:'partner'},};}},function(){QUnit.module('Arch parsing');QUnit.test('empty arch',async function(assert){assert.expect(1);const model=createModel();assert.deepEqual(sanitizeFilters(model),[]);});QUnit.test('one field tag',async function(assert){assert.expect(1);const arch=`
                <search>
                    <field name="bar"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{description:"Bar",fieldName:"bar",fieldType:"many2one",type:"field"},]);});QUnit.test('one separator tag',async function(assert){assert.expect(1);const arch=`
                <search>
                    <separator/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[]);});QUnit.test('one separator tag and one field tag',async function(assert){assert.expect(1);const arch=`
                <search>
                    <separator/>
                    <field name="bar"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{description:"Bar",fieldName:"bar",fieldType:"many2one",type:"field"},]);});QUnit.test('one filter tag',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter name="filter" string="Hello" domain="[]"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{description:"Hello",domain:"[]",type:"filter",},]);});QUnit.test('one filter tag with date attribute',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter name="date_filter" string="Date" date="date_field"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});const dateFilterId=Object.values(model.get('filters'))[0].id;assert.deepEqual(sanitizeFilters(model),[{defaultOptionId:"this_month",description:"Date",fieldName:"date_field",fieldType:"date",isDateFilter:true,hasOptions:true,type:"filter"},{comparisonOptionId:"previous_period",dateFilterId,description:"Date: Previous Period",type:"comparison"},{comparisonOptionId:"previous_year",dateFilterId,description:"Date: Previous Year",type:"comparison"}]);});QUnit.test('one groupBy tag',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter name="groupby" string="Hi" context="{ 'group_by': 'date_field:day'}"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{defaultOptionId:"day",description:"Hi",fieldName:"date_field",fieldType:"date",hasOptions:true,type:"groupBy",},]);});QUnit.test('two filter tags',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter name="filter_1" string="Hello One" domain="[]"/>
                    <filter name="filter_2" string="Hello Two" domain="[('bar', '=', 3)]"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{description:"Hello One",domain:"[]",type:"filter",},{description:"Hello Two",domain:"[('bar', '=', 3)]",type:"filter",},]);});QUnit.test('two filter tags separated by a separator',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter name="filter_1" string="Hello One" domain="[]"/>
                    <separator/>
                    <filter name="filter_2" string="Hello Two" domain="[('bar', '=', 3)]"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{description:"Hello One",domain:"[]",type:"filter",},{description:"Hello Two",domain:"[('bar', '=', 3)]",type:"filter",},]);});QUnit.test('one filter tag and one field',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter name="filter" string="Hello" domain="[]"/>
                    <field name="bar"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{description:"Hello",domain:"[]",type:"filter",},{description:"Bar",fieldName:"bar",fieldType:"many2one",type:"field",},]);});QUnit.test('two field tags',async function(assert){assert.expect(1);const arch=`
                <search>
                    <field name="foo"/>
                    <field name="bar"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,});assert.deepEqual(sanitizeFilters(model),[{description:"Foo",fieldName:"foo",fieldType:"char",type:"field"},{description:"Bar",fieldName:"bar",fieldType:"many2one",type:"field"},]);});QUnit.module('Preparing initial state');QUnit.test('process favorite filters',async function(assert){assert.expect(1);const favoriteFilters=[{user_id:[2,"Mitchell Admin"],name:'Sorted filter',id:5,context:{group_by:['foo','bar']},sort:'["foo", "-bar"]',domain:"[('user_id', '=', uid)]",}];const model=createModel({favoriteFilters});assert.deepEqual(sanitizeFilters(model),[{context:{},description:"Sorted filter",domain:"[('user_id', '=', uid)]",groupBys:['foo','bar'],orderedBy:[{asc:true,name:"foo"},{asc:false,name:"bar"}],removable:true,serverSideId:5,type:"favorite",userId:2},]);});QUnit.test('process dynamic filters',async function(assert){assert.expect(1);const dynamicFilters=[{description:'Quick search',domain:[['id','in',[1,3,4]]]}];const model=createModel({dynamicFilters});assert.deepEqual(sanitizeFilters(model),[{description:'Quick search',domain:"[[\"id\",\"in\",[1,3,4]]]",isDefault:true,type:'filter'},]);});QUnit.test('falsy search defaults are not activated',async function(assert){assert.expect(1);const context={search_default_filter:false,search_default_bar:0,search_default_groupby:2,};const arch=`
                <search>
                    <filter name="filter" string="Hello" domain="[]"/>
                    <filter name="groupby" string="Goodbye" context="{'group_by': 'foo'}"/>
                    <field name="bar"/>
                </search>`;const fields=this.fields;const model=createModel({arch,fields,context});assert.deepEqual(sanitizeFilters(model),[{description:'Hello',domain:"[]",type:'filter',},{description:'Bar',fieldName:'bar',fieldType:'many2one',type:'field',},{defaultRank:2,description:'Goodbye',fieldName:'foo',fieldType:'char',isDefault:true,type:'groupBy',},]);});});});;

/* /web/static/tests/control_panel/control_panel_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.control_panel_tests',function(require){"use strict";const testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;const{createControlPanel}=testUtils;QUnit.module('ControlPanel',{beforeEach(){this.fields={display_name:{string:"Displayed name",type:'char',searchable:true},foo:{string:"Foo",type:"char",default:"My little Foo Value",store:true,sortable:true,searchable:true},date_field:{string:"Date",type:"date",store:true,sortable:true,searchable:true},float_field:{string:"Float",type:"float",searchable:true},bar:{string:"Bar",type:"many2one",relation:'partner',searchable:true},};}},function(){QUnit.test('default field operator',async function(assert){assert.expect(2);const fields={foo_op:{string:"Foo Op",type:"char",store:true,sortable:true,searchable:true},foo:{string:"Foo",type:"char",store:true,sortable:true,searchable:true},bar_op:{string:"Bar Op",type:"many2one",relation:'partner',searchable:true},bar:{string:"Bar",type:"many2one",relation:'partner',searchable:true},selec:{string:"Selec",type:"selection",selection:[['red',"Red"],['black',"Black"]]},};const arch=`
                <search>
                    <field name="bar"/>
                    <field name="bar_op" operator="child_of"/>
                    <field name="foo"/>
                    <field name="foo_op" operator="="/>
                    <field name="selec"/>
                </search>`;const searchMenuTypes=[];const params={cpModelConfig:{arch,fields,context:{show_filterC:true,search_default_bar:10,search_default_bar_op:10,search_default_foo:"foo",search_default_foo_op:"foo_op",search_default_selec:'red',},searchMenuTypes,},cpProps:{fields,searchMenuTypes},env:{session:{async rpc(){return[[10,"Deco Addict"]];},},},};const controlPanel=await createControlPanel(params);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel).map(t=>t.replace(/\s/g,"")),["BarDecoAddict","BarOpDecoAddict","Foofoo","FooOpfoo_op","SelecRed"]);assert.deepEqual(controlPanel.getQuery().domain,["&","&","&","&",["bar","=",10],["bar_op","child_of",10],["foo","ilike","foo"],["foo_op","=","foo_op"],["selec","=","red"],]);controlPanel.destroy();});QUnit.module('Keyboard navigation');QUnit.test('remove a facet with backspace',async function(assert){assert.expect(2);const params={cpModelConfig:{arch:`<search> <field name="foo"/></search>`,fields:this.fields,context:{search_default_foo:"a"},searchMenuTypes:['filter'],},cpProps:{fields:this.fields},};const controlPanel=await createControlPanel(params);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Foo\na']);const searchInput=controlPanel.el.querySelector('input.o_searchview_input');await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Backspace'});assert.containsNone(controlPanel,'div.o_searchview div.o_searchview_facet');await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Backspace'});controlPanel.destroy();});QUnit.test('fields and filters with groups/invisible attribute',async function(assert){assert.expect(16);const arch=`
                <search>
                    <field name="display_name" string="Foo B" invisible="1"/>
                    <field name="foo" string="Foo A"/>
                    <filter name="filterA" string="FA" domain="[]"/>
                    <filter name="filterB" string="FB" invisible="1" domain="[]"/>
                    <filter name="filterC" string="FC" invisible="not context.get('show_filterC')" domain="[]"/>
                    <filter name="groupByA" string="GA" context="{ 'group_by': 'date_field:day' }"/>
                    <filter name="groupByB" string="GB" context="{ 'group_by': 'date_field:day' }" invisible="1"/>
                </search>`;const searchMenuTypes=['filter','groupBy'];const params={cpModelConfig:{arch,fields:this.fields,context:{show_filterC:true,search_default_display_name:'value',search_default_filterB:true,search_default_groupByB:true},searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);function selectorContainsValue(selector,value,shouldContain){const elements=[...controlPanel.el.querySelectorAll(selector)];const regExp=new RegExp(value);const matches=elements.filter(el=>regExp.test(el.innerText.replace(/\s/g,"")));assert.strictEqual(matches.length,shouldContain?1:0,`${selector} in the control panel should${shouldContain ? '' : ' not'} contain "${value}".`);}
assert.containsN(controlPanel,'div.o_searchview_facet',3);selectorContainsValue('.o_searchview_facet',"FooBvalue",true);selectorContainsValue('.o_searchview_facet .o_facet_values',"FB",true);selectorContainsValue('.o_searchview_facet .o_facet_values',"GB",true);await cpHelpers.toggleFilterMenu(controlPanel);selectorContainsValue('.o_menu_item a',"FA",true);selectorContainsValue('.o_menu_item a',"FB",false);selectorContainsValue('.o_menu_item a',"FC",true);await cpHelpers.toggleGroupByMenu(controlPanel);selectorContainsValue('.o_menu_item a',"GA",true);selectorContainsValue('.o_menu_item a',"GB",false);await cpHelpers.editSearch(controlPanel,'a');selectorContainsValue('.o_searchview_autocomplete',"SearchFooAfor:a",true);await cpHelpers.validateSearch(controlPanel);selectorContainsValue('.o_searchview_facet',"FooAa",true);await cpHelpers.toggleFilterMenu(controlPanel);selectorContainsValue('.o_menu_item a',"FA",true);selectorContainsValue('.o_menu_item a',"FB",false);selectorContainsValue('.o_menu_item a',"FC",true);await cpHelpers.toggleGroupByMenu(controlPanel);selectorContainsValue('.o_menu_item a',"GA",true);selectorContainsValue('.o_menu_item a',"GB",false);controlPanel.destroy();});QUnit.test('invisible fields and filters with unknown related fields should not be rendered',async function(assert){assert.expect(2);delete this.fields.bar;delete this.fields.date_field;const searchMenuTypes=[];const params={cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);assert.containsNone(controlPanel.el,'div.o_search_options div.o_filter_menu',"there should not be filter dropdown");assert.containsNone(controlPanel.el,'div.o_search_options div.o_group_by_menu',"there should not be groupby dropdown");controlPanel.destroy();});QUnit.test('groupby menu is not rendered if searchMenuTypes does not have groupBy',async function(assert){assert.expect(2);const arch=`<search/>`;const searchMenuTypes=['filter'];const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);assert.containsOnce(controlPanel.el,'div.o_search_options div.o_filter_menu');assert.containsNone(controlPanel.el,'div.o_search_options div.o_group_by_menu');controlPanel.destroy();});});});;

/* /web/static/tests/control_panel/comparison_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.comparison_menu_tests',function(require){"use strict";const{controlPanel:cpHelpers,createControlPanel,mock,}=require('web.test_utils');const{patchDate}=mock;const searchMenuTypes=['filter','comparison'];QUnit.module('Components',{beforeEach(){this.fields={birthday:{string:"Birthday",type:"date",store:true,sortable:true},date_field:{string:"Date",type:"date",store:true,sortable:true},float_field:{string:"Float",type:"float",group_operator:'sum'},foo:{string:"Foo",type:"char",store:true,sortable:true},};this.cpModelConfig={arch:`
                    <search>
                        <filter name="birthday" date="birthday"/>
                        <filter name="date_field" date="date_field"/>
                    </search>`,fields:this.fields,searchMenuTypes,};},},function(){QUnit.module('ComparisonMenu');QUnit.test('simple rendering',async function(assert){assert.expect(6);const unpatchDate=patchDate(1997,0,9,12,0,0);const params={cpModelConfig:this.cpModelConfig,cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);assert.containsOnce(controlPanel,".o_dropdown.o_filter_menu");assert.containsNone(controlPanel,".o_dropdown.o_comparison_menu");await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Birthday");await cpHelpers.toggleMenuItemOption(controlPanel,"Birthday","January");assert.containsOnce(controlPanel,'div.o_comparison_menu > button i.fa.fa-adjust');assert.strictEqual(controlPanel.el.querySelector('div.o_comparison_menu > button span').innerText.trim(),"Comparison");await cpHelpers.toggleComparisonMenu(controlPanel);const comparisonOptions=[...controlPanel.el.querySelectorAll('.o_comparison_menu li')];assert.strictEqual(comparisonOptions.length,2);assert.deepEqual(comparisonOptions.map(e=>e.innerText),["Birthday: Previous Period","Birthday: Previous Year"]);controlPanel.destroy();unpatchDate();});QUnit.test('activate a comparison works',async function(assert){assert.expect(5);const unpatchDate=patchDate(1997,0,9,12,0,0);const params={cpModelConfig:this.cpModelConfig,cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Birthday");await cpHelpers.toggleMenuItemOption(controlPanel,"Birthday","January");await cpHelpers.toggleComparisonMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Birthday: Previous Period");assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["Birthday: January 1997","Birthday: Previous Period",]);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Date");await cpHelpers.toggleMenuItemOption(controlPanel,"Date","December");await cpHelpers.toggleComparisonMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Date: Previous Year");assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[["Birthday: January 1997","Date: December 1996"].join("or"),"Date: Previous Year",]);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Date");await cpHelpers.toggleMenuItemOption(controlPanel,"Date","1996");assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["Birthday: January 1997",]);await cpHelpers.toggleComparisonMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Birthday: Previous Year");assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["Birthday: January 1997","Birthday: Previous Year",]);await cpHelpers.removeFacet(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);controlPanel.destroy();unpatchDate();});QUnit.test('no timeRanges key in search query if "comparison" not in searchMenuTypes',async function(assert){assert.expect(1);this.cpModelConfig.searchMenuTypes=['filter'];const params={cpModelConfig:this.cpModelConfig,cpProps:{fields:this.fields,searchMenuTypes:['filter']},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Birthday");await cpHelpers.toggleMenuItemOption(controlPanel,"Birthday",0);assert.notOk("timeRanges"in controlPanel.getQuery());controlPanel.destroy();});});});;

/* /web/static/tests/control_panel/favorite_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.favorite_menu_tests',function(require){"use strict";const FormView=require('web.FormView');const testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;const{createControlPanel,createView,mock}=testUtils;const{patchDate}=mock;const searchMenuTypes=['favorite'];QUnit.module('Components',{beforeEach:function(){this.fields={bar:{string:"Bar",type:"many2one",relation:'partner'},birthday:{string:"Birthday",type:"date",store:true,sortable:true},date_field:{string:"Date",type:"date",store:true,sortable:true},float_field:{string:"Float",type:"float",group_operator:'sum'},foo:{string:"Foo",type:"char",store:true,sortable:true},};},},function(){QUnit.module('FavoriteMenu');QUnit.test('simple rendering with no favorite',async function(assert){assert.expect(8);const params={cpModelConfig:{searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes,action:{name:"Action Name"}},};const controlPanel=await createControlPanel(params);assert.containsOnce(controlPanel,'div.o_favorite_menu > button i.fa.fa-star');assert.strictEqual(controlPanel.el.querySelector('div.o_favorite_menu > button span').innerText.trim(),"Favorites");await cpHelpers.toggleFavoriteMenu(controlPanel);assert.containsNone(controlPanel,'.dropdown-divider');assert.containsOnce(controlPanel,'.o_add_favorite');assert.strictEqual(controlPanel.el.querySelector('.o_add_favorite > button').innerText.trim(),"Save current search");await cpHelpers.toggleSaveFavorite(controlPanel);assert.strictEqual(controlPanel.el.querySelector('.o_add_favorite input[type="text"]').value,'Action Name');assert.containsN(controlPanel,'.o_add_favorite .custom-checkbox input[type="checkbox"]',2);const labelEls=controlPanel.el.querySelectorAll('.o_add_favorite .custom-checkbox label');assert.deepEqual([...labelEls].map(e=>e.innerText.trim()),["Use by default","Share with all users"]);controlPanel.destroy();});QUnit.test('favorites use by default and share are exclusive',async function(assert){assert.expect(11);const params={cpModelConfig:{viewInfo:{fields:this.fields},searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes,action:{},},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFavoriteMenu(controlPanel);await cpHelpers.toggleSaveFavorite(controlPanel);const checkboxes=controlPanel.el.querySelectorAll('input[type="checkbox"]');assert.strictEqual(checkboxes.length,2,'2 checkboxes are present');assert.notOk(checkboxes[0].checked,'Start: None of the checkboxes are checked (1)');assert.notOk(checkboxes[1].checked,'Start: None of the checkboxes are checked (2)');await testUtils.dom.click(checkboxes[0]);assert.ok(checkboxes[0].checked,'The first checkbox is checked');assert.notOk(checkboxes[1].checked,'The second checkbox is not checked');await testUtils.dom.click(checkboxes[1]);assert.notOk(checkboxes[0].checked,'Clicking on the second checkbox checks it, and unchecks the first (1)');assert.ok(checkboxes[1].checked,'Clicking on the second checkbox checks it, and unchecks the first (2)');await testUtils.dom.click(checkboxes[0]);assert.ok(checkboxes[0].checked,'Clicking on the first checkbox checks it, and unchecks the second (1)');assert.notOk(checkboxes[1].checked,'Clicking on the first checkbox checks it, and unchecks the second (2)');await testUtils.dom.click(checkboxes[0]);assert.notOk(checkboxes[0].checked,'End: None of the checkboxes are checked (1)');assert.notOk(checkboxes[1].checked,'End: None of the checkboxes are checked (2)');controlPanel.destroy();});QUnit.test('save filter',async function(assert){assert.expect(1);const params={cpModelConfig:{fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes,action:{},},'get-controller-query-params':function(callback){callback({orderedBy:[{asc:true,name:'foo'},{asc:false,name:'bar'}]});},env:{dataManager:{create_filter:async function(filter){assert.strictEqual(filter.sort,'["foo","bar desc"]','The right format for the string "sort" should be sent to the server');}}},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFavoriteMenu(controlPanel);await cpHelpers.toggleSaveFavorite(controlPanel);await cpHelpers.editFavoriteName(controlPanel,"aaa");await cpHelpers.saveFavorite(controlPanel);controlPanel.destroy();});QUnit.test('dynamic filters are saved dynamic',async function(assert){assert.expect(3);const arch=`
            <search>
                <filter string="Float" name="positive" domain="[('date_field', '>=', (context_today() + relativedelta()).strftime('%Y-%m-%d'))]"/>
            </search>
        `;const params={cpModelConfig:{fields:{},arch,searchMenuTypes,context:{search_default_positive:true,}},cpProps:{fields:{},searchMenuTypes,action:{},},'get-controller-query-params':function(callback){callback();},env:{dataManager:{create_filter:async function(filter){assert.strictEqual(filter.domain,"[(\"date_field\", \">=\", (context_today() + relativedelta()).strftime(\"%Y-%m-%d\"))]");return 1;}}},};const controlPanel=await createControlPanel(params);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Float']);await cpHelpers.toggleFavoriteMenu(controlPanel);await cpHelpers.toggleSaveFavorite(controlPanel);await cpHelpers.editFavoriteName(controlPanel,"My favorite");await cpHelpers.saveFavorite(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["My favorite"]);controlPanel.destroy();});QUnit.test('save filters created via autocompletion works',async function(assert){assert.expect(4);const arch=`<search><field name="foo"/></search>`;const params={cpModelConfig:{fields:this.fields,arch,searchMenuTypes,},cpProps:{fields:this.fields,searchMenuTypes,action:{},},'get-controller-query-params':function(callback){callback();},env:{dataManager:{create_filter:async function(filter){assert.strictEqual(filter.domain,`[["foo", "ilike", "a"]]`);return 1;}}},};const controlPanel=await createControlPanel(params);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);await cpHelpers.editSearch(controlPanel,"a");await cpHelpers.validateSearch(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["Foo\na"]);await cpHelpers.toggleFavoriteMenu(controlPanel);await cpHelpers.toggleSaveFavorite(controlPanel);await cpHelpers.editFavoriteName(controlPanel,"My favorite");await cpHelpers.saveFavorite(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["My favorite"]);controlPanel.destroy();});QUnit.test('delete an active favorite remove it both in list of favorite and in search bar',async function(assert){assert.expect(6);const favoriteFilters=[{context:"{}",domain:"[['foo', '=', 'qsdf']]",id:7,is_default:true,name:"My favorite",sort:"[]",user_id:[2,"Mitchell Admin"],}];const params={cpModelConfig:{favoriteFilters,searchMenuTypes},cpProps:{searchMenuTypes,action:{}},search:function(searchQuery){const{domain}=searchQuery;assert.deepEqual(domain,[]);},env:{dataManager:{delete_filter:function(){return Promise.resolve();}}},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFavoriteMenu(controlPanel);const{domain}=controlPanel.getQuery();assert.deepEqual(domain,[["foo","=","qsdf"]]);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["My favorite"]);assert.hasClass(controlPanel.el.querySelector('.o_favorite_menu .o_menu_item > a'),'selected');await cpHelpers.deleteFavorite(controlPanel,0);await testUtils.dom.click(document.querySelector('div.o_dialog footer button'));assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);const itemEls=controlPanel.el.querySelectorAll('.o_favorite_menu .o_menu_item');assert.deepEqual([...itemEls].map(e=>e.innerText.trim()),["Save current search"]);controlPanel.destroy();});QUnit.test('default favorite is not activated if key search_disable_custom_filters is set to true',async function(assert){assert.expect(2);const favoriteFilters=[{context:"{}",domain:"",id:7,is_default:true,name:"My favorite",sort:"[]",user_id:[2,"Mitchell Admin"],}];const params={cpModelConfig:{favoriteFilters,searchMenuTypes,context:{search_disable_custom_filters:true}},cpProps:{searchMenuTypes,action:{}},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFavoriteMenu(controlPanel);const{domain}=controlPanel.getQuery();assert.deepEqual(domain,[]);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);controlPanel.destroy();});QUnit.test('toggle favorite correctly clears filter, groupbys, comparison and field "options"',async function(assert){assert.expect(11);const unpatchDate=patchDate(2019,6,31,13,43,0);const favoriteFilters=[{context:`
                    {
                        "group_by": ["foo"],
                        "comparison": {
                            "favorite comparison content": "bla bla..."
                        },
                    }
                `,domain:"['!', ['foo', '=', 'qsdf']]",id:7,is_default:false,name:"My favorite",sort:"[]",user_id:[2,"Mitchell Admin"],}];let firstSearch=true;const arch=`
            <search>
                <field string="Foo" name="foo"/>
                <filter string="Date Field Filter" name="positive" date="date_field" default_period="this_year"/>
                <filter string="Date Field Groupby" name="coolName" context="{'group_by': 'date_field'}"/>
            </search>
        `;const searchMenuTypes=['filter','groupBy','comparison','favorite'];const params={cpModelConfig:{favoriteFilters,arch,fields:this.fields,searchMenuTypes,context:{search_default_positive:true,search_default_coolName:true,search_default_foo:"a",}},cpProps:{searchMenuTypes,action:{},fields:this.fields},search:function(searchQuery){const{domain,groupBy,timeRanges}=searchQuery;if(firstSearch){assert.deepEqual(domain,[['foo','ilike','a']]);assert.deepEqual(groupBy,['date_field:month']);assert.deepEqual(timeRanges,{comparisonId:"previous_period",comparisonRange:["&",["date_field",">=","2018-01-01"],["date_field","<=","2018-12-31"]],comparisonRangeDescription:"2018",fieldDescription:"Date Field Filter",fieldName:"date_field",range:["&",["date_field",">=","2019-01-01"],["date_field","<=","2019-12-31"]],rangeDescription:"2019",});firstSearch=false;}else{assert.deepEqual(domain,['!',['foo','=','qsdf']]);assert.deepEqual(groupBy,['foo']);assert.deepEqual(timeRanges,{"favorite comparison content":"bla bla...",range:undefined,comparisonRange:undefined,});}},};const controlPanel=await createControlPanel(params);const{domain,groupBy,timeRanges}=controlPanel.getQuery();assert.deepEqual(domain,["&",["foo","ilike","a"],"&",["date_field",">=","2019-01-01"],["date_field","<=","2019-12-31"]]);assert.deepEqual(groupBy,['date_field:month']);assert.deepEqual(timeRanges,{});assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Foo\na','Date Field Filter: 2019','Date Field Groupby: Month',]);await cpHelpers.toggleComparisonMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Date Field Filter: Previous period");await cpHelpers.toggleFavoriteMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,0);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["My favorite"]);controlPanel.destroy();unpatchDate();});QUnit.test('favorites have unique descriptions (the submenus of the favorite menu are correctly updated)',async function(assert){assert.expect(3);const favoriteFilters=[{context:"{}",domain:"[]",id:1,is_default:false,name:"My favorite",sort:"[]",user_id:[2,"Mitchell Admin"],}];const params={cpModelConfig:{favoriteFilters,searchMenuTypes},cpProps:{searchMenuTypes,action:{}},'get-controller-query-params':function(callback){callback();},env:{session:{uid:4},services:{notification:{notify:function(params){assert.deepEqual(params,{message:"Filter with same name already exists.",type:"danger"});},}},dataManager:{create_filter:async function(irFilter){assert.deepEqual(irFilter,{"action_id":undefined,"context":{"group_by":[]},"domain":"[]","is_default":false,"model_id":undefined,"name":"My favorite 2","sort":"[]","user_id":4,});return 2;}}},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFavoriteMenu(controlPanel);await cpHelpers.toggleSaveFavorite(controlPanel);await cpHelpers.editFavoriteName(controlPanel,"My favorite");await cpHelpers.saveFavorite(controlPanel);await cpHelpers.editFavoriteName(controlPanel,"My favorite 2");await cpHelpers.saveFavorite(controlPanel);await cpHelpers.toggleSaveFavorite(controlPanel);await cpHelpers.editFavoriteName(controlPanel,"My favorite 2");await cpHelpers.saveFavorite(controlPanel);controlPanel.destroy();});QUnit.test('save search filter in modal',async function(assert){assert.expect(5);const data={partner:{fields:{date_field:{string:"Date",type:"date",store:true,sortable:true,searchable:true},birthday:{string:"Birthday",type:"date",store:true,sortable:true},foo:{string:"Foo",type:"char",store:true,sortable:true},bar:{string:"Bar",type:"many2one",relation:'partner'},float_field:{string:"Float",type:"float",group_operator:'sum'},},records:[{id:1,display_name:"First record",foo:"yop",bar:2,date_field:"2017-01-25",birthday:"1983-07-15",float_field:1},{id:2,display_name:"Second record",foo:"blip",bar:1,date_field:"2017-01-24",birthday:"1982-06-04",float_field:2},{id:3,display_name:"Third record",foo:"gnap",bar:1,date_field:"2017-01-13",birthday:"1985-09-13",float_field:1.618},{id:4,display_name:"Fourth record",foo:"plop",bar:2,date_field:"2017-02-25",birthday:"1983-05-05",float_field:-1},{id:5,display_name:"Fifth record",foo:"zoup",bar:2,date_field:"2016-01-25",birthday:"1800-01-01",float_field:13},{id:7,display_name:"Partner 6",},{id:8,display_name:"Partner 7",},{id:9,display_name:"Partner 8",},{id:10,display_name:"Partner 9",}],},};const form=await createView({arch:`
                <form string="Partners">
                    <sheet>
                        <group>
                            <field name="bar"/>
                        </group>
                    </sheet>
                </form>`,archs:{'partner,false,list':'<tree><field name="display_name"/></tree>','partner,false,search':'<search><field name="date_field"/></search>',},data,model:'partner',res_id:1,View:FormView,env:{dataManager:{create_filter(filter){assert.strictEqual(filter.name,"Awesome Test Customer Filter","filter name should be correct");},}},});await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown('bar');await testUtils.fields.many2one.clickItem('bar','Search');assert.containsN(document.body,'tr.o_data_row',9,"should display 9 records");await cpHelpers.toggleFilterMenu('.modal');await cpHelpers.toggleAddCustomFilter('.modal');assert.strictEqual(document.querySelector('.o_filter_condition select.o_generator_menu_field').value,'date_field',"date field should be selected");await cpHelpers.applyFilter('.modal');assert.containsNone(document.body,'tr.o_data_row',"should display 0 records");await cpHelpers.toggleFavoriteMenu('.modal');await cpHelpers.toggleSaveFavorite('.modal');const filterNameInput=document.querySelector('.o_add_favorite input[type="text"]');assert.isVisible(filterNameInput,"should display an input field for the filter name");await testUtils.fields.editInput(filterNameInput,'Awesome Test Customer Filter');await testUtils.dom.click(document.querySelector('.o_add_favorite button.btn-primary'));form.destroy();});QUnit.test('modal loads saved search filters',async function(assert){assert.expect(1);const data={partner:{fields:{bar:{string:"Bar",type:"many2one",relation:'partner'},},records:Array.apply(null,Array(10)).map(function(_,i){return{id:i,display_name:"Record "+i,bar:1};})},};const form=await createView({arch:`
                <form string="Partners">
                    <sheet>
                        <group>
                            <field name="bar"/>
                        </group>
                    </sheet>
                </form>`,data,model:'partner',res_id:1,View:FormView,interceptsPropagate:{load_views:function(ev){assert.ok(ev.data.options.load_filters,"opening dialog should load the filters");},},});await testUtils.form.clickEdit(form);await testUtils.fields.many2one.clickOpenDropdown('bar');await testUtils.fields.many2one.clickItem('bar','Search');form.destroy();});});});;

/* /web/static/tests/control_panel/custom_filter_item_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.filter_menu_generator_tests',function(require){"use strict";const Domain=require('web.Domain');const CustomFilterItem=require('web.CustomFilterItem');const ActionModel=require('web/static/src/js/views/action_model.js');const pyUtils=require('web.py_utils');const testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;const{createComponent}=testUtils;QUnit.module('Components',{beforeEach:function(){this.fields={date_field:{name:'date_field',string:"A date",type:'date',searchable:true},date_time_field:{name:'date_time_field',string:"DateTime",type:'datetime',searchable:true},boolean_field:{name:'boolean_field',string:"Boolean Field",type:'boolean',default:true,searchable:true},char_field:{name:'char_field',string:"Char Field",type:'char',default:"foo",trim:true,searchable:true},float_field:{name:'float_field',string:"Floaty McFloatface",type:'float',searchable:true},color:{name:'color',string:"Color",type:'selection',selection:[['black',"Black"],['white',"White"]],searchable:true},};},},function(){QUnit.module('CustomFilterItem');QUnit.test('basic rendering',async function(assert){assert.expect(17);const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},env:{searchModel:new ActionModel(),},});assert.strictEqual(cfi.el.innerText.trim(),"Add Custom Filter");assert.hasClass(cfi.el,'o_generator_menu');assert.strictEqual(cfi.el.children.length,1);await cpHelpers.toggleAddCustomFilter(cfi);assert.containsOnce(cfi,'div.o_filter_condition');assert.containsOnce(cfi,'div.o_filter_condition > select.o_generator_menu_field');assert.containsOnce(cfi,'div.o_filter_condition > select.o_generator_menu_operator');assert.containsOnce(cfi,'div.o_filter_condition > span.o_generator_menu_value');assert.containsNone(cfi,'div.o_filter_condition .o_or_filter');assert.containsNone(cfi,'div.o_filter_condition .o_generator_menu_delete');assert.containsNone(cfi,'div.o_filter_condition > i.o_generator_menu_delete');assert.containsOnce(cfi,'div.o_add_filter_menu');assert.containsOnce(cfi,'div.o_add_filter_menu > button.o_apply_filter');assert.containsOnce(cfi,'div.o_add_filter_menu > button.o_add_condition');assert.containsOnce(cfi,'div.o_filter_condition');await testUtils.dom.click('button.o_add_condition');assert.containsN(cfi,'div.o_filter_condition',2);assert.containsOnce(cfi,'div.o_filter_condition .o_or_filter');assert.containsN(cfi,'div.o_filter_condition .o_generator_menu_delete',2);cfi.destroy();});QUnit.test('selection field: default and updated value',async function(assert){assert.expect(4);let expectedFilters;class MockedSearchModel extends ActionModel{dispatch(method,...args){assert.strictEqual(method,'createNewFilters');const preFilters=args[0];assert.deepEqual(preFilters,expectedFilters);}}
const searchModel=new MockedSearchModel();const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},env:{searchModel},});expectedFilters=[{description:'Color is "black"',domain:'[["color","=","black"]]',type:'filter',}];await cpHelpers.toggleAddCustomFilter(cfi);await testUtils.fields.editSelect(cfi.el.querySelector('.o_generator_menu_field'),'color');await cpHelpers.applyFilter(cfi);expectedFilters=[{description:'Color is "white"',domain:'[["color","=","white"]]',type:'filter',}];await cpHelpers.toggleAddCustomFilter(cfi);await testUtils.fields.editSelect(cfi.el.querySelector('.o_generator_menu_field'),'color');await testUtils.fields.editSelect(cfi.el.querySelector('.o_generator_menu_value select'),'white');await cpHelpers.applyFilter(cfi);cfi.destroy();});QUnit.test('adding a simple filter works',async function(assert){assert.expect(6);delete this.fields.date_field;class MockedSearchModel extends ActionModel{dispatch(method,...args){assert.strictEqual(method,'createNewFilters');const preFilters=args[0];const preFilter=preFilters[0];assert.strictEqual(preFilter.type,'filter');assert.strictEqual(preFilter.description,'Boolean Field is true');assert.strictEqual(preFilter.domain,'[["boolean_field","=",True]]');}}
const searchModel=new MockedSearchModel();const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},env:{searchModel},});await cpHelpers.toggleAddCustomFilter(cfi);await cpHelpers.applyFilter(cfi);assert.strictEqual(cfi.el.children.length,1);assert.containsOnce(cfi,'button.o_add_custom_filter');cfi.destroy();});QUnit.test('commit search with an extended proposition with field char does not cause a crash',async function(assert){assert.expect(12);this.fields.many2one_field={name:'many2one_field',string:"Trululu",type:"many2one",searchable:true};const expectedDomains=[[['many2one_field','ilike',`a`]],[['many2one_field','ilike',`"a"`]],[['many2one_field','ilike',`'a'`]],[['many2one_field','ilike',`'`]],[['many2one_field','ilike',`"`]],[['many2one_field','ilike',`\\`]],];const testedValues=[`a`,`"a"`,`'a'`,`'`,`"`,`\\`];class MockedSearchModel extends ActionModel{dispatch(method,...args){assert.strictEqual(method,'createNewFilters');const preFilters=args[0];const preFilter=preFilters[0];let domain=pyUtils.assembleDomains([preFilter.domain]);domain=Domain.prototype.stringToArray(domain);assert.deepEqual(domain,expectedDomains.shift());}}
const searchModel=new MockedSearchModel();const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},env:{searchModel},});async function testValue(value){await cpHelpers.toggleAddCustomFilter(cfi);await testUtils.fields.editSelect(cfi.el.querySelector('select.o_generator_menu_field'),'many2one_field');await testUtils.fields.editInput(cfi.el.querySelector('div.o_filter_condition > span.o_generator_menu_value input'),value);await cpHelpers.applyFilter(cfi);}
for(const value of testedValues){await testValue(value);}
delete ActionModel.registry.map.testExtension;cfi.destroy();});QUnit.test('custom filter datetime with equal operator',async function(assert){assert.expect(5);class MockedSearchModel extends ActionModel{dispatch(method,...args){assert.strictEqual(method,'createNewFilters');const preFilters=args[0];const preFilter=preFilters[0];assert.strictEqual(preFilter.description,'DateTime is equal to "02/22/2017 11:00:00"',"description should be in localized format");assert.deepEqual(preFilter.domain,'[["date_time_field","=","2017-02-22 15:00:00"]]',"domain should be in UTC format");}}
const searchModel=new MockedSearchModel();const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},session:{getTZOffset(){return-240;},},env:{searchModel},});await cpHelpers.toggleAddCustomFilter(cfi);await testUtils.fields.editSelect(cfi.el.querySelector('.o_generator_menu_field'),'date_time_field');assert.strictEqual(cfi.el.querySelector('.o_generator_menu_field').value,'date_time_field');assert.strictEqual(cfi.el.querySelector('.o_generator_menu_operator').value,'between');await testUtils.fields.editSelect(cfi.el.querySelector('.o_generator_menu_operator'),'=');await testUtils.fields.editSelect(cfi.el.querySelector('div.o_filter_condition > span.o_generator_menu_value input'),'02/22/2017 11:00:00');await cpHelpers.applyFilter(cfi);cfi.destroy();});QUnit.test('custom filter datetime between operator',async function(assert){assert.expect(5);class MockedSearchModel extends ActionModel{dispatch(method,...args){assert.strictEqual(method,'createNewFilters');const preFilters=args[0];const preFilter=preFilters[0];assert.strictEqual(preFilter.description,'DateTime is between "02/22/2017 11:00:00 and 02/22/2017 17:00:00"',"description should be in localized format");assert.deepEqual(preFilter.domain,'[["date_time_field",">=","2017-02-22 15:00:00"]'+',["date_time_field","<=","2017-02-22 21:00:00"]]',"domain should be in UTC format");}}
const searchModel=new MockedSearchModel();const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},session:{getTZOffset(){return-240;},},env:{searchModel},});await cpHelpers.toggleAddCustomFilter(cfi);await testUtils.fields.editSelect(cfi.el.querySelector('.o_generator_menu_field'),'date_time_field');assert.strictEqual(cfi.el.querySelector('.o_generator_menu_field').value,'date_time_field');assert.strictEqual(cfi.el.querySelector('.o_generator_menu_operator').value,'between');const valueInputs=cfi.el.querySelectorAll('.o_generator_menu_value .o_input');await testUtils.fields.editSelect(valueInputs[0],'02/22/2017 11:00:00');await testUtils.fields.editSelect(valueInputs[1],'02-22-2017 17:00:00');await cpHelpers.applyFilter(cfi);cfi.destroy();});QUnit.test('input value parsing',async function(assert){assert.expect(6);const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},env:{searchModel:new ActionModel(),},});await cpHelpers.toggleAddCustomFilter(cfi);await testUtils.dom.click('button.o_add_condition');const[floatSelect,idSelect]=cfi.el.querySelectorAll('.o_generator_menu_field');await testUtils.fields.editSelect(floatSelect,'float_field');await testUtils.fields.editSelect(idSelect,'id');const[floatInput,idInput]=cfi.el.querySelectorAll('.o_generator_menu_value .o_input');assert.strictEqual(floatInput.value,"0.0");assert.strictEqual(idInput.value,"0");await testUtils.fields.editInput(floatInput,4.2);assert.strictEqual(floatInput.value,"4.2");await testUtils.fields.editInput(floatInput,"DefinitelyValidFloat");assert.strictEqual(floatInput.value,"4.2");await testUtils.fields.editInput(idInput,4);assert.strictEqual(idInput.value,"4");await testUtils.fields.editInput(idInput,"DefinitelyValidID");assert.strictEqual(idInput.value,"4");cfi.destroy();});QUnit.test('add custom filter with multiple values',async function(assert){assert.expect(2);class MockedSearchModel extends ActionModel{dispatch(method,...args){assert.strictEqual(method,'createNewFilters');const preFilters=args[0];const expected=[{description:'A date is equal to "01/09/1997"',domain:'[["date_field","=","1997-01-09"]]',type:"filter",},{description:'Boolean Field is true',domain:'[["boolean_field","=",True]]',type:"filter",},{description:'Floaty McFloatface is equal to "7.2"',domain:'[["float_field","=",7.2]]',type:"filter",},{description:'ID is "9"',domain:'[["id","=",9]]',type:"filter",},];assert.deepEqual(preFilters,expected,"Conditions should be in the correct order witht the right values.");}}
const searchModel=new MockedSearchModel();const cfi=await createComponent(CustomFilterItem,{props:{fields:this.fields,},env:{searchModel},});await cpHelpers.toggleAddCustomFilter(cfi);await testUtils.dom.click('button.o_add_condition');await testUtils.dom.click('button.o_add_condition');await testUtils.dom.click('button.o_add_condition');await testUtils.dom.click('button.o_add_condition');function getCondition(index,selector){const condition=cfi.el.querySelectorAll('.o_filter_condition')[index];return condition.querySelector(selector);}
await testUtils.fields.editSelect(getCondition(0,'.o_generator_menu_field'),'date_field');await testUtils.fields.editSelect(getCondition(0,'.o_generator_menu_value .o_input'),'01/09/1997');await testUtils.fields.editSelect(getCondition(1,'.o_generator_menu_field'),'boolean_field');await testUtils.fields.editInput(getCondition(1,'.o_generator_menu_operator'),'!=');await testUtils.fields.editSelect(getCondition(2,'.o_generator_menu_field'),'char_field');await testUtils.fields.editInput(getCondition(2,'.o_generator_menu_value .o_input'),"I will be deleted anyway");await testUtils.fields.editSelect(getCondition(3,'.o_generator_menu_field'),'float_field');await testUtils.fields.editInput(getCondition(3,'.o_generator_menu_value .o_input'),7.2);await testUtils.fields.editSelect(getCondition(4,'.o_generator_menu_field'),'id');await testUtils.fields.editInput(getCondition(4,'.o_generator_menu_value .o_input'),9);await testUtils.dom.click(getCondition(2,'.o_generator_menu_delete'));await cpHelpers.applyFilter(cfi);cfi.destroy();});});});;

/* /web/static/tests/control_panel/filter_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.filter_menu_tests',function(require){"use strict";const testUtils=require('web.test_utils');const{controlPanel:cpHelpers,createControlPanel,mock}=testUtils;const{patchDate}=mock;const searchMenuTypes=['filter'];QUnit.module('Components',{beforeEach:function(){this.fields={date_field:{string:"Date",type:"date",store:true,sortable:true,searchable:true},foo:{string:"Foo",type:"char",store:true,sortable:true},};},},function(){QUnit.module('FilterMenu');QUnit.test('simple rendering with no filter',async function(assert){assert.expect(2);const params={cpModelConfig:{searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);assert.containsNone(controlPanel,'.o_menu_item, .dropdown-divider');assert.containsOnce(controlPanel,'div.o_generator_menu');controlPanel.destroy();});QUnit.test('simple rendering with a single filter',async function(assert){assert.expect(3);const arch=`
                <search>
                    <filter string="Foo" name="foo" domain="[]"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);assert.containsOnce(controlPanel,'.o_menu_item');assert.containsOnce(controlPanel,'.dropdown-divider');assert.containsOnce(controlPanel,'div.o_generator_menu');controlPanel.destroy();});QUnit.test('should have Date and ID field proposed in that order in "Add custom Filter" submenu',async function(assert){assert.expect(2);const params={cpModelConfig:{fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleAddCustomFilter(controlPanel);const optionEls=controlPanel.el.querySelectorAll('div.o_filter_condition > select.o_generator_menu_field option');assert.strictEqual(optionEls[0].innerText.trim(),'Date');assert.strictEqual(optionEls[1].innerText.trim(),'ID');controlPanel.destroy();});QUnit.test('toggle a "simple" filter in filter menu works',async function(assert){assert.expect(9);const domains=[[['foo','=','qsdf']],[]];const arch=`
                <search>
                    <filter string="Foo" name="foo" domain="[['foo', '=', 'qsdf']]"/>
                </search>`;const params={cpModelConfig:{arch,searchMenuTypes},cpProps:{fields:{},searchMenuTypes},search:function(searchQuery){const{domain}=searchQuery;assert.deepEqual(domain,domains.shift());}};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);assert.notOk(cpHelpers.isItemSelected(controlPanel,0));await cpHelpers.toggleMenuItem(controlPanel,"Foo");assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Foo']);assert.containsOnce(controlPanel.el.querySelector('.o_searchview .o_searchview_facet'),'span.fa.fa-filter.o_searchview_facet_label');assert.ok(cpHelpers.isItemSelected(controlPanel,"Foo"));await cpHelpers.toggleMenuItem(controlPanel,"Foo");assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);assert.notOk(cpHelpers.isItemSelected(controlPanel,"Foo"));controlPanel.destroy();});QUnit.test('add a custom filter works',async function(assert){assert.expect(1);const params={cpModelConfig:{fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleAddCustomFilter(controlPanel);await testUtils.fields.editSelect(controlPanel.el.querySelector('div.o_filter_condition > select.o_generator_menu_field'),'id');await testUtils.fields.editInput(controlPanel.el.querySelector('div.o_filter_condition > span.o_generator_menu_value > input'),1);await cpHelpers.applyFilter(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['ID is "1"']);controlPanel.destroy();});QUnit.test('deactivate a new custom filter works',async function(assert){assert.expect(4);const unpatchDate=patchDate(2020,1,5,12,20,0);const params={cpModelConfig:{fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleAddCustomFilter(controlPanel);await cpHelpers.applyFilter(controlPanel);assert.ok(cpHelpers.isItemSelected(controlPanel,'Date is equal to "02/05/2020"'));assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date is equal to "02/05/2020"']);await cpHelpers.toggleMenuItem(controlPanel,'Date is equal to "02/05/2020"');assert.notOk(cpHelpers.isItemSelected(controlPanel,'Date is equal to "02/05/2020"'));assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);controlPanel.destroy();unpatchDate();});QUnit.test('filter by a date field using period works',async function(assert){assert.expect(56);const unpatchDate=patchDate(2017,2,22,1,0,0);const basicDomains=[["&",["date_field",">=","2017-01-01"],["date_field","<=","2017-12-31"]],["&",["date_field",">=","2017-02-01"],["date_field","<=","2017-02-28"]],["&",["date_field",">=","2017-01-01"],["date_field","<=","2017-12-31"]],["&",["date_field",">=","2017-01-01"],["date_field","<=","2017-01-31"]],["|","&",["date_field",">=","2017-01-01"],["date_field","<=","2017-01-31"],"&",["date_field",">=","2017-10-01"],["date_field","<=","2017-12-31"]],["&",["date_field",">=","2017-10-01"],["date_field","<=","2017-12-31"]],["&",["date_field",">=","2017-01-01"],["date_field","<=","2017-12-31"]],["&",["date_field",">=","2017-01-01"],["date_field","<=","2017-03-31"]],["&",["date_field",">=","2017-01-01"],["date_field","<=","2017-12-31"]],["&",["date_field",">=","2017-01-01"],["date_field","<=","2017-12-31"]],["|","&",["date_field",">=","2016-01-01"],["date_field","<=","2016-12-31"],"&",["date_field",">=","2017-01-01"],["date_field","<=","2017-12-31"]],["|","|","&",["date_field",">=","2015-01-01"],["date_field","<=","2015-12-31"],"&",["date_field",">=","2016-01-01"],["date_field","<=","2016-12-31"],"&",["date_field",">=","2017-01-01"],["date_field","<=","2017-12-31"]],["|","|","&",["date_field",">=","2015-03-01"],["date_field","<=","2015-03-31"],"&",["date_field",">=","2016-03-01"],["date_field","<=","2016-03-31"],"&",["date_field",">=","2017-03-01"],["date_field","<=","2017-03-31"]]];const arch=`
                <search>
                    <filter string="Date" name="date_field" date="date_field"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_date_field:1},},cpProps:{fields:this.fields,searchMenuTypes},search:function(searchQuery){const{domain}=searchQuery;if(domain.length){assert.deepEqual(domain,basicDomains.shift());}},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Date");const optionEls=controlPanel.el.querySelectorAll('ul.o_menu_item_options > li.o_item_option > a');const{domain}=controlPanel.getQuery();assert.deepEqual(domain,["&",["date_field",">=","2017-03-01"],["date_field","<=","2017-03-31"]]);assert.ok(cpHelpers.isItemSelected(controlPanel,"Date"));assert.ok(cpHelpers.isOptionSelected(controlPanel,"Date",0));const optionDescriptions=[...optionEls].map(e=>e.innerText.trim());const expectedDescriptions=['March','February','January','Q4','Q3','Q2','Q1','2017','2016','2015'];assert.deepEqual(optionDescriptions,expectedDescriptions);const steps=[{description:'March',facetContent:'Date: 2017',selectedoptions:[7]},{description:'February',facetContent:'Date: February 2017',selectedoptions:[1,7]},{description:'February',facetContent:'Date: 2017',selectedoptions:[7]},{description:'January',facetContent:'Date: January 2017',selectedoptions:[2,7]},{description:'Q4',facetContent:'Date: January 2017/Q4 2017',selectedoptions:[2,3,7]},{description:'January',facetContent:'Date: Q4 2017',selectedoptions:[3,7]},{description:'Q4',facetContent:'Date: 2017',selectedoptions:[7]},{description:'Q1',facetContent:'Date: Q1 2017',selectedoptions:[6,7]},{description:'Q1',facetContent:'Date: 2017',selectedoptions:[7]},{description:'2017',selectedoptions:[]},{description:'2017',facetContent:'Date: 2017',selectedoptions:[7]},{description:'2016',facetContent:'Date: 2016/2017',selectedoptions:[7,8]},{description:'2015',facetContent:'Date: 2015/2016/2017',selectedoptions:[7,8,9]},{description:'March',facetContent:'Date: March 2015/March 2016/March 2017',selectedoptions:[0,7,8,9]}];for(const s of steps){const index=expectedDescriptions.indexOf(s.description);await cpHelpers.toggleMenuItemOption(controlPanel,0,index);if(s.facetContent){assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[s.facetContent]);}else{assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);}
s.selectedoptions.forEach(index=>{assert.ok(cpHelpers.isOptionSelected(controlPanel,0,index),`at step ${steps.indexOf(s) + 1}, option ${expectedDescriptions[index]} should be selected`);});}
controlPanel.destroy();unpatchDate();});QUnit.test('filter by a date field using period works even in January',async function(assert){assert.expect(5);const unpatchDate=patchDate(2017,0,7,3,0,0);const arch=`
                <search>
                    <filter string="Date" name="some_filter" date="date_field" default_period="last_month"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_some_filter:1},},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);const{domain}=controlPanel.getQuery();assert.deepEqual(domain,['&',["date_field",">=","2016-12-01"],["date_field","<=","2016-12-31"]]);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["Date: December 2016"]);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,"Date");assert.ok(cpHelpers.isItemSelected(controlPanel,"Date"));assert.ok(cpHelpers.isOptionSelected(controlPanel,"Date",'December'));assert.ok(cpHelpers.isOptionSelected(controlPanel,"Date",'2016'));controlPanel.destroy();unpatchDate();});QUnit.test('`context` key in <filter> is used',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter string="Filter" name="some_filter" domain="[]" context="{'coucou_1': 1}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},search:function(searchQuery){const{context}=searchQuery;assert.deepEqual(context,{coucou_1:1});},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,0);controlPanel.destroy();});QUnit.test('Filter with JSON-parsable domain works',async function(assert){assert.expect(1);const originalDomain=[['foo','=','Gently Weeps']];const xml_domain=JSON.stringify(originalDomain);const arch=`<search>
                    <filter string="Foo" name="gently_weeps" domain="${_.escape(xml_domain)}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,},cpProps:{fields:this.fields,searchMenuTypes},search:function(searchQuery){const{domain}=searchQuery;assert.deepEqual(domain,originalDomain,'A JSON parsable xml domain should be handled just like any other');},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,0);controlPanel.destroy();});QUnit.test('filter with date attribute set as search_default',async function(assert){assert.expect(1);const unpatchDate=patchDate(2019,6,31,13,43,0);const arch=`<search>
                    <filter string="Date" name="date_field" date="date_field" default_period="last_month"/>
                </search>`,params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_date_field:true}},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["Date: June 2019"]);controlPanel.destroy();unpatchDate();});QUnit.test('filter domains are correcly combined by OR and AND',async function(assert){assert.expect(2);const arch=`<search>
                    <filter string="Filter Group 1" name="f_1_g1" domain="[['foo', '=', 'f1_g1']]"/>
                    <separator/>
                    <filter string="Filter 1 Group 2" name="f1_g2" domain="[['foo', '=', 'f1_g2']]"/>
                    <filter string="Filter 2 GROUP 2" name="f2_g2" domain="[['foo', '=', 'f2_g2']]"/>
                </search>`,params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_f_1_g1:true,search_default_f1_g2:true,search_default_f2_g2:true,}},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);const{domain}=controlPanel.getQuery();assert.deepEqual(domain,['&',['foo','=','f1_g1'],'|',['foo','=','f1_g2'],['foo','=','f2_g2']]);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),["Filter Group 1","Filter 1 Group 2orFilter 2 GROUP 2"]);controlPanel.destroy();});QUnit.test('arch order of groups of filters preserved',async function(assert){assert.expect(12);const arch=`<search>
                    <filter string="1" name="coolName1" date="date_field"/>
                    <separator/>
                    <filter string="2" name="coolName2" date="date_field"/>
                    <separator/>
                    <filter string="3" name="coolName3" domain="[]"/>
                    <separator/>
                    <filter string="4" name="coolName4" domain="[]"/>
                    <separator/>
                    <filter string="5" name="coolName5" domain="[]"/>
                    <separator/>
                    <filter string="6" name="coolName6" domain="[]"/>
                    <separator/>
                    <filter string="7" name="coolName7" domain="[]"/>
                    <separator/>
                    <filter string="8" name="coolName8" domain="[]"/>
                    <separator/>
                    <filter string="9" name="coolName9" domain="[]"/>
                    <separator/>
                    <filter string="10" name="coolName10" domain="[]"/>
                    <separator/>
                    <filter string="11" name="coolName11" domain="[]"/>
                </search>`,params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleFilterMenu(controlPanel);assert.containsN(controlPanel,'.o_filter_menu .o_menu_item',11);const menuItemEls=controlPanel.el.querySelectorAll('.o_filter_menu .o_menu_item');[...menuItemEls].forEach((e,index)=>{assert.strictEqual(e.innerText.trim(),String(index+1));});controlPanel.destroy();});});});;

/* /web/static/tests/control_panel/custom_group_by_item_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.groupby_menu_generator_tests',function(require){"use strict";const CustomGroupByItem=require('web.CustomGroupByItem');const ActionModel=require('web/static/src/js/views/action_model.js');const testUtils=require('web.test_utils');const{createComponent}=testUtils;QUnit.module('Components',{},function(){QUnit.module('CustomGroupByItem');QUnit.test('click on add custom group toggle group selector',async function(assert){assert.expect(6);const cgi=await createComponent(CustomGroupByItem,{props:{fields:[{sortable:true,name:"date",string:'Super Date',type:'date'},],},env:{searchModel:new ActionModel(),},});assert.strictEqual(cgi.el.innerText.trim(),"Add Custom Group");assert.hasClass(cgi.el,'o_generator_menu');assert.strictEqual(cgi.el.children.length,1);await testUtils.dom.click(cgi.el.querySelector('.o_generator_menu button.o_add_custom_group_by'));assert.containsOnce(cgi,'div > select.o_group_by_selector');assert.strictEqual(cgi.el.querySelector('div > select.o_group_by_selector option').innerText.trim(),"Super Date");assert.containsOnce(cgi,'button.o_apply_group_by');cgi.destroy();});QUnit.test('select a field name in Add Custom Group menu properly trigger the corresponding field',async function(assert){assert.expect(4);const fields=[{sortable:true,name:'candlelight',string:'Candlelight',type:'boolean'},];class MockedSearchModel extends ActionModel{dispatch(method,...args){assert.strictEqual(method,'createNewGroupBy');const field=args[0];assert.deepEqual(field,fields[0]);}}
const searchModel=new MockedSearchModel();const cgi=await createComponent(CustomGroupByItem,{props:{fields},env:{searchModel},});await testUtils.dom.click(cgi.el.querySelector('.o_generator_menu button.o_add_custom_group_by'));await testUtils.dom.click(cgi.el.querySelector('.o_generator_menu button.o_apply_group_by'));assert.strictEqual(cgi.el.children.length,1);assert.containsOnce(cgi,'button.o_add_custom_group_by');cgi.destroy();});});});;

/* /web/static/tests/control_panel/groupby_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.groupby_menu_tests',function(require){"use strict";const testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;const{createControlPanel}=testUtils;const searchMenuTypes=['groupBy'];QUnit.module('Components',{beforeEach:function(){this.fields={bar:{string:"Bar",type:"many2one",relation:'partner'},birthday:{string:"Birthday",type:"date",store:true,sortable:true},date_field:{string:"Date",type:"date",store:true,sortable:true},float_field:{string:"Float",type:"float",group_operator:'sum'},foo:{string:"Foo",type:"char",store:true,sortable:true},};},},function(){QUnit.module('GroupByMenu');QUnit.test('simple rendering with neither groupbys nor groupable fields',async function(assert){assert.expect(1);const params={cpModelConfig:{searchMenuTypes},cpProps:{fields:{},searchMenuTypes},};const controlPanel=await createControlPanel(params);assert.containsNone(controlPanel,'.o_menu_item, .dropdown-divider, div.o_generator_menu');controlPanel.destroy();});QUnit.test('simple rendering with no groupby',async function(assert){assert.expect(5);const params={cpModelConfig:{searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);assert.containsNone(controlPanel,'.o_menu_item, .dropdown-divider');assert.containsOnce(controlPanel,'div.o_generator_menu');await cpHelpers.toggleAddCustomGroup(controlPanel);const optionEls=controlPanel.el.querySelectorAll('div.o_generator_menu select.o_group_by_selector option');assert.strictEqual(optionEls[0].innerText.trim(),'Birthday');assert.strictEqual(optionEls[1].innerText.trim(),'Date');assert.strictEqual(optionEls[2].innerText.trim(),'Foo');controlPanel.destroy();});QUnit.test('simple rendering with a single groupby',async function(assert){assert.expect(4);const arch=`
                <search>
                    <filter string="Groupby Foo" name="gb_foo" context="{'group_by': 'foo'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);assert.containsOnce(controlPanel,'.o_menu_item');assert.strictEqual(controlPanel.el.querySelector('.o_menu_item').innerText.trim(),"Groupby Foo");assert.containsOnce(controlPanel,'.dropdown-divider');assert.containsOnce(controlPanel,'div.o_generator_menu');controlPanel.destroy();});QUnit.test('toggle a "simple" groupby in groupby menu works',async function(assert){assert.expect(9);const groupBys=[['foo'],[]];const arch=`
                <search>
                    <filter string="Groupby Foo" name="gb_foo" context="{'group_by': 'foo'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},search:function(searchQuery){const{groupBy}=searchQuery;assert.deepEqual(groupBy,groupBys.shift());},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);assert.notOk(cpHelpers.isItemSelected(controlPanel,0));await cpHelpers.toggleMenuItem(controlPanel,0);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Groupby Foo']);assert.containsOnce(controlPanel.el.querySelector('.o_searchview .o_searchview_facet'),'span.fa.fa-bars.o_searchview_facet_label');assert.ok(cpHelpers.isItemSelected(controlPanel,0));await cpHelpers.toggleMenuItem(controlPanel,0);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);assert.notOk(cpHelpers.isItemSelected(controlPanel,0));controlPanel.destroy();});QUnit.test('toggle a "simple" groupby quickly does not crash',async function(assert){assert.expect(1);const arch=`
                <search>
                    <filter string="Groupby Foo" name="gb_foo" context="{'group_by': 'foo'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);cpHelpers.toggleMenuItem(controlPanel,0);cpHelpers.toggleMenuItem(controlPanel,0);assert.ok(true);controlPanel.destroy();});QUnit.test('remove a "Group By" facet properly unchecks groupbys in groupby menu',async function(assert){assert.expect(5);const arch=`
                <search>
                    <filter string="Groupby Foo" name="gb_foo" context="{'group_by': 'foo'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_gb_foo:1}},cpProps:{fields:this.fields,searchMenuTypes},search:function(searchQuery){const{groupBy}=searchQuery;assert.deepEqual(groupBy,[]);},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);const facetEl=controlPanel.el.querySelector('.o_searchview .o_searchview_facet');assert.strictEqual(facetEl.innerText.trim(),"Groupby Foo");assert.ok(cpHelpers.isItemSelected(controlPanel,0));await testUtils.dom.click(facetEl.querySelector('i.o_facet_remove'));assert.containsNone(controlPanel,'.o_searchview .o_searchview_facet');await cpHelpers.toggleGroupByMenu(controlPanel);assert.notOk(cpHelpers.isItemSelected(controlPanel,0));controlPanel.destroy();});QUnit.test('group by a date field using interval works',async function(assert){assert.expect(21);const groupBys=[['date_field:year','date_field:week'],['date_field:year','date_field:month','date_field:week'],['date_field:year','date_field:month'],['date_field:year'],[]];const arch=`
                <search>
                    <filter string="Date" name="date" context="{'group_by': 'date_field:week'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_date:1}},cpProps:{fields:this.fields,searchMenuTypes},search:function(searchQuery){const{groupBy}=searchQuery;assert.deepEqual(groupBy,groupBys.shift());},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,0);const optionEls=controlPanel.el.querySelectorAll('ul.o_menu_item_options > li.o_item_option > a');const{groupBy}=controlPanel.getQuery();assert.deepEqual(groupBy,['date_field:week']);assert.ok(cpHelpers.isOptionSelected(controlPanel,0,3));const optionDescriptions=[...optionEls].map(e=>e.innerText.trim());const expectedDescriptions=['Year','Quarter','Month','Week','Day'];assert.deepEqual(optionDescriptions,expectedDescriptions);const steps=[{description:'Year',facetContent:'Date: Year>Date: Week',selectedoptions:[0,3]},{description:'Month',facetContent:'Date: Year>Date: Month>Date: Week',selectedoptions:[0,2,3]},{description:'Week',facetContent:'Date: Year>Date: Month',selectedoptions:[0,2]},{description:'Month',facetContent:'Date: Year',selectedoptions:[0]},{description:'Year',selectedoptions:[]},];for(const s of steps){const index=expectedDescriptions.indexOf(s.description);await cpHelpers.toggleMenuItemOption(controlPanel,0,index);if(s.facetContent){assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[s.facetContent]);}else{assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);}
s.selectedoptions.forEach(index=>{assert.ok(cpHelpers.isOptionSelected(controlPanel,0,index));});}
controlPanel.destroy();});QUnit.test('interval options are correctly grouped and ordered',async function(assert){assert.expect(8);const arch=`
                <search>
                    <filter string="Bar" name="bar" context="{'group_by': 'bar'}"/>
                    <filter string="Date" name="date" context="{'group_by': 'date_field'}"/>
                    <filter string="Foo" name="foo" context="{'group_by': 'foo'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_bar:1}},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Bar']);await cpHelpers.toggleGroupByMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,'Date');await cpHelpers.toggleMenuItemOption(controlPanel,'Date','Week');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Bar>Date: Week']);await cpHelpers.toggleMenuItemOption(controlPanel,'Date','Day');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Bar>Date: Week>Date: Day']);await cpHelpers.toggleMenuItemOption(controlPanel,'Date','Year');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Bar>Date: Year>Date: Week>Date: Day']);await cpHelpers.toggleMenuItem(controlPanel,'Foo');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Bar>Date: Year>Date: Week>Date: Day>Foo']);await cpHelpers.toggleMenuItem(controlPanel,'Date');await cpHelpers.toggleMenuItemOption(controlPanel,'Date','Quarter');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Bar>Date: Year>Date: Quarter>Date: Week>Date: Day>Foo']);await cpHelpers.toggleMenuItem(controlPanel,'Bar');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Year>Date: Quarter>Date: Week>Date: Day>Foo']);await cpHelpers.toggleMenuItem(controlPanel,'Date');await cpHelpers.toggleMenuItemOption(controlPanel,'Date','Week');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Year>Date: Quarter>Date: Day>Foo']);controlPanel.destroy();});QUnit.test('the ID field should not be proposed in "Add Custom Group" menu',async function(assert){assert.expect(2);const fields={foo:{string:"Foo",type:"char",store:true,sortable:true},id:{sortable:true,string:'ID',type:'integer'}};const params={cpModelConfig:{searchMenuTypes},cpProps:{fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);await cpHelpers.toggleAddCustomGroup(controlPanel);const optionEls=controlPanel.el.querySelectorAll('div.o_generator_menu select.o_group_by_selector option');assert.strictEqual(optionEls.length,1);assert.strictEqual(optionEls[0].innerText.trim(),"Foo");controlPanel.destroy();});QUnit.test('add a date field in "Add Custome Group" activate a groupby with global default option "month"',async function(assert){assert.expect(4);const fields={date_field:{string:"Date",type:"date",store:true,sortable:true},id:{sortable:true,string:'ID',type:'integer'}};const params={cpModelConfig:{fields,searchMenuTypes},cpProps:{fields,searchMenuTypes},search:function(searchQuery){const{groupBy}=searchQuery;assert.deepEqual(groupBy,['date_field:month']);}};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);await cpHelpers.toggleAddCustomGroup(controlPanel);await cpHelpers.applyGroup(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Month']);assert.ok(cpHelpers.isItemSelected(controlPanel,"Date"));await cpHelpers.toggleMenuItem(controlPanel,"Date");assert.ok(cpHelpers.isOptionSelected(controlPanel,"Date","Month"));controlPanel.destroy();});QUnit.test('default groupbys can be ordered',async function(assert){assert.expect(2);const arch=`
                <search>
                    <filter string="Birthday" name="birthday" context="{'group_by': 'birthday'}"/>
                    <filter string="Date" name="date" context="{'group_by': 'date_field:week'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_birthday:2,search_default_date:1}},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);const{groupBy}=controlPanel.getQuery();assert.deepEqual(groupBy,['date_field:week','birthday:month']);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Week>Birthday: Month']);controlPanel.destroy();});QUnit.test('a separator in groupbys does not cause problems',async function(assert){assert.expect(23);const arch=`
                <search>
                    <filter string="Date" name="coolName" context="{'group_by': 'date_field'}"/>
                    <separator/>
                    <filter string="Bar" name="superName" context="{'group_by': 'bar'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);await cpHelpers.toggleGroupByMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,0);await cpHelpers.toggleMenuItemOption(controlPanel,0,4);assert.ok(cpHelpers.isItemSelected(controlPanel,0));assert.notOk(cpHelpers.isItemSelected(controlPanel,1));assert.ok(cpHelpers.isOptionSelected(controlPanel,0,4),'selected');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Day']);await cpHelpers.toggleMenuItem(controlPanel,1);await cpHelpers.toggleMenuItem(controlPanel,0);assert.ok(cpHelpers.isItemSelected(controlPanel,0));assert.ok(cpHelpers.isItemSelected(controlPanel,1));assert.ok(cpHelpers.isOptionSelected(controlPanel,0,4),'selected');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Day>Bar']);await cpHelpers.toggleMenuItemOption(controlPanel,0,1);assert.ok(cpHelpers.isItemSelected(controlPanel,0));assert.ok(cpHelpers.isItemSelected(controlPanel,1));assert.ok(cpHelpers.isOptionSelected(controlPanel,0,1),'selected');assert.ok(cpHelpers.isOptionSelected(controlPanel,0,4),'selected');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Quarter>Date: Day>Bar']);await cpHelpers.toggleMenuItem(controlPanel,1);await cpHelpers.toggleMenuItem(controlPanel,0);assert.ok(cpHelpers.isItemSelected(controlPanel,0));assert.notOk(cpHelpers.isItemSelected(controlPanel,1));assert.ok(cpHelpers.isOptionSelected(controlPanel,0,1),'selected');assert.ok(cpHelpers.isOptionSelected(controlPanel,0,4),'selected');assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),['Date: Quarter>Date: Day']);await cpHelpers.removeFacet(controlPanel);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);await cpHelpers.toggleGroupByMenu(controlPanel);await cpHelpers.toggleMenuItem(controlPanel,0);assert.notOk(cpHelpers.isItemSelected(controlPanel,0));assert.notOk(cpHelpers.isItemSelected(controlPanel,1));assert.notOk(cpHelpers.isOptionSelected(controlPanel,0,1),'selected');assert.notOk(cpHelpers.isOptionSelected(controlPanel,0,4),'selected');controlPanel.destroy();});QUnit.test('falsy search default groupbys are not activated',async function(assert){assert.expect(2);const arch=`
                <search>
                    <filter string="Birthday" name="birthday" context="{'group_by': 'birthday'}"/>
                    <filter string="Date" name="date" context="{'group_by': 'foo'}"/>
                </search>`;const params={cpModelConfig:{arch,fields:this.fields,searchMenuTypes,context:{search_default_birthday:false,search_default_foo:0}},cpProps:{fields:this.fields,searchMenuTypes},};const controlPanel=await createControlPanel(params);const{groupBy}=controlPanel.getQuery();assert.deepEqual(groupBy,[]);assert.deepEqual(cpHelpers.getFacetTexts(controlPanel),[]);controlPanel.destroy();});});});;

/* /web/static/tests/control_panel/search_bar_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.search_bar_tests',function(require){"use strict";const{Model}=require('web/static/src/js/model.js');const Registry=require("web.Registry");const SearchBar=require('web.SearchBar');const testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;const{createActionManager,createComponent}=testUtils;QUnit.module('Components',{beforeEach:function(){this.data={partner:{fields:{bar:{string:"Bar",type:'many2one',relation:'partner'},birthday:{string:"Birthday",type:'date'},birth_datetime:{string:"Birth DateTime",type:'datetime'},foo:{string:"Foo",type:'char'},},records:[{id:1,display_name:"First record",foo:"yop",bar:2,birthday:'1983-07-15',birth_datetime:'1983-07-15 01:00:00'},{id:2,display_name:"Second record",foo:"blip",bar:1,birthday:'1982-06-04',birth_datetime:'1982-06-04 02:00:00'},{id:3,display_name:"Third record",foo:"gnap",bar:1,birthday:'1985-09-13',birth_datetime:'1985-09-13 03:00:00'},{id:4,display_name:"Fourth record",foo:"plop",bar:2,birthday:'1983-05-05',birth_datetime:'1983-05-05 04:00:00'},{id:5,display_name:"Fifth record",foo:"zoup",bar:2,birthday:'1800-01-01',birth_datetime:'1800-01-01 05:00:00'},],},};this.actions=[{id:1,name:"Partners Action",res_model:'partner',search_view_id:[false,'search'],type:'ir.actions.act_window',views:[[false,'list']],}];this.archs={'partner,false,list':`
                <tree>
                    <field name="foo"/>
                </tree>`,'partner,false,search':`
                <search>
                    <field name="foo"/>
                    <field name="birthday"/>
                    <field name="birth_datetime"/>
                    <field name="bar" context="{'bar': self}"/>
                    <filter string="Date Field Filter" name="positive" date="birthday"/>
                    <filter string="Date Field Groupby" name="coolName" context="{'group_by': 'birthday:day'}"/>
                </search>`,};},},function(){QUnit.module('SearchBar');QUnit.test('basic rendering',async function(assert){assert.expect(1);const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);assert.strictEqual(document.activeElement,actionManager.el.querySelector('.o_searchview input.o_searchview_input'),"searchview input should be focused");actionManager.destroy();});QUnit.test('navigation with facets',async function(assert){assert.expect(4);const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);await cpHelpers.toggleGroupByMenu(actionManager);await cpHelpers.toggleMenuItem(actionManager,0);await cpHelpers.toggleMenuItemOption(actionManager,0,0);assert.containsOnce(actionManager,'.o_searchview .o_searchview_facet',"there should be one facet");assert.strictEqual(document.activeElement,actionManager.el.querySelector('.o_searchview input.o_searchview_input'));await testUtils.dom.triggerEvent(document.activeElement,'keydown',{key:'ArrowLeft'});assert.strictEqual(document.activeElement,actionManager.el.querySelector('.o_searchview .o_searchview_facet'));await testUtils.dom.triggerEvent(document.activeElement,'keydown',{key:'ArrowRight'});assert.strictEqual(document.activeElement,actionManager.el.querySelector('.o_searchview input.o_searchview_input'));actionManager.destroy();});QUnit.test('search date and datetime fields. Support of timezones',async function(assert){assert.expect(4);let searchReadCount=0;const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,session:{getTZOffset(){return 360;}},async mockRPC(route,args){if(route==='/web/dataset/search_read'){switch(searchReadCount){case 0:break;case 1:assert.deepEqual(args.domain,[["birthday","=","1983-07-15"]],"A date should stay what the user has input, but transmitted in server's format");break;case 2:break;case 3:assert.deepEqual(args.domain,[["birth_datetime","=","1983-07-14 18:00:00"]],"A datetime should be transformed in UTC and transmitted in server's format");break;}
searchReadCount++;}
return this._super(...arguments);},});await actionManager.doAction(1);let searchInput=actionManager.el.querySelector('.o_searchview_input');await testUtils.fields.editInput(searchInput,'07/15/1983');await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter'});assert.strictEqual(actionManager.el.querySelector('.o_searchview_facet .o_facet_values').innerText.trim(),'07/15/1983','The format of the date in the facet should be in locale');await testUtils.dom.click($('.o_searchview_facet .o_facet_remove'));searchInput=actionManager.el.querySelector('.o_searchview_input');await testUtils.fields.editInput(searchInput,'07/15/1983 00:00:00');await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter'});assert.strictEqual(actionManager.el.querySelector('.o_searchview_facet .o_facet_values').innerText.trim(),'07/15/1983 00:00:00','The format of the datetime in the facet should be in locale');actionManager.destroy();});QUnit.test("autocomplete menu clickout interactions",async function(assert){assert.expect(9);const fields=this.data.partner.fields;class TestModelExtension extends Model.Extension{get(property){switch(property){case'facets':return[];case'filters':return Object.keys(fields).map((fname,index)=>Object.assign({description:fields[fname].string,fieldName:fname,fieldType:fields[fname].type,id:index,},fields[fname]));default:break;}}}
class MockedModel extends Model{}
MockedModel.registry=new Registry({Test:TestModelExtension,});const searchModel=new MockedModel({Test:{}});const searchBar=await createComponent(SearchBar,{data:this.data,env:{searchModel},props:{fields},});const input=searchBar.el.querySelector('.o_searchview_input');assert.containsNone(searchBar,'.o_searchview_autocomplete');await testUtils.controlPanel.editSearch(searchBar,"Hello there");assert.strictEqual(input.value,"Hello there","input value should be updated");assert.containsOnce(searchBar,'.o_searchview_autocomplete');await testUtils.dom.triggerEvent(input,'keydown',{key:'Escape'});assert.strictEqual(input.value,"","input value should be empty");assert.containsNone(searchBar,'.o_searchview_autocomplete');await testUtils.controlPanel.editSearch(searchBar,"General Kenobi");assert.strictEqual(input.value,"General Kenobi","input value should be updated");assert.containsOnce(searchBar,'.o_searchview_autocomplete');await testUtils.dom.click(document.body);assert.strictEqual(input.value,"","input value should be empty");assert.containsNone(searchBar,'.o_searchview_autocomplete');searchBar.destroy();});QUnit.test('select an autocomplete field',async function(assert){assert.expect(3);let searchReadCount=0;const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,async mockRPC(route,args){if(route==='/web/dataset/search_read'){switch(searchReadCount){case 0:break;case 1:assert.deepEqual(args.domain,[["foo","ilike","a"]]);break;}
searchReadCount++;}
return this._super(...arguments);},});await actionManager.doAction(1);const searchInput=actionManager.el.querySelector('.o_searchview_input');await testUtils.fields.editInput(searchInput,'a');assert.containsN(actionManager,'.o_searchview_autocomplete li',2,"there should be 2 result for 'a' in search bar autocomplete");await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter'});assert.strictEqual(actionManager.el.querySelector('.o_searchview_input_container .o_facet_values').innerText.trim(),"a","There should be a field facet with label 'a'");actionManager.destroy();});QUnit.test('select an autocomplete field with `context` key',async function(assert){assert.expect(9);let searchReadCount=0;const firstLoading=testUtils.makeTestPromise();const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,async mockRPC(route,args){if(route==='/web/dataset/search_read'){switch(searchReadCount){case 0:firstLoading.resolve();break;case 1:assert.deepEqual(args.domain,[["bar","=",1]]);assert.deepEqual(args.context.bar,[1]);break;case 2:assert.deepEqual(args.domain,["|",["bar","=",1],["bar","=",2]]);assert.deepEqual(args.context.bar,[1,2]);break;}
searchReadCount++;}
return this._super(...arguments);},});await actionManager.doAction(1);await firstLoading;assert.strictEqual(searchReadCount,1,"there should be 1 search_read");const searchInput=actionManager.el.querySelector('.o_searchview_input');await testUtils.fields.editInput(searchInput,'record');await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowRight'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter'});assert.strictEqual(actionManager.el.querySelector('.o_searchview_input_container .o_facet_values').innerText.trim(),"First record","the autocompletion facet should be correct");assert.strictEqual(searchReadCount,2,"there should be 2 search_read");await testUtils.fields.editInput(searchInput,'record');await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowRight'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter'});assert.strictEqual(actionManager.el.querySelector('.o_searchview_input_container .o_facet_values').innerText.trim(),"First recordorSecond record","the autocompletion facet should be correct");assert.strictEqual(searchReadCount,3,"there should be 3 search_read");actionManager.destroy();});QUnit.test('no search text triggers a reload',async function(assert){assert.expect(2);this.actions[0].views=[[false,'pivot']];this.archs['partner,false,pivot']=`
            <pivot>
                <field name="foo" type="row"/>
            </pivot>`;let rpcs;const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,mockRPC:function(){rpcs++;return this._super.apply(this,arguments);},});await actionManager.doAction(1);const searchInput=actionManager.el.querySelector('.o_searchview_input');rpcs=0;await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter'});assert.containsNone(actionManager,'.o_searchview_facet_label');assert.strictEqual(rpcs,2,"should have reloaded");actionManager.destroy();});QUnit.test('selecting (no result) triggers a re-render',async function(assert){assert.expect(3);const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);const searchInput=actionManager.el.querySelector('.o_searchview_input');await testUtils.fields.editInput(searchInput,'hello there');await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowRight'});await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown'});assert.strictEqual(actionManager.el.querySelector('.o_searchview_autocomplete .o_selection_focus').innerText.trim(),"(no result)","there should be no result for 'a' in bar");await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter'});assert.containsNone(actionManager,'.o_searchview_facet_label');assert.strictEqual(actionManager.el.querySelector('.o_searchview_input').value,"","the search input should be re-rendered");actionManager.destroy();});QUnit.test('update suggested filters in autocomplete menu with Japanese IME',async function(assert){assert.expect(4);const TEST="TEST";const テスト="テスト";const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);const searchInput=actionManager.el.querySelector('.o_searchview_input');for(let i=0;i<TEST.length;i++){const key=TEST[i].toUpperCase();await testUtils.dom.triggerEvent(searchInput,'keydown',{key,isComposing:true});if(i===0){await testUtils.dom.triggerEvent(searchInput,'compositionstart');}
await testUtils.dom.triggerEvent(searchInput,'keypress',{key,isComposing:true});searchInput.value=TEST.slice(0,i+1);await testUtils.dom.triggerEvent(searchInput,'keyup',{key,isComposing:true});await testUtils.dom.triggerEvent(searchInput,'input',{inputType:'insertCompositionText',isComposing:true});}
assert.containsOnce(actionManager.el,'.o_searchview_autocomplete',"should display autocomplete dropdown menu on typing something in search view");assert.strictEqual(actionManager.el.querySelector('.o_searchview_autocomplete li').innerText.trim(),"Search Foo for: TEST",`1st filter suggestion should be based on typed word "TEST"`);await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'ArrowDown',isComposing:true});await testUtils.dom.triggerEvent(searchInput,'keypress',{key:'ArrowDown',isComposing:true});searchInput.value=テスト;await testUtils.dom.triggerEvent(searchInput,'keyup',{key:'ArrowDown',isComposing:true});await testUtils.dom.triggerEvent(searchInput,'input',{inputType:'insertCompositionText',isComposing:true});assert.strictEqual(actionManager.el.querySelector('.o_searchview_autocomplete li').innerText.trim(),"Search Foo for: テスト",`1st filter suggestion should be updated with soft-selection typed word "テスト"`);await testUtils.dom.triggerEvent(searchInput,'keydown',{key:'Enter',isComposing:true});await testUtils.dom.triggerEvent(searchInput,'keypress',{key:'Enter',isComposing:true});searchInput.value=TEST;await testUtils.dom.triggerEvent(searchInput,'keyup',{key:'Enter',isComposing:true});await testUtils.dom.triggerEvent(searchInput,'input',{inputType:'insertCompositionText',isComposing:true});await testUtils.dom.triggerEvent(searchInput,'compositionend');assert.strictEqual(actionManager.el.querySelector('.o_searchview_autocomplete li').innerText.trim(),"Search Foo for: TEST",`1st filter suggestion should finally be updated with click selection on word "TEST" from IME`);actionManager.destroy();});QUnit.test('open search view autocomplete on paste value using mouse',async function(assert){assert.expect(1);const actionManager=await createActionManager({actions:this.actions,archs:this.archs,data:this.data,});await actionManager.doAction(1);const searchInput=actionManager.el.querySelector('.o_searchview_input');searchInput.value="ABC";await testUtils.dom.triggerEvent(searchInput,'input',{inputType:'insertFromPaste'});await testUtils.nextTick();assert.containsOnce(actionManager,'.o_searchview_autocomplete',"should display autocomplete dropdown menu on paste in search view");actionManager.destroy();});QUnit.test('select autocompleted many2one',async function(assert){assert.expect(5);const archs=Object.assign({},this.archs,{'partner,false,search':`
                    <search>
                        <field name="foo"/>
                        <field name="birthday"/>
                        <field name="birth_datetime"/>
                        <field name="bar" operator="child_of"/>
                    </search>`,});const actionManager=await createActionManager({actions:this.actions,archs,data:this.data,async mockRPC(route,{domain}){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(domain));}
return this._super(...arguments);},});await actionManager.doAction(1);await cpHelpers.editSearch(actionManager,"rec");await testUtils.dom.click(actionManager.el.querySelector('.o_searchview_autocomplete li:last-child'));await cpHelpers.removeFacet(actionManager,0);await cpHelpers.editSearch(actionManager,"rec");await testUtils.dom.click(actionManager.el.querySelector('.o_expand'));await testUtils.dom.click(actionManager.el.querySelector('.o_searchview_autocomplete li.o_menu_item.o_indent'));assert.verifySteps(['[]','[["bar","child_of","rec"]]','[]','[["bar","child_of",1]]',]);actionManager.destroy();});QUnit.test("reference fields are supported in search view",async function(assert){assert.expect(7);this.data.partner.fields.ref={type:'reference',string:"Reference"};this.data.partner.records.forEach((record,i)=>{record.ref=`ref${String(i).padStart(3, "0")}`;});const archs=Object.assign({},this.archs,{'partner,false,search':`
                    <search>
                        <field name="ref"/>
                    </search>`,});const actionManager=await createActionManager({actions:this.actions,archs,data:this.data,async mockRPC(route,{domain}){if(route==='/web/dataset/search_read'){assert.step(JSON.stringify(domain));}
return this._super(...arguments);}});await actionManager.doAction(1);await cpHelpers.editSearch(actionManager,"ref");await cpHelpers.validateSearch(actionManager);assert.containsN(actionManager,".o_data_row",5);await cpHelpers.removeFacet(actionManager,0);await cpHelpers.editSearch(actionManager,"ref002");await cpHelpers.validateSearch(actionManager);assert.containsOnce(actionManager,".o_data_row");assert.verifySteps(['[]','[["ref","ilike","ref"]]','[]','[["ref","ilike","ref002"]]',]);actionManager.destroy();});});});;

/* /web/static/tests/control_panel/search_utils_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.search_utils_tests',function(require){"use strict";const{constructDateDomain}=require('web.searchUtils');const testUtils=require('web.test_utils');const{_t}=require('web.core');const patchDate=testUtils.mock.patchDate;QUnit.module('SearchUtils',function(){QUnit.module('Construct domain');QUnit.test('construct simple domain based on date field (no comparisonOptionId)',function(assert){assert.expect(4);const unpatchDate=patchDate(2020,5,1,13,0,0);const referenceMoment=moment().utc();assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',[]),{domain:"[]",description:"",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_month','this_year']),{domain:`["&", ["date_field", ">=", "2020-06-01"], ["date_field", "<=", "2020-06-30"]]`,description:"June 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['second_quarter','this_year']),{domain:`["&", ["date_field", ">=", "2020-04-01"], ["date_field", "<=", "2020-06-30"]]`,description:"Q2 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_year']),{domain:`["&", ["date_field", ">=", "2020-01-01"], ["date_field", "<=", "2020-12-31"]]`,description:"2020",});unpatchDate();});QUnit.test('construct simple domain based on datetime field (no comparisonOptionId)',function(assert){assert.expect(3);const unpatchDate=patchDate(2020,5,1,13,0,0);const referenceMoment=moment().utc();assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['this_month','this_year']),{domain:`["&", ["date_field", ">=", "2020-06-01 00:00:00"], ["date_field", "<=", "2020-06-30 23:59:59"]]`,description:"June 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['second_quarter','this_year']),{domain:`["&", ["date_field", ">=", "2020-04-01 00:00:00"], ["date_field", "<=", "2020-06-30 23:59:59"]]`,description:"Q2 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['this_year']),{domain:`["&", ["date_field", ">=", "2020-01-01 00:00:00"], ["date_field", "<=", "2020-12-31 23:59:59"]]`,description:"2020",});unpatchDate();});QUnit.test('construct domain based on date field (no comparisonOptionId)',function(assert){assert.expect(3);const unpatchDate=patchDate(2020,0,1,12,0,0);const referenceMoment=moment().utc();assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_month','first_quarter','this_year']),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2020-01-01"], ["date_field", "<=", "2020-01-31"], `+`"&", ["date_field", ">=", "2020-01-01"], ["date_field", "<=", "2020-03-31"]`+"]",description:"January 2020/Q1 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['second_quarter','this_year','last_year']),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2019-04-01"], ["date_field", "<=", "2019-06-30"], `+`"&", ["date_field", ">=", "2020-04-01"], ["date_field", "<=", "2020-06-30"]`+"]",description:"Q2 2019/Q2 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_year','this_month','antepenultimate_month']),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2020-01-01"], ["date_field", "<=", "2020-01-31"], `+`"&", ["date_field", ">=", "2020-11-01"], ["date_field", "<=", "2020-11-30"]`+"]",description:"January 2020/November 2020",});unpatchDate();});QUnit.test('construct domain based on datetime field (no comparisonOptionId)',function(assert){assert.expect(3);const unpatchDate=patchDate(2020,0,1,12,0,0);const referenceMoment=moment().utc();assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['this_month','first_quarter','this_year']),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2020-01-01 00:00:00"], ["date_field", "<=", "2020-01-31 23:59:59"], `+`"&", ["date_field", ">=", "2020-01-01 00:00:00"], ["date_field", "<=", "2020-03-31 23:59:59"]`+"]",description:"January 2020/Q1 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['second_quarter','this_year','last_year']),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2019-04-01 00:00:00"], ["date_field", "<=", "2019-06-30 23:59:59"], `+`"&", ["date_field", ">=", "2020-04-01 00:00:00"], ["date_field", "<=", "2020-06-30 23:59:59"]`+"]",description:"Q2 2019/Q2 2020",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['this_year','this_month','antepenultimate_month']),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2020-01-01 00:00:00"], ["date_field", "<=", "2020-01-31 23:59:59"], `+`"&", ["date_field", ">=", "2020-11-01 00:00:00"], ["date_field", "<=", "2020-11-30 23:59:59"]`+"]",description:"January 2020/November 2020",});unpatchDate();});QUnit.test('construct comparison domain based on date field and option "previous_period"',function(assert){assert.expect(5);const unpatchDate=patchDate(2020,0,1,12,0,0);const referenceMoment=moment().utc();assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_month','first_quarter','this_year'],'previous_period'),{domain:"["+`"|", "|", `+`"&", ["date_field", ">=", "2019-10-01"], ["date_field", "<=", "2019-10-31"], `+`"&", ["date_field", ">=", "2019-11-01"], ["date_field", "<=", "2019-11-30"], `+`"&", ["date_field", ">=", "2019-12-01"], ["date_field", "<=", "2019-12-31"]`+"]",description:"October 2019/November 2019/December 2019",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['second_quarter','this_year','last_year'],'previous_period'),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2018-01-01"], ["date_field", "<=", "2018-03-31"], `+`"&", ["date_field", ">=", "2019-01-01"], ["date_field", "<=", "2019-03-31"]`+"]",description:"Q1 2018/Q1 2019",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_year','antepenultimate_year','this_month','antepenultimate_month'],'previous_period'),{domain:"["+`"|", "|", "|", `+`"&", ["date_field", ">=", "2015-02-01"], ["date_field", "<=", "2015-02-28"], `+`"&", ["date_field", ">=", "2015-12-01"], ["date_field", "<=", "2015-12-31"], `+`"&", ["date_field", ">=", "2017-02-01"], ["date_field", "<=", "2017-02-28"], `+`"&", ["date_field", ">=", "2017-12-01"], ["date_field", "<=", "2017-12-31"]`+"]",description:"February 2015/December 2015/February 2017/December 2017",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_year','last_year'],'previous_period'),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2017-01-01"], ["date_field", "<=", "2017-12-31"], `+`"&", ["date_field", ">=", "2018-01-01"], ["date_field", "<=", "2018-12-31"]`+"]",description:"2017/2018",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['second_quarter','third_quarter','last_year'],'previous_period'),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2018-10-01"], ["date_field", "<=", "2018-12-31"], `+`"&", ["date_field", ">=", "2019-01-01"], ["date_field", "<=", "2019-03-31"]`+"]",description:"Q4 2018/Q1 2019",});unpatchDate();});QUnit.test('construct comparison domain based on datetime field and option "previous_year"',function(assert){assert.expect(3);const unpatchDate=patchDate(2020,5,1,13,0,0);const referenceMoment=moment().utc();assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['this_month','first_quarter','this_year'],'previous_year'),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2019-06-01 00:00:00"], ["date_field", "<=", "2019-06-30 23:59:59"], `+`"&", ["date_field", ">=", "2019-01-01 00:00:00"], ["date_field", "<=", "2019-03-31 23:59:59"]`+"]",description:"June 2019/Q1 2019",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['second_quarter','this_year','last_year'],'previous_year'),{domain:"["+`"|", `+`"&", ["date_field", ">=", "2018-04-01 00:00:00"], ["date_field", "<=", "2018-06-30 23:59:59"], `+`"&", ["date_field", ">=", "2019-04-01 00:00:00"], ["date_field", "<=", "2019-06-30 23:59:59"]`+"]",description:"Q2 2018/Q2 2019",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','datetime',['this_year','antepenultimate_year','this_month','antepenultimate_month'],'previous_year'),{domain:"["+`"|", "|", "|", `+`"&", ["date_field", ">=", "2017-04-01 00:00:00"], ["date_field", "<=", "2017-04-30 23:59:59"], `+`"&", ["date_field", ">=", "2017-06-01 00:00:00"], ["date_field", "<=", "2017-06-30 23:59:59"], `+`"&", ["date_field", ">=", "2019-04-01 00:00:00"], ["date_field", "<=", "2019-04-30 23:59:59"], `+`"&", ["date_field", ">=", "2019-06-01 00:00:00"], ["date_field", "<=", "2019-06-30 23:59:59"]`+"]",description:"April 2017/June 2017/April 2019/June 2019",});unpatchDate();});QUnit.module('Options translation');QUnit.test("Quarter option: custom translation",async function(assert){assert.expect(1);const unpatchDate=patchDate(2020,5,1,13,0,0);const referenceMoment=moment().locale('en');testUtils.mock.patch(_t.database.db,{"Q2":"Deuxième trimestre de l'an de grâce",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['second_quarter','this_year']),{domain:`["&", ["date_field", ">=", "2020-04-01"], ["date_field", "<=", "2020-06-30"]]`,description:"Deuxième trimestre de l'an de grâce 2020",},"Quarter term should be translated");unpatchDate();testUtils.mock.unpatch(_t.database.db);});QUnit.test("Quarter option: right to left",async function(assert){assert.expect(1);const unpatchDate=patchDate(2020,5,1,13,0,0);const referenceMoment=moment().locale('en');testUtils.mock.patch(_t.database.parameters,{direction:"rtl",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['second_quarter','this_year']),{domain:`["&", ["date_field", ">=", "2020-04-01"], ["date_field", "<=", "2020-06-30"]]`,description:"2020 Q2",},"Notation should be right to left");unpatchDate();testUtils.mock.unpatch(_t.database.parameters);});QUnit.test("Quarter option: custom translation and right to left",async function(assert){assert.expect(1);const unpatchDate=patchDate(2020,5,1,13,0,0);const referenceMoment=moment().locale('en');testUtils.mock.patch(_t.database.db,{"Q2":"2e Trimestre",});testUtils.mock.patch(_t.database.parameters,{direction:"rtl",});assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['second_quarter','this_year']),{domain:`["&", ["date_field", ">=", "2020-04-01"], ["date_field", "<=", "2020-06-30"]]`,description:"2020 2e Trimestre",},"Quarter term should be translated and notation should be right to left");unpatchDate();testUtils.mock.unpatch(_t.database.db);testUtils.mock.unpatch(_t.database.parameters);});QUnit.test("Moment.js localization does not affect formatted domain dates",async function(assert){assert.expect(1);const unpatchDate=patchDate(2020,5,1,13,0,0);const initialLocale=moment.locale();moment.defineLocale('addoneForTest',{postformat:function(string){return string.replace(/\d/g,match=>(1+parseInt(match))%10);}});const referenceMoment=moment().locale('addoneForTest');assert.deepEqual(constructDateDomain(referenceMoment,'date_field','date',['this_month','this_year']),{domain:`["&", ["date_field", ">=", "2020-06-01"], ["date_field", "<=", "2020-06-30"]]`,description:"June 3131",},"Numbers in domain should not use addoneForTest locale");moment.locale(initialLocale);moment.updateLocale("addoneForTest",null);unpatchDate();});});});;

/* /web/static/tests/widgets/company_switcher_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.SwitchCompanyMenu_tests',function(require){"use strict";var SwitchCompanyMenu=require('web.SwitchCompanyMenu');var testUtils=require('web.test_utils');async function createSwitchCompanyMenu(params){params=params||{};var target=params.debug?document.body:$('#qunit-fixture');var menu=new SwitchCompanyMenu();await testUtils.mock.addMockEnvironment(menu,params);await menu.appendTo(target)
return menu}
async function initMockCompanyMenu(assert,params){var menu=await createSwitchCompanyMenu({session:{...params.session,setCompanies:function(mainCompanyId,companyIds){assert.equal(mainCompanyId,params.assertMainCompany[0],params.assertMainCompany[1]);assert.equal(_.intersection(companyIds,params.asserCompanies[0]).length,params.asserCompanies[0].length,params.asserCompanies[1]);},}})
await testUtils.dom.click(menu.$('.dropdown-toggle'));return menu}
async function testSwitchCompany(assert,params){assert.expect(2);var menu=await initMockCompanyMenu(assert,params);await testUtils.dom.click(menu.$(`div[data-company-id=${params.company}] div.log_into`));menu.destroy();}
async function testToggleCompany(assert,params){assert.expect(2);var menu=await initMockCompanyMenu(assert,params);await testUtils.dom.click(menu.$(`div[data-company-id=${params.company}] div.toggle_company`));menu.destroy();}
QUnit.module('widgets',{beforeEach:async function(){this.session_mock_multi={user_companies:{current_company:[1,"Company 1"],allowed_companies:[[1,"Company 1"],[2,"Company 2"],[3,"Company 3"]],},user_context:{allowed_company_ids:[1,3]},},this.session_mock_single={user_companies:{current_company:[1,"Company 1"],allowed_companies:[[1,"Company 1"],[2,"Company 2"],[3,"Company 3"]],},user_context:{allowed_company_ids:[1]},}},},function(){QUnit.module('SwitchCompanyMenu',{},function(){QUnit.test("Company switcher basic rendering",async function(assert){assert.expect(6);var menu=await createSwitchCompanyMenu({session:this.session_mock_multi});assert.equal(menu.$('.company_label:contains(Company 1)').length,1,"it should display Company 1")
assert.equal(menu.$('.company_label:contains(Company 2)').length,1,"it should display Company 2")
assert.equal(menu.$('.company_label:contains(Company 3)').length,1,"it should display Company 3")
assert.equal(menu.$('div[data-company-id=1] .fa-check-square').length,1,"Company 1 should be checked")
assert.equal(menu.$('div[data-company-id=2] .fa-square-o').length,1,"Company 2 should not be checked")
assert.equal(menu.$('div[data-company-id=3] .fa-check-square').length,1,"Company 3 should be checked")
menu.destroy();});});QUnit.module('SwitchCompanyMenu',{},function(){QUnit.test("Toggle new company in multiple company mode",async function(assert){await testToggleCompany(assert,{company:2,session:this.session_mock_multi,assertMainCompany:[1,"Main company should not have changed"],asserCompanies:[[1,2,3],"All companies should be activated"],});});QUnit.test("Toggle active company in mutliple company mode",async function(assert){await testToggleCompany(assert,{company:3,session:this.session_mock_multi,assertMainCompany:[1,"Main company should not have changed"],asserCompanies:[[1],"Companies 3 should be unactivated"],});});QUnit.test("Switch main company in mutliple company mode",async function(assert){await testSwitchCompany(assert,{company:3,session:this.session_mock_multi,assertMainCompany:[3,"Main company should switch to Company 3"],asserCompanies:[[1,3],"Companies 1 and 3 should still be active"],});});QUnit.test("Switch new company in mutliple company mode",async function(assert){await testSwitchCompany(assert,{company:2,session:this.session_mock_multi,assertMainCompany:[2,"Company 2 should become the main company"],asserCompanies:[[1,2,3],"Companies 1 and 3 should still be active"],});});QUnit.test("Switch main company in single company mode",async function(assert){await testSwitchCompany(assert,{company:3,session:this.session_mock_single,assertMainCompany:[3,"Main company should switch to Company 3"],asserCompanies:[[3],"Companies 1 should no longer be active"],});});QUnit.test("Toggle new company in single company mode",async function(assert){await testToggleCompany(assert,{company:3,session:this.session_mock_single,assertMainCompany:[1,"Company 1 should still be the main company"],asserCompanies:[[1,3],"Company 3 should be activated"],});});});});});;

/* /web/static/tests/widgets/data_export_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.data_export_tests',function(require){"use strict";const data=require('web.data');const framework=require('web.framework');const ListView=require('web.ListView');const testUtils=require('web.test_utils');const cpHelpers=testUtils.controlPanel;const createView=testUtils.createView;QUnit.module('widgets',{beforeEach:function(){this.data={'partner':{fields:{foo:{string:"Foo",type:"char"},bar:{string:"Bar",type:"char"},},records:[{id:1,foo:"yop",bar:"bar-blup",},{id:2,foo:"yop",bar:"bar-yop",},{id:3,foo:"blup",bar:"bar-blup",}]},'ir.exports':{fields:{name:{string:"Name",type:"char"},},records:[],},};this.mockSession={async user_has_group(g){return g==='base.group_allow_export';}}
this.mockDataExportRPCs=function(route){if(route==='/web/export/formats'){return Promise.resolve([{tag:'csv',label:'CSV'},{tag:'xls',label:'Excel'},]);}
if(route==='/web/export/get_fields'){return Promise.resolve([{field_type:"one2many",string:"Activities",required:false,value:"activity_ids/id",id:"activity_ids",params:{"model":"mail.activity","prefix":"activity_ids","name":"Activities"},relation_field:"res_id",children:true,},{children:false,field_type:'char',id:"foo",relation_field:null,required:false,string:'Foo',value:"foo",}]);}
return this._super.apply(this,arguments);};}},function(){QUnit.module('Data Export');QUnit.test('exporting all data in list view',async function(assert){assert.expect(8);var blockUI=framework.blockUI;var unblockUI=framework.unblockUI;framework.blockUI=function(){assert.step('block UI');};framework.unblockUI=function(){assert.step('unblock UI');};var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="foo"/></tree>',viewOptions:{hasActionMenus:true,},mockRPC:this.mockDataExportRPCs,session:{...this.mockSession,get_file:function(params){assert.step(params.url);params.complete();},},});await testUtils.dom.click(list.$('thead th.o_list_record_selector input'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,'Export');assert.strictEqual($('.modal').length,1,"a modal dialog should be open");assert.strictEqual($('div.o_tree_column:contains(Activities)').length,1,"the Activities field should be in the list of exportable fields");assert.strictEqual($('.modal .o_export_field').length,1,"There should be only one export field");assert.strictEqual($('.modal .o_export_field').data('field_id'),'foo',"There should be only one export field");await testUtils.dom.click($('.modal .o_tree_column:contains(Foo) .o_add_field'));await testUtils.dom.click($('.modal span:contains(Export)'));await testUtils.dom.click($('.modal span:contains(Close)'));list.destroy();framework.blockUI=blockUI;framework.unblockUI=unblockUI;assert.verifySteps(['block UI','/web/export/csv','unblock UI',]);});QUnit.test('exporting data in list view (multi pages)',async function(assert){assert.expect(4);let expectedData;const list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree limit="2"><field name="foo"/></tree>',domain:[['id','<',1000]],viewOptions:{hasActionMenus:true,},mockRPC:this.mockDataExportRPCs,session:{...this.mockSession,get_file:function(params){const data=JSON.parse(params.data.data);assert.deepEqual({ids:data.ids,domain:data.domain},expectedData);params.complete();},},});expectedData={ids:[1,2],domain:[['id','<',1000]],};await testUtils.dom.click(list.$('thead th.o_list_record_selector input'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,'Export');assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal span:contains(Export)'));await testUtils.dom.click($('.modal span:contains(Close)'));expectedData={ids:false,domain:[['id','<',1000]],};await testUtils.dom.click(list.$('.o_list_selection_box .o_list_select_domain'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,'Export');assert.containsOnce(document.body,'.modal');await testUtils.dom.click($('.modal span:contains(Export)'));await testUtils.dom.click($('.modal span:contains(Close)'));list.destroy();});QUnit.test('saving fields list when exporting data',async function(assert){assert.expect(4);var create=data.DataSet.prototype.create;data.DataSet.prototype.create=function(){assert.step('create');return Promise.resolve([]);};var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="foo"/></tree>',viewOptions:{hasActionMenus:true,},session:this.mockSession,mockRPC:this.mockDataExportRPCs,});await testUtils.dom.click(list.$('thead th.o_list_record_selector input'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,'Export');assert.strictEqual($('.modal').length,1,"a modal dialog should be open");await testUtils.dom.click($('.modal .o_export_tree_item:contains(Activities) .o_add_field'));assert.strictEqual($('.modal .o_fields_list .o_export_field').length,2,"there should be two items in the fields list");await testUtils.fields.editAndTrigger($('.modal .o_exported_lists_select'),'new_template',['change']);await testUtils.fields.editInput($('.modal .o_save_list .o_save_list_name'),'fields list');await testUtils.dom.click($('.modal .o_save_list .o_save_list_btn'));assert.verifySteps(['create'],"create should have been called");await testUtils.dom.click($('.modal button span:contains(Close)'));list.destroy();data.DataSet.prototype.create=create;});QUnit.test('Export dialog UI test',async function(assert){assert.expect(5);var list=await createView({View:ListView,model:'partner',data:this.data,arch:'<tree><field name="foo"/></tree>',viewOptions:{hasActionMenus:true,},session:this.mockSession,mockRPC:this.mockDataExportRPCs,});await testUtils.dom.click(list.$('thead th.o_list_record_selector input'));await cpHelpers.toggleActionMenu(list);await cpHelpers.toggleMenuItem(list,'Export');assert.strictEqual($('.modal .o_export_tree_item:visible').length,2,"There should be only two items visible");await testUtils.dom.click($('.modal .o_export_search_input'));$('.modal .o_export_search_input').val('Activities').trigger($.Event('input',{keyCode:65,}));assert.strictEqual($('.modal .o_export_tree_item:visible').length,1,"Only match item visible");await testUtils.dom.click($('.modal div:contains(Activities) .o_add_field'));assert.strictEqual($('.modal .o_fields_list li').length,2,"There should be two fields in export field list.");assert.strictEqual($('.modal .o_fields_list li:eq(1)').text(),"Activities","string of second field in export list should be 'Activities'");await testUtils.dom.click($('.modal .o_fields_list li:first .o_remove_field'));assert.strictEqual($('.modal .o_fields_list li').length,1,"There should be only one field in list");list.destroy();});QUnit.test('Direct export button invisible',async function(assert){assert.expect(1)
let list=await createView({View:ListView,model:'partner',data:this.data,arch:`<tree export_xlsx="0"><field name="foo"/></tree>`,session:this.mockSession,});assert.containsNone(list,'.o_list_export_xlsx')
list.destroy();});QUnit.test('Direct export list ',async function(assert){assert.expect(2);let list=await createView({View:ListView,model:'partner',data:this.data,arch:`
                <tree export_xlsx="1">
                    <field name="foo"/>
                    <field name="bar"/>
                </tree>`,domain:[['bar','!=','glou']],session:{...this.mockSession,get_file(args){let data=JSON.parse(args.data.data);assert.strictEqual(args.url,'/web/export/xlsx',"should call get_file with the correct url");assert.deepEqual(data,{context:{},model:'partner',domain:[['bar','!=','glou']],groupby:[],ids:false,import_compat:false,fields:[{name:'foo',label:'Foo',},{name:'bar',label:'Bar',}]},"should be called with correct params");args.complete();},},});await testUtils.dom.click(list.$buttons.find('.o_list_export_xlsx'));list.destroy();});QUnit.test('Direct export grouped list ',async function(assert){assert.expect(2);let list=await createView({View:ListView,model:'partner',data:this.data,arch:`
                <tree>
                    <field name="foo"/>
                    <field name="bar"/>
                </tree>`,groupBy:['foo','bar'],domain:[['bar','!=','glou']],session:{...this.mockSession,get_file(args){let data=JSON.parse(args.data.data);assert.strictEqual(args.url,'/web/export/xlsx',"should call get_file with the correct url");assert.deepEqual(data,{context:{},model:'partner',domain:[['bar','!=','glou']],groupby:['foo','bar'],ids:false,import_compat:false,fields:[{name:'foo',label:'Foo',},{name:'bar',label:'Bar',}]},"should be called with correct params");args.complete();},},});await testUtils.dom.click(list.$buttons.find('.o_list_export_xlsx'));list.destroy();});});});;

/* /web/static/tests/widgets/domain_selector_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.domain_selector_tests',function(require){"use strict";var DomainSelector=require("web.DomainSelector");var testUtils=require("web.test_utils");QUnit.module('widgets',{},function(){QUnit.module('DomainSelector',{beforeEach:function(){this.data={partner:{fields:{foo:{string:"Foo",type:"char",searchable:true},bar:{string:"Bar",type:"boolean",searchable:true},nice_datetime:{string:"Datetime",type:"datetime",searchable:true},product_id:{string:"Product",type:"many2one",relation:"product",searchable:true},},records:[{id:1,foo:"yop",bar:true,product_id:37,},{id:2,foo:"blip",bar:true,product_id:false,},{id:4,foo:"abc",bar:false,product_id:41,}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char",searchable:true}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},};},},function(){QUnit.test("creating a domain from scratch",async function(assert){assert.expect(13);var $target=$("#qunit-fixture");var domainSelector=new DomainSelector(null,"partner",[],{readonly:false,debugMode:true,});await testUtils.mock.addMockEnvironment(domainSelector,{data:this.data});await domainSelector.appendTo($target);var $domainAddFirstNodeButton=domainSelector.$(".o_domain_add_first_node_button:visible");assert.strictEqual($domainAddFirstNodeButton.length,1,"there should be a button to create first domain element");await testUtils.dom.click($domainAddFirstNodeButton);var $fieldSelector=domainSelector.$(".o_field_selector:visible");assert.strictEqual($fieldSelector.length,1,"there should be a field selector");$fieldSelector.trigger('focusin');await testUtils.nextTick();var $fieldSelectorPopover=$fieldSelector.find(".o_field_selector_popover:visible");assert.strictEqual($fieldSelectorPopover.length,1,"field selector popover should be visible");var $lis=$fieldSelectorPopover.find("li");var $barLi=$();$lis.each(function(){var $li=$(this);if($li.html().indexOf("Bar")>=0){$barLi=$li;}});assert.strictEqual($barLi.length,1,"field selector popover should contain the 'Bar' field");await testUtils.dom.click($barLi);assert.strictEqual(domainSelector.$(".o_domain_debug_input").val(),'[["bar","=",True]]',"the domain input should contain a domain with 'bar'");var $plus=domainSelector.$(".fa-plus-circle");assert.strictEqual($plus.length,1,"there should be a '+' button");await testUtils.dom.click($plus);assert.strictEqual(domainSelector.$(".o_domain_debug_input").val(),'["&",["bar","=",True],["id","=",1]]',"the domain input should contain a domain with 'bar' and 'id'");var $dots=domainSelector.$(".fa-ellipsis-h");assert.strictEqual($dots.length,2,"there should be two '...' buttons");await testUtils.dom.click($dots.first());assert.strictEqual(domainSelector.$(".o_domain_debug_input").val(),'["&","&",["bar","=",True],"|",["id","=",1],["id","=",1],["id","=",1]]',"the domain input should contain a domain with 'bar', 'id' and a subgroup");domainSelector.$(".o_domain_debug_input").val('["&","&",["bar","=",True],"|",["foo","=","hello"],["id","=",1],["id","=",1]]').change();await testUtils.nextTick();assert.strictEqual(domainSelector.$(".o_field_selector").eq(1).find("input.o_field_selector_debug").val(),"foo","the second field selector should now contain the 'foo' value");assert.ok(domainSelector.$(".o_domain_leaf_operator_select").eq(1).html().indexOf("contains")>=0,"the second operator selector should now contain the 'contains' operator");var $minus=domainSelector.$(".o_domain_delete_node_button");assert.strictEqual($minus.length,5,"there should be five 'x' buttons");await testUtils.dom.click($minus.last());await testUtils.dom.click(domainSelector.$(".o_domain_delete_node_button").last());assert.strictEqual(domainSelector.$(".o_domain_debug_input").val(),'["&",["bar","=",True],["foo","=","hello"]]',"the domain input should contain a domain with 'bar' and 'foo'");domainSelector.destroy();});QUnit.test("building a domain with a datetime",async function(assert){assert.expect(2);var $target=$("#qunit-fixture");var domainSelector=new DomainSelector(null,"partner",[["nice_datetime","=","2017-03-27 15:42:00"]],{readonly:false,});await testUtils.mock.addMockEnvironment(domainSelector,{data:this.data});await domainSelector.appendTo($target);var $datepicker=domainSelector.$(".o_datepicker:visible");assert.strictEqual($datepicker.length,1,"there should be a datepicker");var val=$datepicker.find('input').val();await testUtils.dom.openDatepicker($datepicker);await testUtils.dom.clickFirst($('.bootstrap-datetimepicker-widget :not(.today)[data-action="selectDay"]'));assert.notEqual(domainSelector.$(".o_datepicker:visible input").val(),val,"datepicker value should have changed");await testUtils.dom.click($('.bootstrap-datetimepicker-widget a[data-action=close]'));domainSelector.destroy();});QUnit.test("building a domain with a m2o without following the relation",async function(assert){assert.expect(1);var $target=$("#qunit-fixture");var domainSelector=new DomainSelector(null,"partner",[["product_id","ilike",1]],{debugMode:true,readonly:false,});await testUtils.mock.addMockEnvironment(domainSelector,{data:this.data});await domainSelector.appendTo($target);await testUtils.fields.editAndTrigger(domainSelector.$('.o_domain_leaf_value_input'),'pad',['input','change']);assert.strictEqual(domainSelector.$('.o_domain_debug_input').val(),'[["product_id","ilike","pad"]]',"string should have been allowed as m2o value");domainSelector.destroy();});QUnit.test("editing a domain with `parent` key",async function(assert){assert.expect(1);var $target=$("#qunit-fixture");var domainSelector=new DomainSelector(null,"product","[['name','=',parent.foo]]",{debugMode:true,readonly:false,});await testUtils.mock.addMockEnvironment(domainSelector,{data:this.data});await domainSelector.appendTo($target);assert.strictEqual(domainSelector.$el.text(),"This domain is not supported.","an error message should be displayed because of the `parent` key");domainSelector.destroy();});QUnit.test("creating a domain with a default option",async function(assert){assert.expect(1);var $target=$("#qunit-fixture");var domainSelector=new DomainSelector(null,"partner",[],{readonly:false,debugMode:true,default:[["foo","=","kikou"]],});await testUtils.mock.addMockEnvironment(domainSelector,{data:this.data});await domainSelector.appendTo($target);await testUtils.dom.click(domainSelector.$(".o_domain_add_first_node_button:visible"));assert.strictEqual(domainSelector.$(".o_domain_debug_input").val(),'[["foo","=","kikou"]]',"the domain input should contain the default domain");domainSelector.destroy();});});});});;

/* /web/static/tests/widgets/model_field_selector_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.model_field_selector_tests',function(require){"use strict";var ModelFieldSelector=require("web.ModelFieldSelector");var testUtils=require("web.test_utils");QUnit.module('widgets',{},function(){QUnit.module('ModelFieldSelector',{beforeEach:function(){this.data={partner:{fields:{foo:{string:"Foo",type:"char",searchable:true},bar:{string:"Bar",type:"boolean",searchable:true},product_id:{string:"Product",type:"many2one",relation:"product",searchable:true},},records:[{id:1,foo:"yop",bar:true,product_id:37,},{id:2,foo:"blip",bar:true,product_id:false,},{id:4,foo:"abc",bar:false,product_id:41,}],onchanges:{},},product:{fields:{name:{string:"Product Name",type:"char",searchable:true}},records:[{id:37,display_name:"xphone",},{id:41,display_name:"xpad",}]},};},},function(){QUnit.test("creating a field chain from scratch",async function(assert){assert.expect(14);var $target=$("#qunit-fixture");var fieldSelector=new ModelFieldSelector(null,"partner",[],{readonly:false,debugMode:true,});await testUtils.mock.addMockEnvironment(fieldSelector,{data:this.data});await fieldSelector.appendTo($target);var $value=fieldSelector.$("> .o_field_selector_value");fieldSelector.$el.trigger('focusin');var $fieldSelectorPopover=fieldSelector.$(".o_field_selector_popover:visible");assert.strictEqual($fieldSelectorPopover.length,1,"field selector popover should be visible");var $lis=$fieldSelectorPopover.find("li");var $barLi=$();$lis.each(function(){var $li=$(this);if($li.html().indexOf("Bar")>=0){$barLi=$li;}});assert.strictEqual($barLi.length,1,"field selector popover should contain the 'Bar' field");await testUtils.dom.click($barLi);assert.notOk($fieldSelectorPopover.is("visible"),"field selector popover should be closed now");assert.strictEqual(getValueFromDOM($value),"Bar","field selector value should be displayed with a 'Bar' tag");assert.deepEqual(fieldSelector.getSelectedField(),{model:"partner",name:"bar",searchable:true,string:"Bar",type:"boolean",},"the selected field should be correctly set");fieldSelector.$el.trigger('focusin');await testUtils.nextTick();assert.ok($fieldSelectorPopover.is(":visible"),"field selector popover should be visible");$lis=$fieldSelectorPopover.find("li");var $productLi=$();$lis.each(function(){var $li=$(this);if($li.html().indexOf("Product")>=0){$productLi=$li;}});assert.strictEqual($productLi.length,1,"field selector popover should contain the 'Product' field");await testUtils.dom.click($productLi);$lis=$fieldSelectorPopover.find("li");assert.strictEqual($lis.length,1,"there should be only one field proposition for 'product' model");assert.ok($lis.first().html().indexOf("Product Name")>=0,"the name of the only suggestion should be 'Product Name'");await testUtils.dom.click($lis.first());assert.notOk($fieldSelectorPopover.is("visible"),"field selector popover should be closed now");assert.strictEqual(getValueFromDOM($value),"Product -> Product Name","field selector value should be displayed with two tags: 'Product' and 'Product Name'");fieldSelector.$el.trigger('focusin');await testUtils.nextTick();await testUtils.dom.click(fieldSelector.$('.o_field_selector_prev_page'));await testUtils.dom.click(fieldSelector.$('.o_field_selector_close'));fieldSelector.$el.trigger('focusin');await testUtils.nextTick();$fieldSelectorPopover=fieldSelector.$(".o_field_selector_popover:visible");$lis=$fieldSelectorPopover.find("li");$productLi=$();$lis.each(function(){var $li=$(this);if($li.html().indexOf("Product")>=0){$productLi=$li;}});assert.strictEqual($productLi.length,1,"field selector popover should contain the 'Product' field");await testUtils.dom.click($productLi);$lis=$fieldSelectorPopover.find("li");await testUtils.dom.click($lis.first());assert.notOk($fieldSelectorPopover.is("visible"),"field selector popover should be closed now");assert.strictEqual(getValueFromDOM($value),"Product -> Product Name","field selector value should be displayed with two tags: 'Product' and 'Product Name'");fieldSelector.destroy();function getValueFromDOM($dom){return _.map($dom.find(".o_field_selector_chain_part"),function(part){return $(part).text().trim();}).join(" -> ");}});QUnit.test("default field chain should set the page data correctly",async function(assert){assert.expect(3);var $target=$("#qunit-fixture");var fieldSelector=new ModelFieldSelector(null,"partner",['product_id'],{readonly:false,debugMode:true,});await testUtils.addMockEnvironment(fieldSelector,{data:this.data});await fieldSelector.appendTo($target);fieldSelector.$el.trigger('focusin');var $fieldSelectorPopover=fieldSelector.$(".o_field_selector_popover:visible");assert.strictEqual($fieldSelectorPopover.length,1,"field selector popover should be visible");var $lis=$fieldSelectorPopover.find("li");assert.strictEqual($lis.length,1,"there should be only one field proposition for 'product' model");assert.ok($lis.first().html().indexOf("Product Name")>=0,"the name of the only suggestion should be 'Product Name'");fieldSelector.destroy();});QUnit.test("use the filter option",async function(assert){assert.expect(2);var $target=$("#qunit-fixture");var fieldSelector=new ModelFieldSelector(null,"partner",[],{readonly:false,filter:function(field){return field.type==='many2one';},});await testUtils.mock.addMockEnvironment(fieldSelector,{data:this.data});await fieldSelector.appendTo($target);fieldSelector.$el.trigger('focusin');await testUtils.nextTick();var $fieldSelectorPopover=fieldSelector.$(".o_field_selector_popover:visible");var $lis=$fieldSelectorPopover.find("li");assert.strictEqual($lis.length,1,"there should only be one element");assert.strictEqual($lis.text().trim(),"Product","the available field should be the many2one");fieldSelector.destroy();});QUnit.test("default `showSearchInput` option",async function(assert){assert.expect(6);var $target=$("#qunit-fixture");var fieldSelector=new ModelFieldSelector(null,"partner",[],{readonly:false,});await testUtils.mock.addMockEnvironment(fieldSelector,{data:this.data});await fieldSelector.appendTo($target);fieldSelector.$el.trigger('focusin');await testUtils.nextTick();var $fieldSelectorPopover=fieldSelector.$(".o_field_selector_popover:visible");var $searchInput=$fieldSelectorPopover.find(".o_field_selector_search input");assert.strictEqual($searchInput.length,1,"there should be a search input");assert.strictEqual($fieldSelectorPopover.find("li").length,3,"there should be three available fields");assert.strictEqual($fieldSelectorPopover.find("li").text().trim().replace(/\s+/g,' '),"Bar Foo Product","the available field should be correct");await testUtils.fields.editAndTrigger($searchInput,'xx','keyup');assert.strictEqual($fieldSelectorPopover.find("li").length,0,"there shouldn't be any element");await testUtils.fields.editAndTrigger($searchInput,'Pro','keyup');assert.strictEqual($fieldSelectorPopover.find("li").length,1,"there should only be one element");assert.strictEqual($fieldSelectorPopover.find("li").text().trim().replace(/\s+/g,' '),"Product","the available field should be the Product");fieldSelector.destroy();});QUnit.test("false `showSearchInput` option",async function(assert){assert.expect(1);var $target=$("#qunit-fixture");var fieldSelector=new ModelFieldSelector(null,"partner",[],{readonly:false,showSearchInput:false,});await testUtils.mock.addMockEnvironment(fieldSelector,{data:this.data});await fieldSelector.appendTo($target);fieldSelector.$el.trigger('focusin');await testUtils.nextTick();var $fieldSelectorPopover=fieldSelector.$(".o_field_selector_popover:visible");var $searchInput=$fieldSelectorPopover.find(".o_field_selector_search input");assert.strictEqual($searchInput.length,0,"there should be no search input");fieldSelector.destroy();});QUnit.test("create a field chain with value 1 i.e. TRUE_LEAF",async function(assert){assert.expect(1);var $target=$("#qunit-fixture");var fieldSelector=new ModelFieldSelector(null,"partner",["1"],{readonly:false,showSearchInput:false,});await testUtils.mock.addMockEnvironment(fieldSelector,{data:this.data});await fieldSelector.appendTo($target);var $fieldName=fieldSelector.$('.o_field_selector_chain_part');assert.strictEqual($fieldName.text().trim(),"1","field name value should be 1.");fieldSelector.destroy();});QUnit.test("create a field chain with value 0 i.e. FALSE_LEAF",async function(assert){assert.expect(1);var $target=$("#qunit-fixture");var fieldSelector=new ModelFieldSelector(null,"partner",["0"],{readonly:false,showSearchInput:false,});await testUtils.mock.addMockEnvironment(fieldSelector,{data:this.data});await fieldSelector.appendTo($target);var $fieldName=fieldSelector.$('.o_field_selector_chain_part');assert.strictEqual($fieldName.text().trim(),"0","field name value should be 0.");fieldSelector.destroy();});});});});;

/* /web/static/tests/widgets/rainbow_man_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.RainbowMan_tests',function(require){"use strict";var RainbowMan=require('web.RainbowMan');QUnit.module('widgets',{},function(){QUnit.module('RainbowMan',{beforeEach:function(){this.data={message:'Congrats!',};},},function(){QUnit.test("rendering a rainbowman",function(assert){var done=assert.async();assert.expect(2);var $target=$("#qunit-fixture");var rainbowman=new RainbowMan(this.data);rainbowman.appendTo($target).then(function(){var $rainbow=rainbowman.$(".o_reward_rainbow");assert.strictEqual($rainbow.length,1,"Should have displayed rainbow effect");assert.ok(rainbowman.$('.o_reward_msg_content').html()==='Congrats!',"Card on the rainbowman should display 'Congrats!' message");rainbowman.destroy();done();});});});});});;

/* /web/static/tests/tools/debug_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.debugManagerTests',function(require){"use strict";var testUtils=require('web.test_utils');var FormView=require('web.FormView');var createDebugManager=testUtils.createDebugManager;QUnit.module('DebugManager',{},function(){QUnit.test("list: edit view menu item",async function(assert){assert.expect(3);var debugManager=await createDebugManager();await debugManager.appendTo($('#qunit-fixture'));var action={views:[{displayName:"List",fieldsView:{view_id:1,},type:"list",}],};var view={viewType:"list",};await testUtils.nextTick();await debugManager.update('action',action,view);var $editView=debugManager.$('a[data-action=edit][data-model="ir.ui.view"]');assert.strictEqual($editView.length,1,"should have edit view menu item");assert.strictEqual($editView.text().trim(),"Edit View: List","should have correct menu item text for editing view");assert.strictEqual($editView.data('id'),1,"should have correct view_id");debugManager.destroy();});QUnit.test("form: Manage Attachments option",async function(assert){assert.expect(3);var debugManager=await createDebugManager({intercepts:{do_action:function(event){assert.deepEqual(event.data.action,{context:{default_res_model:"test.model",default_res_id:5,},domain:[["res_model","=","test.model"],["res_id","=",5]],name:"Manage Attachments",res_model:"ir.attachment",type:"ir.actions.act_window",views:[[false,"list"],[false,"form"]],});},},});await debugManager.appendTo($('#qunit-fixture'));var action={views:[{displayName:"Form",fieldsView:{view_id:2,},type:"form",}],res_model:"test.model",};var view={viewType:"form",getSelectedIds:function(){return[5];},};await debugManager.update('action',action,view);var $attachmentMenu=debugManager.$('a[data-action=get_attachments]');assert.strictEqual($attachmentMenu.length,1,"should have Manage Attachments menu item");assert.strictEqual($attachmentMenu.text().trim(),"Manage Attachments","should have correct menu item text");await testUtils.dom.click(debugManager.$('> a'));await testUtils.dom.click($attachmentMenu);debugManager.destroy();});QUnit.test("Debug: Set defaults with right model",async function(assert){assert.expect(2);var data={partner:{fields:{foo:{string:"Foo",type:"char",default:"My little Foo Value"},},records:[{id:1,foo:"yop",}]},'ir.default':{fields:{},},};var form=await testUtils.createView({View:FormView,model:'partner',data:data,arch:'<form string="Partners">'+'<field name="foo" />'+'</form>',res_id:1,});var debugManager=await createDebugManager({data:data,mockRPC:function(route,args){if(route=="/web/dataset/call_kw/ir.default/set"){assert.deepEqual(args.args,["partner","foo","yop",true,true,false],'Model, field, value and booleans for current user/company should have been passed');return Promise.resolve();}
return this._super.apply(this,arguments);}});await debugManager.appendTo($('#qunit-fixture'));var action={controlPanelFieldsView:{},views:[{fieldsView:{view_id:1,model:'partner',type:'form',},type:"form",}],res_model:'partner',};await debugManager.update('action',action,form);await testUtils.dom.click(debugManager.$('> a'));await testUtils.dom.click(debugManager.$('a[data-action="set_defaults"]'));var $modal=$('.modal-content');assert.strictEqual($modal.length,1,'One modal present');$modal.find('select[id=formview_default_fields] option[value=foo]').prop('selected',true);await testUtils.dom.click($modal.find('.modal-footer button').eq(1));form.destroy();debugManager.destroy();});});});;

/* /web/static/tests/helpers/test_utils_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.testUtilsTests',function(require){"use strict";var testUtils=require('web.test_utils');QUnit.module('web',{},function(){QUnit.module('testUtils',{},function(){QUnit.module('patch date');QUnit.test('new date',function(assert){assert.expect(5);const unpatchDate=testUtils.mock.patchDate(2018,9,23,14,50,0);const date=new Date();assert.strictEqual(date.getFullYear(),2018);assert.strictEqual(date.getMonth(),9);assert.strictEqual(date.getDate(),23);assert.strictEqual(date.getHours(),14);assert.strictEqual(date.getMinutes(),50);unpatchDate();});QUnit.test('new moment',function(assert){assert.expect(1);const unpatchDate=testUtils.mock.patchDate(2018,9,23,14,50,0);const m=moment();assert.strictEqual(m.format('YYYY-MM-DD HH:mm'),'2018-10-23 14:50');unpatchDate();});});});});;

/* /web/static/tests/owl_compatibility_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.OwlCompatibilityTests',function(require){"use strict";const{ComponentAdapter,ComponentWrapper,WidgetAdapterMixin}=require('web.OwlCompatibility');const testUtils=require('web.test_utils');const Widget=require('web.Widget');const makeTestPromise=testUtils.makeTestPromise;const nextTick=testUtils.nextTick;const addMockEnvironmentOwl=testUtils.mock.addMockEnvironmentOwl;const{Component,tags,useState}=owl;const{xml}=tags;const WidgetAdapter=Widget.extend(WidgetAdapterMixin,{destroy(){this._super(...arguments);WidgetAdapterMixin.destroy.call(this,...arguments);},});QUnit.module("Owl Compatibility",function(){QUnit.module("ComponentAdapter");QUnit.test("sub widget with no argument",async function(assert){assert.expect(1);const MyWidget=Widget.extend({start:function(){this.$el.text('Hello World!');}});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hello World!</div>');parent.destroy();});QUnit.test("sub widget with one argument",async function(assert){assert.expect(1);const MyWidget=Widget.extend({init:function(parent,name){this._super.apply(this,arguments);this.name=name;},start:function(){this.$el.text(`Hello ${this.name}!`);}});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget" name="'World'"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hello World!</div>');parent.destroy();});QUnit.test("sub widget with several arguments (common Adapter)",async function(assert){assert.expect(1);const MyWidget=Widget.extend({init:function(parent,a1,a2){this._super.apply(this,arguments);this.a1=a1;this.a2=a2;},start:function(){this.$el.text(`${this.a1} ${this.a2}!`);}});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget" a1="'Hello'" a2="'World'"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();try{await parent.mount(target);}catch(e){assert.strictEqual(e.toString(),`Error: ComponentAdapter has more than 1 argument, 'widgetArgs' must be overriden.`);}
parent.destroy();});QUnit.test("sub widget with several arguments (specific Adapter)",async function(assert){assert.expect(1);const MyWidget=Widget.extend({init:function(parent,a1,a2){this._super.apply(this,arguments);this.a1=a1;this.a2=a2;},start:function(){this.$el.text(`${this.a1} ${this.a2}!`);}});class MyWidgetAdapter extends ComponentAdapter{get widgetArgs(){return[this.props.a1,this.props.a2];}}
class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <MyWidgetAdapter Component="MyWidget" a1="'Hello'" a2="'World'"/>
                </div>`;Parent.components={MyWidgetAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hello World!</div>');parent.destroy();});QUnit.test("sub widget and widgetArgs props",async function(assert){assert.expect(1);const MyWidget=Widget.extend({init:function(parent,a1,a2){this._super.apply(this,arguments);this.a1=a1;this.a2=a2;},start:function(){this.$el.text(`${this.a1} ${this.a2}!`);}});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget" a1="'Hello'" a2="'World'" widgetArgs="['Hello', 'World']"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hello World!</div>');parent.destroy();});QUnit.test("sub widget is updated when props change",async function(assert){assert.expect(2);const MyWidget=Widget.extend({init:function(parent,name){this._super.apply(this,arguments);this.name=name;},start:function(){this.render();},render:function(){this.$el.text(`Hello ${this.name}!`);},update:function(name){this.name=name;},});class MyWidgetAdapter extends ComponentAdapter{updateWidget(nextProps){return this.widget.update(nextProps.name);}
renderWidget(){this.widget.render();}}
class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;this.state=useState({name:"World",});}}
Parent.template=xml`
                <div>
                    <MyWidgetAdapter Component="MyWidget" name="state.name"/>
                </div>`;Parent.components={MyWidgetAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hello World!</div>');parent.state.name="GED";await nextTick();assert.strictEqual(parent.el.innerHTML,'<div>Hello GED!</div>');parent.destroy();});QUnit.test("sub widget is updated when props change (async)",async function(assert){assert.expect(7);const prom=makeTestPromise();const MyWidget=Widget.extend({init:function(parent,name){this._super.apply(this,arguments);this.name=name;},start:function(){this.render();},render:function(){this.$el.text(`Hello ${this.name}!`);assert.step('render');},update:function(name){assert.step('update');this.name=name;},});class MyWidgetAdapter extends ComponentAdapter{updateWidget(nextProps){return this.widget.update(nextProps.name);}
renderWidget(){this.widget.render();}}
class AsyncComponent extends Component{willUpdateProps(){return prom;}}
AsyncComponent.template=xml`<div>Hi <t t-esc="props.name"/>!</div>`;class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;this.state=useState({name:"World",});}}
Parent.template=xml`
                <div>
                    <AsyncComponent name="state.name"/>
                    <MyWidgetAdapter Component="MyWidget" name="state.name"/>
                </div>`;Parent.components={AsyncComponent,MyWidgetAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hi World!</div><div>Hello World!</div>');parent.state.name="GED";await nextTick();assert.strictEqual(parent.el.innerHTML,'<div>Hi World!</div><div>Hello World!</div>');prom.resolve();await nextTick();assert.strictEqual(parent.el.innerHTML,'<div>Hi GED!</div><div>Hello GED!</div>');assert.verifySteps(['render','update','render']);parent.destroy();});QUnit.test("sub widget methods are correctly called",async function(assert){assert.expect(8);const MyWidget=Widget.extend({on_attach_callback:function(){assert.step('on_attach_callback');},on_detach_callback:function(){assert.step('on_detach_callback');},destroy:function(){assert.step('destroy');this._super.apply(this,arguments);},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.verifySteps(['on_attach_callback']);parent.unmount();await parent.mount(target);assert.verifySteps(['on_detach_callback','on_attach_callback']);parent.destroy();assert.verifySteps(['on_detach_callback','destroy']);});QUnit.test("dynamic sub widget/component",async function(assert){assert.expect(1);const MyWidget=Widget.extend({start:function(){this.$el.text('widget');},});class MyComponent extends Component{}
MyComponent.template=xml`<div>component</div>`;class Parent extends Component{constructor(){super(...arguments);this.Children=[MyWidget,MyComponent];}}
Parent.template=xml`
                <div>
                    <ComponentAdapter t-foreach="Children" t-as="Child" Component="Child"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>widget</div><div>component</div>');parent.destroy();});QUnit.test("sub widget that triggers events",async function(assert){assert.expect(5);let widget;const MyWidget=Widget.extend({init:function(){this._super.apply(this,arguments);widget=this;},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}
onSomeEvent(ev){assert.step(ev.detail.value);assert.ok(ev.detail.__targetWidget instanceof MyWidget);}}
Parent.template=xml`
                <div t-on-some-event="onSomeEvent">
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);widget.trigger_up('some-event',{value:'a'});widget.trigger_up('some_event',{value:'b'});assert.verifySteps(['a','b']);parent.destroy();});QUnit.test("sub widget that calls _rpc",async function(assert){assert.expect(3);const MyWidget=Widget.extend({willStart:function(){return this._rpc({route:'some/route',params:{val:2}});},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const cleanUp=await addMockEnvironmentOwl(Parent,{mockRPC:function(route,args){assert.step(`${route} ${args.val}`);return Promise.resolve();},});const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div></div>');assert.verifySteps(['some/route 2']);parent.destroy();cleanUp();});QUnit.test("sub widget that calls a service",async function(assert){assert.expect(1);const MyWidget=Widget.extend({start:function(){let result;this.trigger_up('call_service',{service:'math',method:'sqrt',args:[9],callback:r=>{result=r;},});assert.strictEqual(result,3);},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};Parent.env.services.math={sqrt:v=>Math.sqrt(v),};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);parent.destroy();});QUnit.test("sub widget that requests the session",async function(assert){assert.expect(1);const MyWidget=Widget.extend({start:function(){assert.strictEqual(this.getSession().key,'value');},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const cleanUp=await addMockEnvironmentOwl(Parent,{session:{key:'value'},});const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);parent.destroy();cleanUp();});QUnit.test("sub widget that calls load_views",async function(assert){assert.expect(4);const MyWidget=Widget.extend({willStart:function(){return this.loadViews('some_model',{x:2},[[false,'list']]);},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}}
Parent.template=xml`
                <div>
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const cleanUp=await addMockEnvironmentOwl(Parent,{mockRPC:function(route,args){assert.strictEqual(route,'/web/dataset/call_kw/some_model');assert.deepEqual(args.kwargs.context,{x:2});assert.deepEqual(args.kwargs.views,[[false,'list']]);return Promise.resolve();},});const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div></div>');parent.destroy();cleanUp();});QUnit.test("sub widgets in a t-if/t-else",async function(assert){assert.expect(3);const MyWidget1=Widget.extend({start:function(){this.$el.text('Hi');},});const MyWidget2=Widget.extend({start:function(){this.$el.text('Hello');},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget1=MyWidget1;this.MyWidget2=MyWidget2;this.state=useState({flag:true,});}}
Parent.template=xml`
                <div>
                    <ComponentAdapter t-if="state.flag" Component="MyWidget1"/>
                    <ComponentAdapter t-else="" Component="MyWidget2"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hi</div>');parent.state.flag=false;await nextTick();assert.strictEqual(parent.el.innerHTML,'<div>Hello</div>');parent.state.flag=true;await nextTick();assert.strictEqual(parent.el.innerHTML,'<div>Hi</div>');parent.destroy();});QUnit.test("sub widget in a t-if, and events",async function(assert){assert.expect(6);let myWidget;const MyWidget=Widget.extend({start:function(){myWidget=this;this.$el.text('Hi');},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;this.state=useState({flag:true,});}
onSomeEvent(ev){assert.step(ev.detail.value);}}
Parent.template=xml`
                <div t-on-some-event="onSomeEvent">
                    <ComponentAdapter t-if="state.flag" Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div>Hi</div>');myWidget.trigger_up('some-event',{value:'a'});parent.state.flag=false;await nextTick();assert.strictEqual(parent.el.innerHTML,'');myWidget.trigger_up('some-event',{value:'b'});parent.state.flag=true;await nextTick();assert.strictEqual(parent.el.innerHTML,'<div>Hi</div>');myWidget.trigger_up('some-event',{value:'c'});assert.verifySteps(['a','c']);parent.destroy();});QUnit.test("adapter keeps same el as sub widget (modify)",async function(assert){assert.expect(7);let myWidget;const MyWidget=Widget.extend({events:{click:"_onClick",},init:function(parent,name){myWidget=this;this._super.apply(this,arguments);this.name=name;},start:function(){this.render();},render:function(){this.$el.text("Click me!");},update:function(name){this.name=name;},_onClick:function(){assert.step(this.name);},});class MyWidgetAdapter extends ComponentAdapter{updateWidget(nextProps){return this.widget.update(nextProps.name);}
renderWidget(){this.widget.render();}}
class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;this.state=useState({name:"GED",});}}
Parent.template=xml`
                <MyWidgetAdapter Component="MyWidget" name="state.name"/>
            `;Parent.components={MyWidgetAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el,myWidget.el);await testUtils.dom.click(parent.el);parent.state.name="AAB";await nextTick();assert.strictEqual(parent.el,myWidget.el);await testUtils.dom.click(parent.el);parent.state.name="MCM";await nextTick();assert.strictEqual(parent.el,myWidget.el);await testUtils.dom.click(parent.el);assert.verifySteps(["GED","AAB","MCM"]);parent.destroy();});QUnit.test("adapter keeps same el as sub widget (replace)",async function(assert){assert.expect(7);let myWidget;const MyWidget=Widget.extend({events:{click:"_onClick",},init:function(parent,name){myWidget=this;this._super.apply(this,arguments);this.name=name;},start:function(){this.render();},render:function(){this._replaceElement("<div>Click me!</div>");},update:function(name){this.name=name;},_onClick:function(){assert.step(this.name);},});class MyWidgetAdapter extends ComponentAdapter{updateWidget(nextProps){return this.widget.update(nextProps.name);}
renderWidget(){this.widget.render();}}
class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;this.state=useState({name:"GED",});}}
Parent.template=xml`
                <MyWidgetAdapter Component="MyWidget" name="state.name"/>
            `;Parent.components={MyWidgetAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el,myWidget.el);await testUtils.dom.click(parent.el);parent.state.name="AAB";await nextTick();assert.strictEqual(parent.el,myWidget.el);await testUtils.dom.click(parent.el);parent.state.name="MCM";await nextTick();assert.strictEqual(parent.el,myWidget.el);await testUtils.dom.click(parent.el);assert.verifySteps(["GED","AAB","MCM"]);parent.destroy();});QUnit.module('WidgetAdapterMixin and ComponentWrapper');QUnit.test("widget with sub component",async function(assert){assert.expect(1);class MyComponent extends Component{}
MyComponent.template=xml`<div>Component</div>`;const MyWidget=WidgetAdapter.extend({start(){const component=new ComponentWrapper(this,MyComponent,{});return component.mount(this.el);}});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);assert.strictEqual(widget.el.innerHTML,'<div>Component</div>');widget.destroy();});QUnit.test("sub component hooks are correctly called",async function(assert){assert.expect(14);let component;class MyComponent extends Component{constructor(parent){super(parent);assert.step("init");}
async willStart(){assert.step("willStart");}
mounted(){assert.step("mounted");}
willUnmount(){assert.step("willUnmount");}
__destroy(){super.__destroy();assert.step("__destroy");}}
MyComponent.template=xml`<div>Component</div>`;const MyWidget=WidgetAdapter.extend({start(){component=new ComponentWrapper(this,MyComponent,{});return component.mount(this.el);}});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);assert.verifySteps(['init','willStart','mounted']);assert.ok(component.__owl__.isMounted);widget.$el.detach();widget.on_detach_callback();assert.verifySteps(['willUnmount']);assert.ok(!component.__owl__.isMounted);widget.$el.appendTo(target);widget.on_attach_callback();assert.verifySteps(['mounted']);assert.ok(component.__owl__.isMounted);widget.destroy();assert.verifySteps(['willUnmount','__destroy']);});QUnit.test("isMounted with several sub components",async function(assert){assert.expect(11);let c1;let c2;class MyComponent extends Component{}
MyComponent.template=xml`<div>Component <t t-esc="props.id"/></div>`;const MyWidget=WidgetAdapter.extend({start(){c1=new ComponentWrapper(this,MyComponent,{id:1});c2=new ComponentWrapper(this,MyComponent,{id:2});return Promise.all([c1.mount(this.el),c2.mount(this.el)]);}});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);assert.strictEqual(widget.el.innerHTML,'<div>Component 1</div><div>Component 2</div>');assert.ok(c1.__owl__.isMounted);assert.ok(c2.__owl__.isMounted);widget.$el.detach();widget.on_detach_callback();assert.ok(!c1.__owl__.isMounted);assert.ok(!c2.__owl__.isMounted);widget.$el.appendTo(target);widget.on_attach_callback();assert.ok(c1.__owl__.isMounted);assert.ok(c2.__owl__.isMounted);widget.destroy();assert.ok(!c1.__owl__.isMounted);assert.ok(!c2.__owl__.isMounted);assert.ok(c1.__owl__.isDestroyed);assert.ok(c2.__owl__.isDestroyed);});QUnit.test("isMounted with several levels of sub components",async function(assert){assert.expect(6);let child;class MyChildComponent extends Component{constructor(){super(...arguments);child=this;}}
MyChildComponent.template=xml`<div>child</div>`;class MyComponent extends Component{}
MyComponent.template=xml`<div><MyChildComponent/></div>`;MyComponent.components={MyChildComponent};const MyWidget=WidgetAdapter.extend({start(){let component=new ComponentWrapper(this,MyComponent,{});return component.mount(this.el);}});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);assert.strictEqual(widget.el.innerHTML,'<div><div>child</div></div>');assert.ok(child.__owl__.isMounted);widget.$el.detach();widget.on_detach_callback();assert.ok(!child.__owl__.isMounted);widget.$el.appendTo(target);widget.on_attach_callback();assert.ok(child.__owl__.isMounted);widget.destroy();assert.ok(!child.__owl__.isMounted);assert.ok(child.__owl__.isDestroyed);});QUnit.test("sub component can be updated (in DOM)",async function(assert){assert.expect(2);class MyComponent extends Component{}
MyComponent.template=xml`<div>Component <t t-esc="props.val"/></div>`;const MyWidget=WidgetAdapter.extend({start(){this.component=new ComponentWrapper(this,MyComponent,{val:1});return this.component.mount(this.el);},update(){return this.component.update({val:2});},});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);assert.strictEqual(widget.el.innerHTML,'<div>Component 1</div>');await widget.update();assert.strictEqual(widget.el.innerHTML,'<div>Component 2</div>');widget.destroy();});QUnit.test("sub component can be updated (not in DOM)",async function(assert){assert.expect(4);class MyComponent extends Component{}
MyComponent.template=xml`<div>Component <t t-esc="props.val"/></div>`;const MyWidget=WidgetAdapter.extend({start(){this.component=new ComponentWrapper(this,MyComponent,{val:1});return this.component.mount(this.el);},update(){return this.component.update({val:2});},});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);assert.strictEqual(widget.el.innerHTML,'<div>Component 1</div>');widget.$el.detach();widget.on_detach_callback();assert.ok(!widget.component.__owl__.isMounted);await widget.update();widget.$el.appendTo(target);widget.on_attach_callback();assert.ok(widget.component.__owl__.isMounted);assert.strictEqual(widget.el.innerHTML,'<div>Component 2</div>');widget.destroy();});QUnit.test("update a destroyed sub component",async function(assert){assert.expect(1);class MyComponent extends Component{}
MyComponent.template=xml`<div>Component <t t-esc="props.val"/></div>`;const MyWidget=WidgetAdapter.extend({start(){this.component=new ComponentWrapper(this,MyComponent,{val:1});return this.component.mount(this.el);},update(){this.component.update({val:2});},});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);assert.strictEqual(widget.el.innerHTML,'<div>Component 1</div>');widget.destroy();widget.update();});QUnit.test("sub component that triggers events",async function(assert){assert.expect(3);class WidgetComponent extends Component{}
WidgetComponent.template=xml`<div>Component</div>`;const MyWidget=WidgetAdapter.extend({custom_events:_.extend({},Widget.custom_events,{some_event:function(ev){assert.step(ev.data.value);}}),start(){this.component=new ComponentWrapper(this,WidgetComponent,{});return this.component.mount(this.el);},});const target=testUtils.prepareTarget();const widget=new MyWidget();await widget.appendTo(target);widget.component.trigger('some_event',{value:'a'});widget.component.trigger('some-event',{value:'b'});assert.verifySteps(['a','b']);widget.destroy();});QUnit.test("change parent of ComponentWrapper",async function(assert){assert.expect(7);let myComponent;let widget1;let widget2;class WidgetComponent extends Component{}
WidgetComponent.template=xml`<div>Component</div>`;const MyWidget=WidgetAdapter.extend({custom_events:_.extend({},Widget.custom_events,{some_event:function(ev){assert.strictEqual(this,ev.data.widget);assert.step(ev.data.value);}}),});const Parent=Widget.extend({start(){const proms=[];myComponent=new ComponentWrapper(null,WidgetComponent,{});widget1=new MyWidget();widget2=new MyWidget();proms.push(myComponent.mount(this.el));proms.push(widget1.appendTo(this.$el));proms.push(widget2.appendTo(this.$el));return Promise.all(proms);}});const target=testUtils.prepareTarget();const parent=new Parent();await parent.appendTo(target);myComponent.trigger('some-event',{value:'a',widget:null});assert.verifySteps([]);myComponent.unmount();await myComponent.mount(widget1.el);myComponent.setParent(widget1);myComponent.trigger('some-event',{value:'b',widget:widget1});assert.verifySteps(['b']);myComponent.unmount();await myComponent.mount(widget2.el);myComponent.setParent(widget2);myComponent.trigger('some-event',{value:'c',widget:widget2});assert.verifySteps(['c']);parent.destroy();});QUnit.module('Several layers of legacy widgets and Owl components');QUnit.test("Owl over legacy over Owl",async function(assert){assert.expect(7);let leafComponent;class MyComponent extends Component{}
MyComponent.template=xml`<span>Component</span>`;const MyWidget=WidgetAdapter.extend({custom_events:{widget_event:function(ev){assert.step(`[widget] widget-event ${ev.data.value}`);},both_event:function(ev){assert.step(`[widget] both-event ${ev.data.value}`);if(ev.data.value===4){ev.stopPropagation();}}},start(){leafComponent=new ComponentWrapper(this,MyComponent,{});return leafComponent.mount(this.el);},});class Parent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}
onRootEvent(ev){assert.step(`[root] root-event ${ev.detail.value}`);}
onBothEvent(ev){assert.step(`[root] both-event ${ev.detail.value}`);}}
Parent.template=xml`
                <div t-on-root-event="onRootEvent" t-on-both-event="onBothEvent">
                    <ComponentAdapter Component="MyWidget"/>
                </div>`;Parent.components={ComponentAdapter};const target=testUtils.prepareTarget();const parent=new Parent();await parent.mount(target);assert.strictEqual(parent.el.innerHTML,'<div><span>Component</span></div>');leafComponent.trigger('root-event',{value:1});leafComponent.trigger('widget-event',{value:2});leafComponent.trigger('both-event',{value:3});leafComponent.trigger('both-event',{value:4});assert.verifySteps(['[root] root-event 1','[widget] widget-event 2','[widget] both-event 3','[root] both-event 3','[widget] both-event 4',]);parent.destroy();});QUnit.test("Legacy over Owl over legacy",async function(assert){assert.expect(7);let leafWidget;const MyWidget=Widget.extend({start:function(){leafWidget=this;this.$el.text('Widget');}});class MyComponent extends Component{constructor(){super(...arguments);this.MyWidget=MyWidget;}
onComponentEvent(ev){assert.step(`[component] component-event ${ev.detail.value}`);}
onBothEvent(ev){assert.step(`[component] both-event ${ev.detail.value}`);if(ev.detail.value===4){ev.stopPropagation();}}}
MyComponent.template=xml`
                <span t-on-component-event="onComponentEvent" t-on-both-event="onBothEvent">
                    <ComponentAdapter Component="MyWidget"/>
                </span>`;MyComponent.components={ComponentAdapter};const Parent=WidgetAdapter.extend({custom_events:{root_event:function(ev){assert.step(`[root] root-event ${ev.data.value}`);},both_event:function(ev){assert.step(`[root] both-event ${ev.data.value}`);},},start(){const component=new ComponentWrapper(this,MyComponent,{});return component.mount(this.el);}});const target=testUtils.prepareTarget();const parent=new Parent();await parent.appendTo(target);assert.strictEqual(parent.el.innerHTML,'<span><div>Widget</div></span>');leafWidget.trigger_up('root-event',{value:1});leafWidget.trigger_up('component-event',{value:2});leafWidget.trigger_up('both-event',{value:3});leafWidget.trigger_up('both-event',{value:4});assert.verifySteps(['[root] root-event 1','[component] component-event 2','[component] both-event 3','[root] both-event 3','[component] both-event 4',]);parent.destroy();});});});;

/* /web/static/tests/component_extension_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.component_extension_tests',function(require){"use strict";const makeTestEnvironment=require("web.test_env");const testUtils=require("web.test_utils");const{Component,tags}=owl;const{xml}=tags;const{useListener}=require('web.custom_hooks');QUnit.module("web",function(){QUnit.module("Component Extension");QUnit.test("Component destroyed while performing successful RPC",async function(assert){assert.expect(1);class Parent extends Component{}
Parent.env=makeTestEnvironment({},()=>Promise.resolve());Parent.template=xml`<div/>`;const parent=new Parent();parent.rpc({}).then(()=>{throw new Error();});parent.destroy();await testUtils.nextTick();assert.ok(true,"Promise should still be pending");});QUnit.test("Component destroyed while performing failed RPC",async function(assert){assert.expect(1);class Parent extends Component{}
Parent.env=makeTestEnvironment({},()=>Promise.reject());Parent.template=xml`<div/>`;const parent=new Parent();parent.rpc({}).catch(()=>{throw new Error();});parent.destroy();await testUtils.nextTick();assert.ok(true,"Promise should still be pending");});QUnit.module("Custom Hooks");QUnit.test("useListener handler type",async function(assert){assert.expect(1);class Parent extends Component{constructor(){super();useListener('custom1','_onCustom1');}}
Parent.env=makeTestEnvironment({},()=>Promise.reject());Parent.template=xml`<div/>`;assert.throws(()=>new Parent(null),'The handler must be a function');});QUnit.test("useListener in inheritance setting",async function(assert){assert.expect(12);const fixture=document.body.querySelector('#qunit-fixture');class Parent extends Component{constructor(){super();useListener('custom1',this._onCustom1);useListener('custom2',this._onCustom2);}
_onCustom1(){assert.step(`${this.constructor.name} custom1`);}
_onCustom2(){assert.step('parent custom2');}}
Parent.env=makeTestEnvironment({},()=>Promise.reject());Parent.template=xml`<div/>`;class Child extends Parent{constructor(){super();useListener('custom2',this._onCustom2);useListener('custom3',this._onCustom3);}
_onCustom2(){assert.step('overriden custom2');}
_onCustom3(){assert.step('child custom3');}}
const parent=new Parent(null);const child=new Child(null);await parent.mount(fixture);await child.mount(fixture);parent.trigger('custom1');assert.verifySteps(['Parent custom1']);parent.trigger('custom2');assert.verifySteps(['parent custom2']);parent.trigger('custom3');assert.verifySteps([]);child.trigger('custom1');assert.verifySteps(['Child custom1']);child.trigger('custom2');assert.verifySteps(['overriden custom2','overriden custom2']);child.trigger('custom3');assert.verifySteps(['child custom3']);parent.destroy();child.destroy();});QUnit.test("useListener with native JS selector",async function(assert){assert.expect(3);const fixture=document.body.querySelector('#qunit-fixture');class Parent extends Component{constructor(){super();useListener('custom1','div .custom-class',this._onCustom1);}
_onCustom1(){assert.step(`custom1`);}}
Parent.env=makeTestEnvironment({},()=>Promise.reject());Parent.template=xml`
                <div>
                    <p>no trigger</p>
                    <h1 class="custom-class">triggers</h1>
                </div>`;const parent=new Parent(null);await parent.mount(fixture);parent.el.querySelector('p').dispatchEvent(new Event('custom1',{bubbles:true}));assert.verifySteps([]);parent.el.querySelector('h1').dispatchEvent(new Event('custom1',{bubbles:true}));assert.verifySteps(['custom1']);parent.destroy();});QUnit.test("useListener with native JS selector delegation",async function(assert){assert.expect(3);const fixture=document.body.querySelector('#qunit-fixture');class Parent extends Component{constructor(){super();useListener('custom1','.custom-class',this._onCustom1);}
_onCustom1(){assert.step(`custom1`);}}
Parent.env=makeTestEnvironment({},()=>Promise.reject());Parent.template=xml`
                <div>
                    <p>no trigger</p>
                    <h1 class="custom-class"><h2>triggers</h2></h1>
                </div>`;fixture.classList.add('custom-class');const parent=new Parent(null);await parent.mount(fixture);parent.el.querySelector('p').dispatchEvent(new Event('custom1',{bubbles:true}));assert.verifySteps([]);parent.el.querySelector('h2').dispatchEvent(new Event('custom1',{bubbles:true}));assert.verifySteps(['custom1']);parent.destroy();fixture.classList.remove('custom-class');});QUnit.test("useListener with capture option",async function(assert){assert.expect(7);const fixture=document.body.querySelector('#qunit-fixture');class Leaf extends Component{constructor(){super();useListener('custom1',this._onCustom1);}
_onCustom1(){assert.step(`${this.constructor.name} custom1`);}}
Leaf.template=xml`<div class="leaf"/>`;class Root extends Component{constructor(){super();useListener('custom1',this._onCustom1,{capture:true});}
_onCustom1(event){assert.step(`${this.constructor.name} custom1`);const detail=event.detail;if(detail&&detail.stopMe){event.stopPropagation();}}}
Root.template=xml`<div class="root"><Leaf/></div>`;Root.components={Leaf};const root=new Root(null);await root.mount(fixture);const rootNode=document.body.querySelector('.root');const leafNode=document.body.querySelector('.leaf');rootNode.dispatchEvent(new CustomEvent('custom1',{bubbles:true,cancelable:true}));assert.verifySteps(['Root custom1']);leafNode.dispatchEvent(new CustomEvent('custom1',{bubbles:true,cancelable:true,detail:{stopMe:true},}));assert.verifySteps(['Root custom1']);leafNode.dispatchEvent(new CustomEvent('custom1',{bubbles:true,cancelable:true,detail:{stopMe:false}}));assert.verifySteps(['Root custom1','Leaf custom1']);root.destroy();});});});;

/* /base_import/static/tests/import_buttons_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.base_import_tests',function(require){"use strict";const KanbanView=require('web.KanbanView');const ListView=require('web.ListView');const PivotView=require('web.PivotView');const testUtils=require('web.test_utils');const createView=testUtils.createView;QUnit.module('Base Import Tests',{beforeEach:function(){this.data={foo:{fields:{foo:{string:"Foo",type:"char"},},records:[{id:1,foo:"yop"},]},};}});QUnit.test('import in favorite dropdown in list',async function(assert){assert.expect(2);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree><field name="foo"/></tree>',});testUtils.mock.intercept(list,'do_action',function(){assert.ok(true,"should have triggered a do_action");});await testUtils.dom.click(list.$('.o_favorite_menu button'));assert.containsOnce(list,'.o_import_menu');await testUtils.dom.click(list.$('.o_import_menu button'));list.destroy();});QUnit.test('import favorite dropdown item should not in list with create="0"',async function(assert){assert.expect(1);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree create="0"><field name="foo"/></tree>',});await testUtils.dom.click(list.$('.o_favorite_menu button'));assert.containsNone(list,'.o_import_menu');list.destroy();});QUnit.test('import favorite dropdown item should not in list with import="0"',async function(assert){assert.expect(1);const list=await createView({View:ListView,model:'foo',data:this.data,arch:'<tree import="0"><field name="foo"/></tree>',});await testUtils.dom.click(list.$('.o_favorite_menu button'));assert.containsNone(list,'.o_import_menu');list.destroy();});QUnit.test('import in favorite dropdown in kanban',async function(assert){assert.expect(2);const kanban=await createView({View:KanbanView,model:'foo',data:this.data,arch:`<kanban>
                <templates>
                    <t t-name="kanban-box">
                        <div><field name="foo"/></div>
                    </t>
                </templates>
            </kanban>`,});testUtils.mock.intercept(kanban,'do_action',function(){assert.ok(true,"should have triggered a do_action");});await testUtils.dom.click(kanban.$('.o_favorite_menu button'));assert.containsOnce(kanban,'.o_import_menu');await testUtils.dom.click(kanban.$('.o_import_menu button'));kanban.destroy();});QUnit.test('import favorite dropdown item should not in list with create="0"',async function(assert){assert.expect(1);const kanban=await createView({View:KanbanView,model:'foo',data:this.data,arch:`<kanban create="0">
                <templates>
                    <t t-name="kanban-box">
                        <div><field name="foo"/></div>
                    </t>
                </templates>
            </kanban>`,});await testUtils.dom.click(kanban.$('.o_favorite_menu button'));assert.containsNone(kanban,'.o_import_menu');kanban.destroy();});QUnit.test('import dropdown favorite should not in kanban with import="0"',async function(assert){assert.expect(1);const kanban=await createView({View:KanbanView,model:'foo',data:this.data,arch:`<kanban import="0">
                <templates>
                    <t t-name="kanban-box">
                        <div><field name="foo"/></div>
                    </t>
                </templates>
            </kanban>`,});await testUtils.dom.click(kanban.$('.o_favorite_menu button'));assert.containsNone(kanban,'.o_import_menu');kanban.destroy();});QUnit.test('import should not available in favorite dropdown in pivot (other than kanban or list)',async function(assert){assert.expect(1);this.data.foo.fields.foobar={string:"Fubar",type:"integer",group_operator:'sum'};const pivot=await createView({View:PivotView,model:'foo',data:this.data,arch:'<pivot><field name="foobar" type="measure"/></pivot>',});await testUtils.dom.click(pivot.$('.o_favorite_menu button'));assert.containsNone(pivot,'.o_import_menu');pivot.destroy();});});;

/* <inline asset> defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.wysiwyg.root.test',function(require){'use strict';var WysiwygRoot=require('web_editor.wysiwyg.root');if(WysiwygRoot){WysiwygRoot.include({assetLibs:null});}});;

/* /web_editor/static/lib/cropperjs/cropper.js defined in bundle 'web.qunit_suite_tests' */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=global||self,global.Cropper=factory());}(this,function(){'use strict';function _typeof(obj){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function(obj){return typeof obj;};}else{_typeof=function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}
return _typeof(obj);}
function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}
function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor;}
function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread();}
function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2;}}
function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||Object.prototype.toString.call(iter)==="[object Arguments]")return Array.from(iter);}
function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance");}
var IS_BROWSER=typeof window!=='undefined'&&typeof window.document!=='undefined';var WINDOW=IS_BROWSER?window:{};var IS_TOUCH_DEVICE=IS_BROWSER?'ontouchstart'in WINDOW.document.documentElement:false;var HAS_POINTER_EVENT=IS_BROWSER?'PointerEvent'in WINDOW:false;var NAMESPACE='cropper';var ACTION_ALL='all';var ACTION_CROP='crop';var ACTION_MOVE='move';var ACTION_ZOOM='zoom';var ACTION_EAST='e';var ACTION_WEST='w';var ACTION_SOUTH='s';var ACTION_NORTH='n';var ACTION_NORTH_EAST='ne';var ACTION_NORTH_WEST='nw';var ACTION_SOUTH_EAST='se';var ACTION_SOUTH_WEST='sw';var CLASS_CROP="".concat(NAMESPACE,"-crop");var CLASS_DISABLED="".concat(NAMESPACE,"-disabled");var CLASS_HIDDEN="".concat(NAMESPACE,"-hidden");var CLASS_HIDE="".concat(NAMESPACE,"-hide");var CLASS_INVISIBLE="".concat(NAMESPACE,"-invisible");var CLASS_MODAL="".concat(NAMESPACE,"-modal");var CLASS_MOVE="".concat(NAMESPACE,"-move");var DATA_ACTION="".concat(NAMESPACE,"Action");var DATA_PREVIEW="".concat(NAMESPACE,"Preview");var DRAG_MODE_CROP='crop';var DRAG_MODE_MOVE='move';var DRAG_MODE_NONE='none';var EVENT_CROP='crop';var EVENT_CROP_END='cropend';var EVENT_CROP_MOVE='cropmove';var EVENT_CROP_START='cropstart';var EVENT_DBLCLICK='dblclick';var EVENT_TOUCH_START=IS_TOUCH_DEVICE?'touchstart':'mousedown';var EVENT_TOUCH_MOVE=IS_TOUCH_DEVICE?'touchmove':'mousemove';var EVENT_TOUCH_END=IS_TOUCH_DEVICE?'touchend touchcancel':'mouseup';var EVENT_POINTER_DOWN=HAS_POINTER_EVENT?'pointerdown':EVENT_TOUCH_START;var EVENT_POINTER_MOVE=HAS_POINTER_EVENT?'pointermove':EVENT_TOUCH_MOVE;var EVENT_POINTER_UP=HAS_POINTER_EVENT?'pointerup pointercancel':EVENT_TOUCH_END;var EVENT_READY='ready';var EVENT_RESIZE='resize';var EVENT_WHEEL='wheel';var EVENT_ZOOM='zoom';var MIME_TYPE_JPEG='image/jpeg';var REGEXP_ACTIONS=/^e|w|s|n|se|sw|ne|nw|all|crop|move|zoom$/;var REGEXP_DATA_URL=/^data:/;var REGEXP_DATA_URL_JPEG=/^data:image\/jpeg;base64,/;var REGEXP_TAG_NAME=/^img|canvas$/i;var MIN_CONTAINER_WIDTH=200;var MIN_CONTAINER_HEIGHT=100;var DEFAULTS={viewMode:0,dragMode:DRAG_MODE_CROP,initialAspectRatio:NaN,aspectRatio:NaN,data:null,preview:'',responsive:true,restore:true,checkCrossOrigin:true,checkOrientation:true,modal:true,guides:true,center:true,highlight:true,background:true,autoCrop:true,autoCropArea:0.8,movable:true,rotatable:true,scalable:true,zoomable:true,zoomOnTouch:true,zoomOnWheel:true,wheelZoomRatio:0.1,cropBoxMovable:true,cropBoxResizable:true,toggleDragModeOnDblclick:true,minCanvasWidth:0,minCanvasHeight:0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:200,minContainerHeight:100,ready:null,cropstart:null,cropmove:null,cropend:null,crop:null,zoom:null};var TEMPLATE='<div class="cropper-container" touch-action="none">'+'<div class="cropper-wrap-box">'+'<div class="cropper-canvas"></div>'+'</div>'+'<div class="cropper-drag-box"></div>'+'<div class="cropper-crop-box">'+'<span class="cropper-view-box"></span>'+'<span class="cropper-dashed dashed-h"></span>'+'<span class="cropper-dashed dashed-v"></span>'+'<span class="cropper-center"></span>'+'<span class="cropper-face"></span>'+'<span class="cropper-line line-e" data-cropper-action="e"></span>'+'<span class="cropper-line line-n" data-cropper-action="n"></span>'+'<span class="cropper-line line-w" data-cropper-action="w"></span>'+'<span class="cropper-line line-s" data-cropper-action="s"></span>'+'<span class="cropper-point point-e" data-cropper-action="e"></span>'+'<span class="cropper-point point-n" data-cropper-action="n"></span>'+'<span class="cropper-point point-w" data-cropper-action="w"></span>'+'<span class="cropper-point point-s" data-cropper-action="s"></span>'+'<span class="cropper-point point-ne" data-cropper-action="ne"></span>'+'<span class="cropper-point point-nw" data-cropper-action="nw"></span>'+'<span class="cropper-point point-sw" data-cropper-action="sw"></span>'+'<span class="cropper-point point-se" data-cropper-action="se"></span>'+'</div>'+'</div>';var isNaN=Number.isNaN||WINDOW.isNaN;function isNumber(value){return typeof value==='number'&&!isNaN(value);}
var isPositiveNumber=function isPositiveNumber(value){return value>0&&value<Infinity;};function isUndefined(value){return typeof value==='undefined';}
function isObject(value){return _typeof(value)==='object'&&value!==null;}
var hasOwnProperty=Object.prototype.hasOwnProperty;function isPlainObject(value){if(!isObject(value)){return false;}
try{var _constructor=value.constructor;var prototype=_constructor.prototype;return _constructor&&prototype&&hasOwnProperty.call(prototype,'isPrototypeOf');}catch(error){return false;}}
function isFunction(value){return typeof value==='function';}
var slice=Array.prototype.slice;function toArray(value){return Array.from?Array.from(value):slice.call(value);}
function forEach(data,callback){if(data&&isFunction(callback)){if(Array.isArray(data)||isNumber(data.length)){toArray(data).forEach(function(value,key){callback.call(data,value,key,data);});}else if(isObject(data)){Object.keys(data).forEach(function(key){callback.call(data,data[key],key,data);});}}
return data;}
var assign=Object.assign||function assign(target){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
if(isObject(target)&&args.length>0){args.forEach(function(arg){if(isObject(arg)){Object.keys(arg).forEach(function(key){target[key]=arg[key];});}});}
return target;};var REGEXP_DECIMALS=/\.\d*(?:0|9){12}\d*$/;function normalizeDecimalNumber(value){var times=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100000000000;return REGEXP_DECIMALS.test(value)?Math.round(value*times)/times:value;}
var REGEXP_SUFFIX=/^width|height|left|top|marginLeft|marginTop$/;function setStyle(element,styles){var style=element.style;forEach(styles,function(value,property){if(REGEXP_SUFFIX.test(property)&&isNumber(value)){value="".concat(value,"px");}
style[property]=value;});}
function hasClass(element,value){return element.classList?element.classList.contains(value):element.className.indexOf(value)>-1;}
function addClass(element,value){if(!value){return;}
if(isNumber(element.length)){forEach(element,function(elem){addClass(elem,value);});return;}
if(element.classList){element.classList.add(value);return;}
var className=element.className.trim();if(!className){element.className=value;}else if(className.indexOf(value)<0){element.className="".concat(className," ").concat(value);}}
function removeClass(element,value){if(!value){return;}
if(isNumber(element.length)){forEach(element,function(elem){removeClass(elem,value);});return;}
if(element.classList){element.classList.remove(value);return;}
if(element.className.indexOf(value)>=0){element.className=element.className.replace(value,'');}}
function toggleClass(element,value,added){if(!value){return;}
if(isNumber(element.length)){forEach(element,function(elem){toggleClass(elem,value,added);});return;}
if(added){addClass(element,value);}else{removeClass(element,value);}}
var REGEXP_CAMEL_CASE=/([a-z\d])([A-Z])/g;function toParamCase(value){return value.replace(REGEXP_CAMEL_CASE,'$1-$2').toLowerCase();}
function getData(element,name){if(isObject(element[name])){return element[name];}
if(element.dataset){return element.dataset[name];}
return element.getAttribute("data-".concat(toParamCase(name)));}
function setData(element,name,data){if(isObject(data)){element[name]=data;}else if(element.dataset){element.dataset[name]=data;}else{element.setAttribute("data-".concat(toParamCase(name)),data);}}
function removeData(element,name){if(isObject(element[name])){try{delete element[name];}catch(error){element[name]=undefined;}}else if(element.dataset){try{delete element.dataset[name];}catch(error){element.dataset[name]=undefined;}}else{element.removeAttribute("data-".concat(toParamCase(name)));}}
var REGEXP_SPACES=/\s\s*/;var onceSupported=function(){var supported=false;if(IS_BROWSER){var once=false;var listener=function listener(){};var options=Object.defineProperty({},'once',{get:function get(){supported=true;return once;},set:function set(value){once=value;}});WINDOW.addEventListener('test',listener,options);WINDOW.removeEventListener('test',listener,options);}
return supported;}();function removeListener(element,type,listener){var options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var handler=listener;type.trim().split(REGEXP_SPACES).forEach(function(event){if(!onceSupported){var listeners=element.listeners;if(listeners&&listeners[event]&&listeners[event][listener]){handler=listeners[event][listener];delete listeners[event][listener];if(Object.keys(listeners[event]).length===0){delete listeners[event];}
if(Object.keys(listeners).length===0){delete element.listeners;}}}
element.removeEventListener(event,handler,options);});}
function addListener(element,type,listener){var options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var _handler=listener;type.trim().split(REGEXP_SPACES).forEach(function(event){if(options.once&&!onceSupported){var _element$listeners=element.listeners,listeners=_element$listeners===void 0?{}:_element$listeners;_handler=function handler(){delete listeners[event][listener];element.removeEventListener(event,_handler,options);for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}
listener.apply(element,args);};if(!listeners[event]){listeners[event]={};}
if(listeners[event][listener]){element.removeEventListener(event,listeners[event][listener],options);}
listeners[event][listener]=_handler;element.listeners=listeners;}
element.addEventListener(event,_handler,options);});}
function dispatchEvent(element,type,data){var event;if(isFunction(Event)&&isFunction(CustomEvent)){event=new CustomEvent(type,{detail:data,bubbles:true,cancelable:true});}else{event=document.createEvent('CustomEvent');event.initCustomEvent(type,true,true,data);}
return element.dispatchEvent(event);}
function getOffset(element){var box=element.getBoundingClientRect();return{left:box.left+(window.pageXOffset-document.documentElement.clientLeft),top:box.top+(window.pageYOffset-document.documentElement.clientTop)};}
var location=WINDOW.location;var REGEXP_ORIGINS=/^(\w+:)\/\/([^:/?#]*):?(\d*)/i;function isCrossOriginURL(url){var parts=url.match(REGEXP_ORIGINS);return parts!==null&&(parts[1]!==location.protocol||parts[2]!==location.hostname||parts[3]!==location.port);}
function addTimestamp(url){var timestamp="timestamp=".concat(new Date().getTime());return url+(url.indexOf('?')===-1?'?':'&')+timestamp;}
function getTransforms(_ref){var rotate=_ref.rotate,scaleX=_ref.scaleX,scaleY=_ref.scaleY,translateX=_ref.translateX,translateY=_ref.translateY;var values=[];if(isNumber(translateX)&&translateX!==0){values.push("translateX(".concat(translateX,"px)"));}
if(isNumber(translateY)&&translateY!==0){values.push("translateY(".concat(translateY,"px)"));}
if(isNumber(rotate)&&rotate!==0){values.push("rotate(".concat(rotate,"deg)"));}
if(isNumber(scaleX)&&scaleX!==1){values.push("scaleX(".concat(scaleX,")"));}
if(isNumber(scaleY)&&scaleY!==1){values.push("scaleY(".concat(scaleY,")"));}
var transform=values.length?values.join(' '):'none';return{WebkitTransform:transform,msTransform:transform,transform:transform};}
function getMaxZoomRatio(pointers){var pointers2=assign({},pointers);var ratios=[];forEach(pointers,function(pointer,pointerId){delete pointers2[pointerId];forEach(pointers2,function(pointer2){var x1=Math.abs(pointer.startX-pointer2.startX);var y1=Math.abs(pointer.startY-pointer2.startY);var x2=Math.abs(pointer.endX-pointer2.endX);var y2=Math.abs(pointer.endY-pointer2.endY);var z1=Math.sqrt(x1*x1+y1*y1);var z2=Math.sqrt(x2*x2+y2*y2);var ratio=(z2-z1)/z1;ratios.push(ratio);});});ratios.sort(function(a,b){return Math.abs(a)<Math.abs(b);});return ratios[0];}
function getPointer(_ref2,endOnly){var pageX=_ref2.pageX,pageY=_ref2.pageY;var end={endX:pageX,endY:pageY};return endOnly?end:assign({startX:pageX,startY:pageY},end);}
function getPointersCenter(pointers){var pageX=0;var pageY=0;var count=0;forEach(pointers,function(_ref3){var startX=_ref3.startX,startY=_ref3.startY;pageX+=startX;pageY+=startY;count+=1;});pageX/=count;pageY/=count;return{pageX:pageX,pageY:pageY};}
function getAdjustedSizes(_ref4)
{var aspectRatio=_ref4.aspectRatio,height=_ref4.height,width=_ref4.width;var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'contain';var isValidWidth=isPositiveNumber(width);var isValidHeight=isPositiveNumber(height);if(isValidWidth&&isValidHeight){var adjustedWidth=height*aspectRatio;if(type==='contain'&&adjustedWidth>width||type==='cover'&&adjustedWidth<width){height=width/aspectRatio;}else{width=height*aspectRatio;}}else if(isValidWidth){height=width/aspectRatio;}else if(isValidHeight){width=height*aspectRatio;}
return{width:width,height:height};}
function getRotatedSizes(_ref5){var width=_ref5.width,height=_ref5.height,degree=_ref5.degree;degree=Math.abs(degree)%180;if(degree===90){return{width:height,height:width};}
var arc=degree%90*Math.PI/180;var sinArc=Math.sin(arc);var cosArc=Math.cos(arc);var newWidth=width*cosArc+height*sinArc;var newHeight=width*sinArc+height*cosArc;return degree>90?{width:newHeight,height:newWidth}:{width:newWidth,height:newHeight};}
function getSourceCanvas(image,_ref6,_ref7,_ref8){var imageAspectRatio=_ref6.aspectRatio,imageNaturalWidth=_ref6.naturalWidth,imageNaturalHeight=_ref6.naturalHeight,_ref6$rotate=_ref6.rotate,rotate=_ref6$rotate===void 0?0:_ref6$rotate,_ref6$scaleX=_ref6.scaleX,scaleX=_ref6$scaleX===void 0?1:_ref6$scaleX,_ref6$scaleY=_ref6.scaleY,scaleY=_ref6$scaleY===void 0?1:_ref6$scaleY;var aspectRatio=_ref7.aspectRatio,naturalWidth=_ref7.naturalWidth,naturalHeight=_ref7.naturalHeight;var _ref8$fillColor=_ref8.fillColor,fillColor=_ref8$fillColor===void 0?'transparent':_ref8$fillColor,_ref8$imageSmoothingE=_ref8.imageSmoothingEnabled,imageSmoothingEnabled=_ref8$imageSmoothingE===void 0?true:_ref8$imageSmoothingE,_ref8$imageSmoothingQ=_ref8.imageSmoothingQuality,imageSmoothingQuality=_ref8$imageSmoothingQ===void 0?'low':_ref8$imageSmoothingQ,_ref8$maxWidth=_ref8.maxWidth,maxWidth=_ref8$maxWidth===void 0?Infinity:_ref8$maxWidth,_ref8$maxHeight=_ref8.maxHeight,maxHeight=_ref8$maxHeight===void 0?Infinity:_ref8$maxHeight,_ref8$minWidth=_ref8.minWidth,minWidth=_ref8$minWidth===void 0?0:_ref8$minWidth,_ref8$minHeight=_ref8.minHeight,minHeight=_ref8$minHeight===void 0?0:_ref8$minHeight;var canvas=document.createElement('canvas');var context=canvas.getContext('2d');var maxSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:maxWidth,height:maxHeight});var minSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:minWidth,height:minHeight},'cover');var width=Math.min(maxSizes.width,Math.max(minSizes.width,naturalWidth));var height=Math.min(maxSizes.height,Math.max(minSizes.height,naturalHeight));var destMaxSizes=getAdjustedSizes({aspectRatio:imageAspectRatio,width:maxWidth,height:maxHeight});var destMinSizes=getAdjustedSizes({aspectRatio:imageAspectRatio,width:minWidth,height:minHeight},'cover');var destWidth=Math.min(destMaxSizes.width,Math.max(destMinSizes.width,imageNaturalWidth));var destHeight=Math.min(destMaxSizes.height,Math.max(destMinSizes.height,imageNaturalHeight));var params=[-destWidth/2,-destHeight/2,destWidth,destHeight];canvas.width=normalizeDecimalNumber(width);canvas.height=normalizeDecimalNumber(height);context.fillStyle=fillColor;context.fillRect(0,0,width,height);context.save();context.translate(width/2,height/2);context.rotate(rotate*Math.PI/180);context.scale(scaleX,scaleY);context.imageSmoothingEnabled=imageSmoothingEnabled;context.imageSmoothingQuality=imageSmoothingQuality;context.drawImage.apply(context,[image].concat(_toConsumableArray(params.map(function(param){return Math.floor(normalizeDecimalNumber(param));}))));context.restore();return canvas;}
var fromCharCode=String.fromCharCode;function getStringFromCharCode(dataView,start,length){var str='';length+=start;for(var i=start;i<length;i+=1){str+=fromCharCode(dataView.getUint8(i));}
return str;}
var REGEXP_DATA_URL_HEAD=/^data:.*,/;function dataURLToArrayBuffer(dataURL){var base64=dataURL.replace(REGEXP_DATA_URL_HEAD,'');var binary=atob(base64);var arrayBuffer=new ArrayBuffer(binary.length);var uint8=new Uint8Array(arrayBuffer);forEach(uint8,function(value,i){uint8[i]=binary.charCodeAt(i);});return arrayBuffer;}
function arrayBufferToDataURL(arrayBuffer,mimeType){var chunks=[];var chunkSize=8192;var uint8=new Uint8Array(arrayBuffer);while(uint8.length>0){chunks.push(fromCharCode.apply(null,toArray(uint8.subarray(0,chunkSize))));uint8=uint8.subarray(chunkSize);}
return"data:".concat(mimeType,";base64,").concat(btoa(chunks.join('')));}
function resetAndGetOrientation(arrayBuffer){var dataView=new DataView(arrayBuffer);var orientation;try{var littleEndian;var app1Start;var ifdStart;if(dataView.getUint8(0)===0xFF&&dataView.getUint8(1)===0xD8){var length=dataView.byteLength;var offset=2;while(offset+1<length){if(dataView.getUint8(offset)===0xFF&&dataView.getUint8(offset+1)===0xE1){app1Start=offset;break;}
offset+=1;}}
if(app1Start){var exifIDCode=app1Start+4;var tiffOffset=app1Start+10;if(getStringFromCharCode(dataView,exifIDCode,4)==='Exif'){var endianness=dataView.getUint16(tiffOffset);littleEndian=endianness===0x4949;if(littleEndian||endianness===0x4D4D){if(dataView.getUint16(tiffOffset+2,littleEndian)===0x002A){var firstIFDOffset=dataView.getUint32(tiffOffset+4,littleEndian);if(firstIFDOffset>=0x00000008){ifdStart=tiffOffset+firstIFDOffset;}}}}}
if(ifdStart){var _length=dataView.getUint16(ifdStart,littleEndian);var _offset;var i;for(i=0;i<_length;i+=1){_offset=ifdStart+i*12+2;if(dataView.getUint16(_offset,littleEndian)===0x0112){_offset+=8;orientation=dataView.getUint16(_offset,littleEndian);dataView.setUint16(_offset,1,littleEndian);break;}}}}catch(error){orientation=1;}
return orientation;}
function parseOrientation(orientation){var rotate=0;var scaleX=1;var scaleY=1;switch(orientation){case 2:scaleX=-1;break;case 3:rotate=-180;break;case 4:scaleY=-1;break;case 5:rotate=90;scaleY=-1;break;case 6:rotate=90;break;case 7:rotate=90;scaleX=-1;break;case 8:rotate=-90;break;default:}
return{rotate:rotate,scaleX:scaleX,scaleY:scaleY};}
var render={render:function render(){this.initContainer();this.initCanvas();this.initCropBox();this.renderCanvas();if(this.cropped){this.renderCropBox();}},initContainer:function initContainer(){var element=this.element,options=this.options,container=this.container,cropper=this.cropper;addClass(cropper,CLASS_HIDDEN);removeClass(element,CLASS_HIDDEN);var containerData={width:Math.max(container.offsetWidth,Number(options.minContainerWidth)||200),height:Math.max(container.offsetHeight,Number(options.minContainerHeight)||100)};this.containerData=containerData;setStyle(cropper,{width:containerData.width,height:containerData.height});addClass(element,CLASS_HIDDEN);removeClass(cropper,CLASS_HIDDEN);},initCanvas:function initCanvas(){var containerData=this.containerData,imageData=this.imageData;var viewMode=this.options.viewMode;var rotated=Math.abs(imageData.rotate)%180===90;var naturalWidth=rotated?imageData.naturalHeight:imageData.naturalWidth;var naturalHeight=rotated?imageData.naturalWidth:imageData.naturalHeight;var aspectRatio=naturalWidth/naturalHeight;var canvasWidth=containerData.width;var canvasHeight=containerData.height;if(containerData.height*aspectRatio>containerData.width){if(viewMode===3){canvasWidth=containerData.height*aspectRatio;}else{canvasHeight=containerData.width/aspectRatio;}}else if(viewMode===3){canvasHeight=containerData.width/aspectRatio;}else{canvasWidth=containerData.height*aspectRatio;}
var canvasData={aspectRatio:aspectRatio,naturalWidth:naturalWidth,naturalHeight:naturalHeight,width:canvasWidth,height:canvasHeight};canvasData.left=(containerData.width-canvasWidth)/2;canvasData.top=(containerData.height-canvasHeight)/2;canvasData.oldLeft=canvasData.left;canvasData.oldTop=canvasData.top;this.canvasData=canvasData;this.limited=viewMode===1||viewMode===2;this.limitCanvas(true,true);this.initialImageData=assign({},imageData);this.initialCanvasData=assign({},canvasData);},limitCanvas:function limitCanvas(sizeLimited,positionLimited){var options=this.options,containerData=this.containerData,canvasData=this.canvasData,cropBoxData=this.cropBoxData;var viewMode=options.viewMode;var aspectRatio=canvasData.aspectRatio;var cropped=this.cropped&&cropBoxData;if(sizeLimited){var minCanvasWidth=Number(options.minCanvasWidth)||0;var minCanvasHeight=Number(options.minCanvasHeight)||0;if(viewMode>1){minCanvasWidth=Math.max(minCanvasWidth,containerData.width);minCanvasHeight=Math.max(minCanvasHeight,containerData.height);if(viewMode===3){if(minCanvasHeight*aspectRatio>minCanvasWidth){minCanvasWidth=minCanvasHeight*aspectRatio;}else{minCanvasHeight=minCanvasWidth/aspectRatio;}}}else if(viewMode>0){if(minCanvasWidth){minCanvasWidth=Math.max(minCanvasWidth,cropped?cropBoxData.width:0);}else if(minCanvasHeight){minCanvasHeight=Math.max(minCanvasHeight,cropped?cropBoxData.height:0);}else if(cropped){minCanvasWidth=cropBoxData.width;minCanvasHeight=cropBoxData.height;if(minCanvasHeight*aspectRatio>minCanvasWidth){minCanvasWidth=minCanvasHeight*aspectRatio;}else{minCanvasHeight=minCanvasWidth/aspectRatio;}}}
var _getAdjustedSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:minCanvasWidth,height:minCanvasHeight});minCanvasWidth=_getAdjustedSizes.width;minCanvasHeight=_getAdjustedSizes.height;canvasData.minWidth=minCanvasWidth;canvasData.minHeight=minCanvasHeight;canvasData.maxWidth=Infinity;canvasData.maxHeight=Infinity;}
if(positionLimited){if(viewMode>(cropped?0:1)){var newCanvasLeft=containerData.width-canvasData.width;var newCanvasTop=containerData.height-canvasData.height;canvasData.minLeft=Math.min(0,newCanvasLeft);canvasData.minTop=Math.min(0,newCanvasTop);canvasData.maxLeft=Math.max(0,newCanvasLeft);canvasData.maxTop=Math.max(0,newCanvasTop);if(cropped&&this.limited){canvasData.minLeft=Math.min(cropBoxData.left,cropBoxData.left+(cropBoxData.width-canvasData.width));canvasData.minTop=Math.min(cropBoxData.top,cropBoxData.top+(cropBoxData.height-canvasData.height));canvasData.maxLeft=cropBoxData.left;canvasData.maxTop=cropBoxData.top;if(viewMode===2){if(canvasData.width>=containerData.width){canvasData.minLeft=Math.min(0,newCanvasLeft);canvasData.maxLeft=Math.max(0,newCanvasLeft);}
if(canvasData.height>=containerData.height){canvasData.minTop=Math.min(0,newCanvasTop);canvasData.maxTop=Math.max(0,newCanvasTop);}}}}else{canvasData.minLeft=-canvasData.width;canvasData.minTop=-canvasData.height;canvasData.maxLeft=containerData.width;canvasData.maxTop=containerData.height;}}},renderCanvas:function renderCanvas(changed,transformed){var canvasData=this.canvasData,imageData=this.imageData;if(transformed){var _getRotatedSizes=getRotatedSizes({width:imageData.naturalWidth*Math.abs(imageData.scaleX||1),height:imageData.naturalHeight*Math.abs(imageData.scaleY||1),degree:imageData.rotate||0}),naturalWidth=_getRotatedSizes.width,naturalHeight=_getRotatedSizes.height;var width=canvasData.width*(naturalWidth/canvasData.naturalWidth);var height=canvasData.height*(naturalHeight/canvasData.naturalHeight);canvasData.left-=(width-canvasData.width)/2;canvasData.top-=(height-canvasData.height)/2;canvasData.width=width;canvasData.height=height;canvasData.aspectRatio=naturalWidth/naturalHeight;canvasData.naturalWidth=naturalWidth;canvasData.naturalHeight=naturalHeight;this.limitCanvas(true,false);}
if(canvasData.width>canvasData.maxWidth||canvasData.width<canvasData.minWidth){canvasData.left=canvasData.oldLeft;}
if(canvasData.height>canvasData.maxHeight||canvasData.height<canvasData.minHeight){canvasData.top=canvasData.oldTop;}
canvasData.width=Math.min(Math.max(canvasData.width,canvasData.minWidth),canvasData.maxWidth);canvasData.height=Math.min(Math.max(canvasData.height,canvasData.minHeight),canvasData.maxHeight);this.limitCanvas(false,true);canvasData.left=Math.min(Math.max(canvasData.left,canvasData.minLeft),canvasData.maxLeft);canvasData.top=Math.min(Math.max(canvasData.top,canvasData.minTop),canvasData.maxTop);canvasData.oldLeft=canvasData.left;canvasData.oldTop=canvasData.top;setStyle(this.canvas,assign({width:canvasData.width,height:canvasData.height},getTransforms({translateX:canvasData.left,translateY:canvasData.top})));this.renderImage(changed);if(this.cropped&&this.limited){this.limitCropBox(true,true);}},renderImage:function renderImage(changed){var canvasData=this.canvasData,imageData=this.imageData;var width=imageData.naturalWidth*(canvasData.width/canvasData.naturalWidth);var height=imageData.naturalHeight*(canvasData.height/canvasData.naturalHeight);assign(imageData,{width:width,height:height,left:(canvasData.width-width)/2,top:(canvasData.height-height)/2});setStyle(this.image,assign({width:imageData.width,height:imageData.height},getTransforms(assign({translateX:imageData.left,translateY:imageData.top},imageData))));if(changed){this.output();}},initCropBox:function initCropBox(){var options=this.options,canvasData=this.canvasData;var aspectRatio=options.aspectRatio||options.initialAspectRatio;var autoCropArea=Number(options.autoCropArea)||0.8;var cropBoxData={width:canvasData.width,height:canvasData.height};if(aspectRatio){if(canvasData.height*aspectRatio>canvasData.width){cropBoxData.height=cropBoxData.width/aspectRatio;}else{cropBoxData.width=cropBoxData.height*aspectRatio;}}
this.cropBoxData=cropBoxData;this.limitCropBox(true,true);cropBoxData.width=Math.min(Math.max(cropBoxData.width,cropBoxData.minWidth),cropBoxData.maxWidth);cropBoxData.height=Math.min(Math.max(cropBoxData.height,cropBoxData.minHeight),cropBoxData.maxHeight);cropBoxData.width=Math.max(cropBoxData.minWidth,cropBoxData.width*autoCropArea);cropBoxData.height=Math.max(cropBoxData.minHeight,cropBoxData.height*autoCropArea);cropBoxData.left=canvasData.left+(canvasData.width-cropBoxData.width)/2;cropBoxData.top=canvasData.top+(canvasData.height-cropBoxData.height)/2;cropBoxData.oldLeft=cropBoxData.left;cropBoxData.oldTop=cropBoxData.top;this.initialCropBoxData=assign({},cropBoxData);},limitCropBox:function limitCropBox(sizeLimited,positionLimited){var options=this.options,containerData=this.containerData,canvasData=this.canvasData,cropBoxData=this.cropBoxData,limited=this.limited;var aspectRatio=options.aspectRatio;if(sizeLimited){var minCropBoxWidth=Number(options.minCropBoxWidth)||0;var minCropBoxHeight=Number(options.minCropBoxHeight)||0;var maxCropBoxWidth=limited?Math.min(containerData.width,canvasData.width,canvasData.width+canvasData.left,containerData.width-canvasData.left):containerData.width;var maxCropBoxHeight=limited?Math.min(containerData.height,canvasData.height,canvasData.height+canvasData.top,containerData.height-canvasData.top):containerData.height;minCropBoxWidth=Math.min(minCropBoxWidth,containerData.width);minCropBoxHeight=Math.min(minCropBoxHeight,containerData.height);if(aspectRatio){if(minCropBoxWidth&&minCropBoxHeight){if(minCropBoxHeight*aspectRatio>minCropBoxWidth){minCropBoxHeight=minCropBoxWidth/aspectRatio;}else{minCropBoxWidth=minCropBoxHeight*aspectRatio;}}else if(minCropBoxWidth){minCropBoxHeight=minCropBoxWidth/aspectRatio;}else if(minCropBoxHeight){minCropBoxWidth=minCropBoxHeight*aspectRatio;}
if(maxCropBoxHeight*aspectRatio>maxCropBoxWidth){maxCropBoxHeight=maxCropBoxWidth/aspectRatio;}else{maxCropBoxWidth=maxCropBoxHeight*aspectRatio;}}
cropBoxData.minWidth=Math.min(minCropBoxWidth,maxCropBoxWidth);cropBoxData.minHeight=Math.min(minCropBoxHeight,maxCropBoxHeight);cropBoxData.maxWidth=maxCropBoxWidth;cropBoxData.maxHeight=maxCropBoxHeight;}
if(positionLimited){if(limited){cropBoxData.minLeft=Math.max(0,canvasData.left);cropBoxData.minTop=Math.max(0,canvasData.top);cropBoxData.maxLeft=Math.min(containerData.width,canvasData.left+canvasData.width)-cropBoxData.width;cropBoxData.maxTop=Math.min(containerData.height,canvasData.top+canvasData.height)-cropBoxData.height;}else{cropBoxData.minLeft=0;cropBoxData.minTop=0;cropBoxData.maxLeft=containerData.width-cropBoxData.width;cropBoxData.maxTop=containerData.height-cropBoxData.height;}}},renderCropBox:function renderCropBox(){var options=this.options,containerData=this.containerData,cropBoxData=this.cropBoxData;if(cropBoxData.width>cropBoxData.maxWidth||cropBoxData.width<cropBoxData.minWidth){cropBoxData.left=cropBoxData.oldLeft;}
if(cropBoxData.height>cropBoxData.maxHeight||cropBoxData.height<cropBoxData.minHeight){cropBoxData.top=cropBoxData.oldTop;}
cropBoxData.width=Math.min(Math.max(cropBoxData.width,cropBoxData.minWidth),cropBoxData.maxWidth);cropBoxData.height=Math.min(Math.max(cropBoxData.height,cropBoxData.minHeight),cropBoxData.maxHeight);this.limitCropBox(false,true);cropBoxData.left=Math.min(Math.max(cropBoxData.left,cropBoxData.minLeft),cropBoxData.maxLeft);cropBoxData.top=Math.min(Math.max(cropBoxData.top,cropBoxData.minTop),cropBoxData.maxTop);cropBoxData.oldLeft=cropBoxData.left;cropBoxData.oldTop=cropBoxData.top;if(options.movable&&options.cropBoxMovable){setData(this.face,DATA_ACTION,cropBoxData.width>=containerData.width&&cropBoxData.height>=containerData.height?ACTION_MOVE:ACTION_ALL);}
setStyle(this.cropBox,assign({width:cropBoxData.width,height:cropBoxData.height},getTransforms({translateX:cropBoxData.left,translateY:cropBoxData.top})));if(this.cropped&&this.limited){this.limitCanvas(true,true);}
if(!this.disabled){this.output();}},output:function output(){this.preview();dispatchEvent(this.element,EVENT_CROP,this.getData());}};var preview={initPreview:function initPreview(){var element=this.element,crossOrigin=this.crossOrigin;var preview=this.options.preview;var url=crossOrigin?this.crossOriginUrl:this.url;var alt=element.alt||'The image to preview';var image=document.createElement('img');if(crossOrigin){image.crossOrigin=crossOrigin;}
image.src=url;image.alt=alt;this.viewBox.appendChild(image);this.viewBoxImage=image;if(!preview){return;}
var previews=preview;if(typeof preview==='string'){previews=element.ownerDocument.querySelectorAll(preview);}else if(preview.querySelector){previews=[preview];}
this.previews=previews;forEach(previews,function(el){var img=document.createElement('img');setData(el,DATA_PREVIEW,{width:el.offsetWidth,height:el.offsetHeight,html:el.innerHTML});if(crossOrigin){img.crossOrigin=crossOrigin;}
img.src=url;img.alt=alt;img.style.cssText='display:block;'+'width:100%;'+'height:auto;'+'min-width:0!important;'+'min-height:0!important;'+'max-width:none!important;'+'max-height:none!important;'+'image-orientation:0deg!important;"';el.innerHTML='';el.appendChild(img);});},resetPreview:function resetPreview(){forEach(this.previews,function(element){var data=getData(element,DATA_PREVIEW);setStyle(element,{width:data.width,height:data.height});element.innerHTML=data.html;removeData(element,DATA_PREVIEW);});},preview:function preview(){var imageData=this.imageData,canvasData=this.canvasData,cropBoxData=this.cropBoxData;var cropBoxWidth=cropBoxData.width,cropBoxHeight=cropBoxData.height;var width=imageData.width,height=imageData.height;var left=cropBoxData.left-canvasData.left-imageData.left;var top=cropBoxData.top-canvasData.top-imageData.top;if(!this.cropped||this.disabled){return;}
setStyle(this.viewBoxImage,assign({width:width,height:height},getTransforms(assign({translateX:-left,translateY:-top},imageData))));forEach(this.previews,function(element){var data=getData(element,DATA_PREVIEW);var originalWidth=data.width;var originalHeight=data.height;var newWidth=originalWidth;var newHeight=originalHeight;var ratio=1;if(cropBoxWidth){ratio=originalWidth/cropBoxWidth;newHeight=cropBoxHeight*ratio;}
if(cropBoxHeight&&newHeight>originalHeight){ratio=originalHeight/cropBoxHeight;newWidth=cropBoxWidth*ratio;newHeight=originalHeight;}
setStyle(element,{width:newWidth,height:newHeight});setStyle(element.getElementsByTagName('img')[0],assign({width:width*ratio,height:height*ratio},getTransforms(assign({translateX:-left*ratio,translateY:-top*ratio},imageData))));});}};var events={bind:function bind(){var element=this.element,options=this.options,cropper=this.cropper;if(isFunction(options.cropstart)){addListener(element,EVENT_CROP_START,options.cropstart);}
if(isFunction(options.cropmove)){addListener(element,EVENT_CROP_MOVE,options.cropmove);}
if(isFunction(options.cropend)){addListener(element,EVENT_CROP_END,options.cropend);}
if(isFunction(options.crop)){addListener(element,EVENT_CROP,options.crop);}
if(isFunction(options.zoom)){addListener(element,EVENT_ZOOM,options.zoom);}
addListener(cropper,EVENT_POINTER_DOWN,this.onCropStart=this.cropStart.bind(this));if(options.zoomable&&options.zoomOnWheel){addListener(cropper,EVENT_WHEEL,this.onWheel=this.wheel.bind(this),{passive:false,capture:true});}
if(options.toggleDragModeOnDblclick){addListener(cropper,EVENT_DBLCLICK,this.onDblclick=this.dblclick.bind(this));}
addListener(element.ownerDocument,EVENT_POINTER_MOVE,this.onCropMove=this.cropMove.bind(this));addListener(element.ownerDocument,EVENT_POINTER_UP,this.onCropEnd=this.cropEnd.bind(this));if(options.responsive){addListener(window,EVENT_RESIZE,this.onResize=this.resize.bind(this));}},unbind:function unbind(){var element=this.element,options=this.options,cropper=this.cropper;if(isFunction(options.cropstart)){removeListener(element,EVENT_CROP_START,options.cropstart);}
if(isFunction(options.cropmove)){removeListener(element,EVENT_CROP_MOVE,options.cropmove);}
if(isFunction(options.cropend)){removeListener(element,EVENT_CROP_END,options.cropend);}
if(isFunction(options.crop)){removeListener(element,EVENT_CROP,options.crop);}
if(isFunction(options.zoom)){removeListener(element,EVENT_ZOOM,options.zoom);}
removeListener(cropper,EVENT_POINTER_DOWN,this.onCropStart);if(options.zoomable&&options.zoomOnWheel){removeListener(cropper,EVENT_WHEEL,this.onWheel,{passive:false,capture:true});}
if(options.toggleDragModeOnDblclick){removeListener(cropper,EVENT_DBLCLICK,this.onDblclick);}
removeListener(element.ownerDocument,EVENT_POINTER_MOVE,this.onCropMove);removeListener(element.ownerDocument,EVENT_POINTER_UP,this.onCropEnd);if(options.responsive){removeListener(window,EVENT_RESIZE,this.onResize);}}};var handlers={resize:function resize(){var options=this.options,container=this.container,containerData=this.containerData;var minContainerWidth=Number(options.minContainerWidth)||MIN_CONTAINER_WIDTH;var minContainerHeight=Number(options.minContainerHeight)||MIN_CONTAINER_HEIGHT;if(this.disabled||containerData.width<=minContainerWidth||containerData.height<=minContainerHeight){return;}
var ratio=container.offsetWidth/containerData.width;if(ratio!==1||container.offsetHeight!==containerData.height){var canvasData;var cropBoxData;if(options.restore){canvasData=this.getCanvasData();cropBoxData=this.getCropBoxData();}
this.render();if(options.restore){this.setCanvasData(forEach(canvasData,function(n,i){canvasData[i]=n*ratio;}));this.setCropBoxData(forEach(cropBoxData,function(n,i){cropBoxData[i]=n*ratio;}));}}},dblclick:function dblclick(){if(this.disabled||this.options.dragMode===DRAG_MODE_NONE){return;}
this.setDragMode(hasClass(this.dragBox,CLASS_CROP)?DRAG_MODE_MOVE:DRAG_MODE_CROP);},wheel:function wheel(event){var _this=this;var ratio=Number(this.options.wheelZoomRatio)||0.1;var delta=1;if(this.disabled){return;}
event.preventDefault();if(this.wheeling){return;}
this.wheeling=true;setTimeout(function(){_this.wheeling=false;},50);if(event.deltaY){delta=event.deltaY>0?1:-1;}else if(event.wheelDelta){delta=-event.wheelDelta/120;}else if(event.detail){delta=event.detail>0?1:-1;}
this.zoom(-delta*ratio,event);},cropStart:function cropStart(event){var buttons=event.buttons,button=event.button;if(this.disabled||isNumber(buttons)&&buttons!==1||isNumber(button)&&button!==0||event.ctrlKey){return;}
var options=this.options,pointers=this.pointers;var action;if(event.changedTouches){forEach(event.changedTouches,function(touch){pointers[touch.identifier]=getPointer(touch);});}else{pointers[event.pointerId||0]=getPointer(event);}
if(Object.keys(pointers).length>1&&options.zoomable&&options.zoomOnTouch){action=ACTION_ZOOM;}else{action=getData(event.target,DATA_ACTION);}
if(!REGEXP_ACTIONS.test(action)){return;}
if(dispatchEvent(this.element,EVENT_CROP_START,{originalEvent:event,action:action})===false){return;}
event.preventDefault();this.action=action;this.cropping=false;if(action===ACTION_CROP){this.cropping=true;addClass(this.dragBox,CLASS_MODAL);}},cropMove:function cropMove(event){var action=this.action;if(this.disabled||!action){return;}
var pointers=this.pointers;event.preventDefault();if(dispatchEvent(this.element,EVENT_CROP_MOVE,{originalEvent:event,action:action})===false){return;}
if(event.changedTouches){forEach(event.changedTouches,function(touch){assign(pointers[touch.identifier]||{},getPointer(touch,true));});}else{assign(pointers[event.pointerId||0]||{},getPointer(event,true));}
this.change(event);},cropEnd:function cropEnd(event){if(this.disabled){return;}
var action=this.action,pointers=this.pointers;if(event.changedTouches){forEach(event.changedTouches,function(touch){delete pointers[touch.identifier];});}else{delete pointers[event.pointerId||0];}
if(!action){return;}
event.preventDefault();if(!Object.keys(pointers).length){this.action='';}
if(this.cropping){this.cropping=false;toggleClass(this.dragBox,CLASS_MODAL,this.cropped&&this.options.modal);}
dispatchEvent(this.element,EVENT_CROP_END,{originalEvent:event,action:action});}};var change={change:function change(event){var options=this.options,canvasData=this.canvasData,containerData=this.containerData,cropBoxData=this.cropBoxData,pointers=this.pointers;var action=this.action;var aspectRatio=options.aspectRatio;var left=cropBoxData.left,top=cropBoxData.top,width=cropBoxData.width,height=cropBoxData.height;var right=left+width;var bottom=top+height;var minLeft=0;var minTop=0;var maxWidth=containerData.width;var maxHeight=containerData.height;var renderable=true;var offset;if(!aspectRatio&&event.shiftKey){aspectRatio=width&&height?width/height:1;}
if(this.limited){minLeft=cropBoxData.minLeft;minTop=cropBoxData.minTop;maxWidth=minLeft+Math.min(containerData.width,canvasData.width,canvasData.left+canvasData.width);maxHeight=minTop+Math.min(containerData.height,canvasData.height,canvasData.top+canvasData.height);}
var pointer=pointers[Object.keys(pointers)[0]];var range={x:pointer.endX-pointer.startX,y:pointer.endY-pointer.startY};var check=function check(side){switch(side){case ACTION_EAST:if(right+range.x>maxWidth){range.x=maxWidth-right;}
break;case ACTION_WEST:if(left+range.x<minLeft){range.x=minLeft-left;}
break;case ACTION_NORTH:if(top+range.y<minTop){range.y=minTop-top;}
break;case ACTION_SOUTH:if(bottom+range.y>maxHeight){range.y=maxHeight-bottom;}
break;default:}};switch(action){case ACTION_ALL:left+=range.x;top+=range.y;break;case ACTION_EAST:if(range.x>=0&&(right>=maxWidth||aspectRatio&&(top<=minTop||bottom>=maxHeight))){renderable=false;break;}
check(ACTION_EAST);width+=range.x;if(width<0){action=ACTION_WEST;width=-width;left-=width;}
if(aspectRatio){height=width/aspectRatio;top+=(cropBoxData.height-height)/2;}
break;case ACTION_NORTH:if(range.y<=0&&(top<=minTop||aspectRatio&&(left<=minLeft||right>=maxWidth))){renderable=false;break;}
check(ACTION_NORTH);height-=range.y;top+=range.y;if(height<0){action=ACTION_SOUTH;height=-height;top-=height;}
if(aspectRatio){width=height*aspectRatio;left+=(cropBoxData.width-width)/2;}
break;case ACTION_WEST:if(range.x<=0&&(left<=minLeft||aspectRatio&&(top<=minTop||bottom>=maxHeight))){renderable=false;break;}
check(ACTION_WEST);width-=range.x;left+=range.x;if(width<0){action=ACTION_EAST;width=-width;left-=width;}
if(aspectRatio){height=width/aspectRatio;top+=(cropBoxData.height-height)/2;}
break;case ACTION_SOUTH:if(range.y>=0&&(bottom>=maxHeight||aspectRatio&&(left<=minLeft||right>=maxWidth))){renderable=false;break;}
check(ACTION_SOUTH);height+=range.y;if(height<0){action=ACTION_NORTH;height=-height;top-=height;}
if(aspectRatio){width=height*aspectRatio;left+=(cropBoxData.width-width)/2;}
break;case ACTION_NORTH_EAST:if(aspectRatio){if(range.y<=0&&(top<=minTop||right>=maxWidth)){renderable=false;break;}
check(ACTION_NORTH);height-=range.y;top+=range.y;width=height*aspectRatio;}else{check(ACTION_NORTH);check(ACTION_EAST);if(range.x>=0){if(right<maxWidth){width+=range.x;}else if(range.y<=0&&top<=minTop){renderable=false;}}else{width+=range.x;}
if(range.y<=0){if(top>minTop){height-=range.y;top+=range.y;}}else{height-=range.y;top+=range.y;}}
if(width<0&&height<0){action=ACTION_SOUTH_WEST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_NORTH_WEST;width=-width;left-=width;}else if(height<0){action=ACTION_SOUTH_EAST;height=-height;top-=height;}
break;case ACTION_NORTH_WEST:if(aspectRatio){if(range.y<=0&&(top<=minTop||left<=minLeft)){renderable=false;break;}
check(ACTION_NORTH);height-=range.y;top+=range.y;width=height*aspectRatio;left+=cropBoxData.width-width;}else{check(ACTION_NORTH);check(ACTION_WEST);if(range.x<=0){if(left>minLeft){width-=range.x;left+=range.x;}else if(range.y<=0&&top<=minTop){renderable=false;}}else{width-=range.x;left+=range.x;}
if(range.y<=0){if(top>minTop){height-=range.y;top+=range.y;}}else{height-=range.y;top+=range.y;}}
if(width<0&&height<0){action=ACTION_SOUTH_EAST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_NORTH_EAST;width=-width;left-=width;}else if(height<0){action=ACTION_SOUTH_WEST;height=-height;top-=height;}
break;case ACTION_SOUTH_WEST:if(aspectRatio){if(range.x<=0&&(left<=minLeft||bottom>=maxHeight)){renderable=false;break;}
check(ACTION_WEST);width-=range.x;left+=range.x;height=width/aspectRatio;}else{check(ACTION_SOUTH);check(ACTION_WEST);if(range.x<=0){if(left>minLeft){width-=range.x;left+=range.x;}else if(range.y>=0&&bottom>=maxHeight){renderable=false;}}else{width-=range.x;left+=range.x;}
if(range.y>=0){if(bottom<maxHeight){height+=range.y;}}else{height+=range.y;}}
if(width<0&&height<0){action=ACTION_NORTH_EAST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_SOUTH_EAST;width=-width;left-=width;}else if(height<0){action=ACTION_NORTH_WEST;height=-height;top-=height;}
break;case ACTION_SOUTH_EAST:if(aspectRatio){if(range.x>=0&&(right>=maxWidth||bottom>=maxHeight)){renderable=false;break;}
check(ACTION_EAST);width+=range.x;height=width/aspectRatio;}else{check(ACTION_SOUTH);check(ACTION_EAST);if(range.x>=0){if(right<maxWidth){width+=range.x;}else if(range.y>=0&&bottom>=maxHeight){renderable=false;}}else{width+=range.x;}
if(range.y>=0){if(bottom<maxHeight){height+=range.y;}}else{height+=range.y;}}
if(width<0&&height<0){action=ACTION_NORTH_WEST;height=-height;width=-width;top-=height;left-=width;}else if(width<0){action=ACTION_SOUTH_WEST;width=-width;left-=width;}else if(height<0){action=ACTION_NORTH_EAST;height=-height;top-=height;}
break;case ACTION_MOVE:this.move(range.x,range.y);renderable=false;break;case ACTION_ZOOM:this.zoom(getMaxZoomRatio(pointers),event);renderable=false;break;case ACTION_CROP:if(!range.x||!range.y){renderable=false;break;}
offset=getOffset(this.cropper);left=pointer.startX-offset.left;top=pointer.startY-offset.top;width=cropBoxData.minWidth;height=cropBoxData.minHeight;if(range.x>0){action=range.y>0?ACTION_SOUTH_EAST:ACTION_NORTH_EAST;}else if(range.x<0){left-=width;action=range.y>0?ACTION_SOUTH_WEST:ACTION_NORTH_WEST;}
if(range.y<0){top-=height;}
if(!this.cropped){removeClass(this.cropBox,CLASS_HIDDEN);this.cropped=true;if(this.limited){this.limitCropBox(true,true);}}
break;default:}
if(renderable){cropBoxData.width=width;cropBoxData.height=height;cropBoxData.left=left;cropBoxData.top=top;this.action=action;this.renderCropBox();}
forEach(pointers,function(p){p.startX=p.endX;p.startY=p.endY;});}};var methods={crop:function crop(){if(this.ready&&!this.cropped&&!this.disabled){this.cropped=true;this.limitCropBox(true,true);if(this.options.modal){addClass(this.dragBox,CLASS_MODAL);}
removeClass(this.cropBox,CLASS_HIDDEN);this.setCropBoxData(this.initialCropBoxData);}
return this;},reset:function reset(){if(this.ready&&!this.disabled){this.imageData=assign({},this.initialImageData);this.canvasData=assign({},this.initialCanvasData);this.cropBoxData=assign({},this.initialCropBoxData);this.renderCanvas();if(this.cropped){this.renderCropBox();}}
return this;},clear:function clear(){if(this.cropped&&!this.disabled){assign(this.cropBoxData,{left:0,top:0,width:0,height:0});this.cropped=false;this.renderCropBox();this.limitCanvas(true,true);this.renderCanvas();removeClass(this.dragBox,CLASS_MODAL);addClass(this.cropBox,CLASS_HIDDEN);}
return this;},replace:function replace(url){var hasSameSize=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this.disabled&&url){if(this.isImg){this.element.src=url;}
if(hasSameSize){this.url=url;this.image.src=url;if(this.ready){this.viewBoxImage.src=url;forEach(this.previews,function(element){element.getElementsByTagName('img')[0].src=url;});}}else{if(this.isImg){this.replaced=true;}
this.options.data=null;this.uncreate();this.load(url);}}
return this;},enable:function enable(){if(this.ready&&this.disabled){this.disabled=false;removeClass(this.cropper,CLASS_DISABLED);}
return this;},disable:function disable(){if(this.ready&&!this.disabled){this.disabled=true;addClass(this.cropper,CLASS_DISABLED);}
return this;},destroy:function destroy(){var element=this.element;if(!element[NAMESPACE]){return this;}
element[NAMESPACE]=undefined;if(this.isImg&&this.replaced){element.src=this.originalUrl;}
this.uncreate();return this;},move:function move(offsetX){var offsetY=arguments.length>1&&arguments[1]!==undefined?arguments[1]:offsetX;var _this$canvasData=this.canvasData,left=_this$canvasData.left,top=_this$canvasData.top;return this.moveTo(isUndefined(offsetX)?offsetX:left+Number(offsetX),isUndefined(offsetY)?offsetY:top+Number(offsetY));},moveTo:function moveTo(x){var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:x;var canvasData=this.canvasData;var changed=false;x=Number(x);y=Number(y);if(this.ready&&!this.disabled&&this.options.movable){if(isNumber(x)){canvasData.left=x;changed=true;}
if(isNumber(y)){canvasData.top=y;changed=true;}
if(changed){this.renderCanvas(true);}}
return this;},zoom:function zoom(ratio,_originalEvent){var canvasData=this.canvasData;ratio=Number(ratio);if(ratio<0){ratio=1/(1-ratio);}else{ratio=1+ratio;}
return this.zoomTo(canvasData.width*ratio/canvasData.naturalWidth,null,_originalEvent);},zoomTo:function zoomTo(ratio,pivot,_originalEvent){var options=this.options,canvasData=this.canvasData;var width=canvasData.width,height=canvasData.height,naturalWidth=canvasData.naturalWidth,naturalHeight=canvasData.naturalHeight;ratio=Number(ratio);if(ratio>=0&&this.ready&&!this.disabled&&options.zoomable){var newWidth=naturalWidth*ratio;var newHeight=naturalHeight*ratio;if(dispatchEvent(this.element,EVENT_ZOOM,{ratio:ratio,oldRatio:width/naturalWidth,originalEvent:_originalEvent})===false){return this;}
if(_originalEvent){var pointers=this.pointers;var offset=getOffset(this.cropper);var center=pointers&&Object.keys(pointers).length?getPointersCenter(pointers):{pageX:_originalEvent.pageX,pageY:_originalEvent.pageY};canvasData.left-=(newWidth-width)*((center.pageX-offset.left-canvasData.left)/width);canvasData.top-=(newHeight-height)*((center.pageY-offset.top-canvasData.top)/height);}else if(isPlainObject(pivot)&&isNumber(pivot.x)&&isNumber(pivot.y)){canvasData.left-=(newWidth-width)*((pivot.x-canvasData.left)/width);canvasData.top-=(newHeight-height)*((pivot.y-canvasData.top)/height);}else{canvasData.left-=(newWidth-width)/2;canvasData.top-=(newHeight-height)/2;}
canvasData.width=newWidth;canvasData.height=newHeight;this.renderCanvas(true);}
return this;},rotate:function rotate(degree){return this.rotateTo((this.imageData.rotate||0)+Number(degree));},rotateTo:function rotateTo(degree){degree=Number(degree);if(isNumber(degree)&&this.ready&&!this.disabled&&this.options.rotatable){this.imageData.rotate=degree%360;this.renderCanvas(true,true);}
return this;},scaleX:function scaleX(_scaleX){var scaleY=this.imageData.scaleY;return this.scale(_scaleX,isNumber(scaleY)?scaleY:1);},scaleY:function scaleY(_scaleY){var scaleX=this.imageData.scaleX;return this.scale(isNumber(scaleX)?scaleX:1,_scaleY);},scale:function scale(scaleX){var scaleY=arguments.length>1&&arguments[1]!==undefined?arguments[1]:scaleX;var imageData=this.imageData;var transformed=false;scaleX=Number(scaleX);scaleY=Number(scaleY);if(this.ready&&!this.disabled&&this.options.scalable){if(isNumber(scaleX)){imageData.scaleX=scaleX;transformed=true;}
if(isNumber(scaleY)){imageData.scaleY=scaleY;transformed=true;}
if(transformed){this.renderCanvas(true,true);}}
return this;},getData:function getData(){var rounded=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var options=this.options,imageData=this.imageData,canvasData=this.canvasData,cropBoxData=this.cropBoxData;var data;if(this.ready&&this.cropped){data={x:cropBoxData.left-canvasData.left,y:cropBoxData.top-canvasData.top,width:cropBoxData.width,height:cropBoxData.height};var ratio=imageData.width/imageData.naturalWidth;forEach(data,function(n,i){data[i]=n/ratio;});if(rounded){var bottom=Math.round(data.y+data.height);var right=Math.round(data.x+data.width);data.x=Math.round(data.x);data.y=Math.round(data.y);data.width=right-data.x;data.height=bottom-data.y;}}else{data={x:0,y:0,width:0,height:0};}
if(options.rotatable){data.rotate=imageData.rotate||0;}
if(options.scalable){data.scaleX=imageData.scaleX||1;data.scaleY=imageData.scaleY||1;}
return data;},setData:function setData(data){var options=this.options,imageData=this.imageData,canvasData=this.canvasData;var cropBoxData={};if(this.ready&&!this.disabled&&isPlainObject(data)){var transformed=false;if(options.rotatable){if(isNumber(data.rotate)&&data.rotate!==imageData.rotate){imageData.rotate=data.rotate;transformed=true;}}
if(options.scalable){if(isNumber(data.scaleX)&&data.scaleX!==imageData.scaleX){imageData.scaleX=data.scaleX;transformed=true;}
if(isNumber(data.scaleY)&&data.scaleY!==imageData.scaleY){imageData.scaleY=data.scaleY;transformed=true;}}
if(transformed){this.renderCanvas(true,true);}
var ratio=imageData.width/imageData.naturalWidth;if(isNumber(data.x)){cropBoxData.left=data.x*ratio+canvasData.left;}
if(isNumber(data.y)){cropBoxData.top=data.y*ratio+canvasData.top;}
if(isNumber(data.width)){cropBoxData.width=data.width*ratio;}
if(isNumber(data.height)){cropBoxData.height=data.height*ratio;}
this.setCropBoxData(cropBoxData);}
return this;},getContainerData:function getContainerData(){return this.ready?assign({},this.containerData):{};},getImageData:function getImageData(){return this.sized?assign({},this.imageData):{};},getCanvasData:function getCanvasData(){var canvasData=this.canvasData;var data={};if(this.ready){forEach(['left','top','width','height','naturalWidth','naturalHeight'],function(n){data[n]=canvasData[n];});}
return data;},setCanvasData:function setCanvasData(data){var canvasData=this.canvasData;var aspectRatio=canvasData.aspectRatio;if(this.ready&&!this.disabled&&isPlainObject(data)){if(isNumber(data.left)){canvasData.left=data.left;}
if(isNumber(data.top)){canvasData.top=data.top;}
if(isNumber(data.width)){canvasData.width=data.width;canvasData.height=data.width/aspectRatio;}else if(isNumber(data.height)){canvasData.height=data.height;canvasData.width=data.height*aspectRatio;}
this.renderCanvas(true);}
return this;},getCropBoxData:function getCropBoxData(){var cropBoxData=this.cropBoxData;var data;if(this.ready&&this.cropped){data={left:cropBoxData.left,top:cropBoxData.top,width:cropBoxData.width,height:cropBoxData.height};}
return data||{};},setCropBoxData:function setCropBoxData(data){var cropBoxData=this.cropBoxData;var aspectRatio=this.options.aspectRatio;var widthChanged;var heightChanged;if(this.ready&&this.cropped&&!this.disabled&&isPlainObject(data)){if(isNumber(data.left)){cropBoxData.left=data.left;}
if(isNumber(data.top)){cropBoxData.top=data.top;}
if(isNumber(data.width)&&data.width!==cropBoxData.width){widthChanged=true;cropBoxData.width=data.width;}
if(isNumber(data.height)&&data.height!==cropBoxData.height){heightChanged=true;cropBoxData.height=data.height;}
if(aspectRatio){if(widthChanged){cropBoxData.height=cropBoxData.width/aspectRatio;}else if(heightChanged){cropBoxData.width=cropBoxData.height*aspectRatio;}}
this.renderCropBox();}
return this;},getCroppedCanvas:function getCroppedCanvas(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!this.ready||!window.HTMLCanvasElement){return null;}
var canvasData=this.canvasData;var source=getSourceCanvas(this.image,this.imageData,canvasData,options);if(!this.cropped){return source;}
var _this$getData=this.getData(),initialX=_this$getData.x,initialY=_this$getData.y,initialWidth=_this$getData.width,initialHeight=_this$getData.height;var ratio=source.width/Math.floor(canvasData.naturalWidth);if(ratio!==1){initialX*=ratio;initialY*=ratio;initialWidth*=ratio;initialHeight*=ratio;}
var aspectRatio=initialWidth/initialHeight;var maxSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:options.maxWidth||Infinity,height:options.maxHeight||Infinity});var minSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:options.minWidth||0,height:options.minHeight||0},'cover');var _getAdjustedSizes=getAdjustedSizes({aspectRatio:aspectRatio,width:options.width||(ratio!==1?source.width:initialWidth),height:options.height||(ratio!==1?source.height:initialHeight)}),width=_getAdjustedSizes.width,height=_getAdjustedSizes.height;width=Math.min(maxSizes.width,Math.max(minSizes.width,width));height=Math.min(maxSizes.height,Math.max(minSizes.height,height));var canvas=document.createElement('canvas');var context=canvas.getContext('2d');canvas.width=normalizeDecimalNumber(width);canvas.height=normalizeDecimalNumber(height);context.fillStyle=options.fillColor||'transparent';context.fillRect(0,0,width,height);var _options$imageSmoothi=options.imageSmoothingEnabled,imageSmoothingEnabled=_options$imageSmoothi===void 0?true:_options$imageSmoothi,imageSmoothingQuality=options.imageSmoothingQuality;context.imageSmoothingEnabled=imageSmoothingEnabled;if(imageSmoothingQuality){context.imageSmoothingQuality=imageSmoothingQuality;}
var sourceWidth=source.width;var sourceHeight=source.height;var srcX=initialX;var srcY=initialY;var srcWidth;var srcHeight;var dstX;var dstY;var dstWidth;var dstHeight;if(srcX<=-initialWidth||srcX>sourceWidth){srcX=0;srcWidth=0;dstX=0;dstWidth=0;}else if(srcX<=0){dstX=-srcX;srcX=0;srcWidth=Math.min(sourceWidth,initialWidth+srcX);dstWidth=srcWidth;}else if(srcX<=sourceWidth){dstX=0;srcWidth=Math.min(initialWidth,sourceWidth-srcX);dstWidth=srcWidth;}
if(srcWidth<=0||srcY<=-initialHeight||srcY>sourceHeight){srcY=0;srcHeight=0;dstY=0;dstHeight=0;}else if(srcY<=0){dstY=-srcY;srcY=0;srcHeight=Math.min(sourceHeight,initialHeight+srcY);dstHeight=srcHeight;}else if(srcY<=sourceHeight){dstY=0;srcHeight=Math.min(initialHeight,sourceHeight-srcY);dstHeight=srcHeight;}
var params=[srcX,srcY,srcWidth,srcHeight];if(dstWidth>0&&dstHeight>0){var scale=width/initialWidth;params.push(dstX*scale,dstY*scale,dstWidth*scale,dstHeight*scale);}
context.drawImage.apply(context,[source].concat(_toConsumableArray(params.map(function(param){return Math.floor(normalizeDecimalNumber(param));}))));return canvas;},setAspectRatio:function setAspectRatio(aspectRatio){var options=this.options;if(!this.disabled&&!isUndefined(aspectRatio)){options.aspectRatio=Math.max(0,aspectRatio)||NaN;if(this.ready){this.initCropBox();if(this.cropped){this.renderCropBox();}}}
return this;},setDragMode:function setDragMode(mode){var options=this.options,dragBox=this.dragBox,face=this.face;if(this.ready&&!this.disabled){var croppable=mode===DRAG_MODE_CROP;var movable=options.movable&&mode===DRAG_MODE_MOVE;mode=croppable||movable?mode:DRAG_MODE_NONE;options.dragMode=mode;setData(dragBox,DATA_ACTION,mode);toggleClass(dragBox,CLASS_CROP,croppable);toggleClass(dragBox,CLASS_MOVE,movable);if(!options.cropBoxMovable){setData(face,DATA_ACTION,mode);toggleClass(face,CLASS_CROP,croppable);toggleClass(face,CLASS_MOVE,movable);}}
return this;}};var AnotherCropper=WINDOW.Cropper;var Cropper=function(){function Cropper(element){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};_classCallCheck(this,Cropper);if(!element||!REGEXP_TAG_NAME.test(element.tagName)){throw new Error('The first argument is required and must be an <img> or <canvas> element.');}
this.element=element;this.options=assign({},DEFAULTS,isPlainObject(options)&&options);this.cropped=false;this.disabled=false;this.pointers={};this.ready=false;this.reloading=false;this.replaced=false;this.sized=false;this.sizing=false;this.init();}
_createClass(Cropper,[{key:"init",value:function init(){var element=this.element;var tagName=element.tagName.toLowerCase();var url;if(element[NAMESPACE]){return;}
element[NAMESPACE]=this;if(tagName==='img'){this.isImg=true;url=element.getAttribute('src')||'';this.originalUrl=url;if(!url){return;}
url=element.src;}else if(tagName==='canvas'&&window.HTMLCanvasElement){url=element.toDataURL();}
this.load(url);}},{key:"load",value:function load(url){var _this=this;if(!url){return;}
this.url=url;this.imageData={};var element=this.element,options=this.options;if(!options.rotatable&&!options.scalable){options.checkOrientation=false;}
if(!options.checkOrientation||!window.ArrayBuffer){this.clone();return;}
if(REGEXP_DATA_URL.test(url)){if(REGEXP_DATA_URL_JPEG.test(url)){this.read(dataURLToArrayBuffer(url));}else{this.clone();}
return;}
var xhr=new XMLHttpRequest();var clone=this.clone.bind(this);this.reloading=true;this.xhr=xhr;xhr.onabort=clone;xhr.onerror=clone;xhr.ontimeout=clone;xhr.onprogress=function(){if(xhr.getResponseHeader('content-type')!==MIME_TYPE_JPEG){xhr.abort();}};xhr.onload=function(){_this.read(xhr.response);};xhr.onloadend=function(){_this.reloading=false;_this.xhr=null;};if(options.checkCrossOrigin&&isCrossOriginURL(url)&&element.crossOrigin){url=addTimestamp(url);}
xhr.open('GET',url);xhr.responseType='arraybuffer';xhr.withCredentials=element.crossOrigin==='use-credentials';xhr.send();}},{key:"read",value:function read(arrayBuffer){var options=this.options,imageData=this.imageData;var orientation=resetAndGetOrientation(arrayBuffer);var rotate=0;var scaleX=1;var scaleY=1;if(orientation>1){this.url=arrayBufferToDataURL(arrayBuffer,MIME_TYPE_JPEG);var _parseOrientation=parseOrientation(orientation);rotate=_parseOrientation.rotate;scaleX=_parseOrientation.scaleX;scaleY=_parseOrientation.scaleY;}
if(options.rotatable){imageData.rotate=rotate;}
if(options.scalable){imageData.scaleX=scaleX;imageData.scaleY=scaleY;}
this.clone();}},{key:"clone",value:function clone(){var element=this.element,url=this.url;var crossOrigin=element.crossOrigin;var crossOriginUrl=url;if(this.options.checkCrossOrigin&&isCrossOriginURL(url)){if(!crossOrigin){crossOrigin='anonymous';}
crossOriginUrl=addTimestamp(url);}
this.crossOrigin=crossOrigin;this.crossOriginUrl=crossOriginUrl;var image=document.createElement('img');if(crossOrigin){image.crossOrigin=crossOrigin;}
image.src=crossOriginUrl||url;image.alt=element.alt||'The image to crop';this.image=image;image.onload=this.start.bind(this);image.onerror=this.stop.bind(this);addClass(image,CLASS_HIDE);element.parentNode.insertBefore(image,element.nextSibling);}},{key:"start",value:function start(){var _this2=this;var image=this.image;image.onload=null;image.onerror=null;this.sizing=true;var isIOSWebKit=WINDOW.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(WINDOW.navigator.userAgent);var done=function done(naturalWidth,naturalHeight){assign(_this2.imageData,{naturalWidth:naturalWidth,naturalHeight:naturalHeight,aspectRatio:naturalWidth/naturalHeight});_this2.sizing=false;_this2.sized=true;_this2.build();};if(image.naturalWidth&&!isIOSWebKit){done(image.naturalWidth,image.naturalHeight);return;}
var sizingImage=document.createElement('img');var body=document.body||document.documentElement;this.sizingImage=sizingImage;sizingImage.onload=function(){done(sizingImage.width,sizingImage.height);if(!isIOSWebKit){body.removeChild(sizingImage);}};sizingImage.src=image.src;if(!isIOSWebKit){sizingImage.style.cssText='left:0;'+'max-height:none!important;'+'max-width:none!important;'+'min-height:0!important;'+'min-width:0!important;'+'opacity:0;'+'position:absolute;'+'top:0;'+'z-index:-1;';body.appendChild(sizingImage);}}},{key:"stop",value:function stop(){var image=this.image;image.onload=null;image.onerror=null;image.parentNode.removeChild(image);this.image=null;}},{key:"build",value:function build(){if(!this.sized||this.ready){return;}
var element=this.element,options=this.options,image=this.image;var container=element.parentNode;var template=document.createElement('div');template.innerHTML=TEMPLATE;var cropper=template.querySelector(".".concat(NAMESPACE,"-container"));var canvas=cropper.querySelector(".".concat(NAMESPACE,"-canvas"));var dragBox=cropper.querySelector(".".concat(NAMESPACE,"-drag-box"));var cropBox=cropper.querySelector(".".concat(NAMESPACE,"-crop-box"));var face=cropBox.querySelector(".".concat(NAMESPACE,"-face"));this.container=container;this.cropper=cropper;this.canvas=canvas;this.dragBox=dragBox;this.cropBox=cropBox;this.viewBox=cropper.querySelector(".".concat(NAMESPACE,"-view-box"));this.face=face;canvas.appendChild(image);addClass(element,CLASS_HIDDEN);container.insertBefore(cropper,element.nextSibling);if(!this.isImg){removeClass(image,CLASS_HIDE);}
this.initPreview();this.bind();options.initialAspectRatio=Math.max(0,options.initialAspectRatio)||NaN;options.aspectRatio=Math.max(0,options.aspectRatio)||NaN;options.viewMode=Math.max(0,Math.min(3,Math.round(options.viewMode)))||0;addClass(cropBox,CLASS_HIDDEN);if(!options.guides){addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-dashed")),CLASS_HIDDEN);}
if(!options.center){addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-center")),CLASS_HIDDEN);}
if(options.background){addClass(cropper,"".concat(NAMESPACE,"-bg"));}
if(!options.highlight){addClass(face,CLASS_INVISIBLE);}
if(options.cropBoxMovable){addClass(face,CLASS_MOVE);setData(face,DATA_ACTION,ACTION_ALL);}
if(!options.cropBoxResizable){addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-line")),CLASS_HIDDEN);addClass(cropBox.getElementsByClassName("".concat(NAMESPACE,"-point")),CLASS_HIDDEN);}
this.render();this.ready=true;this.setDragMode(options.dragMode);if(options.autoCrop){this.crop();}
this.setData(options.data);if(isFunction(options.ready)){addListener(element,EVENT_READY,options.ready,{once:true});}
dispatchEvent(element,EVENT_READY);}},{key:"unbuild",value:function unbuild(){if(!this.ready){return;}
this.ready=false;this.unbind();this.resetPreview();this.cropper.parentNode.removeChild(this.cropper);removeClass(this.element,CLASS_HIDDEN);}},{key:"uncreate",value:function uncreate(){if(this.ready){this.unbuild();this.ready=false;this.cropped=false;}else if(this.sizing){this.sizingImage.onload=null;this.sizing=false;this.sized=false;}else if(this.reloading){this.xhr.onabort=null;this.xhr.abort();}else if(this.image){this.stop();}}}],[{key:"noConflict",value:function noConflict(){window.Cropper=AnotherCropper;return Cropper;}},{key:"setDefaults",value:function setDefaults(options){assign(DEFAULTS,isPlainObject(options)&&options);}}]);return Cropper;}();assign(Cropper.prototype,render,preview,events,handlers,change,methods);return Cropper;}));;

/* /web_editor/static/lib/jquery-cropper/jquery-cropper.js defined in bundle 'web.qunit_suite_tests' */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?factory(require('jquery'),require('cropperjs')):typeof define==='function'&&define.amd?define(['jquery','cropperjs'],factory):(factory(global.jQuery,global.Cropper));}(this,(function($,Cropper){'use strict';$=$&&$.hasOwnProperty('default')?$['default']:$;Cropper=Cropper&&Cropper.hasOwnProperty('default')?Cropper['default']:Cropper;if($.fn){var AnotherCropper=$.fn.cropper;var NAMESPACE='cropper';$.fn.cropper=function jQueryCropper(option){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
var result=void 0;this.each(function(i,element){var $element=$(element);var isDestroy=option==='destroy';var cropper=$element.data(NAMESPACE);if(!cropper){if(isDestroy){return;}
var options=$.extend({},$element.data(),$.isPlainObject(option)&&option);cropper=new Cropper(element,options);$element.data(NAMESPACE,cropper);}
if(typeof option==='string'){var fn=cropper[option];if($.isFunction(fn)){result=fn.apply(cropper,args);if(result===cropper){result=undefined;}
if(isDestroy){$element.removeData(NAMESPACE);}}}});return result!==undefined?result:this;};$.fn.cropper.Constructor=Cropper;$.fn.cropper.setDefaults=Cropper.setDefaults;$.fn.cropper.noConflict=function noConflict(){$.fn.cropper=AnotherCropper;return this;};}})));;

/* /web_editor/static/lib/jQuery.transfo.js defined in bundle 'web.qunit_suite_tests' */
(function($){'use strict';var rad=Math.PI/180;var methods={init:function(settings){return this.each(function(){var $this=$(this),transfo=$this.data('transfo');if(!transfo){_init($this,settings);}else{_overwriteOptions($this,transfo,settings);_targetCss($this,transfo);}});},destroy:function(){return this.each(function(){var $this=$(this);if($this.data('transfo')){_destroy($this);}});},reset:function(){return this.each(function(){var $this=$(this);if($this.data('transfo')){_reset($this);}});},toggle:function(){return this.each(function(){var $this=$(this);var transfo=$this.data('transfo');if(transfo){transfo.settings.hide=!transfo.settings.hide;_showHide($this,transfo);}});},hide:function(){return this.each(function(){var $this=$(this);var transfo=$this.data('transfo');if(transfo){transfo.settings.hide=true;_showHide($this,transfo);}});},show:function(){return this.each(function(){var $this=$(this);var transfo=$this.data('transfo');if(transfo){transfo.settings.hide=false;_showHide($this,transfo);}});},settings:function(){if(this.length>1){this.map(function(){var $this=$(this);return $this.data('transfo')&&$this.data('transfo').settings;});}
return this.data('transfo')&&$this.data('transfo').settings;},center:function(){if(this.length>1){this.map(function(){var $this=$(this);return $this.data('transfo')&&$this.data('transfo').$center.offset();});}
return this.data('transfo')&&this.data('transfo').$center.offset();}};$.fn.transfo=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method '+method+' does not exist on jQuery.transfo');}
return false;};function _init($this,settings){var transfo={};$this.data('transfo',transfo);transfo.settings=settings;var css="box-sizing: border-box; position: absolute; background-color: #fff; border: 1px solid #ccc; width: 8px; height: 8px; margin-left: -4px; margin-top: -4px;";transfo.$markup=$(''
+'<div class="transfo-container">'
+'<div class="transfo-controls">'
+'<div style="cursor: crosshair; position: absolute; margin: -30px; top: 0; right: 0; padding: 1px 0 0 1px;" class="transfo-rotator">'
+'<span class="fa-stack fa-lg">'
+'<i class="fa fa-circle fa-stack-2x"></i>'
+'<i class="fa fa-repeat fa-stack-1x fa-inverse"></i>'
+'</span>'
+'</div>'
+'<div style="'+css+'top: 0%; left: 0%; cursor: nw-resize;" class="transfo-scaler-tl"></div>'
+'<div style="'+css+'top: 0%; left: 100%; cursor: ne-resize;" class="transfo-scaler-tr"></div>'
+'<div style="'+css+'top: 100%; left: 100%; cursor: se-resize;" class="transfo-scaler-br"></div>'
+'<div style="'+css+'top: 100%; left: 0%; cursor: sw-resize;" class="transfo-scaler-bl"></div>'
+'<div style="'+css+'top: 0%; left: 50%; cursor: n-resize;" class="transfo-scaler-tc"></div>'
+'<div style="'+css+'top: 100%; left: 50%; cursor: s-resize;" class="transfo-scaler-bc"></div>'
+'<div style="'+css+'top: 50%; left: 0%; cursor: w-resize;" class="transfo-scaler-ml"></div>'
+'<div style="'+css+'top: 50%; left: 100%; cursor: e-resize;" class="transfo-scaler-mr"></div>'
+'<div style="'+css+'border: 0; width: 0px; height: 0px; top: 50%; left: 50%;" class="transfo-scaler-mc"></div>'
+'</div>'
+'</div>');transfo.$center=transfo.$markup.find(".transfo-scaler-mc");_setOptions($this,transfo);_overwriteOptions($this,transfo,settings);$("body").append(transfo.$markup);setTimeout(function(){_targetCss($this,transfo);},0);_bind($this,transfo);_targetCss($this,transfo);_stop_animation($this[0]);}
function _overwriteOptions($this,transfo,settings){transfo.settings=$.extend(transfo.settings,settings||{});}
function _stop_animation(target){target.style.webkitAnimationPlayState="paused";target.style.animationPlayState="paused";target.style.webkitTransition="none";target.style.transition="none";}
function _setOptions($this,transfo){var style=$this.attr("style")||"";var transform=style.match(/transform\s*:([^;]+)/)?style.match(/transform\s*:([^;]+)/)[1]:"";transfo.settings={};transfo.settings.angle=transform.indexOf('rotate')!=-1?parseFloat(transform.match(/rotate\(([^)]+)deg\)/)[1]):0;transfo.settings.scalex=transform.indexOf('scaleX')!=-1?parseFloat(transform.match(/scaleX\(([^)]+)\)/)[1]):1;transfo.settings.scaley=transform.indexOf('scaleY')!=-1?parseFloat(transform.match(/scaleY\(([^)]+)\)/)[1]):1;transfo.settings.style=style.replace(/[^;]*transform[^;]+/g,'').replace(/;+/g,';');$this.attr("style",transfo.settings.style);_stop_animation($this[0]);transfo.settings.pos=$this.offset();transfo.settings.height=$this.innerHeight();transfo.settings.width=$this.innerWidth();var translatex=transform.match(/translateX\(([0-9.-]+)(%|px)\)/);var translatey=transform.match(/translateY\(([0-9.-]+)(%|px)\)/);transfo.settings.translate="%";if(translatex&&translatex[2]==="%"){transfo.settings.translatexp=parseFloat(translatex[1]);transfo.settings.translatex=transfo.settings.translatexp/100*transfo.settings.width;}else{transfo.settings.translatex=translatex?parseFloat(translatex[1]):0;}
if(translatey&&translatey[2]==="%"){transfo.settings.translateyp=parseFloat(translatey[1]);transfo.settings.translatey=transfo.settings.translateyp/100*transfo.settings.height;}else{transfo.settings.translatey=translatey?parseFloat(translatey[1]):0;}
transfo.settings.css=window.getComputedStyle($this[0],null);transfo.settings.rotationStep=5;transfo.settings.hide=false;transfo.settings.callback=function(){};}
function _bind($this,transfo){function mousedown(event){_mouseDown($this,this,transfo,event);$(document).on("mousemove",mousemove).on("mouseup",mouseup);}
function mousemove(event){_mouseMove($this,this,transfo,event);}
function mouseup(event){_mouseUp($this,this,transfo,event);$(document).off("mousemove",mousemove).off("mouseup",mouseup);}
transfo.$markup.off().on("mousedown",mousedown);transfo.$markup.find(".transfo-controls >:not(.transfo-scaler-mc)").off().on("mousedown",mousedown);}
function _mouseDown($this,div,transfo,event){event.preventDefault();if(transfo.active||event.which!==1)return;var type="position",$e=$(div);if($e.hasClass("transfo-rotator"))type="rotator";else if($e.hasClass("transfo-scaler-tl"))type="tl";else if($e.hasClass("transfo-scaler-tr"))type="tr";else if($e.hasClass("transfo-scaler-br"))type="br";else if($e.hasClass("transfo-scaler-bl"))type="bl";else if($e.hasClass("transfo-scaler-tc"))type="tc";else if($e.hasClass("transfo-scaler-bc"))type="bc";else if($e.hasClass("transfo-scaler-ml"))type="ml";else if($e.hasClass("transfo-scaler-mr"))type="mr";transfo.active={"type":type,"scalex":transfo.settings.scalex,"scaley":transfo.settings.scaley,"pageX":event.pageX,"pageY":event.pageY,"center":transfo.$center.offset(),};}
function _mouseUp($this,div,transfo,event){transfo.active=null;}
function _mouseMove($this,div,transfo,event){event.preventDefault();if(!transfo.active)return;var settings=transfo.settings;var center=transfo.active.center;var cdx=center.left-event.pageX;var cdy=center.top-event.pageY;if(transfo.active.type=="rotator"){var ang,dang=Math.atan((settings.width*settings.scalex)/(settings.height*settings.scaley))/rad;if(cdy)ang=Math.atan(-cdx/cdy)/rad;else ang=0;if(event.pageY>=center.top&&event.pageX>=center.left)ang+=180;else if(event.pageY>=center.top&&event.pageX<center.left)ang+=180;else if(event.pageY<center.top&&event.pageX<center.left)ang+=360;ang-=dang;if(settings.scaley<0&&settings.scalex<0)ang+=180;if(!event.ctrlKey){settings.angle=Math.round(ang/transfo.settings.rotationStep)*transfo.settings.rotationStep;}else{settings.angle=ang;}
_targetCss($this,transfo);var new_center=transfo.$center.offset();var x=center.left-new_center.left;var y=center.top-new_center.top;var angle=ang*rad;settings.translatex+=x*Math.cos(angle)-y*Math.sin(-angle);settings.translatey+=-x*Math.sin(angle)+y*Math.cos(-angle);}
else if(transfo.active.type=="position"){var angle=settings.angle*rad;var x=event.pageX-transfo.active.pageX;var y=event.pageY-transfo.active.pageY;transfo.active.pageX=event.pageX;transfo.active.pageY=event.pageY;var dx=x*Math.cos(angle)-y*Math.sin(-angle);var dy=-x*Math.sin(angle)+y*Math.cos(-angle);settings.translatex+=dx;settings.translatey+=dy;}
else if(transfo.active.type.length===2){var angle=settings.angle*rad;var dx=cdx*Math.cos(angle)-cdy*Math.sin(-angle);var dy=-cdx*Math.sin(angle)+cdy*Math.cos(-angle);if(transfo.active.type.indexOf("t")!=-1){settings.scaley=dy/(settings.height/2);}
if(transfo.active.type.indexOf("b")!=-1){settings.scaley=-dy/(settings.height/2);}
if(transfo.active.type.indexOf("l")!=-1){settings.scalex=dx/(settings.width/2);}
if(transfo.active.type.indexOf("r")!=-1){settings.scalex=-dx/(settings.width/2);}
if(settings.scaley>0&&settings.scaley<0.05)settings.scaley=0.05;if(settings.scalex>0&&settings.scalex<0.05)settings.scalex=0.05;if(settings.scaley<0&&settings.scaley>-0.05)settings.scaley=-0.05;if(settings.scalex<0&&settings.scalex>-0.05)settings.scalex=-0.05;if(event.shiftKey&&(transfo.active.type==="tl"||transfo.active.type==="bl"||transfo.active.type==="tr"||transfo.active.type==="br")){settings.scaley=settings.scalex;}}
settings.angle=Math.round(settings.angle);settings.translatex=Math.round(settings.translatex);settings.translatey=Math.round(settings.translatey);settings.scalex=Math.round(settings.scalex*100)/100;settings.scaley=Math.round(settings.scaley*100)/100;_targetCss($this,transfo);_stop_animation($this[0]);return false;}
function _setCss($this,css,settings){var transform="";var trans=false;if(settings.angle!==0){trans=true;transform+=" rotate("+settings.angle+"deg) ";}
if(settings.translatex){trans=true;transform+=" translateX("+(settings.translate==="%"?settings.translatexp+"%":settings.translatex+"px")+") ";}
if(settings.translatey){trans=true;transform+=" translateY("+(settings.translate==="%"?settings.translateyp+"%":settings.translatey+"px")+") ";}
if(settings.scalex!=1){trans=true;transform+=" scaleX("+settings.scalex+") ";}
if(settings.scaley!=1){trans=true;transform+=" scaleY("+settings.scaley+") ";}
if(trans){css+=";"
css+="-webkit-transform:"+transform+";"
+"-moz-transform:"+transform+";"
+"-ms-transform:"+transform+";"
+"-o-transform:"+transform+";"
+"transform:"+transform+";";}
css=css.replace(/(\s*;)+/g,';').replace(/^\s*;|;\s*$/g,'');$this.attr("style",css);}
function _targetCss($this,transfo){var settings=transfo.settings;var width=parseFloat(settings.css.width);var height=parseFloat(settings.css.height);settings.translatexp=Math.round(settings.translatex/width*1000)/10;settings.translateyp=Math.round(settings.translatey/height*1000)/10;_setCss($this,settings.style,settings);transfo.$markup.css({"position":"absolute","width":width+"px","height":height+"px","top":settings.pos.top+"px","left":settings.pos.left+"px"});var $controls=transfo.$markup.find('.transfo-controls');_setCss($controls,"width:"+width+"px;"+"height:"+height+"px;"+"cursor: move;",settings);$controls.children().css("transform","scaleX("+(1/settings.scalex)+") scaleY("+(1/settings.scaley)+")");_showHide($this,transfo);transfo.settings.callback.call($this[0],$this);}
function _showHide($this,transfo){transfo.$markup.css("z-index",transfo.settings.hide?-1:1000);if(transfo.settings.hide){transfo.$markup.find(".transfo-controls > *").hide();transfo.$markup.find(".transfo-scaler-mc").show();}else{transfo.$markup.find(".transfo-controls > *").show();}}
function _destroy($this){$this.data('transfo').$markup.remove();$this.removeData('transfo');}
function _reset($this){var transfo=$this.data('transfo');_destroy($this);$this.transfo(transfo.settings);}})(jQuery);;

/* /web/static/lib/nearest/jquery.nearest.js defined in bundle 'web.qunit_suite_tests' */
;(function($,undefined){var rPerc=/^([\d.]+)%$/;function nearest(selector,options,thisObj){selector||(selector='div');var $container=$(options.container),containerOffset=$container.offset()||{left:0,top:0},containerDims=[containerOffset.left+$container.width(),containerOffset.top+$container.height()],percProps={x:0,y:1,w:0,h:1},prop,match;for(prop in percProps)if(percProps.hasOwnProperty(prop)){match=rPerc.exec(options[prop]);if(match){options[prop]=containerDims[percProps[prop]]*match[1]/100;}}
var $all=$(selector),cache=[],furthest=!!options.furthest,checkX=!!options.checkHoriz,checkY=!!options.checkVert,compDist=furthest?0:Infinity,point1x=parseFloat(options.x)||0,point1y=parseFloat(options.y)||0,point2x=parseFloat(point1x+options.w)||point1x,point2y=parseFloat(point1y+options.h)||point1y,tolerance=options.tolerance||0,hasEach2=!!$.fn.each2,min=Math.min,max=Math.max;if(!options.includeSelf&&thisObj){$all=$all.not(thisObj);}
if(tolerance<0){tolerance=0;}
$all[hasEach2?'each2':'each'](function(i,elem){var $this=hasEach2?elem:$(this),off=$this.offset(),x=off.left,y=off.top,w=$this.outerWidth(),h=$this.outerHeight(),x2=x+w,y2=y+h,maxX1=max(x,point1x),minX2=min(x2,point2x),maxY1=max(y,point1y),minY2=min(y2,point2y),intersectX=minX2>=maxX1,intersectY=minY2>=maxY1,distX,distY,distT,isValid;if((checkX&&checkY)||(!checkX&&!checkY&&intersectX&&intersectY)||(checkX&&intersectY)||(checkY&&intersectX)){distX=intersectX?0:maxX1-minX2;distY=intersectY?0:maxY1-minY2;distT=intersectX||intersectY?max(distX,distY):Math.sqrt(distX*distX+distY*distY);isValid=furthest?distT>=compDist-tolerance:distT<=compDist+tolerance;if(isValid){compDist=furthest?max(compDist,distT):min(compDist,distT);cache.push({node:this,dist:distT});}}});var len=cache.length,filtered=[],compMin,compMax,i,item;if(len){if(furthest){compMin=compDist-tolerance;compMax=compDist;}else{compMin=compDist;compMax=compDist+tolerance;}
for(i=0;i<len;i++){item=cache[i];if(item.dist>=compMin&&item.dist<=compMax){filtered.push(item.node);}}}
return filtered;}
$.each(['nearest','furthest','touching'],function(i,name){var defaults={x:0,y:0,w:0,h:0,tolerance:1,container:document,furthest:name=='furthest',includeSelf:false,checkHoriz:name!='touching',checkVert:name!='touching'};$[name]=function(point,selector,options){if(!point||point.x===undefined||point.y===undefined){return $([]);}
var opts=$.extend({},defaults,point,options||{});return $(nearest(selector,opts));};$.fn[name]=function(selector,options){var opts;if(selector&&$.isPlainObject(selector)){opts=$.extend({},defaults,selector,options||{});return this.pushStack(nearest(this,opts));}
var offset=this.offset(),dimensions={x:offset.left,y:offset.top,w:this.outerWidth(),h:this.outerHeight()};opts=$.extend({},defaults,dimensions,options||{});return this.pushStack(nearest(selector,opts,this));};});})(jQuery);;

/* /web_editor/static/lib/webgl-image-filter/webgl-image-filter.js defined in bundle 'web.qunit_suite_tests' */
(function(window){var WebGLProgram=function(gl,vertexSource,fragmentSource){var _collect=function(source,prefix,collection){var r=new RegExp('\\b'+prefix+' \\w+ (\\w+)','ig');source.replace(r,function(match,name){collection[name]=0;return match;});};var _compile=function(gl,source,type){var shader=gl.createShader(type);gl.shaderSource(shader,source);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){console.log(gl.getShaderInfoLog(shader));return null;}
return shader;};this.uniform={};this.attribute={};var _vsh=_compile(gl,vertexSource,gl.VERTEX_SHADER);var _fsh=_compile(gl,fragmentSource,gl.FRAGMENT_SHADER);this.id=gl.createProgram();gl.attachShader(this.id,_vsh);gl.attachShader(this.id,_fsh);gl.linkProgram(this.id);if(!gl.getProgramParameter(this.id,gl.LINK_STATUS)){console.log(gl.getProgramInfoLog(this.id));}
gl.useProgram(this.id);_collect(vertexSource,'attribute',this.attribute);for(var a in this.attribute){this.attribute[a]=gl.getAttribLocation(this.id,a);}
_collect(vertexSource,'uniform',this.uniform);_collect(fragmentSource,'uniform',this.uniform);for(var u in this.uniform){this.uniform[u]=gl.getUniformLocation(this.id,u);}};const identityMatrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,];const weightedAvg=(a,b,w)=>a*w+b*(1-w);var WebGLImageFilter=window.WebGLImageFilter=function(params){if(!params)
params={};var
gl=null,_drawCount=0,_sourceTexture=null,_lastInChain=false,_currentFramebufferIndex=-1,_tempFramebuffers=[null,null],_filterChain=[],_width=-1,_height=-1,_vertexBuffer=null,_currentProgram=null,_canvas=params.canvas||document.createElement('canvas');var _shaderProgramCache={};var gl=_canvas.getContext("webgl")||_canvas.getContext("experimental-webgl");if(!gl){throw"Couldn't get WebGL context";}
this.addFilter=function(name){var args=Array.prototype.slice.call(arguments,1);var filter=_filter[name];_filterChain.push({func:filter,args:args});};this.reset=function(){_filterChain=[];};this.apply=function(image){_resize(image.width,image.height);_drawCount=0;if(!_sourceTexture)
_sourceTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,_sourceTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);if(_filterChain.length==0){var program=_compileShader(SHADER.FRAGMENT_IDENTITY);_draw();return _canvas;}
for(var i=0;i<_filterChain.length;i++){_lastInChain=(i==_filterChain.length-1);var f=_filterChain[i];f.func.apply(this,f.args||[]);}
return _canvas;};var _resize=function(width,height){if(width==_width&&height==_height){return;}
_canvas.width=_width=width;_canvas.height=_height=height;if(!_vertexBuffer){var vertices=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]);_vertexBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,_vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STATIC_DRAW);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);}
gl.viewport(0,0,_width,_height);_tempFramebuffers=[null,null];};var _getTempFramebuffer=function(index){_tempFramebuffers[index]=_tempFramebuffers[index]||_createFramebufferTexture(_width,_height);return _tempFramebuffers[index];};var _createFramebufferTexture=function(width,height){var fbo=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,fbo);var renderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,renderbuffer);var texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return{fbo:fbo,texture:texture};};var _draw=function(flags){var source=null,target=null,flipY=false;if(_drawCount==0){source=_sourceTexture;}
else{source=_getTempFramebuffer(_currentFramebufferIndex).texture;}
_drawCount++;if(_lastInChain&&!(flags&DRAW.INTERMEDIATE)){target=null;flipY=_drawCount%2==0;}
else{_currentFramebufferIndex=(_currentFramebufferIndex+1)%2;target=_getTempFramebuffer(_currentFramebufferIndex).fbo;}
gl.bindTexture(gl.TEXTURE_2D,source);gl.bindFramebuffer(gl.FRAMEBUFFER,target);gl.uniform1f(_currentProgram.uniform.flipY,(flipY?-1:1));gl.drawArrays(gl.TRIANGLES,0,6);};var _compileShader=function(fragmentSource){if(_shaderProgramCache[fragmentSource]){_currentProgram=_shaderProgramCache[fragmentSource];gl.useProgram(_currentProgram.id);return _currentProgram;}
_currentProgram=new WebGLProgram(gl,SHADER.VERTEX_IDENTITY,fragmentSource);var floatSize=Float32Array.BYTES_PER_ELEMENT;var vertSize=4*floatSize;gl.enableVertexAttribArray(_currentProgram.attribute.pos);gl.vertexAttribPointer(_currentProgram.attribute.pos,2,gl.FLOAT,false,vertSize,0*floatSize);gl.enableVertexAttribArray(_currentProgram.attribute.uv);gl.vertexAttribPointer(_currentProgram.attribute.uv,2,gl.FLOAT,false,vertSize,2*floatSize);_shaderProgramCache[fragmentSource]=_currentProgram;return _currentProgram;};var DRAW={INTERMEDIATE:1};var SHADER={};SHADER.VERTEX_IDENTITY=['precision highp float;','attribute vec2 pos;','attribute vec2 uv;','varying vec2 vUv;','uniform float flipY;','void main(void) {','vUv = uv;','gl_Position = vec4(pos.x, pos.y*flipY, 0.0, 1.);','}'].join('\n');SHADER.FRAGMENT_IDENTITY=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','void main(void) {','gl_FragColor = texture2D(texture, vUv);','}',].join('\n');var _filter={};_filter.colorMatrix=function(matrix,amount=1){matrix=matrix.map((coef,index)=>weightedAvg(coef,identityMatrix[index],amount));var m=new Float32Array(matrix);m[4]/=255;m[9]/=255;m[14]/=255;m[19]/=255;var shader=(1==m[18]&&0==m[3]&&0==m[8]&&0==m[13]&&0==m[15]&&0==m[16]&&0==m[17]&&0==m[19])?_filter.colorMatrix.SHADER.WITHOUT_ALPHA:_filter.colorMatrix.SHADER.WITH_ALPHA;var program=_compileShader(shader);gl.uniform1fv(program.uniform.m,m);_draw();};_filter.colorMatrix.SHADER={};_filter.colorMatrix.SHADER.WITH_ALPHA=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform float m[20];','void main(void) {','vec4 c = texture2D(texture, vUv);','gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[3] * c.a + m[4];','gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[8] * c.a + m[9];','gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[13] * c.a + m[14];','gl_FragColor.a = m[15] * c.r + m[16] * c.g + m[17] * c.b + m[18] * c.a + m[19];','}',].join('\n');_filter.colorMatrix.SHADER.WITHOUT_ALPHA=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform float m[20];','void main(void) {','vec4 c = texture2D(texture, vUv);','gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[4];','gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[9];','gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[14];','gl_FragColor.a = c.a;','}',].join('\n');_filter.brightness=function(brightness){var b=(brightness||0)+1;_filter.colorMatrix([b,0,0,0,0,0,b,0,0,0,0,0,b,0,0,0,0,0,1,0]);};_filter.saturation=function(amount){var x=(amount||0)*2/3+1;var y=((x-1)*-0.5);_filter.colorMatrix([x,y,y,0,0,y,x,y,0,0,y,y,x,0,0,0,0,0,1,0]);};_filter.desaturate=function(){_filter.saturation(-1);};_filter.contrast=function(amount){var v=(amount||0)+1;var o=-128*(v-1);_filter.colorMatrix([v,0,0,0,o,0,v,0,0,o,0,0,v,0,o,0,0,0,1,0]);};_filter.negative=function(){_filter.contrast(-2);};_filter.hue=function(rotation){rotation=(rotation||0)/180*Math.PI;var cos=Math.cos(rotation),sin=Math.sin(rotation),lumR=0.213,lumG=0.715,lumB=0.072;_filter.colorMatrix([lumR+cos*(1-lumR)+sin*(-lumR),lumG+cos*(-lumG)+sin*(-lumG),lumB+cos*(-lumB)+sin*(1-lumB),0,0,lumR+cos*(-lumR)+sin*(0.143),lumG+cos*(1-lumG)+sin*(0.140),lumB+cos*(-lumB)+sin*(-0.283),0,0,lumR+cos*(-lumR)+sin*(-(1-lumR)),lumG+cos*(-lumG)+sin*(lumG),lumB+cos*(1-lumB)+sin*(lumB),0,0,0,0,0,1,0]);};_filter.desaturateLuminance=function(amount){_filter.colorMatrix([0.2764723,0.9297080,0.0938197,0,-37.1,0.2764723,0.9297080,0.0938197,0,-37.1,0.2764723,0.9297080,0.0938197,0,-37.1,0,0,0,1,0],amount);};_filter.sepia=function(amount){_filter.colorMatrix([0.393,0.7689999,0.18899999,0,0,0.349,0.6859999,0.16799999,0,0,0.272,0.5339999,0.13099999,0,0,0,0,0,1,0],amount);};_filter.brownie=function(amount){_filter.colorMatrix([0.5997023498159715,0.34553243048391263,-0.2708298674538042,0,47.43192855600873,-0.037703249837783157,0.8609577587992641,0.15059552388459913,0,-36.96841498319127,0.24113635128153335,-0.07441037908422492,0.44972182064877153,0,-7.562075277591283,0,0,0,1,0],amount);};_filter.vintagePinhole=function(amount){_filter.colorMatrix([0.6279345635605994,0.3202183420819367,-0.03965408211312453,0,9.651285835294123,0.02578397704808868,0.6441188644374771,0.03259127616149294,0,7.462829176470591,0.0466055556782719,-0.0851232987247891,0.5241648018700465,0,5.159190588235296,0,0,0,1,0],amount);};_filter.kodachrome=function(amount){_filter.colorMatrix([1.1285582396593525,-0.3967382283601348,-0.03992559172921793,0,63.72958762196502,-0.16404339962244616,1.0835251566291304,-0.05498805115633132,0,24.732407896706203,-0.16786010706155763,-0.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0],amount);};_filter.technicolor=function(amount){_filter.colorMatrix([1.9125277891456083,-0.8545344976951645,-0.09155508482755585,0,11.793603434377337,-0.3087833385928097,1.7658908555458428,-0.10601743074722245,0,-70.35205161461398,-0.231103377548616,-0.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0],amount);};_filter.polaroid=function(amount){_filter.colorMatrix([1.438,-0.062,-0.062,0,0,-0.122,1.378,-0.122,0,0,-0.016,-0.016,1.483,0,0,0,0,0,1,0],amount);};_filter.shiftToBGR=function(amount){_filter.colorMatrix([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0],amount);};_filter.convolution=function(matrix){var m=new Float32Array(matrix);var pixelSizeX=1/_width;var pixelSizeY=1/_height;var program=_compileShader(_filter.convolution.SHADER);gl.uniform1fv(program.uniform.m,m);gl.uniform2f(program.uniform.px,pixelSizeX,pixelSizeY);_draw();};_filter.convolution.SHADER=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform vec2 px;','uniform float m[9];','void main(void) {','vec4 c11 = texture2D(texture, vUv - px);','vec4 c12 = texture2D(texture, vec2(vUv.x, vUv.y - px.y));','vec4 c13 = texture2D(texture, vec2(vUv.x + px.x, vUv.y - px.y));','vec4 c21 = texture2D(texture, vec2(vUv.x - px.x, vUv.y) );','vec4 c22 = texture2D(texture, vUv);','vec4 c23 = texture2D(texture, vec2(vUv.x + px.x, vUv.y) );','vec4 c31 = texture2D(texture, vec2(vUv.x - px.x, vUv.y + px.y) );','vec4 c32 = texture2D(texture, vec2(vUv.x, vUv.y + px.y) );','vec4 c33 = texture2D(texture, vUv + px );','gl_FragColor = ','c11 * m[0] + c12 * m[1] + c22 * m[2] +','c21 * m[3] + c22 * m[4] + c23 * m[5] +','c31 * m[6] + c32 * m[7] + c33 * m[8];','gl_FragColor.a = c22.a;','}',].join('\n');_filter.detectEdges=function(){_filter.convolution.call(this,[0,1,0,1,-4,1,0,1,0]);};_filter.sobelX=function(){_filter.convolution.call(this,[-1,0,1,-2,0,2,-1,0,1]);};_filter.sobelY=function(){_filter.convolution.call(this,[-1,-2,-1,0,0,0,1,2,1]);};_filter.sharpen=function(amount){var a=amount||1;_filter.convolution.call(this,[0,-1*a,0,-1*a,1+4*a,-1*a,0,-1*a,0]);};_filter.emboss=function(size){var s=size||1;_filter.convolution.call(this,[-2*s,-1*s,0,-1*s,1,1*s,0,1*s,2*s]);};_filter.blur=function(size){var blurSizeX=(size/7)/_width;var blurSizeY=(size/7)/_height;var program=_compileShader(_filter.blur.SHADER);gl.uniform2f(program.uniform.px,0,blurSizeY);_draw(DRAW.INTERMEDIATE);gl.uniform2f(program.uniform.px,blurSizeX,0);_draw();};_filter.blur.SHADER=['precision highp float;','varying vec2 vUv;','uniform sampler2D texture;','uniform vec2 px;','void main(void) {','gl_FragColor = vec4(0.0);','gl_FragColor += texture2D(texture, vUv + vec2(-7.0*px.x, -7.0*px.y))*0.0044299121055113265;','gl_FragColor += texture2D(texture, vUv + vec2(-6.0*px.x, -6.0*px.y))*0.00895781211794;','gl_FragColor += texture2D(texture, vUv + vec2(-5.0*px.x, -5.0*px.y))*0.0215963866053;','gl_FragColor += texture2D(texture, vUv + vec2(-4.0*px.x, -4.0*px.y))*0.0443683338718;','gl_FragColor += texture2D(texture, vUv + vec2(-3.0*px.x, -3.0*px.y))*0.0776744219933;','gl_FragColor += texture2D(texture, vUv + vec2(-2.0*px.x, -2.0*px.y))*0.115876621105;','gl_FragColor += texture2D(texture, vUv + vec2(-1.0*px.x, -1.0*px.y))*0.147308056121;','gl_FragColor += texture2D(texture, vUv                             )*0.159576912161;','gl_FragColor += texture2D(texture, vUv + vec2( 1.0*px.x,  1.0*px.y))*0.147308056121;','gl_FragColor += texture2D(texture, vUv + vec2( 2.0*px.x,  2.0*px.y))*0.115876621105;','gl_FragColor += texture2D(texture, vUv + vec2( 3.0*px.x,  3.0*px.y))*0.0776744219933;','gl_FragColor += texture2D(texture, vUv + vec2( 4.0*px.x,  4.0*px.y))*0.0443683338718;','gl_FragColor += texture2D(texture, vUv + vec2( 5.0*px.x,  5.0*px.y))*0.0215963866053;','gl_FragColor += texture2D(texture, vUv + vec2( 6.0*px.x,  6.0*px.y))*0.00895781211794;','gl_FragColor += texture2D(texture, vUv + vec2( 7.0*px.x,  7.0*px.y))*0.0044299121055113265;','}',].join('\n');_filter.pixelate=function(size){var blurSizeX=(size)/_width;var blurSizeY=(size)/_height;var program=_compileShader(_filter.pixelate.SHADER);gl.uniform2f(program.uniform.size,blurSizeX,blurSizeY);_draw();};_filter.pixelate.SHADER=['precision highp float;','varying vec2 vUv;','uniform vec2 size;','uniform sampler2D texture;','vec2 pixelate(vec2 coord, vec2 size) {','return floor( coord / size ) * size;','}','void main(void) {','gl_FragColor = vec4(0.0);','vec2 coord = pixelate(vUv, size);','gl_FragColor += texture2D(texture, coord);','}',].join('\n');};})(window);;

/* /web_editor/static/src/js/wysiwyg/fonts.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.fonts',function(require){'use strict';return{cacheCssSelectors:{},getCssSelectors:function(filter){if(this.cacheCssSelectors[filter]){return this.cacheCssSelectors[filter];}
this.cacheCssSelectors[filter]=[];var sheets=document.styleSheets;for(var i=0;i<sheets.length;i++){var rules;try{rules=sheets[i].rules||sheets[i].cssRules;}catch(e){console.warn("Can't read the css rules of: "+sheets[i].href,e);continue;}
if(!rules){continue;}
for(var r=0;r<rules.length;r++){var selectorText=rules[r].selectorText;if(!selectorText){continue;}
var selectors=selectorText.split(/\s*,\s*/);var data=null;for(var s=0;s<selectors.length;s++){var match=selectors[s].trim().match(filter);if(!match){continue;}
if(!data){data={selector:match[0],css:rules[r].cssText.replace(/(^.*\{\s*)|(\s*\}\s*$)/g,''),names:[match[1]]};}else{data.selector+=(', '+match[0]);data.names.push(match[1]);}}
if(data){this.cacheCssSelectors[filter].push(data);}}}
return this.cacheCssSelectors[filter];},fontIcons:[{base:'fa',parser:/\.(fa-(?:\w|-)+)::?before/i}],computeFonts:_.once(function(){var self=this;_.each(this.fontIcons,function(data){data.cssData=self.getCssSelectors(data.parser);data.alias=_.flatten(_.map(data.cssData,_.property('names')));});}),};});;

/* /web_editor/static/src/js/base.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.base',function(require){'use strict';var ajax=require('web.ajax');var session=require('web.session');var domReady=new Promise(function(resolve){$(resolve);});return{cacheCssSelectors:{},getCssSelectors:function(filter){if(this.cacheCssSelectors[filter]){return this.cacheCssSelectors[filter];}
this.cacheCssSelectors[filter]=[];var sheets=document.styleSheets;for(var i=0;i<sheets.length;i++){var rules;try{rules=sheets[i].rules||sheets[i].cssRules;}catch(e){console.warn("Can't read the css rules of: "+sheets[i].href,e);continue;}
if(!rules){continue;}
for(var r=0;r<rules.length;r++){var selectorText=rules[r].selectorText;if(!selectorText){continue;}
var selectors=selectorText.split(/\s*,\s*/);var data=null;for(var s=0;s<selectors.length;s++){var match=selectors[s].trim().match(filter);if(!match){continue;}
if(!data){data={selector:match[0],css:rules[r].cssText.replace(/(^.*\{\s*)|(\s*\}\s*$)/g,''),names:[match[1]]};}else{data.selector+=(', '+match[0]);data.names.push(match[1]);}}
if(data){this.cacheCssSelectors[filter].push(data);}}}
return this.cacheCssSelectors[filter];},fontIcons:[{base:'fa',parser:/\.(fa-(?:\w|-)+)::?before/i}],computeFonts:_.once(function(){var self=this;_.each(this.fontIcons,function(data){data.cssData=self.getCssSelectors(data.parser);data.alias=_.flatten(_.map(data.cssData,_.property('names')));});}),ready:function(){return Promise.all([domReady,session.is_bound,ajax.loadXML()]);},};});odoo.define('web_editor.context',function(require){'use strict';function getContext(context){var html=document.documentElement;return _.extend({lang:(html.getAttribute('lang')||'en_US').replace('-','_'),'website_id':html.getAttribute('data-website-id')|0,},context||{});}
function getExtraContext(context){var html=document.documentElement;return _.extend(getContext(),{editable:!!(html.dataset.editable||$('[data-oe-model]').length),translatable:!!html.dataset.translatable,edit_translations:!!html.dataset.edit_translations,},context||{});}
return{get:getContext,getExtra:getExtraContext,};});odoo.define('web_editor.ready',function(require){'use strict';var base=require('web_editor.base');return base.ready();});;

/* /web_editor/static/src/js/editor/editor.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.editor',function(require){'use strict';var Dialog=require('web.Dialog');var Widget=require('web.Widget');var core=require('web.core');var rte=require('web_editor.rte');var snippetsEditor=require('web_editor.snippet.editor');var summernoteCustomColors=require('web_editor.rte.summernote_custom_colors');var _t=core._t;var EditorMenuBar=Widget.extend({template:'web_editor.editorbar',xmlDependencies:['/web_editor/static/src/xml/editor.xml'],events:{'click button[data-action=save]':'_onSaveClick','click button[data-action=cancel]':'_onCancelClick',},custom_events:{request_editable:'_onRequestEditable',request_history_undo_record:'_onHistoryUndoRecordRequest',request_save:'_onSaveRequest',},init:function(parent,options){var self=this;var res=this._super.apply(this,arguments);var Editor=options.Editor||rte.Class;this.rte=new Editor(this,{getConfig:function($editable){var param=self._getDefaultConfig($editable);if(options.generateOptions){param=options.generateOptions(param);}
return param;},saveElement:options.saveElement,});this.rte.on('rte:start',this,function(){self.trigger('rte:start');});var $editable=this.rte.editable();window.__EditorMenuBar_$editable=$editable;if(options.snippets){this.snippetsMenu=new snippetsEditor.Class(this,Object.assign({$el:$editable,selectorEditableArea:'.o_editable',},options));}
return res;},start:function(){var self=this;var defs=[this._super.apply(this,arguments)];core.bus.on('editor_save_request',this,this.save);core.bus.on('editor_discard_request',this,this.cancel);$('.dropdown-toggle').dropdown();$(document).on('keyup',function(event){if((event.keyCode===8||event.keyCode===46)){var $target=$(event.target).closest('.o_editable');if(!$target.is(':has(*:not(p):not(br))')&&!$target.text().match(/\S/)){$target.empty();}}});$(document).on('click','.note-editable',function(ev){ev.preventDefault();});$(document).on('submit','.note-editable form .btn',function(ev){ev.preventDefault();});$(document).on('hide.bs.dropdown','.dropdown',function(ev){if(ev.originalEvent&&$(ev.target).has(ev.originalEvent.target).length&&$(ev.originalEvent.target).is('[contenteditable]')){ev.preventDefault();}});this.rte.start();var flag=false;window.onbeforeunload=function(event){if(rte.history.getEditableHasUndo().length&&!flag){flag=true;_.defer(function(){flag=false;});return _t('This document is not saved!');}};if(self.snippetsMenu){defs.push(this.snippetsMenu.insertAfter(this.$el));}
this.rte.editable().find('*').off('mousedown mouseup click');return Promise.all(defs).then(function(){self.trigger_up('edit_mode');});},destroy:function(){this._super.apply(this,arguments);core.bus.off('editor_save_request',this,this._onSaveRequest);core.bus.off('editor_discard_request',this,this._onDiscardRequest);},cancel:function(reload){var self=this;return new Promise(function(resolve,reject){if(!rte.history.getEditableHasUndo().length){resolve();}else{var confirm=Dialog.confirm(this,_t("If you discard the current edits, all unsaved changes will be lost. You can cancel to return to edit mode."),{confirm_callback:resolve,});confirm.on('closed',self,reject);}}).then(function(){if(reload!==false){window.onbeforeunload=null;return self._reload();}});},save:async function(reload){var defs=[];this.trigger_up('ready_to_save',{defs:defs});await Promise.all(defs);if(this.snippetsMenu){await this.snippetsMenu.cleanForSave();}
await this.getParent().saveModifiedImages(this.rte.editable());await this.rte.save();if(reload!==false){return this._reload();}},_getDefaultConfig:function($editable){return{'airMode':true,'focus':false,'airPopover':[['style',['style']],['font',['bold','italic','underline','clear']],['fontsize',['fontsize']],['color',['color']],['para',['ul','ol','paragraph']],['table',['table']],['insert',['link','picture']],['history',['undo','redo']],],'styleWithSpan':false,'inlinemedia':['p'],'lang':'odoo','onChange':function(html,$editable){$editable.trigger('content_changed');},'colors':summernoteCustomColors,};},_reload:function(){window.location.hash='scrollTop='+window.document.body.scrollTop;if(window.location.search.indexOf('enable_editor')>=0){window.location.href=window.location.href.replace(/&?enable_editor(=[^&]*)?/g,'');}else{window.location.reload(true);}
return new Promise(function(){});},_onCancelClick:function(){this.cancel();},_onHistoryUndoRecordRequest:function(ev){this.rte.historyRecordUndo(ev.data.$target,ev.data.event);},_onSaveClick:function(){this.save();},_onDiscardRequest:function(ev){this.cancel(ev.data.reload).then(ev.data.onSuccess,ev.data.onFailure);},_onSaveRequest:function(ev){ev.stopPropagation();this.save(ev.data.reload).then(ev.data.onSuccess,ev.data.onFailure);},_onRequestEditable:function(ev){ev.data.callback(this.rte.editable());},});return{Class:EditorMenuBar,};});;

/* /web_editor/static/src/js/editor/rte.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.rte',function(require){'use strict';var fonts=require('wysiwyg.fonts');var concurrency=require('web.concurrency');var core=require('web.core');var Widget=require('web.Widget');var weContext=require('web_editor.context');var summernote=require('web_editor.summernote');var summernoteCustomColors=require('web_editor.rte.summernote_custom_colors');var _t=core._t;var dom=summernote.core.dom;var range=summernote.core.range;var History=function History($editable){var aUndo=[];var pos=0;var toSnap;this.makeSnap=function(event,rng){rng=rng||range.create();var elEditable=$(rng&&rng.sc).closest('.o_editable')[0];if(!elEditable){return false;}
return{event:event,editable:elEditable,contents:elEditable.innerHTML,bookmark:rng&&rng.bookmark(elEditable),scrollTop:$(elEditable).scrollTop()};};this.applySnap=function(oSnap){var $editable=$(oSnap.editable);if(document.documentMode){$editable.removeAttr('contentEditable').removeProp('contentEditable');}
$editable.trigger('content_will_be_destroyed');var $tempDiv=$('<div/>',{html:oSnap.contents});_.each($tempDiv.find('.o_temp_auto_element'),function(el){var $el=$(el);var originalContent=$el.attr('data-temp-auto-element-original-content');if(originalContent){$el.after(originalContent);}
$el.remove();});$editable.html($tempDiv.html()).scrollTop(oSnap.scrollTop);$editable.trigger('content_was_recreated');$('.oe_overlay').remove();$('.note-control-selection').hide();$editable.trigger('content_changed');try{var r=oSnap.editable.innerHTML===''?range.create(oSnap.editable,0):range.createFromBookmark(oSnap.editable,oSnap.bookmark);r.select();}catch(e){console.error(e);return;}
$(document).trigger('click');$('.o_editable *').filter(function(){var $el=$(this);if($el.data('snippet-editor')){$el.removeData();}});_.defer(function(){var target=dom.isBR(r.sc)?r.sc.parentNode:dom.node(r.sc);if(!target){return;}
$editable.trigger('applySnap');var evt=document.createEvent('MouseEvents');evt.initMouseEvent('click',true,true,window,0,0,0,0,0,false,false,false,false,0,target);target.dispatchEvent(evt);$editable.trigger('keyup');});};this.undo=function(){if(!pos){return;}
var _toSnap=toSnap;if(_toSnap){this.saveSnap();}
if(!aUndo[pos]&&(!aUndo[pos]||aUndo[pos].event!=='undo')){var temp=this.makeSnap('undo');if(temp&&(!pos||temp.contents!==aUndo[pos-1].contents)){aUndo[pos]=temp;}else{pos--;}}else if(_toSnap){pos--;}
this.applySnap(aUndo[Math.max(--pos,0)]);while(pos&&(aUndo[pos].event==='blur'||(aUndo[pos+1].editable===aUndo[pos].editable&&aUndo[pos+1].contents===aUndo[pos].contents))){this.applySnap(aUndo[--pos]);}};this.hasUndo=function(){return(toSnap&&(toSnap.event!=='blur'&&toSnap.event!=='activate'&&toSnap.event!=='undo'))||!!_.find(aUndo.slice(0,pos+1),function(undo){return undo.event!=='blur'&&undo.event!=='activate'&&undo.event!=='undo';});};this.getEditableHasUndo=function(){var editable=[];if((toSnap&&(toSnap.event!=='blur'&&toSnap.event!=='activate'&&toSnap.event!=='undo'))){editable.push(toSnap.editable);}
_.each(aUndo.slice(0,pos+1),function(undo){if(undo.event!=='blur'&&undo.event!=='activate'&&undo.event!=='undo'){editable.push(undo.editable);}});return _.uniq(editable);};this.redo=function(){if(!aUndo[pos+1]){return;}
this.applySnap(aUndo[++pos]);while(aUndo[pos+1]&&aUndo[pos].event==='active'){this.applySnap(aUndo[pos++]);}};this.hasRedo=function(){return aUndo.length>pos+1;};this.recordUndo=function($editable,event,internal_history){var self=this;if(!$editable){var rng=range.create();if(!rng)return;$editable=$(rng.sc).closest('.o_editable');}
if(aUndo[pos]&&(event==='applySnap'||event==='activate')){return;}
if(!internal_history){if(!event||!toSnap||!aUndo[pos-1]||toSnap.event==='activate'){setTimeout(function(){$editable.trigger('content_changed');},0);}}
if(aUndo[pos]){pos=Math.min(pos,aUndo.length);aUndo.splice(pos,aUndo.length);}
if(toSnap&&(toSnap.split||!event||toSnap.event!==event||toSnap.editable!==$editable[0])){this.saveSnap();}
if(pos&&aUndo[pos-1].editable!==$editable[0]){var snap=this.makeSnap('blur',range.create(aUndo[pos-1].editable,0));pos++;aUndo.push(snap);}
if(range.create()){toSnap=self.makeSnap(event);}else{toSnap=false;}};this.splitNext=function(){if(toSnap){toSnap.split=true;}};this.saveSnap=function(){if(toSnap){if(!aUndo[pos]){pos++;}
aUndo.push(toSnap);delete toSnap.split;toSnap=null;}};};var history=new History();$.extend($.expr[':'],{o_editable:function(node,i,m){while(node){if(node.className&&_.isString(node.className)){if(node.className.indexOf('o_not_editable')!==-1){return false;}
if(node.className.indexOf('o_editable')!==-1){return true;}}
node=node.parentNode;}
return false;},});$.fn.extend({focusIn:function(){if(this.length){range.create(dom.firstChild(this[0]),0).select();}
return this;},focusInEnd:function(){if(this.length){var last=dom.lastChild(this[0]);range.create(last,dom.nodeLength(last)).select();}
return this;},selectContent:function(){if(this.length){var next=dom.lastChild(this[0]);range.create(dom.firstChild(this[0]),0,next,next.textContent.length).select();}
return this;},});var RTEWidget=Widget.extend({init:function(parent,params){var self=this;this._super.apply(this,arguments);this.init_bootstrap_carousel=$.fn.carousel;this.edit_bootstrap_carousel=function(){var res=self.init_bootstrap_carousel.apply(this,arguments);$(this).off('keydown.bs.carousel');return res;};this._getConfig=params&&params.getConfig||this._getDefaultConfig;this._saveElement=params&&params.saveElement||this._saveElement;fonts.computeFonts();},start:function(){var self=this;this.saving_mutex=new concurrency.Mutex();$.fn.carousel=this.edit_bootstrap_carousel;$(document).on('click.rte keyup.rte',function(){var current_range={};try{current_range=range.create()||{};}catch(e){}
var $popover=$(current_range.sc).closest('[contenteditable]');var popover_history=($popover.data()||{}).NoteHistory;if(!popover_history||popover_history===history)return;var editor=$popover.parent('.note-editor');$('button[data-event="undo"]',editor).attr('disabled',!popover_history.hasUndo());$('button[data-event="redo"]',editor).attr('disabled',!popover_history.hasRedo());});$(document).on('mousedown.rte activate.rte',this,this._onMousedown.bind(this));$(document).on('mouseup.rte',this,this._onMouseup.bind(this));$('.o_not_editable').attr('contentEditable',false);var $editable=this.editable();$editable.on('content_will_be_destroyed',function(ev){self.trigger_up('content_will_be_destroyed',{$target:$(ev.currentTarget),});});$editable.on('content_was_recreated',function(ev){self.trigger_up('content_was_recreated',{$target:$(ev.currentTarget),});});$editable.addClass('o_editable').data('rte',this).each(function(){var $node=$(this);var computedStyles=window.getComputedStyle(this)||window.parent.getComputedStyle(this);if(computedStyles.display==='inline'&&$node.data('oe-type')!=='image'){$node.addClass('o_is_inline_editable');}});$(document).on('content_changed',function(ev){self.trigger_up('rte_change',{target:ev.target});if(!ev.__isDirtyHandled){ev.__isDirtyHandled=true;var el=ev.target;var dirty=el.closest('.o_editable')||el;dirty.classList.add('o_dirty');}});$('#wrapwrap, .o_editable').on('click.rte','*',this,this._onClick.bind(this));$('body').addClass('editor_enable');$(document.body).tooltip({selector:'[data-oe-readonly]',container:'body',trigger:'hover',delay:{'show':1000,'hide':100},placement:'bottom',title:_t("Readonly field")}).on('click',function(){$(this).tooltip('hide');});$(document).trigger('mousedown');this.trigger('rte:start');return this._super.apply(this,arguments);},destroy:function(){this.cancel();this._super.apply(this,arguments);},cancel:function(){if(this.$last){this.$last.destroy();this.$last=null;}
$.fn.carousel=this.init_bootstrap_carousel;$(document).off('.rte');$('#wrapwrap, .o_editable').off('.rte');$('.o_not_editable').removeAttr('contentEditable');$(document).off('click.rte keyup.rte mousedown.rte activate.rte mouseup.rte');$(document).off('content_changed').removeClass('o_is_inline_editable').removeData('rte');$(document).tooltip('dispose');$('body').removeClass('editor_enable');this.trigger('rte:stop');},editable:function(){return $('#wrapwrap [data-oe-model]').not('.o_not_editable').filter(function(){return!$(this).closest('.o_not_editable').length;}).not('link, script').not('[data-oe-readonly]').not('img[data-oe-field="arch"], br[data-oe-field="arch"], input[data-oe-field="arch"]').not('.oe_snippet_editor').add('.o_editable');},historyRecordUndo:function($target,event,internal_history){const initialActiveElement=document.activeElement;const initialSelectionStart=initialActiveElement&&initialActiveElement.selectionStart;const initialSelectionEnd=initialActiveElement&&initialActiveElement.selectionEnd;$target=$($target);var rng=range.create();var $editable=$(rng&&rng.sc).closest('.o_editable');if(!rng||!$editable.length){$editable=$target.closest('.o_editable');rng=range.create($target.closest('*')[0],0);}else{rng=$editable.data('range')||rng;}
try{rng.select();}catch(e){console.log('error',e);}
history.recordUndo($editable,event,internal_history);if(initialActiveElement&&initialActiveElement!==document.activeElement){initialActiveElement.focus();if(initialActiveElement.matches('input[type=range]')){return;}
try{initialActiveElement.selectionStart=initialSelectionStart;initialActiveElement.selectionEnd=initialSelectionEnd;}catch(e){console.log('error',e);}}},save:function(context){var self=this;$('.o_editable').destroy().removeClass('o_editable o_is_inline_editable o_editable_date_field_linked o_editable_date_field_format_changed');var $dirty=$('.o_dirty');$dirty.removeAttr('contentEditable').removeClass('o_dirty oe_carlos_danger o_is_inline_editable');var defs=_.map($dirty,function(el){var $el=$(el);$el.find('[class]').filter(function(){if(!this.getAttribute('class').match(/\S/)){this.removeAttribute('class');}});return self.saving_mutex.exec(function(){return self._saveElement($el,context||weContext.get()).then(function(){$el.removeClass('o_dirty');}).guardedCatch(function(response){var id=_.uniqueId('carlos_danger_');$el.addClass('o_dirty oe_carlos_danger '+id);$('.o_editable.'+id).removeClass(id).popover({trigger:'hover',content:response.message.data.message||'',placement:'auto top',}).popover('show');});});});return Promise.all(defs).then(function(){window.onbeforeunload=null;}).guardedCatch(function(failed){self.cancel();self.start();});},_enableEditableArea:function($editable){if($editable.data('oe-type')==="datetime"||$editable.data('oe-type')==="date"){var selector='[data-oe-id="'+$editable.data('oe-id')+'"]';selector+='[data-oe-field="'+$editable.data('oe-field')+'"]';selector+='[data-oe-model="'+$editable.data('oe-model')+'"]';var $linkedFieldNodes=this.editable().find(selector).addBack(selector);$linkedFieldNodes.not($editable).addClass('o_editable_date_field_linked');if(!$editable.hasClass('o_editable_date_field_format_changed')){$linkedFieldNodes.html($editable.data('oe-original-with-format'));$linkedFieldNodes.addClass('o_editable_date_field_format_changed');}}
if($editable.data('oe-type')==="monetary"){$editable.attr('contenteditable',false);$editable.find('.oe_currency_value').attr('contenteditable',true);}
if($editable.is('[data-oe-model]')&&!$editable.is('[data-oe-model="ir.ui.view"]')&&!$editable.is('[data-oe-type="html"]')){$editable.data('layoutInfo').popover().find('.btn-group:not(.note-history)').remove();}},_getDefaultConfig:function($editable){return{'airMode':true,'focus':false,'airPopover':[['style',['style']],['font',['bold','italic','underline','clear']],['fontsize',['fontsize']],['color',['color']],['para',['ul','ol','paragraph']],['table',['table']],['insert',['link','picture']],['history',['undo','redo']],],'styleWithSpan':false,'inlinemedia':['p'],'lang':'odoo','onChange':function(html,$editable){$editable.trigger('content_changed');},'colors':summernoteCustomColors,};},_getEscapedElement:function($el){var escaped_el=$el.clone();var to_escape=escaped_el.find('*').addBack();to_escape=to_escape.not(to_escape.filter('object,iframe,script,style,[data-oe-model][data-oe-model!="ir.ui.view"]').find('*').addBack());to_escape.contents().each(function(){if(this.nodeType===3){this.nodeValue=$('<div />').text(this.nodeValue).html();}});return escaped_el;},_saveElement:function($el,context,withLang){var viewID=$el.data('oe-id');if(!viewID){return Promise.resolve();}
return this._rpc({model:'ir.ui.view',method:'save',args:[viewID,this._getEscapedElement($el).prop('outerHTML'),$el.data('oe-xpath')||null,],context:context,},withLang?undefined:{noContextKeys:'lang',});},_onClick:function(e){e.preventDefault();},_onMousedown:function(ev){var $target=$(ev.target);var $editable=$target.closest('.o_editable');var isLink=$target.is('a');if(this&&this.$last&&this.$last.length&&this.$last[0]!==$target[0]){$('.o_editable_date_field_linked').removeClass('o_editable_date_field_linked');}
if(!$editable.length||(!isLink&&$.summernote.core.dom.isContentEditableFalse($target))){return;}
_.defer(function(){$editable.find('[_moz_abspos]').removeAttr('_moz_abspos');});if(isLink){let hasContentEditable=$target.attr('contenteditable');$target.attr('contenteditable',true);_.defer(function(){$editable.not($target).attr('contenteditable',false);$target.focus();});$(document).on('mousedown.reactivate_contenteditable',function(e){if($target.is(e.target))return;if(!hasContentEditable){$target.removeAttr('contenteditable');}
$editable.attr('contenteditable',true);$(document).off('mousedown.reactivate_contenteditable');});}
if(this&&this.$last&&(!$editable.length||this.$last[0]!==$editable[0])){var $destroy=this.$last;history.splitNext();var lastTimerId=_.delay(function(){var id=$destroy.data('note-id');$destroy.destroy().removeData('note-id').removeAttr('data-note-id');$('#note-popover-'+id+', #note-handle-'+id+', #note-dialog-'+id+'').remove();},150);this.$last=null;if($destroy.hasClass('modal-body')){clearTimeout(lastTimerId);}}
if($editable.length&&(!this.$last||this.$last[0]!==$editable[0])){$editable.summernote(this._getConfig($editable));$editable.data('NoteHistory',history);this.$last=$editable;try{document.execCommand('enableObjectResizing',false,false);document.execCommand('enableInlineTableEditing',false,false);document.execCommand('2D-position',false,false);}catch(e){}
document.body.addEventListener('resizestart',function(evt){evt.preventDefault();return false;});document.body.addEventListener('movestart',function(evt){evt.preventDefault();return false;});document.body.addEventListener('dragstart',function(evt){evt.preventDefault();return false;});if(!range.create()){$editable.focusIn();}
if(dom.isImg($target[0])){$target.trigger('mousedown');}
this._enableEditableArea($editable);}},_onMouseup:function(ev){var $target=$(ev.target);var $editable=$target.closest('.o_editable');if(!$editable.length){return;}
var self=this;_.defer(function(){self.historyRecordUndo($target,'activate',true);});if(ev.originalEvent&&ev.originalEvent.detail===3){range.create(ev.target,0,ev.target,ev.target.childNodes.length).select();}},});return{Class:RTEWidget,history:history,};});odoo.define('web_editor.rte.summernote_custom_colors',function(require){'use strict';return[['#000000','#424242','#636363','#9C9C94','#CEC6CE','#EFEFEF','#F7F7F7','#FFFFFF'],['#FF0000','#FF9C00','#FFFF00','#00FF00','#00FFFF','#0000FF','#9C00FF','#FF00FF'],['#F7C6CE','#FFE7CE','#FFEFC6','#D6EFD6','#CEDEE7','#CEE7F7','#D6D6E7','#E7D6DE'],['#E79C9C','#FFC69C','#FFE79C','#B5D6A5','#A5C6CE','#9CC6EF','#B5A5D6','#D6A5BD'],['#E76363','#F7AD6B','#FFD663','#94BD7B','#73A5AD','#6BADDE','#8C7BC6','#C67BA5'],['#CE0000','#E79439','#EFC631','#6BA54A','#4A7B8C','#3984C6','#634AA5','#A54A7B'],['#9C0000','#B56308','#BD9400','#397B21','#104A5A','#085294','#311873','#731842'],['#630000','#7B3900','#846300','#295218','#083139','#003163','#21104A','#4A1031']];});;

/* /web_editor/static/src/js/editor/rte.summernote.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.rte.summernote',function(require){'use strict';var Class=require('web.Class');const concurrency=require('web.concurrency');var core=require('web.core');const topBus=window.top.odoo.__DEBUG__.services['web.core'].bus;const{ColorpickerWidget}=require('web.Colorpicker');var ColorPaletteWidget=require('web_editor.ColorPalette').ColorPaletteWidget;var mixins=require('web.mixins');var fonts=require('wysiwyg.fonts');var rte=require('web_editor.rte');var ServicesMixin=require('web.ServicesMixin');var weWidgets=require('wysiwyg.widgets');var _t=core._t;var dom=$.summernote.core.dom;var range=$.summernote.core.range;var eventHandler=$.summernote.eventHandler;var renderer=$.summernote.renderer;function protectCommand(callback){return function(){var rng=range.create();var $sc=(rng&&rng.sc)?$(rng.sc).parents(':o_editable').last():$();var $ec=(rng&&rng.ec)?$(rng.ec).parents(':o_editable').last():$();$sc.addClass('o_we_command_protector');$ec.addClass('o_we_command_protector');var restore=function(){$sc.removeClass('o_we_command_protector');$ec.removeClass('o_we_command_protector');};var result;try{result=callback.apply(this,arguments);}catch(err){restore();throw err;}
restore();return result;};}
document.execCommand=protectCommand(document.execCommand);document.queryCommandState=protectCommand(document.queryCommandState);var tplButton=renderer.getTemplate().button;var tplIconButton=renderer.getTemplate().iconButton;var tplDropdown=renderer.getTemplate().dropdown;const processAndApplyColor=function(target,eventName,color,preview){if(!color){color='inherit';}else if(!ColorpickerWidget.isCSSColor(color)){color=(eventName==="foreColor"?'text-':'bg-')+color;}
var layoutInfo=dom.makeLayoutInfo(target);$.summernote.pluginEvents[eventName](undefined,eventHandler.modules.editor,layoutInfo,color,preview);};renderer.createPalette=function($container,options){const $dropdownContent=$container.find(".colorPalette");const parent=odoo.__DEBUG__.services['root.widget'];_.each($dropdownContent,elem=>{const eventName=elem.dataset.eventName;let colorpicker=null;const mutex=new concurrency.MutexedDropPrevious();const $dropdown=$(elem).closest('.btn-group, .dropdown');let manualOpening=false;$dropdown.on('hide.bs.dropdown',ev=>{return!(ev.clickEvent&&ev.clickEvent.originalEvent&&ev.clickEvent.originalEvent.__isColorpickerClick);});$dropdown.on('show.bs.dropdown',()=>{if(manualOpening){return true;}
mutex.exec(()=>{const oldColorpicker=colorpicker;const hookEl=oldColorpicker?oldColorpicker.el:elem;const r=range.create();const targetNode=r.sc;const targetElement=targetNode.nodeType===Node.ELEMENT_NODE?targetNode:targetNode.parentNode;colorpicker=new ColorPaletteWidget(parent,{excluded:['transparent_grayscale'],$editable:rte.Class.prototype.editable(),selectedColor:$(targetElement).css(eventName==="foreColor"?'color':'backgroundColor'),});colorpicker.on('custom_color_picked color_picked',null,ev=>{processAndApplyColor(ev.data.target,eventName,ev.data.color);});colorpicker.on('color_hover color_leave',null,ev=>{processAndApplyColor(ev.data.target,eventName,ev.data.color,true);});colorpicker.on('enter_key_color_colorpicker',null,()=>{$dropdown.children('.dropdown-toggle').dropdown('hide');});return colorpicker.replace(hookEl).then(()=>{if(oldColorpicker){oldColorpicker.destroy();}
manualOpening=true;$dropdown.children('.dropdown-toggle').dropdown('show');manualOpening=false;});});return false;});});};var fn_tplPopovers=renderer.tplPopovers;renderer.tplPopovers=function(lang,options){var $popover=$(fn_tplPopovers.call(this,lang,options));var $imagePopover=$popover.find('.note-image-popover');var $linkPopover=$popover.find('.note-link-popover');var $airPopover=$popover.find('.note-air-popover');$(tplIconButton('fa fa-align-center',{title:_t('Center'),event:'floatMe',value:'center'})).insertAfter($imagePopover.find('[data-event="floatMe"][data-value="left"]'));$imagePopover.find('button[data-event="removeMedia"]').parent().remove();$imagePopover.find('button[data-event="floatMe"][data-value="none"]').remove();var $padding=$('<div class="btn-group"/>');$padding.insertBefore($imagePopover.find('.btn-group:first'));var dropdown_content=['<li><a class="dropdown-item" data-event="padding" href="#" data-value="">'+_t('None')+'</a></li>','<li><a class="dropdown-item" data-event="padding" href="#" data-value="small">'+_t('Small')+'</a></li>','<li><a class="dropdown-item" data-event="padding" href="#" data-value="medium">'+_t('Medium')+'</a></li>','<li><a class="dropdown-item" data-event="padding" href="#" data-value="large">'+_t('Large')+'</a></li>','<li><a class="dropdown-item" data-event="padding" href="#" data-value="xl">'+_t('Xl')+'</a></li>',];$(tplIconButton('fa fa-plus-square-o',{title:_t('Padding'),dropdown:tplDropdown(dropdown_content)})).appendTo($padding);$imagePopover.find('[data-event="imageShape"]:not([data-value])').remove();var $button=$(tplIconButton('fa fa-sun-o',{title:_t('Shadow'),event:'imageShape',value:'shadow'})).insertAfter($imagePopover.find('[data-event="imageShape"][data-value="rounded-circle"]'));var $spin=$('<div class="btn-group d-none only_fa"/>').insertAfter($button.parent());$(tplIconButton('fa fa-refresh',{title:_t('Spin'),event:'imageShape',value:'fa-spin'})).appendTo($spin);var $resizefa=$('<div class="btn-group d-none only_fa"/>').insertAfter($imagePopover.find('.btn-group:has([data-event="resize"])'));for(var size=1;size<=5;size++){$(tplButton('<span class="note-fontsize-10">'+size+'x</span>',{title:size+"x",event:'resizefa',value:size+''})).appendTo($resizefa);}
var $colorfa=$airPopover.find('.note-color').clone();$colorfa.find(".dropdown-menu").css('min-width','172px');$resizefa.after($colorfa);var $imageprop=$('<div class="btn-group"/>');$imageprop.appendTo($imagePopover.find('.popover-body'));$(tplIconButton('fa fa-file-image-o',{title:_t('Edit'),event:'showImageDialog'})).appendTo($imageprop);$(tplIconButton('fa fa-trash-o',{title:_t('Remove'),event:'delete'})).appendTo($imageprop);$(tplIconButton('fa fa-crop',{title:_t('Crop Image'),event:'cropImage',})).insertAfter($imagePopover.find('[data-event="imageShape"][data-value="img-thumbnail"]'));$imagePopover.find('.popover-body').append($airPopover.find(".note-history").clone());$imagePopover.find('[data-event="showImageDialog"]').before($airPopover.find('[data-event="showLinkDialog"]').clone());var $alt=$('<div class="btn-group"/>');$alt.appendTo($imagePopover.find('.popover-body'));$alt.append('<button class="btn btn-secondary" data-event="alt"><strong>'+_t('Description')+': </strong><span class="o_image_alt"/></button>');$linkPopover.find('.popover-body').append($airPopover.find(".note-history").clone());$linkPopover.find('button[data-event="showLinkDialog"] i').attr("class","fa fa-link");$linkPopover.find('button[data-event="unlink"]').before($airPopover.find('button[data-event="showImageDialog"]').clone());$airPopover.find('.note-style .dropdown-toggle').on('mousedown',function(){var $format=$airPopover.find('[data-event="formatBlock"]');var node=range.create().sc;var formats=$format.map(function(){return $(this).data("value");}).get();while(node&&(!node.tagName||(!node.tagName||formats.indexOf(node.tagName.toLowerCase())===-1))){node=node.parentNode;}
$format.removeClass('active');$format.filter('[data-value="'+(node?node.tagName.toLowerCase():"p")+'"]').addClass("active");});setTimeout(function(){$airPopover.add($linkPopover).add($imagePopover).find("button").tooltip('dispose').tooltip({container:'body',trigger:'hover',placement:'bottom'}).on('click',function(){$(this).tooltip('hide');});});return $popover;};var fn_boutton_update=eventHandler.modules.popover.button.update;eventHandler.modules.popover.button.update=function($container,oStyle){var previous=$(".note-control-selection").data('target');if(previous){var $previous=$(previous);$previous.css({"-webkit-animation-play-state":"","animation-play-state":"","-webkit-transition":"","transition":"","-webkit-animation":"","animation":""});$previous.find('.o_we_selected_image').addBack('.o_we_selected_image').removeClass('o_we_selected_image');}
fn_boutton_update.call(this,$container,oStyle);$container.find('.note-color').removeClass('d-none');if(oStyle.image){$container.find('[data-event]').removeClass("active");$container.find('a[data-event="padding"][data-value="small"]').toggleClass("active",$(oStyle.image).hasClass("padding-small"));$container.find('a[data-event="padding"][data-value="medium"]').toggleClass("active",$(oStyle.image).hasClass("padding-medium"));$container.find('a[data-event="padding"][data-value="large"]').toggleClass("active",$(oStyle.image).hasClass("padding-large"));$container.find('a[data-event="padding"][data-value="xl"]').toggleClass("active",$(oStyle.image).hasClass("padding-xl"));$container.find('a[data-event="padding"][data-value=""]').toggleClass("active",!$container.find('li a.active[data-event="padding"]').length);$(oStyle.image).addClass('o_we_selected_image');if(dom.isImgFont(oStyle.image)){$container.find('.note-fore-color-preview > button > .caret').css('border-bottom-color',$(oStyle.image).css('color'));$container.find('.note-back-color-preview > button > .caret').css('border-bottom-color',$(oStyle.image).css('background-color'));$container.find('.btn-group:not(.only_fa):has(button[data-event="resize"],button[data-value="img-thumbnail"])').addClass('d-none');$container.find('.only_fa').removeClass('d-none');$container.find('button[data-event="resizefa"][data-value="2"]').toggleClass("active",$(oStyle.image).hasClass("fa-2x"));$container.find('button[data-event="resizefa"][data-value="3"]').toggleClass("active",$(oStyle.image).hasClass("fa-3x"));$container.find('button[data-event="resizefa"][data-value="4"]').toggleClass("active",$(oStyle.image).hasClass("fa-4x"));$container.find('button[data-event="resizefa"][data-value="5"]').toggleClass("active",$(oStyle.image).hasClass("fa-5x"));$container.find('button[data-event="resizefa"][data-value="1"]').toggleClass("active",!$container.find('.active[data-event="resizefa"]').length);$container.find('button[data-event="imageShape"][data-value="fa-spin"]').toggleClass("active",$(oStyle.image).hasClass("fa-spin"));$container.find('button[data-event="imageShape"][data-value="shadow"]').toggleClass("active",$(oStyle.image).hasClass("shadow"));$container.find('.btn-group:has(button[data-event="imageShape"])').removeClass("d-none");}else{$container.find('.d-none:not(.only_fa, .note-recent-color)').removeClass('d-none');$container.find('.only_fa').addClass('d-none');var width=($(oStyle.image).attr('style')||'').match(/(^|;|\s)width:\s*([0-9]+%)/);if(width){width=width[2];}
$container.find('button[data-event="resize"][data-value="auto"]').toggleClass("active",width!=="100%"&&width!=="50%"&&width!=="25%");$container.find('button[data-event="resize"][data-value="1"]').toggleClass("active",width==="100%");$container.find('button[data-event="resize"][data-value="0.5"]').toggleClass("active",width==="50%");$container.find('button[data-event="resize"][data-value="0.25"]').toggleClass("active",width==="25%");$container.find('button[data-event="imageShape"][data-value="shadow"]').toggleClass("active",$(oStyle.image).hasClass("shadow"));if(!$(oStyle.image).is("img")){$container.find('.btn-group:has(button[data-event="imageShape"])').addClass('d-none');}
$container.find('.note-color').addClass('d-none');}
$container.find('button[data-event="floatMe"][data-value="left"]').toggleClass("active",$(oStyle.image).hasClass("float-left"));$container.find('button[data-event="floatMe"][data-value="center"]').toggleClass("active",$(oStyle.image).hasClass("d-block mx-auto"));$container.find('button[data-event="floatMe"][data-value="right"]').toggleClass("active",$(oStyle.image).hasClass("float-right"));$(oStyle.image).trigger('attributes_change');}else{$container.find('.note-fore-color-preview > button > .caret').css('border-bottom-color',oStyle.color);$container.find('.note-back-color-preview > button > .caret').css('border-bottom-color',oStyle['background-color']);}};var fn_toolbar_boutton_update=eventHandler.modules.toolbar.button.update;eventHandler.modules.toolbar.button.update=function($container,oStyle){fn_toolbar_boutton_update.call(this,$container,oStyle);$container.find('button[data-event="insertUnorderedList"]').toggleClass("active",$(oStyle.ancestors).is('ul:not(.o_checklist)'));$container.find('button[data-event="insertOrderedList"]').toggleClass("active",$(oStyle.ancestors).is('ol'));$container.find('button[data-event="insertCheckList"]').toggleClass("active",$(oStyle.ancestors).is('ul.o_checklist'));};var fn_popover_update=eventHandler.modules.popover.update;eventHandler.modules.popover.update=function($popover,oStyle,isAirMode){var $imagePopover=$popover.find('.note-image-popover');var $linkPopover=$popover.find('.note-link-popover');var $airPopover=$popover.find('.note-air-popover');fn_popover_update.call(this,$popover,oStyle,isAirMode);if(oStyle.image){if(oStyle.image.parentNode.className.match(/(^|\s)media_iframe_video(\s|$)/i)){oStyle.image=oStyle.image.parentNode;}
var alt=$(oStyle.image).attr("alt");$imagePopover.find('.o_image_alt').text((alt||"").replace(/&quot;/g,'"')).parent().toggle(oStyle.image.tagName==="IMG");$imagePopover.show();var target_node=oStyle.image;if(!oStyle.image.className.match(/(^|\s)media_iframe_video(\s|$)/i)){target_node=dom.firstChild(target_node);}
range.createFromNode(target_node).select();eventHandler.modules.editor.saveRange(dom.makeLayoutInfo(target_node).editable());}else{$(".note-control-selection").hide();}
if(oStyle.image||(oStyle.range&&(!oStyle.range.isCollapsed()||(oStyle.range.sc.tagName&&!dom.isAnchor(oStyle.range.sc))))||(oStyle.image&&!$(oStyle.image).closest('a').length)){$linkPopover.hide();oStyle.anchor=false;}
if(oStyle.image||oStyle.anchor||(oStyle.range&&!$(oStyle.range.sc).closest('.note-editable').length)){$airPopover.hide();}else{$airPopover.show();}
const $externalHistoryButtons=$('.o_we_external_history_buttons');if($externalHistoryButtons.length){const $noteHistory=$('.note-history');$noteHistory.addClass('d-none');$externalHistoryButtons.find(':first-child').prop('disabled',$noteHistory.find('[data-event=undo]').prop('disabled'));$externalHistoryButtons.find(':last-child').prop('disabled',$noteHistory.find('[data-event=redo]').prop('disabled'));}
$popover.trigger('summernote_popover_update_call');};var fn_handle_update=eventHandler.modules.handle.update;eventHandler.modules.handle.update=function($handle,oStyle,isAirMode){fn_handle_update.call(this,$handle,oStyle,isAirMode);if(oStyle.image){$handle.find('.note-control-selection').hide();}};function getImgTarget($editable){var $handle=$editable?dom.makeLayoutInfo($editable).handle():undefined;return $(".note-control-selection",$handle).data('target');}
eventHandler.modules.editor.padding=function($editable,sValue){var $target=$(getImgTarget($editable));var paddings="small medium large xl".split(/\s+/);$editable.data('NoteHistory').recordUndo();if(sValue.length){paddings.splice(paddings.indexOf(sValue),1);$target.toggleClass('padding-'+sValue);}
$target.removeClass("padding-"+paddings.join(" padding-"));};eventHandler.modules.editor.resize=function($editable,sValue){var $target=$(getImgTarget($editable));$editable.data('NoteHistory').recordUndo();var width=($target.attr('style')||'').match(/(^|;|\s)width:\s*([0-9]+)%/);if(width){width=width[2]/100;}
$target.css('width',(width!==sValue&&sValue!=="auto")?(sValue*100)+'%':'');};eventHandler.modules.editor.resizefa=function($editable,sValue){var $target=$(getImgTarget($editable));$editable.data('NoteHistory').recordUndo();$target.attr('class',$target.attr('class').replace(/\s*fa-[0-9]+x/g,''));if(+sValue>1){$target.addClass('fa-'+sValue+'x');}};eventHandler.modules.editor.floatMe=function($editable,sValue){var $target=$(getImgTarget($editable));$editable.data('NoteHistory').recordUndo();switch(sValue){case'center':$target.toggleClass('d-block mx-auto').removeClass('float-right float-left');break;case'left':$target.toggleClass('float-left').removeClass('float-right d-block mx-auto');break;case'right':$target.toggleClass('float-right').removeClass('float-left d-block mx-auto');break;}};eventHandler.modules.editor.imageShape=function($editable,sValue){var $target=$(getImgTarget($editable));$editable.data('NoteHistory').recordUndo();$target.toggleClass(sValue);};eventHandler.modules.linkDialog.showLinkDialog=function($editable,$dialog,linkInfo){$editable.data('range').select();$editable.data('NoteHistory').recordUndo();var commonAncestor=linkInfo.range.commonAncestor();if(commonAncestor&&commonAncestor.closest){var link=commonAncestor.closest('a');linkInfo.className=link&&link.className;}
var def=new $.Deferred();topBus.trigger('link_dialog_demand',{$editable:$editable,linkInfo:linkInfo,onSave:function(linkInfo){linkInfo.range.select();$editable.data('range',linkInfo.range);def.resolve(linkInfo);$editable.trigger('keyup');$('.note-popover .note-link-popover').show();},onCancel:def.reject.bind(def),});return def;};eventHandler.modules.imageDialog.showImageDialog=function($editable){var r=$editable.data('range');if(r.sc.tagName&&r.sc.childNodes.length){r.sc=r.sc.childNodes[r.so];}
var media=$(r.sc).parents().addBack().filter(function(i,el){return dom.isImg(el);})[0];var options=$editable.closest('.o_editable, .note-editor').data('options');topBus.trigger('media_dialog_demand',{$editable:$editable,media:media,options:{onUpload:$editable.data('callbacks').onUpload,noVideos:options&&options.noVideos,},onSave:function(newMedia){if(!newMedia){return;}
if(media){$(media).replaceWith(newMedia);}else{r.insertNode(newMedia);}},});return new $.Deferred().reject();};$.summernote.pluginEvents.alt=function(event,editor,layoutInfo,sorted){var $editable=layoutInfo.editable();var $selection=layoutInfo.handle().find('.note-control-selection');topBus.trigger('alt_dialog_demand',{$editable:$editable,media:$selection.data('target'),});};$.summernote.pluginEvents.cropImage=function(event,editor,layoutInfo,sorted){var $editable=layoutInfo.editable();var $selection=layoutInfo.handle().find('.note-control-selection');topBus.trigger('crop_image_demand',{$editable:$editable,media:$selection.data('target'),});};var fn_is_void=dom.isVoid||function(){};dom.isVoid=function(node){return fn_is_void(node)||dom.isImgFont(node)||(node&&node.className&&node.className.match(/(^|\s)media_iframe_video(\s|$)/i));};var fn_is_img=dom.isImg||function(){};dom.isImg=function(node){return fn_is_img(node)||dom.isImgFont(node)||(node&&(node.nodeName==="IMG"||(node.className&&node.className.match(/(^|\s)(media_iframe_video|o_image)(\s|$)/i))));};var fn_is_forbidden_node=dom.isForbiddenNode||function(){};dom.isForbiddenNode=function(node){if(node.tagName==="BR"){return false;}
return fn_is_forbidden_node(node)||$(node).is(".media_iframe_video");};var fn_is_img_font=dom.isImgFont||function(){};dom.isImgFont=function(node){if(fn_is_img_font(node))return true;var nodeName=node&&node.nodeName.toUpperCase();var className=(node&&node.className||"");if(node&&(nodeName==="SPAN"||nodeName==="I")&&className.length){var classNames=className.split(/\s+/);for(var k=0;k<fonts.fontIcons.length;k++){if(_.intersection(fonts.fontIcons[k].alias,classNames).length){return true;}}}
return false;};var fn_is_font=dom.isFont;dom.isFont=function(node){return fn_is_font(node)||dom.isImgFont(node);};var fn_visible=$.summernote.pluginEvents.visible;$.summernote.pluginEvents.visible=function(event,editor,layoutInfo){var res=fn_visible.apply(this,arguments);var rng=range.create();if(!rng)return res;var $node=$(dom.node(rng.sc));if(($node.is('[data-oe-type="html"]')||$node.is('[data-oe-field="arch"]'))&&$node.hasClass("o_editable")&&!$node[0].children.length&&"h1 h2 h3 h4 h5 h6 p b bold i u code sup strong small pre th td span label".toUpperCase().indexOf($node[0].nodeName)===-1){var p=$('<p><br/></p>')[0];$node.append(p);range.createFromNode(p.firstChild).select();}
return res;};function prettify_html(html){html=html.trim();var result='',level=0,get_space=function(level){var i=level,space='';while(i--)space+='  ';return space;},reg=/^<\/?(a|span|font|u|em|i|strong|b)(\s|>)/i,inline_level=Infinity,tokens=_.compact(_.flatten(_.map(html.split(/</),function(value){value=value.replace(/\s+/g,' ').split(/>/);value[0]=/\S/.test(value[0])?'<'+value[0]+'>':'';return value;})));for(var i=0,l=tokens.length;i<l;i++){var token=tokens[i];var inline_tag=reg.test(token);var inline=inline_tag||inline_level<=level;if(token[0]==='<'&&token[1]==='/'){if(inline_tag&&inline_level===level){inline_level=Infinity;}
level--;}
if(!inline&&!/\S/.test(token)){continue;}
if(!inline||(token[1]!=='/'&&inline_level>level)){result+=get_space(level);}
if(token[0]==='<'&&token[1]!=='/'){level++;if(inline_tag&&inline_level>level){inline_level=level;}}
if(token.match(/^<(img|hr|br)/)){level--;}
if(!inline){token=token.trim();}
result+=token.replace(/\s+/,' ');if(inline_level>level){result+='\n';}}
return result;}
$.summernote.pluginEvents.codeview=function(event,editor,layoutInfo,enable){if(!layoutInfo){return;}
if(layoutInfo.toolbar){var is_activated=$.summernote.eventHandler.modules.codeview.isActivated(layoutInfo);if(is_activated===enable){return;}
return eventHandler.modules.codeview.toggle(layoutInfo);}else{var $editor=layoutInfo.editor();var $textarea=$editor.prev('textarea');if($textarea.is('textarea')===enable){return;}
if(!$textarea.length){var html=prettify_html($editor.prop("innerHTML"));$editor.parent().css({'position':'absolute','top':0,'bottom':0,'left':0,'right':0});$textarea=$('<textarea/>').css({'margin':'0 -4px','padding':'0 4px','border':0,'top':'51px','left':'620px','width':'100%','font-family':'sans-serif','font-size':'13px','height':'98%','white-space':'pre','word-wrap':'normal'}).val(html).data('init',html);$editor.before($textarea);$editor.hide();}else{$editor.prop('innerHTML',$textarea.val().replace(/\s*\n\s*/g,'')).trigger('content_changed');$textarea.remove();$editor.show();}}};var last_div;var last_div_change;var last_editable;var initial_data={};function reRangeSelectKey(event){initial_data.range=null;if(event.shiftKey&&event.keyCode>=37&&event.keyCode<=40&&!$(event.target).is("input, textarea, select")){var r=range.create();if(r){var rng=r.reRange(event.keyCode<=38);if(r!==rng){rng.select();}}}}
function reRangeSelect(event,dx,dy){var r=range.create();if(!r||r.isCollapsed())return;var data=r.reRange(dy<0||(dy===0&&dx<0));if(data.sc!==r.sc||data.so!==r.so||data.ec!==r.ec||data.eo!==r.eo){setTimeout(function(){data.select();$(data.sc.parentNode).closest('.note-popover');},0);}
$(data.sc).closest('.o_editable').data('range',r);return r;}
function summernote_mouseup(event){if($(event.target).closest("#web_editor-top-navbar, .note-popover").length){return;}
if(initial_data.event){var dx=event.clientX-(event.shiftKey&&initial_data.rect?initial_data.rect.left:initial_data.event.clientX);var dy=event.clientY-(event.shiftKey&&initial_data.rect?initial_data.rect.top:initial_data.event.clientY);if(10<Math.pow(dx,2)+Math.pow(dy,2)){reRangeSelect(event,dx,dy);}}
if(!$(event.target).closest(".o_editable").length){return;}
if(!initial_data.range||!event.shiftKey){setTimeout(function(){initial_data.range=range.create();},0);}}
var remember_selection;function summernote_mousedown(event){rte.history.splitNext();var $editable=$(event.target).closest(".o_editable, .note-editor");var r;if(document.documentMode){summernote_ie_fix(event,function(node){return node.tagName==="DIV"||node.tagName==="IMG"||(node.dataset&&node.dataset.oeModel);});}else if(last_div&&event.target!==last_div){if(last_div.tagName==="A"){summernote_ie_fix(event,function(node){return node.dataset&&node.dataset.oeModel;});}else if($editable.length){if(summernote_ie_fix(event,function(node){return node.tagName==="A";})){r=range.create();r.select();}}}
try{r=range.create();}catch(e){return;}
var editables=$(".o_editable[contenteditable], .note-editable[contenteditable]");var r_editable=editables.has((r||{}).sc).addBack(editables.filter((r||{}).sc));if(!r_editable.closest('.note-editor').is($editable)&&!r_editable.filter('.o_editable').is(editables)){var saved_editable=editables.has((remember_selection||{}).sc);if($editable.length&&!saved_editable.closest('.o_editable, .note-editor').is($editable)){remember_selection=range.create(dom.firstChild($editable[0]),0);}else if(!saved_editable.length){remember_selection=undefined;}
if(remember_selection){try{remember_selection.select();}catch(e){console.warn(e);}}}else if(r_editable.length){remember_selection=r;}
initial_data.event=event;if(event.shiftKey&&$editable.length){if(initial_data.range){initial_data.range.select();}
var rect=r&&r.getClientRects();initial_data.rect=rect&&rect.length?rect[0]:{top:0,left:0};}}
function summernote_ie_fix(event,pred){var editable;var div;var node=event.target;while(node.parentNode){if(!div&&pred(node)){div=node;}
if(last_div!==node&&(node.getAttribute('contentEditable')==='false'||node.className&&(node.className.indexOf('o_not_editable')!==-1))){break;}
if(node.className&&node.className.indexOf('o_editable')!==-1){if(!div){div=node;}
editable=node;break;}
node=node.parentNode;}
if(!editable){$(last_div_change).removeAttr("contentEditable").removeProp("contentEditable");$(last_editable).attr("contentEditable","true").prop("contentEditable","true");last_div_change=null;last_editable=null;return;}
if(div===last_div){return;}
last_div=div;$(last_div_change).removeAttr("contentEditable").removeProp("contentEditable");if(last_editable!==editable){if($(editable).is("[contentEditable='true']")){$(editable).removeAttr("contentEditable").removeProp("contentEditable");last_editable=editable;}else{last_editable=null;}}
if(!$(div).attr("contentEditable")&&!$(div).is("[data-oe-type='many2one'], [data-oe-type='contact']")){$(div).attr("contentEditable","true").prop("contentEditable","true");last_div_change=div;}else{last_div_change=null;}
return editable!==div?div:null;}
var fn_attach=eventHandler.attach;eventHandler.attach=function(oLayoutInfo,options){fn_attach.call(this,oLayoutInfo,options);oLayoutInfo.editor().on('dragstart','img',function(e){e.preventDefault();});$(document).on('mousedown',summernote_mousedown).on('mouseup',summernote_mouseup);oLayoutInfo.editor().off('click').on('click',function(e){e.preventDefault();});create_dblclick_feature("img, .media_iframe_video, i.fa, span.fa, a.o_image",function(){eventHandler.modules.imageDialog.show(oLayoutInfo);});create_dblclick_feature("a[href], a.btn, button.btn",function(){eventHandler.modules.linkDialog.show(oLayoutInfo);});oLayoutInfo.editable().on('mousedown',function(e){if(dom.isImg(e.target)&&dom.isContentEditable(e.target)){range.createFromNode(e.target).select();}});$(document).on("keyup",reRangeSelectKey);var clone_data=false;if(options.model){oLayoutInfo.editable().data({'oe-model':options.model,'oe-id':options.id});}
if(options.getMediaDomain){oLayoutInfo.editable().data('oe-media-domain',options.getMediaDomain);}
var $node=oLayoutInfo.editor();if($node.data('oe-model')||$node.data('oe-translation-id')){$node.on('content_changed',function(){var $nodes=$('[data-oe-model], [data-oe-translation-id]').filter(function(){return this!==$node[0];});if($node.data('oe-model')){$nodes=$nodes.filter('[data-oe-model="'+$node.data('oe-model')+'"]').filter('[data-oe-id="'+$node.data('oe-id')+'"]').filter('[data-oe-field="'+$node.data('oe-field')+'"]');}
if($node.data('oe-translation-id'))$nodes=$nodes.filter('[data-oe-translation-id="'+$node.data('oe-translation-id')+'"]');if($node.data('oe-type'))$nodes=$nodes.filter('[data-oe-type="'+$node.data('oe-type')+'"]');if($node.data('oe-expression'))$nodes=$nodes.filter('[data-oe-expression="'+$node.data('oe-expression')+'"]');if($node.data('oe-xpath'))$nodes=$nodes.filter('[data-oe-xpath="'+$node.data('oe-xpath')+'"]');if($node.data('oe-contact-options'))$nodes=$nodes.filter('[data-oe-contact-options="'+$node.data('oe-contact-options')+'"]');var nodes=$node.get();if($node.data('oe-type')==="many2one"){$nodes=$nodes.add($('[data-oe-model]').filter(function(){return this!==$node[0]&&nodes.indexOf(this)===-1;}).filter('[data-oe-many2one-model="'+$node.data('oe-many2one-model')+'"]').filter('[data-oe-many2one-id="'+$node.data('oe-many2one-id')+'"]').filter('[data-oe-type="many2one"]'));$nodes=$nodes.add($('[data-oe-model]').filter(function(){return this!==$node[0]&&nodes.indexOf(this)===-1;}).filter('[data-oe-model="'+$node.data('oe-many2one-model')+'"]').filter('[data-oe-id="'+$node.data('oe-many2one-id')+'"]').filter('[data-oe-field="name"]'));}
if(!clone_data){clone_data=true;$nodes.html(this.innerHTML);clone_data=false;}});}
var custom_toolbar=oLayoutInfo.toolbar?oLayoutInfo.toolbar():undefined;var $toolbar=$(oLayoutInfo.popover()).add(custom_toolbar);$('button[data-event="undo"], button[data-event="redo"]',$toolbar).attr('disabled',true);$(oLayoutInfo.editor()).add(oLayoutInfo.handle()).add(oLayoutInfo.popover()).add(custom_toolbar).on('click content_changed',function(){$('button[data-event="undo"]',$toolbar).attr('disabled',!oLayoutInfo.editable().data('NoteHistory').hasUndo());$('button[data-event="redo"]',$toolbar).attr('disabled',!oLayoutInfo.editable().data('NoteHistory').hasRedo());});function create_dblclick_feature(selector,callback){var show_tooltip=true;oLayoutInfo.editor().on("dblclick",selector,function(e){var $target=$(e.target);if(!dom.isContentEditable($target)){return;}
show_tooltip=false;callback();e.stopImmediatePropagation();});oLayoutInfo.editor().on("click",selector,function(e){var $target=$(e.target);if(!dom.isContentEditable($target)){return;}
show_tooltip=true;setTimeout(function(){if(!show_tooltip||$target.attr('title')!==undefined){return;}
$target.tooltip({title:_t('Double-click to edit'),trigger:'manuel',container:'body'}).tooltip('show');setTimeout(function(){$target.tooltip('dispose');},800);},400);});}};var fn_detach=eventHandler.detach;eventHandler.detach=function(oLayoutInfo,options){fn_detach.call(this,oLayoutInfo,options);oLayoutInfo.editable().off('mousedown');oLayoutInfo.editor().off("dragstart");oLayoutInfo.editor().off('click');$(document).off('mousedown',summernote_mousedown);$(document).off('mouseup',summernote_mouseup);oLayoutInfo.editor().off("dblclick");$(document).off("keyup",reRangeSelectKey);};$.summernote.lang.odoo={font:{bold:_t('Bold'),italic:_t('Italic'),underline:_t('Underline'),strikethrough:_t('Strikethrough'),subscript:_t('Subscript'),superscript:_t('Superscript'),clear:_t('Remove Font Style'),height:_t('Line Height'),name:_t('Font Family'),size:_t('Font Size')},image:{image:_t('File / Image'),insert:_t('Insert Image'),resizeFull:_t('Resize Full'),resizeHalf:_t('Resize Half'),resizeQuarter:_t('Resize Quarter'),floatLeft:_t('Float Left'),floatRight:_t('Float Right'),floatNone:_t('Float None'),dragImageHere:_t('Drag an image here'),selectFromFiles:_t('Select from files'),url:_t('Image URL'),remove:_t('Remove Image')},link:{link:_t('Link'),insert:_t('Insert Link'),unlink:_t('Unlink'),edit:_t('Edit'),textToDisplay:_t('Text to display'),url:_t('To what URL should this link go?'),openInNewWindow:_t('Open in new window')},video:{video:_t('Video'),videoLink:_t('Video Link'),insert:_t('Insert Video'),url:_t('Video URL?'),providers:_t('(YouTube, Vimeo, Vine, Instagram, DailyMotion or Youku)')},table:{table:_t('Table')},hr:{insert:_t('Insert Horizontal Rule')},style:{style:_t('Style'),normal:_t('Normal'),blockquote:_t('Quote'),pre:_t('Code'),small:_t('Small'),h1:_t('Header 1'),h2:_t('Header 2'),h3:_t('Header 3'),h4:_t('Header 4'),h5:_t('Header 5'),h6:_t('Header 6')},lists:{unordered:_t('Unordered list'),ordered:_t('Ordered list')},options:{help:_t('Help'),fullscreen:_t('Full Screen'),codeview:_t('Code View')},paragraph:{paragraph:_t('Paragraph'),outdent:_t('Outdent'),indent:_t('Indent'),left:_t('Align left'),center:_t('Align center'),right:_t('Align right'),justify:_t('Justify full')},color:{custom:_t('Custom Color'),background:_t('Background Color'),foreground:_t('Font Color'),transparent:_t('Transparent'),setTransparent:_t('None'),},shortcut:{shortcuts:_t('Keyboard shortcuts'),close:_t('Close'),textFormatting:_t('Text formatting'),action:_t('Action'),paragraphFormatting:_t('Paragraph formatting'),documentStyle:_t('Document Style')},history:{undo:_t('Undo'),redo:_t('Redo')}};var SummernoteManager=Class.extend(mixins.EventDispatcherMixin,ServicesMixin,{init:function(parent){mixins.EventDispatcherMixin.init.call(this);this.setParent(parent);topBus.on('alt_dialog_demand',this,this._onAltDialogDemand);topBus.on('crop_image_demand',this,this._onCropImageDemand);topBus.on('link_dialog_demand',this,this._onLinkDialogDemand);topBus.on('media_dialog_demand',this,this._onMediaDialogDemand);},destroy:function(){mixins.EventDispatcherMixin.destroy.call(this);topBus.off('alt_dialog_demand',this,this._onAltDialogDemand);topBus.off('crop_image_demand',this,this._onCropImageDemand);topBus.off('link_dialog_demand',this,this._onLinkDialogDemand);topBus.off('media_dialog_demand',this,this._onMediaDialogDemand);},saveModifiedImages:function($editable){const defs=_.map($editable,async editableEl=>{const{oeModel:resModel,oeId:resId}=editableEl.dataset;const proms=[...editableEl.querySelectorAll('.o_modified_image_to_save')].map(async el=>{const isBackground=!el.matches('img');el.classList.remove('o_modified_image_to_save');const newAttachmentSrc=await this._rpc({route:`/web_editor/modify_image/${el.dataset.originalId}`,params:{res_model:resModel,res_id:parseInt(resId),data:(isBackground?el.dataset.bgSrc:el.getAttribute('src')).split(',')[1],},});if(isBackground){$(el).css('background-image',`url('${newAttachmentSrc}')`);delete el.dataset.bgSrc;}else{el.setAttribute('src',newAttachmentSrc);}});return Promise.all(proms);});return Promise.all(defs);},_onAltDialogDemand:function(data){if(data.__alreadyDone){return;}
data.__alreadyDone=true;var altDialog=new weWidgets.AltDialog(this,data.options||{},data.media);if(data.onSave){altDialog.on('save',this,data.onSave);}
if(data.onCancel){altDialog.on('cancel',this,data.onCancel);}
altDialog.open();},_onCropImageDemand:function(data){if(data.__alreadyDone){return;}
data.__alreadyDone=true;new weWidgets.ImageCropWidget(this,data.media).appendTo(data.$editable);},_onLinkDialogDemand:function(data){if(data.__alreadyDone){return;}
data.__alreadyDone=true;var linkDialog=new weWidgets.LinkDialog(this,data.options||{},data.$editable,data.linkInfo);if(data.onSave){linkDialog.on('save',this,data.onSave);}
if(data.onCancel){linkDialog.on('cancel',this,data.onCancel);}
linkDialog.open();},_onMediaDialogDemand:function(data){if(data.__alreadyDone){return;}
data.__alreadyDone=true;const model=data.$editable.data('oe-model');const field=data.$editable.data('oe-field');const type=data.$editable.data('oe-type');var mediaDialog=new weWidgets.MediaDialog(this,_.extend({res_model:model,res_id:data.$editable.data('oe-id'),domain:data.$editable.data('oe-media-domain'),useMediaLibrary:field&&(model==='ir.ui.view'&&field==='arch'||type==='html'),},data.options),data.media);if(data.onSave){mediaDialog.on('save',this,data.onSave);}
if(data.onCancel){mediaDialog.on('cancel',this,data.onCancel);}
mediaDialog.open();},});return SummernoteManager;});;

/* /web_editor/static/src/js/editor/image_processing.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.image_processing',function(require){'use strict';const cropperDataFields=['x','y','width','height','rotate','scaleX','scaleY'];const modifierFields=['filter','quality','mimetype','glFilter','originalId','originalSrc','resizeWidth','aspectRatio',];const _applyAll=(result,filter,filters)=>{filters.forEach(f=>{if(f[0]==='blend'){const cv=f[1];const ctx=result.getContext('2d');ctx.globalCompositeOperation=f[2];ctx.globalAlpha=f[3];ctx.drawImage(cv,0,0);ctx.globalCompositeOperation='source-over';ctx.globalAlpha=1.0;}else{filter.addFilter(...f);}});};let applyAll;const glFilters={blur:filter=>filter.addFilter('blur',10),'1977':(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='rgb(243, 106, 188)';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'screen',.3],['brightness',.1],['contrast',.1],['saturation',.3],]);},aden:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='rgb(66, 10, 14)';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'darken',.2],['brightness',.2],['contrast',-.1],['saturation',-.15],['hue',20],]);},brannan:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='rgb(161, 44, 191)';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'lighten',.31],['sepia',.5],['contrast',.4],]);},earlybird:(filter,cv)=>{const ctx=cv.getContext('2d');const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(.2,'#D0BA8E');gradient.addColorStop(1,'#1D0210');ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'overlay',.2],['sepia',.2],['contrast',-.1],]);},inkwell:(filter,cv)=>{applyAll(filter,[['sepia',.3],['brightness',.1],['contrast',-.1],['desaturateLuminance'],]);},maven:(filter,cv)=>{applyAll(filter,[['sepia',.25],['brightness',-.05],['contrast',-.05],['saturation',.5],]);},toaster:(filter,cv)=>{const ctx=cv.getContext('2d');const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(0,'#0F4E80');gradient.addColorStop(1,'#3B003B');ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'screen',.5],['brightness',-.1],['contrast',.5],]);},walden:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='#CC4400';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'screen',.3],['sepia',.3],['brightness',.1],['saturation',.6],['hue',350],]);},valencia:(filter,cv)=>{const ctx=cv.getContext('2d');ctx.fillStyle='#3A0339';ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'exclusion',.5],['sepia',.08],['brightness',.08],['contrast',.08],]);},xpro:(filter,cv)=>{const ctx=cv.getContext('2d');const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(.4,'#E0E7E6');gradient.addColorStop(1,'#2B2AA1');ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[['blend',cv,'color-burn',.7],['sepia',.3],]);},custom:(filter,cv,filterOptions)=>{const options=Object.assign({blend:'normal',filterColor:'',blur:'0',desaturateLuminance:'0',saturation:'0',contrast:'0',brightness:'0',sepia:'0',},JSON.parse(filterOptions||"{}"));const filters=[];if(options.filterColor){const ctx=cv.getContext('2d');ctx.fillStyle=options.filterColor;ctx.fillRect(0,0,cv.width,cv.height);filters.push(['blend',cv,options.blend,1]);}
delete options.blend;delete options.filterColor;filters.push(...Object.entries(options).map(([filter,amount])=>[filter,parseInt(amount)/100]));applyAll(filter,filters);},};async function applyModifications(img){const data=Object.assign({glFilter:'',filter:'#0000',quality:'75',},img.dataset);let{width,height,resizeWidth,quality,filter,mimetype,originalSrc,glFilter,filterOptions,}=data;[width,height,resizeWidth]=[width,height,resizeWidth].map(s=>parseFloat(s));quality=parseInt(quality);const container=document.createElement('div');const original=await loadImage(originalSrc);container.appendChild(original);await activateCropper(original,0,data);const croppedImg=$(original).cropper('getCroppedCanvas',{width,height});$(original).cropper('destroy');const result=document.createElement('canvas');result.width=resizeWidth||croppedImg.width;result.height=croppedImg.height*result.width/croppedImg.width;const ctx=result.getContext('2d');ctx.drawImage(croppedImg,0,0,croppedImg.width,croppedImg.height,0,0,result.width,result.height);if(glFilter){const glf=new window.WebGLImageFilter();const cv=document.createElement('canvas');cv.width=result.width;cv.height=result.height;applyAll=_applyAll.bind(null,result);glFilters[glFilter](glf,cv,filterOptions);const filtered=glf.apply(result);ctx.drawImage(filtered,0,0,filtered.width,filtered.height,0,0,result.width,result.height);}
ctx.fillStyle=filter||'#0000';ctx.fillRect(0,0,result.width,result.height);return result.toDataURL(mimetype,quality/100);}
function loadImage(src,img=new Image()){return new Promise((resolve,reject)=>{img.addEventListener('load',()=>resolve(img),{once:true});img.addEventListener('error',reject,{once:true});img.src=src;});}
const imageCache=new Map();async function activateCropper(image,aspectRatio,dataset){const src=image.getAttribute('src');if(!imageCache.has(src)){const res=await fetch(src);imageCache.set(src,URL.createObjectURL(await res.blob()));}
image.src=imageCache.get(src);$(image).cropper({viewMode:2,dragMode:'move',autoCropArea:1.0,aspectRatio:aspectRatio,data:_.mapObject(_.pick(dataset,...cropperDataFields),value=>parseFloat(value)),minContainerWidth:1,minContainerHeight:1,});return new Promise(resolve=>image.addEventListener('ready',resolve,{once:true}));}
async function loadImageInfo(img,rpc){const src=img.getAttribute('src');if(img.dataset.originalSrc||!src){return;}
const{original}=await rpc({route:'/web_editor/get_image_info',params:{src:src.split(/[?#]/)[0]},});const isLocal=original&&new URL(original.image_src,window.location.origin).origin===window.location.origin;if(isLocal&&original.image_src){img.dataset.originalId=original.id;img.dataset.originalSrc=original.image_src;img.dataset.mimetype=original.mimetype;}}
return{applyModifications,cropperDataFields,activateCropper,loadImageInfo,loadImage,removeOnImageChangeAttrs:[...cropperDataFields,...modifierFields,'aspectRatio'],};});;

/* /web_editor/static/src/js/editor/custom_colors.js defined in bundle 'web.qunit_suite_tests' */
;

/* /web_editor/static/src/js/wysiwyg/widgets/media.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.widgets.media',function(require){'use strict';var concurrency=require('web.concurrency');var core=require('web.core');var Dialog=require('web.Dialog');var dom=require('web.dom');var fonts=require('wysiwyg.fonts');var utils=require('web.utils');var Widget=require('web.Widget');var session=require('web.session');const{removeOnImageChangeAttrs}=require('web_editor.image_processing');const{getCSSVariableValue,DEFAULT_PALETTE}=require('web_editor.utils');var QWeb=core.qweb;var _t=core._t;var MediaWidget=Widget.extend({xmlDependencies:['/web_editor/static/src/xml/wysiwyg.xml'],init:function(parent,media,options){this._super.apply(this,arguments);this.media=media;this.$media=$(media);},clear:function(){if(!this.media){return;}
this._clear();},save:function(){},_clear:function(){},});var SearchableMediaWidget=MediaWidget.extend({events:_.extend({},MediaWidget.prototype.events||{},{'input .o_we_search':'_onSearchInput',}),init:function(){this._super.apply(this,arguments);this._onSearchInput=_.debounce(this._onSearchInput,500);},search:function(needle){},_renderThumbnails:function(){},_onSearchInput:function(ev){this.attachments=[];this.search($(ev.currentTarget).val()||'').then(()=>this._renderThumbnails());this.hasSearched=true;},});var FileWidget=SearchableMediaWidget.extend({events:_.extend({},SearchableMediaWidget.prototype.events||{},{'click .o_upload_media_button':'_onUploadButtonClick','change .o_file_input':'_onFileInputChange','click .o_upload_media_url_button':'_onUploadURLButtonClick','input .o_we_url_input':'_onURLInputChange','click .o_existing_attachment_cell':'_onAttachmentClick','click .o_existing_attachment_remove':'_onRemoveClick','click .o_load_more':'_onLoadMoreClick',}),existingAttachmentsTemplate:undefined,IMAGE_MIMETYPES:['image/gif','image/jpe','image/jpeg','image/jpg','image/gif','image/png','image/svg+xml'],NUMBER_OF_ATTACHMENTS_TO_DISPLAY:30,MAX_DB_ATTACHMENTS:5,init:function(parent,media,options){this._super.apply(this,arguments);this._mutex=new concurrency.Mutex();this.numberOfAttachmentsToDisplay=this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY;this.options=_.extend({mediaWidth:media&&media.parentElement&&$(media.parentElement).width(),useMediaLibrary:true,},options||{});this.attachments=[];this.selectedAttachments=[];this.libraryMedia=[];this.selectedMedia=[];this._onUploadURLButtonClick=dom.makeAsyncHandler(this._onUploadURLButtonClick);},start:function(){var def=this._super.apply(this,arguments);var self=this;this.$urlInput=this.$('.o_we_url_input');this.$form=this.$('form');this.$fileInput=this.$('.o_file_input');this.$uploadButton=this.$('.o_upload_media_button');this.$addUrlButton=this.$('.o_upload_media_url_button');this.$urlSuccess=this.$('.o_we_url_success');this.$urlWarning=this.$('.o_we_url_warning');this.$urlError=this.$('.o_we_url_error');this.$errorText=this.$('.o_we_error_text');var o={url:null,alt:null,};if(this.$media.is('img')){o.url=this.$media.attr('src');}else if(this.$media.is('a.o_image')){o.url=this.$media.attr('href').replace(/[?].*/,'');o.id=+o.url.match(/\/web\/content\/(\d+)/,'')[1];}
return this.search('').then(async()=>{await this._renderThumbnails();if(o.url){self._selectAttachement(_.find(self.attachments,function(attachment){return o.url===attachment.image_src;})||o);}
return def;});},save:function(){return this._mutex.exec(this._save.bind(this));},search:function(needle){this.needle=needle;return this.fetchAttachments(this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY,0);},fetchAttachments:function(number,offset){return this._rpc({model:'ir.attachment',method:'search_read',args:[],kwargs:{domain:this._getAttachmentsDomain(this.needle),fields:['name','mimetype','description','checksum','url','type','res_id','res_model','public','access_token','image_src','image_width','image_height','original_id'],order:[{name:'id',asc:false}],context:this.options.context,limit:number+1,offset:offset,},}).then(attachments=>{this.attachments=this.attachments.slice();Array.prototype.splice.apply(this.attachments,[offset,attachments.length].concat(attachments));});},hasContent(){return this.attachments.length;},_clear:function(){this.media.className=this.media.className&&this.media.className.replace(/(^|\s+)(o_image)(?=\s|$)/g,' ');},_getAttachmentsDomain:function(needle){var domain=this.options.attachmentIDs&&this.options.attachmentIDs.length?['|',['id','in',this.options.attachmentIDs]]:[];var attachedDocumentDomain=['&',['res_model','=',this.options.res_model],['res_id','=',this.options.res_id|0]];if(!this.options.res_id){attachedDocumentDomain.unshift('&');attachedDocumentDomain.push(['create_uid','=',this.options.user_id]);}
if(this.options.data_res_model){var relatedDomain=['&',['res_model','=',this.options.data_res_model],['res_id','=',this.options.data_res_id|0]];if(!this.options.data_res_id){relatedDomain.unshift('&');relatedDomain.push(['create_uid','=',session.uid]);}
domain=domain.concat(['|'],attachedDocumentDomain,relatedDomain);}else{domain=domain.concat(attachedDocumentDomain);}
domain=['|',['public','=',true]].concat(domain);domain=domain.concat(this.options.mimetypeDomain);if(needle&&needle.length){domain.push(['name','ilike',needle]);}
if(!this.options.useMediaLibrary){domain.push('!',['url','=ilike','/web_editor/shape/%']);}
domain.push('!',['name','=like','%.crop']);domain.push('|',['type','=','binary'],'!',['url','=like','/%/static/%']);return domain;},_highlightSelected:function(){var self=this;this.$('.o_existing_attachment_cell.o_we_attachment_selected').removeClass("o_we_attachment_selected");_.each(this.selectedAttachments,function(attachment){self.$('.o_existing_attachment_cell[data-id='+attachment.id+']').addClass("o_we_attachment_selected").css('display','');});},_handleNewAttachment:function(attachment){this.attachments=this.attachments.filter(att=>att.id!==attachment.id);this.attachments.unshift(attachment);this._renderThumbnails();this._selectAttachement(attachment);},_loadMoreImages:function(forceSearch){return this.fetchAttachments(10,this.numberOfAttachmentsToDisplay).then(()=>{this.numberOfAttachmentsToDisplay+=10;if(!forceSearch){this._renderThumbnails();return Promise.resolve();}else{return this.search(this.$('.o_we_search').val()||'');}});},_renderExisting:function(attachments){return QWeb.render(this.existingAttachmentsTemplate,{attachments:attachments,widget:this,});},_renderThumbnails:function(){var attachments=this.attachments.slice(0,this.numberOfAttachmentsToDisplay);this.$('.o_we_existing_attachments').replaceWith(this._renderExisting(attachments));this._highlightSelected();this.$('.o_we_load_more').toggleClass('d-none',!this.hasContent());var noLoadMoreButton=this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY>=this.attachments.length;var noMoreImgToLoad=this.numberOfAttachmentsToDisplay>=this.attachments.length;this.$('.o_load_done_msg').toggleClass('d-none',noLoadMoreButton||!noMoreImgToLoad);this.$('.o_load_more').toggleClass('d-none',noMoreImgToLoad);},_save:async function(){const toSave=Object.fromEntries(this.selectedMedia.map(media=>[media.id,{query:media.query||'',is_dynamic_svg:!!media.isDynamicSVG,}]));let mediaAttachments=[];if(Object.keys(toSave).length!==0){mediaAttachments=await this._rpc({route:'/web_editor/save_library_media',params:{media:toSave,},});}
const selected=this.selectedAttachments.concat(mediaAttachments).map(attachment=>{if(attachment.image_src&&attachment.image_src.startsWith('/web_editor/shape/')){const colorCustomizedURL=new URL(attachment.image_src,window.location.origin);colorCustomizedURL.searchParams.set('c1',getCSSVariableValue('o-color-1'));attachment.image_src=colorCustomizedURL.pathname+colorCustomizedURL.search;}
return attachment;});if(this.options.multiImages){return selected;}
const img=selected[0];if(!img||!img.id||this.$media.attr('src')===img.image_src){return this.media;}
if(!img.public&&!img.access_token){await this._rpc({model:'ir.attachment',method:'generate_access_token',args:[[img.id]]}).then(function(access_token){img.access_token=access_token[0];});}
if(img.image_src){var src=img.image_src;if(!img.public&&img.access_token){src+=_.str.sprintf('?access_token=%s',img.access_token);}
if(!this.$media.is('img')){this.$media=$('<img/>',{class:'img-fluid o_we_custom_image'});this.media=this.$media[0];}
this.$media.attr('src',src);}else{if(!this.$media.is('a')){$('.note-control-selection').hide();this.$media=$('<a/>');this.media=this.$media[0];}
var href='/web/content/'+img.id+'?';if(!img.public&&img.access_token){href+=_.str.sprintf('access_token=%s&',img.access_token);}
href+='unique='+img.checksum+'&download=true';this.$media.attr('href',href);this.$media.addClass('o_image').attr('title',img.name).attr('data-mimetype',img.mimetype);}
this.$media.attr('alt',img.alt||img.description||'');var style=this.style;if(style){this.$media.css(style);}
removeOnImageChangeAttrs.forEach(attr=>{delete this.media.dataset[attr];});this.media.classList.remove('o_modified_image_to_save');this.$media.trigger('image_changed');return this.media;},_selectAttachement:function(attachment,save,{type='attachment'}={}){const possibleProps={'attachment':'selectedAttachments','media':'selectedMedia'};const prop=possibleProps[type];if(this.options.multiImages){const index=this[prop].indexOf(attachment);if(index!==-1){if(!save){this[prop].splice(index,1);}}else{this[prop].push(attachment);}}else{Object.values(possibleProps).forEach(prop=>{this[prop]=[];});this[prop]=[attachment];}
this._highlightSelected();if(save){this.trigger_up('save_request');}},_updateAddUrlUi:function(emptyValue,isURL,isImage){this.$addUrlButton.toggleClass('btn-secondary',emptyValue).toggleClass('btn-primary',!emptyValue).prop('disabled',!isURL);this.$urlSuccess.toggleClass('d-none',!isURL);this.$urlError.toggleClass('d-none',emptyValue||isURL);},_onAttachmentClick:function(ev){const attachment=ev.currentTarget;const{id:attachmentID,mediaId}=attachment.dataset;if(attachmentID){const attachment=this.attachments.find(attachment=>attachment.id===parseInt(attachmentID));this._selectAttachement(attachment,!this.options.multiImages);}else if(mediaId){const media=this.libraryMedia.find(media=>media.id===parseInt(mediaId));this._selectAttachement(media,!this.options.multiImages,{type:'media'});}},_onFileInputChange:function(){return this._mutex.exec(this._addData.bind(this));},_addData:function(){var self=this;var uploadMutex=new concurrency.Mutex();var files=_.sortBy(this.$fileInput[0].files,'size');_.each(files,function(file){uploadMutex.exec(function(){return utils.getDataURLFromFile(file).then(function(result){return self._rpc({route:'/web_editor/attachment/add_data',params:{'name':file.name,'data':result.split(',')[1],'res_id':self.options.res_id,'res_model':self.options.res_model,'width':0,'quality':0,},}).then(function(attachment){self._handleNewAttachment(attachment);});});});});return uploadMutex.getUnlockedDef().then(function(){if(!self.options.multiImages&&!self.noSave){self.trigger_up('save_request');}
self.noSave=false;});},_onRemoveClick:function(ev){var self=this;ev.stopPropagation();Dialog.confirm(this,_t("Are you sure you want to delete this file ?"),{confirm_callback:function(){var $a=$(ev.currentTarget).closest('.o_existing_attachment_cell');var id=parseInt($a.data('id'),10);var attachment=_.findWhere(self.attachments,{id:id});return self._rpc({route:'/web_editor/attachment/remove',params:{ids:[id],},}).then(function(prevented){if(_.isEmpty(prevented)){self.attachments=_.without(self.attachments,attachment);self.attachments.filter(at=>at.original_id[0]===attachment.id).forEach(at=>delete at.original_id);if(!self.attachments.length){self._renderThumbnails();}else{$a.closest('.o_existing_attachment_cell').remove();}
return;}
self.$errorText.replaceWith(QWeb.render('wysiwyg.widgets.image.existing.error',{views:prevented[id],widget:self,}));});}});},_onURLInputChange:function(){var inputValue=this.$urlInput.val();var emptyValue=(inputValue==='');var isURL=/^.+\..+$/.test(inputValue);var isImage=_.any(['.gif','.jpeg','.jpe','.jpg','.png'],function(format){return inputValue.endsWith(format);});this._updateAddUrlUi(emptyValue,isURL,isImage);},_onUploadButtonClick:function(){this.$fileInput.click();},_onUploadURLButtonClick:function(){if(this.$urlInput.is('.o_we_horizontal_collapse')){this.$urlInput.removeClass('o_we_horizontal_collapse');this.$addUrlButton.attr('disabled','disabled');return;}
return this._mutex.exec(this._addUrl.bind(this));},_addUrl:function(){var self=this;return this._rpc({route:'/web_editor/attachment/add_url',params:{'url':this.$urlInput.val(),'res_id':this.options.res_id,'res_model':this.options.res_model,},}).then(function(attachment){self.$urlInput.val('');self._onURLInputChange();self._handleNewAttachment(attachment);if(!self.options.multiImages){self.trigger_up('save_request');}});},_onLoadMoreClick:function(){this._loadMoreImages();},_onSearchInput:function(){this.attachments=[];this.numberOfAttachmentsToDisplay=this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY;this._super.apply(this,arguments);},});var ImageWidget=FileWidget.extend({template:'wysiwyg.widgets.image',existingAttachmentsTemplate:'wysiwyg.widgets.image.existing.attachments',events:Object.assign({},FileWidget.prototype.events,{'change input.o_we_show_optimized':'_onShowOptimizedChange','change .o_we_search_select':'_onSearchSelect',}),MIN_ROW_HEIGHT:128,init:function(parent,media,options){this.searchService='all';options=_.extend({accept:'image/*',mimetypeDomain:[['mimetype','in',this.IMAGE_MIMETYPES]],},options||{});this._onAttachmentImageLoad=this._onAttachmentImageLoad.bind(this);this._super(parent,media,options);},start:async function(){await this._super(...arguments);this.el.addEventListener('load',this._onAttachmentImageLoad,true);},destroy:function(){this.el.removeEventListener('load',this._onAttachmentImageLoad,true);return this._super(...arguments);},async fetchAttachments(number,offset){if(this.needle&&this.searchService!=='database'){number=this.MAX_DB_ATTACHMENTS;offset=0;}
const result=await this._super(number,offset);const primaryColor=getCSSVariableValue('o-color-1');this.attachments.forEach(attachment=>{if(attachment.image_src.startsWith('/')){const newURL=new URL(attachment.image_src,window.location.origin);if(attachment.image_src.startsWith('/web_editor/shape/')){newURL.searchParams.set('c1',primaryColor);}else{newURL.searchParams.set('height',2*this.MIN_ROW_HEIGHT);}
attachment.thumbnail_src=newURL.pathname+newURL.search;}});if(this.needle&&this.options.useMediaLibrary){try{const response=await this._rpc({route:'/web_editor/media_library_search',params:{'query':this.needle,'offset':this.libraryMedia.length,},});const newMedia=response.media;this.nbMediaResults=response.results;this.libraryMedia.push(...newMedia);}catch(e){console.error(`Couldn't reach API endpoint.`);}}
return result;},hasContent(){if(this.searchService==='all'){return this._super(...arguments)||this.libraryMedia.length;}else if(this.searchService==='media-library'){return!!this.libraryMedia.length;}
return this._super(...arguments);},_updateAddUrlUi:function(emptyValue,isURL,isImage){this._super.apply(this,arguments);this.$addUrlButton.text((isURL&&!isImage)?_t("Add as document"):_t("Add image"));const warning=isURL&&!isImage;this.$urlWarning.toggleClass('d-none',!warning);if(warning){this.$urlSuccess.addClass('d-none');}},_renderThumbnails:function(){const alreadyLoaded=this.$('.o_existing_attachment_cell[data-loaded="true"]');this._super(...arguments);this.$('.o_existing_attachment_cell').addClass('d-none');alreadyLoaded.each((index,el)=>{const toReplace=this.$(`.o_existing_attachment_cell[data-id="${el.dataset.id}"], .o_existing_attachment_cell[data-media-id="${el.dataset.mediaId}"]`);if(toReplace.length){toReplace.replaceWith(el);}});this._toggleOptimized(this.$('input.o_we_show_optimized')[0].checked);const placeholderWidth=3/2*this.MIN_ROW_HEIGHT;this.$('.o_we_attachment_placeholder').css({flexGrow:placeholderWidth,flexBasis:placeholderWidth,});if(this.needle&&['media-library','all'].includes(this.searchService)){const noMoreImgToLoad=this.libraryMedia.length===this.nbMediaResults;const noLoadMoreButton=noMoreImgToLoad&&this.libraryMedia.length<=15;this.$('.o_load_done_msg').toggleClass('d-none',noLoadMoreButton||!noMoreImgToLoad);this.$('.o_load_more').toggleClass('d-none',noMoreImgToLoad);}},_renderExisting:function(attachments){if(this.needle&&this.searchService!=='database'){attachments=attachments.slice(0,this.MAX_DB_ATTACHMENTS);}
return QWeb.render(this.existingAttachmentsTemplate,{attachments:attachments,libraryMedia:this.libraryMedia,widget:this,});},_toggleOptimized:function(value){this.$('.o_we_attachment_optimized').each((i,cell)=>cell.style.setProperty('display',value?null:'none','important'));},_highlightSelected:function(){this._super(...arguments);this.selectedMedia.forEach(media=>{this.$(`.o_existing_attachment_cell[data-media-id=${media.id}]`).addClass("o_we_attachment_selected");});},_onAttachmentImageLoad:async function(ev){const img=ev.target;const cell=img.closest('.o_existing_attachment_cell');if(!cell){return;}
if(cell.dataset.mediaId&&!img.src.startsWith('blob')){const mediaUrl=img.src;try{const response=await fetch(mediaUrl);if(response.headers.get('content-type')==='image/svg+xml'){const svg=await response.text();const colorRegex=new RegExp(DEFAULT_PALETTE['1'],'gi');if(colorRegex.test(svg)){const fileName=mediaUrl.split('/').pop();const file=new File([svg.replace(colorRegex,getCSSVariableValue('o-color-1'))],fileName,{type:"image/svg+xml",});img.src=URL.createObjectURL(file);const media=this.libraryMedia.find(media=>media.id===parseInt(cell.dataset.mediaId));if(media){media.isDynamicSVG=true;}
return;}}}catch(e){console.error('CORS is misconfigured on the API server, image will be treated as non-dynamic.');}}
let aspectRatio=img.naturalWidth/img.naturalHeight;if(img.naturalHeight===0){img.width=1000;img.style.position='fixed';img.style.opacity='0';const originalParent=img.parentElement;document.body.appendChild(img);aspectRatio=img.width/img.height;originalParent.appendChild(img);img.removeAttribute('width');img.style.removeProperty('position');img.style.removeProperty('opacity');}
const width=aspectRatio*this.MIN_ROW_HEIGHT;cell.style.flexGrow=width;cell.style.flexBasis=`${width}px`;cell.classList.remove('d-none');cell.classList.add('d-flex');cell.dataset.loaded='true';},_onShowOptimizedChange:function(ev){this._toggleOptimized(ev.target.checked);},_onSearchSelect:function(ev){const{value}=ev.target;this.searchService=value;this.$('.o_we_search').trigger('input');},_onSearchInput:function(ev){this.libraryMedia=[];this._super(...arguments);},_clear:function(type){var allImgClasses=/(^|\s+)(img|img-\S*|o_we_custom_image|rounded-circle|rounded|thumbnail|shadow)(?=\s|$)/g;this.media.className=this.media.className&&this.media.className.replace(allImgClasses,' ');},});var DocumentWidget=FileWidget.extend({template:'wysiwyg.widgets.document',existingAttachmentsTemplate:'wysiwyg.widgets.document.existing.attachments',init:function(parent,media,options){options=_.extend({accept:'*/*',mimetypeDomain:[['mimetype','not in',this.IMAGE_MIMETYPES]],},options||{});this._super(parent,media,options);},_updateAddUrlUi:function(emptyValue,isURL,isImage){this._super.apply(this,arguments);this.$addUrlButton.text((isURL&&isImage)?_t("Add as image"):_t("Add document"));const warning=isURL&&isImage;this.$urlWarning.toggleClass('d-none',!warning);if(warning){this.$urlSuccess.addClass('d-none');}},_getAttachmentsDomain:function(needle){var domain=this._super.apply(this,arguments);return domain.concat('!',utils.assetsDomain());},});var IconWidget=SearchableMediaWidget.extend({template:'wysiwyg.widgets.font-icons',events:_.extend({},SearchableMediaWidget.prototype.events||{},{'click .font-icons-icon':'_onIconClick',}),init:function(parent,media){this._super.apply(this,arguments);fonts.computeFonts();this.iconsParser=fonts.fontIcons;this.alias=_.flatten(_.map(this.iconsParser,function(data){return data.alias;}));},start:function(){this.$icons=this.$('.font-icons-icon');var classes=(this.media&&this.media.className||'').split(/\s+/);for(var i=0;i<classes.length;i++){var cls=classes[i];if(_.contains(this.alias,cls)){this.selectedIcon=cls;this.initialIcon=cls;this._highlightSelectedIcon();}}
this.nonIconClasses=_.without(classes,'media_iframe_video',this.selectedIcon);return this._super.apply(this,arguments);},save:function(){var style=this.$media.attr('style')||'';var iconFont=this._getFont(this.selectedIcon)||{base:'fa',font:''};if(!this.$media.is('span, i')){var $span=$('<span/>');$span.data(this.$media.data());this.$media=$span;this.media=this.$media[0];style=style.replace(/\s*width:[^;]+/,'');}
this.$media.removeClass(this.initialIcon).addClass([iconFont.base,iconFont.font]);this.$media.attr('style',style||null);return Promise.resolve(this.media);},search:function(needle){var iconsParser=this.iconsParser;if(needle&&needle.length){iconsParser=[];_.filter(this.iconsParser,function(data){var cssData=_.filter(data.cssData,function(cssData){return _.find(cssData.names,function(alias){return alias.indexOf(needle)>=0;});});if(cssData.length){iconsParser.push({base:data.base,cssData:cssData,});}});}
this.$('div.font-icons-icons').html(QWeb.render('wysiwyg.widgets.font-icons.icons',{iconsParser:iconsParser,widget:this}));return Promise.resolve();},_clear:function(){var allFaClasses=/(^|\s)(fa|(text-|bg-|fa-)\S*|rounded-circle|rounded|thumbnail|shadow)(?=\s|$)/g;this.media.className=this.media.className&&this.media.className.replace(allFaClasses,' ');},_getFont:function(classNames){if(!(classNames instanceof Array)){classNames=(classNames||"").split(/\s+/);}
var fontIcon,cssData;for(var k=0;k<this.iconsParser.length;k++){fontIcon=this.iconsParser[k];for(var s=0;s<fontIcon.cssData.length;s++){cssData=fontIcon.cssData[s];if(_.intersection(classNames,cssData.names).length){return{base:fontIcon.base,parser:fontIcon.parser,font:cssData.names[0],};}}}
return null;},_highlightSelectedIcon:function(){var self=this;this.$icons.removeClass('o_we_attachment_selected');this.$icons.filter(function(i,el){return _.contains($(el).data('alias').split(','),self.selectedIcon);}).addClass('o_we_attachment_selected');},_onIconClick:function(ev){ev.preventDefault();ev.stopPropagation();this.selectedIcon=$(ev.currentTarget).data('id');this._highlightSelectedIcon();this.trigger_up('save_request');},});var VideoWidget=MediaWidget.extend({template:'wysiwyg.widgets.video',events:_.extend({},MediaWidget.prototype.events||{},{'change .o_video_dialog_options input':'_onUpdateVideoOption','input textarea#o_video_text':'_onVideoCodeInput','change textarea#o_video_text':'_onVideoCodeChange',}),init:function(parent,media,options){this._super.apply(this,arguments);this.isForBgVideo=!!options.isForBgVideo;this._onVideoCodeInput=_.debounce(this._onVideoCodeInput,1000);},start:function(){this.$content=this.$('.o_video_dialog_iframe');if(this.media){var $media=$(this.media);var src=$media.data('oe-expression')||$media.data('src')||($media.is('iframe')?$media.attr('src'):'')||'';this.$('textarea#o_video_text').val(src);this.$('input#o_video_autoplay').prop('checked',src.indexOf('autoplay=1')>=0);this.$('input#o_video_hide_controls').prop('checked',src.indexOf('controls=0')>=0);this.$('input#o_video_loop').prop('checked',src.indexOf('loop=1')>=0);this.$('input#o_video_hide_fullscreen').prop('checked',src.indexOf('fs=0')>=0);this.$('input#o_video_hide_yt_logo').prop('checked',src.indexOf('modestbranding=1')>=0);this.$('input#o_video_hide_dm_logo').prop('checked',src.indexOf('ui-logo=0')>=0);this.$('input#o_video_hide_dm_share').prop('checked',src.indexOf('sharing-enable=0')>=0);this._updateVideo();}
return this._super.apply(this,arguments);},save:function(){this._updateVideo();if(this.isForBgVideo){return Promise.resolve({bgVideoSrc:this.$content.attr('src')});}
if(this.$('.o_video_dialog_iframe').is('iframe')){this.$media=$('<div class="media_iframe_video" data-oe-expression="'+this.$content.attr('src')+'">'+'<div class="css_editable_mode_display">&nbsp;</div>'+'<div class="media_iframe_video_size" contenteditable="false">&nbsp;</div>'+'<iframe src="'+this.$content.attr('src')+'" frameborder="0" contenteditable="false" allowfullscreen="allowfullscreen"></iframe>'+'</div>');this.media=this.$media[0];}
return Promise.resolve(this.media);},_clear:function(){if(this.media.dataset.src){try{delete this.media.dataset.src;}catch(e){this.media.dataset.src=undefined;}}
var allVideoClasses=/(^|\s)media_iframe_video(\s|$)/g;var isVideo=this.media.className&&this.media.className.match(allVideoClasses);if(isVideo){this.media.className=this.media.className.replace(allVideoClasses,' ');this.media.innerHTML='';}},_createVideoNode:function(url,options){options=options||{};const videoData=this._getVideoURLData(url,options);if(videoData.error){return{errorCode:0};}
if(!videoData.type){return{errorCode:1};}
const $video=$('<iframe>').width(1280).height(720).attr('frameborder',0).attr('src',videoData.embedURL).addClass('o_video_dialog_iframe');return{$video:$video,type:videoData.type};},_updateVideo:function(){this.$content.empty();this.$('#o_video_form_group').removeClass('o_has_error o_has_success').find('.form-control, .custom-select').removeClass('is-invalid is-valid');this.$('.o_video_dialog_options div').addClass('d-none');var $textarea=this.$('textarea#o_video_text');var code=$textarea.val().trim();if(!code){return;}
var embedMatch=code.match(/(src|href)=["']?([^"']+)?/);if(embedMatch&&embedMatch[2].length>0&&embedMatch[2].indexOf('instagram')){embedMatch[1]=embedMatch[2];}
var url=embedMatch?embedMatch[1]:code;var query=this._createVideoNode(url,{'autoplay':this.isForBgVideo||this.$('input#o_video_autoplay').is(':checked'),'hide_controls':this.isForBgVideo||this.$('input#o_video_hide_controls').is(':checked'),'loop':this.isForBgVideo||this.$('input#o_video_loop').is(':checked'),'hide_fullscreen':this.isForBgVideo||this.$('input#o_video_hide_fullscreen').is(':checked'),'hide_yt_logo':this.isForBgVideo||this.$('input#o_video_hide_yt_logo').is(':checked'),'hide_dm_logo':this.isForBgVideo||this.$('input#o_video_hide_dm_logo').is(':checked'),'hide_dm_share':this.isForBgVideo||this.$('input#o_video_hide_dm_share').is(':checked'),});var $optBox=this.$('.o_video_dialog_options');this.$el.find('.o_video_dialog_preview_text, .media_iframe_video_size').add($optBox).toggleClass('d-none',!query.$video);this.$el.find('#o_video_form_group').toggleClass('o_has_error',!query.$video).find('.form-control, .custom-select').toggleClass('is-invalid',!query.$video).end().toggleClass('o_has_success',!!query.$video).find('.form-control, .custom-select').toggleClass('is-valid',!!query.$video);$optBox.find('div.o_'+query.type+'_option').removeClass('d-none');$optBox.toggleClass('d-none',this.isForBgVideo||$optBox.find('div:not(.d-none)').length===0);if(query.type==='youtube'){this.$('input#o_video_hide_fullscreen, input#o_video_hide_yt_logo').closest('div').toggleClass('d-none',this.$('input#o_video_hide_controls').is(':checked'));}
var $content=query.$video;if(!$content){switch(query.errorCode){case 0:$content=$('<div/>',{class:'alert alert-danger o_video_dialog_iframe mb-2 mt-2',text:_t("The provided url is not valid"),});break;case 1:$content=$('<div/>',{class:'alert alert-warning o_video_dialog_iframe mb-2 mt-2',text:_t("The provided url does not reference any supported video"),});break;}}
this.$content.replaceWith($content);this.$content=$content;},_onUpdateVideoOption:function(){this._updateVideo();},_onVideoCodeChange:function(){this._updateVideo();},_onVideoCodeInput:function(){this._updateVideo();},_getVideoURLData:function(url,options){if(!url.match(/^(http:\/\/|https:\/\/|\/\/)[a-z0-9]+([-.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/i)){return{error:true,message:'The provided url is invalid',};}
const regexes={youtube:/^(?:(?:https?:)?\/\/)?(?:www\.)?(?:youtu\.be\/|youtube(-nocookie)?\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((?:\w|-){11})(?:\S+)?$/,instagram:/(.*)instagram.com\/p\/(.[a-zA-Z0-9]*)/,vine:/\/\/vine.co\/v\/(.[a-zA-Z0-9]*)/,vimeo:/\/\/(player.)?vimeo.com\/([a-z]*\/)*([0-9]{6,11})[?]?.*/,dailymotion:/.+dailymotion.com\/(video|hub|embed)\/([^_?]+)[^#]*(#video=([^_&]+))?/,youku:/(.*).youku\.com\/(v_show\/id_|embed\/)(.+)/,};const matches=_.mapObject(regexes,regex=>url.match(regex));const autoplay=options.autoplay?'?autoplay=1&mute=1':'?autoplay=0';const controls=options.hide_controls?'&controls=0':'';const loop=options.loop?'&loop=1':'';let embedURL;let type;if(matches.youtube&&matches.youtube[2].length===11){const fullscreen=options.hide_fullscreen?'&fs=0':'';const ytLoop=loop?loop+`&playlist=${matches.youtube[2]}`:'';const logo=options.hide_yt_logo?'&modestbranding=1':'';embedURL=`//www.youtube${matches.youtube[1] || ''}.com/embed/${matches.youtube[2]}${autoplay}&rel=0${ytLoop}${controls}${fullscreen}${logo}`;type='youtube';}else if(matches.instagram&&matches.instagram[2].length){embedURL=`//www.instagram.com/p/${matches.instagram[2]}/embed/`;type='instagram';}else if(matches.vine&&matches.vine[0].length){embedURL=`${matches.vine[0]}/embed/simple`;type='vine';}else if(matches.vimeo&&matches.vimeo[3].length){const vimeoAutoplay=autoplay.replace('mute','muted');embedURL=`//player.vimeo.com/video/${matches.vimeo[3]}${vimeoAutoplay}${loop}`;type='vimeo';}else if(matches.dailymotion&&matches.dailymotion[2].length){const videoId=matches.dailymotion[2].replace('video/','');const logo=options.hide_dm_logo?'&ui-logo=0':'';const share=options.hide_dm_share?'&sharing-enable=0':'';embedURL=`//www.dailymotion.com/embed/video/${videoId}${autoplay}${controls}${logo}${share}`;type='dailymotion';}else if(matches.youku&&matches.youku[3].length){const videoId=matches.youku[3].indexOf('.html?')>=0?matches.youku[3].substring(0,matches.youku[3].indexOf('.html?')):matches.youku[3];embedURL=`//player.youku.com/embed/${videoId}`;type='youku';}
return{type:type,embedURL:embedURL};},});return{MediaWidget:MediaWidget,SearchableMediaWidget:SearchableMediaWidget,FileWidget:FileWidget,ImageWidget:ImageWidget,DocumentWidget:DocumentWidget,IconWidget:IconWidget,VideoWidget:VideoWidget,};});;

/* /web_editor/static/src/js/wysiwyg/widgets/dialog.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.widgets.Dialog',function(require){'use strict';var config=require('web.config');var core=require('web.core');var Dialog=require('web.Dialog');var _t=core._t;var SummernoteDialog=Dialog.extend({init:function(parent,options){this.options=options||{};if(config.device.isMobile){options.fullscreen=true;}
this._super(parent,_.extend({},{buttons:[{text:this.options.save_text||_t("Save"),classes:'btn-primary',click:this.save,},{text:_t("Discard"),close:true,}]},this.options));this.destroyAction='cancel';var self=this;this.opened(function(){self.$('input:visible:first').focus();self.$el.closest('.modal').addClass('o_web_editor_dialog');self.$el.closest('.modal').on('hidden.bs.modal',self.options.onClose);});this.on('closed',this,function(){self._toggleFullScreen();this.trigger(this.destroyAction,this.final_data||null);});},_toggleFullScreen:function(){if(config.device.isMobile&&!this.hasFullScreen){$('#iframe_target[isMobile="true"] #web_editor-top-edit .o_fullscreen').click();}},save:function(){this.destroyAction="save";this.close();},open:function(){this.hasFullScreen=$(window.top.document.body).hasClass('o_field_widgetTextHtml_fullscreen');this._toggleFullScreen();return this._super.apply(this,arguments);},});return SummernoteDialog;});;

/* /web_editor/static/src/js/wysiwyg/widgets/alt_dialog.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.widgets.AltDialog',function(require){'use strict';var core=require('web.core');var Dialog=require('wysiwyg.widgets.Dialog');var _t=core._t;var AltDialog=Dialog.extend({template:'wysiwyg.widgets.alt',xmlDependencies:Dialog.prototype.xmlDependencies.concat(['/web_editor/static/src/xml/wysiwyg.xml']),init:function(parent,options,media){options=options||{};this._super(parent,_.extend({},{title:_t("Change media description and tooltip")},options));this.trigger_up('getRecordInfo',{recordInfo:options,callback:function(recordInfo){_.defaults(options,recordInfo);},});this.media=media;var allEscQuots=/&quot;/g;this.alt=($(this.media).attr('alt')||"").replace(allEscQuots,'"');var title=$(this.media).attr('title')||$(this.media).data('original-title')||"";this.tag_title=(title).replace(allEscQuots,'"');},save:function(){var alt=this.$('#alt').val();var title=this.$('#title').val();var allNonEscQuots=/"/g;$(this.media).attr('alt',alt?alt.replace(allNonEscQuots,"&quot;"):null).attr('title',title?title.replace(allNonEscQuots,"&quot;"):null);$(this.media).trigger('content_changed');this.final_data=this.media;return this._super.apply(this,arguments);},});return AltDialog;});;

/* /web_editor/static/src/js/wysiwyg/widgets/color_palette.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.ColorPalette',function(require){'use strict';const ajax=require('web.ajax');const core=require('web.core');const session=require('web.session');const{ColorpickerWidget}=require('web.Colorpicker');const Widget=require('web.Widget');const summernoteCustomColors=require('web_editor.rte.summernote_custom_colors');const weUtils=require('web_editor.utils');const qweb=core.qweb;const ColorPaletteWidget=Widget.extend({template:'web_editor.snippet.option.colorpicker',events:{'click .o_we_color_btn':'_onColorButtonClick','mouseenter .o_we_color_btn':'_onColorButtonEnter','mouseleave .o_we_color_btn':'_onColorButtonLeave','click .o_we_colorpicker_switch_pane_btn':'_onSwitchPaneButtonClick',},custom_events:{'colorpicker_select':'_onColorPickerSelect','colorpicker_preview':'_onColorPickerPreview',},init:function(parent,options){this._super.apply(this,arguments);this.summernoteCustomColorsArray=[].concat(...summernoteCustomColors);this.style=window.getComputedStyle(document.documentElement);this.options=_.extend({selectedColor:false,resetButton:true,excluded:[],excludeSectionOf:null,$editable:$(),withCombinations:false,},options||{});this.selectedColor='';this.resetButton=this.options.resetButton;this.withCombinations=this.options.withCombinations;this.trigger_up('request_editable',{callback:val=>this.options.$editable=val});},willStart:async function(){await this._super(...arguments);await ColorPaletteWidget.loadDependencies(this);},start:async function(){const res=this._super.apply(this,arguments);const $colorSection=this.$('.o_colorpicker_sections[data-color-tab="theme-colors"]');const $clpicker=qweb.has_template('web_editor.colorpicker')?$(qweb.render('web_editor.colorpicker')):$(`<colorpicker><div class="o_colorpicker_section" data-name="common"></div></colorpicker>`);$clpicker.find('button').addClass('o_we_color_btn');$clpicker.appendTo($colorSection);_.each(this.options.excluded,exc=>{this.$('[data-name="'+exc+'"]').addClass('d-none');});if(this.options.excludeSectionOf){this.$('[data-name]:has([data-color="'+this.options.excludeSectionOf+'"])').addClass('d-none');}
this.el.querySelectorAll('.o_colorpicker_section').forEach(elem=>{$(elem).prepend('<div>'+(elem.dataset.display||'')+'</div>');});if(!this.options.excluded.includes('common')){const $commonColorSection=this.$('[data-name="common"]');summernoteCustomColors.forEach((colorRow,i)=>{if(i===0){return;}
const $div=$('<div/>',{class:'clearfix'}).appendTo($commonColorSection);colorRow.forEach(color=>{$div.append(this._createColorButton(color,['o_common_color']));});});}
const compatibilityColorNames=['primary','secondary','alpha','beta','gamma','delta','epsilon','success','info','warning','danger'];this.colorNames=[...compatibilityColorNames];this.colorToColorNames={};this.el.querySelectorAll('button[data-color]').forEach(elem=>{const colorName=elem.dataset.color;const $color=$(elem);const isCCName=weUtils.isColorCombinationName(colorName);if(isCCName){$color.find('.o_we_cc_preview_wrapper').addClass(`o_cc o_cc${colorName}`);}else{$color.addClass(`bg-${colorName}`);}
this.colorNames.push(colorName);if(!isCCName&&!elem.classList.contains('d-none')){const color=weUtils.getCSSVariableValue(colorName,this.style);this.colorToColorNames[color]=colorName;}});if(this.options.selectedColor){let selectedColor=this.options.selectedColor;if(compatibilityColorNames.includes(selectedColor)){selectedColor=weUtils.getCSSVariableValue(selectedColor,this.style)||selectedColor;}
selectedColor=ColorpickerWidget.normalizeCSSColor(selectedColor);if(selectedColor!=='rgba(0, 0, 0, 0)'){this.selectedColor=this.colorToColorNames[selectedColor]||selectedColor;}}
this._buildCustomColors();this._markSelectedColor();let defaultColor=this.selectedColor;if(defaultColor&&!ColorpickerWidget.isCSSColor(defaultColor)){defaultColor=weUtils.getCSSVariableValue(defaultColor,this.style);}
this.colorPicker=new ColorpickerWidget(this,{defaultColor:defaultColor,});await this.colorPicker.prependTo($colorSection);if(this.options.excluded.includes('custom')){this.colorPicker.$el.addClass('d-none');}
return res;},getColorNames:function(){return this.colorNames;},_buildCustomColors:function(){if(this.options.excluded.includes('custom')){return;}
this.el.querySelectorAll('.o_custom_color').forEach(el=>el.remove());const existingColors=new Set(this.summernoteCustomColorsArray.concat(Object.keys(this.colorToColorNames)));this.trigger_up('get_custom_colors',{onSuccess:(colors)=>{colors.forEach(color=>{this._addCustomColor(existingColors,color);});},});weUtils.getCSSVariableValue('custom-colors',this.style).split(' ').forEach(v=>{const color=weUtils.getCSSVariableValue(v.substring(1,v.length-1),this.style);if(ColorpickerWidget.isCSSColor(color)){this._addCustomColor(existingColors,color);}});_.each(this.options.$editable.find('[style*="color"]'),el=>{for(const colorProp of['color','backgroundColor']){this._addCustomColor(existingColors,el.style[colorProp]);}});if(this.selectedColor){this._addCustomColor(existingColors,this.selectedColor);}},_addCustomColor:function(existingColors,color){if(!color){return;}
if(!ColorpickerWidget.isCSSColor(color)){color=weUtils.getCSSVariableValue(color,this.style);}
const normColor=ColorpickerWidget.normalizeCSSColor(color);if(!existingColors.has(normColor)){this._addCustomColorButton(normColor);existingColors.add(normColor);}},_addCustomColorButton:function(color,classes=[]){classes.push('o_custom_color');const $themeSection=this.$('.o_colorpicker_section[data-name="theme"]');const $button=this._createColorButton(color,classes);return $button.appendTo($themeSection);},_createColorButton:function(color,classes){return $('<button/>',{class:'o_we_color_btn '+classes.join(' '),style:'background-color:'+color+';',});},_getButtonInfo:function(buttonEl){const bgColor=buttonEl.style.backgroundColor;return{color:bgColor?ColorpickerWidget.normalizeCSSColor(bgColor):buttonEl.dataset.color||'',target:buttonEl,};},_selectColor:function(colorInfo,eventName){this.selectedColor=colorInfo.color=this.colorToColorNames[colorInfo.color]||colorInfo.color;this.trigger_up(eventName,colorInfo);this._buildCustomColors();this._markSelectedColor();},_markSelectedColor:function(){this.el.querySelectorAll('button.selected').forEach(el=>el.classList.remove('selected'));const selectedButton=this.el.querySelector(`button[data-color="${this.selectedColor}"], button[style*="background-color:${this.selectedColor};"]`);if(selectedButton){selectedButton.classList.add('selected');}},_onColorButtonClick:function(ev){const buttonEl=ev.currentTarget;const colorInfo=this._getButtonInfo(buttonEl);this._selectColor(colorInfo,'color_picked');},_onColorButtonEnter:function(ev){ev.stopPropagation();this.trigger_up('color_hover',this._getButtonInfo(ev.currentTarget));},_onColorButtonLeave:function(ev){ev.stopPropagation();this.trigger_up('color_leave',{color:this.selectedColor,target:ev.target,});},_onColorPickerPreview:function(ev){this.trigger_up('color_hover',{color:ev.data.cssColor,target:this.colorPicker.el,});},_onColorPickerSelect:function(ev){this._selectColor({color:ev.data.cssColor,target:this.colorPicker.el,},'custom_color_picked');},_onSwitchPaneButtonClick(ev){ev.stopPropagation();this.el.querySelectorAll('.o_we_colorpicker_switch_pane_btn').forEach(el=>{el.classList.remove('active');});ev.currentTarget.classList.add('active');this.el.querySelectorAll('.o_colorpicker_sections').forEach(el=>{el.classList.toggle('d-none',el.dataset.colorTab!==ev.currentTarget.dataset.target);});},});let colorpickerTemplateProm;ColorPaletteWidget.loadDependencies=async function(rpcCapableObj){const proms=[ajax.loadXML('/web_editor/static/src/xml/snippets.xml',qweb)];if(!session.is_website_user){if(!colorpickerTemplateProm&&!qweb.has_template('web_editor.colorpicker')){colorpickerTemplateProm=rpcCapableObj._rpc({model:'ir.ui.view',method:'read_template',args:['web_editor.colorpicker'],}).then(template=>{return qweb.add_template('<templates>'+template+'</templates>');});}
proms.push(colorpickerTemplateProm);}
return Promise.all(proms);};return{ColorPaletteWidget:ColorPaletteWidget,};});;

/* /web_editor/static/src/js/wysiwyg/widgets/image_crop_widget.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.widgets.ImageCropWidget',function(require){'use strict';const core=require('web.core');const Widget=require('web.Widget');const{applyModifications,cropperDataFields,activateCropper,loadImage,loadImageInfo}=require('web_editor.image_processing');const _t=core._t;const ImageCropWidget=Widget.extend({template:['wysiwyg.widgets.crop'],xmlDependencies:['/web_editor/static/src/xml/wysiwyg.xml'],events:{'click.crop_options [data-action]':'_onCropOptionClick','zoom':'_onCropZoom',},init(parent,media){this._super(...arguments);this.media=media;this.$media=$(media);this.document=media.ownerDocument;this.aspectRatios={"0/0":{label:_t("Free"),value:0},"16/9":{label:"16:9",value:16/9},"4/3":{label:"4:3",value:4/3},"1/1":{label:"1:1",value:1},"2/3":{label:"2:3",value:2/3},};const src=this.media.getAttribute('src');const data=Object.assign({},media.dataset);this.initialSrc=src;this.aspectRatio=data.aspectRatio||"0/0";this.mimetype=data.mimetype||src.endsWith('.png')?'image/png':'image/jpeg';},async willStart(){await this._super.apply(this,arguments);await loadImageInfo(this.media,this._rpc.bind(this));if(this.media.dataset.originalSrc){this.originalSrc=this.media.dataset.originalSrc;this.originalId=this.media.dataset.originalId;return;}
this.uncroppable=true;},async start(){if(this.uncroppable){this.displayNotification({type:'warning',title:_t("This image is an external image"),message:_t("This type of image is not supported for cropping.<br/>If you want to crop it, please first download it from the original source and upload it in Odoo."),});return this.destroy();}
const _super=this._super.bind(this);const $cropperWrapper=this.$('.o_we_cropper_wrapper');await loadImage(this.originalSrc,this.media);this.$cropperImage=this.$('.o_we_cropper_img');const cropperImage=this.$cropperImage[0];[cropperImage.style.width,cropperImage.style.height]=[this.$media.width()+'px',this.$media.height()+'px'];const offset=this.$media.offset();offset.left+=parseInt(this.$media.css('padding-left'));offset.top+=parseInt(this.$media.css('padding-right'));$cropperWrapper.offset(offset);await loadImage(this.originalSrc,cropperImage);await activateCropper(cropperImage,this.aspectRatios[this.aspectRatio].value,this.media.dataset);core.bus.trigger('deactivate_snippet');this._onDocumentMousedown=this._onDocumentMousedown.bind(this);this.document.addEventListener('mousedown',this._onDocumentMousedown,{capture:true});return _super(...arguments);},destroy(){if(this.$cropperImage){this.$cropperImage.cropper('destroy');this.document.removeEventListener('mousedown',this._onDocumentMousedown,{capture:true});}
this.media.setAttribute('src',this.initialSrc);return this._super(...arguments);},async _save(){this.media.classList.add('o_modified_image_to_save');[...cropperDataFields,'aspectRatio'].forEach(attr=>{delete this.media.dataset[attr];const value=this._getAttributeValue(attr);if(value){this.media.dataset[attr]=value;}});delete this.media.dataset.resizeWidth;this.initialSrc=await applyModifications(this.media);this.$media.trigger('image_cropped');this.destroy();},_getAttributeValue(attr){if(cropperDataFields.includes(attr)){return this.$cropperImage.cropper('getData')[attr];}
return this[attr];},_resetCropBox(){this.$cropperImage.cropper('clear');this.$cropperImage.cropper('crop');},_onCropOptionClick(ev){const{action,value,scaleDirection}=ev.currentTarget.dataset;switch(action){case'ratio':this.$cropperImage.cropper('reset');this.aspectRatio=value;this.$cropperImage.cropper('setAspectRatio',this.aspectRatios[this.aspectRatio].value);break;case'zoom':case'reset':this.$cropperImage.cropper(action,value);break;case'rotate':this.$cropperImage.cropper(action,value);this._resetCropBox();break;case'flip':{const amount=this.$cropperImage.cropper('getData')[scaleDirection]*-1;return this.$cropperImage.cropper(scaleDirection,amount);}
case'apply':return this._save();case'discard':return this.destroy();}},_onDocumentMousedown(ev){if(document.body.contains(ev.target)&&this.$(ev.target).length===0){return this.destroy();}},async _onCropZoom(){await new Promise(res=>setTimeout(res,0));this._resetCropBox();},});return ImageCropWidget;});;

/* /web_editor/static/src/js/wysiwyg/widgets/link_dialog.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.widgets.LinkDialog',function(require){'use strict';var core=require('web.core');var Dialog=require('wysiwyg.widgets.Dialog');var dom=$.summernote.core.dom;var range=$.summernote.core.range;var _t=core._t;var LinkDialog=Dialog.extend({template:'wysiwyg.widgets.link',xmlDependencies:(Dialog.prototype.xmlDependencies||[]).concat(['/web_editor/static/src/xml/wysiwyg.xml']),events:_.extend({},Dialog.prototype.events||{},{'input':'_onAnyChange','change [name="link_style_color"]':'_onTypeChange','change':'_onAnyChange','input input[name="url"]':'_onURLInput',}),init:function(parent,options,editable,linkInfo){this.options=options||{};this._super(parent,_.extend({title:_t("Link to"),},this.options));this.trigger_up('getRecordInfo',{recordInfo:this.options,callback:recordInfo=>{_.defaults(this.options,recordInfo);},});this.colorsData=[{type:'',label:_t("Link"),btnPreview:'link'},{type:'primary',label:_t("Primary"),btnPreview:'primary'},{type:'secondary',label:_t("Secondary"),btnPreview:'secondary'},];this.editable=editable;this.data=linkInfo||{};this.data.className="";this.data.iniClassName="";var r=this.data.range;this.needLabel=!r||(r.sc===r.ec&&r.so===r.eo);if(this.data.range){const $link=$(this.data.range.sc).filter("a");this.data.iniClassName=$link.attr("class")||"";this.colorCombinationClass=false;let $node=$link;while($node.length&&!$node.is('body')){const className=$node.attr('class')||'';const m=className.match(/\b(o_cc\d+)\b/g);if(m){this.colorCombinationClass=m[0];break;}
$node=$node.parent();}
this.data.className=this.data.iniClassName.replace(/(^|\s+)btn(-[a-z0-9_-]*)?/gi,' ');var is_link=this.data.range.isOnAnchor();var sc=r.sc;var so=r.so;var ec=r.ec;var eo=r.eo;var nodes;if(!is_link){if(sc.tagName){sc=dom.firstChild(so?sc.childNodes[so]:sc);so=0;}else if(so!==sc.textContent.length){if(sc===ec){ec=sc=sc.splitText(so);eo-=so;}else{sc=sc.splitText(so);}
so=0;}
if(ec.tagName){ec=dom.lastChild(eo?ec.childNodes[eo-1]:ec);eo=ec.textContent.length;}else if(eo!==ec.textContent.length){ec.splitText(eo);}
nodes=dom.listBetween(sc,ec);if(dom.isVoid(sc)||dom.isImg(sc)){so=dom.listPrev(sc).length-1;sc=sc.parentNode;}
if(dom.isBR(ec)){eo=dom.listPrev(ec).length-1;ec=ec.parentNode;}else if(dom.isVoid(ec)||dom.isImg(sc)){eo=dom.listPrev(ec).length;ec=ec.parentNode;}
this.data.range=range.create(sc,so,ec,eo);$(editable).data("range",this.data.range);this.data.range.select();}else{nodes=dom.ancestor(sc,dom.isAnchor).childNodes;}
if(dom.isImg(sc)&&nodes.indexOf(sc)===-1){nodes.push(sc);}
if(nodes.length>1||dom.ancestor(nodes[0],dom.isImg)){var text="";this.data.images=[];for(var i=0;i<nodes.length;i++){if(dom.ancestor(nodes[i],dom.isImg)){this.data.images.push(dom.ancestor(nodes[i],dom.isImg));text+='[IMG]';}else if(!is_link&&nodes[i].nodeType===1){}else if(!is_link&&i===0){text+=nodes[i].textContent.slice(so,Infinity);}else if(!is_link&&i===nodes.length-1){text+=nodes[i].textContent.slice(0,eo);}else{text+=nodes[i].textContent;}}
this.data.text=text;}}
this.data.text=this.data.text.replace(/[ \t\r\n]+/g,' ');var allBtnClassSuffixes=/(^|\s+)btn(-[a-z0-9_-]*)?/gi;var allBtnShapes=/\s*(rounded-circle|flat)\s*/gi;this.data.className=this.data.iniClassName.replace(allBtnClassSuffixes,' ').replace(allBtnShapes,' ');},start:function(){this.buttonOptsCollapseEl=this.el.querySelector('#o_link_dialog_button_opts_collapse');this.$styleInputs=this.$('input.link-style');this.$styleInputs.prop('checked',false).filter('[value=""]').prop('checked',true);if(this.data.iniClassName){_.each(this.$('input[name="link_style_color"], select[name="link_style_size"] > option, select[name="link_style_shape"] > option'),el=>{var $option=$(el);if($option.val()&&this.data.iniClassName.match(new RegExp('(^|btn-| |btn-outline-)'+$option.val()))){if($option.is("input")){$option.prop("checked",true);}else{$option.parent().find('option').removeAttr('selected').removeProp('selected');$option.parent().val($option.val());$option.attr('selected','selected').prop('selected','selected');}}});}
if(this.data.url){var match=/mailto:(.+)/.exec(this.data.url);this.$('input[name="url"]').val(match?match[1]:this.data.url);this._onURLInput();}
this._updateOptionsUI();this._adaptPreview();this.$('input:visible:first').focus();return this._super.apply(this,arguments);},save:function(){var data=this._getData();if(data===null){var $url=this.$('input[name="url"]');$url.closest('.form-group').addClass('o_has_error').find('.form-control, .custom-select').addClass('is-invalid');$url.focus();return Promise.reject();}
this.data.text=data.label;this.data.url=data.url;var allWhitespace=/\s+/gi;var allStartAndEndSpace=/^\s+|\s+$/gi;var allBtnTypes=/(^|[ ])(btn-secondary|btn-success|btn-primary|btn-info|btn-warning|btn-danger)([ ]|$)/gi;this.data.className=data.classes.replace(allWhitespace,' ').replace(allStartAndEndSpace,'');if(data.classes.replace(allBtnTypes,' ')){this.data.style={'background-color':'','color':'',};}
this.data.isNewWindow=data.isNewWindow;this.final_data=this.data;return this._super.apply(this,arguments);},_adaptPreview:function(){var data=this._getData();if(data===null){return;}
const attrs={target:data.isNewWindow?'_blank':'',href:data.url&&data.url.length?data.url:'#',class:`${data.classes.replace(/float-\w+/, '')} o_btn_preview`,};this.$("#link-preview").attr(attrs).html((data.label&&data.label.length)?data.label:data.url);},_getData:function(){var $url=this.$('input[name="url"]');var url=$url.val();var label=this.$('input[name="label"]').val()||url;if(label&&this.data.images){for(var i=0;i<this.data.images.length;i++){label=label.replace('<',"&lt;").replace('>',"&gt;").replace(/\[IMG\]/,this.data.images[i].outerHTML);}}
if($url.prop('required')&&(!url||!$url[0].checkValidity())){return null;}
const type=this.$('input[name="link_style_color"]:checked').val()||'';const size=this.$('select[name="link_style_size"]').val()||'';const shape=this.$('select[name="link_style_shape"]').val()||'';const shapes=shape?shape.split(','):[];const style=['outline','fill'].includes(shapes[0])?`${shapes[0]}-`:'';const shapeClasses=shapes.slice(style?1:0).join(' ');const classes=(this.data.className||'')+
(type?(` btn btn-${style}${type}`):'')+
(shapeClasses?(` ${shapeClasses}`):'')+
(size?(' btn-'+size):'');var isNewWindow=this.$('input[name="is_new_window"]').prop('checked');if(url.indexOf('@')>=0&&url.indexOf('mailto:')<0&&!url.match(/^http[s]?/i)){url=('mailto:'+url);}else if(url.indexOf(location.origin)===0&&this.$('#o_link_dialog_url_strip_domain').prop("checked")){url=url.slice(location.origin.length);}
var allWhitespace=/\s+/gi;var allStartAndEndSpace=/^\s+|\s+$/gi;return{label:label,url:url,classes:classes.replace(allWhitespace,' ').replace(allStartAndEndSpace,''),isNewWindow:isNewWindow,};},_updateOptionsUI:function(){const el=this.el.querySelector('[name="link_style_color"]:checked');$(this.buttonOptsCollapseEl).collapse(el&&el.value?'show':'hide');},_onAnyChange:function(){this._adaptPreview();},_onTypeChange(){this._updateOptionsUI();},_onURLInput:function(){var $linkUrlInput=this.$('#o_link_dialog_url_input');$linkUrlInput.closest('.form-group').removeClass('o_has_error').find('.form-control, .custom-select').removeClass('is-invalid');let value=$linkUrlInput.val();let isLink=value.indexOf('@')<0;this.$('input[name="is_new_window"]').closest('.form-group').toggleClass('d-none',!isLink);this.$('.o_strip_domain').toggleClass('d-none',value.indexOf(window.location.origin)!==0);},});return LinkDialog;});;

/* /web_editor/static/src/js/wysiwyg/widgets/media_dialog.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.widgets.MediaDialog',function(require){'use strict';var core=require('web.core');var MediaModules=require('wysiwyg.widgets.media');var Dialog=require('wysiwyg.widgets.Dialog');var _t=core._t;var MediaDialog=Dialog.extend({template:'wysiwyg.widgets.media',xmlDependencies:Dialog.prototype.xmlDependencies.concat(['/web_editor/static/src/xml/wysiwyg.xml']),events:_.extend({},Dialog.prototype.events,{'click #editor-media-image-tab':'_onClickImageTab','click #editor-media-document-tab':'_onClickDocumentTab','click #editor-media-icon-tab':'_onClickIconTab','click #editor-media-video-tab':'_onClickVideoTab',}),custom_events:_.extend({},Dialog.prototype.custom_events||{},{save_request:'_onSaveRequest',show_parent_dialog_request:'_onShowRequest',hide_parent_dialog_request:'_onHideRequest',}),init:function(parent,options,media){var $media=$(media);media=$media[0];this.media=media;options=_.extend({},options);var onlyImages=options.onlyImages||this.multiImages||(media&&($media.parent().data('oeField')==='image'||$media.parent().data('oeType')==='image'));options.noDocuments=onlyImages||options.noDocuments;options.noIcons=onlyImages||options.noIcons;options.noVideos=onlyImages||options.noVideos;this._super(parent,_.extend({},{title:_t("Select a Media"),save_text:_t("Add"),},options));this.trigger_up('getRecordInfo',{recordInfo:options,type:'media',callback:function(recordInfo){_.defaults(options,recordInfo);},});if(!options.noImages){this.imageWidget=new MediaModules.ImageWidget(this,media,options);}
if(!options.noDocuments){this.documentWidget=new MediaModules.DocumentWidget(this,media,options);}
if(!options.noIcons){this.iconWidget=new MediaModules.IconWidget(this,media,options);}
if(!options.noVideos){this.videoWidget=new MediaModules.VideoWidget(this,media,options);}
if(this.imageWidget&&$media.is('img')){this.activeWidget=this.imageWidget;}else if(this.documentWidget&&$media.is('a.o_image')){this.activeWidget=this.documentWidget;}else if(this.videoWidget&&$media.is('.media_iframe_video, .o_bg_video_iframe')){this.activeWidget=this.videoWidget;}else if(this.iconWidget&&$media.is('span, i')){this.activeWidget=this.iconWidget;}else{this.activeWidget=[this.imageWidget,this.documentWidget,this.videoWidget,this.iconWidget].find(w=>!!w);}
this.initiallyActiveWidget=this.activeWidget;},start:function(){var promises=[this._super.apply(this,arguments)];this.$modal.find('.modal-dialog').addClass('o_select_media_dialog');if(this.imageWidget){promises.push(this.imageWidget.appendTo(this.$("#editor-media-image")));}
if(this.documentWidget){promises.push(this.documentWidget.appendTo(this.$("#editor-media-document")));}
if(this.iconWidget){promises.push(this.iconWidget.appendTo(this.$("#editor-media-icon")));}
if(this.videoWidget){promises.push(this.videoWidget.appendTo(this.$("#editor-media-video")));}
this.opened(()=>this.$('input.o_we_search:visible:first').focus());return Promise.all(promises);},isDocumentActive:function(){return this.activeWidget===this.documentWidget;},isIconActive:function(){return this.activeWidget===this.iconWidget;},isImageActive:function(){return this.activeWidget===this.imageWidget;},isVideoActive:function(){return this.activeWidget===this.videoWidget;},save:function(){var self=this;var _super=this._super;var args=arguments;return this.activeWidget.save().then(function(data){if(self.activeWidget!==self.initiallyActiveWidget){self._clearWidgets();}
if(self.media!==data){var oldClasses=self.media&&_.toArray(self.media.classList);if(oldClasses){data.className=_.union(_.toArray(data.classList),oldClasses).join(' ');}}
self.final_data=data;_super.apply(self,args);$(data).trigger('content_changed');});},_clearWidgets:function(){[this.imageWidget,this.documentWidget,this.iconWidget,this.videoWidget].forEach((widget)=>{if(widget!==this.activeWidget){widget&&widget.clear();}});},_onClickDocumentTab:function(){this.activeWidget=this.documentWidget;},_onClickIconTab:function(){this.activeWidget=this.iconWidget;},_onClickImageTab:function(){this.activeWidget=this.imageWidget;},_onClickVideoTab:function(){this.activeWidget=this.videoWidget;},_onHideRequest:function(ev){this.$modal.addClass('d-none');},_onSaveRequest:function(ev){ev.stopPropagation();this.save();},_onShowRequest:function(ev){this.$modal.removeClass('d-none');},});return MediaDialog;});;

/* /web_editor/static/src/js/wysiwyg/widgets/widgets.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('wysiwyg.widgets',function(require){'use strict';var Dialog=require('wysiwyg.widgets.Dialog');var AltDialog=require('wysiwyg.widgets.AltDialog');var MediaDialog=require('wysiwyg.widgets.MediaDialog');var LinkDialog=require('wysiwyg.widgets.LinkDialog');var ImageCropWidget=require('wysiwyg.widgets.ImageCropWidget');const{ColorpickerDialog}=require('web.Colorpicker');var media=require('wysiwyg.widgets.media');return{Dialog:Dialog,AltDialog:AltDialog,MediaDialog:MediaDialog,LinkDialog:LinkDialog,ImageCropWidget:ImageCropWidget,ColorpickerDialog:ColorpickerDialog,MediaWidget:media.MediaWidget,SearchableMediaWidget:media.SearchableMediaWidget,FileWidget:media.FileWidget,ImageWidget:media.ImageWidget,DocumentWidget:media.DocumentWidget,IconWidget:media.IconWidget,VideoWidget:media.VideoWidget,};});;

/* /web_editor/static/src/js/editor/snippets.editor.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.snippet.editor',function(require){'use strict';var concurrency=require('web.concurrency');var core=require('web.core');var Dialog=require('web.Dialog');var dom=require('web.dom');var Widget=require('web.Widget');var options=require('web_editor.snippets.options');var Wysiwyg=require('web_editor.wysiwyg');const{ColorPaletteWidget}=require('web_editor.ColorPalette');const SmoothScrollOnDrag=require('web/static/src/js/core/smooth_scroll_on_drag.js');const{getCSSVariableValue}=require('web_editor.utils');var _t=core._t;var globalSelector={closest:()=>$(),all:()=>$(),is:()=>false,};var SnippetEditor=Widget.extend({template:'web_editor.snippet_overlay',xmlDependencies:['/web_editor/static/src/xml/snippets.xml'],events:{'click .oe_snippet_remove':'_onRemoveClick','wheel':'_onMouseWheel',},custom_events:{'option_update':'_onOptionUpdate','user_value_widget_request':'_onUserValueWidgetRequest','snippet_option_update':'_onSnippetOptionUpdate','snippet_option_visibility_update':'_onSnippetOptionVisibilityUpdate',},init:function(parent,target,templateOptions,$editable,options){this._super.apply(this,arguments);this.options=options;this.$editable=$editable;this.ownerDocument=this.$editable[0].ownerDocument;this.$body=$(this.ownerDocument.body);this.$target=$(target);this.$target.data('snippet-editor',this);this.templateOptions=templateOptions;this.isTargetParentEditable=false;this.isTargetMovable=false;this.$scrollingElement=$().getScrollingElement();this.__isStarted=new Promise(resolve=>{this.__isStartedResolveFunc=resolve;});},start:function(){var defs=[this._super.apply(this,arguments)];defs.push(this._initializeOptions());var $customize=this._customize$Elements[this._customize$Elements.length-1];this.isTargetParentEditable=this.$target.parent().is(':o_editable');this.isTargetMovable=this.isTargetParentEditable&&this.isTargetMovable;this.isTargetRemovable=this.isTargetParentEditable&&!this.$target.parent().is('[data-oe-type="image"]');if(this.isTargetMovable){this.dropped=false;const smoothScrollOptions=this.options.getScrollOptions({jQueryDraggableOptions:{cursorAt:{left:10,top:10},handle:'.o_move_handle',helper:()=>{var $clone=this.$el.clone().css({width:'24px',height:'24px',border:0});$clone.appendTo(this.$body).removeClass('d-none');return $clone;},start:this._onDragAndDropStart.bind(this),stop:(...args)=>{setTimeout(()=>{this._onDragAndDropStop(...args);},0);},},});this.draggableComponent=new SmoothScrollOnDrag(this,this.$el,$().getScrollingElement(),smoothScrollOptions);}else{this.$('.o_overlay_move_options').addClass('d-none');$customize.find('.oe_snippet_clone').addClass('d-none');}
if(!this.isTargetRemovable){this.$el.add($customize).find('.oe_snippet_remove').addClass('d-none');}
var _animationsCount=0;var postAnimationCover=_.throttle(()=>this.cover(),100);this.$target.on('transitionstart.snippet_editor, animationstart.snippet_editor',()=>{_animationsCount++;setTimeout(()=>{if(!--_animationsCount){postAnimationCover();}},500);});this.$target.on('transitionend.snippet_editor, animationend.snippet_editor',postAnimationCover);return Promise.all(defs).then(()=>{this.__isStartedResolveFunc(this);});},destroy:function(){this.trigger_up('snippet_editor_destroyed');this._super(...arguments);this.$target.removeData('snippet-editor');this.$target.off('.snippet_editor');},areOptionsShown:function(){const lastIndex=this._customize$Elements.length-1;return!!this._customize$Elements[lastIndex].parent().length;},buildSnippet:async function(){for(var i in this.styles){this.styles[i].onBuilt();}
await this.toggleTargetVisibility(true);},cleanForSave:async function(){if(this.isDestroyed()){return;}
await this.toggleTargetVisibility(!this.$target.hasClass('o_snippet_invisible'));const proms=_.map(this.styles,option=>{return option.cleanForSave();});await Promise.all(proms);},closeWidgets:function(){if(!this.styles||!this.areOptionsShown()){return;}
Object.keys(this.styles).forEach(key=>{this.styles[key].closeWidgets();});},cover:function(){if(!this.isShown()||!this.$target.length){return;}
const $modal=this.$target.find('.modal');const $target=$modal.length?$modal:this.$target;const targetEl=$target[0];const rect=targetEl.getBoundingClientRect();const vpWidth=window.innerWidth||document.documentElement.clientWidth;const vpHeight=window.innerHeight||document.documentElement.clientHeight;const isInViewport=(rect.bottom>-0.1&&rect.right>-0.1&&(vpHeight-rect.top)>-0.1&&(vpWidth-rect.left)>-0.1);const hasSize=(Math.abs(rect.bottom-rect.top)>0.01&&Math.abs(rect.right-rect.left)>0.01);if(!isInViewport||!hasSize||!this.$target.is(`:visible`)){this.toggleOverlayVisibility(false);return;}
const offset=$target.offset();var manipulatorOffset=this.$el.parent().offset();offset.top-=manipulatorOffset.top;offset.left-=manipulatorOffset.left;this.$el.css({width:$target.outerWidth(),left:offset.left,top:offset.top,});this.$('.o_handles').css('height',$target.outerHeight());const editableOffsetTop=this.$editable.offset().top-manipulatorOffset.top;this.$el.toggleClass('o_top_cover',offset.top-editableOffsetTop<25);},getName:function(){if(this.$target.data('name')!==undefined){return this.$target.data('name');}
if(this.$target.is('img')){return _t("Image");}
if(this.$target.parent('.row').length){return _t("Column");}
return _t("Block");},isShown:function(){return this.$el&&this.$el.parent().length&&this.$el.hasClass('oe_active');},isSticky:function(){return this.$el&&this.$el.hasClass('o_we_overlay_sticky');},isTargetVisible:function(){return(this.$target[0].dataset.invisible!=='1');},removeSnippet:async function(){this.toggleOverlay(false);this.toggleOptions(false);await this.toggleTargetVisibility(!this.$target.hasClass('o_snippet_invisible'));await new Promise(resolve=>{this.trigger_up('call_for_each_child_snippet',{$snippet:this.$target,callback:function(editor,$snippet){for(var i in editor.styles){editor.styles[i].onRemove();}
resolve();},});});this.trigger_up('go_to_parent',{$snippet:this.$target});var $parent=this.$target.parent();this.$target.find('*').addBack().tooltip('dispose');this.$target.remove();this.$el.remove();var node=$parent[0];if(node&&node.firstChild){if(!node.firstChild.tagName&&node.firstChild.textContent===' '){node.removeChild(node.firstChild);}}
if($parent.closest(':data("snippet-editor")').length){var editor=$parent.data('snippet-editor');while(!editor){var $nextParent=$parent.parent();if(isEmptyAndRemovable($parent)){$parent.remove();}
$parent=$nextParent;editor=$parent.data('snippet-editor');}
if(isEmptyAndRemovable($parent,editor)){setTimeout(()=>editor.removeSnippet());}}
this.$body.find('.note-control-selection').hide();this.$body.find('.o_table_handler').remove();this.trigger_up('snippet_removed');this.destroy();$parent.trigger('content_changed');$(window).trigger('resize');function isEmptyAndRemovable($el,editor){editor=editor||$el.data('snippet-editor');return $el.children().length===0&&$el.text().trim()===''&&!$el.hasClass('oe_structure')&&(!editor||editor.isTargetParentEditable);}},toggleOverlay:function(show,previewMode){if(!this.$el){return;}
if(previewMode){this.$el.toggleClass('o_we_overlay_preview',show);}else{this.$el.removeClass('o_we_overlay_preview');this.$el.toggleClass('o_we_overlay_sticky',show);}
this.$el.toggleClass('oe_active',show);this.cover();},toggleOptions:function(show){if(!this.$el){return;}
if(this.areOptionsShown()===show){return;}
this.trigger_up('update_customize_elements',{customize$Elements:show?this._customize$Elements:[],});this._customize$Elements.forEach(($el,i)=>{const editor=$el.data('editor');const styles=_.chain(editor.styles).values().sortBy('__order').value();if(show){styles.forEach(style=>style.onFocus());styles.forEach(style=>style.updateUI());}else{styles.forEach(style=>style.onBlur());}});},toggleTargetVisibility:async function(show){show=this._toggleVisibilityStatus(show);var styles=_.values(this.styles);const proms=_.sortBy(styles,'__order').map(style=>{return show?style.onTargetShow():style.onTargetHide();});await Promise.all(proms);return show;},toggleOverlayVisibility:function(show){if(this.$el&&!this.scrollingTimeout){this.$el.toggleClass('o_overlay_hidden',!show&&this.isShown());}},clone:async function(recordUndo){this.trigger_up('snippet_will_be_cloned',{$target:this.$target});var $clone=this.$target.clone(false);if(recordUndo){this.trigger_up('request_history_undo_record',{$target:this.$target});}
this.$target.after($clone);await new Promise(resolve=>{this.trigger_up('call_for_each_child_snippet',{$snippet:$clone,callback:function(editor,$snippet){for(var i in editor.styles){editor.styles[i].onClone({isCurrent:($snippet.is($clone)),});}
resolve();},});});this.trigger_up('snippet_cloned',{$target:$clone,$origin:this.$target});$clone.trigger('content_changed');},_initializeOptions:function(){this._customize$Elements=[];this.styles={};this.selectorSiblings=[];this.selectorChildren=[];var $element=this.$target.parent();while($element.length){var parentEditor=$element.data('snippet-editor');if(parentEditor){this._customize$Elements=this._customize$Elements.concat(parentEditor._customize$Elements);break;}
$element=$element.parent();}
var $optionsSection=$(core.qweb.render('web_editor.customize_block_options_section',{name:this.getName(),})).data('editor',this);const $optionsSectionBtnGroup=$optionsSection.find('we-top-button-group');$optionsSectionBtnGroup.contents().each((i,node)=>{if(node.nodeType===Node.TEXT_NODE){node.parentNode.removeChild(node);}});$optionsSection.on('mouseenter',this._onOptionsSectionMouseEnter.bind(this));$optionsSection.on('mouseleave',this._onOptionsSectionMouseLeave.bind(this));$optionsSection.on('click','we-title > span',this._onOptionsSectionClick.bind(this));$optionsSection.on('click','.oe_snippet_clone',this._onCloneClick.bind(this));$optionsSection.on('click','.oe_snippet_remove',this._onRemoveClick.bind(this));this._customize$Elements.push($optionsSection);this.$el.data('$optionsSection',$optionsSection);var i=0;var defs=_.map(this.templateOptions,val=>{if(!val.selector.is(this.$target)){return;}
if(val['drop-near']){this.selectorSiblings.push(val['drop-near']);}
if(val['drop-in']){this.selectorChildren.push(val['drop-in']);}
var optionName=val.option;var option=new(options.registry[optionName]||options.Class)(this,val.$el.children(),val.base_target?this.$target.find(val.base_target).eq(0):this.$target,this.$el,_.extend({optionName:optionName,snippetName:this.getName(),},val.data),this.options);var key=optionName||_.uniqueId('option');if(this.styles[key]){key=_.uniqueId(key);}
this.styles[key]=option;option.__order=i++;if(option.forceNoDeleteButton){this.$el.add($optionsSection).find('.oe_snippet_remove').addClass('d-none');}
return option.appendTo(document.createDocumentFragment());});this.isTargetMovable=(this.selectorSiblings.length>0||this.selectorChildren.length>0);this.$el.find('[data-toggle="dropdown"]').dropdown();return Promise.all(defs).then(()=>{const options=_.sortBy(this.styles,'__order');options.forEach(option=>{if(option.isTopOption){$optionsSectionBtnGroup.prepend(option.$el);}else{$optionsSection.append(option.$el);}});$optionsSection.toggleClass('d-none',options.length===0);});},_toggleVisibilityStatus:function(show){if(show===undefined){show=!this.isTargetVisible();}
if(show){delete this.$target[0].dataset.invisible;}else{this.$target[0].dataset.invisible='1';}
return show;},_onCloneClick:function(ev){ev.preventDefault();this.clone(true);},_onDragAndDropStart:function(){var self=this;this.dropped=false;self.size={width:self.$target.width(),height:self.$target.height()};self.$target.after('<div class="oe_drop_clone" style="display: none;"/>');self.$target.detach();self.$el.addClass('d-none');var $selectorSiblings;for(var i=0;i<self.selectorSiblings.length;i++){if(!$selectorSiblings){$selectorSiblings=self.selectorSiblings[i].all();}else{$selectorSiblings=$selectorSiblings.add(self.selectorSiblings[i].all());}}
var $selectorChildren;for(i=0;i<self.selectorChildren.length;i++){if(!$selectorChildren){$selectorChildren=self.selectorChildren[i].all();}else{$selectorChildren=$selectorChildren.add(self.selectorChildren[i].all());}}
this.trigger_up('go_to_parent',{$snippet:this.$target});this.trigger_up('activate_insertion_zones',{$selectorSiblings:$selectorSiblings,$selectorChildren:$selectorChildren,});this.$body.addClass('move-important');this.$editable.find('.oe_drop_zone').droppable({over:function(){if(!self.dropped){self.dropped=true;$(this).first().after(self.$target).addClass('invisible');}},out:function(){var prev=self.$target.prev();if(this===prev[0]){self.dropped=false;self.$target.detach();$(this).removeClass('invisible');}},});const $openModal=self.$editable.find('.modal:visible');self.draggableComponent.$scrollTarget=$openModal.length?$openModal:self.$scrollingElement;self.draggableComponent.$scrollTarget.on('scroll.scrolling_element',function(){self.$el.trigger('scroll');});},_onDragAndDropStop:function(ev,ui){if(!this.dropped){var $el=$.nearest({x:ui.position.left,y:ui.position.top},'.oe_drop_zone',{container:document.body}).first();if($el.length){$el.after(this.$target);this.dropped=true;}}
this.$editable.find('.oe_drop_zone').droppable('destroy').remove();var prev=this.$target.first()[0].previousSibling;var next=this.$target.last()[0].nextSibling;var $parent=this.$target.parent();var $clone=this.$editable.find('.oe_drop_clone');if(prev===$clone[0]){prev=$clone[0].previousSibling;}else if(next===$clone[0]){next=$clone[0].nextSibling;}
$clone.after(this.$target);var $from=$clone.parent();this.$el.removeClass('d-none');this.$body.removeClass('move-important');$clone.remove();if(this.dropped){this.trigger_up('request_history_undo_record',{$target:this.$target});if(prev){this.$target.insertAfter(prev);}else if(next){this.$target.insertBefore(next);}else{$parent.prepend(this.$target);}
for(var i in this.styles){this.styles[i].onMove();}
this.$target.trigger('content_changed');$from.trigger('content_changed');}
this.trigger_up('drag_and_drop_stop',{$snippet:this.$target,});this.draggableComponent.$scrollTarget.off('scroll.scrolling_element');},_onOptionsSectionMouseEnter:function(ev){if(!this.$target.is(':visible')){return;}
this.trigger_up('activate_snippet',{$snippet:this.$target,previewMode:true,});},_onOptionsSectionMouseLeave:function(ev){this.trigger_up('activate_snippet',{$snippet:false,previewMode:true,});},_onOptionsSectionClick:function(ev){this.trigger_up('activate_snippet',{$snippet:this.$target,previewMode:false,});},_onOptionUpdate:function(ev){var self=this;if(ev.data.optionNames){ev.stopPropagation();_.each(ev.data.optionNames,function(name){notifyForEachMatchedOption(name);});}
if(ev.data.optionName){if(notifyForEachMatchedOption(ev.data.optionName)){ev.stopPropagation();}}
function notifyForEachMatchedOption(name){var regex=new RegExp('^'+name+'\\d+$');var hasOption=false;for(var key in self.styles){if(key===name||regex.test(key)){self.styles[key].notify(ev.data.name,ev.data.data);hasOption=true;}}
return hasOption;}},_onRemoveClick:function(ev){ev.preventDefault();ev.stopPropagation();this.trigger_up('request_history_undo_record',{$target:this.$target});this.removeSnippet();},_onSnippetOptionUpdate:async function(ev){const proms1=Object.keys(this.styles).map(key=>{return this.styles[key].updateUI({noVisibility:true,});});await Promise.all(proms1);const proms2=Object.keys(this.styles).map(key=>{return this.styles[key].updateUIVisibility();});await Promise.all(proms2);ev.data.onSuccess();},_onSnippetOptionVisibilityUpdate:function(ev){ev.data.show=this._toggleVisibilityStatus(ev.data.show);},_onUserValueWidgetRequest:function(ev){ev.stopPropagation();for(const key of Object.keys(this.styles)){const widget=this.styles[key].findWidget(ev.data.name);if(widget){ev.data.onSuccess(widget);return;}}},_onMouseWheel:function(ev){ev.stopPropagation();this.$el.css('pointer-events','none');clearTimeout(this.wheelTimeout);this.wheelTimeout=setTimeout(()=>{this.$el.css('pointer-events','');},250);},});var SnippetsMenu=Widget.extend({id:'oe_snippets',cacheSnippetTemplate:{},events:{'click .oe_snippet':'_onSnippetClick','click .o_install_btn':'_onInstallBtnClick','click .o_we_add_snippet_btn':'_onBlocksTabClick','click .o_we_invisible_entry':'_onInvisibleEntryClick','click #snippet_custom .o_delete_btn':'_onDeleteBtnClick','mousedown':'_onMouseDown','input .o_snippet_search_filter_input':'_onSnippetSearchInput','click .o_snippet_search_filter_reset':'_onSnippetSearchResetClick','summernote_popover_update_call .o_we_snippet_text_tools':'_onSummernoteToolsUpdate',},custom_events:{'activate_insertion_zones':'_onActivateInsertionZones','activate_snippet':'_onActivateSnippet','call_for_each_child_snippet':'_onCallForEachChildSnippet','clone_snippet':'_onCloneSnippet','cover_update':'_onOverlaysCoverUpdate','deactivate_snippet':'_onDeactivateSnippet','drag_and_drop_stop':'_onDragAndDropStop','get_snippet_versions':'_onGetSnippetVersions','go_to_parent':'_onGoToParent','remove_snippet':'_onRemoveSnippet','snippet_edition_request':'_onSnippetEditionRequest','snippet_editor_destroyed':'_onSnippetEditorDestroyed','snippet_removed':'_onSnippetRemoved','snippet_cloned':'_onSnippetCloned','snippet_option_visibility_update':'_onSnippetOptionVisibilityUpdate','snippet_thumbnail_url_request':'_onSnippetThumbnailURLRequest','reload_snippet_dropzones':'_disableUndroppableSnippets','request_save':'_onSaveRequest','update_customize_elements':'_onUpdateCustomizeElements','hide_overlay':'_onHideOverlay','block_preview_overlays':'_onBlockPreviewOverlays','unblock_preview_overlays':'_onUnblockPreviewOverlays','user_value_widget_opening':'_onUserValueWidgetOpening','user_value_widget_closing':'_onUserValueWidgetClosing','reload_snippet_template':'_onReloadSnippetTemplate',},tabs:{BLOCKS:'blocks',OPTIONS:'options',},init:function(parent,options){this._super.apply(this,arguments);options=options||{};this.trigger_up('getRecordInfo',{recordInfo:options,callback:function(recordInfo){_.defaults(options,recordInfo);},});this.options=options;if(!this.options.snippets){this.options.snippets='web_editor.snippets';}
this.snippetEditors=[];this._enabledEditorHierarchy=[];this._mutex=new concurrency.Mutex();this.setSelectorEditableArea(options.$el,options.selectorEditableArea);this._notActivableElementsSelector=['#web_editor-top-edit','.o_we_website_top_actions','#oe_snippets','#oe_manipulators','.o_technical_modal','.oe_drop_zone','.o_notification_manager','.o_we_no_overlay','.ui-autocomplete','.modal .close','.o_we_crop_widget',].join(', ');this.loadingTimers={};this.loadingElements={};},willStart:function(){ColorPaletteWidget.loadDependencies(this);return this._super(...arguments);},async start(){var defs=[this._super.apply(this,arguments)];this.ownerDocument=this.$el[0].ownerDocument;this.$document=$(this.ownerDocument);this.window=this.ownerDocument.defaultView;this.$window=$(this.window);this.customizePanel=document.createElement('div');this.customizePanel.classList.add('o_we_customize_panel','d-none');this.textEditorPanelEl=document.createElement('div');this.textEditorPanelEl.classList.add('o_we_snippet_text_tools','d-none');this.invisibleDOMPanelEl=document.createElement('div');this.invisibleDOMPanelEl.classList.add('o_we_invisible_el_panel');this.invisibleDOMPanelEl.appendChild($('<div/>',{text:_t('Invisible Elements'),class:'o_panel_header',})[0]);this.options.getScrollOptions=this._getScrollOptions.bind(this);defs.push((async()=>{await this._loadSnippetsTemplates();await this._updateInvisibleDOM();})());this.$snippetEditorArea=$('<div/>',{id:'oe_manipulators',}).insertAfter(this.$el);var lastElement;this.$document.on('click.snippets_menu','*',ev=>{var srcElement=ev.target||(ev.originalEvent&&(ev.originalEvent.target||ev.originalEvent.originalTarget))||ev.srcElement;if(!srcElement||lastElement===srcElement){return;}
lastElement=srcElement;_.defer(function(){lastElement=false;});var $target=$(srcElement);if(!$target.closest('we-button, we-toggler, .o_we_color_preview').length){this._closeWidgets();}
if(!$target.closest('body > *').length){return;}
if($target.closest(this._notActivableElementsSelector).length){return;}
const $oeStructure=$target.closest('.oe_structure');if($oeStructure.length&&!$oeStructure.children().length&&this.$snippets){this.$snippets.odooBounce();return;}
this._activateSnippet($target);});core.bus.on('deactivate_snippet',this,this._onDeactivateSnippet);var debouncedCoverUpdate=_.throttle(()=>{this.updateCurrentSnippetEditorOverlay();},50);this.$window.on('resize.snippets_menu',debouncedCoverUpdate);this.$window.on('content_changed.snippets_menu',debouncedCoverUpdate);this.$document.on('keydown.snippets_menu',()=>{this.__overlayKeyWasDown=true;this.snippetEditors.forEach(editor=>{editor.toggleOverlayVisibility(false);});});this.$document.on('mousemove.snippets_menu, mousedown.snippets_menu',_.throttle(()=>{if(!this.__overlayKeyWasDown){return;}
this.__overlayKeyWasDown=false;this.snippetEditors.forEach(editor=>{editor.toggleOverlayVisibility(true);editor.cover();});},250));this.$scrollingElement=$().getScrollingElement();this._onScrollingElementScroll=_.throttle(()=>{for(const editor of this.snippetEditors){editor.toggleOverlayVisibility(false);}
clearTimeout(this.scrollingTimeout);this.scrollingTimeout=setTimeout(()=>{this._scrollingTimeout=null;for(const editor of this.snippetEditors){editor.toggleOverlayVisibility(true);editor.cover();}},250);},50)
this.$scrollingElement[0].addEventListener('scroll',this._onScrollingElementScroll,{capture:true});this.$document.on('click.snippets_menu','.o_default_snippet_text',function(ev){$(ev.target).closest('.o_default_snippet_text').removeClass('o_default_snippet_text');$(ev.target).selectContent();$(ev.target).removeClass('o_default_snippet_text');});this.$document.on('keyup.snippets_menu',function(){var range=Wysiwyg.getRange(this);$(range&&range.sc).closest('.o_default_snippet_text').removeClass('o_default_snippet_text');});const $autoFocusEls=$('.o_we_snippet_autofocus');this._activateSnippet($autoFocusEls.length?$autoFocusEls.first():false);this.$el.tooltip({selector:'we-title',placement:'bottom',delay:100,title:function(){const el=this;el.style.setProperty('overflow','scroll','important');const tipContent=el.scrollWidth>el.clientWidth?el.innerHTML:'';el.style.removeProperty('overflow');return tipContent;},});return Promise.all(defs).then(()=>{this.$('[data-title]').tooltip({delay:100,title:function(){return this.classList.contains('active')?false:this.dataset.title;},});setTimeout(()=>{this.$window.trigger('resize');this._mutex.exec(()=>this._textToolsSwitchingEnabled=true);},1000);});},destroy:function(){this._super.apply(this,arguments);if(this.$window){this.$snippetEditorArea.remove();this.$window.off('.snippets_menu');this.$document.off('.snippets_menu');this.$scrollingElement[0].removeEventListener('scroll',this._onScrollingElementScroll,{capture:true});}
core.bus.off('deactivate_snippet',this,this._onDeactivateSnippet);delete this.cacheSnippetTemplate[this.options.snippets];},cleanForSave:async function(){await this._activateSnippet(false);this.trigger_up('ready_to_clean_for_save');await this._destroyEditors();this.getEditableArea().find('[contentEditable]').removeAttr('contentEditable').removeProp('contentEditable');this.getEditableArea().find('.o_we_selected_image').removeClass('o_we_selected_image');},loadSnippets:function(invalidateCache){if(!invalidateCache&&this.cacheSnippetTemplate[this.options.snippets]){this._defLoadSnippets=this.cacheSnippetTemplate[this.options.snippets];return this._defLoadSnippets;}
this._defLoadSnippets=this._rpc({model:'ir.ui.view',method:'render_public_asset',args:[this.options.snippets,{}],kwargs:{context:this.options.context,},});this.cacheSnippetTemplate[this.options.snippets]=this._defLoadSnippets;return this._defLoadSnippets;},setSelectorEditableArea:function($editor,selectorEditableArea){this.selectorEditableArea=selectorEditableArea;this.$editor=$editor;this.$body=$editor.closest('body');},getEditableArea:function(){return this.$editor.find(this.selectorEditableArea).add(this.$editor.filter(this.selectorEditableArea));},updateCurrentSnippetEditorOverlay:function(){for(const snippetEditor of this.snippetEditors){if(snippetEditor.$target.closest('body').length){snippetEditor.cover();continue;}
this._mutex.exec(()=>snippetEditor.destroy());}},_activateInsertionZones:function($selectorSiblings,$selectorChildren){var self=this;const $openModal=self.getEditableArea().find('.modal:visible');if($openModal.length){$selectorSiblings=$openModal.find($selectorSiblings);$selectorChildren=$openModal.find($selectorChildren);}
function setDropZoneDirection($elem,$parent,$sibling){var vertical=false;var style={};$sibling=$sibling||$elem;var css=window.getComputedStyle($elem[0]);var parentCss=window.getComputedStyle($parent[0]);var float=css.float||css.cssFloat;var display=parentCss.display;var flex=parentCss.flexDirection;if(float==='left'||float==='right'||(display==='flex'&&flex==='row')){style['float']=float;if($sibling.parent().width()!==$sibling.outerWidth(true)){vertical=true;style['height']=Math.max($sibling.outerHeight(),30)+'px';}}
return{vertical:vertical,style:style,};}
function testPreviousSibling(node,$zone){if(!node||((node.tagName||!node.textContent.match(/\S/))&&node.tagName!=='BR')){return false;}
return{vertical:true,style:{'float':'none','display':'inline-block','height':parseInt(self.window.getComputedStyle($zone[0]).lineHeight)+'px',},};}
var $clone=$('.oe_drop_clone');if($clone.length){var $neighbor=$clone.prev();if(!$neighbor.length){$neighbor=$clone.next();}
var data;if($neighbor.length){data=setDropZoneDirection($neighbor,$neighbor.parent());}else{data={vertical:false,style:{},};}
self._insertDropzone($('<we-hook/>').insertAfter($clone),data.vertical,data.style);}
if($selectorChildren){$selectorChildren.each(function(){var data;var $zone=$(this);var $children=$zone.find('> :not(.oe_drop_zone, .oe_drop_clone)');if(!$zone.children().last().is('.oe_drop_zone')){data=testPreviousSibling($zone[0].lastChild,$zone)||setDropZoneDirection($zone,$zone,$children.last());self._insertDropzone($('<we-hook/>').appendTo($zone),data.vertical,data.style);}
if(!$zone.children().first().is('.oe_drop_clone')){data=testPreviousSibling($zone[0].firstChild,$zone)||setDropZoneDirection($zone,$zone,$children.first());self._insertDropzone($('<we-hook/>').prependTo($zone),data.vertical,data.style);}});$selectorSiblings=$(_.uniq(($selectorSiblings||$()).add($selectorChildren.children()).get()));}
var noDropZonesSelector='[data-invisible="1"], .o_we_no_overlay, :not(:visible)';if($selectorSiblings){$selectorSiblings.not(`.oe_drop_zone, .oe_drop_clone, ${noDropZonesSelector}`).each(function(){var data;var $zone=$(this);var $zoneToCheck=$zone;while($zoneToCheck.prev(noDropZonesSelector).length){$zoneToCheck=$zoneToCheck.prev();}
if(!$zoneToCheck.prev('.oe_drop_zone:visible, .oe_drop_clone').length){data=setDropZoneDirection($zone,$zone.parent());self._insertDropzone($('<we-hook/>').insertBefore($zone),data.vertical,data.style);}
$zoneToCheck=$zone;while($zoneToCheck.next(noDropZonesSelector).length){$zoneToCheck=$zoneToCheck.next();}
if(!$zoneToCheck.next('.oe_drop_zone:visible, .oe_drop_clone').length){data=setDropZoneDirection($zone,$zone.parent());self._insertDropzone($('<we-hook/>').insertAfter($zone),data.vertical,data.style);}});}
var count;var $zones;do{count=0;$zones=this.getEditableArea().find('.oe_drop_zone > .oe_drop_zone').remove();count+=$zones.length;$zones.remove();}while(count>0);$zones=this.getEditableArea().find('.oe_drop_zone:not(.oe_vertical)');$zones.each(function(){var zone=$(this);var prev=zone.prev();var next=zone.next();if(prev.is('.oe_drop_zone')||next.is('.oe_drop_zone')){zone.remove();return;}
var floatPrev=prev.css('float')||'none';var floatNext=next.css('float')||'none';var dispPrev=prev.css('display')||null;var dispNext=next.css('display')||null;if((floatPrev==='left'||floatPrev==='right')&&(floatNext==='left'||floatNext==='right')){zone.remove();}else if(dispPrev!==null&&dispNext!==null&&dispPrev.indexOf('inline')>=0&&dispNext.indexOf('inline')>=0){zone.remove();}});},_updateInvisibleDOM:function(){return this._execWithLoadingEffect(()=>{this.invisibleDOMMap=new Map();const $invisibleDOMPanelEl=$(this.invisibleDOMPanelEl);$invisibleDOMPanelEl.find('.o_we_invisible_entry').remove();const $invisibleSnippets=globalSelector.all().find('.o_snippet_invisible').addBack('.o_snippet_invisible');$invisibleDOMPanelEl.toggleClass('d-none',!$invisibleSnippets.length);const proms=_.map($invisibleSnippets,async el=>{const editor=await this._createSnippetEditor($(el));const $invisEntry=$('<div/>',{class:'o_we_invisible_entry d-flex align-items-center justify-content-between',text:editor.getName(),}).append($('<i/>',{class:`fa ${editor.isTargetVisible() ? 'fa-eye' : 'fa-eye-slash'} ml-2`}));$invisibleDOMPanelEl.append($invisEntry);this.invisibleDOMMap.set($invisEntry[0],el);});return Promise.all(proms);},false);},_activateSnippet:async function($snippet,previewMode,ifInactiveOptions){if(this._blockPreviewOverlays&&previewMode){return;}
if($snippet&&!$snippet.is(':visible')){return;}
const exec=previewMode?action=>this._mutex.exec(action):action=>this._execWithLoadingEffect(action,false);return exec(()=>{return new Promise(resolve=>{if($snippet&&$snippet.length){$snippet=globalSelector.closest($snippet);if($snippet.length){return this._createSnippetEditor($snippet).then(resolve);}}
resolve(null);}).then(editorToEnable=>{if(ifInactiveOptions&&this._enabledEditorHierarchy.includes(editorToEnable)){return editorToEnable;}
const editorToEnableHierarchy=[];let current=editorToEnable;while(current&&current.$target){editorToEnableHierarchy.push(current);current=current.getParent();}
for(let i=this.snippetEditors.length;i--;){const editor=this.snippetEditors[i];editor.toggleOverlay(false,previewMode);if(!previewMode&&!editorToEnableHierarchy.includes(editor)){editor.toggleOptions(false);}}
if(!editorToEnable){editorToEnable=this.snippetEditors.find(editor=>editor.isSticky());previewMode=false;}
if(editorToEnable){editorToEnable.toggleOverlay(true,previewMode);editorToEnable.toggleOptions(true);}
this._enabledEditorHierarchy=editorToEnableHierarchy;return editorToEnable;});});},_loadSnippetsTemplates:async function(invalidateCache){return this._execWithLoadingEffect(async()=>{await this._destroyEditors();const html=await this.loadSnippets(invalidateCache);await this._computeSnippetTemplates(html);},false);},_destroyEditors:async function($el){const proms=_.map(this.snippetEditors,async function(snippetEditor){if($el&&!$el.has(snippetEditor.$target).length){return;}
await snippetEditor.cleanForSave();snippetEditor.destroy();});await Promise.all(proms);this.snippetEditors.splice(0);},_callForEachChildSnippet:function($snippet,callback){var self=this;var defs=_.map($snippet.add(globalSelector.all($snippet)),function(el){var $snippet=$(el);return self._createSnippetEditor($snippet).then(function(editor){if(editor){return callback.call(self,editor,$snippet);}});});return Promise.all(defs);},_closeWidgets:function(){this.snippetEditors.forEach(editor=>editor.closeWidgets());},_computeSelectorFunctions:function(selector,exclude,target,noCheck,isChildren){var self=this;exclude+=`${exclude && ', '}.o_snippet_not_selectable`;let filterFunc=function(){return!$(this).is(exclude);};if(target){const oldFilter=filterFunc;filterFunc=function(){return oldFilter.apply(this)&&$(this).find(target).length!==0;};}
var functions={is:function($from){return $from.is(selector)&&$from.filter(filterFunc).length!==0;},};if(noCheck){functions.closest=function($from,parentNode){return $from.closest(selector,parentNode).filter(filterFunc);};functions.all=function($from){return($from?dom.cssFind($from,selector):$(selector)).filter(filterFunc);};}else{functions.closest=function($from,parentNode){var parents=self.getEditableArea().get();return $from.closest(selector,parentNode).filter(function(){var node=this;while(node.parentNode){if(parents.indexOf(node)!==-1){return true;}
node=node.parentNode;}
return false;}).filter(filterFunc);};functions.all=isChildren?function($from){return dom.cssFind($from||self.getEditableArea(),selector).filter(filterFunc);}:function($from){$from=$from||self.getEditableArea();return $from.filter(selector).add(dom.cssFind($from,selector)).filter(filterFunc);};}
return functions;},_computeSnippetTemplates:function(html){var self=this;var $html=$(html);var $scroll=$html.siblings('#o_scroll');const $headerNavFix=$html.find('[data-js="HeaderNavbar"][data-selector="#wrapwrap > header > nav"]');if($headerNavFix.length){$headerNavFix[0].dataset.selector='#wrapwrap > header nav.navbar';}
this.templateOptions=[];var selectors=[];var $styles=$html.find('[data-selector]');$styles.each(function(){var $style=$(this);var selector=$style.data('selector');var exclude=$style.data('exclude')||'';var target=$style.data('target');var noCheck=$style.data('no-check');var optionID=$style.data('js')||$style.data('option-name');var option={'option':optionID,'base_selector':selector,'base_exclude':exclude,'base_target':target,'selector':self._computeSelectorFunctions(selector,exclude,target,noCheck),'$el':$style,'drop-near':$style.data('drop-near')&&self._computeSelectorFunctions($style.data('drop-near'),'',false,noCheck,true),'drop-in':$style.data('drop-in')&&self._computeSelectorFunctions($style.data('drop-in'),'',false,noCheck),'data':_.extend({string:$style.attr('string')},$style.data()),};self.templateOptions.push(option);selectors.push(option.selector);});$styles.addClass('d-none');globalSelector.closest=function($from){var $temp;var $target;for(var i=0,len=selectors.length;i<len;i++){$temp=selectors[i].closest($from,$target&&$target[0]);if($temp.length){$target=$temp;}}
return $target||$();};globalSelector.all=function($from){var $target=$();for(var i=0,len=selectors.length;i<len;i++){$target=$target.add(selectors[i].all($from));}
return $target;};globalSelector.is=function($from){for(var i=0,len=selectors.length;i<len;i++){if(selectors[i].is($from)){return true;}}
return false;};this.$snippets=$scroll.find('.o_panel_body').children().addClass('oe_snippet').each((i,el)=>{const $snippet=$(el);const name=el.getAttribute('name');const $sbody=$snippet.children().addClass('oe_snippet_body');const isCustomSnippet=!!el.closest('#snippet_custom');let snippetClasses=$sbody.attr('class').match(/s_[^ ]+/g);if(snippetClasses&&snippetClasses.length){snippetClasses='.'+snippetClasses.join('.');}
const $els=$(snippetClasses).not('[data-name]').add($sbody);$els.attr('data-name',name).data('name',name);const $thumbnail=$(`
                    <div class="oe_snippet_thumbnail">
                        <div class="oe_snippet_thumbnail_img" style="background-image: url(${el.dataset.oeThumbnail});"/>
                        <span class="oe_snippet_thumbnail_title">${name}</span>
                    </div>
                `);$snippet.prepend($thumbnail);const moduleID=$snippet.data('moduleId');if(moduleID){el.classList.add('o_snippet_install');$thumbnail.append($('<button/>',{class:'btn btn-primary o_install_btn w-100',type:'button',text:_t("Install"),}));}
if(isCustomSnippet){const btnEl=document.createElement('we-button');btnEl.dataset.snippetId=$snippet.data('oeSnippetId');btnEl.classList.add('o_delete_btn','fa','fa-trash','btn','o_we_hover_danger');btnEl.title=_.str.sprintf(_t("Delete %s"),name);$snippet.append(btnEl);}}).not('[data-module-id]');if(!this.$snippets.length){this.$el.detach();}
this._registerDefaultTexts();$html.find('.o_not_editable').attr('contentEditable',false);this.$el.html($html);this.$el.append(this.customizePanel);this.$el.append(this.textEditorPanelEl);this.$el.append(this.invisibleDOMPanelEl);this._makeSnippetDraggable(this.$snippets);this._disableUndroppableSnippets();this.$el.addClass('o_loaded');$('body.editor_enable').addClass('editor_has_snippets');this.trigger_up('snippets_loaded',self.$el);},_createSnippetEditor:function($snippet){var self=this;var snippetEditor=$snippet.data('snippet-editor');if(snippetEditor){return snippetEditor.__isStarted;}
var def;var $parent=globalSelector.closest($snippet.parent());if($parent.length){def=this._createSnippetEditor($parent);}
return Promise.resolve(def).then(function(parentEditor){snippetEditor=$snippet.data('snippet-editor');if(snippetEditor){return snippetEditor.__isStarted;}
let editableArea=self.getEditableArea();snippetEditor=new SnippetEditor(parentEditor||self,$snippet,self.templateOptions,$snippet.closest('[data-oe-type="html"], .oe_structure').add(editableArea),self.options);self.snippetEditors.push(snippetEditor);return snippetEditor.appendTo(self.$snippetEditorArea);}).then(function(){return snippetEditor;});},_disableUndroppableSnippets:function(){var self=this;var cache={};this.$snippets.each(function(){var $snippet=$(this);var $snippetBody=$snippet.find('.oe_snippet_body');var check=false;_.each(self.templateOptions,function(option,k){if(check||!($snippetBody.is(option.base_selector)&&!$snippetBody.is(option.base_exclude))){return;}
cache[k]=cache[k]||{'drop-near':option['drop-near']?option['drop-near'].all().length:0,'drop-in':option['drop-in']?option['drop-in'].all().length:0};check=(cache[k]['drop-near']||cache[k]['drop-in']);});$snippet.toggleClass('o_disabled',!check);$snippet.attr('title',check?'':_t("No location to drop in"));const $icon=$snippet.find('.o_snippet_undroppable').remove();if(check){$icon.remove();}else if(!$icon.length){const imgEl=document.createElement('img');imgEl.classList.add('o_snippet_undroppable');imgEl.src='/web_editor/static/src/img/snippet_disabled.svg';$snippet.append(imgEl);}});},_filterSnippets(search){const searchInputEl=this.el.querySelector('.o_snippet_search_filter_input');const searchInputReset=this.el.querySelector('.o_snippet_search_filter_reset');if(search!==undefined){searchInputEl.value=search;}else{search=searchInputEl.value;}
search=search.toLowerCase();searchInputReset.classList.toggle('d-none',!search);const strMatches=str=>!search||str.toLowerCase().includes(search);for(const panelEl of this.el.querySelectorAll('.o_panel')){let hasVisibleSnippet=false;const panelTitle=panelEl.querySelector('.o_panel_header').textContent;const isPanelTitleMatch=strMatches(panelTitle);for(const snippetEl of panelEl.querySelectorAll('.oe_snippet')){const matches=(isPanelTitleMatch||strMatches(snippetEl.getAttribute('name'))||strMatches(snippetEl.dataset.oeKeywords||''));if(matches){hasVisibleSnippet=true;}
snippetEl.classList.toggle('d-none',!matches);}
panelEl.classList.toggle('d-none',!hasVisibleSnippet);}},_getScrollOptions(options={}){return Object.assign({},options,{scrollBoundaries:Object.assign({right:false,},options.scrollBoundaries),jQueryDraggableOptions:Object.assign({appendTo:this.$body,cursor:'move',greedy:true,scroll:false,},options.jQueryDraggableOptions),});},_insertDropzone:function($hook,vertical,style){var $dropzone=$('<div/>',{'class':'oe_drop_zone oe_insert'+(vertical?' oe_vertical':''),});if(style){$dropzone.css(style);}
$hook.replaceWith($dropzone);return $dropzone;},_makeSnippetDraggable:function($snippets){var self=this;var $toInsert,dropped,$snippet;let dragAndDropResolve;const $scrollingElement=$().getScrollingElement();const smoothScrollOptions=this._getScrollOptions({jQueryDraggableOptions:{handle:'.oe_snippet_thumbnail:not(.o_we_already_dragging)',helper:function(){const dragSnip=this.cloneNode(true);dragSnip.querySelectorAll('.o_delete_btn').forEach(el=>el.remove());return dragSnip;},start:function(){self.$el.find('.oe_snippet_thumbnail').addClass('o_we_already_dragging');dropped=false;$snippet=$(this);var $baseBody=$snippet.find('.oe_snippet_body');var $selectorSiblings=$();var $selectorChildren=$();var temp=self.templateOptions;for(var k in temp){if($baseBody.is(temp[k].base_selector)&&!$baseBody.is(temp[k].base_exclude)){if(temp[k]['drop-near']){$selectorSiblings=$selectorSiblings.add(temp[k]['drop-near'].all());}
if(temp[k]['drop-in']){$selectorChildren=$selectorChildren.add(temp[k]['drop-in'].all());}}}
$toInsert=$baseBody.clone();[...$toInsert.find('img[src^="/web_editor/shape/"]')].forEach(dynamicSvg=>{const colorCustomizedURL=new URL(dynamicSvg.getAttribute('src'),window.location.origin);colorCustomizedURL.searchParams.set('c1',getCSSVariableValue('o-color-1'));dynamicSvg.src=colorCustomizedURL.pathname+colorCustomizedURL.search;});if(!$selectorSiblings.length&&!$selectorChildren.length){console.warn($snippet.find('.oe_snippet_thumbnail_title').text()+" have not insert action: data-drop-near or data-drop-in");return;}
self._activateSnippet(false);self._activateInsertionZones($selectorSiblings,$selectorChildren);self.getEditableArea().find('.oe_drop_zone').droppable({over:function(){if(!dropped){dropped=true;$(this).first().after($toInsert).addClass('invisible');$toInsert.removeClass('oe_snippet_body');}},out:function(){var prev=$toInsert.prev();if(this===prev[0]){dropped=false;$toInsert.detach();$(this).removeClass('invisible');$toInsert.addClass('oe_snippet_body');}},});const $openModal=self.getEditableArea().find('.modal:visible');self.draggableComponent.$scrollTarget=$openModal.length?$openModal:$scrollingElement;self.draggableComponent.$scrollTarget.on('scroll.scrolling_element',function(){self.$el.trigger('scroll');});const prom=new Promise(resolve=>dragAndDropResolve=()=>resolve());self._mutex.exec(()=>prom);},stop:async function(ev,ui){$toInsert.removeClass('oe_snippet_body');self.draggableComponent.$scrollTarget.off('scroll.scrolling_element');if(!dropped&&ui.position.top>3&&ui.position.left+ui.helper.outerHeight()<self.el.getBoundingClientRect().left){var $el=$.nearest({x:ui.position.left,y:ui.position.top},'.oe_drop_zone',{container:document.body}).first();if($el.length){$el.after($toInsert);dropped=true;}}
self.getEditableArea().find('.oe_drop_zone').droppable('destroy').remove();if(dropped){var prev=$toInsert.first()[0].previousSibling;var next=$toInsert.last()[0].nextSibling;if(prev){$toInsert.detach();self.trigger_up('request_history_undo_record',{$target:$(prev)});$toInsert.insertAfter(prev);}else if(next){$toInsert.detach();self.trigger_up('request_history_undo_record',{$target:$(next)});$toInsert.insertBefore(next);}else{var $parent=$toInsert.parent();$toInsert.detach();self.trigger_up('request_history_undo_record',{$target:$parent});$parent.prepend($toInsert);}
var $target=$toInsert;await self._scrollToSnippet($target);_.defer(async function(){self.trigger_up('snippet_dropped',{$target:$target});self._disableUndroppableSnippets();dragAndDropResolve();await self._callForEachChildSnippet($target,function(editor,$snippet){return editor.buildSnippet();});$target.trigger('content_changed');await self._updateInvisibleDOM();self.$el.find('.oe_snippet_thumbnail').removeClass('o_we_already_dragging');});}else{$toInsert.remove();dragAndDropResolve();self.$el.find('.oe_snippet_thumbnail').removeClass('o_we_already_dragging');}},},});this.draggableComponent=new SmoothScrollOnDrag(this,$snippets,$scrollingElement,smoothScrollOptions);},_registerDefaultTexts:function($in){if($in===undefined){$in=this.$snippets.find('.oe_snippet_body');}
$in.find('*').addBack().contents().filter(function(){return this.nodeType===3&&this.textContent.match(/\S/);}).parent().addClass('o_default_snippet_text');},_updateLeftPanelContent:function({content,tab}){clearTimeout(this._textToolsSwitchingTimeout);this._closeWidgets();tab=tab||this.tabs.BLOCKS;if(content){while(this.customizePanel.firstChild){this.customizePanel.removeChild(this.customizePanel.firstChild);}
$(this.customizePanel).append(content);}
this.$('.o_snippet_search_filter').toggleClass('d-none',tab!==this.tabs.BLOCKS);this.$('#o_scroll').toggleClass('d-none',tab!==this.tabs.BLOCKS);this.customizePanel.classList.toggle('d-none',tab===this.tabs.BLOCKS);this.textEditorPanelEl.classList.toggle('d-none',tab!==this.tabs.OPTIONS);this.$('.o_we_add_snippet_btn').toggleClass('active',tab===this.tabs.BLOCKS);this.$('.o_we_customize_snippet_btn').toggleClass('active',tab===this.tabs.OPTIONS).prop('disabled',tab!==this.tabs.OPTIONS);},async _scrollToSnippet($el){return dom.scrollTo($el[0],{extraOffset:50});},_createLoadingElement(){const loaderContainer=document.createElement('div');const loader=document.createElement('i');const loaderContainerClassList=['o_we_ui_loading','d-flex','justify-content-center','align-items-center',];const loaderClassList=['fa','fa-circle-o-notch','fa-spin','fa-4x',];loaderContainer.classList.add(...loaderContainerClassList);loader.classList.add(...loaderClassList);loaderContainer.appendChild(loader);return loaderContainer;},async _execWithLoadingEffect(action,contentLoading=true,delay=500){const mutexExecResult=this._mutex.exec(action);if(!this.loadingTimers[contentLoading]){this.loadingTimers[contentLoading]=setTimeout(()=>{this.loadingElements[contentLoading]=this._createLoadingElement();if(contentLoading){this.$snippetEditorArea.append(this.loadingElements[contentLoading]);}else{this.el.appendChild(this.loadingElements[contentLoading]);}},delay);this._mutex.getUnlockedDef().then(()=>{clearTimeout(this.loadingTimers[contentLoading]);this.loadingTimers[contentLoading]=undefined;if(this.loadingElements[contentLoading]){this.loadingElements[contentLoading].remove();this.loadingElements[contentLoading]=null;}});}
return mutexExecResult;},_onActivateInsertionZones:function(ev){this._activateInsertionZones(ev.data.$selectorSiblings,ev.data.$selectorChildren);},_onActivateSnippet:function(ev){this._activateSnippet(ev.data.$snippet,ev.data.previewMode,ev.data.ifInactiveOptions);},_onCallForEachChildSnippet:function(ev){this._callForEachChildSnippet(ev.data.$snippet,ev.data.callback);},_onOverlaysCoverUpdate:function(){this.snippetEditors.forEach(editor=>{editor.cover();});},_onCloneSnippet:async function(ev){ev.stopPropagation();const editor=await this._createSnippetEditor(ev.data.$snippet);await editor.clone();if(ev.data.onSuccess){ev.data.onSuccess();}},_onDeactivateSnippet:function(){this._activateSnippet(false);},_onDragAndDropStop:async function(ev){const $modal=ev.data.$snippet.closest('.modal');await this._destroyEditors($modal.length?$modal:null);await this._activateSnippet(ev.data.$snippet);},_onGoToParent:function(ev){ev.stopPropagation();this._activateSnippet(ev.data.$snippet.parent());},_onHideOverlay:function(){for(const editor of this.snippetEditors){editor.toggleOverlay(false);}},_onInstallBtnClick:function(ev){var self=this;var $snippet=$(ev.currentTarget).closest('[data-module-id]');var moduleID=$snippet.data('moduleId');var name=$snippet.attr('name');new Dialog(this,{title:_.str.sprintf(_t("Install %s"),name),size:'medium',$content:$('<div/>',{text:_.str.sprintf(_t("Do you want to install the %s App?"),name)}).append($('<a/>',{target:'_blank',href:'/web#id='+moduleID+'&view_type=form&model=ir.module.module&action=base.open_module_tree',text:_t("More info about this app."),class:'ml4',})),buttons:[{text:_t("Save and Install"),classes:'btn-primary',click:function(){this.$footer.find('.btn').toggleClass('o_hidden');this._rpc({model:'ir.module.module',method:'button_immediate_install',args:[[moduleID]],}).then(()=>{self.trigger_up('request_save',{reloadEditor:true,_toMutex:true,});}).guardedCatch(reason=>{reason.event.preventDefault();this.close();self.displayNotification({message:_.str.sprintf(_t("Could not install module <strong>%s</strong>"),name),type:'danger',sticky:true,});});},},{text:_t("Install in progress"),icon:'fa-spin fa-spinner fa-pulse mr8',classes:'btn-primary disabled o_hidden',},{text:_t("Cancel"),close:true,}],}).open();},_onInvisibleEntryClick:async function(ev){ev.preventDefault();const $snippet=$(this.invisibleDOMMap.get(ev.currentTarget));const isVisible=await this._execWithLoadingEffect(async()=>{const editor=await this._createSnippetEditor($snippet);return editor.toggleTargetVisibility();},true);$(ev.currentTarget).find('.fa').toggleClass('fa-eye',isVisible).toggleClass('fa-eye-slash',!isVisible);return this._activateSnippet(isVisible?$snippet:false);},_onBlocksTabClick:function(ev){this._activateSnippet(false).then(()=>{this._updateLeftPanelContent({content:[],tab:this.tabs.BLOCKS,});});},_onDeleteBtnClick:function(ev){const $snippet=$(ev.target).closest('.oe_snippet');const snippetId=parseInt(ev.currentTarget.dataset.snippetId);ev.stopPropagation();new Dialog(this,{size:'medium',title:_t('Confirmation'),$content:$('<div><p>'+_t(`Are you sure you want to delete the snippet: ${$snippet.attr('name')} ?`)+'</p></div>'),buttons:[{text:_t("Yes"),close:true,classes:'btn-primary',click:async()=>{await this._rpc({model:'ir.ui.view',method:'delete_snippet',kwargs:{'view_id':snippetId,'template_key':this.options.snippets,},});await this._loadSnippetsTemplates(true);},},{text:_t("No"),close:true,}],}).open();},_onMouseDown:function(){const $blockedArea=$('#wrapwrap');$blockedArea.addClass('o_we_no_pointer_events');const reenable=()=>$blockedArea.removeClass('o_we_no_pointer_events');const enableTimeoutID=setTimeout(()=>reenable(),5000);$(document).one('mouseup',()=>{clearTimeout(enableTimeoutID);reenable();});},_onGetSnippetVersions:function(ev){const snippet=this.el.querySelector(`.oe_snippet > [data-snippet="${ev.data.snippetName}"]`);ev.data.onSuccess(snippet&&{vcss:snippet.dataset.vcss,vjs:snippet.dataset.vjs,vxml:snippet.dataset.vxml,});},_onReloadSnippetTemplate:async function(ev){await this._activateSnippet(false);await this._loadSnippetsTemplates(true);},_onBlockPreviewOverlays:function(ev){this._blockPreviewOverlays=true;},_onUnblockPreviewOverlays:function(ev){this._blockPreviewOverlays=false;},_onRemoveSnippet:async function(ev){ev.stopPropagation();const editor=await this._createSnippetEditor(ev.data.$snippet);await editor.removeSnippet();if(ev.data.onSuccess){ev.data.onSuccess();}},_onSaveRequest:function(ev){const data=ev.data;if(ev.target===this&&!data._toMutex){return;}
delete data._toMutex;ev.stopPropagation();this._execWithLoadingEffect(()=>{if(data.reloadEditor){data.reload=false;const oldOnSuccess=data.onSuccess;data.onSuccess=async function(){if(oldOnSuccess){await oldOnSuccess.call(this,...arguments);}
window.location.href=window.location.origin+window.location.pathname+'?enable_editor=1';};}
this.trigger_up('request_save',data);},true);},_onSnippetClick(){const $els=this.getEditableArea().find('.oe_structure.oe_empty').addBack('.oe_structure.oe_empty');for(const el of $els){if(!el.children.length){$(el).odooBounce('o_we_snippet_area_animation');}}},_onSnippetEditionRequest:function(ev){this._execWithLoadingEffect(ev.data.exec,true);},_onSnippetEditorDestroyed(ev){ev.stopPropagation();const index=this.snippetEditors.indexOf(ev.target);this.snippetEditors.splice(index,1);},_onSnippetCloned:function(ev){this._updateInvisibleDOM();},_onSnippetRemoved:function(){this._disableUndroppableSnippets();this._updateInvisibleDOM();},_onSnippetOptionVisibilityUpdate:async function(ev){if(!ev.data.show){await this._activateSnippet(false);}
await this._updateInvisibleDOM();},_onSnippetThumbnailURLRequest(ev){const $snippet=this.$snippets.has(`[data-snippet="${ev.data.key}"]`);ev.data.onSuccess($snippet.length?$snippet[0].dataset.oeThumbnail:'');},_onSummernoteToolsUpdate(ev){if(!this._textToolsSwitchingEnabled){return;}
const range=$.summernote.core.range.create();if(!range){return;}
if(range.sc===range.ec&&range.sc.nodeType===Node.ELEMENT_NODE&&range.sc.classList.contains('oe_structure')&&range.sc.children.length===0){return;}
this.textEditorPanelEl.classList.add('d-block');const hasVisibleButtons=!!$(this.textEditorPanelEl).find('.btn:visible').length;this.textEditorPanelEl.classList.remove('d-block');if(!hasVisibleButtons){return;}
clearTimeout(this._textToolsSwitchingTimeout);this._textToolsSwitchingTimeout=setTimeout(()=>{this._updateLeftPanelContent({tab:this.tabs.OPTIONS});},250);},_onUpdateCustomizeElements:function(ev){this._updateLeftPanelContent({content:ev.data.customize$Elements,tab:ev.data.customize$Elements.length?this.tabs.OPTIONS:this.tabs.BLOCKS,});},_onUserValueWidgetOpening:function(){this._closeWidgets();this.el.classList.add('o_we_backdrop');},_onUserValueWidgetClosing:function(){this.el.classList.remove('o_we_backdrop');},_onSnippetSearchInput:function(){this._filterSnippets();},_onSnippetSearchResetClick:function(){this._filterSnippets('');},});return{Class:SnippetsMenu,Editor:SnippetEditor,globalSelector:globalSelector,};});;

/* /web_editor/static/src/js/editor/snippets.options.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.snippets.options',function(require){'use strict';var core=require('web.core');const{ColorpickerWidget}=require('web.Colorpicker');const Dialog=require('web.Dialog');const rpc=require('web.rpc');const time=require('web.time');var Widget=require('web.Widget');var ColorPaletteWidget=require('web_editor.ColorPalette').ColorPaletteWidget;const weUtils=require('web_editor.utils');const{normalizeColor,getBgImageURL,}=weUtils;var weWidgets=require('wysiwyg.widgets');const{loadImage,loadImageInfo,applyModifications,removeOnImageChangeAttrs,}=require('web_editor.image_processing');var qweb=core.qweb;var _t=core._t;function _addTitleAndAllowedAttributes(el,title,options){let tooltipEl=el;if(title){const titleEl=_buildTitleElement(title);tooltipEl=titleEl;el.appendChild(titleEl);}
if(options&&options.classes){el.classList.add(...options.classes);}
if(options&&options.tooltip){tooltipEl.title=options.tooltip;}
if(options&&options.placeholder){el.setAttribute('placeholder',options.placeholder);}
if(options&&options.dataAttributes){for(const key in options.dataAttributes){el.dataset[key]=options.dataAttributes[key];}}
return el;}
function _buildElement(tagName,title,options){const el=document.createElement(tagName);return _addTitleAndAllowedAttributes(el,title,options);}
function _buildTitleElement(title){const titleEl=document.createElement('we-title');titleEl.textContent=title;return titleEl;}
const _buildImgElementCache={};async function _buildImgElement(src){if(!(src in _buildImgElementCache)){_buildImgElementCache[src]=(async()=>{if(src.split('.').pop()==='svg'){const response=await window.fetch(src);const text=await response.text();const parser=new window.DOMParser();const xmlDoc=parser.parseFromString(text,'text/xml');return xmlDoc.getElementsByTagName('svg')[0];}else{const imgEl=document.createElement('img');imgEl.src=src;return imgEl;}})();}
const node=await _buildImgElementCache[src];return node.cloneNode(true);}
function _buildRowElement(title,options){const groupEl=_buildElement('we-row',title,options);const rowEl=document.createElement('div');groupEl.appendChild(rowEl);if(options&&options.childNodes){options.childNodes.forEach(node=>rowEl.appendChild(node));}
return groupEl;}
function _buildCollapseElement(title,options){const groupEl=_buildElement('we-collapse',title,options);const titleEl=groupEl.querySelector('we-title');const children=options&&options.childNodes||[];if(titleEl){titleEl.remove();children.unshift(titleEl);}
let i=0;for(i=0;i<children.length;i++){groupEl.appendChild(children[i]);if(children[i].nodeType===Node.ELEMENT_NODE){break;}}
const togglerEl=document.createElement('we-toggler');togglerEl.classList.add('o_we_collapse_toggler');groupEl.appendChild(togglerEl);const containerEl=document.createElement('div');children.slice(i+1).forEach(node=>containerEl.appendChild(node));groupEl.appendChild(containerEl);return groupEl;}
function createPropertyProxy(obj,propertyName,value){return new Proxy(obj,{get:function(obj,prop){if(prop===propertyName){return value;}
return obj[prop];},set:function(obj,prop,val){if(prop===propertyName){return(value=val);}
return Reflect.set(...arguments);},});}
const NULL_ID='__NULL__';const UserValueWidget=Widget.extend({className:'o_we_user_value_widget',custom_events:{'user_value_update':'_onUserValueNotification',},init:function(parent,title,options,$target){this._super(...arguments);this.title=title;this.options=options;this._userValueWidgets=[];this._value='';this.$target=$target;},async willStart(){await this._super(...arguments);if(this.options.dataAttributes.img){this.imgEl=await _buildImgElement(this.options.dataAttributes.img);}},_makeDescriptive:function(){const $el=this._super(...arguments);const el=$el[0];_addTitleAndAllowedAttributes(el,this.title,this.options);this.containerEl=document.createElement('div');if(this.imgEl){this.containerEl.appendChild(this.imgEl);}
el.appendChild(this.containerEl);return $el;},async start(){await this._super(...arguments);if(this.el.classList.contains('o_we_img_animate')){const buildImgExtensionSwitcher=(from,to)=>{const regex=new RegExp(`${from}$`,'i');return ev=>{const img=ev.currentTarget.getElementsByTagName("img")[0];img.src=img.src.replace(regex,to);};};this.$el.on('mouseenter.img_animate',buildImgExtensionSwitcher('png','gif'));this.$el.on('mouseleave.img_animate',buildImgExtensionSwitcher('gif','png'));}},destroy(){if(this.$el){this.$el.off('.img_animate');}
this._super(...arguments);},close:function(){if(!this.el){return;}
this.trigger_up('user_value_widget_closing');this.el.classList.remove('o_we_widget_opened');this._userValueWidgets.forEach(widget=>widget.close());},enable(){this.$el.click();},findWidget:function(name){for(const widget of this._userValueWidgets){if(widget.getName()===name){return widget;}
const depWidget=widget.findWidget(name);if(depWidget){return depWidget;}}
return null;},getActiveValue:function(methodName){return this._value;},getDefaultValue:function(methodName){const possibleValues=this._methodsParams.optionsPossibleValues[methodName];return possibleValues&&possibleValues[0]||'';},getDependencies:function(){return this._dependencies;},getMethodsNames:function(){return this._methodsNames;},getMethodsParams:function(methodName){const params=_.extend({},this._methodsParams);if(methodName){params.possibleValues=params.optionsPossibleValues[methodName]||[];params.activeValue=this.getActiveValue(methodName);params.defaultValue=this.getDefaultValue(methodName);}
return params;},getName:function(){return this._methodsParams.name||'';},getValue:function(methodName){const isActive=this.isActive();if(!methodName||!this._methodsNames.includes(methodName)){return isActive?'true':'';}
if(isActive){return this.getActiveValue(methodName);}
return this.getDefaultValue(methodName);},isActive:function(){return this._value&&this._value!==NULL_ID;},isContainer:function(){return false;},isPreviewed:function(){const focusEl=document.activeElement;if(focusEl&&focusEl.tagName==='INPUT'&&(this.el===focusEl||this.el.contains(focusEl))){return true;}
return this.el.classList.contains('o_we_preview');},loadMethodsData:function(validMethodNames,extraParams){this._methodsNames=[];this._methodsParams=_.extend({},extraParams);this._methodsParams.optionsPossibleValues={};this._dependencies=[];this._triggerWidgetsNames=[];this._triggerWidgetsValues=[];for(const key in this.el.dataset){const dataValue=this.el.dataset[key].trim();if(key==='dependencies'){this._dependencies.push(...dataValue.split(/\s*,\s*/g));}else if(key==='trigger'){this._triggerWidgetsNames.push(...dataValue.split(/\s*,\s*/g));}else if(key==='triggerValue'){this._triggerWidgetsValues.push(...dataValue.split(/\s*,\s*/g));}else if(validMethodNames.includes(key)){this._methodsNames.push(key);this._methodsParams.optionsPossibleValues[key]=dataValue.split(/\s*\|\s*/g);}else{this._methodsParams[key]=dataValue;}}
this._userValueWidgets.forEach(widget=>{const inheritedParams=_.extend({},this._methodsParams);inheritedParams.optionsPossibleValues=null;widget.loadMethodsData(validMethodNames,inheritedParams);const subMethodsNames=widget.getMethodsNames();const subMethodsParams=widget.getMethodsParams();for(const methodName of subMethodsNames){if(!this._methodsNames.includes(methodName)){this._methodsNames.push(methodName);this._methodsParams.optionsPossibleValues[methodName]=[];}
for(const subPossibleValue of subMethodsParams.optionsPossibleValues[methodName]){this._methodsParams.optionsPossibleValues[methodName].push(subPossibleValue);}}});for(const methodName of this._methodsNames){const arr=this._methodsParams.optionsPossibleValues[methodName];const uniqArr=arr.filter((v,i,arr)=>i===arr.indexOf(v));this._methodsParams.optionsPossibleValues[methodName]=uniqArr;}},notifyValueChange:function(previewMode,isSimulatedEvent){if(!this._methodsNames.length){return;}
const isPreviewed=this.isPreviewed();if(!previewMode&&!isPreviewed){this.notifyValueChange(true);}
const data={previewMode:previewMode||false,isSimulatedEvent:!!isSimulatedEvent,};if(previewMode===true||previewMode===false){data.prepare=()=>this.el.classList.add('o_we_preview');}else if(previewMode==='reset'){data.prepare=()=>this.el.classList.remove('o_we_preview');}
this.trigger_up('user_value_update',data);},open(){this.trigger_up('user_value_widget_opening');this.el.classList.add('o_we_widget_opened');},registerSubWidget:function(widget){this._userValueWidgets.push(widget);},async setValue(value,methodName){this._value=value;this.el.classList.remove('o_we_preview');},toggleVisibility:function(show){this.el.classList.toggle('d-none',!show);},_handleNotifierEvent:function(ev){if(!ev){return true;}
if(ev._seen){return false;}
ev._seen=true;if(ev.preventDefault){ev.preventDefault();}
return true;},_onUserValueChange:function(ev){if(this._handleNotifierEvent(ev)){this.notifyValueChange(false);}},_onUserValueNotification:function(ev){ev.data.widget=this;if(!ev.data.triggerWidgetsNames){ev.data.triggerWidgetsNames=[];}
ev.data.triggerWidgetsNames.push(...this._triggerWidgetsNames);if(!ev.data.triggerWidgetsValues){ev.data.triggerWidgetsValues=[];}
ev.data.triggerWidgetsValues.push(...this._triggerWidgetsValues);},_onUserValuePreview:function(ev){if(this._handleNotifierEvent(ev)){this.notifyValueChange(true);}},_onUserValueReset:function(ev){if(this._handleNotifierEvent(ev)){this.notifyValueChange('reset');}},});const ButtonUserValueWidget=UserValueWidget.extend({tagName:'we-button',events:{'click':'_onButtonClick','click [role="button"]':'_onInnerButtonClick','mouseenter':'_onUserValuePreview','mouseleave':'_onUserValueReset',},start:function(parent,title,options){if(this.options&&this.options.childNodes){this.options.childNodes.forEach(node=>this.containerEl.appendChild(node));}
return this._super(...arguments);},getActiveValue:function(methodName){const possibleValues=this._methodsParams.optionsPossibleValues[methodName];return possibleValues&&possibleValues[possibleValues.length-1]||'';},isActive:function(){return(this.isPreviewed()!==this.el.classList.contains('active'));},loadMethodsData:function(validMethodNames){this._super.apply(this,arguments);for(const methodName of this._methodsNames){const possibleValues=this._methodsParams.optionsPossibleValues[methodName];if(possibleValues.length<=1){possibleValues.unshift('');}}},async setValue(value,methodName){await this._super(...arguments);let active=!!value;if(methodName){if(!this._methodsNames.includes(methodName)){return;}
active=(this.getActiveValue(methodName)===value);}
this.el.classList.toggle('active',active);},_onButtonClick:function(ev){if(!ev._innerButtonClicked){this._onUserValueChange(ev);}},_onInnerButtonClick:function(ev){ev._innerButtonClicked=true;},});const CheckboxUserValueWidget=ButtonUserValueWidget.extend({className:(ButtonUserValueWidget.prototype.className||'')+' o_we_checkbox_wrapper',start:function(){const checkboxEl=document.createElement('we-checkbox');this.containerEl.appendChild(checkboxEl);return this._super(...arguments);},enable(){this.$('we-checkbox').click();},_onButtonClick(ev){if(!ev.target.closest('we-title, we-checkbox')){return;}
return this._super(...arguments);},});const BaseSelectionUserValueWidget=UserValueWidget.extend({async start(){await this._super(...arguments);this.menuEl=document.createElement('we-selection-items');if(this.options&&this.options.childNodes){this.options.childNodes.forEach(node=>this.menuEl.appendChild(node));}
this.containerEl.appendChild(this.menuEl);},getMethodsParams(methodName){const params=this._super(...arguments);const activeWidget=this._getActiveSubWidget();if(!activeWidget){return params;}
return Object.assign(activeWidget.getMethodsParams(...arguments),params);},getValue(methodName){const activeWidget=this._getActiveSubWidget();if(activeWidget){return activeWidget.getActiveValue(methodName);}
return this._super(...arguments);},isContainer(){return true;},async setValue(value,methodName){const _super=this._super.bind(this);for(const widget of this._userValueWidgets){await widget.setValue(NULL_ID,methodName);}
for(const widget of[...this._userValueWidgets].reverse()){await widget.setValue(value,methodName);if(widget.isActive()){return;}}
await _super(...arguments);},_getActiveSubWidget(){const previewedWidget=this._userValueWidgets.find(widget=>widget.isPreviewed());if(previewedWidget){return previewedWidget;}
return this._userValueWidgets.find(widget=>widget.isActive());},});const SelectUserValueWidget=BaseSelectionUserValueWidget.extend({tagName:'we-select',events:{'click':'_onClick',},async start(){await this._super(...arguments);if(this.options&&this.options.valueEl){this.containerEl.insertBefore(this.options.valueEl,this.menuEl);}
this.menuTogglerEl=document.createElement('we-toggler');this.icon=this.el.dataset.icon||false;if(this.icon){this.el.classList.add('o_we_icon_select');const iconEl=document.createElement('i');iconEl.classList.add('fa','fa-fw',this.icon);this.menuTogglerEl.appendChild(iconEl);}
this.containerEl.insertBefore(this.menuTogglerEl,this.menuEl);const dropdownCaretEl=document.createElement('span');dropdownCaretEl.classList.add('o_we_dropdown_caret');this.containerEl.appendChild(dropdownCaretEl);},close:function(){this._super(...arguments);if(this.menuTogglerEl){this.menuTogglerEl.classList.remove('active');}},isPreviewed:function(){return this._super(...arguments)||this.menuTogglerEl.classList.contains('active');},open(){this._super(...arguments);this.menuTogglerEl.classList.add('active');},async setValue(){await this._super(...arguments);if(this.icon){return;}
if(this.menuTogglerItemEl){this.menuTogglerItemEl.remove();this.menuTogglerItemEl=null;}
let textContent='';const activeWidget=this._userValueWidgets.find(widget=>!widget.isPreviewed()&&widget.isActive());if(activeWidget){const svgTag=activeWidget.el.querySelector('svg');const value=(activeWidget.el.dataset.selectLabel||(!svgTag&&activeWidget.el.textContent.trim()));const imgSrc=activeWidget.el.dataset.img;if(value){textContent=value;}else if(imgSrc){this.menuTogglerItemEl=document.createElement('img');this.menuTogglerItemEl.src=imgSrc;}else{const fakeImgEl=activeWidget.el.querySelector('.o_we_fake_img_item');if(fakeImgEl){this.menuTogglerItemEl=fakeImgEl.cloneNode(true);}}}else{textContent="/";}
this.menuTogglerEl.textContent=textContent;if(this.menuTogglerItemEl){this.menuTogglerEl.appendChild(this.menuTogglerItemEl);}},_onClick:function(ev){if(ev.target.closest('[role="button"]')){return;}
if(!this.menuTogglerEl.classList.contains('active')){this.open();}else{this.close();}
const activeButton=this._userValueWidgets.find(widget=>widget.isActive());if(activeButton){this.menuEl.scrollTop=activeButton.el.offsetTop-(this.menuEl.offsetHeight/2);}},});const ButtonGroupUserValueWidget=BaseSelectionUserValueWidget.extend({tagName:'we-button-group',});const UnitUserValueWidget=UserValueWidget.extend({start:async function(){const unit=this.el.dataset.unit||'';this.el.dataset.unit=unit;if(this.el.dataset.saveUnit===undefined){this.el.dataset.saveUnit=unit;}
return this._super(...arguments);},getActiveValue:function(methodName){const activeValue=this._super(...arguments);const params=this._methodsParams;if(!params.unit){return activeValue;}
const defaultValue=this.getDefaultValue(methodName,false);return activeValue.split(/\s+/g).map(v=>{const numValue=parseFloat(v);if(isNaN(numValue)){return defaultValue;}else{const value=weUtils.convertNumericToUnit(numValue,params.unit,params.saveUnit,params.cssProperty,this.$target);return`${this._floatToStr(value)}${params.saveUnit}`;}}).join(' ');},getDefaultValue:function(methodName,useInputUnit){const defaultValue=this._super(...arguments);const params=this._methodsParams;if(!params.unit){return defaultValue;}
const unit=useInputUnit?params.unit:params.saveUnit;const numValue=weUtils.convertValueToUnit(defaultValue||'0',unit,params.cssProperty,this.$target);if(isNaN(numValue)){return defaultValue;}
return`${this._floatToStr(numValue)}${unit}`;},isActive:function(){const isSuperActive=this._super(...arguments);const params=this._methodsParams;if(!params.unit){return isSuperActive;}
return isSuperActive&&this._floatToStr(parseFloat(this._value))!=='0';},async setValue(value,methodName){const params=this._methodsParams;if(params.unit){value=value.split(' ').map(v=>{const numValue=weUtils.convertValueToUnit(v,params.unit,params.cssProperty,this.$target);if(isNaN(numValue)){return'';}
return this._floatToStr(numValue);}).join(' ');}
return this._super(value,methodName);},_floatToStr:function(value){return`${parseFloat(value.toFixed(5))}`;},});const InputUserValueWidget=UnitUserValueWidget.extend({tagName:'we-input',events:{'input input':'_onInputInput','blur input':'_onInputBlur','keydown input':'_onInputKeydown',},start:async function(){await this._super(...arguments);const unit=this.el.dataset.unit;this.inputEl=document.createElement('input');this.inputEl.setAttribute('type','text');this.inputEl.setAttribute('autocomplete','chrome-off');this.inputEl.setAttribute('placeholder',this.el.getAttribute('placeholder')||'');this.inputEl.classList.toggle('text-left',!unit);this.inputEl.classList.toggle('text-right',!!unit);this.containerEl.appendChild(this.inputEl);var unitEl=document.createElement('span');unitEl.textContent=unit;this.containerEl.appendChild(unitEl);if(unit.length>3){this.el.classList.add('o_we_large_input');}},async setValue(){await this._super(...arguments);this.inputEl.value=this._value;},_onInputInput:function(ev){this._value=this.inputEl.value;this._onUserValuePreview(ev);},_onInputBlur:function(ev){setTimeout(()=>{if(ev.currentTarget===document.activeElement){return;}
this._onUserValueChange(ev);});},_onInputKeydown:function(ev){switch(ev.which){case $.ui.keyCode.ENTER:{this._onUserValueChange(ev);break;}
case $.ui.keyCode.UP:case $.ui.keyCode.DOWN:{const input=ev.currentTarget;const params=this._methodsParams;if(!params.unit&&!params.step){break;}
let value=parseFloat(input.value||input.placeholder);if(isNaN(value)){value=0.0;}
let step=parseFloat(params.step);if(isNaN(step)){step=1.0;}
value+=(ev.which===$.ui.keyCode.UP?step:-step);input.value=this._floatToStr(value);$(input).trigger('input');break;}}},});const MultiUserValueWidget=UserValueWidget.extend({tagName:'we-multi',start:function(){if(this.options&&this.options.childNodes){this.options.childNodes.forEach(node=>this.containerEl.appendChild(node));}
return this._super(...arguments);},getValue:function(methodName){const value=this._userValueWidgets.map(widget=>{return widget.getValue(methodName);}).join(' ').trim();return value||this._super(...arguments);},isContainer:function(){return true;},async setValue(value,methodName){let values=value.split(/\s*\|\s*/g);if(values.length===1){values=value.split(/\s+/g);}
for(let i=0;i<this._userValueWidgets.length-1;i++){await this._userValueWidgets[i].setValue(values.shift()||'',methodName);}
await this._userValueWidgets[this._userValueWidgets.length-1].setValue(values.join(' '),methodName);},});const ColorpickerUserValueWidget=SelectUserValueWidget.extend({className:(SelectUserValueWidget.prototype.className||'')+' o_we_so_color_palette',custom_events:_.extend({},SelectUserValueWidget.prototype.custom_events,{'custom_color_picked':'_onCustomColorPicked','color_picked':'_onColorPicked','color_hover':'_onColorHovered','color_leave':'_onColorLeft','enter_key_color_colorpicker':'_onEnterKey'}),start:async function(){const _super=this._super.bind(this);const args=arguments;await this._renderColorPalette();this.colorPreviewEl=document.createElement('span');this.colorPreviewEl.classList.add('o_we_color_preview');this.options.childNodes=[this.colorPalette.el];this.options.valueEl=this.colorPreviewEl;return _super(...args);},close:function(){this._super(...arguments);if(this._customColorValue&&this._customColorValue!==this._value){this._value=this._customColorValue;this._customColorValue=false;this._onUserValueChange();}},getMethodsParams:function(){return _.extend(this._super(...arguments),{colorNames:this.colorPalette.getColorNames(),});},getValue:function(methodName){if(typeof this._previewColor==='string'){return this._previewColor;}
if(typeof this._customColorValue==='string'){return this._customColorValue;}
let value=this._super(...arguments);if(value){const useCssColor=this.options.dataAttributes.hasOwnProperty('useCssColor');const cssCompatible=this.options.dataAttributes.hasOwnProperty('cssCompatible');if((useCssColor||cssCompatible)&&!ColorpickerWidget.isCSSColor(value)){if(useCssColor){value=weUtils.getCSSVariableValue(value);}else{value=`var(--${value})`;}}}
return value;},isContainer:function(){return false;},isActive:function(){return!weUtils.areCssValuesEqual(this._value,'rgba(0, 0, 0, 0)');},async setValue(color){await this._super(...arguments);await this._renderColorPalette();const classes=weUtils.computeColorClasses(this.colorPalette.getColorNames());this.colorPreviewEl.classList.remove(...classes);this.colorPreviewEl.style.removeProperty('background-color');if(this._value){if(ColorpickerWidget.isCSSColor(this._value)){this.colorPreviewEl.style.backgroundColor=this._value;}else if(weUtils.isColorCombinationName(this._value)){this.colorPreviewEl.classList.add('o_cc',`o_cc${this._value}`);}else{this.colorPreviewEl.classList.add(`bg-${this._value}`);}}},_renderColorPalette:function(){const options={selectedColor:this._value,};if(this.options.dataAttributes.excluded){options.excluded=this.options.dataAttributes.excluded.replace(/ /g,'').split(',');}
if(this.options.dataAttributes.withCombinations){options.withCombinations=!!this.options.dataAttributes.withCombinations;}
const oldColorPalette=this.colorPalette;this.colorPalette=new ColorPaletteWidget(this,options);if(oldColorPalette){return this.colorPalette.insertAfter(oldColorPalette.el).then(()=>{oldColorPalette.destroy();});}
return this.colorPalette.appendTo(document.createDocumentFragment());},_onCustomColorPicked:function(ev){this._customColorValue=ev.data.color;},_onColorPicked:function(ev){this._previewColor=false;this._customColorValue=false;this._value=ev.data.color;this._onUserValueChange(ev);},_onColorHovered:function(ev){this._previewColor=ev.data.color;this._onUserValuePreview(ev);},_onColorLeft:function(ev){this._previewColor=false;this._onUserValueReset(ev);},_onEnterKey:function(){this.close();},_onClick:function(ev){if(!ev.originalEvent.__isColorpickerClick){this._super(...arguments);}
ev.stopPropagation();},});const MediapickerUserValueWidget=UserValueWidget.extend({tagName:'we-button',events:{'click':'_onEditMedia',},async start(){await this._super(...arguments);const iconEl=document.createElement('i');if(this.options.dataAttributes.buttonStyle){iconEl.classList.add('fa','fa-fw','fa-camera');}else{iconEl.classList.add('fa','fa-fw','fa-refresh','mr-1');this.el.classList.add('o_we_no_toggle');this.containerEl.textContent=_t("Replace media");}
$(this.containerEl).prepend(iconEl);},_openDialog(el,{images=false,videos=false}){el.src=this._value;const $editable=this.$target.closest('.o_editable');const mediaDialog=new weWidgets.MediaDialog(this,{noImages:!images,noVideos:!videos,noIcons:true,noDocuments:true,isForBgVideo:true,'res_model':$editable.data('oe-model'),'res_id':$editable.data('oe-id'),},el).open();return mediaDialog;},async setValue(){await this._super(...arguments);this.el.classList.toggle('active',this.isActive());},_onEditMedia:function(ev){},});const ImagepickerUserValueWidget=MediapickerUserValueWidget.extend({_onEditMedia(ev){const dummyEl=document.createElement('img');const dialog=this._openDialog(dummyEl,{images:true});dialog.on('save',this,data=>{this._value=dummyEl.getAttribute('src');this._onUserValueChange();});},});const VideopickerUserValueWidget=MediapickerUserValueWidget.extend({_onEditMedia(ev){const dummyEl=document.createElement('iframe');const dialog=this._openDialog(dummyEl,{videos:true});dialog.on('save',this,data=>{this._value=data.bgVideoSrc;this._onUserValueChange();});},});const DatetimePickerUserValueWidget=InputUserValueWidget.extend({events:{'blur input':'_onInputBlur','change.datetimepicker':'_onDateTimePickerChange','error.datetimepicker':'_onDateTimePickerError',},init:function(){this._super(...arguments);this._value=moment().unix().toString();this.__libInput=0;},start:async function(){await this._super(...arguments);const datetimePickerId=_.uniqueId('datetimepicker');this.el.classList.add('o_we_large_input');this.inputEl.classList.add('datetimepicker-input','mx-0','text-left');this.inputEl.setAttribute('id',datetimePickerId);this.inputEl.setAttribute('data-target','#'+datetimePickerId);const datepickersOptions={minDate:moment({y:1000}),maxDate:moment().add(200,'y'),calendarWeeks:true,defaultDate:moment().format(),icons:{close:'fa fa-check primary',},locale:moment.locale(),format:time.getLangDatetimeFormat(),sideBySide:true,buttons:{showClose:true,showToday:true,},widgetParent:'body',allowInputToggle:true,};this.__libInput++;const $input=$(this.inputEl);$input.datetimepicker(datepickersOptions);this.__libInput--;const libObject=$input.data('datetimepicker');const oldFunc=libObject._getTemplate;libObject._getTemplate=function(){const $template=oldFunc.call(this,...arguments);$template.addClass('o_we_no_overlay o_we_datetimepicker');return $template;};},isPreviewed:function(){return this._super(...arguments)||!!$(this.inputEl).data('datetimepicker').widget;},async setValue(){await this._super(...arguments);let momentObj=moment.unix(this._value);if(!momentObj.isValid()){momentObj=moment();}
this.__libInput++;$(this.inputEl).datetimepicker('date',momentObj);this.__libInput--;},_onDateTimePickerChange:function(ev){if(this.__libInput>0){return;}
if(!ev.date||!ev.date.isValid()){return;}
this._value=ev.date.unix().toString();this._onUserValuePreview(ev);},_onDateTimePickerError:function(ev){ev.stopPropagation();},});const RangeUserValueWidget=UnitUserValueWidget.extend({tagName:'we-range',events:{'change input':'_onInputChange',},async start(){await this._super(...arguments);this.input=document.createElement('input');this.input.type="range";let min=this.el.dataset.min&&parseFloat(this.el.dataset.min)||0;let max=this.el.dataset.max&&parseFloat(this.el.dataset.max)||100;const step=this.el.dataset.step&&parseFloat(this.el.dataset.step)||1;if(min>max){[min,max]=[max,min];this.input.classList.add('o_we_inverted_range');}
this.input.setAttribute('min',min);this.input.setAttribute('max',max);this.input.setAttribute('step',step);this.containerEl.appendChild(this.input);},async setValue(value,methodName){await this._super(...arguments);this.input.value=this._value;},_onInputChange(ev){this._value=ev.target.value;this._onUserValueChange(ev);},});const SelectPagerUserValueWidget=SelectUserValueWidget.extend({className:(SelectUserValueWidget.prototype.className||'')+' o_we_select_pager',events:Object.assign({},SelectUserValueWidget.prototype.events,{'click .o_we_pager_next, .o_we_pager_prev':'_onPageChange',}),async start(){const _super=this._super.bind(this);this.pages=this.options.childNodes.filter(node=>node.matches&&node.matches('we-select-page'));this.numPages=this.pages.length;const prev=document.createElement('i');prev.classList.add('o_we_pager_prev','fa','fa-chevron-left');this.pageNum=document.createElement('span');this.currentPage=0;const next=document.createElement('i');next.classList.add('o_we_pager_next','fa','fa-chevron-right');const pagerControls=document.createElement('div');pagerControls.classList.add('o_we_pager_controls');pagerControls.appendChild(prev);pagerControls.appendChild(this.pageNum);pagerControls.appendChild(next);this.pageName=document.createElement('b');const pagerHeader=document.createElement('div');pagerHeader.classList.add('o_we_pager_header');pagerHeader.appendChild(this.pageName);pagerHeader.appendChild(pagerControls);await _super(...arguments);this.menuEl.classList.add('o_we_has_pager');$(this.menuEl).prepend(pagerHeader);this._updatePage();},_updatePage(){this.pages.forEach((page,i)=>page.classList.toggle('active',i===this.currentPage));this.pageNum.textContent=`${this.currentPage + 1}/${this.numPages}`;const activePage=this.pages.find((page,i)=>i===this.currentPage);this.pageName.textContent=activePage.getAttribute('string');},_onPageChange(ev){ev.preventDefault();ev.stopPropagation();const delta=ev.target.matches('.o_we_pager_next')?1:-1;this.currentPage=(this.currentPage+this.numPages+delta)%this.numPages;this._updatePage();},_onClick(ev){const activeButton=this._getActiveSubWidget();if(activeButton){const currentPage=this.pages.indexOf(activeButton.el.closest('we-select-page'));if(currentPage!==-1){this.currentPage=currentPage;this._updatePage();}}
return this._super(...arguments);},});const userValueWidgetsRegistry={'we-button':ButtonUserValueWidget,'we-checkbox':CheckboxUserValueWidget,'we-select':SelectUserValueWidget,'we-button-group':ButtonGroupUserValueWidget,'we-input':InputUserValueWidget,'we-multi':MultiUserValueWidget,'we-colorpicker':ColorpickerUserValueWidget,'we-datetimepicker':DatetimePickerUserValueWidget,'we-imagepicker':ImagepickerUserValueWidget,'we-videopicker':VideopickerUserValueWidget,'we-range':RangeUserValueWidget,'we-select-pager':SelectPagerUserValueWidget,};const SnippetOptionWidget=Widget.extend({tagName:'we-customizeblock-option',events:{'click .o_we_collapse_toggler':'_onCollapseTogglerClick',},custom_events:{'user_value_update':'_onUserValueUpdate','user_value_widget_critical':'_onUserValueWidgetCritical',},isTopOption:false,forceNoDeleteButton:false,init:function(parent,$uiElements,$target,$overlay,data,options){this._super.apply(this,arguments);this.$originalUIElements=$uiElements;this.$target=$target;this.$overlay=$overlay;this.data=data;this.options=options;this.className='snippet-option-'+this.data.optionName;this.ownerDocument=this.$target[0].ownerDocument;this._userValueWidgets=[];this._actionQueues=new Map();},willStart:async function(){await this._super(...arguments);return this._renderOriginalXML().then(uiFragment=>{this.uiFragment=uiFragment;});},renderElement:function(){this._super(...arguments);this.el.appendChild(this.uiFragment);this.uiFragment=null;},onFocus:function(){},onBuilt:function(){},onBlur:function(){},onClone:function(options){},onMove:function(){},onRemove:function(){},onTargetShow:async function(){},onTargetHide:async function(){},cleanForSave:async function(){},selectClass:function(previewMode,widgetValue,params){for(const classNames of params.possibleValues){if(classNames){this.$target[0].classList.remove(...classNames.trim().split(/\s+/g));}}
if(widgetValue){this.$target[0].classList.add(...widgetValue.trim().split(/\s+/g));}},selectDataAttribute:function(previewMode,widgetValue,params){const value=this._selectAttributeHelper(widgetValue,params);this.$target[0].dataset[params.attributeName]=value;},selectAttribute:function(previewMode,widgetValue,params){const value=this._selectAttributeHelper(widgetValue,params);this.$target[0].setAttribute(params.attributeName,value);},selectStyle:function(previewMode,widgetValue,params){this.$target[0].classList.add('o_we_force_no_transition');const _restoreTransitions=()=>this.$target[0].classList.remove('o_we_force_no_transition');if(params.cssProperty==='background-color'){this.$target.trigger('background-color-event',previewMode);}
const cssProps=weUtils.CSS_SHORTHANDS[params.cssProperty]||[params.cssProperty];for(const cssProp of cssProps){this.$target[0].style.setProperty(cssProp,'');}
if(params.extraClass){this.$target.removeClass(params.extraClass);}
if(params.colorNames&&params.colorPrefix){const classes=weUtils.computeColorClasses(params.colorNames,params.colorPrefix);this.$target[0].classList.remove(...classes);if(weUtils.isColorCombinationName(widgetValue)){this.$target[0].classList.add('o_cc',`o_cc${widgetValue}`,params.extraClass);_restoreTransitions();return;}
if(params.colorNames.includes(widgetValue)){const originalCSSValue=window.getComputedStyle(this.$target[0])[cssProps[0]];const className=params.colorPrefix+widgetValue;this.$target[0].classList.add(className);if(originalCSSValue!==window.getComputedStyle(this.$target[0])[cssProps[0]]){this.$target.addClass(params.extraClass);_restoreTransitions();return;}
this.$target[0].classList.remove(className);}}
const htmlPropValue=weUtils.getCSSVariableValue(widgetValue);if(htmlPropValue){widgetValue=`var(--${widgetValue})`;}
const values=widgetValue.replace(/,\s/g,',').split(/\s+/g);while(values.length<cssProps.length){switch(values.length){case 1:case 2:{values.push(values[0]);break;}
case 3:{values.push(values[1]);break;}
default:{values.push(values[values.length-1]);}}}
const styles=window.getComputedStyle(this.$target[0]);let hasUserValue=false;for(let i=cssProps.length-1;i>0;i--){hasUserValue=applyCSS.call(this,cssProps[i],values.pop(),styles)||hasUserValue;}
hasUserValue=applyCSS.call(this,cssProps[0],values.join(' '),styles)||hasUserValue;function applyCSS(cssProp,cssValue,styles){if(!weUtils.areCssValuesEqual(styles[cssProp],cssValue)){this.$target[0].style.setProperty(cssProp,cssValue,'important');return true;}
return false;}
if(params.extraClass){this.$target.toggleClass(params.extraClass,hasUserValue);}
_restoreTransitions();},$:function(){return this.$target.find.apply(this.$target,arguments);},closeWidgets:function(){this._userValueWidgets.forEach(widget=>widget.close());},findWidget:function(name){for(const widget of this._userValueWidgets){if(widget.getName()===name){return widget;}
const depWidget=widget.findWidget(name);if(depWidget){return depWidget;}}
return null;},notify:function(name,data){if(name==='target'){this.setTarget(data);}},setTarget:function($target){this.$target=$target;},updateUI:async function({noVisibility}={}){const proms=this._userValueWidgets.map(async widget=>{const methodsNames=widget.getMethodsNames();for(const methodName of methodsNames){const params=widget.getMethodsParams(methodName);let obj=this;if(params.applyTo){const $firstSubTarget=this.$(params.applyTo).eq(0);if(!$firstSubTarget.length){continue;}
obj=createPropertyProxy(this,'$target',$firstSubTarget);}
const value=await this._computeWidgetState.call(obj,methodName,params);if(value===undefined){continue;}
const normalizedValue=this._normalizeWidgetValue(value);await widget.setValue(normalizedValue,methodName);}});await Promise.all(proms);if(!noVisibility){await this.updateUIVisibility();}},updateUIVisibility:async function(){const proms=this._userValueWidgets.map(async widget=>{const params=widget.getMethodsParams();let obj=this;if(params.applyTo){const $firstSubTarget=this.$(params.applyTo).eq(0);if(!$firstSubTarget.length){widget.toggleVisibility(false);return;}
obj=createPropertyProxy(this,'$target',$firstSubTarget);}
const allSubWidgets=[widget];let i=0;while(i<allSubWidgets.length){allSubWidgets.push(...allSubWidgets[i]._userValueWidgets);i++;}
const proms=allSubWidgets.map(async widget=>{const show=await this._computeWidgetVisibility.call(obj,widget.getName(),params);if(!show){widget.toggleVisibility(false);return;}
const dependencies=widget.getDependencies();const dependenciesData=[];dependencies.forEach(depName=>{const toBeActive=(depName[0]!=='!');if(!toBeActive){depName=depName.substr(1);}
const widget=this._requestUserValueWidgets(depName)[0];if(widget){dependenciesData.push({widget:widget,toBeActive:toBeActive,});}});const dependenciesOK=!dependenciesData.length||dependenciesData.some(depData=>{return(depData.widget.isActive()===depData.toBeActive);});widget.toggleVisibility(dependenciesOK);});return Promise.all(proms);});const showUI=await this._computeVisibility();this.el.classList.toggle('d-none',!showUI);await Promise.all(proms);for(const el of this.$el.find('we-row')){el.classList.toggle('d-none',!$(el).find('> div > .o_we_user_value_widget').not('.d-none').length);}
for(const el of this.$el.find('we-collapse')){const $el=$(el);el.classList.toggle('d-none',$el.children().first().hasClass('d-none'));const hasNoVisibleElInCollapseMenu=!$el.children().last().children().not('.d-none').length;if(hasNoVisibleElInCollapseMenu){this._toggleCollapseEl(el,false);}
el.querySelector('.o_we_collapse_toggler').classList.toggle('d-none',hasNoVisibleElInCollapseMenu);}},async _checkIfWidgetsUpdateNeedWarning(widgets){const messages=[];for(const widget of widgets){const message=widget.getMethodsParams().warnMessage;if(message){messages.push(message);}}
return messages.join(' ');},async _checkIfWidgetsUpdateNeedReload(widgets){return false;},_computeVisibility:async function(){return true;},_computeWidgetState:async function(methodName,params){switch(methodName){case'selectClass':{let maxNbClasses=0;let activeClassNames='';params.possibleValues.forEach(classNames=>{if(!classNames){return;}
const classes=classNames.split(/\s+/g);if(classes.length>=maxNbClasses&&classes.every(className=>this.$target[0].classList.contains(className))){maxNbClasses=classes.length;activeClassNames=classNames;}});return activeClassNames;}
case'selectAttribute':case'selectDataAttribute':{const attrName=params.attributeName;let attrValue;if(methodName==='selectAttribute'){attrValue=this.$target[0].getAttribute(attrName);}else if(methodName==='selectDataAttribute'){attrValue=this.$target[0].dataset[attrName];}
attrValue=(attrValue||'').trim();if(params.saveUnit&&!params.withUnit){attrValue=attrValue.split(/\s+/g).map(v=>v+params.saveUnit).join(' ');}
return attrValue||params.attributeDefaultValue||'';}
case'selectStyle':{if(params.colorPrefix&&params.colorNames){for(const c of params.colorNames){const className=weUtils.computeColorClasses([c],params.colorPrefix)[0];if(this.$target[0].classList.contains(className)){return c;}}}
this.$target[0].classList.add('o_we_force_no_transition');const _restoreTransitions=()=>this.$target[0].classList.remove('o_we_force_no_transition');const styles=window.getComputedStyle(this.$target[0]);const cssProps=weUtils.CSS_SHORTHANDS[params.cssProperty]||[params.cssProperty];const cssValues=cssProps.map(cssProp=>{let value=styles[cssProp].trim();if(cssProp==='box-shadow'){const inset=value.includes('inset');let values=value.replace(/,\s/g,',').replace('inset','').trim().split(/\s+/g);const color=values.find(s=>!s.match(/^\d/));values=values.join(' ').replace(color,'').trim();value=`${color} ${values}${inset ? ' inset' : ''}`;}
return value;});if(cssValues.length===4&&weUtils.areCssValuesEqual(cssValues[3],cssValues[1],params.cssProperty,this.$target)){cssValues.pop();}
if(cssValues.length===3&&weUtils.areCssValuesEqual(cssValues[2],cssValues[0],params.cssProperty,this.$target)){cssValues.pop();}
if(cssValues.length===2&&weUtils.areCssValuesEqual(cssValues[1],cssValues[0],params.cssProperty,this.$target)){cssValues.pop();}
_restoreTransitions();return cssValues.join(' ');}}},_computeWidgetVisibility:async function(widgetName,params){if(widgetName==='move_up_opt'||widgetName==='move_left_opt'){return!this.$target.is(':first-child');}
if(widgetName==='move_down_opt'||widgetName==='move_right_opt'){return!this.$target.is(':last-child');}
return true;},_extraInfoFromDescriptionElement:function(el){return{title:el.getAttribute('string'),options:{classes:el.classList,dataAttributes:el.dataset,tooltip:el.title,placeholder:el.getAttribute('placeholder'),childNodes:[...el.childNodes],},};},_normalizeWidgetValue:function(value){value=`${value}`.trim();value=ColorpickerWidget.normalizeCSSColor(value);return value;},_registerUserValueWidget:function(widgetName,parent,title,options){const widget=new userValueWidgetsRegistry[widgetName](parent,title,options,this.$target);if(!parent||parent===this){this._userValueWidgets.push(widget);}else{parent.registerSubWidget(widget);}
return widget;},_renderCustomWidgets:function(uiFragment){return Promise.resolve();},_renderCustomXML:function(uiFragment){return Promise.resolve();},_renderOriginalXML:async function($xml){const uiFragment=document.createDocumentFragment();($xml||this.$originalUIElements).clone(true).appendTo(uiFragment);await this._renderCustomXML(uiFragment);for(const[itemName,build]of[['we-row',_buildRowElement],['we-collapse',_buildCollapseElement]]){uiFragment.querySelectorAll(itemName).forEach(el=>{const infos=this._extraInfoFromDescriptionElement(el);const groupEl=build(infos.title,infos.options);el.parentNode.insertBefore(groupEl,el);el.parentNode.removeChild(el);});}
await this._renderXMLWidgets(uiFragment);await this._renderCustomWidgets(uiFragment);if(this.isDestroyed()){return uiFragment;}
const validMethodNames=[];for(const key in this){validMethodNames.push(key);}
this._userValueWidgets.forEach(widget=>{widget.loadMethodsData(validMethodNames);});return uiFragment;},_renderXMLWidgets:function(parentEl,parentWidget){const proms=[...parentEl.children].map(el=>{const widgetName=el.tagName.toLowerCase();if(!userValueWidgetsRegistry.hasOwnProperty(widgetName)){return this._renderXMLWidgets(el,parentWidget);}
const infos=this._extraInfoFromDescriptionElement(el);const widget=this._registerUserValueWidget(widgetName,parentWidget||this,infos.title,infos.options);return widget.insertAfter(el).then(()=>{parentEl.removeChild(el);if(widget.isContainer()){return this._renderXMLWidgets(widget.el,widget);}});});return Promise.all(proms);},_requestUserValueWidgets:function(...widgetNames){const widgets=[];for(const widgetName of widgetNames){let widget=null;this.trigger_up('user_value_widget_request',{name:widgetName,onSuccess:_widget=>widget=_widget,});if(widget){widgets.push(widget);}}
return widgets;},_rerenderXML:async function(callback){this._userValueWidgets.forEach(widget=>widget.destroy());this._userValueWidgets=[];this.$el.empty();let $xml=undefined;if(callback){$xml=await callback.call(this);}
return this._renderOriginalXML($xml).then(uiFragment=>{this.$el.append(uiFragment);return this.updateUI();});},_select:async function(previewMode,widget){let $applyTo=null;for(const methodName of widget.getMethodsNames()){const widgetValue=widget.getValue(methodName);const params=widget.getMethodsParams(methodName);if(params.applyTo){if(!$applyTo){$applyTo=this.$(params.applyTo);}
const proms=_.map($applyTo,subTargetEl=>{const proxy=createPropertyProxy(this,'$target',$(subTargetEl));return this[methodName].call(proxy,previewMode,widgetValue,params);});await Promise.all(proms);}else{await this[methodName](previewMode,widgetValue,params);}}
($applyTo||this.$target).trigger('content_changed');},_selectAttributeHelper(value,params){if(!params.attributeName){throw new Error('Attribute name missing');}
if(params.saveUnit&&!params.withUnit){value=value.split(params.saveUnit).join('');}
if(params.extraClass){this.$target.toggleClass(params.extraClass,params.defaultValue!==value);}
return value;},_toggleCollapseEl(collapseEl,show){collapseEl.classList.toggle('active',show);collapseEl.querySelector('.o_we_collapse_toggler').classList.toggle('active',show);},_onCollapseTogglerClick(ev){const currentCollapseEl=ev.currentTarget.parentNode;this._toggleCollapseEl(currentCollapseEl);for(const collapseEl of currentCollapseEl.querySelectorAll('we-collapse')){this._toggleCollapseEl(collapseEl,false);}},_onUserValueUpdate:async function(ev){ev.stopPropagation();const widget=ev.data.widget;const previewMode=ev.data.previewMode;let requiresReload=false;if(!ev.data.previewMode&&!ev.data.isSimulatedEvent){const linkedWidgets=this._requestUserValueWidgets(...ev.data.triggerWidgetsNames);const widgets=[ev.data.widget].concat(linkedWidgets);const warnMessage=await this._checkIfWidgetsUpdateNeedWarning(widgets);if(warnMessage){const okWarning=await new Promise(resolve=>{Dialog.confirm(this,warnMessage,{confirm_callback:()=>resolve(true),cancel_callback:()=>resolve(false),});});if(!okWarning){return;}}
const reloadMessage=await this._checkIfWidgetsUpdateNeedReload(widgets);requiresReload=!!reloadMessage;if(requiresReload){const save=await new Promise(resolve=>{Dialog.confirm(this,_t("This change needs to reload the page, this will save all your changes and reload the page, are you sure you want to proceed?")+' '
+(typeof reloadMessage==='string'?reloadMessage:''),{confirm_callback:()=>resolve(true),cancel_callback:()=>resolve(false),});});if(!save){return;}}}
if(!this._actionQueues.get(widget)){this._actionQueues.set(widget,[]);}
const currentAction={previewMode};this._actionQueues.get(widget).push(currentAction);const shouldRecordUndo=(!previewMode&&!ev.data.isSimulatedEvent);this.trigger_up('snippet_edition_request',{exec:async()=>{if(this.isDestroyed()){return;}
const actionQueue=this._actionQueues.get(widget).filter(({previewMode},i,actions)=>{const prev=actions[i-1];const next=actions[i+1];if(previewMode===true&&next&&next.previewMode){return false;}else if(previewMode==='reset'&&prev&&prev.previewMode){return false;}
return true;});if(!actionQueue.includes(currentAction)){this._actionQueues.set(widget,actionQueue);return;}
this._actionQueues.set(widget,actionQueue.filter(action=>action!==currentAction));if(ev.data.prepare){ev.data.prepare();}
if(previewMode&&(widget.$el.closest('[data-no-preview="true"]').length)){return;}
if(shouldRecordUndo){this.trigger_up('request_history_undo_record',{$target:this.$target});}
await this._select(previewMode,widget);if(previewMode){return;}
await new Promise(resolve=>setTimeout(()=>{this.trigger_up('snippet_option_update',{onSuccess:()=>resolve(),});}));}});if(ev.data.isSimulatedEvent){return;}
const linkedWidgets=this._requestUserValueWidgets(...ev.data.triggerWidgetsNames);if(linkedWidgets.length!==ev.data.triggerWidgetsNames.length){console.warn('Missing widget to trigger');return;}
let i=0;const triggerWidgetsValues=ev.data.triggerWidgetsValues;for(const linkedWidget of linkedWidgets){const widgetValue=triggerWidgetsValues[i];if(widgetValue!==undefined){const normValue=this._normalizeWidgetValue(widgetValue);if(previewMode===true){linkedWidget._previewColor=normValue;}else if(previewMode===false){linkedWidget._previewColor=false;linkedWidget._value=normValue;}else{linkedWidget._previewColor=false;}}
linkedWidget.notifyValueChange(previewMode,true);i++;}
if(requiresReload){this.trigger_up('request_save',{reloadEditor:true,});}},_onUserValueWidgetCritical(){this.trigger_up('remove_snippet',{$snippet:this.$target,});},});const registry={};registry.sizing=SnippetOptionWidget.extend({start:function(){var self=this;var def=this._super.apply(this,arguments);this.$handles=this.$overlay.find('.o_handle');var resizeValues=this._getSize();this.$handles.on('mousedown',function(ev){ev.preventDefault();resizeValues=self._getSize();var $handle=$(ev.currentTarget);var compass=false;var XY=false;if($handle.hasClass('n')){compass='n';XY='Y';}else if($handle.hasClass('s')){compass='s';XY='Y';}else if($handle.hasClass('e')){compass='e';XY='X';}else if($handle.hasClass('w')){compass='w';XY='X';}
var resize=resizeValues[compass];if(!resize){return;}
var current=0;var cssProperty=resize[2];var cssPropertyValue=parseInt(self.$target.css(cssProperty));_.each(resize[0],function(val,key){if(self.$target.hasClass(val)){current=key;}else if(resize[1][key]===cssPropertyValue){current=key;}});var begin=current;var beginClass=self.$target.attr('class');var regClass=new RegExp('\\s*'+resize[0][begin].replace(/[-]*[0-9]+/,'[-]*[0-9]+'),'g');var cursor=$handle.css('cursor')+'-important';var $body=$(this.ownerDocument.body);$body.addClass(cursor);var xy=ev['page'+XY];var bodyMouseMove=function(ev){ev.preventDefault();var dd=ev['page'+XY]-xy+resize[1][begin];var next=current+(current+1===resize[1].length?0:1);var prev=current?(current-1):0;var change=false;if(dd>(2*resize[1][next]+resize[1][current])/3){self.$target.attr('class',(self.$target.attr('class')||'').replace(regClass,''));self.$target.addClass(resize[0][next]);current=next;change=true;}
if(prev!==current&&dd<(2*resize[1][prev]+resize[1][current])/3){self.$target.attr('class',(self.$target.attr('class')||'').replace(regClass,''));self.$target.addClass(resize[0][prev]);current=prev;change=true;}
if(change){self._onResize(compass,beginClass,current);self.trigger_up('cover_update');$handle.addClass('o_active');}};var bodyMouseUp=function(){$body.off('mousemove',bodyMouseMove);$(window).off('mouseup',bodyMouseUp);$body.removeClass(cursor);$handle.removeClass('o_active');var $handlers=self.$overlay.find('.o_handle');$handlers.addClass('o_active').delay(300).queue(function(){$handlers.removeClass('o_active').dequeue();});if(begin===current){return;}
setTimeout(function(){self.trigger_up('request_history_undo_record',{$target:self.$target,event:'resize_'+XY,});},0);};$body.on('mousemove',bodyMouseMove);$(window).on('mouseup',bodyMouseUp);});return def;},onFocus:function(){this._onResize();},onBlur:function(){this.$handles.addClass('readonly');},setTarget:function(){this._super(...arguments);this._onResize();},updateUI:async function(){await this._super(...arguments);const resizeValues=this._getSize();_.each(resizeValues,(value,key)=>{this.$handles.filter('.'+key).toggleClass('readonly',!value);});},_getSize:function(){},_onResize:function(compass,beginClass,current){var self=this;var resizeValues=this._getSize();var $handles=this.$overlay.find('.o_handle');_.each(resizeValues,function(resizeValue,direction){var classes=resizeValue[0];var values=resizeValue[1];var cssProperty=resizeValue[2];var $handle=$handles.filter('.'+direction);var current=0;var cssPropertyValue=parseInt(self.$target.css(cssProperty));_.each(classes,function(className,key){if(self.$target.hasClass(className)){current=key;}else if(values[key]===cssPropertyValue){current=key;}});$handle.toggleClass('o_handle_start',current===0);$handle.toggleClass('o_handle_end',current===classes.length-1);});var ml=this.$target.css('margin-left');this.$overlay.find('.o_handle.w').css({width:ml,left:'-'+ml,});this.$overlay.find('.o_handle.e').css({width:0,});_.each(this.$overlay.find(".o_handle.n, .o_handle.s"),function(handle){var $handle=$(handle);var direction=$handle.hasClass('n')?'top':'bottom';$handle.height(self.$target.css('padding-'+direction));});this.$target.trigger('content_changed');},});registry['sizing_y']=registry.sizing.extend({_getSize:function(){var nClass='pt';var nProp='padding-top';var sClass='pb';var sProp='padding-bottom';if(this.$target.is('hr')){nClass='mt';nProp='margin-top';sClass='mb';sProp='margin-bottom';}
var grid=[];for(var i=0;i<=(256/8);i++){grid.push(i*8);}
grid.splice(1,0,4);this.grid={n:[grid.map(v=>nClass+v),grid,nProp],s:[grid.map(v=>sClass+v),grid,sProp],};return this.grid;},});const ImageHandlerOption=SnippetOptionWidget.extend({async willStart(){const _super=this._super.bind(this);await this._loadImageInfo();return _super(...arguments);},selectWidth(previewMode,widgetValue,params){this._getImg().dataset.resizeWidth=widgetValue;return this._applyOptions();},setQuality(previewMode,widgetValue,params){this._getImg().dataset.quality=widgetValue;return this._applyOptions();},glFilter(previewMode,widgetValue,params){const dataset=this._getImg().dataset;if(widgetValue){dataset.glFilter=widgetValue;}else{delete dataset.glFilter;}
return this._applyOptions();},customFilter(previewMode,widgetValue,params){const img=this._getImg();const{filterOptions}=img.dataset;const{filterProperty}=params;if(filterProperty==='filterColor'){widgetValue=normalizeColor(widgetValue);}
const newOptions=Object.assign(JSON.parse(filterOptions||"{}"),{[filterProperty]:widgetValue});img.dataset.filterOptions=JSON.stringify(newOptions);return this._applyOptions();},_computeVisibility(){const img=this._getImg();if(!['image/jpeg','image/png'].includes(img.dataset.mimetype)){return false;}
const src=img.getAttribute('src');return src&&src!=='/';},async _computeWidgetState(methodName,params){const img=this._getImg();await new Promise((resolve,reject)=>{if(img.complete){resolve();return;}
img.addEventListener('load',resolve,{once:true});img.addEventListener('error',resolve,{once:true});});switch(methodName){case'selectWidth':return img.naturalWidth;case'setFilter':return img.dataset.filter;case'glFilter':return img.dataset.glFilter||"";case'setQuality':return img.dataset.quality||75;case'customFilter':{const{filterProperty}=params;const options=JSON.parse(img.dataset.filterOptions||"{}");const defaultValue=filterProperty==='blend'?'normal':0;return options[filterProperty]||defaultValue;}}
return this._super(...arguments);},async _renderCustomXML(uiFragment){if(!this.originalSrc){return[...uiFragment.childNodes].forEach(node=>{if(node.matches('.o_we_external_warning')){node.classList.remove('d-none');}else{node.remove();}});}
const img=this._getImg();const $select=$(uiFragment).find('we-select[data-name=width_select_opt]');(await this._computeAvailableWidths()).forEach(([value,label])=>{$select.append(`<we-button data-select-width="${value}">${label}</we-button>`);});const qualityRange=uiFragment.querySelector('we-range');if(img.dataset.mimetype!=='image/jpeg'){qualityRange.remove();}},async _computeAvailableWidths(){const img=this._getImg();const original=await loadImage(this.originalSrc);const maxWidth=img.dataset.width?img.naturalWidth:original.naturalWidth;const optimizedWidth=Math.min(maxWidth,this._computeMaxDisplayWidth());this.optimizedWidth=optimizedWidth;const widths={128:'128px',256:'256px',512:'512px',1024:'1024px',1920:'1920px',};widths[img.naturalWidth]=_.str.sprintf(_t("%spx"),img.naturalWidth);widths[optimizedWidth]=_.str.sprintf(_t("%dpx (Suggested)"),optimizedWidth);widths[maxWidth]=_.str.sprintf(_t("%dpx (Original)"),maxWidth);return Object.entries(widths).filter(([width])=>width<=maxWidth).sort(([v1],[v2])=>v1-v2);},async _applyOptions(){const img=this._getImg();if(!['image/jpeg','image/png'].includes(img.dataset.mimetype)){this.originalId=null;return;}
const dataURL=await applyModifications(img);const weight=dataURL.split(',')[1].length/4*3;const $weight=this.$el.find('.o_we_image_weight');$weight.find('> small').text(_t("New size"));$weight.find('b').text(`${(weight / 1024).toFixed(1)} kb`);$weight.removeClass('d-none');img.classList.add('o_modified_image_to_save');return loadImage(dataURL,img);},async _loadImageInfo(){const img=this._getImg();await loadImageInfo(img,this._rpc.bind(this));if(!img.dataset.originalId){this.originalId=null;this.originalSrc=null;return;}
this.originalId=img.dataset.originalId;this.originalSrc=img.dataset.originalSrc;},async _autoOptimizeImage(){await this._loadImageInfo();await this._rerenderXML();this._getImg().dataset.resizeWidth=this.optimizedWidth;await this._applyOptions();await this.updateUI();},_getImg(){},_computeMaxDisplayWidth(){},});registry.ImageOptimize=ImageHandlerOption.extend({start(){this.$target.on('image_changed.ImageOptimization',this._onImageChanged.bind(this));this.$target.on('image_cropped.ImageOptimization',this._onImageCropped.bind(this));return this._super(...arguments);},destroy(){this.$target.off('.ImageOptimization');return this._super(...arguments);},_computeMaxDisplayWidth(){const displayWidth=this._getImg().clientWidth;if(this.$target.closest('[class*="col-lg"]').length){if(this.$target.closest('.container, .o_container_small').length){return Math.min(1920,Math.max(displayWidth,690));}
return Math.min(1920,Math.max(displayWidth,962));}
return displayWidth;},_getImg(){return this.$target[0];},async _onImageChanged(ev){this.trigger_up('snippet_edition_request',{exec:async()=>{await this._autoOptimizeImage();this.trigger_up('cover_update');}});},async _onImageCropped(ev){await this._rerenderXML();},});registry.BackgroundOptimize=ImageHandlerOption.extend({start(){this.$target.on('background_changed.BackgroundOptimize',this._onBackgroundChanged.bind(this));return this._super(...arguments);},destroy(){this.$target.off('.BackgroundOptimize');return this._super(...arguments);},async cleanForSave(){const img=this._getImg();if(img.matches('.o_modified_image_to_save')){this.$target.addClass('o_modified_image_to_save');Object.entries(img.dataset).forEach(([key,value])=>{this.$target[0].dataset[key]=value;});this.$target[0].dataset.bgSrc=img.getAttribute('src');}},_getImg(){return this.img;},_computeMaxDisplayWidth(){return 1920;},async _applyOptions(){await this._super(...arguments);this.$target.css('background-image',`url('${this._getImg().getAttribute('src')}')`);},async _loadImageInfo(){this.img=new Image();Object.entries(this.$target[0].dataset).forEach(([key,value])=>{this.img.dataset[key]=value;});const src=getBgImageURL(this.$target[0]);this.img.src=src.startsWith('/')?src:'';return await this._super(...arguments);},async _onBackgroundChanged(ev,previewMode){if(!previewMode){this.trigger_up('snippet_edition_request',{exec:async()=>{await this._autoOptimizeImage();}});}},});registry.BackgroundToggler=SnippetOptionWidget.extend({start(){this.$target.on('content_changed.BackgroundToggler',this._onExternalUpdate.bind(this));return this._super(...arguments);},destroy(){this._super(...arguments);this.$target.off('.BackgroundToggler');},toggleBgImage(previewMode,widgetValue,params){if(!widgetValue){const[bgImageWidget]=this._requestUserValueWidgets('bg_image_opt');const bgImageOpt=bgImageWidget.getParent();return bgImageOpt.background(false,'',bgImageWidget.getMethodsParams('background'));}else{this._requestUserValueWidgets('bg_image_opt')[0].el.click();}},toggleBgShape(previewMode,widgetValue,params){const[shapeWidget]=this._requestUserValueWidgets('bg_shape_opt');const shapeOption=shapeWidget.getParent();return shapeOption._toggleShape();},toggleBgFilter(previewMode,widgetValue,params){if(widgetValue){const bgFilterEl=document.createElement('div');bgFilterEl.classList.add('o_we_bg_filter','bg-black-50');const lastBackgroundEl=this._getLastPreFilterLayerElement();if(lastBackgroundEl){$(lastBackgroundEl).after(bgFilterEl);}else{this.$target.prepend(bgFilterEl);}}else{this.$target.find('.o_we_bg_filter').remove();}},_computeWidgetState(methodName,params){switch(methodName){case'toggleBgImage':{const[bgImageWidget]=this._requestUserValueWidgets('bg_image_opt');const bgImageOpt=bgImageWidget.getParent();return!!bgImageOpt._computeWidgetState('background',bgImageWidget.getMethodsParams('background'));}
case'toggleBgFilter':{return this._hasBgFilter();}
case'toggleBgShape':{const[shapeWidget]=this._requestUserValueWidgets('bg_shape_opt');const shapeOption=shapeWidget.getParent();return!!shapeOption._computeWidgetState('shape',shapeWidget.getMethodsParams('shape'));}}
return this._super(...arguments);},_getLastPreFilterLayerElement(){return null;},_hasBgFilter(){return!!this.$target.find('> .o_we_bg_filter').length;},_onExternalUpdate(){if(this._hasBgFilter()&&!this._getLastPreFilterLayerElement()&&!getBgImageURL(this.$target)){const widget=this._requestUserValueWidgets('bg_filter_toggle_opt')[0];widget.enable();}},});registry.BackgroundImage=SnippetOptionWidget.extend({start:function(){this.__customImageSrc=getBgImageURL(this.$target[0]);return this._super(...arguments);},background:async function(previewMode,widgetValue,params){if(previewMode===true){this.__customImageSrc=getBgImageURL(this.$target[0]);}else if(previewMode==='reset'){widgetValue=this.__customImageSrc;}else{this.__customImageSrc=widgetValue;}
this._setBackground(widgetValue);if(previewMode!=='reset'){removeOnImageChangeAttrs.forEach(attr=>delete this.$target[0].dataset[attr]);this.$target.trigger('background_changed',[previewMode]);}},async dynamicColor(previewMode,widgetValue,params){const currentSrc=getBgImageURL(this.$target[0]);switch(previewMode){case true:this.previousSrc=currentSrc;break;case'reset':this.$target.css('background-image',`url('${this.previousSrc}')`);return;}
const newURL=new URL(currentSrc,window.location.origin);newURL.searchParams.set('c1',normalizeColor(widgetValue));const src=newURL.pathname+newURL.search;await loadImage(src);this.$target.css('background-image',`url('${src}')`);if(!previewMode){this.previousSrc=src;}},setTarget:function(){const oldBgURL=getBgImageURL(this.$target);this._setBackground('');this._super(...arguments);if(oldBgURL){this._setBackground(oldBgURL);}
this.__customImageSrc=getBgImageURL(this.$target[0]);},_computeWidgetState:function(methodName){switch(methodName){case'background':return getBgImageURL(this.$target[0]);case'dynamicColor':return new URL(getBgImageURL(this.$target[0]),window.location.origin).searchParams.get('c1');}
return this._super(...arguments);},_computeWidgetVisibility(widgetName,params){if(widgetName==='dynamic_color_opt'){const src=new URL(getBgImageURL(this.$target[0]),window.location.origin);return src.origin===window.location.origin&&src.pathname.startsWith('/web_editor/shape/');}
return this._super(...arguments);},_setBackground(backgroundURL){if(backgroundURL){this.$target.css('background-image',`url('${backgroundURL}')`);this.$target.addClass('oe_img_bg');}else{this.$target.css('background-image','');this.$target.removeClass('oe_img_bg');}},});registry.BackgroundShape=SnippetOptionWidget.extend({updateUI(){if(this.rerender){this.rerender=false;return this._rerenderXML();}
return this._super.apply(this,arguments);},shape(previewMode,widgetValue,params){this._handlePreviewState(previewMode,()=>{return{shape:widgetValue,colors:this._getDefaultColors(),flip:[]};});},color(previewMode,widgetValue,params){this._handlePreviewState(previewMode,()=>{const{colorName}=params;const{colors:previousColors}=this._getShapeData();const newColor=normalizeColor(widgetValue)||this._getDefaultColors()[colorName];const newColors=Object.assign(previousColors,{[colorName]:newColor});return{colors:newColors};});},flipX(previewMode,widgetValue,params){this._flipShape(previewMode,'x');},flipY(previewMode,widgetValue,params){this._flipShape(previewMode,'y');},_computeWidgetState(methodName,params){switch(methodName){case'shape':{return this._getShapeData().shape;}
case'color':{const{shape,colors:customColors}=this._getShapeData();const colors=Object.assign(this._getDefaultColors(),customColors);const color=shape&&colors[params.colorName];return color||'';}
case'flipX':{const hasFlipClass=this.$target.find('> .o_we_shape.o_we_flip_x').length!==0;return hasFlipClass||this._getShapeData().flip.includes('x');}
case'flipY':{const hasFlipClass=this.$target.find('> .o_we_shape.o_we_flip_y').length!==0;return hasFlipClass||this._getShapeData().flip.includes('y');}}
return this._super(...arguments);},_renderCustomXML(uiFragment){Object.keys(this._getDefaultColors()).map(colorName=>{uiFragment.querySelector('[data-name="colors"]').prepend($(`<we-colorpicker data-color="true" data-color-name="${colorName}">`)[0]);});uiFragment.querySelectorAll('we-select-pager we-button[data-shape]').forEach(btn=>{const btnContent=document.createElement('div');btnContent.classList.add('o_we_shape_btn_content','position-relative','border-dark');const btnContentInnerDiv=document.createElement('div');btnContentInnerDiv.classList.add('o_we_shape');btnContent.appendChild(btnContentInnerDiv);const{shape}=btn.dataset;const shapeEl=btnContent.querySelector('.o_we_shape');shapeEl.classList.add(`o_${shape.replace(/\//g, '_')}`);btn.append(btnContent);});return uiFragment;},async _computeWidgetVisibility(widgetName,params){if(widgetName==='shape_none_opt'){return false;}
return this._super(...arguments);},_flipShape(previewMode,axis){this._handlePreviewState(previewMode,()=>{const flip=new Set(this._getShapeData().flip);if(flip.has(axis)){flip.delete(axis);}else{flip.add(axis);}
return{flip:[...flip]};});},_handlePreviewState(previewMode,computeShapeData){const target=this.$target[0];const insertShapeContainer=newContainer=>{const shapeContainer=target.querySelector(':scope > .o_we_shape');if(shapeContainer){shapeContainer.remove();}
if(newContainer){const preShapeLayerElement=this._getLastPreShapeLayerElement();if(preShapeLayerElement){$(preShapeLayerElement).after(newContainer);}else{this.$target.prepend(newContainer);}}
return newContainer;};let changedShape=false;if(previewMode==='reset'){insertShapeContainer(this.prevShapeContainer);if(this.prevShape){target.dataset.oeShapeData=this.prevShape;}else{delete target.dataset.oeShapeData;}
return;}else{if(previewMode===true){const shapeContainer=target.querySelector(':scope > .o_we_shape');this.prevShapeContainer=shapeContainer&&shapeContainer.cloneNode(true);this.prevShape=target.dataset.oeShapeData;}
const curShapeData=target.dataset.oeShapeData||{};const newShapeData=computeShapeData();const{shape:curShape}=curShapeData;changedShape=newShapeData.shape!==curShape;this._markShape(newShapeData);if(previewMode===false&&changedShape){this.rerender=true;}}
const json=target.dataset.oeShapeData;const{shape,colors,flip=[]}=json?JSON.parse(json):{};let shapeContainer=target.querySelector(':scope > .o_we_shape');if(!shape){return insertShapeContainer(null);}
if(changedShape){shapeContainer=insertShapeContainer(null);}
if(!shapeContainer){shapeContainer=insertShapeContainer(document.createElement('div'));target.style.position='relative';shapeContainer.className=`o_we_shape o_${shape.replace(/\//g, '_')}`;}
shapeContainer.classList.remove('o_we_flip_x','o_we_flip_y');if(colors||flip.length){$(shapeContainer).css('background-image',`url("${this._getShapeSrc()}")`);shapeContainer.style.backgroundPosition='';if(flip.length){let[xPos,yPos]=$(shapeContainer).css('background-position').split(' ').map(p=>parseFloat(p));xPos=flip.includes('x')?-xPos+100:xPos;yPos=flip.includes('y')?-yPos+100:yPos;shapeContainer.style.backgroundPosition=`${xPos}% ${yPos}%`;}}else{$(shapeContainer).css('background-image','');$(shapeContainer).css('background-position','');}
if(previewMode===false){this.prevShapeContainer=shapeContainer.cloneNode(true);this.prevShape=target.dataset.oeShapeData;}},_markShape(newData){const defaultColors=this._getDefaultColors();const shapeData=Object.assign(this._getShapeData(),newData);const areColorsDefault=Object.entries(shapeData.colors).every(([colorName,colorValue])=>{return colorValue.toLowerCase()===defaultColors[colorName].toLowerCase();});if(areColorsDefault){delete shapeData.colors;}
if(!shapeData.shape){delete this.$target[0].dataset.oeShapeData;}else{this.$target[0].dataset.oeShapeData=JSON.stringify(shapeData);}},_getLastPreShapeLayerElement(){const $filterEl=this.$target.find('> .o_we_bg_filter');if($filterEl.length){return $filterEl[0];}
return null;},_getShapeSrc(){const{shape,colors,flip}=this._getShapeData();if(!shape){return'';}
const searchParams=Object.entries(colors).map(([colorName,colorValue])=>{const encodedCol=encodeURIComponent(colorValue);return`${colorName}=${encodedCol}`;});if(flip.length){searchParams.push(`flip=${flip.sort().join('')}`);}
return`/web_editor/shape/${shape}.svg?${searchParams.join('&')}`;},_getShapeData(target=this.$target[0]){const defaultData={shape:'',colors:this._getDefaultColors(),flip:[],};const json=target.dataset.oeShapeData;return json?Object.assign(defaultData,JSON.parse(json.replace(/'/g,'"'))):defaultData;},_getDefaultColors(){const $shapeContainer=this.$target.find('> .o_we_shape').clone().addClass('d-none').appendTo(document.body);const shapeContainer=$shapeContainer[0];$shapeContainer.css('background-image','');const shapeSrc=shapeContainer&&getBgImageURL(shapeContainer);$shapeContainer.remove();if(!shapeSrc){return{};}
const url=new URL(shapeSrc,window.location.origin);return Object.fromEntries(url.searchParams.entries());},_toggleShape(){if(this._getShapeData().shape){return this._handlePreviewState(false,()=>({shape:''}));}else{const target=this.$target[0];const previousSibling=target.previousElementSibling;const[shapeWidget]=this._requestUserValueWidgets('bg_shape_opt');const possibleShapes=shapeWidget.getMethodsParams('shape').possibleValues;let shapeToSelect;if(previousSibling){const previousShape=this._getShapeData(previousSibling).shape;shapeToSelect=possibleShapes.find((shape,i)=>{return possibleShapes[i-1]===previousShape;});}else{shapeToSelect=possibleShapes[1];}
return this._handlePreviewState(false,()=>({shape:shapeToSelect}));}},});registry.BackgroundPosition=SnippetOptionWidget.extend({xmlDependencies:['/web_editor/static/src/xml/editor.xml'],start:function(){this._super.apply(this,arguments);this._initOverlay();$(window).on('resize.bgposition',()=>this._dimensionOverlay());},destroy:function(){this._toggleBgOverlay(false);$(window).off('.bgposition');this._super.apply(this,arguments);},backgroundType:function(previewMode,widgetValue,params){this.$target.toggleClass('o_bg_img_opt_repeat',widgetValue==='repeat-pattern');this.$target.css('background-position','');this.$target.css('background-size','');},backgroundPositionOverlay:async function(previewMode,widgetValue,params){await new Promise(resolve=>{this.img=document.createElement('img');this.img.addEventListener('load',()=>resolve());this.img.src=getBgImageURL(this.$target[0]);});const position=this.$target.css('background-position').split(' ').map(v=>parseInt(v));const delta=this._getBackgroundDelta();this.originalPosition={left:position[0],top:position[1],};this.currentPosition={left:position[0]/100*delta.x||0,top:position[1]/100*delta.y||0,};this._toggleBgOverlay(true);},selectStyle:function(previewMode,widgetValue,params){if(params.cssProperty==='background-size'&&!this.$target.hasClass('o_bg_img_opt_repeat')){return;}
this._super(...arguments);},_computeVisibility:function(){return this._super(...arguments)&&!!getBgImageURL(this.$target[0]);},_computeWidgetState:function(methodName,params){if(methodName==='backgroundType'){return this.$target.css('background-repeat')==='repeat'?'repeat-pattern':'cover';}
return this._super(...arguments);},_initOverlay:function(){this.$backgroundOverlay=$(qweb.render('web_editor.background_position_overlay'));this.$overlayContent=this.$backgroundOverlay.find('.o_we_overlay_content');this.$overlayBackground=this.$overlayContent.find('.o_overlay_background');this.$backgroundOverlay.on('click','.o_btn_apply',()=>{this.$target.css('background-position',this.$bgDragger.css('background-position'));this._toggleBgOverlay(false);});this.$backgroundOverlay.on('click','.o_btn_discard',()=>{this._toggleBgOverlay(false);});this.$backgroundOverlay.insertAfter(this.$overlay);},_dimensionOverlay:function(){if(!this.$backgroundOverlay.is('.oe_active')){return;}
const $wrapwrap=$('#wrapwrap');const targetOffset=this.$target.offset();this.$backgroundOverlay.css({width:$wrapwrap.innerWidth(),height:$wrapwrap.innerHeight(),});this.$overlayContent.offset(targetOffset);this.$bgDragger.css({width:`${this.$target.innerWidth()}px`,height:`${this.$target.innerHeight()}px`,});const topPos=(parseInt(this.$overlay.css('top'))-parseInt(this.$overlayContent.css('top')));this.$overlayContent.find('.o_we_overlay_buttons').css('top',`${topPos}px`);},_toggleBgOverlay:function(activate){if(!this.$backgroundOverlay||this.$backgroundOverlay.is('.oe_active')===activate){return;}
if(!activate){this.$backgroundOverlay.removeClass('oe_active');this.trigger_up('unblock_preview_overlays');this.trigger_up('activate_snippet',{$snippet:this.$target});$(document).off('click.bgposition');return;}
this.trigger_up('hide_overlay');this.trigger_up('activate_snippet',{$snippet:this.$target,previewMode:true,});this.trigger_up('block_preview_overlays');this.$bgDragger=this.$target.clone().empty();this.$bgDragger.css('background-attachment',this.$target.css('background-attachment'));this.$bgDragger.on('mousedown',this._onDragBackgroundStart.bind(this));this.$bgDragger.tooltip({title:'Click and drag the background to adjust its position!',trigger:'manual',container:this.$backgroundOverlay});this.$overlayBackground.empty().append(this.$bgDragger);this.$backgroundOverlay.addClass('oe_active');this._dimensionOverlay();this.$bgDragger.tooltip('show');window.setTimeout(()=>$(document).on('click.bgposition',this._onDocumentClicked.bind(this)),0);},_getBackgroundDelta:function(){const bgSize=this.$target.css('background-size');if(bgSize!=='cover'){let[width,height]=bgSize.split(' ');if(width==='auto'&&(height==='auto'||!height)){return{x:this.$target.outerWidth()-this.img.naturalWidth,y:this.$target.outerHeight()-this.img.naturalHeight,};}
[width,height]=[parseInt(width),parseInt(height)];return{x:this.$target.outerWidth()-(width||(height*this.img.naturalWidth/this.img.naturalHeight)),y:this.$target.outerHeight()-(height||(width*this.img.naturalHeight/this.img.naturalWidth)),};}
const renderRatio=Math.max(this.$target.outerWidth()/this.img.naturalWidth,this.$target.outerHeight()/this.img.naturalHeight);return{x:this.$target.outerWidth()-Math.round(renderRatio*this.img.naturalWidth),y:this.$target.outerHeight()-Math.round(renderRatio*this.img.naturalHeight),};},_onDragBackgroundStart:function(ev){ev.preventDefault();this.$bgDragger.addClass('o_we_grabbing');const $document=$(this.ownerDocument);$document.on('mousemove.bgposition',this._onDragBackgroundMove.bind(this));$document.one('mouseup',()=>{this.$bgDragger.removeClass('o_we_grabbing');$document.off('mousemove.bgposition');});},_onDragBackgroundMove:function(ev){ev.preventDefault();const delta=this._getBackgroundDelta();this.currentPosition.left=clamp(this.currentPosition.left+ev.originalEvent.movementX,[0,delta.x]);this.currentPosition.top=clamp(this.currentPosition.top+ev.originalEvent.movementY,[0,delta.y]);const percentPosition={left:this.currentPosition.left/delta.x*100,top:this.currentPosition.top/delta.y*100,};percentPosition.left=isFinite(percentPosition.left)?percentPosition.left:this.originalPosition.left;percentPosition.top=isFinite(percentPosition.top)?percentPosition.top:this.originalPosition.top;this.$bgDragger.css('background-position',`${percentPosition.left}% ${percentPosition.top}%`);function clamp(val,bounds){bounds=bounds.sort();return Math.max(bounds[0],Math.min(val,bounds[1]));}},_onDocumentClicked:function(ev){if(!ev.target.closest('.o_we_background_position_overlay')){this._toggleBgOverlay(false);}},});registry.ColoredLevelBackground=registry.BackgroundToggler.extend({start:function(){this._markColorLevel();return this._super(...arguments);},onBuilt:function(){this._markColorLevel();},_markColorLevel:function(){this.$target.addClass('o_colored_level');},});registry.many2one=SnippetOptionWidget.extend({xmlDependencies:['/web_editor/static/src/xml/snippets.xml'],start:function(){var self=this;this.trigger_up('getRecordInfo',_.extend(this.options,{callback:function(recordInfo){_.defaults(self.options,recordInfo);},}));this.Model=this.$target.data('oe-many2one-model');this.ID=+this.$target.data('oe-many2one-id');this.$btn=$(qweb.render('web_editor.many2one.button')).prependTo(this.$el);this.$ul=this.$btn.find('ul');this.$search=this.$ul.find('li:first');this.$search.find('input').on('mousedown click mouseup keyup keydown',function(e){e.stopPropagation();});setTimeout(function(){self.$btn.find('a').on('click',function(e){self._clear();});},0);this.$search.find('input').focus().on('keyup',function(e){self.$overlay.removeClass('o_overlay_hidden');self._findExisting($(this).val());});this.$ul.on('click','li:not(:first) a',function(e){self._selectRecord($(e.currentTarget));});return this._super.apply(this,arguments);},onFocus:function(){this.$target.attr('contentEditable','false');this._clear();},_clear:function(){var self=this;this.$search.siblings().remove();self.$search.find('input').val('');setTimeout(function(){self.$search.find('input').focus();},0);},_findExisting:function(name){var self=this;var domain=[];if(!name||!name.length){self.$search.siblings().remove();return;}
if(isNaN(+name)){if(this.Model!=='res.partner'){domain.push(['name','ilike',name]);}else{domain.push('|',['name','ilike',name],['email','ilike',name]);}}else{domain.push(['id','=',name]);}
return this._rpc({model:this.Model,method:'search_read',args:[domain,this.Model==='res.partner'?['name','display_name','city','country_id']:['name','display_name']],kwargs:{order:[{name:'name',asc:false}],limit:5,context:this.options.context,},}).then(function(result){self.$search.siblings().remove();self.$search.after(qweb.render('web_editor.many2one.search',{contacts:result}));});},_selectRecord:function($li){var self=this;this.ID=+$li.data('id');this.$target.attr('data-oe-many2one-id',this.ID).data('oe-many2one-id',this.ID);this.trigger_up('request_history_undo_record',{$target:this.$target});this.$target.trigger('content_changed');if(self.$target.data('oe-type')==='contact'){$('[data-oe-contact-options]').filter('[data-oe-model="'+self.$target.data('oe-model')+'"]').filter('[data-oe-id="'+self.$target.data('oe-id')+'"]').filter('[data-oe-field="'+self.$target.data('oe-field')+'"]').filter('[data-oe-contact-options!="'+self.$target.data('oe-contact-options')+'"]').add(self.$target).attr('data-oe-many2one-id',self.ID).data('oe-many2one-id',self.ID).each(function(){var $node=$(this);var options=$node.data('oe-contact-options');self._rpc({model:'ir.qweb.field.contact',method:'get_record_to_html',args:[[self.ID]],kwargs:{options:options,context:self.options.context,},}).then(function(html){$node.html(html);});});}else{self.$target.html($li.data('name'));}
this._clear();}});registry.VersionControl=SnippetOptionWidget.extend({xmlDependencies:['/web_editor/static/src/xml/snippets.xml'],start:function(){this.trigger_up('get_snippet_versions',{snippetName:this.$target[0].dataset.snippet,onSuccess:snippetVersions=>{const isUpToDate=snippetVersions&&['vjs','vcss','vxml'].every(key=>this.$target[0].dataset[key]===snippetVersions[key]);if(!isUpToDate){this.$el.prepend(qweb.render('web_editor.outdated_block_message'));}},});return this._super(...arguments);},});registry.SnippetSave=SnippetOptionWidget.extend({xmlDependencies:['/web_editor/static/src/xml/editor.xml'],isTopOption:true,saveSnippet:function(previewMode,widgetValue,params){return new Promise(resolve=>{const dialog=new Dialog(this,{title:_t("Save Your Block"),size:'small',$content:$(qweb.render('web_editor.dialog.save_snippet',{currentSnippetName:_.str.sprintf(_t("Custom %s"),this.data.snippetName),})),buttons:[{text:_t("Save"),classes:'btn-primary',close:true,click:async()=>{const save=await new Promise(resolve=>{Dialog.confirm(this,_t("To save a snippet, we need to save all your previous modifications and reload the page."),{buttons:[{text:_t("Save and Reload"),classes:'btn-primary',close:true,click:()=>resolve(true),},{text:_t("Cancel"),close:true,click:()=>resolve(false),}]});});if(!save){return;}
const snippetKey=this.$target[0].dataset.snippet;let thumbnailURL;this.trigger_up('snippet_thumbnail_url_request',{key:snippetKey,onSuccess:url=>thumbnailURL=url,});let context;this.trigger_up('context_get',{callback:ctx=>context=ctx,});this.trigger_up('request_save',{reloadEditor:true,onSuccess:async()=>{const snippetName=dialog.el.querySelector('.o_we_snippet_name_input').value;const targetCopyEl=this.$target[0].cloneNode(true);delete targetCopyEl.dataset.name;await rpc.query({model:'ir.ui.view',method:'save_snippet',kwargs:{'name':snippetName,'arch':targetCopyEl.outerHTML,'template_key':this.options.snippets,'snippet_key':snippetKey,'thumbnail_url':thumbnailURL,'context':context,},});},});},},{text:_t("Discard"),close:true,}],}).open();dialog.on('closed',this,()=>resolve());});},});registry.DynamicSvg=SnippetOptionWidget.extend({start(){this.$target.on('image_changed.DynamicSvg',this._onImageChanged.bind(this));return this._super(...arguments);},destroy(){this.$target.off('.DynamicSvg');return this._super(...arguments);},async color(previewMode,widgetValue,params){const target=this.$target[0];switch(previewMode){case true:this.previousSrc=target.getAttribute('src');break;case'reset':target.src=this.previousSrc;return;}
const newURL=new URL(target.src,window.location.origin);newURL.searchParams.set('c1',normalizeColor(widgetValue));const src=newURL.pathname+newURL.search;await loadImage(src);target.src=src;if(!previewMode){this.previousSrc=src;}},_computeWidgetState(methodName,params){switch(methodName){case'color':return new URL(this.$target[0].src,window.location.origin).searchParams.get('c1');}
return this._super(...arguments);},_computeVisibility(methodName,params){return this.$target.is("img[src^='/web_editor/shape/']");},_onImageChanged(methodName,params){return this.updateUI();},});return{SnippetOptionWidget:SnippetOptionWidget,snippetOptionRegistry:registry,NULL_ID:NULL_ID,UserValueWidget:UserValueWidget,userValueWidgetsRegistry:userValueWidgetsRegistry,UnitUserValueWidget:UnitUserValueWidget,addTitleAndAllowedAttributes:_addTitleAndAllowedAttributes,buildElement:_buildElement,buildTitleElement:_buildTitleElement,buildRowElement:_buildRowElement,buildCollapseElement:_buildCollapseElement,Class:SnippetOptionWidget,registry:registry,};});;

/* /web_editor/static/lib/jabberwock/jabberwock.js defined in bundle 'web.qunit_suite_tests' */
;

/* /web_editor/static/src/js/wysiwyg/wysiwyg_translate_attributes.js defined in bundle 'web.qunit_suite_tests' */
;

/* /web_editor/static/src/js/wysiwyg/wysiwyg.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.wysiwyg',function(require){'use strict';var Widget=require('web.Widget');var SummernoteManager=require('web_editor.rte.summernote');var summernoteCustomColors=require('web_editor.rte.summernote_custom_colors');var id=0;var Wysiwyg=Widget.extend({xmlDependencies:[],defaultOptions:{'focus':false,'toolbar':[['style',['style']],['font',['bold','italic','underline','clear']],['fontsize',['fontsize']],['color',['color']],['para',['ul','ol','paragraph']],['table',['table']],['insert',['link','picture']],['history',['undo','redo']],],'styleWithSpan':false,'inlinemedia':['p'],'lang':'odoo','colors':summernoteCustomColors,recordInfo:{context:{},},},init:function(parent,options){this._super.apply(this,arguments);this.id=++id;this.options=options;},willStart:function(){this._summernoteManager=new SummernoteManager(this);this.$target=this.$el;return this._super();},start:function(){this.$target.wrap('<odoo-wysiwyg-container>');this.$el=this.$target.parent();var options=this._editorOptions();this.$target.summernote(options);this.$editor=this.$('.note-editable:first');this.$editor.data('wysiwyg',this);this.$editor.data('oe-model',options.recordInfo.res_model);this.$editor.data('oe-id',options.recordInfo.res_id);$(document).on('mousedown',this._blur);this._value=this.$target.html()||this.$target.val();return this._super.apply(this,arguments);},destroy:function(){$(document).off('mousedown',this._blur);if(this.$target&&this.$target.is('textarea')&&this.$target.next('.note-editor').length){this.$target.summernote('destroy');}
this._super();},getEditable:function(){return this.$editor;},isDirty:function(){return this._value!==(this.$editor.html()||this.$editor.val());},focus:function(){console.log('focus');},getValue:function(options){var $editable=options&&options.$layout||this.$editor.clone();$editable.find('[contenteditable]').removeAttr('contenteditable');$editable.find('[class=""]').removeAttr('class');$editable.find('[style=""]').removeAttr('style');$editable.find('[title=""]').removeAttr('title');$editable.find('[alt=""]').removeAttr('alt');$editable.find('[data-original-title=""]').removeAttr('data-original-title');$editable.find('a.o_image, span.fa, i.fa').html('');$editable.find('[aria-describedby]').removeAttr('aria-describedby').removeAttr('data-original-title');return $editable.html();},save:function(){var isDirty=this.isDirty();var html=this.getValue();if(this.$target.is('textarea')){this.$target.val(html);}else{this.$target.html(html);}
return Promise.resolve({isDirty:isDirty,html:html});},saveModifiedImages:function($editable){return this._summernoteManager.saveModifiedImages($editable);},setValue:function(value,options){if(this.$editor.is('textarea')){this.$target.val(value);}else{this.$target.html(value);}
this.$editor.html(value);},_editorOptions:function(){var self=this;var options=Object.assign({},$.summernote.options,this.defaultOptions,this.options);if(this.options.generateOptions){options=this.options.generateOptions(options);}
options.airPopover=options.toolbar;options.onChange=function(html,$editable){$editable.trigger('content_changed');self.trigger_up('wysiwyg_change');};options.onUpload=function(attachments){self.trigger_up('wysiwyg_attachment',attachments);};options.onFocus=function(){self.trigger_up('wysiwyg_focus');};options.onBlur=function(){self.trigger_up('wysiwyg_blur');};return options;},});Wysiwyg.getRange=function(node){var range=$.summernote.core.range.create();return range&&{sc:range.sc,so:range.so,ec:range.ec,eo:range.eo,};};Wysiwyg.setRange=function(startNode,startOffset,endNode,endOffset){$(startNode).focus();if(endNode){$.summernote.core.range.create(startNode,startOffset,endNode,endOffset).select();}else{$.summernote.core.range.create(startNode,startOffset).select();}
$(startNode.tagName?startNode:startNode.parentNode).trigger('wysiwyg.range');};Wysiwyg.setRangeFromNode=function(node,options){var last=node;while(last.lastChild){last=last.lastChild;}
var first=node;while(first.firstChild){first=first.firstChild;}
if(options&&options.begin&&!options.end){Wysiwyg.setRange(first,0);}else if(options&&!options.begin&&options.end){Wysiwyg.setRange(last,last.textContent.length);}else{Wysiwyg.setRange(first,0,last,last.tagName?last.childNodes.length:last.textContent.length);}};return Wysiwyg;});odoo.define('web_editor.widget',function(require){'use strict';return{Dialog:require('wysiwyg.widgets.Dialog'),MediaDialog:require('wysiwyg.widgets.MediaDialog'),LinkDialog:require('wysiwyg.widgets.LinkDialog'),};});;

/* /web_editor/static/src/js/wysiwyg/wysiwyg_snippets.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.wysiwyg.snippets',function(require){'use strict';var editor=require('web_editor.editor');var Wysiwyg=require('web_editor.wysiwyg');Wysiwyg.include({init:function(parent,options){this._super.apply(this,arguments);this.Editor=editor.Class;if(!this.options.toolbarHandler){this.options.toolbarHandler=$('#web_editor-top-edit');}},start:async function(){if(this.options.snippets){var self=this;this.editor=new(this.Editor)(this,this.options);this.$editor=this.editor.rte.editable();const $body=this.$editor[0]?this.$editor[0].ownerDocument.body:document.body;await this.editor.prependTo($body);this._relocateEditorBar();this.$el.on('content_changed',function(e){self.trigger_up('wysiwyg_change');});}else{return this._super();}},_relocateEditorBar:function(){if(!this.options.toolbarHandler.length){this.options.toolbarHandler=$('.o_we_snippet_text_tools');}
this.options.toolbarHandler.append(this.editor.$el);if(this.editor.snippetsMenu&&!this.editor.snippetsMenu.$el.has(this.options.toolbarHandler).length){this.editor.snippetsMenu.$el.insertAfter(this.options.toolbarHandler);this.editor.snippetsMenu.$snippetEditorArea.insertAfter(this.editor.snippetsMenu.$el);}},});});;

/* /web_editor/static/src/js/wysiwyg/wysiwyg_iframe.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.wysiwyg.iframe',function(require){'use strict';var Wysiwyg=require('web_editor.wysiwyg');var ajax=require('web.ajax');var core=require('web.core');var config=require('web.config');var qweb=core.qweb;var promiseCommon;var promiseWysiwyg;Wysiwyg.include({init:function(parent,options){this._super.apply(this,arguments);if(this.options.inIframe){this._onUpdateIframeId='onLoad_'+this.id;}
this.__extraAssetsForIframe=[];},willStart:function(){if(!this.options.inIframe){return this._super();}
var defAsset;if(this.options.iframeCssAssets){defAsset=ajax.loadAsset(this.options.iframeCssAssets);}else{defAsset=Promise.resolve({cssLibs:[],cssContents:[]});}
promiseWysiwyg=promiseWysiwyg||ajax.loadAsset('web_editor.wysiwyg_iframe_editor_assets');this.defAsset=Promise.all([promiseWysiwyg,defAsset]);this.$target=this.$el;return this.defAsset.then(this._loadIframe.bind(this)).then(this._super.bind(this));},_loadIframe:function(){var self=this;this.$iframe=$('<iframe class="wysiwyg_iframe">').css({'min-height':'55vh',width:'100%'});var avoidDoubleLoad=0;var def=new Promise(function(resolve){window.top[self._onUpdateIframeId]=function(Editor,_avoidDoubleLoad){if(_avoidDoubleLoad!==avoidDoubleLoad){console.warn('Wysiwyg iframe double load detected');return;}
delete window.top[self._onUpdateIframeId];var $iframeTarget=self.$iframe.contents().find('#iframe_target');$iframeTarget.attr("isMobile",config.device.isMobile);$iframeTarget.find('.o_editable').html(self.$target.val());self.options.toolbarHandler=$('#web_editor-top-edit',self.$iframe[0].contentWindow.document);$(qweb.render('web_editor.FieldTextHtml.fullscreen')).appendTo(self.options.toolbarHandler).on('click','.o_fullscreen',function(){$("body").toggleClass("o_field_widgetTextHtml_fullscreen");var full=$("body").hasClass("o_field_widgetTextHtml_fullscreen");self.$iframe.parents().toggleClass('o_form_fullscreen_ancestor',full);$(window).trigger("resize");});self.Editor=Editor;resolve();};});this.$iframe.data('loadDef',def);this.$iframe.on('load',function onLoad(ev){var _avoidDoubleLoad=++avoidDoubleLoad;self.defAsset.then(function(assets){if(_avoidDoubleLoad!==avoidDoubleLoad){console.warn('Wysiwyg immediate iframe double load detected');return;}
var iframeContent=qweb.render('wysiwyg.iframeContent',{assets:assets.concat(self.__extraAssetsForIframe),updateIframeId:self._onUpdateIframeId,avoidDoubleLoad:_avoidDoubleLoad});self.$iframe[0].contentWindow.document.open("text/html","replace").write(iframeContent);});});this.$iframe.insertAfter(this.$target);return def;},});});;

/* /web_unsplash/static/src/js/unsplashapi.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('unsplash.api',function(require){'use strict';var Class=require('web.Class');var rpc=require('web.rpc');var Mixins=require('web.mixins');var ServicesMixin=require('web.ServicesMixin');var UnsplashCore=Class.extend(Mixins.EventDispatcherMixin,ServicesMixin,{init:function(parent){Mixins.EventDispatcherMixin.init.call(this,arguments);this.setParent(parent);this._cache={};this.clientId=false;},getImages:function(query,pageSize){var from=0;var to=pageSize;var cachedData=this._cache[query];if(cachedData&&(cachedData.images.length>=to||(cachedData.totalImages!==0&&cachedData.totalImages<to))){return Promise.resolve({images:cachedData.images.slice(from,to),isMaxed:to>cachedData.totalImages});}
return this._fetchImages(query).then(function(cachedData){return{images:cachedData.images.slice(from,to),isMaxed:to>cachedData.totalImages};});},_fetchImages:function(query){if(!this._cache[query]){this._cache[query]={images:[],maxPages:0,totalImages:0,pageCached:0};}
var cachedData=this._cache[query];var payload={query:query,page:cachedData.pageCached+1,per_page:30,};return this._rpc({route:'/web_unsplash/fetch_images',params:payload,}).then(function(result){if(result.error){return Promise.reject(result.error);}
cachedData.pageCached++;cachedData.images.push.apply(cachedData.images,result.results);cachedData.maxPages=result.total_pages;cachedData.totalImages=result.total;return cachedData;});},});return UnsplashCore;});;

/* /web_unsplash/static/src/js/unsplash_image_widget.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_unsplash.image_widgets',function(require){'use strict';var core=require('web.core');var UnsplashAPI=require('unsplash.api');var widgetsMedia=require('wysiwyg.widgets.media');var unsplashAPI=null;const originalEvents=widgetsMedia.ImageWidget.prototype.events;const clickHandler=originalEvents['click .o_existing_attachment_cell'];if(!clickHandler){throw new Error(`Couldn't find a handler for o_existing_attachment_cell clicks.
The unsplash image widget needs to prevent this handler from executing on unsplash attachments.`);}
_.extend(originalEvents,{'click .o_existing_attachment_cell:not(.o_unsplash_attachment_cell)':clickHandler,});delete originalEvents['click .o_existing_attachment_cell'];widgetsMedia.ImageWidget.include({xmlDependencies:widgetsMedia.ImageWidget.prototype.xmlDependencies.concat(['/web_unsplash/static/src/xml/unsplash_image_widget.xml']),events:_.extend({},widgetsMedia.ImageWidget.prototype.events,{'click .o_unsplash_attachment_cell[data-imgid]':'_onUnsplashImgClick','click button.save_unsplash':'_onSaveUnsplashCredentials',}),init:function(){this._super.apply(this,arguments);this._unsplash={selectedImages:{},isMaxed:false,query:false,error:false,records:[],};if(unsplashAPI===null){this.unsplashAPI=new UnsplashAPI(this);unsplashAPI=this.unsplashAPI;}else{this.unsplashAPI=unsplashAPI;this.unsplashAPI.setParent(this);}},destroy:function(){this.unsplashAPI.setParent(undefined);this._super.apply(this,arguments);},_save:async function(){const _super=this._super;if(Object.keys(this._unsplash.selectedImages).length){this.saved=true;const images=await this._rpc({route:'/web_unsplash/attachment/add',params:{unsplashurls:this._unsplash.selectedImages,res_model:this.options.res_model,res_id:this.options.res_id,query:this._unsplash.query,},});this.attachments.push(...images);this.selectedAttachments.push(...images);}
return _super.apply(this,arguments);},search:async function(needle){var self=this;await this._super(...arguments);this._unsplash.query=needle;if(!needle){this._unsplash.records=[];return;}
await this.unsplashAPI.getImages(needle,this.numberOfAttachmentsToDisplay).then(function(res){self._unsplash.isMaxed=res.isMaxed;self._unsplash.records=res.images;self._unsplash.error=false;},function(err){self._unsplash.error=err;});},hasContent(){if(this.searchService==='all'){return this._super(...arguments)||(this.unsplashRecords&&this.unsplashRecords.length);}else if(this.searchService==='unsplash'){return(this.unsplashRecords&&this.unsplashRecords.length);}
return this._super(...arguments);},_highlightSelected:function(){this._super.apply(this,arguments);const $select=this.$('.o_unsplash_attachment_cell[data-imgid]').filter((i,el)=>{return $(el).data('imgid')in this._unsplash.selectedImages;}).addClass('o_we_attachment_selected');return $select;},_loadMoreImages:function(forceSearch){if(!this.$('.o_we_search').val()){return this._super(forceSearch);}
this.numberOfAttachmentsToDisplay+=10;this.search(this.$('.o_we_search').val()).then(()=>this._renderThumbnails());},_renderThumbnails:function(){this._super(...arguments);this.$('.unsplash_error').empty();if(!['all','unsplash'].includes(this.searchService)){return;}
if(this._unsplash.query&&this._unsplash.error){this.$('.unsplash_error').html(core.qweb.render('web_unsplash.dialog.error.content',{status:this._unsplash.error,}));return;}
if(['all','unsplash'].includes(this.searchService)&&this._unsplash.query&&!this._unsplash.isMaxed){this.$('.o_load_more').removeClass('d-none');this.$('.o_load_done_msg').addClass('d-none');}},_renderExisting:function(attachments){this.unsplashRecords=this._unsplash.records.map(record=>{const url=new URL(record.urls.regular);url.searchParams.set('h',2*this.MIN_ROW_HEIGHT);url.searchParams.delete('w');return Object.assign({},record,{url:url.toString(),});});return this._super(...arguments);},_selectAttachement:function(attachment,save){if(!this.options.multiImages){this._unsplash.selectedImages={};}
this._super(...arguments);},_onSaveUnsplashCredentials:function(){var self=this;var key=this.$('#accessKeyInput').val().trim();var appId=this.$('#appIdInput').val().trim();this.$('#accessKeyInput').toggleClass('is-invalid',!key);this.$('#appIdInput').toggleClass('is-invalid',!appId);if(key&&appId){if(!this.$el.find('.is-invalid').length){this._rpc({route:'/web_unsplash/save_unsplash',params:{key:key,appId:appId},}).then(function(){self.unsplashAPI.clientId=key;self._unsplash.error=false;self.search(self._unsplash.query).then(()=>self._renderThumbnails());});}}},_onUnsplashImgClick:function(ev){if(this.saved){return;}
const{imgid,url,downloadUrl,description}=ev.currentTarget.dataset;if(!this.options.multiImages){this._unsplash.selectedImages={};this.selectedAttachments=[];}
if(imgid in this._unsplash.selectedImages){delete this._unsplash.selectedImages[imgid];}else{const _1920Url=new URL(url);_1920Url.searchParams.set('w','1920');this._unsplash.selectedImages[imgid]={url:_1920Url.href,download_url:downloadUrl,description:description};}
this._highlightSelected();if(!this.options.multiImages){this.trigger_up('save_request');}},});});;

/* /web_editor/static/tests/test_utils.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.test_utils',function(require){"use strict";var ajax=require('web.ajax');var MockServer=require('web.MockServer');var testUtils=require('web.test_utils');var Widget=require('web.Widget');var Wysiwyg=require('web_editor.wysiwyg');var options=require('web_editor.snippets.options');const COLOR_PICKER_TEMPLATE=`
    <t t-name="web_editor.colorpicker">
        <colorpicker>
            <div class="o_colorpicker_section" data-name="theme" data-display="Theme Colors" data-icon-class="fa fa-flask">
                <button data-color="o-color-1"/>
                <button data-color="o-color-2"/>
                <button data-color="o-color-3"/>
                <button data-color="o-color-4"/>
                <button data-color="o-color-5"/>
            </div>
            <div class="o_colorpicker_section" data-name="transparent_grayscale" data-display="Transparent Colors" data-icon-class="fa fa-eye-slash">
                <button class="o_btn_transparent"/>
                <button data-color="black-25"/>
                <button data-color="black-50"/>
                <button data-color="black-75"/>
                <button data-color="white-25"/>
                <button data-color="white-50"/>
                <button data-color="white-75"/>
            </div>
            <div class="o_colorpicker_section" data-name="common" data-display="Common Colors" data-icon-class="fa fa-paint-brush"/>
        </colorpicker>
    </t>`;const SNIPPETS_TEMPLATE=`
    <h2 id="snippets_menu">Add blocks</h2>
    <div id="o_scroll">
        <div id="snippet_structure" class="o_panel">
            <div class="o_panel_header">First Panel</div>
            <div class="o_panel_body">
                <div name="Separator" data-oe-type="snippet" data-oe-thumbnail="/website/static/src/img/snippets_thumbs/s_separator.png">
                    <div class="s_hr pt32 pb32">
                        <hr class="s_hr_1px s_hr_solid w-100 mx-auto"/>
                    </div>
                </div>
                <div name="Content" data-oe-type="snippet" data-oe-thumbnail="/website/static/src/img/snippets_thumbs/s_text_block.png">
                    <section name="Content+Options" class="test_option_all pt32 pb32" data-oe-type="snippet" data-oe-thumbnail="/website/static/src/img/snippets_thumbs/s_text_block.png">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-10 offset-lg-1 pt32 pb32">
                                    <h2>Title</h2>
                                    <p class="lead o_default_snippet_text">Content</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
    <div id="snippet_options" class="d-none">
        <div data-js="many2one" data-selector="[data-oe-many2one-model]:not([data-oe-readonly])" data-no-check="true"/>
        <div data-js="content"
            data-selector=".s_hr, .test_option_all"
            data-drop-in=".note-editable"
            data-drop-near="p, h1, h2, h3, blockquote, .s_hr"/>
        <div data-js="sizing_y" data-selector=".s_hr, .test_option_all"/>
        <div data-selector=".test_option_all">
            <we-colorpicker string="Background Color" data-select-style="true" data-css-property="background-color" data-color-prefix="bg-"/>
        </div>
        <div data-js="BackgroundImage" data-selector=".test_option_all">
            <we-button data-choose-image="true" data-no-preview="true">
                <i class="fa fa-picture-o"/> Background Image
            </we-button>
        </div>
        <div data-js="option_test" data-selector=".s_hr">
            <we-select string="Alignment">
                <we-button data-select-class="align-items-start">Top</we-button>
                <we-button data-select-class="align-items-center">Middle</we-button>
                <we-button data-select-class="align-items-end">Bottom</we-button>
                <we-button data-select-class="align-items-stretch">Equal height</we-button>
            </we-select>
        </div>
    </div>`;MockServer.include({async _performRpc(route,args){if(args.model==="ir.ui.view"){if(args.method==='read_template'&&args.args[0]==="web_editor.colorpicker"){return COLOR_PICKER_TEMPLATE;}
if(args.method==='render_public_asset'&&args.args[0]==="web_editor.snippets"){return SNIPPETS_TEMPLATE;}}
return this._super(...arguments);},});options.registry.option_test=options.Class.extend({cleanForSave:function(){this.$target.addClass('cleanForSave');},onBuilt:function(){this.$target.addClass('built');},onBlur:function(){this.$target.removeClass('focus');},onClone:function(){this.$target.addClass('clone');this.$target.removeClass('focus');},onFocus:function(){this.$target.addClass('focus');},onMove:function(){this.$target.addClass('move');},onRemove:function(){this.$target.closest('.note-editable').addClass('snippet_has_removed');},});var WysiwygTest=Wysiwyg.extend({_parentToDestroyForTest:null,destroy:function(){unpatch();this._super();this.$target.remove();this._parentToDestroyForTest.destroy();},});function patch(){testUtils.mock.patch(ajax,{loadAsset:function(xmlId){if(xmlId==='template.assets'){return Promise.resolve({cssLibs:[],cssContents:['body {background-color: red;}']});}
if(xmlId==='template.assets_all_style'){return Promise.resolve({cssLibs:$('link[href]:not([type="image/x-icon"])').map(function(){return $(this).attr('href');}).get(),cssContents:['body {background-color: red;}']});}
throw'Wrong template';},});}
function unpatch(){testUtils.mock.unpatch(ajax);}
function wysiwygData(data){return _.defaults({},data,{'ir.ui.view':{fields:{display_name:{string:"Displayed name",type:"char",},},records:[],read_template(args){if(args[0]==='web_editor.colorpicker'){return COLOR_PICKER_TEMPLATE;}},render_template(args){if(args[0]==='web_editor.snippets'){return SNIPPETS_TEMPLATE;}},},'ir.attachment':{fields:{display_name:{string:"display_name",type:'char',},description:{string:"description",type:'char',},mimetype:{string:"mimetype",type:'char',},checksum:{string:"checksum",type:'char',},url:{string:"url",type:'char',},type:{string:"type",type:'char',},res_id:{string:"res_id",type:'integer',},res_model:{string:"res_model",type:'char',},public:{string:"public",type:'boolean',},access_token:{string:"access_token",type:'char',},image_src:{string:"image_src",type:'char',},image_width:{string:"image_width",type:'integer',},image_height:{string:"image_height",type:'integer',},original_id:{string:"original_id",type:'many2one',relation:'ir.attachment',},},records:[{id:1,name:'image',description:'',mimetype:'image/png',checksum:false,url:'/web/image/123/transparent.png',type:'url',res_id:0,res_model:false,public:true,access_token:false,image_src:'/web/image/123/transparent.png',image_width:256,image_height:256,}],generate_access_token:function(){return;},},});}
async function createWysiwyg(params){patch();params.data=wysiwygData(params.data);var parent=new Widget();await testUtils.mock.addMockEnvironment(parent,params);var wysiwygOptions=_.extend({},params.wysiwygOptions,{recordInfo:{context:{},res_model:'module.test',res_id:1,},useOnlyTestUnbreakable:params.useOnlyTestUnbreakable,});var wysiwyg=new WysiwygTest(parent,wysiwygOptions);wysiwyg._parentToDestroyForTest=parent;var $textarea=$('<textarea/>');if(wysiwygOptions.value){$textarea.val(wysiwygOptions.value);}
var selector=params.debug?'body':'#qunit-fixture';$textarea.prependTo($(selector));if(params.debug){$('body').addClass('debug');}
return wysiwyg.attachTo($textarea).then(function(){if(wysiwygOptions.snippets){var defSnippets=testUtils.makeTestPromise();testUtils.mock.intercept(wysiwyg,"snippets_loaded",function(){defSnippets.resolve(wysiwyg);});return defSnippets;}
return wysiwyg;});}
var dom=$.summernote.dom;var keyboardMap={"8":"BACKSPACE","9":"TAB","13":"ENTER","16":"SHIFT","17":"CONTROL","18":"ALT","19":"PAUSE","20":"CAPS_LOCK","27":"ESCAPE","32":"SPACE","33":"PAGE_UP","34":"PAGE_DOWN","35":"END","36":"HOME","37":"LEFT","38":"UP","39":"RIGHT","40":"DOWN","45":"INSERT","46":"DELETE","91":"OS_KEY","93":"CONTEXT_MENU",};_.each(_.range(40,127),function(keyCode){if(!keyboardMap[keyCode]){keyboardMap[keyCode]=String.fromCharCode(keyCode);}});var testKeyboard=function($editable,assert,keyboardTests,addTests){var tests=_.compact(_.pluck(keyboardTests,'test'));var testNumber=_.compact(_.pluck(tests,'start')).length+
_.compact(_.pluck(tests,'content')).length+
_.compact(_.pluck(tests,'check')).length+
(addTests|0);assert.expect(testNumber);function keydown(target,keypress){var $target=$(target.tagName?target:target.parentNode);if(!keypress.keyCode){keypress.keyCode=+_.findKey(keyboardMap,function(key){return key===keypress.key;});}else{keypress.key=keyboardMap[keypress.keyCode]||String.fromCharCode(keypress.keyCode);}
keypress.keyCode=keypress.keyCode;var event=$.Event("keydown",keypress);$target.trigger(event);if(!event.isDefaultPrevented()){if(keypress.key.length===1){textInput($target[0],keypress.key);}else{console.warn('Native "'+keypress.key+'" is not supported in test');}}
$target.trigger($.Event("keyup",keypress));return $target;}
function _select(selector){var reDOMSelection=/^(.+?)(:contents(\(\)\[|\()([0-9]+)[\]|\)])?(->([0-9]+))?$/;var sel=selector.match(reDOMSelection);var $node=$editable.find(sel[1]);var point={node:sel[3]?$node.contents()[+sel[4]]:$node[0],offset:sel[5]?+sel[6]:0,};if(!point.node||point.offset>(point.node.tagName?point.node.childNodes:point.node.textContent).length){assert.notOk("Node not found: '"+selector+"' "+(point.node?"(container: '"+(point.node.outerHTML||point.node.textContent)+"')":""));}
return point;}
function selectText(start,end){start=_select(start);var target=start.node;$(target.tagName?target:target.parentNode).trigger("mousedown");if(end){end=_select(end);Wysiwyg.setRange(start.node,start.offset,end.node,end.offset);}else{Wysiwyg.setRange(start.node,start.offset);}
target=end?end.node:start.node;$(target.tagName?target:target.parentNode).trigger('mouseup');}
function endOfAreaBetweenTwoNodes(point){if(!point.node.tagName&&point.offset===point.node.textContent.length&&!/\S|\u00A0/.test(point.node.textContent)){point=dom.nextPoint(dom.nextPoint(point));while(point.node.tagName&&point.node.textContent.length){point=dom.nextPoint(point);}}
return point;}
var defPollTest=Promise.resolve();function pollTest(test){var def=Promise.resolve();$editable.data('wysiwyg').setValue(test.content);function poll(step){var def=testUtils.makeTestPromise();if(step.start){selectText(step.start,step.end);if(!Wysiwyg.getRange($editable[0])){throw'Wrong range! \n'+'Test: '+test.name+'\n'+'Selection: '+step.start+'" to "'+step.end+'"\n'+'DOM: '+$editable.html();}}
setTimeout(function(){if(step.keyCode||step.key){var target=Wysiwyg.getRange($editable[0]).ec;if(window.location.search.indexOf('notrycatch')!==-1){keydown(target,{key:step.key,keyCode:step.keyCode,ctrlKey:!!step.ctrlKey,shiftKey:!!step.shiftKey,altKey:!!step.altKey,metaKey:!!step.metaKey,});}else{try{keydown(target,{key:step.key,keyCode:step.keyCode,ctrlKey:!!step.ctrlKey,shiftKey:!!step.shiftKey,altKey:!!step.altKey,metaKey:!!step.metaKey,});}catch(e){assert.notOk(e.name+'\n\n'+e.stack,test.name);}}}
setTimeout(function(){if(step.keyCode||step.key){var $target=$(target.tagName?target:target.parentNode);$target.trigger($.Event('keyup',{key:step.key,keyCode:step.keyCode,ctrlKey:!!step.ctrlKey,shiftKey:!!step.shiftKey,altKey:!!step.altKey,metaKey:!!step.metaKey,}));}
setTimeout(def.resolve.bind(def));});});return def;}
while(test.steps.length){def=def.then(poll.bind(null,test.steps.shift()));}
return def.then(function(){if(!test.test){return;}
if(test.test.check){test.test.check($editable,assert);}
if(test.test.content){var value=$editable.data('wysiwyg').getValue({keepPopover:true,});var allInvisible=/\u200B/g;value=value.replace(allInvisible,'&#8203;');var result=test.test.content.replace(allInvisible,'&#8203;');assert.strictEqual(value,result,test.name);if(test.test.start&&value!==result){assert.notOk("Wrong DOM (see previous assert)",test.name+" (carret position)");return;}}
$editable[0].normalize();if(test.test.start){var start=_select(test.test.start);var range=Wysiwyg.getRange($editable[0]);if((range.sc!==range.ec||range.so!==range.eo)&&!test.test.end){assert.ok(false,test.name+": the carret is not colapsed and the 'end' selector in test is missing");return;}
var end=test.test.end?_select(test.test.end):start;if(start.node&&end.node){range=Wysiwyg.getRange($editable[0]);var startPoint=endOfAreaBetweenTwoNodes({node:range.sc,offset:range.so,});var endPoint=endOfAreaBetweenTwoNodes({node:range.ec,offset:range.eo,});var sameDOM=(startPoint.node.outerHTML||startPoint.node.textContent)===(start.node.outerHTML||start.node.textContent);var stringify=function(obj){if(!sameDOM){delete obj.sameDOMsameNode;}
return JSON.stringify(obj,null,2).replace(/"([^"\s-]+)":/g,"\$1:").replace(/([^\\])"/g,"\$1'").replace(/\\"/g,'"');};assert.deepEqual(stringify({startNode:startPoint.node.outerHTML||startPoint.node.textContent,startOffset:startPoint.offset,endPoint:endPoint.node.outerHTML||endPoint.node.textContent,endOffset:endPoint.offset,sameDOMsameNode:sameDOM&&startPoint.node===start.node,}),stringify({startNode:start.node.outerHTML||start.node.textContent,startOffset:start.offset,endPoint:end.node.outerHTML||end.node.textContent,endOffset:end.offset,sameDOMsameNode:true,}),test.name+" (carret position)");}}});}
while(keyboardTests.length){defPollTest=defPollTest.then(pollTest.bind(null,keyboardTests.shift()));}
return defPollTest;};var select=(function(){var __select=function(selector,$editable){var sel=selector.match(/^(.+?)(:contents\(\)\[([0-9]+)\]|:contents\(([0-9]+)\))?(->([0-9]+))?$/);var $node=$editable.find(sel[1]);return{node:sel[2]?$node.contents()[sel[3]?+sel[3]:+sel[4]]:$node[0],offset:sel[5]?+sel[6]:0,};};return function(startSelector,endSelector,$editable){var start=__select(startSelector,$editable);var end=endSelector?__select(endSelector,$editable):start;return{sc:start.node,so:start.offset,ec:end.node,eo:end.offset,};};})();var keydown=function(key,$editable,options){var keyPress={};if(typeof key==='string'){keyPress.key=key;keyPress.keyCode=+_.findKey(keyboardMap,function(k){return k===key;});}else{keyPress.key=keyboardMap[key]||String.fromCharCode(key);keyPress.keyCode=key;}
var range=Wysiwyg.getRange($editable[0]);if(!range){console.error("Editor have not any range");return;}
if(options&&options.firstDeselect){range.sc=range.ec;range.so=range.eo;Wysiwyg.setRange(range.sc,range.so,range.ec,range.eo);}
var target=range.ec;var $target=$(target.tagName?target:target.parentNode);var event=$.Event("keydown",keyPress);$target.trigger(event);if(!event.isDefaultPrevented()){if(keyPress.key.length===1){textInput($target[0],keyPress.key);}else{console.warn('Native "'+keyPress.key+'" is not supported in test');}}};var textInput=function(target,char){var ev=new CustomEvent('textInput',{bubbles:true,cancelBubble:false,cancelable:true,composed:true,data:char,defaultPrevented:false,detail:0,eventPhase:3,isTrusted:true,returnValue:true,sourceCapabilities:null,type:"textInput",which:0,});ev.data=char;target.dispatchEvent(ev);if(!ev.defaultPrevented){document.execCommand("insertText",0,ev.data);}};return{wysiwygData:wysiwygData,createWysiwyg:createWysiwyg,testKeyboard:testKeyboard,select:select,keydown:keydown,patch:patch,unpatch:unpatch,};});;

/* /web_editor/static/tests/field_html_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_editor.field_html_tests',function(require){"use strict";var ajax=require('web.ajax');var FormView=require('web.FormView');var testUtils=require('web.test_utils');var weTestUtils=require('web_editor.test_utils');var core=require('web.core');var Wysiwyg=require('web_editor.wysiwyg');var MediaDialog=require('wysiwyg.widgets.MediaDialog');var _t=core._t;QUnit.module('web_editor',{},function(){QUnit.module('field html',{beforeEach:function(){this.data=weTestUtils.wysiwygData({'note.note':{fields:{display_name:{string:"Displayed name",type:"char"},header:{string:"Header",type:"html",required:true,},body:{string:"Message",type:"html"},},records:[{id:1,display_name:"first record",header:"<p>  &nbsp;&nbsp;  <br>   </p>",body:"<p>toto toto toto</p><p>tata</p>",}],},'mass.mailing':{fields:{display_name:{string:"Displayed name",type:"char"},body_html:{string:"Message Body inline (to send)",type:"html"},body_arch:{string:"Message Body for edition",type:"html"},},records:[{id:1,display_name:"first record",body_html:"<div class='field_body' style='background-color: red;'>yep</div>",body_arch:"<div class='field_body'>yep</div>",}],},"ir.translation":{fields:{lang_code:{type:"char"},value:{type:"char"},res_id:{type:"integer"}},records:[{id:99,res_id:12,value:'',lang_code:'en_US'}]},});testUtils.mock.patch(ajax,{loadAsset:function(xmlId){if(xmlId==='template.assets'){return Promise.resolve({cssLibs:[],cssContents:['body {background-color: red;}']});}
if(xmlId==='template.assets_all_style'){return Promise.resolve({cssLibs:$('link[href]:not([type="image/x-icon"])').map(function(){return $(this).attr('href');}).get(),cssContents:['body {background-color: red;}']});}
throw'Wrong template';},});},afterEach:function(){testUtils.mock.unpatch(ajax);},},function(){QUnit.module('basic');QUnit.test('simple rendering',async function(assert){assert.expect(3);var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form>'+'<field name="body" widget="html" style="height: 100px"/>'+'</form>',res_id:1,});var $field=form.$('.oe_form_field[name="body"]');assert.strictEqual($field.children('.o_readonly').html(),'<p>toto toto toto</p><p>tata</p>',"should have rendered a div with correct content in readonly");assert.strictEqual($field.attr('style'),'height: 100px',"should have applied the style correctly");await testUtils.form.clickEdit(form);await testUtils.nextTick();$field=form.$('.oe_form_field[name="body"]');assert.strictEqual($field.find('.note-editable').html(),'<p>toto toto toto</p><p>tata</p>',"should have rendered the field correctly in edit");form.destroy();});QUnit.test('check if required field is set',async function(assert){assert.expect(1);var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form>'+'<field name="header" widget="html" style="height: 100px" />'+'</form>',res_id:1,});testUtils.mock.intercept(form,'call_service',function(ev){if(ev.data.service==='notification'){assert.deepEqual(ev.data.args[0],{"className":undefined,"message":"<ul><li>Header</li></ul>","sticky":undefined,"title":"Invalid fields:","type":"danger"});}},true);await testUtils.form.clickEdit(form);await testUtils.nextTick();await testUtils.dom.click(form.$('.o_form_button_save'));form.destroy();});QUnit.test('colorpicker',async function(assert){assert.expect(6);var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form>'+'<field name="body" widget="html" style="height: 100px"/>'+'</form>',res_id:1,});const rootWidget=odoo.__DEBUG__.services['root.widget'];odoo.__DEBUG__.services['root.widget']=form.getParent();await testUtils.form.clickEdit(form);var $field=form.$('.oe_form_field[name="body"]');var pText=$field.find('.note-editable p').first().contents()[0];Wysiwyg.setRange(pText,1,pText,10);var range=Wysiwyg.getRange($field[0]);assert.strictEqual(range.sc,pText,"should select the text");async function openColorpicker(selector){const $colorpicker=$field.find(selector);const openingProm=new Promise(resolve=>{$colorpicker.one('shown.bs.dropdown',()=>resolve());});await testUtils.dom.click($colorpicker.find('button:first'));return openingProm;}
await openColorpicker('.note-toolbar .note-back-color-preview');assert.ok($field.find('.note-back-color-preview').hasClass('show'),"should display the color picker");await testUtils.dom.click($field.find('.note-toolbar .note-back-color-preview .o_we_color_btn[style="background-color:#00FFFF;"]'));assert.ok(!$field.find('.note-back-color-preview').hasClass('show'),"should close the color picker");assert.strictEqual($field.find('.note-editable').html(),'<p>t<font style="background-color: rgb(0, 255, 255);">oto toto&nbsp;</font>toto</p><p>tata</p>',"should have rendered the field correctly in edit");var fontContent=$field.find('.note-editable font').contents()[0];var rangeControl={sc:fontContent,so:0,ec:fontContent,eo:fontContent.length,};range=Wysiwyg.getRange($field[0]);assert.deepEqual(_.pick(range,'sc','so','ec','eo'),rangeControl,"should select the text after color change");pText=$field.find('.note-editable p').first().contents()[2];Wysiwyg.setRange(fontContent,5,pText,2);await openColorpicker('.note-toolbar .note-back-color-preview');await testUtils.dom.click($field.find('.note-toolbar .note-back-color-preview .o_we_color_btn.bg-o-color-3'));assert.strictEqual($field.find('.note-editable').html(),'<p>t<font style="background-color: rgb(0, 255, 255);">oto t</font><font style="" class="bg-o-color-3">oto&nbsp;</font><font class="bg-o-color-3" style="">to</font>to</p><p>tata</p>',"should have rendered the field correctly in edit");odoo.__DEBUG__.services['root.widget']=rootWidget;form.destroy();});QUnit.test('media dialog: image',async function(assert){assert.expect(1);var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form>'+'<field name="body" widget="html" style="height: 100px"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.model==='ir.attachment'){if(args.method==="generate_access_token"){return Promise.resolve();}}
if(route.indexOf('/web/image/123/transparent.png')===0){return Promise.resolve();}
if(route.indexOf('/web_unsplash/fetch_images')===0){return Promise.resolve();}
if(route.indexOf('/web_editor/media_library_search')===0){return Promise.resolve();}
return this._super(route,args);},});await testUtils.form.clickEdit(form);var $field=form.$('.oe_form_field[name="body"]');var defMediaDialog=testUtils.makeTestPromise();testUtils.mock.patch(MediaDialog,{init:function(){this._super.apply(this,arguments);this.opened(defMediaDialog.resolve.bind(defMediaDialog));}});var pText=$field.find('.note-editable p').first().contents()[0];Wysiwyg.setRange(pText,1);await testUtils.dom.click($field.find('.note-toolbar .note-insert button:has(.fa-file-image-o)'));await defMediaDialog;await testUtils.dom.click($('.modal #editor-media-image .o_existing_attachment_cell:first').removeClass('d-none'));var $editable=form.$('.oe_form_field[name="body"] .note-editable');assert.ok($editable.find('img')[0].dataset.src.includes('/web/image/123/transparent.png'),"should have the image in the dom");testUtils.mock.unpatch(MediaDialog);form.destroy();});QUnit.test('media dialog: icon',async function(assert){assert.expect(1);var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form>'+'<field name="body" widget="html" style="height: 100px"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.model==='ir.attachment'){return Promise.resolve([]);}
if(route.indexOf('/web_unsplash/fetch_images')===0){return Promise.resolve();}
return this._super(route,args);},});await testUtils.form.clickEdit(form);var $field=form.$('.oe_form_field[name="body"]');var defMediaDialog=testUtils.makeTestPromise();testUtils.mock.patch(MediaDialog,{init:function(){this._super.apply(this,arguments);this.opened(defMediaDialog.resolve.bind(defMediaDialog));}});var pText=$field.find('.note-editable p').first().contents()[0];Wysiwyg.setRange(pText,1);await testUtils.dom.click($field.find('.note-toolbar .note-insert button:has(.fa-file-image-o)'));await defMediaDialog;$('.modal .tab-content .tab-pane').removeClass('fade');await testUtils.dom.click($('.modal a[aria-controls="editor-media-icon"]'));await testUtils.dom.click($('.modal #editor-media-icon .font-icons-icon.fa-glass'));var $editable=form.$('.oe_form_field[name="body"] .note-editable');assert.strictEqual($editable.data('wysiwyg').getValue(),'<p>t<span class="fa fa-glass"></span>oto toto toto</p><p>tata</p>',"should have the image in the dom");testUtils.mock.unpatch(MediaDialog);form.destroy();});QUnit.test('save',async function(assert){assert.expect(1);var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form>'+'<field name="body" widget="html" style="height: 100px"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(args.method==="write"){assert.strictEqual(args.args[1].body,'<p>t<font class="bg-o-color-3">oto toto&nbsp;</font>toto</p><p>tata</p>',"should save the content");}
return this._super.apply(this,arguments);},});await testUtils.form.clickEdit(form);var $field=form.$('.oe_form_field[name="body"]');var pText=$field.find('.note-editable p').first().contents()[0];Wysiwyg.setRange(pText,1,pText,10);async function openColorpicker(selector){const $colorpicker=$field.find(selector);const openingProm=new Promise(resolve=>{$colorpicker.one('shown.bs.dropdown',()=>resolve());});await testUtils.dom.click($colorpicker.find('button:first'));return openingProm;}
await openColorpicker('.note-toolbar .note-back-color-preview');await testUtils.dom.click($field.find('.note-toolbar .note-back-color-preview .o_we_color_btn.bg-o-color-3'));await testUtils.form.clickSave(form);form.destroy();});QUnit.module('cssReadonly');QUnit.test('rendering with iframe for readonly mode',async function(assert){assert.expect(3);var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form>'+'<field name="body" widget="html" style="height: 100px" options="{\'cssReadonly\': \'template.assets\'}"/>'+'</form>',res_id:1,});var $field=form.$('.oe_form_field[name="body"]');var $iframe=$field.find('iframe.o_readonly');await $iframe.data('loadDef');var doc=$iframe.contents()[0];assert.strictEqual($(doc).find('#iframe_target').html(),'<p>toto toto toto</p><p>tata</p>',"should have rendered a div with correct content in readonly");assert.strictEqual(doc.defaultView.getComputedStyle(doc.body).backgroundColor,'rgb(255, 0, 0)',"should load the asset css");await testUtils.form.clickEdit(form);$field=form.$('.oe_form_field[name="body"]');assert.strictEqual($field.find('.note-editable').html(),'<p>toto toto toto</p><p>tata</p>',"should have rendered the field correctly in edit");form.destroy();});QUnit.module('translation');QUnit.test('field html translatable',async function(assert){assert.expect(4);var multiLang=_t.database.multi_lang;_t.database.multi_lang=true;this.data['note.note'].fields.body.translate=true;var form=await testUtils.createView({View:FormView,model:'note.note',data:this.data,arch:'<form string="Partners">'+'<field name="body" widget="html"/>'+'</form>',res_id:1,mockRPC:function(route,args){if(route==='/web/dataset/call_button'&&args.method==='translate_fields'){assert.deepEqual(args.args,['note.note',1,'body'],"should call 'call_button' route");return Promise.resolve({domain:[],context:{search_default_name:'partnes,foo'},});}
if(route==="/web/dataset/call_kw/res.lang/get_installed"){return Promise.resolve([["en_US"],["fr_BE"]]);}
return this._super.apply(this,arguments);},});assert.strictEqual(form.$('.oe_form_field_html .o_field_translate').length,0,"should not have a translate button in readonly mode");await testUtils.form.clickEdit(form);var $button=form.$('.oe_form_field_html .o_field_translate');assert.strictEqual($button.length,1,"should have a translate button");await testUtils.dom.click($button);assert.containsOnce($(document),'.o_translation_dialog','should have a modal to translate');form.destroy();_t.database.multi_lang=multiLang;});});});});;

/* /web_kanban_gauge/static/tests/gauge_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_kanban_gauge.gauge_tests',function(require){"use strict";var KanbanView=require('web.KanbanView');var testUtils=require('web.test_utils');var createView=testUtils.createView;QUnit.module('fields',{},function(){QUnit.module('basic_fields',{beforeEach:function(){this.data={partner:{fields:{int_field:{string:"int_field",type:"integer",sortable:true},},records:[{id:1,int_field:10},{id:2,int_field:4},]},};}},function(){QUnit.module('gauge widget');QUnit.test('basic rendering',async function(assert){assert.expect(1);var kanban=await createView({View:KanbanView,model:'partner',data:this.data,arch:'<kanban><templates><t t-name="kanban-box">'+'<div><field name="int_field" widget="gauge"/></div>'+'</t></templates></kanban>',});assert.containsOnce(kanban,'.o_kanban_record:first .oe_gauge canvas',"should render the gauge widget");kanban.destroy();});});});});;

/* /web_tour/static/tests/tour_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web_tour.tour_manager_tests',async function(require){"use strict";const KanbanView=require('web.KanbanView');const TourManager=require('web_tour.TourManager');const testUtils=require('web.test_utils');const createView=testUtils.createView;const ajax=require('web.ajax');const{qweb}=require('web.core');await ajax.loadXML('/web_tour/static/src/xml/tip.xml',qweb);async function createTourManager({consumed_tours,debug,template,tours}){const parent=await testUtils.createParent({debug});const tourManager=new TourManager(parent,consumed_tours);tourManager.running_step_delay=0;for(const{name,options,steps}of tours){tourManager.register(name,options,steps);}
const _destroy=tourManager.destroy;tourManager.destroy=function(){tourManager.destroy=_destroy;parent.destroy();};await parent.prependTo(testUtils.prepareTarget(debug));parent.el.innerHTML=template;testUtils.mock.patch(TourManager,{_isTourConsumed:name=>(consumed_tours||[]).includes(name),});await tourManager._register_all(true);await testUtils.nextTick();return tourManager;}
QUnit.module("Tours",{afterEach(){testUtils.mock.unpatch(TourManager);},},function(){QUnit.module("Tour manager");QUnit.test("Tours sequence",async function(assert){assert.expect(2);const tourManager=await createTourManager({template:`
                    <button class="btn anchor">Anchor</button>`,tours:[{name:"Tour 1",options:{sequence:10},steps:[{trigger:'.anchor'}]},{name:"Tour 2",options:{},steps:[{trigger:'.anchor'}]},{name:"Tour 3",options:{sequence:5},steps:[{trigger:'.anchor',content:"Oui"}]},],debug:true,});assert.containsOnce(document.body,'.o_tooltip:visible');assert.strictEqual($('.o_tooltip_content:visible').text(),"Oui","content should be that of the third tour");tourManager.destroy();});QUnit.test("Click on invisible tip consumes it",async function(assert){assert.expect(5);const tourManager=await createTourManager({template:`
                    <button class="btn anchor1">Anchor</button>
                    <button class="btn anchor2">Anchor</button>
                    `,tours:[{name:"Tour 1",options:{rainbowMan:false,sequence:10},steps:[{trigger:'.anchor1',content:"1"}],},{name:"Tour 2",options:{rainbowMan:false,sequence:5},steps:[{trigger:'.anchor2',content:"2"}],}],debug:true,});assert.containsN(document.body,'.o_tooltip',2);assert.strictEqual($('.o_tooltip_content:visible').text(),"2");await testUtils.dom.click($('.anchor1'));assert.containsOnce(document.body,'.o_tooltip');assert.strictEqual($('.o_tooltip_content:visible').text(),"2");await testUtils.dom.click($('.anchor2'));assert.containsNone(document.body,'.o_tooltip');tourManager.destroy();});QUnit.test("Step anchor replaced",async function(assert){assert.expect(3);const tourManager=await createTourManager({observe:true,template:`<input class="anchor"/>`,tours:[{name:"Tour",options:{rainbowMan:false},steps:[{trigger:"input.anchor"}],}],});assert.containsOnce(document.body,'.o_tooltip:visible');const $anchor=$(".anchor");const $parent=$anchor.parent();$parent.empty();$parent.append($anchor);tourManager.update();await testUtils.nextTick();assert.containsOnce(document.body,'.o_tooltip:visible');await testUtils.fields.editInput($('.anchor'),"AAA");assert.containsNone(document.body,'.o_tooltip:visible');tourManager.destroy();});QUnit.test("kanban quick create VS tour tooltips",async function(assert){assert.expect(3);const kanban=await createView({View:KanbanView,model:'partner',data:{partner:{fields:{foo:{string:"Foo",type:"char"},bar:{string:"Bar",type:"boolean"},},records:[{id:1,bar:true,foo:"yop"},]}},arch:`<kanban>
                        <field name="bar"/>
                        <templates><t t-name="kanban-box">
                            <div><field name="foo"/></div>
                        </t></templates>
                        </kanban>`,groupBy:['bar'],});await testUtils.dom.click(kanban.$('.o_kanban_header .o_kanban_quick_add i').first());assert.containsOnce(kanban,'.o_kanban_quick_create',"should have open the quick create widget");const tourManager=await createTourManager({observe:true,template:kanban.$el.html(),tours:[{name:"Tour",options:{rainbowMan:false},steps:[{trigger:"input[name='display_name']"}],}],});assert.containsOnce(document.body,'.o_tooltip:visible');await testUtils.dom.click($('.o_tooltip:visible'));assert.containsOnce(kanban,'.o_kanban_quick_create',"the quick create should not have been destroyed when tooltip is clicked");kanban.destroy();tourManager.destroy();});});});;

/* /bus/static/tests/bus_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('web.bus_tests',function(require){"use strict";var BusService=require('bus.BusService');var AbstractStorageService=require('web.AbstractStorageService');var RamStorage=require('web.RamStorage');var testUtils=require('web.test_utils');var Widget=require('web.Widget');var LocalStorageServiceMock;BusService=BusService.extend({TAB_HEARTBEAT_PERIOD:10,MASTER_TAB_HEARTBEAT_PERIOD:1,});QUnit.module('Bus',{beforeEach:function(){LocalStorageServiceMock=AbstractStorageService.extend({storage:new RamStorage()});},},function(){QUnit.test('notifications received from the longpolling channel',async function(assert){assert.expect(6);var pollPromise=testUtils.makeTestPromise();var parent=new Widget();await testUtils.mock.addMockEnvironment(parent,{data:{},services:{bus_service:BusService,local_storage:LocalStorageServiceMock,},mockRPC:function(route,args){if(route==='/longpolling/poll'){assert.step(route+' - '+args.channels.join(','));pollPromise=testUtils.makeTestPromise();pollPromise.abort=(function(){this.reject({message:"XmlHttpRequestError abort"},$.Event());}).bind(pollPromise);return pollPromise;}
return this._super.apply(this,arguments);}});var widget=new Widget(parent);await widget.appendTo($('#qunit-fixture'));widget.call('bus_service','onNotification',this,function(notifications){assert.step('notification - '+notifications.toString());});widget.call('bus_service','addChannel','lambda');pollPromise.resolve([{id:1,channel:'lambda',message:'beta',}]);await testUtils.nextTick();pollPromise.resolve([{id:2,channel:'lambda',message:'epsilon',}]);await testUtils.nextTick();assert.verifySteps(['/longpolling/poll - lambda','notification - lambda,beta','/longpolling/poll - lambda','notification - lambda,epsilon','/longpolling/poll - lambda',]);parent.destroy();});QUnit.test('provide notification ID of 0 by default',async function(assert){assert.expect(3);testUtils.mock.patch(LocalStorageServiceMock,{getItem:function(key){if(key==='last_ts'){return 0;}
return this._super.apply(this,arguments);},});var pollPromise=testUtils.makeTestPromise();var parent=new Widget();await testUtils.mock.addMockEnvironment(parent,{data:{},services:{bus_service:BusService,local_storage:LocalStorageServiceMock,},mockRPC:function(route,args){if(route==='/longpolling/poll'){assert.step(route);assert.strictEqual(args.last,0,"provided last notification ID should be 0");pollPromise=testUtils.makeTestPromise();pollPromise.abort=(function(){this.reject({message:"XmlHttpRequestError abort"},$.Event());}).bind(pollPromise);return pollPromise;}
return this._super.apply(this,arguments);}});var widget=new Widget(parent);await widget.appendTo($('#qunit-fixture'));widget.call('bus_service','addChannel','lambda');assert.verifySteps(['/longpolling/poll']);testUtils.mock.unpatch(LocalStorageServiceMock);parent.destroy();});QUnit.test('cross tab bus share message from a channel',async function(assert){assert.expect(5);var pollPromiseMaster=testUtils.makeTestPromise();var parentMaster=new Widget();await testUtils.mock.addMockEnvironment(parentMaster,{data:{},services:{bus_service:BusService,local_storage:LocalStorageServiceMock,},mockRPC:function(route,args){if(route==='/longpolling/poll'){assert.step('master'+' - '+route+' - '+args.channels.join(','));pollPromiseMaster=testUtils.makeTestPromise();pollPromiseMaster.abort=(function(){this.reject({message:"XmlHttpRequestError abort"},$.Event());}).bind(pollPromiseMaster);return pollPromiseMaster;}
return this._super.apply(this,arguments);}});var master=new Widget(parentMaster);await master.appendTo($('#qunit-fixture'));master.call('bus_service','onNotification',master,function(notifications){assert.step('master - notification - '+notifications.toString());});master.call('bus_service','addChannel','lambda');await testUtils.nextTick();var parentSlave=new Widget();await testUtils.mock.addMockEnvironment(parentSlave,{data:{},services:{bus_service:BusService,local_storage:LocalStorageServiceMock,},mockRPC:function(route,args){if(route==='/longpolling/poll'){throw new Error("Can not use the longpolling of the slave client");}
return this._super.apply(this,arguments);}});var slave=new Widget(parentSlave);await slave.appendTo($('#qunit-fixture'));slave.call('bus_service','onNotification',slave,function(notifications){assert.step('slave - notification - '+notifications.toString());});slave.call('bus_service','addChannel','lambda');pollPromiseMaster.resolve([{id:1,channel:'lambda',message:'beta',}]);await testUtils.nextTick();assert.verifySteps(['master - /longpolling/poll - lambda','master - notification - lambda,beta','slave - notification - lambda,beta','master - /longpolling/poll - lambda',]);parentMaster.destroy();parentSlave.destroy();});QUnit.test('cross tab bus elect new master on master unload',async function(assert){assert.expect(8);var pollPromiseMaster=testUtils.makeTestPromise();var parentMaster=new Widget();await testUtils.mock.addMockEnvironment(parentMaster,{data:{},services:{bus_service:BusService,local_storage:LocalStorageServiceMock,},mockRPC:function(route,args){if(route==='/longpolling/poll'){assert.step('master - '+route+' - '+args.channels.join(','));pollPromiseMaster=testUtils.makeTestPromise();pollPromiseMaster.abort=(function(){this.reject({message:"XmlHttpRequestError abort"},$.Event());}).bind(pollPromiseMaster);return pollPromiseMaster;}
return this._super.apply(this,arguments);}});var master=new Widget(parentMaster);await master.appendTo($('#qunit-fixture'));master.call('bus_service','onNotification',master,function(notifications){assert.step('master - notification - '+notifications.toString());});master.call('bus_service','addChannel','lambda');await testUtils.nextTick();var parentSlave=new Widget();var pollPromiseSlave=testUtils.makeTestPromise();await testUtils.mock.addMockEnvironment(parentSlave,{data:{},services:{bus_service:BusService,local_storage:LocalStorageServiceMock,},mockRPC:function(route,args){if(route==='/longpolling/poll'){assert.step('slave - '+route+' - '+args.channels.join(','));pollPromiseSlave=testUtils.makeTestPromise();pollPromiseSlave.abort=(function(){this.reject({message:"XmlHttpRequestError abort"},$.Event());}).bind(pollPromiseSlave);return pollPromiseSlave;}
return this._super.apply(this,arguments);}});var slave=new Widget(parentSlave);await slave.appendTo($('#qunit-fixture'));slave.call('bus_service','onNotification',slave,function(notifications){assert.step('slave - notification - '+notifications.toString());});slave.call('bus_service','addChannel','lambda');pollPromiseMaster.resolve([{id:1,channel:'lambda',message:'beta',}]);await testUtils.nextTick();master.call('bus_service','_onUnload');pollPromiseSlave.resolve([{id:2,channel:'lambda',message:'gamma',}]);await testUtils.nextTick();assert.verifySteps(['master - /longpolling/poll - lambda','master - notification - lambda,beta','slave - notification - lambda,beta','master - /longpolling/poll - lambda','slave - /longpolling/poll - lambda','slave - notification - lambda,gamma','slave - /longpolling/poll - lambda',]);parentMaster.destroy();parentSlave.destroy();});});});;

/* /mail/static/tests/chatter_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail.chatter_tests',function(require){"use strict";const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');var FormView=require('web.FormView');var ListView=require('web.ListView');var testUtils=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('Chatter',{beforeEach:function(){beforeEach(this);this.data['res.partner'].records.push({id:11,im_status:'online'});this.data['mail.activity.type'].records.push({id:1,name:"Type 1"},{id:2,name:"Type 2"},{id:3,name:"Type 3",category:'upload_file'},{id:4,name:"Exception",decoration_type:"warning",icon:"fa-warning"});this.data['ir.attachment'].records.push({id:1,mimetype:'image/png',name:'filename.jpg',res_id:7,res_model:'res.users',type:'url',},{id:2,mimetype:"application/x-msdos-program",name:"file2.txt",res_id:7,res_model:'res.users',type:'binary',},{id:3,mimetype:"application/x-msdos-program",name:"file3.txt",res_id:5,res_model:'res.users',type:'binary',},);Object.assign(this.data['res.users'].fields,{activity_exception_decoration:{string:'Decoration',type:'selection',selection:[['warning','Alert'],['danger','Error']],},activity_exception_icon:{string:'icon',type:'char',},activity_ids:{string:'Activities',type:'one2many',relation:'mail.activity',relation_field:'res_id',},activity_state:{string:'State',type:'selection',selection:[['overdue','Overdue'],['today','Today'],['planned','Planned']],},activity_summary:{string:"Next Activity Summary",type:'char',},activity_type_icon:{string:"Activity Type Icon",type:'char',},activity_type_id:{string:"Activity type",type:"many2one",relation:"mail.activity.type",},foo:{string:"Foo",type:"char",default:"My little Foo Value"},message_attachment_count:{string:'Attachment count',type:'integer',},message_follower_ids:{string:"Followers",type:"one2many",relation:'mail.followers',relation_field:"res_id",},message_ids:{string:"messages",type:"one2many",relation:'mail.message',relation_field:"res_id",},});},afterEach(){afterEach(this);},});QUnit.test('list activity widget with no activity',async function(assert){assert.expect(5);const{widget:list}=await start({hasView:true,View:ListView,model:'res.users',data:this.data,arch:'<list><field name="activity_ids" widget="list_activity"/></list>',mockRPC:function(route){assert.step(route);return this._super(...arguments);},session:{uid:2},});assert.containsOnce(list,'.o_mail_activity .o_activity_color_default');assert.strictEqual(list.$('.o_activity_summary').text(),'');assert.verifySteps(['/web/dataset/search_read','/mail/init_messaging',]);list.destroy();});QUnit.test('list activity widget with activities',async function(assert){assert.expect(7);const currentUser=this.data['res.users'].records.find(user=>user.id===this.data.currentUserId);Object.assign(currentUser,{activity_ids:[1,4],activity_state:'today',activity_summary:'Call with Al',activity_type_id:3,activity_type_icon:'fa-phone',});this.data['res.users'].records.push({id:44,activity_ids:[2],activity_state:'planned',activity_summary:false,activity_type_id:2,});const{widget:list}=await start({hasView:true,View:ListView,model:'res.users',data:this.data,arch:'<list><field name="activity_ids" widget="list_activity"/></list>',mockRPC:function(route){assert.step(route);return this._super(...arguments);},});const $firstRow=list.$('.o_data_row:first');assert.containsOnce($firstRow,'.o_mail_activity .o_activity_color_today.fa-phone');assert.strictEqual($firstRow.find('.o_activity_summary').text(),'Call with Al');const $secondRow=list.$('.o_data_row:nth(1)');assert.containsOnce($secondRow,'.o_mail_activity .o_activity_color_planned.fa-clock-o');assert.strictEqual($secondRow.find('.o_activity_summary').text(),'Type 2');assert.verifySteps(['/web/dataset/search_read','/mail/init_messaging',]);list.destroy();});QUnit.test('list activity widget with exception',async function(assert){assert.expect(5);const currentUser=this.data['res.users'].records.find(user=>user.id===this.data.currentUserId);Object.assign(currentUser,{activity_ids:[1],activity_state:'today',activity_summary:'Call with Al',activity_type_id:3,activity_exception_decoration:'warning',activity_exception_icon:'fa-warning',});const{widget:list}=await start({hasView:true,View:ListView,model:'res.users',data:this.data,arch:'<list><field name="activity_ids" widget="list_activity"/></list>',mockRPC:function(route){assert.step(route);return this._super(...arguments);},});assert.containsOnce(list,'.o_activity_color_today.text-warning.fa-warning');assert.strictEqual(list.$('.o_activity_summary').text(),'Warning');assert.verifySteps(['/web/dataset/search_read','/mail/init_messaging',]);list.destroy();});QUnit.test('list activity widget: open dropdown',async function(assert){assert.expect(10);const currentUser=this.data['res.users'].records.find(user=>user.id===this.data.currentUserId);Object.assign(currentUser,{activity_ids:[1,4],activity_state:'today',activity_summary:'Call with Al',activity_type_id:3,});this.data['mail.activity'].records.push({id:1,display_name:"Call with Al",date_deadline:moment().format("YYYY-MM-DD"),can_write:true,state:"today",user_id:this.data.currentUserId,create_uid:this.data.currentUserId,activity_type_id:3,},{id:4,display_name:"Meet FP",date_deadline:moment().add(1,'day').format("YYYY-MM-DD"),can_write:true,state:"planned",user_id:this.data.currentUserId,create_uid:this.data.currentUserId,activity_type_id:1,});const{env,widget:list}=await start({hasView:true,View:ListView,model:'res.users',data:this.data,arch:`
            <list>
                <field name="foo"/>
                <field name="activity_ids" widget="list_activity"/>
            </list>`,mockRPC:function(route,args){assert.step(args.method||route);if(args.method==='action_feedback'){const currentUser=this.data['res.users'].records.find(user=>user.id===env.messaging.currentUser.id);Object.assign(currentUser,{activity_ids:[4],activity_state:'planned',activity_summary:'Meet FP',activity_type_id:1,});return Promise.resolve();}
return this._super(route,args);},intercepts:{switch_view:()=>assert.step('switch_view'),},});assert.strictEqual(list.$('.o_activity_summary').text(),'Call with Al');await testUtils.dom.click(list.$('.o_data_cell:first'));assert.step('open dropdown');await testUtils.dom.click(list.$('.o_activity_btn span'));await testUtils.dom.click(list.$('.o_mark_as_done:first'));await testUtils.dom.click(list.$('.o_activity_popover_done'));assert.strictEqual(list.$('.o_activity_summary').text(),'Meet FP');assert.verifySteps(['/web/dataset/search_read','/mail/init_messaging','switch_view','open dropdown','activity_format','action_feedback','read',]);list.destroy();});QUnit.test('list activity exception widget with activity',async function(assert){assert.expect(3);const currentUser=this.data['res.users'].records.find(user=>user.id===this.data.currentUserId);currentUser.activity_ids=[1];this.data['res.users'].records.push({id:13,message_attachment_count:3,display_name:"second partner",foo:"Tommy",message_follower_ids:[],message_ids:[],activity_ids:[2],activity_exception_decoration:'warning',activity_exception_icon:'fa-warning',});this.data['mail.activity'].records.push({id:1,display_name:"An activity",date_deadline:moment().format("YYYY-MM-DD"),can_write:true,state:"today",user_id:2,create_uid:2,activity_type_id:1,},{id:2,display_name:"An exception activity",date_deadline:moment().format("YYYY-MM-DD"),can_write:true,state:"today",user_id:2,create_uid:2,activity_type_id:4,});const{widget:list}=await start({hasView:true,View:ListView,model:'res.users',data:this.data,arch:'<tree>'+'<field name="foo"/>'+'<field name="activity_exception_decoration" widget="activity_exception"/> '+'</tree>',});assert.containsN(list,'.o_data_row',2,"should have two records");assert.doesNotHaveClass(list.$('.o_data_row:eq(0) .o_activity_exception_cell div'),'fa-warning',"there is no any exception activity on record");assert.hasClass(list.$('.o_data_row:eq(1) .o_activity_exception_cell div'),'fa-warning',"there is an exception on a record");list.destroy();});QUnit.module('FieldMany2ManyTagsEmail',{beforeEach(){beforeEach(this);Object.assign(this.data['res.users'].fields,{timmy:{string:"pokemon",type:"many2many",relation:'partner_type'},});this.data['res.users'].records.push({id:11,display_name:"first record",timmy:[],});Object.assign(this.data,{partner_type:{fields:{name:{string:"Partner Type",type:"char"},email:{string:"Email",type:"char"},},records:[],},});this.data['partner_type'].records.push({id:12,display_name:"gold",email:'coucou@petite.perruche'},{id:14,display_name:"silver",email:''});},afterEach(){afterEach(this);},});QUnit.test('fieldmany2many tags email',function(assert){assert.expect(13);var done=assert.async();const user11=this.data['res.users'].records.find(user=>user.id===11);user11.timmy=[12,14];start({hasView:true,View:FormView,model:'res.users',data:this.data,res_id:11,arch:'<form string="Partners">'+'<sheet>'+'<field name="display_name"/>'+'<field name="timmy" widget="many2many_tags_email"/>'+'</sheet>'+'</form>',viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='read'&&args.model==='partner_type'){assert.step(JSON.stringify(args.args[0]));assert.deepEqual(args.args[1],['display_name','email'],"should read the email");}
return this._super.apply(this,arguments);},archs:{'partner_type,false,form':'<form string="Types"><field name="display_name"/><field name="email"/></form>',},}).then(async function({widget:form}){assert.verifySteps(['[12,14]','[14]','[14]']);await testUtils.nextTick();assert.containsN(form,'.o_field_many2manytags[name="timmy"] .badge.o_tag_color_0',2,"two tags should be present");var firstTag=form.$('.o_field_many2manytags[name="timmy"] .badge.o_tag_color_0').first();assert.strictEqual(firstTag.find('.o_badge_text').text(),"gold","tag should only show display_name");assert.hasAttrValue(firstTag.find('.o_badge_text'),'title',"coucou@petite.perruche","tag should show email address on mouse hover");form.destroy();done();});testUtils.nextTick().then(function(){assert.strictEqual($('.modal-body.o_act_window').length,1,"there should be one modal opened to edit the empty email");assert.strictEqual($('.modal-body.o_act_window input[name="display_name"]').val(),"silver","the opened modal should be a form view dialog with the partner_type 14");assert.strictEqual($('.modal-body.o_act_window input[name="email"]').length,1,"there should be an email field in the modal");testUtils.fields.editInput($('.modal-body.o_act_window input[name="email"]'),'coucou@petite.perruche');testUtils.dom.click($('.modal-footer .btn-primary'));});});QUnit.test('fieldmany2many tags email (edition)',async function(assert){assert.expect(15);const user11=this.data['res.users'].records.find(user=>user.id===11);user11.timmy=[12];var{widget:form}=await start({hasView:true,View:FormView,model:'res.users',data:this.data,res_id:11,arch:'<form string="Partners">'+'<sheet>'+'<field name="display_name"/>'+'<field name="timmy" widget="many2many_tags_email"/>'+'</sheet>'+'</form>',viewOptions:{mode:'edit',},mockRPC:function(route,args){if(args.method==='read'&&args.model==='partner_type'){assert.step(JSON.stringify(args.args[0]));assert.deepEqual(args.args[1],['display_name','email'],"should read the email");}
return this._super.apply(this,arguments);},archs:{'partner_type,false,form':'<form string="Types"><field name="display_name"/><field name="email"/></form>',},});assert.verifySteps(['[12]']);assert.containsOnce(form,'.o_field_many2manytags[name="timmy"] .badge.o_tag_color_0',"should contain one tag");await testUtils.fields.many2one.clickOpenDropdown('timmy');await testUtils.fields.many2one.clickHighlightedItem('timmy');assert.strictEqual($('.modal-body.o_act_window').length,1,"there should be one modal opened to edit the empty email");assert.strictEqual($('.modal-body.o_act_window input[name="display_name"]').val(),"silver","the opened modal in edit mode should be a form view dialog with the partner_type 14");assert.strictEqual($('.modal-body.o_act_window input[name="email"]').length,1,"there should be an email field in the modal");await testUtils.fields.editInput($('.modal-body.o_act_window input[name="email"]'),'coucou@petite.perruche');await testUtils.dom.click($('.modal-footer .btn-primary'));assert.containsN(form,'.o_field_many2manytags[name="timmy"] .badge.o_tag_color_0',2,"should contain the second tag");assert.verifySteps(['[14]','[14]','[14]']);form.destroy();});QUnit.test('many2many_tags_email widget can load more than 40 records',async function(assert){assert.expect(3);const user11=this.data['res.users'].records.find(user=>user.id===11);this.data['res.users'].fields.partner_ids={string:"Partner",type:"many2many",relation:'res.users'};user11.partner_ids=[];for(let i=100;i<200;i++){this.data['res.users'].records.push({id:i,display_name:`partner${i}`});user11.partner_ids.push(i);}
const{widget:form}=await start({hasView:true,View:FormView,model:'res.users',data:this.data,arch:'<form><field name="partner_ids" widget="many2many_tags"/></form>',res_id:11,});assert.strictEqual(form.$('.o_field_widget[name="partner_ids"] .badge').length,100);await testUtils.form.clickEdit(form);assert.hasClass(form.$('.o_form_view'),'o_form_editable');await testUtils.fields.many2one.clickOpenDropdown('partner_ids');await testUtils.fields.many2one.clickHighlightedItem('partner_ids');assert.strictEqual(form.$('.o_field_widget[name="partner_ids"] .badge').length,101);form.destroy();});});});;

/* /mail/static/tests/mail_utils_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail.mail_utils_tests',function(require){"use strict";var utils=require('mail.utils');QUnit.module('mail',{},function(){QUnit.module('Mail utils');QUnit.test('add_link utility function',function(assert){assert.expect(15);var testInputs={'http://admin:password@example.com:8/%2020':true,'https://admin:password@example.com/test':true,'www.example.com:8/test':true,'https://127.0.0.5:8069':true,'www.127.0.0.5':false,'should.notmatch':false,'fhttps://test.example.com/test':false,"https://www.transifex.com/odoo/odoo-11/translate/#fr/lunch?q=text%3A'La+Tartiflette'":true,'https://www.transifex.com/odoo/odoo-11/translate/#fr/$/119303430?q=text%3ATartiflette':true,};_.each(testInputs,function(willLinkify,content){var output=utils.parseAndTransform(content,utils.addLink);if(willLinkify){assert.strictEqual(output.indexOf('<a '),0,"There should be a link");assert.strictEqual(output.indexOf('</a>'),(output.length-4),"Link should match the whole text");}else{assert.strictEqual(output.indexOf('<a '),-1,"There should be no link");}});});QUnit.test('addLink: linkify inside text node (1 occurrence)',function(assert){assert.expect(5);const content='<p>some text https://somelink.com</p>';const linkified=utils.parseAndTransform(content,utils.addLink);assert.ok(linkified.startsWith('<p>some text <a'),"linkified text should start with non-linkified start part, followed by an '<a>' tag");assert.ok(linkified.endsWith('</a></p>'),"linkified text should end with closing '<a>' tag");const fragment=document.createDocumentFragment();const div=document.createElement('div');fragment.appendChild(div);div.innerHTML=linkified;assert.strictEqual(div.textContent,'some text https://somelink.com',"linkified text should have same text content as non-linkified version");assert.strictEqual(div.querySelectorAll(':scope a').length,1,"linkified text should have an <a> tag");assert.strictEqual(div.querySelector(':scope a').textContent,'https://somelink.com',"text content of link should be equivalent of its non-linkified version");});QUnit.test('addLink: linkify inside text node (2 occurrences)',function(assert){assert.expect(4);const content='<p>some text https://somelink.com and again https://somelink2.com ...</p>';const linkified=utils.parseAndTransform(content,utils.addLink);const fragment=document.createDocumentFragment();const div=document.createElement('div');fragment.appendChild(div);div.innerHTML=linkified;assert.strictEqual(div.textContent,'some text https://somelink.com and again https://somelink2.com ...',"linkified text should have same text content as non-linkified version");assert.strictEqual(div.querySelectorAll(':scope a').length,2,"linkified text should have 2 <a> tags");assert.strictEqual(div.querySelectorAll(':scope a')[0].textContent,'https://somelink.com',"text content of 1st link should be equivalent to its non-linkified version");assert.strictEqual(div.querySelectorAll(':scope a')[1].textContent,'https://somelink2.com',"text content of 2nd link should be equivalent to its non-linkified version");});});});;

/* /mail/static/tests/document_viewer_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail.document_viewer_tests',function(require){"use strict";var DocumentViewer=require('mail.DocumentViewer');var testUtils=require('web.test_utils');var Widget=require('web.Widget');var createViewer=async function(params){var parent=new Widget();var viewer=new DocumentViewer(parent,params.attachments,params.attachmentID);var mockRPC=function(route){if(route==='/web/static/lib/pdfjs/web/viewer.html?file=/web/content/1?model%3Dir.attachment%26filename%3DfilePdf.pdf'){return Promise.resolve();}
if(route==='https://www.youtube.com/embed/FYqW0Gdwbzk'){return Promise.resolve();}
if(route==='/web/content/4?model=ir.attachment'){return Promise.resolve();}
if(route==='/web/image/6?unique=56789abc&model=ir.attachment'){return Promise.resolve();}};await testUtils.mock.addMockEnvironment(parent,{mockRPC:function(){if(params.mockRPC){var _super=this._super;this._super=mockRPC;var def=params.mockRPC.apply(this,arguments);this._super=_super;return def;}else{return mockRPC.apply(this,arguments);}},intercepts:params.intercepts||{},});var $target=$("#qunit-fixture");if(params.debug){$target=$('body');$target.addClass('debug');}
viewer.destroy=function(){delete viewer.destroy;parent.destroy();};return viewer.appendTo($target).then(function(){return viewer;});};QUnit.module('mail',{},function(){QUnit.module('document_viewer_tests.js',{beforeEach:function(){this.attachments=[{id:1,name:'filePdf.pdf',type:'binary',mimetype:'application/pdf',datas:'R0lGOP////ywAADs='},{id:2,name:'urlYoutube',type:'url',mimetype:'',url:'https://youtu.be/FYqW0Gdwbzk'},{id:3,name:'urlRandom',type:'url',mimetype:'',url:'https://www.google.com'},{id:4,name:'text.html',type:'binary',mimetype:'text/html',datas:'testee'},{id:5,name:'video.mp4',type:'binary',mimetype:'video/mp4',datas:'R0lDOP////ywAADs='},{id:6,name:'image.jpg',type:'binary',mimetype:'image/jpeg',checksum:'123456789abc',datas:'R0lVOP////ywAADs='},];},},function(){QUnit.test('basic rendering',async function(assert){assert.expect(7);var viewer=await createViewer({attachmentID:1,attachments:this.attachments,});assert.containsOnce(viewer,'.o_viewer_content',"there should be a preview");assert.containsOnce(viewer,'.o_close_btn',"there should be a close button");assert.containsOnce(viewer,'.o_viewer-header',"there should be a header");assert.containsOnce(viewer,'.o_image_caption',"there should be an image caption");assert.containsOnce(viewer,'.o_viewer_zoomer',"there should be a zoomer");assert.containsOnce(viewer,'.fa-chevron-right',"there should be a right nav icon");assert.containsOnce(viewer,'.fa-chevron-left',"there should be a left nav icon");viewer.destroy();});QUnit.test('Document Viewer Youtube',async function(assert){assert.expect(3);var youtubeURL='https://www.youtube.com/embed/FYqW0Gdwbzk';var viewer=await createViewer({attachmentID:2,attachments:this.attachments,mockRPC:function(route){if(route===youtubeURL){assert.ok(true,"should have called youtube URL");}
return this._super.apply(this,arguments);},});assert.strictEqual(viewer.$(".o_image_caption:contains('urlYoutube')").length,1,"the viewer should be on the right attachment");assert.containsOnce(viewer,'.o_viewer_text[data-src="'+youtubeURL+'"]',"there should be a video player");viewer.destroy();});QUnit.test('Document Viewer html/(txt)',async function(assert){assert.expect(2);var viewer=await createViewer({attachmentID:4,attachments:this.attachments,});assert.strictEqual(viewer.$(".o_image_caption:contains('text.html')").length,1,"the viewer be on the right attachment");assert.containsOnce(viewer,'iframe[data-src="/web/content/4?model=ir.attachment"]',"there should be an iframe with the right src");viewer.destroy();});QUnit.test('Document Viewer mp4',async function(assert){assert.expect(2);var viewer=await createViewer({attachmentID:5,attachments:this.attachments,});assert.strictEqual(viewer.$(".o_image_caption:contains('video.mp4')").length,1,"the viewer be on the right attachment");assert.containsOnce(viewer,'.o_viewer_video',"there should be a video player");viewer.destroy();});QUnit.test('Document Viewer jpg',async function(assert){assert.expect(2);var viewer=await createViewer({attachmentID:6,attachments:this.attachments,});assert.strictEqual(viewer.$(".o_image_caption:contains('image.jpg')").length,1,"the viewer be on the right attachment");assert.containsOnce(viewer,'img[data-src="/web/image/6?unique=56789abc&model=ir.attachment"]',"there should be a video player");viewer.destroy();});QUnit.test('is closable by button',async function(assert){assert.expect(3);var viewer=await createViewer({attachmentID:6,attachments:this.attachments,});assert.containsOnce(viewer,'.o_viewer_content',"should have a document viewer");assert.containsOnce(viewer,'.o_close_btn',"should have a close button");await testUtils.dom.click(viewer.$('.o_close_btn'));assert.ok(viewer.isDestroyed(),'viewer should be destroyed');});QUnit.test('is closable by clicking on the wrapper',async function(assert){assert.expect(3);var viewer=await createViewer({attachmentID:6,attachments:this.attachments,});assert.containsOnce(viewer,'.o_viewer_content',"should have a document viewer");assert.containsOnce(viewer,'.o_viewer_img_wrapper',"should have a wrapper");await testUtils.dom.click(viewer.$('.o_viewer_img_wrapper'));assert.ok(viewer.isDestroyed(),'viewer should be destroyed');});QUnit.test('fileType and integrity test',async function(assert){assert.expect(3);var viewer=await createViewer({attachmentID:2,attachments:this.attachments,});assert.strictEqual(this.attachments[1].type,'url',"the type should be url");assert.strictEqual(this.attachments[1].fileType,'youtu',"there should be a fileType 'youtu'");assert.strictEqual(this.attachments[1].youtube,'FYqW0Gdwbzk',"there should be a youtube token");viewer.destroy();});});});});;

/* /mail/static/tests/many2one_avatar_user_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail.Many2OneAvatarUserTests',function(require){"use strict";const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');const KanbanView=require('web.KanbanView');const ListView=require('web.ListView');const{Many2OneAvatarUser}=require('mail.Many2OneAvatarUser');const{dom,mock}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('Many2OneAvatarUser',{beforeEach(){beforeEach(this);Many2OneAvatarUser.prototype.partnerIds={};Object.assign(this.data,{'foo':{fields:{user_id:{string:"User",type:'many2one',relation:'res.users'},},records:[{id:1,user_id:11},{id:2,user_id:7},{id:3,user_id:11},{id:4,user_id:23},],},});this.data['res.partner'].records.push({id:11,display_name:"Partner 1"},{id:12,display_name:"Partner 2"},{id:13,display_name:"Partner 3"});this.data['res.users'].records.push({id:11,name:"Mario",partner_id:11},{id:7,name:"Luigi",partner_id:12},{id:23,name:"Yoshi",partner_id:13});},afterEach(){afterEach(this);},});QUnit.test('many2one_avatar_user widget in list view',async function(assert){assert.expect(5);const{widget:list}=await start({hasView:true,View:ListView,model:'foo',data:this.data,arch:'<tree><field name="user_id" widget="many2one_avatar_user"/></tree>',mockRPC(route,args){if(args.method==='read'){assert.step(`read ${args.model} ${args.args[0]}`);}
return this._super(...arguments);},});mock.intercept(list,'open_record',()=>{assert.step('open record');});assert.strictEqual(list.$('.o_data_cell span').text(),'MarioLuigiMarioYoshi');await dom.click(list.$('.o_data_row:first span'));await dom.click(list.$('.o_data_cell:nth(0) .o_m2o_avatar'));await dom.click(list.$('.o_data_cell:nth(1) .o_m2o_avatar'));await dom.click(list.$('.o_data_cell:nth(2) .o_m2o_avatar'));assert.verifySteps(['open record','read res.users 11','read res.users 7',]);list.destroy();});QUnit.test('many2one_avatar_user widget in kanban view',async function(assert){assert.expect(6);const{widget:kanban}=await start({hasView:true,View:KanbanView,model:'foo',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="user_id" widget="many2one_avatar_user"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,});assert.strictEqual(kanban.$('.o_kanban_record').text().trim(),'');assert.containsN(kanban,'.o_m2o_avatar',4);assert.strictEqual(kanban.$('.o_m2o_avatar:nth(0)').data('src'),'/web/image/res.users/11/image_128');assert.strictEqual(kanban.$('.o_m2o_avatar:nth(1)').data('src'),'/web/image/res.users/7/image_128');assert.strictEqual(kanban.$('.o_m2o_avatar:nth(2)').data('src'),'/web/image/res.users/11/image_128');assert.strictEqual(kanban.$('.o_m2o_avatar:nth(3)').data('src'),'/web/image/res.users/23/image_128');kanban.destroy();});});});;

/* /mail/static/tests/systray/systray_activity_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail.systray.ActivityMenuTests',function(require){"use strict";const{afterEach,afterNextRender,beforeEach,start,}=require('mail/static/src/utils/test_utils.js');var ActivityMenu=require('mail.systray.ActivityMenu');var testUtils=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('ActivityMenu',{beforeEach(){beforeEach(this);Object.assign(this.data,{'mail.activity.menu':{fields:{name:{type:"char"},model:{type:"char"},type:{type:"char"},planned_count:{type:"integer"},today_count:{type:"integer"},overdue_count:{type:"integer"},total_count:{type:"integer"},actions:[{icon:{type:"char"},name:{type:"char"},action_xmlid:{type:"char"},}],},records:[{name:"Contact",model:"res.partner",type:"activity",planned_count:0,today_count:1,overdue_count:0,total_count:1,},{name:"Task",type:"activity",model:"project.task",planned_count:1,today_count:0,overdue_count:0,total_count:1,},{name:"Issue",type:"activity",model:"project.issue",planned_count:1,today_count:1,overdue_count:1,total_count:3,actions:[{icon:"fa-clock-o",name:"summary",}],},{name:"Note",type:"activity",model:"partner",planned_count:1,today_count:1,overdue_count:1,total_count:3,actions:[{icon:"fa-clock-o",name:"summary",action_xmlid:"mail.mail_activity_type_view_tree",}],}],},});this.session={uid:10,};},afterEach(){afterEach(this);},});QUnit.test('activity menu widget: menu with no records',async function(assert){assert.expect(1);const{widget}=await start({data:this.data,mockRPC:function(route,args){if(args.method==='systray_get_activities'){return Promise.resolve([]);}
return this._super(route,args);},});const activityMenu=new ActivityMenu(widget);await activityMenu.appendTo($('#qunit-fixture'));await testUtils.nextTick();assert.containsOnce(activityMenu,'.o_no_activity');widget.destroy();});QUnit.test('activity menu widget: activity menu with 3 records',async function(assert){assert.expect(10);var self=this;const{widget}=await start({data:this.data,mockRPC:function(route,args){if(args.method==='systray_get_activities'){return Promise.resolve(self.data['mail.activity.menu']['records']);}
return this._super(route,args);},});var activityMenu=new ActivityMenu(widget);await activityMenu.appendTo($('#qunit-fixture'));await testUtils.nextTick();assert.hasClass(activityMenu.$el,'o_mail_systray_item','should be the instance of widget');assert.ok(activityMenu.$('.o_mail_preview').length);assert.containsOnce(activityMenu.$el,'.o_notification_counter',"widget should have notification counter");assert.strictEqual(parseInt(activityMenu.el.innerText),8,"widget should have 8 notification counter");var context={};testUtils.mock.intercept(activityMenu,'do_action',function(event){assert.deepEqual(event.data.action.context,context,"wrong context value");},true);context={force_search_count:1,search_default_activities_overdue:1,};await testUtils.dom.click(activityMenu.$('.dropdown-toggle'));assert.hasClass(activityMenu.$el,'show','ActivityMenu should be open');await testUtils.dom.click(activityMenu.$(".o_activity_filter_button[data-model_name='Issue'][data-filter='overdue']"));assert.doesNotHaveClass(activityMenu.$el,'show','ActivityMenu should be closed');context={force_search_count:1,search_default_activities_today:1,};await testUtils.dom.click(activityMenu.$('.dropdown-toggle'));await testUtils.dom.click(activityMenu.$(".o_activity_filter_button[data-model_name='Issue'][data-filter='today']"));context={force_search_count:1,search_default_activities_upcoming_all:1,};await testUtils.dom.click(activityMenu.$('.dropdown-toggle'));await testUtils.dom.click(activityMenu.$(".o_activity_filter_button[data-model_name='Issue'][data-filter='upcoming_all']"));context={force_search_count:1,search_default_activities_overdue:1,search_default_activities_today:1,};await testUtils.dom.click(activityMenu.$('.dropdown-toggle'));await testUtils.dom.click(activityMenu.$(".o_mail_systray_dropdown_items > div[data-model_name='Issue']"));widget.destroy();});QUnit.test('activity menu widget: activity view icon',async function(assert){assert.expect(12);var self=this;const{widget}=await start({data:this.data,mockRPC:function(route,args){if(args.method==='systray_get_activities'){return Promise.resolve(self.data['mail.activity.menu'].records);}
return this._super(route,args);},session:this.session,});var activityMenu=new ActivityMenu(widget);await activityMenu.appendTo($('#qunit-fixture'));await testUtils.nextTick();assert.containsN(activityMenu,'.o_mail_activity_action',2,"widget should have 2 activity view icons");var $first=activityMenu.$('.o_mail_activity_action').eq(0);var $second=activityMenu.$('.o_mail_activity_action').eq(1);assert.strictEqual($first.data('model_name'),"Issue","first activity action should link to 'Issue'");assert.hasClass($first,'fa-clock-o',"should display the activity action icon");assert.strictEqual($second.data('model_name'),"Note","Second activity action should link to 'Note'");assert.hasClass($second,'fa-clock-o',"should display the activity action icon");testUtils.mock.intercept(activityMenu,'do_action',function(ev){if(ev.data.action.name){assert.ok(ev.data.action.domain,"should define a domain on the action");assert.deepEqual(ev.data.action.domain,[["activity_ids.user_id","=",10]],"should set domain to user's activity only");assert.step('do_action:'+ev.data.action.name);}else{assert.step('do_action:'+ev.data.action);}},true);await testUtils.dom.click(activityMenu.$('.dropdown-toggle'));assert.hasClass(activityMenu.$('.dropdown-menu'),'show',"dropdown should be expanded");await testUtils.dom.click(activityMenu.$(".o_mail_activity_action[data-model_name='Issue']"));assert.doesNotHaveClass(activityMenu.$('.dropdown-menu'),'show',"dropdown should be collapsed");await testUtils.dom.click(activityMenu.$('.dropdown-toggle'));await testUtils.dom.click(activityMenu.$(".o_mail_activity_action[data-model_name='Note']"));assert.verifySteps(['do_action:Issue','do_action:mail.mail_activity_type_view_tree']);widget.destroy();});QUnit.test('activity menu widget: close on messaging menu click',async function(assert){assert.expect(2);const{widget}=await start({data:this.data,hasMessagingMenu:true,async mockRPC(route,args){if(args.method==='message_fetch'){return[];}
if(args.method==='systray_get_activities'){return[];}
return this._super(route,args);},});const activityMenu=new ActivityMenu(widget);await activityMenu.appendTo($('#qunit-fixture'));await testUtils.nextTick();await testUtils.dom.click(activityMenu.$('.dropdown-toggle'));assert.hasClass(activityMenu.el.querySelector('.o_mail_systray_dropdown'),'show',"activity menu should be shown after click on itself");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.doesNotHaveClass(activityMenu.el.querySelector('.o_mail_systray_dropdown'),'show',"activity menu should be hidden after click on messaging menu");widget.destroy();});});});;

/* /mail/static/tests/tools/debug_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail.debugManagerTests',function(require){"use strict";var testUtils=require('web.test_utils');var createDebugManager=testUtils.createDebugManager;QUnit.module('Mail DebugManager',{},function(){QUnit.test("Manage Messages",async function(assert){assert.expect(3);var debugManager=await createDebugManager({intercepts:{do_action:function(event){assert.deepEqual(event.data.action,{context:{default_res_model:"testModel",default_res_id:5,},res_model:'mail.message',name:"Manage Messages",views:[[false,'list'],[false,'form']],type:'ir.actions.act_window',domain:[['res_id','=',5],['model','=','testModel']],});},},});await debugManager.appendTo($('#qunit-fixture'));var action={views:[{displayName:"Form",fieldsView:{view_id:1,},type:"form",}],};var view={viewType:"form",getSelectedIds:function(){return[5];},modelName:'testModel',};await testUtils.nextTick();await debugManager.update('action',action,view);var $messageMenu=debugManager.$('a[data-action=getMailMessages]');assert.strictEqual($messageMenu.length,1,"should have Manage Message menu item");assert.strictEqual($messageMenu.text().trim(),"Manage Messages","should have correct menu item text");await testUtils.dom.click(debugManager.$('> a'));await testUtils.dom.click($messageMenu);debugManager.destroy();});});});;

/* /mail/static/tests/activity_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail.activity_view_tests',function(require){'use strict';var ActivityView=require('mail.ActivityView');var testUtils=require('web.test_utils');var createActionManager=testUtils.createActionManager;var createView=testUtils.createView;QUnit.module('mail',{},function(){QUnit.module('activity view',{beforeEach:function(){this.data={task:{fields:{id:{string:'ID',type:'integer'},foo:{string:"Foo",type:"char"},activity_ids:{string:'Activities',type:'one2many',relation:'mail.activity',relation_field:'res_id',},},records:[{id:13,foo:'Meeting Room Furnitures',activity_ids:[1]},{id:30,foo:'Office planning',activity_ids:[2,3]},],},partner:{fields:{display_name:{string:"Displayed name",type:"char"},},records:[{id:2,display_name:"first partner",}]},'mail.activity':{fields:{res_id:{string:'Related document id',type:'integer'},activity_type_id:{string:"Activity type",type:"many2one",relation:"mail.activity.type"},display_name:{string:"Display name",type:"char"},date_deadline:{string:"Due Date",type:"date"},can_write:{string:"Can write",type:"boolean"},state:{string:'State',type:'selection',selection:[['overdue','Overdue'],['today','Today'],['planned','Planned']],},mail_template_ids:{string:"Mail templates",type:"many2many",relation:"mail.template"},user_id:{string:"Assigned to",type:"many2one",relation:'partner'},},records:[{id:1,res_id:13,display_name:"An activity",date_deadline:moment().add(3,"days").format("YYYY-MM-DD"),can_write:true,state:"planned",activity_type_id:1,mail_template_ids:[8,9],user_id:2,},{id:2,res_id:30,display_name:"An activity",date_deadline:moment().format("YYYY-MM-DD"),can_write:true,state:"today",activity_type_id:1,mail_template_ids:[8,9],user_id:2,},{id:3,res_id:30,display_name:"An activity",date_deadline:moment().subtract(2,"days").format("YYYY-MM-DD"),can_write:true,state:"overdue",activity_type_id:2,mail_template_ids:[],user_id:2,}],},'mail.template':{fields:{name:{string:"Name",type:"char"},},records:[{id:8,name:"Template1"},{id:9,name:"Template2"},],},'mail.activity.type':{fields:{mail_template_ids:{string:"Mail templates",type:"many2many",relation:"mail.template"},name:{string:"Name",type:"char"},},records:[{id:1,name:"Email",mail_template_ids:[8,9]},{id:2,name:"Call"},{id:3,name:"Call for Demo"},{id:4,name:"To Do"},],},};}});var activityDateFormat=function(date){return date.toLocaleDateString(moment().locale(),{day:'numeric',month:'short'});};QUnit.test('activity view: simple activity rendering',async function(assert){assert.expect(14);var activity=await createView({View:ActivityView,model:'task',data:this.data,arch:'<activity string="Task">'+'<templates>'+'<div t-name="activity-box">'+'<field name="foo"/>'+'</div>'+'</templates>'+'</activity>',intercepts:{do_action:function(event){assert.deepEqual(event.data.action,{context:{default_res_id:30,default_res_model:"task",default_activity_type_id:3,},res_id:false,res_model:"mail.activity",target:"new",type:"ir.actions.act_window",view_mode:"form",view_type:"form",views:[[false,"form"]]},"should do a do_action with correct parameters");event.data.options.on_close();},},});assert.containsOnce(activity,'table','should have a table');var $th1=activity.$('table thead tr:first th:nth-child(2)');assert.containsOnce($th1,'span:first:contains(Email)','should contain "Email" in header of first column');assert.containsOnce($th1,'.o_kanban_counter','should contain a progressbar in header of first column');assert.hasAttrValue($th1.find('.o_kanban_counter_progress .progress-bar:first'),'data-original-title','1 Planned','the counter progressbars should be correctly displayed');assert.hasAttrValue($th1.find('.o_kanban_counter_progress .progress-bar:nth-child(2)'),'data-original-title','1 Today','the counter progressbars should be correctly displayed');var $th2=activity.$('table thead tr:first th:nth-child(3)');assert.containsOnce($th2,'span:first:contains(Call)','should contain "Call" in header of second column');assert.hasAttrValue($th2.find('.o_kanban_counter_progress .progress-bar:nth-child(3)'),'data-original-title','1 Overdue','the counter progressbars should be correctly displayed');assert.containsNone(activity,'table thead tr:first th:nth-child(4) .o_kanban_counter','should not contain a progressbar in header of 3rd column');assert.ok(activity.$('table tbody tr:first td:first:contains(Office planning)').length,'should contain "Office planning" in first colum of first row');assert.ok(activity.$('table tbody tr:nth-child(2) td:first:contains(Meeting Room Furnitures)').length,'should contain "Meeting Room Furnitures" in first colum of second row');var today=activityDateFormat(new Date());assert.ok(activity.$('table tbody tr:first td:nth-child(2).today .o_closest_deadline:contains('+today+')').length,'should contain an activity for today in second cell of first line '+today);var td='table tbody tr:nth-child(1) td.o_activity_empty_cell';assert.containsN(activity,td,2,'should contain an empty cell as no activity scheduled yet.');await testUtils.fields.editAndTrigger(activity.$(td+':first'),null,['mouseenter','click']);assert.containsOnce(activity,'table tfoot tr .o_record_selector','should contain search more selector to choose the record to schedule an activity for it');activity.destroy();});QUnit.test('activity view: no content rendering',async function(assert){assert.expect(2);this.data['mail.activity'].records=[];this.data.task.records.forEach(function(task){task.activity_ids=false;});this.data['mail.activity.type'].records=[];var activity=await createView({View:ActivityView,model:'task',data:this.data,arch:'<activity string="Task">'+'<templates>'+'<div t-name="activity-box">'+'<field name="foo"/>'+'</div>'+'</templates>'+'</activity>',});assert.containsOnce(activity,'.o_view_nocontent',"should display the no content helper");assert.strictEqual(activity.$('.o_view_nocontent .o_view_nocontent_empty_folder').text().trim(),"No data to display","should display the no content helper text");activity.destroy();});QUnit.test('activity view: batch send mail on activity',async function(assert){assert.expect(6);var activity=await createView({View:ActivityView,model:'task',data:this.data,arch:'<activity string="Task">'+'<templates>'+'<div t-name="activity-box">'+'<field name="foo"/>'+'</div>'+'</templates>'+'</activity>',mockRPC:function(route,args){if(args.method==='activity_send_mail'){assert.step(JSON.stringify(args.args));return Promise.resolve();}
return this._super.apply(this,arguments);},});assert.notOk(activity.$('table thead tr:first th:nth-child(2) span:nth-child(2) .dropdown-menu.show').length,'dropdown shouldn\'t be displayed');testUtils.dom.click(activity.$('table thead tr:first th:nth-child(2) span:nth-child(2) i.fa-ellipsis-v'));assert.ok(activity.$('table thead tr:first th:nth-child(2) span:nth-child(2) .dropdown-menu.show').length,'dropdown should have appeared');testUtils.dom.click(activity.$('table thead tr:first th:nth-child(2) span:nth-child(2) .dropdown-menu.show .o_send_mail_template:contains(Template2)'));assert.notOk(activity.$('table thead tr:first th:nth-child(2) span:nth-child(2) .dropdown-menu.show').length,'dropdown shouldn\'t be displayed');testUtils.dom.click(activity.$('table thead tr:first th:nth-child(2) span:nth-child(2) i.fa-ellipsis-v'));testUtils.dom.click(activity.$('table thead tr:first th:nth-child(2) span:nth-child(2) .dropdown-menu.show .o_send_mail_template:contains(Template1)'));assert.verifySteps(['[[13,30],9]','[[13,30],8]',]);activity.destroy();});QUnit.test('activity view: activity widget',async function(assert){assert.expect(16);const params={View:ActivityView,model:'task',data:this.data,arch:'<activity string="Task">'+'<templates>'+'<div t-name="activity-box">'+'<field name="foo"/>'+'</div>'+'</templates>'+'</activity>',mockRPC:function(route,args){if(args.method==='activity_send_mail'){assert.deepEqual([[30],8],args.args,"Should send template 8 on record 30");assert.step('activity_send_mail');return Promise.resolve();}
if(args.method==='action_feedback_schedule_next'){assert.deepEqual([[3]],args.args,"Should execute action_feedback_schedule_next on activity 3 only ");assert.equal(args.kwargs.feedback,"feedback2");assert.step('action_feedback_schedule_next');return Promise.resolve({serverGeneratedAction:true});}
return this._super.apply(this,arguments);},intercepts:{do_action:function(ev){var action=ev.data.action;if(action.serverGeneratedAction){assert.step('serverGeneratedAction');}else if(action.res_model==='mail.compose.message'){assert.deepEqual({default_model:"task",default_res_id:30,default_template_id:8,default_use_template:true,force_email:true},action.context);assert.step("do_action_compose");}else if(action.res_model==='mail.activity'){assert.deepEqual({"default_res_id":30,"default_res_model":"task"},action.context);assert.step("do_action_activity");}else{assert.step("Unexpected action");}},},};var activity=await createView(params);var today=activity.$('table tbody tr:first td:nth-child(2).today');var dropdown=today.find('.dropdown-menu.o_activity');await testUtils.dom.click(today.find('.o_closest_deadline'));assert.hasClass(dropdown,'show',"dropdown should be displayed");assert.ok(dropdown.find('.o_activity_color_today:contains(Today)').length,"Title should be today");assert.ok(dropdown.find('.o_activity_title_entry[data-activity-id="2"]:first div:contains(template8)').length,"template8 should be available");assert.ok(dropdown.find('.o_activity_title_entry[data-activity-id="2"]:eq(1) div:contains(template9)').length,"template9 should be available");await testUtils.dom.click(dropdown.find('.o_activity_title_entry[data-activity-id="2"]:first .o_activity_template_preview'));await testUtils.dom.click(dropdown.find('.o_activity_title_entry[data-activity-id="2"]:first .o_activity_template_send'));var overdue=activity.$('table tbody tr:first td:nth-child(3).overdue');await testUtils.dom.click(overdue.find('.o_closest_deadline'));dropdown=overdue.find('.dropdown-menu.o_activity');assert.notOk(dropdown.find('.o_activity_title div div div:first span').length,"No template should be available");await testUtils.dom.click(dropdown.find('.o_schedule_activity'));await testUtils.dom.click(overdue.find('.o_closest_deadline'));await testUtils.dom.click(dropdown.find('.o_mark_as_done'));dropdown.find('#activity_feedback').val("feedback2");await testUtils.dom.click(dropdown.find('.o_activity_popover_done_next'));assert.verifySteps(["do_action_compose","activity_send_mail","do_action_activity","action_feedback_schedule_next","serverGeneratedAction"]);activity.destroy();});QUnit.test('activity view: no group_by_menu and no comparison_menu',async function(assert){assert.expect(4);var actionManager=await createActionManager({actions:[{id:1,name:'Task Action',res_model:'task',type:'ir.actions.act_window',views:[[false,'activity']],}],archs:{'task,false,activity':'<activity string="Task">'+'<templates>'+'<div t-name="activity-box">'+'<field name="foo"/>'+'</div>'+'</templates>'+'</activity>','task,false,search':'<search></search>',},data:this.data,session:{user_context:{lang:'zz_ZZ'},},mockRPC:function(route,args){if(args.method==='get_activity_data'){assert.deepEqual(args.kwargs.context,{lang:'zz_ZZ'},'The context should have been passed');}
return this._super.apply(this,arguments);},});await actionManager.doAction(1);assert.containsN(actionManager,'.o_search_options .o_dropdown button:visible',2,"only two elements should be available in view search");assert.isVisible(actionManager.$('.o_search_options .o_dropdown.o_filter_menu > button'),"filter should be available in view search");assert.isVisible(actionManager.$('.o_search_options .o_dropdown.o_favorite_menu > button'),"favorites should be available in view search");actionManager.destroy();});QUnit.test('activity view: search more to schedule an activity for a record of a respecting model',async function(assert){assert.expect(5);_.extend(this.data.task.fields,{name:{string:"Name",type:"char"},});this.data.task.records[2]={id:31,name:"Task 3"};var activity=await createView({View:ActivityView,model:'task',data:this.data,arch:'<activity string="Task">'+'<templates>'+'<div t-name="activity-box">'+'<field name="foo"/>'+'</div>'+'</templates>'+'</activity>',archs:{"task,false,list":'<tree string="Task"><field name="name"/></tree>',"task,false,search":'<search></search>',},mockRPC:function(route,args){if(args.method==='name_search'){args.kwargs.name="Task";}
return this._super.apply(this,arguments);},intercepts:{do_action:function(ev){assert.step('doAction');var expectedAction={context:{default_res_id:{id:31,display_name:undefined},default_res_model:"task",},name:"Schedule Activity",res_id:false,res_model:"mail.activity",target:"new",type:"ir.actions.act_window",view_mode:"form",views:[[false,"form"]],};assert.deepEqual(ev.data.action,expectedAction,"should execute an action with correct params");ev.data.options.on_close();},},});assert.containsOnce(activity,'table tfoot tr .o_record_selector','should contain search more selector to choose the record to schedule an activity for it');await testUtils.dom.click(activity.$('table tfoot tr .o_record_selector'));var $modal=$('.modal-lg');assert.strictEqual($modal.find('.o_data_row').length,3,"all tasks should be available to select");testUtils.dom.click($modal.find('.o_data_row:last'));assert.verifySteps(['doAction']);activity.destroy();});QUnit.test('Activity view: discard an activity creation dialog',async function(assert){assert.expect(2);var actionManager=await createActionManager({actions:[{id:1,name:'Task Action',res_model:'task',type:'ir.actions.act_window',views:[[false,'activity']],}],archs:{'task,false,activity':`
                <activity string="Task">
                    <templates>
                        <div t-name="activity-box">
                            <field name="foo"/>
                        </div>
                    </templates>
                </activity>`,'task,false,search':'<search></search>','mail.activity,false,form':`
                <form>
                    <field name="display_name"/>
                    <footer>
                        <button string="Discard" class="btn-secondary" special="cancel"/>
                    </footer>
                </form>`},data:this.data,intercepts:{do_action(ev){actionManager.doAction(ev.data.action,ev.data.options);}},async mockRPC(route,args){if(args.method==='check_access_rights'){return true;}
return this._super(...arguments);},});await actionManager.doAction(1);await testUtils.dom.click(actionManager.$('.o_activity_view .o_data_row .o_activity_empty_cell')[0]);assert.containsOnce($,'.modal.o_technical_modal.show',"Activity Modal should be opened");await testUtils.dom.click($('.modal.o_technical_modal.show button[special="cancel"]'));assert.containsNone($,'.modal.o_technical_modal.show',"Activity Modal should be closed");actionManager.destroy();});});});;

/* /mail/static/src/bugfix/bugfix_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/bugfix/bugfix_tests.js',function(require){'use strict';QUnit.module('mail',{},function(){QUnit.module('bugfix',{},function(){QUnit.module('bugfix_tests.js',{});});});});;

/* /mail/static/src/component_hooks/use_store/use_store_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/component_hooks/use_store/use_store_tests.js',function(require){'use strict';const useStore=require('mail/static/src/component_hooks/use_store/use_store.js');const{afterNextRender,nextAnimationFrame,}=require('mail/static/src/utils/test_utils.js');const{Component,QWeb,Store}=owl;const{onPatched,useGetters}=owl.hooks;const{xml}=owl.tags;QUnit.module('mail',{},function(){QUnit.module('component_hooks',{},function(){QUnit.module('use_store',{},function(){QUnit.module('use_store_tests.js',{beforeEach(){const qweb=new QWeb();this.env={qweb};},afterEach(){this.env=undefined;this.store=undefined;},});QUnit.test("compare keys, no depth, primitives",async function(assert){assert.expect(8);this.store=new Store({env:this.env,getters:{get({state},key){return state[key];},},state:{obj:{subObj1:'a',subObj2:'b',use1:true,},},});this.env.store=this.store;let count=0;class MyComponent extends Component{constructor(){super(...arguments);this.storeGetters=useGetters();this.storeProps=useStore(props=>{const obj=this.storeGetters.get('obj');return{res:obj.use1?obj.subObj1:obj.subObj2,};});onPatched(()=>{count++;});}}
Object.assign(MyComponent,{env:this.env,props:{},template:xml`<div t-esc="storeProps.res"/>`,});const fixture=document.querySelector('#qunit-fixture');const myComponent=new MyComponent();await myComponent.mount(fixture);assert.strictEqual(count,0,'should not detect an update initially');assert.strictEqual(fixture.textContent,'a','should display the content of subObj1');await afterNextRender(()=>{this.store.state.obj.use1=false;});assert.strictEqual(count,1,'should detect an update because the selector is returning a different value (was subObj1, now is subObj2)');assert.strictEqual(fixture.textContent,'b','should display the content of subObj2');this.store.state.obj.subObj2='b';await nextAnimationFrame();assert.strictEqual(count,1,'should not detect an update because the same primitive value was assigned (subObj2 was already "b")');assert.strictEqual(fixture.textContent,'b','should still display the content of subObj2');await afterNextRender(()=>{this.store.state.obj.subObj2='d';});assert.strictEqual(count,2,'should detect an update because the selector is returning a different value for subObj2');assert.strictEqual(fixture.textContent,'d','should display the new content of subObj2');myComponent.destroy();});QUnit.test("compare keys, depth 1, proxy",async function(assert){assert.expect(8);this.store=new Store({env:this.env,getters:{get({state},key){return state[key];},},state:{obj:{subObj1:{a:'a'},subObj2:{a:'b'},use1:true,},},});this.env.store=this.store;let count=0;class MyComponent extends Component{constructor(){super(...arguments);this.storeGetters=useGetters();this.storeProps=useStore(props=>{const obj=this.storeGetters.get('obj');return{array:[obj.use1?obj.subObj1:obj.subObj2],};},{compareDepth:{array:1,},});onPatched(()=>{count++;});}}
Object.assign(MyComponent,{env:this.env,props:{},template:xml`<div t-esc="storeProps.array[0].a"/>`,});const fixture=document.querySelector('#qunit-fixture');const myComponent=new MyComponent();await myComponent.mount(fixture);assert.strictEqual(count,0,'should not detect an update initially');assert.strictEqual(fixture.textContent,'a','should display the content of subObj1');await afterNextRender(()=>{this.store.state.obj.use1=false;});assert.strictEqual(count,1,'should detect an update because the selector is returning a different value (was subObj1, now is subObj2)');assert.strictEqual(fixture.textContent,'b','should display the content of subObj2');this.store.state.obj.subObj1.a='c';await nextAnimationFrame();assert.strictEqual(count,1,'should not detect an update because subObj1 was changed but only subObj2 is selected');assert.strictEqual(fixture.textContent,'b','should still display the content of subObj2');await afterNextRender(()=>{this.store.state.obj.subObj2.a='d';});assert.strictEqual(count,2,'should detect an update because the value of subObj2 changed');assert.strictEqual(fixture.textContent,'d','should display the new content of subObj2');myComponent.destroy();});});});});});;

/* /mail/static/src/components/activity/activity_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/activity/activity_tests.js',function(require){'use strict';const components={Activity:require('mail/static/src/components/activity/activity.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');const useStore=require('mail/static/src/component_hooks/use_store/use_store.js');const Bus=require('web.Bus');const{date_to_str}=require('web.time');const{Component,tags:{xml}}=owl;QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('activity',{},function(){QUnit.module('activity_tests.js',{beforeEach(){beforeEach(this);this.createActivityComponent=async function(activity){await createRootComponent(this,components.Activity,{props:{activityLocalId:activity.localId},target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('activity simplest layout',async function(assert){assert.expect(12);await this.start();const activity=this.env.models['mail.activity'].create({id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_sidebar').length,1,"should have activity sidebar");assert.strictEqual(document.querySelectorAll('.o_Activity_core').length,1,"should have activity core");assert.strictEqual(document.querySelectorAll('.o_Activity_user').length,1,"should have activity user");assert.strictEqual(document.querySelectorAll('.o_Activity_info').length,1,"should have activity info");assert.strictEqual(document.querySelectorAll('.o_Activity_note').length,0,"should not have activity note");assert.strictEqual(document.querySelectorAll('.o_Activity_details').length,0,"should not have activity details");assert.strictEqual(document.querySelectorAll('.o_Activity_mailTemplates').length,0,"should not have activity mail templates");assert.strictEqual(document.querySelectorAll('.o_Activity_editButton').length,0,"should not have activity Edit button");assert.strictEqual(document.querySelectorAll('.o_Activity_cancelButton').length,0,"should not have activity Cancel button");assert.strictEqual(document.querySelectorAll('.o_Activity_markDoneButton').length,0,"should not have activity Mark as Done button");assert.strictEqual(document.querySelectorAll('.o_Activity_uploadButton').length,0,"should not have activity Upload button");});QUnit.test('activity with note layout',async function(assert){assert.expect(3);await this.start();const activity=this.env.models['mail.activity'].create({id:12,note:'There is no good or bad note',thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_note').length,1,"should have activity note");assert.strictEqual(document.querySelector('.o_Activity_note').textContent,"There is no good or bad note","activity note should be 'There is no good or bad note'");});QUnit.test('activity info layout when planned after tomorrow',async function(assert){assert.expect(4);await this.start();const today=new Date();const fiveDaysFromNow=new Date();fiveDaysFromNow.setDate(today.getDate()+5);const activity=this.env.models['mail.activity'].create({dateDeadline:date_to_str(fiveDaysFromNow),id:12,state:'planned',thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_dueDateText').length,1,"should have activity delay");assert.ok(document.querySelector('.o_Activity_dueDateText').classList.contains('o-planned'),"activity delay should have the right color modifier class (planned)");assert.strictEqual(document.querySelector('.o_Activity_dueDateText').textContent,"Due in 5 days:","activity delay should have 'Due in 5 days:' as label");});QUnit.test('activity info layout when planned tomorrow',async function(assert){assert.expect(4);await this.start();const today=new Date();const tomorrow=new Date();tomorrow.setDate(today.getDate()+1);const activity=this.env.models['mail.activity'].create({dateDeadline:date_to_str(tomorrow),id:12,state:'planned',thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_dueDateText').length,1,"should have activity delay");assert.ok(document.querySelector('.o_Activity_dueDateText').classList.contains('o-planned'),"activity delay should have the right color modifier class (planned)");assert.strictEqual(document.querySelector('.o_Activity_dueDateText').textContent,'Tomorrow:',"activity delay should have 'Tomorrow:' as label");});QUnit.test('activity info layout when planned today',async function(assert){assert.expect(4);await this.start();const today=new Date();const activity=this.env.models['mail.activity'].create({dateDeadline:date_to_str(today),id:12,state:'today',thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_dueDateText').length,1,"should have activity delay");assert.ok(document.querySelector('.o_Activity_dueDateText').classList.contains('o-today'),"activity delay should have the right color modifier class (today)");assert.strictEqual(document.querySelector('.o_Activity_dueDateText').textContent,"Today:","activity delay should have 'Today:' as label");});QUnit.test('activity info layout when planned yesterday',async function(assert){assert.expect(4);await this.start();const today=new Date();const yesterday=new Date();yesterday.setDate(today.getDate()-1);const activity=this.env.models['mail.activity'].create({dateDeadline:date_to_str(yesterday),id:12,state:'overdue',thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_dueDateText').length,1,"should have activity delay");assert.ok(document.querySelector('.o_Activity_dueDateText').classList.contains('o-overdue'),"activity delay should have the right color modifier class (overdue)");assert.strictEqual(document.querySelector('.o_Activity_dueDateText').textContent,"Yesterday:","activity delay should have 'Yesterday:' as label");});QUnit.test('activity info layout when planned before yesterday',async function(assert){assert.expect(4);await this.start();const today=new Date();const fiveDaysBeforeNow=new Date();fiveDaysBeforeNow.setDate(today.getDate()-5);const activity=this.env.models['mail.activity'].create({dateDeadline:date_to_str(fiveDaysBeforeNow),id:12,state:'overdue',thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_dueDateText').length,1,"should have activity delay");assert.ok(document.querySelector('.o_Activity_dueDateText').classList.contains('o-overdue'),"activity delay should have the right color modifier class (overdue)");assert.strictEqual(document.querySelector('.o_Activity_dueDateText').textContent,"5 days overdue:","activity delay should have '5 days overdue:' as label");});QUnit.test('activity with a summary layout',async function(assert){assert.expect(4);await this.start();const activity=this.env.models['mail.activity'].create({id:12,summary:'test summary',thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_summary').length,1,"should have activity summary");assert.strictEqual(document.querySelectorAll('.o_Activity_type').length,0,"should not have the activity type as summary");assert.strictEqual(document.querySelector('.o_Activity_summary').textContent.trim(),"“test summary”","should have the specific activity summary in activity summary");});QUnit.test('activity without summary layout',async function(assert){assert.expect(5);await this.start();const activity=this.env.models['mail.activity'].create({id:12,thread:[['insert',{id:42,model:'res.partner'}]],type:[['insert',{id:1,displayName:"Fake type"}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_type').length,1,"activity details should have an activity type section");assert.strictEqual(document.querySelector('.o_Activity_type').textContent.trim(),"Fake type","activity details should have the activity type display name in type section");assert.strictEqual(document.querySelectorAll('.o_Activity_summary.o_Activity_type').length,1,"should have activity type as summary");assert.strictEqual(document.querySelectorAll('.o_Activity_summary:not(.o_Activity_type)').length,0,"should not have a specific summary");});QUnit.test('activity details toggle',async function(assert){assert.expect(5);await this.start();const today=new Date();const tomorrow=new Date();tomorrow.setDate(today.getDate()+1);const activity=this.env.models['mail.activity'].create({creator:[['insert',{id:1,display_name:"Admin"}]],dateCreate:date_to_str(today),dateDeadline:date_to_str(tomorrow),id:12,state:'planned',thread:[['insert',{id:42,model:'res.partner'}]],type:[['insert',{id:1,displayName:"Fake type"}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_details').length,0,"activity details should not be visible by default");assert.strictEqual(document.querySelectorAll('.o_Activity_detailsButton').length,1,"activity should have a details button");await afterNextRender(()=>document.querySelector('.o_Activity_detailsButton').click());assert.strictEqual(document.querySelectorAll('.o_Activity_details').length,1,"activity details should be visible after clicking on details button");await afterNextRender(()=>document.querySelector('.o_Activity_detailsButton').click());assert.strictEqual(document.querySelectorAll('.o_Activity_details').length,0,"activity details should no longer be visible after clicking again on details button");});QUnit.test('activity details layout',async function(assert){assert.expect(11);await this.start();const today=new Date();const tomorrow=new Date();tomorrow.setDate(today.getDate()+1);const activity=this.env.models['mail.activity'].create({assignee:[['insert',{id:10,display_name:"Pauvre pomme"}]],creator:[['insert',{id:1,display_name:"Admin"}]],dateCreate:date_to_str(today),dateDeadline:date_to_str(tomorrow),id:12,state:'planned',thread:[['insert',{id:42,model:'res.partner'}]],type:[['insert',{id:1,displayName:"Fake type"}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_userAvatar').length,1,"should have activity user avatar");assert.strictEqual(document.querySelectorAll('.o_Activity_detailsButton').length,1,"activity should have a details button");await afterNextRender(()=>document.querySelector('.o_Activity_detailsButton').click());assert.strictEqual(document.querySelectorAll('.o_Activity_details').length,1,"activity details should be visible after clicking on details button");assert.strictEqual(document.querySelectorAll('.o_Activity_details .o_Activity_type').length,1,"activity details should have type");assert.strictEqual(document.querySelector('.o_Activity_details .o_Activity_type').textContent,"Fake type","activity details type should be 'Fake type'");assert.strictEqual(document.querySelectorAll('.o_Activity_detailsCreation').length,1,"activity details should have creation date ");assert.strictEqual(document.querySelectorAll('.o_Activity_detailsCreator').length,1,"activity details should have creator");assert.strictEqual(document.querySelectorAll('.o_Activity_detailsAssignation').length,1,"activity details should have assignation information");assert.strictEqual(document.querySelector('.o_Activity_detailsAssignation').textContent.indexOf('Pauvre pomme'),0,"activity details assignation information should contain creator display name");assert.strictEqual(document.querySelectorAll('.o_Activity_detailsAssignationUserAvatar').length,1,"activity details should have user avatar");});QUnit.test('activity with mail template layout',async function(assert){assert.expect(8);await this.start();const activity=this.env.models['mail.activity'].create({id:12,mailTemplates:[['insert',{id:1,name:"Dummy mail template"}]],thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_sidebar').length,1,"should have activity sidebar");assert.strictEqual(document.querySelectorAll('.o_Activity_mailTemplates').length,1,"should have activity mail templates");assert.strictEqual(document.querySelectorAll('.o_Activity_mailTemplate').length,1,"should have activity mail template");assert.strictEqual(document.querySelectorAll('.o_MailTemplate_name').length,1,"should have activity mail template name");assert.strictEqual(document.querySelector('.o_MailTemplate_name').textContent,"Dummy mail template","should have activity mail template name");assert.strictEqual(document.querySelectorAll('.o_MailTemplate_preview').length,1,"should have activity mail template name preview button");assert.strictEqual(document.querySelectorAll('.o_MailTemplate_send').length,1,"should have activity mail template name send button");});QUnit.test('activity with mail template: preview mail',async function(assert){assert.expect(10);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action.context.default_res_id,42,'Action should have the activity res id as default res id in context');assert.strictEqual(payload.action.context.default_model,'res.partner','Action should have the activity res model as default model in context');assert.ok(payload.action.context.default_use_template,'Action should have true as default use_template in context');assert.strictEqual(payload.action.context.default_template_id,1,'Action should have the selected mail template id as default template id in context');assert.strictEqual(payload.action.type,"ir.actions.act_window",'Action should be of type "ir.actions.act_window"');assert.strictEqual(payload.action.res_model,"mail.compose.message",'Action should have "mail.compose.message" as res_model');});await this.start({env:{bus}});const activity=this.env.models['mail.activity'].create({id:12,mailTemplates:[['insert',{id:1,name:"Dummy mail template",}]],thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_MailTemplate_preview').length,1,"should have activity mail template name preview button");document.querySelector('.o_MailTemplate_preview').click();assert.verifySteps(['do_action'],"should have called 'compose email' action correctly");});QUnit.test('activity with mail template: send mail',async function(assert){assert.expect(7);await this.start({async mockRPC(route,args){if(args.method==='activity_send_mail'){assert.step('activity_send_mail');assert.strictEqual(args.args[0].length,1);assert.strictEqual(args.args[0][0],42);assert.strictEqual(args.args[1],1);return;}else{return this._super(...arguments);}},});const activity=this.env.models['mail.activity'].create({id:12,mailTemplates:[['insert',{id:1,name:"Dummy mail template",}]],thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_MailTemplate_send').length,1,"should have activity mail template name send button");document.querySelector('.o_MailTemplate_send').click();assert.verifySteps(['activity_send_mail'],"should have called activity_send_mail rpc");});QUnit.test('activity upload document is available',async function(assert){assert.expect(3);await this.start();const today=new Date();const tomorrow=new Date();tomorrow.setDate(today.getDate()+1);const activity=this.env.models['mail.activity'].create({canWrite:true,category:'upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_uploadButton').length,1,"should have activity upload button");assert.strictEqual(document.querySelectorAll('.o_FileUploader').length,1,"should have a file uploader");});QUnit.test('activity click on mark as done',async function(assert){assert.expect(4);await this.start();const today=new Date();const tomorrow=new Date();tomorrow.setDate(today.getDate()+1);const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_markDoneButton').length,1,"should have activity Mark as Done button");await afterNextRender(()=>{document.querySelector('.o_Activity_markDoneButton').click();});assert.strictEqual(document.querySelectorAll('.o_ActivityMarkDonePopover').length,1,"should have opened the mark done popover");await afterNextRender(()=>{document.querySelector('.o_Activity_markDoneButton').click();});assert.strictEqual(document.querySelectorAll('.o_ActivityMarkDonePopover').length,0,"should have closed the mark done popover");});QUnit.test('activity mark as done popover should focus feedback input on open [REQUIRE FOCUS]',async function(assert){assert.expect(3);await this.start();const today=new Date();const tomorrow=new Date();tomorrow.setDate(today.getDate()+1);const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.containsOnce(document.body,'.o_Activity',"should have activity component");assert.containsOnce(document.body,'.o_Activity_markDoneButton',"should have activity Mark as Done button");await afterNextRender(()=>{document.querySelector('.o_Activity_markDoneButton').click();});assert.strictEqual(document.querySelector('.o_ActivityMarkDonePopover_feedback'),document.activeElement,"the popover textarea should have the focus");});QUnit.test('activity click on edit',async function(assert){assert.expect(9);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action.context.default_res_id,42,'Action should have the activity res id as default res id in context');assert.strictEqual(payload.action.context.default_res_model,'res.partner','Action should have the activity res model as default res model in context');assert.strictEqual(payload.action.type,"ir.actions.act_window",'Action should be of type "ir.actions.act_window"');assert.strictEqual(payload.action.res_model,"mail.activity",'Action should have "mail.activity" as res_model');assert.strictEqual(payload.action.res_id,12,'Action should have activity id as res_id');});await this.start({env:{bus}});const activity=this.env.models['mail.activity'].create({canWrite:true,id:12,mailTemplates:[['insert',{id:1,name:"Dummy mail template"}]],thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_editButton').length,1,"should have activity edit button");document.querySelector('.o_Activity_editButton').click();assert.verifySteps(['do_action'],"should have called 'schedule activity' action correctly");});QUnit.test('activity edition',async function(assert){assert.expect(14);this.data['mail.activity'].records.push({can_write:true,icon:'fa-times',id:12,res_id:42,res_model:'res.partner',});const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action.context.default_res_id,42,'Action should have the activity res id as default res id in context');assert.strictEqual(payload.action.context.default_res_model,'res.partner','Action should have the activity res model as default res model in context');assert.strictEqual(payload.action.type,'ir.actions.act_window','Action should be of type "ir.actions.act_window"');assert.strictEqual(payload.action.res_model,'mail.activity','Action should have "mail.activity" as res_model');assert.strictEqual(payload.action.res_id,12,'Action should have activity id as res_id');this.data['mail.activity'].records[0].icon='fa-check';payload.options.on_close();});await this.start({env:{bus}});const activity=this.env.models['mail.activity'].insert(this.env.models['mail.activity'].convertData(this.data['mail.activity'].records[0]));await this.createActivityComponent(activity);assert.containsOnce(document.body,'.o_Activity',"should have activity component");assert.containsOnce(document.body,'.o_Activity_editButton',"should have activity edit button");assert.containsOnce(document.body,'.o_Activity_icon',"should have activity icon");assert.containsOnce(document.body,'.o_Activity_icon.fa-times',"should have initial activity icon");assert.containsNone(document.body,'.o_Activity_icon.fa-check',"should not have new activity icon when not edited yet");await afterNextRender(()=>{document.querySelector('.o_Activity_editButton').click();});assert.verifySteps(['do_action'],"should have called 'schedule activity' action correctly");assert.containsNone(document.body,'.o_Activity_icon.fa-times',"should no more have initial activity icon once edited");assert.containsOnce(document.body,'.o_Activity_icon.fa-check',"should now have new activity icon once edited");});QUnit.test('activity click on cancel',async function(assert){assert.expect(7);await this.start({async mockRPC(route,args){if(route==='/web/dataset/call_kw/mail.activity/unlink'){assert.step('unlink');assert.strictEqual(args.args[0].length,1);assert.strictEqual(args.args[0][0],12);return;}else{return this._super(...arguments);}},});const activity=this.env.models['mail.activity'].create({canWrite:true,id:12,mailTemplates:[['insert',{id:1,name:"Dummy mail template",}]],thread:[['insert',{id:42,model:'res.partner'}]],});class ParentComponent extends Component{constructor(...args){super(...args);useStore(props=>{const activity=this.env.models['mail.activity'].get(props.activityLocalId);return{activity:activity?activity.__state:undefined,};});}
get activity(){return this.env.models['mail.activity'].get(this.props.activityLocalId);}}
ParentComponent.env=this.env;Object.assign(ParentComponent,{components,props:{activityLocalId:String},template:xml`
            <div>
                <p>parent</p>
                <t t-if="activity">
                    <Activity activityLocalId="activity.localId"/>
                </t>
            </div>
        `,});await createRootComponent(this,ParentComponent,{props:{activityLocalId:activity.localId},target:this.widget.el,});assert.strictEqual(document.querySelectorAll('.o_Activity').length,1,"should have activity component");assert.strictEqual(document.querySelectorAll('.o_Activity_cancelButton').length,1,"should have activity cancel button");await afterNextRender(()=>document.querySelector('.o_Activity_cancelButton').click());assert.verifySteps(['unlink'],"should have called unlink rpc after clicking on cancel");assert.strictEqual(document.querySelectorAll('.o_Activity').length,0,"should no longer display activity after clicking on cancel");});QUnit.test('activity mark done popover close on ESCAPE',async function(assert){assert.expect(2);await this.start();const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);await afterNextRender(()=>{document.querySelector('.o_Activity_markDoneButton').click();});assert.containsOnce(document.body,'.o_ActivityMarkDonePopover',"Popover component should be present");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:"Escape"});document.querySelector(`.o_ActivityMarkDonePopover`).dispatchEvent(ev);});assert.containsNone(document.body,'.o_ActivityMarkDonePopover',"ESCAPE pressed should have closed the mark done popover");});QUnit.test('activity mark done popover click on discard',async function(assert){assert.expect(3);await this.start();const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);await afterNextRender(()=>{document.querySelector('.o_Activity_markDoneButton').click();});assert.containsOnce(document.body,'.o_ActivityMarkDonePopover',"Popover component should be present");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_discardButton',"Popover component should contain the discard button");await afterNextRender(()=>document.querySelector('.o_ActivityMarkDonePopover_discardButton').click());assert.containsNone(document.body,'.o_ActivityMarkDonePopover',"Discard button clicked should have closed the mark done popover");});QUnit.test('data-oe-id & data-oe-model link redirection on click',async function(assert){assert.expect(7);const bus=new Bus();bus.on('do-action',null,payload=>{assert.strictEqual(payload.action.type,'ir.actions.act_window',"action should open view");assert.strictEqual(payload.action.res_model,'some.model',"action should open view on 'some.model' model");assert.strictEqual(payload.action.res_id,250,"action should open view on 250");assert.step('do-action:openFormView_some.model_250');});await this.start({env:{bus}});const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,note:`<p><a href="#" data-oe-id="250" data-oe-model="some.model">some.model_250</a></p>`,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityComponent(activity);assert.containsOnce(document.body,'.o_Activity_note',"activity should have a note");assert.containsOnce(document.querySelector('.o_Activity_note'),'a',"activity note should have a link");document.querySelector(`.o_Activity_note a`).click();assert.verifySteps(['do-action:openFormView_some.model_250'],"should have open form view on related record after click on link");});});});});});;

/* /mail/static/src/components/activity_mark_done_popover/activity_mark_done_popover_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/activity_mark_done_popover/activity_mark_done_popover_tests.js',function(require){'use strict';const components={ActivityMarkDonePopover:require('mail/static/src/components/activity_mark_done_popover/activity_mark_done_popover.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('activity_mark_done_popover',{},function(){QUnit.module('activity_mark_done_popover_tests.js',{beforeEach(){beforeEach(this);this.createActivityMarkDonePopoverComponent=async activity=>{await createRootComponent(this,components.ActivityMarkDonePopover,{props:{activityLocalId:activity.localId},target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('activity mark done popover simplest layout',async function(assert){assert.expect(6);await this.start();const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityMarkDonePopoverComponent(activity);assert.containsOnce(document.body,'.o_ActivityMarkDonePopover',"Popover component should be present");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_feedback',"Popover component should contain the feedback textarea");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_buttons',"Popover component should contain the action buttons");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_doneScheduleNextButton',"Popover component should contain the done & schedule next button");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_doneButton',"Popover component should contain the done button");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_discardButton',"Popover component should contain the discard button");});QUnit.test('activity with force next mark done popover simplest layout',async function(assert){assert.expect(6);await this.start();const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',force_next:true,id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityMarkDonePopoverComponent(activity);assert.containsOnce(document.body,'.o_ActivityMarkDonePopover',"Popover component should be present");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_feedback',"Popover component should contain the feedback textarea");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_buttons',"Popover component should contain the action buttons");assert.containsOnce(document.body,'.o_ActivityMarkDonePopover_doneScheduleNextButton',"Popover component should contain the done & schedule next button");assert.containsNone(document.body,'.o_ActivityMarkDonePopover_doneButton',"Popover component should NOT contain the done button");assert.containsNone(document.body,'.o_ActivityMarkDonePopover_discardButton',"Popover component should NOT contain the discard button");});QUnit.test('activity mark done popover mark done without feedback',async function(assert){assert.expect(7);await this.start({async mockRPC(route,args){if(route==='/web/dataset/call_kw/mail.activity/action_feedback'){assert.step('action_feedback');assert.strictEqual(args.args.length,1);assert.strictEqual(args.args[0].length,1);assert.strictEqual(args.args[0][0],12);assert.strictEqual(args.kwargs.attachment_ids.length,0);assert.notOk(args.kwargs.feedback);return;}
if(route==='/web/dataset/call_kw/mail.activity/unlink'){throw new Error("'unlink' RPC on activity must not be called (already unlinked from mark as done)");}
return this._super(...arguments);},});const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityMarkDonePopoverComponent(activity);document.querySelector('.o_ActivityMarkDonePopover_doneButton').click();assert.verifySteps(['action_feedback'],"Mark done and schedule next button should call the right rpc");});QUnit.test('activity mark done popover mark done with feedback',async function(assert){assert.expect(7);await this.start({async mockRPC(route,args){if(route==='/web/dataset/call_kw/mail.activity/action_feedback'){assert.step('action_feedback');assert.strictEqual(args.args.length,1);assert.strictEqual(args.args[0].length,1);assert.strictEqual(args.args[0][0],12);assert.strictEqual(args.kwargs.attachment_ids.length,0);assert.strictEqual(args.kwargs.feedback,'This task is done');return;}
if(route==='/web/dataset/call_kw/mail.activity/unlink'){throw new Error("'unlink' RPC on activity must not be called (already unlinked from mark as done)");}
return this._super(...arguments);},});const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityMarkDonePopoverComponent(activity);let feedbackTextarea=document.querySelector('.o_ActivityMarkDonePopover_feedback');feedbackTextarea.focus();document.execCommand('insertText',false,'This task is done');document.querySelector('.o_ActivityMarkDonePopover_doneButton').click();assert.verifySteps(['action_feedback'],"Mark done and schedule next button should call the right rpc");});QUnit.test('activity mark done popover mark done and schedule next',async function(assert){assert.expect(6);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('activity_action');throw new Error("The do-action event should not be triggered when the route doesn't return an action");});await this.start({async mockRPC(route,args){if(route==='/web/dataset/call_kw/mail.activity/action_feedback_schedule_next'){assert.step('action_feedback_schedule_next');assert.strictEqual(args.args.length,1);assert.strictEqual(args.args[0].length,1);assert.strictEqual(args.args[0][0],12);assert.strictEqual(args.kwargs.feedback,'This task is done');return false;}
if(route==='/web/dataset/call_kw/mail.activity/unlink'){throw new Error("'unlink' RPC on activity must not be called (already unlinked from mark as done)");}
return this._super(...arguments);},env:{bus},});const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityMarkDonePopoverComponent(activity);let feedbackTextarea=document.querySelector('.o_ActivityMarkDonePopover_feedback');feedbackTextarea.focus();document.execCommand('insertText',false,'This task is done');await afterNextRender(()=>{document.querySelector('.o_ActivityMarkDonePopover_doneScheduleNextButton').click();});assert.verifySteps(['action_feedback_schedule_next'],"Mark done and schedule next button should call the right rpc and not trigger an action");});QUnit.test('[technical] activity mark done & schedule next with new action',async function(assert){assert.expect(3);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('activity_action');assert.deepEqual(payload.action,{type:'ir.actions.act_window'},"The content of the action should be correct");});await this.start({async mockRPC(route,args){if(route==='/web/dataset/call_kw/mail.activity/action_feedback_schedule_next'){return{type:'ir.actions.act_window'};}
return this._super(...arguments);},env:{bus},});const activity=this.env.models['mail.activity'].create({canWrite:true,category:'not_upload_file',id:12,thread:[['insert',{id:42,model:'res.partner'}]],});await this.createActivityMarkDonePopoverComponent(activity);await afterNextRender(()=>{document.querySelector('.o_ActivityMarkDonePopover_doneScheduleNextButton').click();});assert.verifySteps(['activity_action'],"The action returned by the route should be executed");});});});});});;

/* /mail/static/src/components/attachment/attachment_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/attachment/attachment_tests.js',function(require){'use strict';const components={Attachment:require('mail/static/src/components/attachment/attachment.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('attachment',{},function(){QUnit.module('attachment_tests.js',{beforeEach(){beforeEach(this);this.createAttachmentComponent=async(attachment,otherProps)=>{const props=Object.assign({attachmentLocalId:attachment.localId},otherProps);await createRootComponent(this,components.Attachment,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('simplest layout',async function(assert){assert.expect(8);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'none',isDownloadable:false,isEditable:false,showExtension:false,showFilename:false,});assert.strictEqual(document.querySelectorAll('.o_Attachment').length,1,"should have attachment component in DOM");const attachmentEl=document.querySelector('.o_Attachment');assert.strictEqual(attachmentEl.dataset.attachmentLocalId,this.env.models['mail.attachment'].findFromIdentifyingData({id:750}).localId,"attachment component should be linked to attachment store model");assert.strictEqual(attachmentEl.title,"test.txt","attachment should have filename as title attribute");assert.strictEqual(attachmentEl.querySelectorAll(`:scope .o_Attachment_image`).length,1,"attachment should have an image part");const attachmentImage=document.querySelector(`.o_Attachment_image`);assert.ok(attachmentImage.classList.contains('o_image'),"attachment should have o_image classname (required for mimetype.scss style)");assert.strictEqual(attachmentImage.dataset.mimetype,'text/plain',"attachment should have data-mimetype set (required for mimetype.scss style)");assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,0,"attachment should not have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_aside`).length,0,"attachment should not have an aside part");});QUnit.test('simplest layout + deletable',async function(assert){assert.expect(6);await this.start({async mockRPC(route,args){if(route.includes('web/image/750')){assert.ok(route.includes('/160x160'),"should fetch image with 160x160 pixels ratio");assert.step('fetch_image');}
return this._super(...arguments);},});const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'none',isDownloadable:false,isEditable:true,showExtension:false,showFilename:false});assert.strictEqual(document.querySelectorAll('.o_Attachment').length,1,"should have attachment component in DOM");assert.strictEqual(document.querySelectorAll(`.o_Attachment_image`).length,1,"attachment should have an image part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,0,"attachment should not have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_aside`).length,1,"attachment should have an aside part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_asideItem`).length,1,"attachment should have only one aside item");assert.strictEqual(document.querySelectorAll(`.o_Attachment_asideItemUnlink`).length,1,"attachment should have a delete button");});QUnit.test('simplest layout + downloadable',async function(assert){assert.expect(6);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'none',isDownloadable:true,isEditable:false,showExtension:false,showFilename:false});assert.strictEqual(document.querySelectorAll('.o_Attachment').length,1,"should have attachment component in DOM");assert.strictEqual(document.querySelectorAll(`.o_Attachment_image`).length,1,"attachment should have an image part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,0,"attachment should not have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_aside`).length,1,"attachment should have an aside part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_asideItem`).length,1,"attachment should have only one aside item");assert.strictEqual(document.querySelectorAll(`.o_Attachment_asideItemDownload`).length,1,"attachment should have a download button");});QUnit.test('simplest layout + deletable + downloadable',async function(assert){assert.expect(8);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'none',isDownloadable:true,isEditable:true,showExtension:false,showFilename:false});assert.strictEqual(document.querySelectorAll('.o_Attachment').length,1,"should have attachment component in DOM");assert.strictEqual(document.querySelectorAll(`.o_Attachment_image`).length,1,"attachment should have an image part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,0,"attachment should not have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_aside`).length,1,"attachment should have an aside part");assert.ok(document.querySelector(`.o_Attachment_aside`).classList.contains('o-has-multiple-action'),"attachment aside should contain multiple actions");assert.strictEqual(document.querySelectorAll(`.o_Attachment_asideItem`).length,2,"attachment should have only two aside items");assert.strictEqual(document.querySelectorAll(`.o_Attachment_asideItemDownload`).length,1,"attachment should have a download button");assert.strictEqual(document.querySelectorAll(`.o_Attachment_asideItemUnlink`).length,1,"attachment should have a delete button");});QUnit.test('layout with card details',async function(assert){assert.expect(3);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'card',isDownloadable:false,isEditable:false,showExtension:false,showFilename:false});assert.strictEqual(document.querySelectorAll(`.o_Attachment_image`).length,1,"attachment should have an image part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,0,"attachment should not have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_aside`).length,0,"attachment should not have an aside part");});QUnit.test('layout with card details and filename',async function(assert){assert.expect(3);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'card',isDownloadable:false,isEditable:false,showExtension:false,showFilename:true});assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,1,"attachment should have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_filename`).length,1,"attachment should not have its filename shown");assert.strictEqual(document.querySelectorAll(`.o_Attachment_extension`).length,0,"attachment should have its extension shown");});QUnit.test('layout with card details and extension',async function(assert){assert.expect(3);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'card',isDownloadable:false,isEditable:false,showExtension:true,showFilename:false});assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,1,"attachment should have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_filename`).length,0,"attachment should not have its filename shown");assert.strictEqual(document.querySelectorAll(`.o_Attachment_extension`).length,1,"attachment should have its extension shown");});QUnit.test('layout with card details and filename and extension',async function(assert){assert.expect(3);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'card',isDownloadable:false,isEditable:false,showExtension:true,showFilename:true});assert.strictEqual(document.querySelectorAll(`.o_Attachment_details`).length,1,"attachment should have a details part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_filename`).length,1,"attachment should have its filename shown");assert.strictEqual(document.querySelectorAll(`.o_Attachment_extension`).length,1,"attachment should have its extension shown");});QUnit.test('simplest layout with hover details and filename and extension',async function(assert){assert.expect(8);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'hover',isDownloadable:true,isEditable:true,showExtension:true,showFilename:true});assert.strictEqual(document.querySelectorAll(`
            .o_Attachment_details:not(.o_Attachment_imageOverlayDetails)
        `).length,0,"attachment should not have a details part directly");assert.strictEqual(document.querySelectorAll(`.o_Attachment_imageOverlayDetails`).length,1,"attachment should have a details part in the overlay");assert.strictEqual(document.querySelectorAll(`.o_Attachment_image`).length,1,"attachment should have an image part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_imageOverlay`).length,1,"attachment should have an image overlay part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_filename`).length,1,"attachment should have its filename shown");assert.strictEqual(document.querySelectorAll(`.o_Attachment_extension`).length,1,"attachment should have its extension shown");assert.strictEqual(document.querySelectorAll(`.o_Attachment_actions`).length,1,"attachment should have an actions part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_aside`).length,0,"attachment should not have an aside element");});QUnit.test('auto layout with image',async function(assert){assert.expect(7);await this.start();const attachment=this.env.models['mail.attachment'].create({filename:"test.png",id:750,mimetype:'image/png',name:"test.png",});await this.createAttachmentComponent(attachment,{detailsMode:'auto',isDownloadable:false,isEditable:false,showExtension:true,showFilename:true});assert.strictEqual(document.querySelectorAll(`
            .o_Attachment_details:not(.o_Attachment_imageOverlayDetails)
        `).length,0,"attachment should not have a details part directly");assert.strictEqual(document.querySelectorAll(`.o_Attachment_imageOverlayDetails`).length,1,"attachment should have a details part in the overlay");assert.strictEqual(document.querySelectorAll(`.o_Attachment_image`).length,1,"attachment should have an image part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_imageOverlay`).length,1,"attachment should have an image overlay part");assert.strictEqual(document.querySelectorAll(`.o_Attachment_filename`).length,1,"attachment should have its filename shown");assert.strictEqual(document.querySelectorAll(`.o_Attachment_extension`).length,1,"attachment should have its extension shown");assert.strictEqual(document.querySelectorAll(`.o_Attachment_aside`).length,0,"attachment should not have an aside element");});QUnit.test('view attachment',async function(assert){assert.expect(3);await this.start({hasDialog:true,});const attachment=this.env.models['mail.attachment'].create({filename:"test.png",id:750,mimetype:'image/png',name:"test.png",});await this.createAttachmentComponent(attachment,{detailsMode:'hover',isDownloadable:false,isEditable:false,});assert.containsOnce(document.body,'.o_Attachment_image',"attachment should have an image part");await afterNextRender(()=>document.querySelector('.o_Attachment_image').click());assert.containsOnce(document.body,'.o_Dialog','a dialog should have been opened once attachment image is clicked',);assert.containsOnce(document.body,'.o_AttachmentViewer','an attachment viewer should have been opened once attachment image is clicked',);});QUnit.test('close attachment viewer',async function(assert){assert.expect(3);await this.start({hasDialog:true});const attachment=this.env.models['mail.attachment'].create({filename:"test.png",id:750,mimetype:'image/png',name:"test.png",});await this.createAttachmentComponent(attachment,{detailsMode:'hover',isDownloadable:false,isEditable:false,});assert.containsOnce(document.body,'.o_Attachment_image',"attachment should have an image part");await afterNextRender(()=>document.querySelector('.o_Attachment_image').click());assert.containsOnce(document.body,'.o_AttachmentViewer',"an attachment viewer should have been opened once attachment image is clicked",);await afterNextRender(()=>document.querySelector('.o_AttachmentViewer_headerItemButtonClose').click());assert.containsNone(document.body,'.o_Dialog',"attachment viewer should be closed after clicking on close button");});QUnit.test('clicking on the delete attachment button multiple times should do the rpc only once',async function(assert){assert.expect(2);await this.start({async mockRPC(route,args){if(args.method==="unlink"&&args.model==="ir.attachment"){assert.step('attachment_unlink');return;}
return this._super(...arguments);},});const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});await this.createAttachmentComponent(attachment,{detailsMode:'hover',});await afterNextRender(()=>{document.querySelector('.o_Attachment_actionUnlink').click();});await afterNextRender(()=>{document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click();document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click();document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click();});assert.verifySteps(['attachment_unlink'],"The unlink method must be called once");});QUnit.test('[technical] does not crash when the viewer is closed before image load',async function(assert){assert.expect(1);await this.start({hasDialog:true});const attachment=this.env.models['mail.attachment'].create({filename:"test.png",id:750,mimetype:'image/png',name:"test.png",});await this.createAttachmentComponent(attachment);await afterNextRender(()=>document.querySelector('.o_Attachment_image').click());const imageEl=document.querySelector('.o_AttachmentViewer_viewImage');await afterNextRender(()=>document.querySelector('.o_AttachmentViewer_headerItemButtonClose').click());let successfulLoad;try{imageEl.dispatchEvent(new Event('load',{bubbles:true}));successfulLoad=true;}catch(err){successfulLoad=false;}finally{assert.ok(successfulLoad,'should not crash when the image is loaded');}});});});});});;

/* /mail/static/src/components/attachment_box/attachment_box_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/attachment_box/attachment_box_tests.js',function(require){"use strict";const components={AttachmentBox:require('mail/static/src/components/attachment_box/attachment_box.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,dragenterFiles,dropFiles,start,}=require('mail/static/src/utils/test_utils.js');const{file:{createFile}}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('attachment_box',{},function(){QUnit.module('attachment_box_tests.js',{beforeEach(){beforeEach(this);this.createAttachmentBoxComponent=async(thread,otherProps)=>{const props=Object.assign({threadLocalId:thread.localId},otherProps);await createRootComponent(this,components.AttachmentBox,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('base empty rendering',async function(assert){assert.expect(4);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createAttachmentBoxComponent(thread);assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox`).length,1,"should have an attachment box");assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox_buttonAdd`).length,1,"should have a button add");assert.strictEqual(document.querySelectorAll(`.o_FileUploader_input`).length,1,"should have a file input");assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox .o_Attachment`).length,0,"should not have any attachment");});QUnit.test('base non-empty rendering',async function(assert){assert.expect(6);this.data['ir.attachment'].records.push({mimetype:'text/plain',name:'Blah.txt',res_id:100,res_model:'res.partner',},{mimetype:'text/plain',name:'Blu.txt',res_id:100,res_model:'res.partner',});await this.start({async mockRPC(route,args){if(route.includes('ir.attachment/search_read')){assert.step('ir.attachment/search_read');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await thread.fetchAttachments();await this.createAttachmentBoxComponent(thread);assert.verifySteps(['ir.attachment/search_read'],"should have fetched attachments");assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox`).length,1,"should have an attachment box");assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox_buttonAdd`).length,1,"should have a button add");assert.strictEqual(document.querySelectorAll(`.o_FileUploader_input`).length,1,"should have a file input");assert.strictEqual(document.querySelectorAll(`.o_attachmentBox_attachmentList`).length,1,"should have an attachment list");});QUnit.test('attachment box: drop attachments',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await thread.fetchAttachments();await this.createAttachmentBoxComponent(thread);const files=[await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',}),];assert.strictEqual(document.querySelectorAll('.o_AttachmentBox').length,1,"should have an attachment box");await afterNextRender(()=>dragenterFiles(document.querySelector('.o_AttachmentBox')));assert.ok(document.querySelector('.o_AttachmentBox_dropZone'),"should have a drop zone");assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox .o_Attachment`).length,0,"should have no attachment before files are dropped");await afterNextRender(()=>dropFiles(document.querySelector('.o_AttachmentBox_dropZone'),files));assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox .o_Attachment`).length,1,"should have 1 attachment in the box after files dropped");await afterNextRender(()=>dragenterFiles(document.querySelector('.o_AttachmentBox')));const file1=await createFile({content:'hello, world',contentType:'text/plain',name:'text2.txt',});const file2=await createFile({content:'hello, world',contentType:'text/plain',name:'text3.txt',});await afterNextRender(()=>dropFiles(document.querySelector('.o_AttachmentBox_dropZone'),[file1,file2]));assert.strictEqual(document.querySelectorAll(`.o_AttachmentBox .o_Attachment`).length,3,"should have 3 attachments in the box after files dropped");});QUnit.test('view attachments',async function(assert){assert.expect(7);await this.start({hasDialog:true,});const thread=this.env.models['mail.thread'].create({attachments:[['insert',{id:143,mimetype:'text/plain',name:'Blah.txt'}],['insert',{id:144,mimetype:'text/plain',name:'Blu.txt'}]],id:100,model:'res.partner',});const firstAttachment=this.env.models['mail.attachment'].findFromIdentifyingData({id:143});await this.createAttachmentBoxComponent(thread);await afterNextRender(()=>document.querySelector(`
            .o_Attachment[data-attachment-local-id="${firstAttachment.localId}"]
            .o_Attachment_image
        `).click());assert.containsOnce(document.body,'.o_Dialog',"a dialog should have been opened once attachment image is clicked",);assert.containsOnce(document.body,'.o_AttachmentViewer',"an attachment viewer should have been opened once attachment image is clicked",);assert.strictEqual(document.querySelector('.o_AttachmentViewer_name').textContent,'Blah.txt',"attachment viewer iframe should point to clicked attachment",);assert.containsOnce(document.body,'.o_AttachmentViewer_buttonNavigationNext',"attachment viewer should allow to see next attachment",);await afterNextRender(()=>document.querySelector('.o_AttachmentViewer_buttonNavigationNext').click());assert.strictEqual(document.querySelector('.o_AttachmentViewer_name').textContent,'Blu.txt',"attachment viewer iframe should point to next attachment of attachment box",);assert.containsOnce(document.body,'.o_AttachmentViewer_buttonNavigationNext',"attachment viewer should allow to see next attachment",);await afterNextRender(()=>document.querySelector('.o_AttachmentViewer_buttonNavigationNext').click());assert.strictEqual(document.querySelector('.o_AttachmentViewer_name').textContent,'Blah.txt',"attachment viewer iframe should point anew to first attachment",);});QUnit.test('remove attachment should ask for confirmation',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({attachments:[['insert',{id:143,mimetype:'text/plain',name:'Blah.txt'}],],id:100,model:'res.partner',});await this.createAttachmentBoxComponent(thread);assert.containsOnce(document.body,'.o_Attachment',"should have an attachment",);assert.containsOnce(document.body,'.o_Attachment_asideItemUnlink',"attachment should have a delete button");await afterNextRender(()=>document.querySelector('.o_Attachment_asideItemUnlink').click());assert.containsOnce(document.body,'.o_AttachmentDeleteConfirmDialog',"A confirmation dialog should have been opened");assert.strictEqual(document.querySelector('.o_AttachmentDeleteConfirmDialog_mainText').textContent,`Do you really want to delete "Blah.txt"?`,"Confirmation dialog should contain the attachment delete confirmation text");await afterNextRender(()=>document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click());assert.containsNone(document.body,'.o_Attachment',"should no longer have an attachment",);});});});});});;

/* /mail/static/src/components/chat_window_manager/chat_window_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/chat_window_manager/chat_window_manager_tests.js',function(require){'use strict';const{makeDeferred}=require('mail/static/src/utils/deferred/deferred.js');const{afterEach,afterNextRender,beforeEach,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');const{file:{createFile,inputFiles},dom:{triggerEvent},}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('chat_window_manager',{},function(){QUnit.module('chat_window_manager_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{afterEvent,env,widget}=await start(Object.assign({hasChatWindow:true,hasMessagingMenu:true},params,{data:this.data}));this.debug=params&&params.debug;this.afterEvent=afterEvent;this.env=env;this.widget=widget;};this.hideHomeMenu=async()=>{await this.env.bus.trigger('will_hide_home_menu');await this.env.bus.trigger('hide_home_menu');};this.showHomeMenu=async()=>{await this.env.bus.trigger('will_show_home_menu');const $frag=document.createDocumentFragment();const selector=this.debug?'body':'#qunit-fixture';$(selector).contents().appendTo($frag);await this.env.bus.trigger('show_home_menu');$(selector).append($frag);};},afterEach(){afterEach(this);},});QUnit.test('[technical] messaging not created',async function(assert){assert.expect(2);const messagingBeforeCreationDeferred=makeDeferred();await this.start({messagingBeforeCreationDeferred,waitUntilMessagingCondition:'none',});assert.containsOnce(document.body,'.o_ChatWindowManager',"should have chat window manager even when messaging is not yet created");messagingBeforeCreationDeferred.resolve();await nextAnimationFrame();assert.containsOnce(document.body,'.o_ChatWindowManager',"should still contain chat window manager after messaging has been created");});QUnit.test('initial mount',async function(assert){assert.expect(1);await this.start();assert.containsOnce(document.body,'.o_ChatWindowManager',"should have chat window manager");});QUnit.test('chat window new message: basic rendering',async function(assert){assert.expect(10);await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_newMessageButton`).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,1,"should have open a chat window");assert.strictEqual(document.querySelectorAll(`.o_ChatWindow_header`).length,1,"should have a header");assert.strictEqual(document.querySelectorAll(`.o_ChatWindow_header .o_ChatWindowHeader_name`).length,1,"should have name part in header");assert.strictEqual(document.querySelector(`.o_ChatWindow_header .o_ChatWindowHeader_name`).textContent,"New message","should display 'new message' in the header");assert.strictEqual(document.querySelectorAll(`.o_ChatWindow_header .o_ChatWindowHeader_command`).length,1,"should have 1 command in header");assert.strictEqual(document.querySelectorAll(`.o_ChatWindow_header .o_ChatWindowHeader_commandClose`).length,1,"should have command to close chat window");assert.strictEqual(document.querySelectorAll(`.o_ChatWindow_newMessageForm`).length,1,"should have a new message chat window container");assert.strictEqual(document.querySelectorAll(`.o_ChatWindow_newMessageFormLabel`).length,1,"should have a part in selection with label");assert.strictEqual(document.querySelector(`.o_ChatWindow_newMessageFormLabel`).textContent.trim(),"To:","should have label 'To:' in selection");assert.strictEqual(document.querySelectorAll(`.o_ChatWindow_newMessageFormInput`).length,1,"should have an input in selection");});QUnit.test('chat window new message: focused on open',async function(assert){assert.expect(2);await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_newMessageButton`).click());assert.ok(document.querySelector(`.o_ChatWindow`).classList.contains('o-focused'),"chat window should be focused");assert.ok(document.activeElement,document.querySelector(`.o_ChatWindow_newMessageFormInput`),"chat window focused = selection input focused");});QUnit.test('chat window new message: close',async function(assert){assert.expect(1);await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_newMessageButton`).click());await afterNextRender(()=>document.querySelector(`.o_ChatWindow_header .o_ChatWindowHeader_commandClose`).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,0,"chat window should be closed");});QUnit.test('chat window new message: fold',async function(assert){assert.expect(6);await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_newMessageButton`).click());assert.doesNotHaveClass(document.querySelector(`.o_ChatWindow`),'o-folded',"chat window should not be folded by default");assert.containsOnce(document.body,'.o_ChatWindow_newMessageForm',"chat window should have new message form");await afterNextRender(()=>document.querySelector(`.o_ChatWindow_header`).click());assert.hasClass(document.querySelector(`.o_ChatWindow`),'o-folded',"chat window should become folded");assert.containsNone(document.body,'.o_ChatWindow_newMessageForm',"chat window should not have new message form");await afterNextRender(()=>document.querySelector(`.o_ChatWindow_header`).click());assert.doesNotHaveClass(document.querySelector(`.o_ChatWindow`),'o-folded',"chat window should become unfolded");assert.containsOnce(document.body,'.o_ChatWindow_newMessageForm',"chat window should have new message form");});QUnit.test('open chat from "new message" chat window should open chat in place of this "new message" chat window',async function(assert){assert.expect(11);this.data['res.partner'].records.push({id:131,name:"Partner 131"});this.data['res.users'].records.push({partner_id:131});this.data['mail.channel'].records.push({is_minimized:true},{is_minimized:true},);const imSearchDef=makeDeferred();await this.start({env:{browser:{innerWidth:1920,},},async mockRPC(route,args){const res=await this._super(...arguments);if(args.method==='im_search'){imSearchDef.resolve();}
return res;}});assert.containsN(document.body,'.o_ChatWindow',2,"should have 2 chat windows initially");assert.containsNone(document.body,'.o_ChatWindow.o-new-message',"should not have any 'new message' chat window initially");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_newMessageButton`).click());assert.containsOnce(document.body,'.o_ChatWindow.o-new-message',"should have 'new message' chat window after clicking 'new message' in messaging menu");assert.containsN(document.body,'.o_ChatWindow',3,"should have 3 chat window after opening 'new message' chat window",);assert.containsOnce(document.body,'.o_ChatWindow_newMessageFormInput',"'new message' chat window should have new message form input");assert.hasClass(document.querySelector('.o_ChatWindow[data-visible-index="2"]'),'o-new-message',"'new message' chat window should be the last chat window initially",);await afterNextRender(()=>document.querySelector('.o_ChatWindow[data-visible-index="2"] .o_ChatWindowHeader_commandShiftRight').click());assert.hasClass(document.querySelector('.o_ChatWindow[data-visible-index="1"]'),'o-new-message',"'new message' chat window should have moved to the middle after clicking shift previous",);document.execCommand('insertText',false,"131");document.querySelector(`.o_ChatWindow_newMessageFormInput`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ChatWindow_newMessageFormInput`).dispatchEvent(new window.KeyboardEvent('keyup'));await imSearchDef;await nextAnimationFrame();const link=document.querySelector('.ui-autocomplete .ui-menu-item a');assert.ok(link,"should have autocomplete suggestion after typing on 'new message' input");assert.strictEqual(link.textContent,"Partner 131","autocomplete suggestion should target the partner matching search term");await afterNextRender(()=>link.click());assert.containsNone(document.body,'.o_ChatWindow.o-new-message',"should have removed the 'new message' chat window after selecting a partner");assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="1"] .o_ChatWindowHeader_name').textContent,"Partner 131","chat window with selected partner should be opened in position where 'new message' chat window was, which is in the middle");});QUnit.test('new message autocomplete should automatically select first result',async function(assert){assert.expect(1);this.data['res.partner'].records.push({id:131,name:"Partner 131"});this.data['res.users'].records.push({partner_id:131});const imSearchDef=makeDeferred();await this.start({async mockRPC(route,args){const res=await this._super(...arguments);if(args.method==='im_search'){imSearchDef.resolve();}
return res;},});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_newMessageButton`).click());document.execCommand('insertText',false,"131");document.querySelector(`.o_ChatWindow_newMessageFormInput`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ChatWindow_newMessageFormInput`).dispatchEvent(new window.KeyboardEvent('keyup'));await imSearchDef;await nextAnimationFrame();assert.hasClass(document.querySelector('.ui-autocomplete .ui-menu-item a'),'ui-state-active',"first autocomplete result should be automatically selected",);});QUnit.test('chat window: basic rendering',async function(assert){assert.expect(11);this.data['mail.channel'].records.push({id:20,name:"General"});await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_NotificationList_preview`).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,1,"should have open a chat window");const chatWindow=document.querySelector(`.o_ChatWindow`);assert.strictEqual(chatWindow.dataset.threadLocalId,this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',}).localId,"should have open a chat window of channel");assert.strictEqual(chatWindow.querySelectorAll(`:scope .o_ChatWindow_header`).length,1,"should have header part");const chatWindowHeader=chatWindow.querySelector(`:scope .o_ChatWindow_header`);assert.strictEqual(chatWindowHeader.querySelectorAll(`:scope .o_ThreadIcon`).length,1,"should have thread icon in header part");assert.strictEqual(chatWindowHeader.querySelectorAll(`:scope .o_ChatWindowHeader_name`).length,1,"should have thread name in header part");assert.strictEqual(chatWindowHeader.querySelector(`:scope .o_ChatWindowHeader_name`).textContent,"General","should have correct thread name in header part");assert.strictEqual(chatWindowHeader.querySelectorAll(`:scope .o_ChatWindowHeader_command`).length,2,"should have 2 commands in header part");assert.strictEqual(chatWindowHeader.querySelectorAll(`:scope .o_ChatWindowHeader_commandExpand`).length,1,"should have command to expand thread in discuss");assert.strictEqual(chatWindowHeader.querySelectorAll(`:scope .o_ChatWindowHeader_commandClose`).length,1,"should have command to close chat window");assert.strictEqual(chatWindow.querySelectorAll(`:scope .o_ChatWindow_thread`).length,1,"should have part to display thread content inside chat window");assert.ok(chatWindow.querySelector(`:scope .o_ChatWindow_thread`).classList.contains('o_ThreadView'),"thread part should use component ThreadView");});QUnit.test('chat window: fold',async function(assert){assert.expect(9);this.data['mail.channel'].records.push({uuid:'channel-uuid'});await this.start({mockRPC(route,args){if(args.method==='channel_fold'){assert.step(`rpc:${args.method}/${args.kwargs.state}`);}
return this._super(...arguments);},});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_dropdownMenu .o_NotificationList_preview`).click());assert.containsOnce(document.body,'.o_ChatWindow_thread',"chat window should have a thread");assert.verifySteps(['rpc:channel_fold/open'],"should sync fold state 'open' with server after opening chat window");await afterNextRender(()=>document.querySelector(`.o_ChatWindow_header`).click());assert.verifySteps(['rpc:channel_fold/folded'],"should sync fold state 'folded' with server after folding chat window");assert.containsNone(document.body,'.o_ChatWindow_thread',"chat window should not have any thread");await afterNextRender(()=>document.querySelector(`.o_ChatWindow_header`).click());assert.verifySteps(['rpc:channel_fold/open'],"should sync fold state 'open' with server after unfolding chat window");assert.containsOnce(document.body,'.o_ChatWindow_thread',"chat window should have a thread");});QUnit.test('chat window: open / close',async function(assert){assert.expect(10);this.data['mail.channel'].records.push({uuid:'channel-uuid'});await this.start({mockRPC(route,args){if(args.method==='channel_fold'){assert.step(`rpc:channel_fold/${args.kwargs.state}`);}
return this._super(...arguments);},});assert.containsNone(document.body,'.o_ChatWindow',"should not have a chat window initially");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_dropdownMenu .o_NotificationList_preview`).click());assert.containsOnce(document.body,'.o_ChatWindow',"should have a chat window after clicking on thread preview");assert.verifySteps(['rpc:channel_fold/open'],"should sync fold state 'open' with server after opening chat window");await afterNextRender(()=>document.querySelector(`.o_ChatWindowHeader_commandClose`).click());assert.containsNone(document.body,'.o_ChatWindow',"should not have a chat window after closing it");assert.verifySteps(['rpc:channel_fold/closed'],"should sync fold state 'closed' with server after closing chat window");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_dropdownMenu .o_NotificationList_preview`).click());assert.containsOnce(document.body,'.o_ChatWindow',"should have a chat window again after clicking on thread preview again");assert.verifySteps(['rpc:channel_fold/open'],"should sync fold state 'open' with server after opening chat window again");});QUnit.test('chat window: close on ESCAPE',async function(assert){assert.expect(10);this.data['res.partner'].records.push({name:"TestPartner"});this.data['mail.channel'].records.push({is_minimized:true});await this.start({mockRPC(route,args){if(args.method==='channel_fold'){assert.step(`rpc:channel_fold/${args.kwargs.state}`);}
return this._super(...arguments);},});assert.containsOnce(document.body,'.o_ChatWindow',"chat window should be opened initially");await afterNextRender(()=>document.querySelector(`.o_Composer_buttonEmojis`).click());assert.containsOnce(document.body,'.o_EmojisPopover',"emojis popover should be opened after click on emojis button");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:"Escape"});document.querySelector(`.o_Composer_buttonEmojis`).dispatchEvent(ev);});assert.containsNone(document.body,'.o_EmojisPopover',"emojis popover should be closed after pressing escape on emojis button");assert.containsOnce(document.body,'.o_ChatWindow',"chat window should still be opened after pressing escape on emojis button");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"@");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.hasClass(document.querySelector('.o_ComposerSuggestionList_list'),'show',"should display mention suggestions on typing '@'");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:"Escape"});document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(ev);});assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"mention suggestion should be closed after pressing escape on mention suggestion");assert.containsOnce(document.body,'.o_ChatWindow',"chat window should still be opened after pressing escape on mention suggestion");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:"Escape"});document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(ev);});assert.containsNone(document.body,'.o_ChatWindow',"chat window should be closed after pressing escape if there was no other priority escape handler");assert.verifySteps(['rpc:channel_fold/closed']);});QUnit.test('focus next visible chat window when closing current chat window with ESCAPE',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({is_minimized:true,state:'open'},{is_minimized:true,state:'open'});await this.start({env:{browser:{innerWidth:1920,},},});assert.containsN(document.body,'.o_ChatWindow .o_ComposerTextInput_textarea',2,"2 chat windows should be present initially");assert.containsNone(document.body,'.o_ChatWindow.o-folded',"both chat windows should be open");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:'Escape'});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(ev);});assert.containsOnce(document.body,'.o_ChatWindow',"only one chat window should remain after pressing escape on first chat window");assert.hasClass(document.querySelector('.o_ChatWindow'),'o-focused',"next visible chat window should be focused after pressing escape on first chat window");});QUnit.test('[technical] chat window: composer state conservation on toggle home menu',async function(assert){assert.expect(7);this.data['mail.channel'].records.push({id:20});await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_dropdownMenu .o_NotificationList_preview`).click());await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,'XDU for the win !');});assert.containsNone(document.body,'.o_Composer .o_Attachment',"composer should have no attachment initially");const files=[await createFile({name:'text state conservation on toggle home menu.txt',content:'hello, world',contentType:'text/plain',}),await createFile({name:'text2 state conservation on toggle home menu.txt',content:'hello, xdu is da best man',contentType:'text/plain',})];await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),files));assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"XDU for the win !","chat window composer initial text input should contain 'XDU for the win !'");assert.containsN(document.body,'.o_Composer .o_Attachment',2,"composer should have 2 total attachments after adding 2 attachments");await this.hideHomeMenu();assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"XDU for the win !","Chat window composer should still have the same input after hiding home menu");assert.containsN(document.body,'.o_Composer .o_Attachment',2,"Chat window composer should have 2 attachments after hiding home menu");await this.showHomeMenu();assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"XDU for the win !","chat window composer should still have the same input showing home menu");assert.containsN(document.body,'.o_Composer .o_Attachment',2,"Chat window composer should have 2 attachments showing home menu");});QUnit.test('[technical] chat window: scroll conservation on toggle home menu',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});for(let i=0;i<10;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],});}
await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector('.o_NotificationList_preview').click(),message:"should wait until channel 20 scrolled to its last message after opening it from the messaging menu",predicate:({scrollTop,thread})=>{const messageList=document.querySelector('.o_ThreadView_messageList');return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`.o_ThreadView_messageList`).scrollTop=142;},message:"should wait until channel 20 scrolled to 142 after setting this value manually",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===142);},});await afterNextRender(()=>this.hideHomeMenu());assert.strictEqual(document.querySelector(`.o_ThreadView_messageList`).scrollTop,142,"chat window scrollTop should still be the same after home menu is hidden");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>this.showHomeMenu(),message:"should wait until channel 20 restored its scroll to 142 after showing the home menu",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===142);},});assert.strictEqual(document.querySelector(`.o_ThreadView_messageList`).scrollTop,142,"chat window scrollTop should still be the same after home menu is shown");});QUnit.test('open 2 different chat windows: enough screen width [REQUIRE FOCUS]',async function(assert){assert.expect(8);this.data['mail.channel'].records.push({id:10},{id:20});await this.start({env:{browser:{innerWidth:1920,},},});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_preview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,1,"should have open a chat window");assert.strictEqual(document.querySelectorAll(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"chat window of chat should be open");assert.ok(document.querySelector(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).classList.contains('o-focused'),"chat window of chat should have focus");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_preview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,2,"should have open a new chat window");assert.strictEqual(document.querySelectorAll(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"chat window of channel should be open");assert.strictEqual(document.querySelectorAll(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"chat window of chat should still be open");assert.ok(document.querySelector(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).classList.contains('o-focused'),"chat window of channel should have focus");assert.notOk(document.querySelector(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).classList.contains('o-focused'),"chat window of chat should no longer have focus");});QUnit.test('open 2 chat windows: check shift operations are available',async function(assert){assert.expect(9);this.data['mail.channel'].records.push({},{});await this.start();await afterNextRender(()=>{document.querySelector('.o_MessagingMenu_toggler').click();});await afterNextRender(()=>{document.querySelectorAll('.o_MessagingMenu_dropdownMenu .o_NotificationList_preview')[0].click();});await afterNextRender(()=>{document.querySelector('.o_MessagingMenu_toggler').click();});await afterNextRender(()=>{document.querySelectorAll('.o_MessagingMenu_dropdownMenu .o_NotificationList_preview')[1].click();});assert.containsN(document.body,'.o_ChatWindow',2,"should have opened 2 chat windows");assert.containsOnce(document.querySelectorAll('.o_ChatWindow')[0],'.o_ChatWindowHeader_commandShiftLeft',"first chat window should be allowed to shift left");assert.containsNone(document.querySelectorAll('.o_ChatWindow')[0],'.o_ChatWindowHeader_commandShiftRight',"first chat window should not be allowed to shift right");assert.containsNone(document.querySelectorAll('.o_ChatWindow')[1],'.o_ChatWindowHeader_commandShiftLeft',"second chat window should not be allowed to shift left");assert.containsOnce(document.querySelectorAll('.o_ChatWindow')[1],'.o_ChatWindowHeader_commandShiftRight',"second chat window should be allowed to shift right");const initialFirstChatWindowThreadLocalId=document.querySelectorAll('.o_ChatWindow')[0].dataset.threadLocalId;const initialSecondChatWindowThreadLocalId=document.querySelectorAll('.o_ChatWindow')[1].dataset.threadLocalId;await afterNextRender(()=>{document.querySelectorAll('.o_ChatWindow')[0].querySelector(':scope .o_ChatWindowHeader_commandShiftLeft').click();});assert.strictEqual(document.querySelectorAll('.o_ChatWindow')[0].dataset.threadLocalId,initialSecondChatWindowThreadLocalId,"First chat window should be second after it has been shift left");assert.strictEqual(document.querySelectorAll('.o_ChatWindow')[1].dataset.threadLocalId,initialFirstChatWindowThreadLocalId,"Second chat window should be first after the first has been shifted left");await afterNextRender(()=>{document.querySelectorAll('.o_ChatWindow')[1].querySelector(':scope .o_ChatWindowHeader_commandShiftRight').click();});assert.strictEqual(document.querySelectorAll('.o_ChatWindow')[0].dataset.threadLocalId,initialFirstChatWindowThreadLocalId,"First chat window should be back at first place after being shifted left then right");assert.strictEqual(document.querySelectorAll('.o_ChatWindow')[1].dataset.threadLocalId,initialSecondChatWindowThreadLocalId,"Second chat window should be back at second place after first one has been shifted left then right");});QUnit.test('open 2 folded chat windows: check shift operations are available',async function(assert){assert.expect(13);this.data['res.partner'].records.push({id:7,name:"Demo"});const channel={channel_type:"channel",is_minimized:true,is_pinned:true,state:'folded',};const chat={channel_type:"chat",is_minimized:true,is_pinned:true,members:[this.data.currentPartnerId,7],state:'folded',};this.data['mail.channel'].records.push(channel,chat);await this.start({env:{browser:{innerWidth:900,},},});assert.containsN(document.body,'.o_ChatWindow',2,"should have opened 2 chat windows initially");assert.hasClass(document.querySelector('.o_ChatWindow[data-visible-index="0"]'),'o-folded',"first chat window should be folded");assert.hasClass(document.querySelector('.o_ChatWindow[data-visible-index="1"]'),'o-folded',"second chat window should be folded");assert.containsOnce(document.body,'.o_ChatWindow .o_ChatWindowHeader_commandShiftLeft',"there should be only one chat window allowed to shift left even if folded");assert.containsOnce(document.body,'.o_ChatWindow .o_ChatWindowHeader_commandShiftRight',"there should be only one chat window allowed to shift right even if folded");const initialFirstChatWindowThreadLocalId=document.querySelector('.o_ChatWindow[data-visible-index="0"]').dataset.threadLocalId;const initialSecondChatWindowThreadLocalId=document.querySelector('.o_ChatWindow[data-visible-index="1"]').dataset.threadLocalId;await afterNextRender(()=>document.querySelector('.o_ChatWindowHeader_commandShiftLeft').click());assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="0"]').dataset.threadLocalId,initialSecondChatWindowThreadLocalId,"First chat window should be second after it has been shift left");assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="1"]').dataset.threadLocalId,initialFirstChatWindowThreadLocalId,"Second chat window should be first after the first has been shifted left");await afterNextRender(()=>document.querySelector('.o_ChatWindowHeader_commandShiftLeft').click());assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="0"]').dataset.threadLocalId,initialFirstChatWindowThreadLocalId,"First chat window should be back at first place");assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="1"]').dataset.threadLocalId,initialSecondChatWindowThreadLocalId,"Second chat window should be back at second place");await afterNextRender(()=>document.querySelector('.o_ChatWindowHeader_commandShiftRight').click());assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="0"]').dataset.threadLocalId,initialSecondChatWindowThreadLocalId,"First chat window should be second after it has been shift right");assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="1"]').dataset.threadLocalId,initialFirstChatWindowThreadLocalId,"Second chat window should be first after the first has been shifted right");await afterNextRender(()=>document.querySelector('.o_ChatWindowHeader_commandShiftRight').click());assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="0"]').dataset.threadLocalId,initialFirstChatWindowThreadLocalId,"First chat window should be back at first place");assert.strictEqual(document.querySelector('.o_ChatWindow[data-visible-index="1"]').dataset.threadLocalId,initialSecondChatWindowThreadLocalId,"Second chat window should be back at second place");});QUnit.test('open 3 different chat windows: not enough screen width',async function(assert){assert.expect(12);this.data['mail.channel'].records.push({id:1},{id:2},{id:3});await this.start({env:{browser:{innerWidth:900,},},});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_preview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 1,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,1,"should have open 1 visible chat window");assert.strictEqual(document.querySelectorAll(`.o_ChatWindowManager_hiddenMenu`).length,0,"should not have hidden menu");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu`).length,0,"messaging menu should be hidden");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_preview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 2,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,2,"should have open 2 visible chat windows");assert.strictEqual(document.querySelectorAll(`.o_ChatWindowManager_hiddenMenu`).length,0,"should not have hidden menu");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu`).length,0,"messaging menu should be hidden");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_preview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 3,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,2,"should have open 2 visible chat windows");assert.strictEqual(document.querySelectorAll(`.o_ChatWindowManager_hiddenMenu`).length,1,"should have hidden menu");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu`).length,0,"messaging menu should be hidden");assert.strictEqual(document.querySelectorAll(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 1,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"chat window of channel 1 should be open");assert.strictEqual(document.querySelectorAll(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 3,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"chat window of channel 3 should be open");assert.ok(document.querySelector(`
            .o_ChatWindow[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 3,
                    model: 'mail.channel',
                }).localId
            }"]
        `).classList.contains('o-focused'),"chat window of channel 3 should have focus");});QUnit.test('chat window: switch on TAB',async function(assert){assert.expect(10);this.data['mail.channel'].records.push({id:1,name:"channel1"},{id:2,name:"channel2"});await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_preview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 1,
                    model: 'mail.channel',
                }).localId
            }"]`).click());assert.containsOnce(document.body,'.o_ChatWindow',"Only 1 chatWindow must be opened");const chatWindow=document.querySelector('.o_ChatWindow');assert.strictEqual(chatWindow.querySelector('.o_ChatWindowHeader_name').textContent,'channel1',"The name of the only chatWindow should be 'channel1' (channel with ID 1)");assert.strictEqual(chatWindow.querySelector('.o_ComposerTextInput_textarea'),document.activeElement,"The chatWindow composer must have focus");await afterNextRender(()=>triggerEvent(chatWindow.querySelector('.o_ChatWindow .o_ComposerTextInput_textarea'),'keydown',{key:'Tab'},));assert.strictEqual(chatWindow.querySelector('.o_ChatWindow .o_ComposerTextInput_textarea'),document.activeElement,"The chatWindow composer still has focus");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_preview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 2,
                    model: 'mail.channel',
                }).localId
            }"]`).click());assert.containsN(document.body,'.o_ChatWindow',2,"2 chatWindows must be opened");const chatWindows=document.querySelectorAll('.o_ChatWindow');assert.strictEqual(chatWindows[0].querySelector('.o_ChatWindowHeader_name').textContent,'channel1',"The name of the 1st chatWindow should be 'channel1' (channel with ID 1)");assert.strictEqual(chatWindows[1].querySelector('.o_ChatWindowHeader_name').textContent,'channel2',"The name of the 2nd chatWindow should be 'channel2' (channel with ID 2)");assert.strictEqual(chatWindows[1].querySelector('.o_ComposerTextInput_textarea'),document.activeElement,"The 2nd chatWindow composer must have focus (channel with ID 2)");await afterNextRender(()=>triggerEvent(chatWindows[1].querySelector('.o_ComposerTextInput_textarea'),'keydown',{key:'Tab'},));assert.containsN(document.body,'.o_ChatWindow',2,"2 chatWindows should still be opened");assert.strictEqual(chatWindows[0].querySelector('.o_ComposerTextInput_textarea'),document.activeElement,"The 1st chatWindow composer must have focus (channel with ID 1)");});QUnit.test('chat window: TAB cycle with 3 open chat windows [REQUIRE FOCUS]',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({is_minimized:true,is_pinned:true,state:'open',},{is_minimized:true,is_pinned:true,state:'open',},{is_minimized:true,is_pinned:true,state:'open',});await this.start({env:{browser:{innerWidth:1920,},},});assert.containsN(document.body,'.o_ChatWindow .o_ComposerTextInput_textarea',3,"initialy, 3 chat windows should be present");assert.containsNone(document.body,'.o_ChatWindow.o-folded',"all 3 chat windows should be open");await afterNextRender(()=>{document.querySelector(".o_ChatWindow[data-visible-index='2'] .o_ComposerTextInput_textarea").focus();});assert.strictEqual(document.querySelector(".o_ChatWindow[data-visible-index='2'] .o_ComposerTextInput_textarea"),document.activeElement,"The chatWindow with visible-index 2 should have the focus");await afterNextRender(()=>triggerEvent(document.querySelector(".o_ChatWindow[data-visible-index='2'] .o_ComposerTextInput_textarea"),'keydown',{key:'Tab'},));assert.strictEqual(document.querySelector(".o_ChatWindow[data-visible-index='1'] .o_ComposerTextInput_textarea"),document.activeElement,"after pressing tab on the chatWindow with visible-index 2, the chatWindow with visible-index 1 should have focus");await afterNextRender(()=>triggerEvent(document.querySelector(".o_ChatWindow[data-visible-index='1'] .o_ComposerTextInput_textarea"),'keydown',{key:'Tab'},));assert.strictEqual(document.querySelector(".o_ChatWindow[data-visible-index='0'] .o_ComposerTextInput_textarea"),document.activeElement,"after pressing tab on the chat window with visible-index 1, the chatWindow with visible-index 0 should have focus");await afterNextRender(()=>triggerEvent(document.querySelector(".o_ChatWindow[data-visible-index='0'] .o_ComposerTextInput_textarea"),'keydown',{key:'Tab'},));assert.strictEqual(document.querySelector(".o_ChatWindow[data-visible-index='2'] .o_ComposerTextInput_textarea"),document.activeElement,"the chatWindow with visible-index 2 should have the focus after pressing tab on the chatWindow with visible-index 0");});QUnit.test('chat window with a thread: keep scroll position in message list on folded',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:20});for(let i=0;i<10;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],});}
await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector('.o_NotificationList_preview').click(),message:"should wait until channel 20 scrolled to its last message after opening it from the messaging menu",predicate:({scrollTop,thread})=>{const messageList=document.querySelector('.o_ThreadView_messageList');return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`.o_ThreadView_messageList`).scrollTop=142;},message:"should wait until channel 20 scrolled to 142 after setting this value manually",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===142);},});assert.strictEqual(document.querySelector(`.o_ThreadView_messageList`).scrollTop,142,"verify chat window initial scrollTop");await afterNextRender(()=>document.querySelector('.o_ChatWindow_header').click());assert.containsNone(document.body,".o_ThreadView","chat window should be folded so no ThreadView should be present");await afterNextRender(()=>this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector('.o_ChatWindow_header').click(),message:"should wait until channel 20 restored its scroll position to 142",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===142);},}));assert.strictEqual(document.querySelector(`.o_ThreadView_messageList`).scrollTop,142,"chat window scrollTop should still be the same when chat window is unfolded");});QUnit.test('chat window should scroll to the newly posted message just after posting it',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20,is_minimized:true,state:'open',});for(let i=0;i<10;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],});}
await this.start();await afterNextRender(()=>{document.querySelector('.o_ComposerTextInput_textarea').focus();document.execCommand('insertText',false,'WOLOLO');});await afterNextRender(()=>triggerEvent(document.querySelector('.o_ChatWindow .o_ComposerTextInput_textarea'),'keydown',{key:'Enter'},));const messageList=document.querySelector('.o_MessageList');assert.strictEqual(messageList.scrollHeight-messageList.scrollTop,messageList.clientHeight,"chat window should scroll to the newly posted message just after posting it");});QUnit.test('[technical] chat window: composer state conservation on toggle home menu when folded',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({});await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_dropdownMenu .o_NotificationList_preview`).click());await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,'XDU for the win !');});const files=[await createFile({name:'text state conservation on toggle home menu.txt',content:'hello, world',contentType:'text/plain',}),await createFile({name:'text2 state conservation on toggle home menu.txt',content:'hello, xdu is da best man',contentType:'text/plain',})];await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),files));assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"XDU for the win !","verify chat window composer initial html input");assert.containsN(document.body,'.o_Composer .o_Attachment',2,"verify chat window composer initial attachment count");await afterNextRender(()=>document.querySelector('.o_ChatWindow_header').click());await this.hideHomeMenu();await afterNextRender(()=>document.querySelector('.o_ChatWindow_header').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"XDU for the win !","Chat window composer should still have the same input after hiding home menu");assert.containsN(document.body,'.o_Composer .o_Attachment',2,"Chat window composer should have 2 attachments after hiding home menu");await afterNextRender(()=>document.querySelector('.o_ChatWindow_header').click());await this.showHomeMenu();await afterNextRender(()=>document.querySelector('.o_ChatWindow_header').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"XDU for the win !","chat window composer should still have the same input after showing home menu");assert.containsN(document.body,'.o_Composer .o_Attachment',2,"Chat window composer should have 2 attachments after showing home menu");});QUnit.test('[technical] chat window with a thread: keep scroll position in message list on toggle home menu when folded',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});for(let i=0;i<10;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],});}
await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector('.o_NotificationList_preview').click(),message:"should wait until channel 20 scrolled to its last message after opening it from the messaging menu",predicate:({scrollTop,thread})=>{const messageList=document.querySelector('.o_ThreadView_messageList');return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector(`.o_ThreadView_messageList`).scrollTop=142,message:"should wait until channel 20 scrolled to 142 after setting this value manually",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===142);},});await afterNextRender(()=>document.querySelector('.o_ChatWindow_header').click());await this.hideHomeMenu();await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector('.o_ChatWindow_header').click(),message:"should wait until channel 20 restored its scroll to 142 after unfolding it",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===142);},});assert.strictEqual(document.querySelector(`.o_ThreadView_messageList`).scrollTop,142,"chat window scrollTop should still be the same after home menu is hidden");await afterNextRender(()=>document.querySelector('.o_ChatWindow_header').click());await this.showHomeMenu();await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector('.o_ChatWindow_header').click(),message:"should wait until channel 20 restored its scroll position to the last saved value (142)",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===142);},});assert.strictEqual(document.querySelector(`.o_ThreadView_messageList`).scrollTop,142,"chat window scrollTop should still be the same after home menu is shown");});QUnit.test('chat window does not fetch messages if hidden',async function(assert){assert.expect(14);this.data['mail.channel'].records=[{id:10,is_minimized:true,name:"Channel #10",state:'open',},{id:11,is_minimized:true,name:"Channel #11",state:'open',},{id:12,is_minimized:true,name:"Channel #12",state:'open',},];await this.start({env:{browser:{innerWidth:900,},},mockRPC(route,args){if(args.method==='message_fetch'){const channel_ids=args.kwargs.domain[0][2];assert.strictEqual(channel_ids.length,1,"messages should be fetched channel per channel");assert.step(`rpc:message_fetch:${channel_ids[0]}`);}
return this._super(...arguments);},});assert.containsN(document.body,'.o_ChatWindow',2,"2 chat windows should be visible");assert.containsNone(document.body,`.o_ChatWindow[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 12,
                model: 'mail.channel',
            }).localId
        }"]`,"chat window for Channel #12 should be hidden");assert.containsOnce(document.body,'.o_ChatWindowHiddenMenu',"chat window hidden menu should be displayed");assert.verifySteps(['rpc:message_fetch:10','rpc:message_fetch:11'],"messages should be fetched for the two visible chat windows");await afterNextRender(()=>document.querySelector('.o_ChatWindowHiddenMenu_dropdownToggle').click());assert.containsOnce(document.body,'.o_ChatWindowHiddenMenu_chatWindowHeader',"1 hidden chat window should be listed in hidden menu");await afterNextRender(()=>document.querySelector('.o_ChatWindowHiddenMenu_chatWindowHeader').click());assert.containsN(document.body,'.o_ChatWindow',2,"2 chat windows should still be visible");assert.containsOnce(document.body,`.o_ChatWindow[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 12,
                model: 'mail.channel',
            }).localId
        }"]`,"chat window for Channel #12 should now be visible");assert.verifySteps(['rpc:message_fetch:12'],"messages should now be fetched for Channel #12");});QUnit.test('new message separator is shown in a chat window of a chat on receiving new message',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:10,name:"Demo"});this.data['res.users'].records.push({id:42,name:"Foreigner user",partner_id:10,});this.data['mail.channel'].records=[{channel_type:"chat",id:10,is_minimized:true,is_pinned:false,members:[this.data.currentPartnerId,10],uuid:'channel-10-uuid',},];await this.start({mockRPC(route,args){if(args.method==='channel_fold'){const channel_uuid=args.kwargs.uuid;assert.strictEqual(channel_uuid,'channel-10-uuid',"chat window fold state should have been sent to server");assert.step(`rpc:channel_fold:${channel_uuid}`);}
return this._super(...arguments);},});await afterNextRender(async()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:42,},message_content:"hu",uuid:'channel-10-uuid',},}));assert.containsOnce(document.body,'.o_ChatWindow',"a chat window should be visible after receiving a new message from a chat");assert.containsOnce(document.body,'.o_Message',"chat window should have a single message (the newly received one)");assert.containsOnce(document.body,'.o_MessageList_separatorNewMessages',"should display 'new messages' separator in the conversation, from reception of new messages");assert.verifySteps(['rpc:channel_fold:channel-10-uuid'],"fold state of chat window of chat should have been updated to server");});QUnit.test('focusing a chat window of a chat should make new message separator disappear [REQUIRE FOCUS]',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:10,name:"Demo"});this.data['res.users'].records.push({id:42,name:"Foreigner user",partner_id:10,});this.data['mail.channel'].records.push({channel_type:"chat",id:10,is_minimized:true,is_pinned:false,members:[this.data.currentPartnerId,10],message_unread_counter:0,uuid:'channel-10-uuid',},);await this.start();await afterNextRender(()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:42,},message_content:"hu",uuid:'channel-10-uuid',},}));assert.containsOnce(document.body,'.o_MessageList_separatorNewMessages',"should display 'new messages' separator in the conversation, from reception of new messages");await afterNextRender(()=>this.afterEvent({eventName:'o-thread-last-seen-by-current-partner-message-id-changed',func:()=>document.querySelector('.o_ComposerTextInput_textarea').focus(),message:"should wait until last seen by current partner message id changed",predicate:({thread})=>{return(thread.id===10&&thread.model==='mail.channel');},}));assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"new message separator should no longer be shown, after focus on composer text input of chat window");});});});});});;

/* /mail/static/src/components/chatter/chatter_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/chatter/chatter_tests',function(require){'use strict';const components={Chatter:require('mail/static/src/components/chatter/chatter.js'),Composer:require('mail/static/src/components/composer/composer.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('chatter',{},function(){QUnit.module('chatter_tests.js',{beforeEach(){beforeEach(this);this.createChatterComponent=async({chatter},otherProps)=>{const props=Object.assign({chatterLocalId:chatter.localId},otherProps);await createRootComponent(this,components.Chatter,{props,target:this.widget.el,});};this.createComposerComponent=async(composer,otherProps)=>{const props=Object.assign({composerLocalId:composer.localId},otherProps);await createRootComponent(this,components.Composer,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('base rendering when chatter has no attachment',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:100});for(let i=0;i<60;i++){this.data['mail.message'].records.push({body:"not empty",model:'res.partner',res_id:100,});}
await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.strictEqual(document.querySelectorAll(`.o_Chatter`).length,1,"should have a chatter");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_Chatter_attachmentBox`).length,0,"should not have an attachment box in the chatter");assert.strictEqual(document.querySelectorAll(`.o_Chatter_thread`).length,1,"should have a thread in the chatter");assert.strictEqual(document.querySelector(`.o_Chatter_thread`).dataset.threadLocalId,this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'res.partner',}).localId,"thread should have the right thread local id");assert.strictEqual(document.querySelectorAll(`.o_Message`).length,30,"the first 30 messages of thread should be loaded");});QUnit.test('base rendering when chatter has no record',async function(assert){assert.expect(8);await this.start();const chatter=this.env.models['mail.chatter'].create({threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.strictEqual(document.querySelectorAll(`.o_Chatter`).length,1,"should have a chatter");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_Chatter_attachmentBox`).length,0,"should not have an attachment box in the chatter");assert.strictEqual(document.querySelectorAll(`.o_Chatter_thread`).length,1,"should have a thread in the chatter");assert.ok(chatter.thread.isTemporary,"thread should have a temporary thread linked to chatter");assert.strictEqual(document.querySelectorAll(`.o_Message`).length,1,"should have a message");assert.strictEqual(document.querySelector(`.o_Message_content`).textContent,"Creating a new record...","should have the 'Creating a new record ...' message");assert.containsNone(document.body,'.o_MessageList_loadMore',"should not have the 'load more' button");});QUnit.test('base rendering when chatter has attachments',async function(assert){assert.expect(3);this.data['res.partner'].records.push({id:100});this.data['ir.attachment'].records.push({mimetype:'text/plain',name:'Blah.txt',res_id:100,res_model:'res.partner',},{mimetype:'text/plain',name:'Blu.txt',res_id:100,res_model:'res.partner',});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.strictEqual(document.querySelectorAll(`.o_Chatter`).length,1,"should have a chatter");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_Chatter_attachmentBox`).length,0,"should not have an attachment box in the chatter");});QUnit.test('show attachment box',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:100});this.data['ir.attachment'].records.push({mimetype:'text/plain',name:'Blah.txt',res_id:100,res_model:'res.partner',},{mimetype:'text/plain',name:'Blu.txt',res_id:100,res_model:'res.partner',});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.strictEqual(document.querySelectorAll(`.o_Chatter`).length,1,"should have a chatter");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,1,"attachments button should have a counter");assert.strictEqual(document.querySelectorAll(`.o_Chatter_attachmentBox`).length,0,"should not have an attachment box in the chatter");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonAttachments`).click());assert.strictEqual(document.querySelectorAll(`.o_Chatter_attachmentBox`).length,1,"should have an attachment box in the chatter");});QUnit.test('composer show/hide on log note/send message [REQUIRE FOCUS]',async function(assert){assert.expect(10);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonSendMessage`).length,1,"should have a send message button");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonLogNote`).length,1,"should have a log note button");assert.strictEqual(document.querySelectorAll(`.o_Chatter_composer`).length,0,"should not have a composer");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.strictEqual(document.querySelectorAll(`.o_Chatter_composer`).length,1,"should have a composer");assert.hasClass(document.querySelector('.o_Chatter_composer'),'o-focused',"composer 'send message' in chatter should have focus just after being displayed");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonLogNote`).click());assert.strictEqual(document.querySelectorAll(`.o_Chatter_composer`).length,1,"should still have a composer");assert.hasClass(document.querySelector('.o_Chatter_composer'),'o-focused',"composer 'log note' in chatter should have focus just after being displayed");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonLogNote`).click());assert.strictEqual(document.querySelectorAll(`.o_Chatter_composer`).length,0,"should have no composer anymore");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.strictEqual(document.querySelectorAll(`.o_Chatter_composer`).length,1,"should have a composer");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.strictEqual(document.querySelectorAll(`.o_Chatter_composer`).length,0,"should have no composer anymore");});QUnit.test('should not display user notification messages in chatter',async function(assert){assert.expect(1);this.data['res.partner'].records.push({id:100});this.data['mail.message'].records.push({id:102,message_type:'user_notification',model:'res.partner',res_id:100,});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.containsNone(document.body,'.o_Message',"should display no messages");});QUnit.test('post message with "CTRL-Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.containsNone(document.body,'.o_Message',"should not have any message initially in chatter");await afterNextRender(()=>document.querySelector('.o_ChatterTopbar_buttonSendMessage').click());await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});await afterNextRender(()=>{const kevt=new window.KeyboardEvent('keydown',{ctrlKey:true,key:"Enter"});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);});assert.containsOnce(document.body,'.o_Message',"should now have single message in chatter after posting message from pressing 'CTRL-Enter' in text input of composer");});QUnit.test('post message with "META-Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.containsNone(document.body,'.o_Message',"should not have any message initially in chatter");await afterNextRender(()=>document.querySelector('.o_ChatterTopbar_buttonSendMessage').click());await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});await afterNextRender(()=>{const kevt=new window.KeyboardEvent('keydown',{key:"Enter",metaKey:true});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);});assert.containsOnce(document.body,'.o_Message',"should now have single message in channel after posting message from pressing 'META-Enter' in text input of composer");});QUnit.test('do not post message with "Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterComponent({chatter});assert.containsNone(document.body,'.o_Message',"should not have any message initially in chatter");await afterNextRender(()=>document.querySelector('.o_ChatterTopbar_buttonSendMessage').click());await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});const kevt=new window.KeyboardEvent('keydown',{key:"Enter"});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);await nextAnimationFrame();assert.containsNone(document.body,'.o_Message',"should still not have any message in mailing channel after pressing 'Enter' in text input of composer");});});});});});;

/* /mail/static/src/components/chatter/chatter_suggested_recipient_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/chatter/chatter_suggested_recipient_tests',function(require){'use strict';const components={Chatter:require('mail/static/src/components/chatter/chatter.js'),Composer:require('mail/static/src/components/composer/composer.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('chatter',{},function(){QUnit.module('chatter_suggested_recipients_tests.js',{beforeEach(){beforeEach(this);this.createChatterComponent=async({chatter},otherProps)=>{const props=Object.assign({chatterLocalId:chatter.localId},otherProps);await createRootComponent(this,components.Chatter,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test("suggest recipient on 'Send message' composer",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.fake'].records.push({id:10,email_cc:"john@test.be",partner_ids:[100],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.containsOnce(document.body,'.o_ComposerSuggestedRecipientList',"Should display a list of suggested recipients after opening the composer from 'Send message' button");});QUnit.test("with 3 or less suggested recipients: no 'show more' button",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.fake'].records.push({id:10,email_cc:"john@test.be",partner_ids:[100],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.containsNone(document.body,'.o_ComposerSuggestedRecipientList_showMore',"should not display 'show more' button with 3 or less suggested recipients");});QUnit.test("display reason for suggested recipient on mouse over",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.fake'].records.push({id:10,partner_ids:[100],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());const partnerTitle=document.querySelector('.o_ComposerSuggestedRecipient[data-partner-id="100"]').getAttribute('title');assert.strictEqual(partnerTitle,"Add as recipient and follower (reason: Email partner)","must display reason for suggested recipient on mouse over",);});QUnit.test("suggested recipient without partner are unchecked by default",async function(assert){assert.expect(1);this.data['res.fake'].records.push({id:10,email_cc:"john@test.be",});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());const checkboxUnchecked=document.querySelector('.o_ComposerSuggestedRecipient:not([data-partner-id]) input[type=checkbox]');assert.notOk(checkboxUnchecked.checked,"suggested recipient without partner must be unchecked by default",);});QUnit.test("suggested recipient with partner are checked by default",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.fake'].records.push({id:10,partner_ids:[100],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());const checkboxChecked=document.querySelector('.o_ComposerSuggestedRecipient[data-partner-id="100"] input[type=checkbox]');assert.ok(checkboxChecked.checked,"suggested recipient with partner must be checked by default",);});QUnit.test("more than 3 suggested recipients: display only 3 and 'show more' button",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.partner'].records.push({display_name:"Jack Jone",email:"jack@jone.be",id:1000,});this.data['res.partner'].records.push({display_name:"jolly Roger",email:"Roger@skullflag.com",id:1001,});this.data['res.partner'].records.push({display_name:"jack sparrow",email:"jsparrow@blackpearl.bb",id:1002,});this.data['res.fake'].records.push({id:10,partner_ids:[100,1000,1001,1002],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.containsOnce(document.body,'.o_ComposerSuggestedRecipientList_showMore',"more than 3 suggested recipients display 'show more' button");});QUnit.test("more than 3 suggested recipients: show all of them on click 'show more' button",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.partner'].records.push({display_name:"Jack Jone",email:"jack@jone.be",id:1000,});this.data['res.partner'].records.push({display_name:"jolly Roger",email:"Roger@skullflag.com",id:1001,});this.data['res.partner'].records.push({display_name:"jack sparrow",email:"jsparrow@blackpearl.bb",id:1002,});this.data['res.fake'].records.push({id:10,partner_ids:[100,1000,1001,1002],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());await afterNextRender(()=>document.querySelector(`.o_ComposerSuggestedRecipientList_showMore`).click());assert.containsN(document.body,'.o_ComposerSuggestedRecipient',4,"more than 3 suggested recipients: show all of them on click 'show more' button");});QUnit.test("more than 3 suggested recipients -> click 'show more' -> 'show less' button",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.partner'].records.push({display_name:"Jack Jone",email:"jack@jone.be",id:1000,});this.data['res.partner'].records.push({display_name:"jolly Roger",email:"Roger@skullflag.com",id:1001,});this.data['res.partner'].records.push({display_name:"jack sparrow",email:"jsparrow@blackpearl.bb",id:1002,});this.data['res.fake'].records.push({id:10,partner_ids:[100,1000,1001,1002],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());await afterNextRender(()=>document.querySelector(`.o_ComposerSuggestedRecipientList_showMore`).click());assert.containsOnce(document.body,'.o_ComposerSuggestedRecipientList_showLess',"more than 3 suggested recipients -> click 'show more' -> 'show less' button");});QUnit.test("suggested recipients list display 3 suggested recipient and 'show more' button when 'show less' button is clicked",async function(assert){assert.expect(2);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.partner'].records.push({display_name:"Jack Jone",email:"jack@jone.be",id:1000,});this.data['res.partner'].records.push({display_name:"jolly Roger",email:"Roger@skullflag.com",id:1001,});this.data['res.partner'].records.push({display_name:"jack sparrow",email:"jsparrow@blackpearl.bb",id:1002,});this.data['res.fake'].records.push({id:10,partner_ids:[100,1000,1001,1002],});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());await afterNextRender(()=>document.querySelector(`.o_ComposerSuggestedRecipientList_showMore`).click());await afterNextRender(()=>document.querySelector(`.o_ComposerSuggestedRecipientList_showLess`).click());assert.containsN(document.body,'.o_ComposerSuggestedRecipient',3,"suggested recipient list should display 3 suggested recipients after clicking on 'show less'.");assert.containsOnce(document.body,'.o_ComposerSuggestedRecipientList_showMore',"suggested recipient list should containt a 'show More' button after clicking on 'show less'.");});QUnit.test("suggested recipients should not be notified when posting an internal note",async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"John Jane",email:"john@jane.be",id:100,});this.data['res.fake'].records.push({id:10,partner_ids:[100],});await this.start({async mockRPC(route,args){if(args.model==='res.fake'&&args.method==='message_post'){assert.strictEqual(args.kwargs.partner_ids.length,0,"message_post should not contain suggested recipients when posting an internal note");}
return this._super(...arguments);},});const chatter=this.env.models['mail.chatter'].create({threadId:10,threadModel:'res.fake',});await this.createChatterComponent({chatter});await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonLogNote`).click());document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>document.execCommand('insertText',false,"Dummy Message"));await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});});});});});});;

/* /mail/static/src/components/chatter_topbar/chatter_topbar_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/chatter_topbar/chatter_topbar_tests.js',function(require){'use strict';const components={ChatterTopBar:require('mail/static/src/components/chatter_topbar/chatter_topbar.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');const{makeTestPromise}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('chatter_topbar',{},function(){QUnit.module('chatter_topbar_tests.js',{beforeEach(){beforeEach(this);this.createChatterTopbarComponent=async(chatter,otherProps)=>{const props=Object.assign({chatterLocalId:chatter.localId},otherProps);await createRootComponent(this,components.ChatterTopBar,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('base rendering',async function(assert){assert.expect(8);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonSendMessage`).length,1,"should have a send message button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonLogNote`).length,1,"should have a log note button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonScheduleActivity`).length,1,"should have a schedule activity button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCountLoader`).length,0,"attachments button should not have a loader");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,1,"attachments button should have a counter");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_followerListMenu`).length,1,"should have a follower menu");});QUnit.test('base disabled rendering',async function(assert){assert.expect(8);await this.start();const chatter=this.env.models['mail.chatter'].create({threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.ok(document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).disabled,"send message button should be disabled");assert.ok(document.querySelector(`.o_ChatterTopbar_buttonLogNote`).disabled,"log note button should be disabled");assert.ok(document.querySelector(`.o_ChatterTopbar_buttonScheduleActivity`).disabled,"schedule activity should be disabled");assert.ok(document.querySelector(`.o_ChatterTopbar_buttonAttachments`).disabled,"attachments button should be disabled");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCountLoader`).length,0,"attachments button should not have a loader");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,1,"attachments button should have a counter");assert.strictEqual(document.querySelector(`.o_ChatterTopbar_buttonAttachmentsCount`).textContent,'0',"attachments button counter should be 0");});QUnit.test('attachment loading is delayed',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:100});await this.start({hasTimeControl:true,loadingBaseDelayDuration:100,async mockRPC(route){if(route.includes('ir.attachment/search_read')){await makeTestPromise();}
return this._super(...arguments);}});const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCountLoader`).length,0,"attachments button should not have a loader yet");await afterNextRender(async()=>this.env.testUtils.advanceTime(100));assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCountLoader`).length,1,"attachments button should now have a loader");});QUnit.test('attachment counter while loading attachments',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:100});await this.start({async mockRPC(route){if(route.includes('ir.attachment/search_read')){await makeTestPromise();}
return this._super(...arguments);}});const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCountLoader`).length,1,"attachments button should have a loader");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,0,"attachments button should not have a counter");});QUnit.test('attachment counter transition when attachments become loaded)',async function(assert){assert.expect(7);this.data['res.partner'].records.push({id:100});const attachmentPromise=makeTestPromise();await this.start({async mockRPC(route){const _super=this._super.bind(this,...arguments);if(route.includes('ir.attachment/search_read')){await attachmentPromise;}
return _super();},});const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCountLoader`).length,1,"attachments button should have a loader");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,0,"attachments button should not have a counter");await afterNextRender(()=>attachmentPromise.resolve());assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCountLoader`).length,0,"attachments button should not have a loader");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,1,"attachments button should have a counter");});QUnit.test('attachment counter without attachments',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,1,"attachments button should have a counter");assert.strictEqual(document.querySelector(`.o_ChatterTopbar_buttonAttachmentsCount`).textContent,'0','attachment counter should contain "0"');});QUnit.test('attachment counter with attachments',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:100});this.data['ir.attachment'].records.push({mimetype:'text/plain',name:'Blah.txt',res_id:100,res_model:'res.partner',},{mimetype:'text/plain',name:'Blu.txt',res_id:100,res_model:'res.partner',});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar`).length,1,"should have a chatter topbar");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachments`).length,1,"should have an attachments button in chatter menu");assert.strictEqual(document.querySelectorAll(`.o_ChatterTopbar_buttonAttachmentsCount`).length,1,"attachments button should have a counter");assert.strictEqual(document.querySelector(`.o_ChatterTopbar_buttonAttachmentsCount`).textContent,'2','attachment counter should contain "2"');});QUnit.test('composer state conserved when clicking on another topbar button',async function(assert){assert.expect(8);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.containsOnce(document.body,`.o_ChatterTopbar`,"should have a chatter topbar");assert.containsOnce(document.body,`.o_ChatterTopbar_buttonSendMessage`,"should have a send message button in chatter menu");assert.containsOnce(document.body,`.o_ChatterTopbar_buttonLogNote`,"should have a log note button in chatter menu");assert.containsOnce(document.body,`.o_ChatterTopbar_buttonAttachments`,"should have an attachments button in chatter menu");await afterNextRender(()=>{document.querySelector(`.o_ChatterTopbar_buttonLogNote`).click();});assert.containsOnce(document.body,`.o_ChatterTopbar_buttonLogNote.o-active`,"log button should now be active");assert.containsNone(document.body,`.o_ChatterTopbar_buttonSendMessage.o-active`,"send message button should not be active");await afterNextRender(()=>{document.querySelector(`.o_ChatterTopbar_buttonAttachments`).click();});assert.containsOnce(document.body,`.o_ChatterTopbar_buttonLogNote.o-active`,"log button should still be active");assert.containsNone(document.body,`.o_ChatterTopbar_buttonSendMessage.o-active`,"send message button should still be not active");});QUnit.test('rendering with multiple partner followers',async function(assert){assert.expect(7);await this.start();this.data['res.partner'].records.push({id:100,message_follower_ids:[1,2],});this.data['mail.followers'].records.push({channel_id:false,id:1,name:"Jean Michang",partner_id:12,res_id:100,res_model:'res.partner',},{channel_id:false,id:2,name:"Eden Hazard",partner_id:11,res_id:100,res_model:'res.partner',},);const chatter=this.env.models['mail.chatter'].create({followerIds:[1,2],threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.containsOnce(document.body,'.o_FollowerListMenu',"should have followers menu component");assert.containsOnce(document.body,'.o_FollowerListMenu_buttonFollowers',"should have followers button");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should be opened");assert.containsN(document.body,'.o_Follower',2,"exactly two followers should be listed");assert.containsN(document.body,'.o_Follower_name',2,"exactly two follower names should be listed");assert.strictEqual(document.querySelectorAll('.o_Follower_name')[0].textContent.trim(),"Jean Michang","first follower is 'Jean Michang'");assert.strictEqual(document.querySelectorAll('.o_Follower_name')[1].textContent.trim(),"Eden Hazard","second follower is 'Eden Hazard'");});QUnit.test('rendering with multiple channel followers',async function(assert){assert.expect(7);this.data['res.partner'].records.push({id:100,message_follower_ids:[1,2],});await this.start();this.data['mail.followers'].records.push({channel_id:11,id:1,name:"channel numero 5",partner_id:false,res_id:100,res_model:'res.partner',},{channel_id:12,id:2,name:"channel armstrong",partner_id:false,res_id:100,res_model:'res.partner',},);const chatter=this.env.models['mail.chatter'].create({followerIds:[1,2],threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.containsOnce(document.body,'.o_FollowerListMenu',"should have followers menu component");assert.containsOnce(document.body,'.o_FollowerListMenu_buttonFollowers',"should have followers button");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should be opened");assert.containsN(document.body,'.o_Follower',2,"exactly two followers should be listed");assert.containsN(document.body,'.o_Follower_name',2,"exactly two follower names should be listed");assert.strictEqual(document.querySelectorAll('.o_Follower_name')[0].textContent.trim(),"channel numero 5","first follower is 'channel numero 5'");assert.strictEqual(document.querySelectorAll('.o_Follower_name')[1].textContent.trim(),"channel armstrong","second follower is 'channel armstrong'");});QUnit.test('log note/send message switching',async function(assert){assert.expect(8);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.containsOnce(document.body,'.o_ChatterTopbar_buttonSendMessage',"should have a 'Send Message' button");assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonSendMessage'),'o-active',"'Send Message' button should not be active");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonLogNote',"should have a 'Log Note' button");assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonLogNote'),'o-active',"'Log Note' button should not be active");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.hasClass(document.querySelector('.o_ChatterTopbar_buttonSendMessage'),'o-active',"'Send Message' button should be active");assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonLogNote'),'o-active',"'Log Note' button should not be active");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonLogNote`).click());assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonSendMessage'),'o-active',"'Send Message' button should not be active");assert.hasClass(document.querySelector('.o_ChatterTopbar_buttonLogNote'),'o-active',"'Log Note' button should be active");});QUnit.test('log note toggling',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.containsOnce(document.body,'.o_ChatterTopbar_buttonLogNote',"should have a 'Log Note' button");assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonLogNote'),'o-active',"'Log Note' button should not be active");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonLogNote`).click());assert.hasClass(document.querySelector('.o_ChatterTopbar_buttonLogNote'),'o-active',"'Log Note' button should be active");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonLogNote`).click());assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonLogNote'),'o-active',"'Log Note' button should not be active");});QUnit.test('send message toggling',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:100});await this.start();const chatter=this.env.models['mail.chatter'].create({threadId:100,threadModel:'res.partner',});await this.createChatterTopbarComponent(chatter);assert.containsOnce(document.body,'.o_ChatterTopbar_buttonSendMessage',"should have a 'Send Message' button");assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonSendMessage'),'o-active',"'Send Message' button should not be active");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.hasClass(document.querySelector('.o_ChatterTopbar_buttonSendMessage'),'o-active',"'Send Message' button should be active");await afterNextRender(()=>document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).click());assert.doesNotHaveClass(document.querySelector('.o_ChatterTopbar_buttonSendMessage'),'o-active',"'Send Message' button should not be active");});});});});});;

/* /mail/static/src/components/composer/composer_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/composer/composer_tests.js',function(require){'use strict';const components={Composer:require('mail/static/src/components/composer/composer.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,dragenterFiles,dropFiles,nextAnimationFrame,pasteFiles,start,}=require('mail/static/src/utils/test_utils.js');const{file:{createFile,inputFiles,},makeTestPromise,}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('composer',{},function(){QUnit.module('composer_tests.js',{beforeEach(){beforeEach(this);this.createComposerComponent=async(composer,otherProps)=>{const props=Object.assign({composerLocalId:composer.localId},otherProps);await createRootComponent(this,components.Composer,{props,target:this.widget.el,});};this.start=async params=>{const{afterEvent,env,widget}=await start(Object.assign({},params,{data:this.data,}));this.afterEvent=afterEvent;this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('composer text input: basic rendering when posting a message',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({composer:[['create',{isLog:false}]],id:20,model:'res.partner',});await this.createComposerComponent(thread.composer);assert.strictEqual(document.querySelectorAll('.o_Composer').length,1,"should have composer in discuss thread");assert.strictEqual(document.querySelectorAll('.o_Composer_textInput').length,1,"should have text input inside discuss thread composer");assert.ok(document.querySelector('.o_Composer_textInput').classList.contains('o_ComposerTextInput'),"composer text input of composer should be a ComposerTextIput component");assert.strictEqual(document.querySelectorAll(`.o_ComposerTextInput_textarea`).length,1,"should have editable part inside composer text input");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).placeholder,"Send a message to followers...","should have 'Send a message to followers...' as placeholder composer text input");});QUnit.test('composer text input: basic rendering when logging note',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({composer:[['create',{isLog:true}]],id:20,model:'res.partner',});await this.createComposerComponent(thread.composer);assert.strictEqual(document.querySelectorAll('.o_Composer').length,1,"should have composer in discuss thread");assert.strictEqual(document.querySelectorAll('.o_Composer_textInput').length,1,"should have text input inside discuss thread composer");assert.ok(document.querySelector('.o_Composer_textInput').classList.contains('o_ComposerTextInput'),"composer text input of composer should be a ComposerTextIput component");assert.strictEqual(document.querySelectorAll(`.o_ComposerTextInput_textarea`).length,1,"should have editable part inside composer text input");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).placeholder,"Log an internal note...","should have 'Log an internal note...' as placeholder in composer text input if composer is log");});QUnit.test('composer text input: basic rendering when linked thread is a mail.channel',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);assert.strictEqual(document.querySelectorAll('.o_Composer').length,1,"should have composer in discuss thread");assert.strictEqual(document.querySelectorAll('.o_Composer_textInput').length,1,"should have text input inside discuss thread composer");assert.ok(document.querySelector('.o_Composer_textInput').classList.contains('o_ComposerTextInput'),"composer text input of composer should be a ComposerTextIput component");assert.strictEqual(document.querySelectorAll(`.o_ComposerTextInput_textarea`).length,1,"should have editable part inside composer text input");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).placeholder,"Write something...","should have 'Write something...' as placeholder in composer text input if composer is for a 'mail.channel'");});QUnit.test('mailing channel composer: basic rendering',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20,mass_mailing:true});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);assert.containsOnce(document.body,'.o_ComposerTextInput',"Composer should have a text input");assert.containsOnce(document.body,'.o_Composer_subjectInput',"Composer should have a subject input");});QUnit.test('add an emoji',async function(assert){assert.expect(1);await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);await afterNextRender(()=>document.querySelector('.o_Composer_buttonEmojis').click());await afterNextRender(()=>document.querySelector('.o_EmojisPopover_emoji[data-unicode="😊"]').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"😊","emoji should be inserted in the composer text input");await nextAnimationFrame();await nextAnimationFrame();await nextAnimationFrame();});QUnit.test('add an emoji after some text',async function(assert){assert.expect(2);await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Blabla");});assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"Blabla","composer text input should have text only initially");await afterNextRender(()=>document.querySelector('.o_Composer_buttonEmojis').click());await afterNextRender(()=>document.querySelector('.o_EmojisPopover_emoji[data-unicode="😊"]').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"Blabla😊","emoji should be inserted after the text");await nextAnimationFrame();await nextAnimationFrame();await nextAnimationFrame();});QUnit.test('add emoji replaces (keyboard) text selection',async function(assert){assert.expect(2);await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const composerTextInputTextArea=document.querySelector(`.o_ComposerTextInput_textarea`);await afterNextRender(()=>{composerTextInputTextArea.focus();document.execCommand('insertText',false,"Blabla");});assert.strictEqual(composerTextInputTextArea.value,"Blabla","composer text input should have text only initially");composerTextInputTextArea.setSelectionRange(0,composerTextInputTextArea.value.length);await afterNextRender(()=>document.querySelector('.o_Composer_buttonEmojis').click());await afterNextRender(()=>document.querySelector('.o_EmojisPopover_emoji[data-unicode="😊"]').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"😊","whole text selection should have been replaced by emoji");await nextAnimationFrame();await nextAnimationFrame();await nextAnimationFrame();});QUnit.test('display canned response suggestions on typing ":"',async function(assert){assert.expect(2);this.data['mail.shortcode'].records.push({id:11,source:"hello",substitution:"Hello! How are you?",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"Canned responses suggestions list should not be present");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,":");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.hasClass(document.querySelector('.o_ComposerSuggestionList_list'),'show',"should display canned response suggestions on typing ':'");});QUnit.test('use a canned response',async function(assert){assert.expect(4);this.data['mail.shortcode'].records.push({id:11,source:"hello",substitution:"Hello! How are you?",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"canned response suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,":");});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a canned response suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"Hello! How are you? ","text content of composer should have canned response + additional whitespace afterwards");});QUnit.test('use a canned response some text',async function(assert){assert.expect(5);this.data['mail.shortcode'].records.push({id:11,source:"hello",substitution:"Hello! How are you?",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"canned response suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");document.querySelector(`.o_ComposerTextInput_textarea`).focus();await afterNextRender(()=>document.execCommand('insertText',false,"bluhbluh "));assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"bluhbluh ","text content of composer should have content");await afterNextRender(()=>document.execCommand('insertText',false,":"));await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a canned response suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"bluhbluh Hello! How are you? ","text content of composer should have previous content + canned response substitution + additional whitespace afterwards");});QUnit.test('add an emoji after a canned response',async function(assert){assert.expect(5);this.data['mail.shortcode'].records.push({id:11,source:"hello",substitution:"Hello! How are you?",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"canned response suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,":");});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a canned response suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"Hello! How are you? ","text content of composer should have previous content + canned response substitution + additional whitespace afterwards");await afterNextRender(()=>document.querySelector('.o_Composer_buttonEmojis').click());await afterNextRender(()=>document.querySelector('.o_EmojisPopover_emoji[data-unicode="😊"]').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"Hello! How are you? 😊","text content of composer should have previous canned response substitution and selected emoji just after");await nextAnimationFrame();});QUnit.test('display channel mention suggestions on typing "#"',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:7,name:"General",public:"groups",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"channel mention suggestions list should not be present");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"#");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.hasClass(document.querySelector('.o_ComposerSuggestionList_list'),'show',"should display channel mention suggestions on typing '#'");});QUnit.test('mention a channel',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:7,name:"General",public:"groups",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"channel mention suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"#");});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a channel mention suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"#General ","text content of composer should have mentioned channel + additional whitespace afterwards");});QUnit.test('mention a channel after some text',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:7,name:"General",public:"groups",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"channel mention suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");document.querySelector(`.o_ComposerTextInput_textarea`).focus();await afterNextRender(()=>document.execCommand('insertText',false,"bluhbluh "));assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"bluhbluh ","text content of composer should have content");await afterNextRender(()=>document.execCommand('insertText',false,"#"));await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a channel mention suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"bluhbluh #General ","text content of composer should have previous content + mentioned channel + additional whitespace afterwards");});QUnit.test('add an emoji after a channel mention',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:7,name:"General",public:"groups",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"mention suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"#");});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a channel mention suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"#General ","text content of composer should have previous content + mentioned channel + additional whitespace afterwards");await afterNextRender(()=>document.querySelector('.o_Composer_buttonEmojis').click());await afterNextRender(()=>document.querySelector('.o_EmojisPopover_emoji[data-unicode="😊"]').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"#General 😊","text content of composer should have previous channel mention and selected emoji just after");await nextAnimationFrame();});QUnit.test('display command suggestions on typing "/"',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({channel_type:'channel',id:20});this.data['mail.channel_command'].records.push({channel_types:['channel'],help:"List users in the current channel",name:"who",},);await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"command suggestions list should not be present");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"/");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.hasClass(document.querySelector('.o_ComposerSuggestionList_list'),'show',"should display command suggestions on typing '/'");});QUnit.test('use a command for a specific channel type',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({channel_type:'channel',id:20});this.data['mail.channel_command'].records.push({channel_types:['channel'],help:"List users in the current channel",name:"who",},);await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"command suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"/");});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a command suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"/who ","text content of composer should have used command + additional whitespace afterwards");});QUnit.test("channel with no commands should not prompt any command suggestions on typing /",async function(assert){assert.expect(1);this.data['mail.channel'].records.push({channel_type:'chat',id:20});this.data['mail.channel_command'].records.push({channel_types:['channel'],help:"bla bla bla",name:"who",},);await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);await afterNextRender(()=>{document.querySelector('.o_ComposerTextInput_textarea').focus();document.execCommand('insertText',false,"/");const composer_text_input=document.querySelector('.o_ComposerTextInput_textarea');composer_text_input.dispatchEvent(new window.KeyboardEvent('keydown'));composer_text_input.dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsNone(document.body,'.o_ComposerSuggestion',"should not prompt (command) suggestion after typing / (reason: no channel commands in chat channels)");});QUnit.test('use a command after some text',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({channel_type:'channel',id:20});this.data['mail.channel_command'].records.push({channel_types:['channel'],help:"List users in the current channel",name:"who",},);await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"command suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");document.querySelector(`.o_ComposerTextInput_textarea`).focus();await afterNextRender(()=>document.execCommand('insertText',false,"bluhbluh "));assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"bluhbluh ","text content of composer should have content");await afterNextRender(()=>document.execCommand('insertText',false,"/"));await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a command suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"bluhbluh /who ","text content of composer should have previous content + used command + additional whitespace afterwards");});QUnit.test('add an emoji after a command',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({channel_type:'channel',id:20});this.data['mail.channel_command'].records.push({channel_types:['channel'],help:"List users in the current channel",name:"who",},);await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"command suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"/");});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a command suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"/who ","text content of composer should have previous content + used command + additional whitespace afterwards");await afterNextRender(()=>document.querySelector('.o_Composer_buttonEmojis').click());await afterNextRender(()=>document.querySelector('.o_EmojisPopover_emoji[data-unicode="😊"]').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"/who 😊","text content of composer should have previous command and selected emoji just after");await nextAnimationFrame();});QUnit.test('display partner mention suggestions on typing "@"',async function(assert){assert.expect(3);this.data['res.partner'].records.push({id:11,email:"testpartner@odoo.com",name:"TestPartner",});this.data['res.partner'].records.push({id:12,email:"testpartner2@odoo.com",name:"TestPartner2",});this.data['res.users'].records.push({partner_id:11,});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"mention suggestions list should not be present");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"@");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.hasClass(document.querySelector('.o_ComposerSuggestionList_list'),'show',"should display mention suggestions on typing '@'");assert.containsOnce(document.body,'.dropdown-divider',"should have a separator");});QUnit.test('mention a partner',async function(assert){assert.expect(4);this.data['res.partner'].records.push({email:"testpartner@odoo.com",name:"TestPartner",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestionList_list',"mention suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"@");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"T");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"e");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a mention suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"@TestPartner ","text content of composer should have mentioned partner + additional whitespace afterwards");});QUnit.test('mention a partner after some text',async function(assert){assert.expect(5);this.data['res.partner'].records.push({email:"testpartner@odoo.com",name:"TestPartner",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"mention suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");document.querySelector(`.o_ComposerTextInput_textarea`).focus();await afterNextRender(()=>document.execCommand('insertText',false,"bluhbluh "));assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"bluhbluh ","text content of composer should have content");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"@");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"T");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"e");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a mention suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"bluhbluh @TestPartner ","text content of composer should have previous content + mentioned partner + additional whitespace afterwards");});QUnit.test('add an emoji after a partner mention',async function(assert){assert.expect(5);this.data['res.partner'].records.push({email:"testpartner@odoo.com",name:"TestPartner",});await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);assert.containsNone(document.body,'.o_ComposerSuggestion',"mention suggestions list should not be present");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","text content of composer should be empty initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"@");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"T");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"e");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"should have a mention suggestion");await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"@TestPartner ","text content of composer should have previous content + mentioned partner + additional whitespace afterwards");await afterNextRender(()=>document.querySelector('.o_Composer_buttonEmojis').click());await afterNextRender(()=>document.querySelector('.o_EmojisPopover_emoji[data-unicode="😊"]').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"@TestPartner 😊","text content of composer should have previous mention and selected emoji just after");await nextAnimationFrame();});QUnit.test('composer: add an attachment',async function(assert){assert.expect(2);await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer,{attachmentsDetailsMode:'card'});const file=await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',});await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),[file]));assert.ok(document.querySelector('.o_Composer_attachmentList'),"should have an attachment list");assert.ok(document.querySelector(`.o_Composer .o_Attachment`),"should have an attachment");});QUnit.test('composer: drop attachments',async function(assert){assert.expect(4);await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const files=[await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',}),await createFile({content:'hello, worlduh',contentType:'text/plain',name:'text2.txt',}),];await afterNextRender(()=>dragenterFiles(document.querySelector('.o_Composer')));assert.ok(document.querySelector('.o_Composer_dropZone'),"should have a drop zone");assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`).length,0,"should have no attachment before files are dropped");await afterNextRender(()=>dropFiles(document.querySelector('.o_Composer_dropZone'),files));assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`).length,2,"should have 2 attachments in the composer after files dropped");await afterNextRender(()=>dragenterFiles(document.querySelector('.o_Composer')));await afterNextRender(async()=>dropFiles(document.querySelector('.o_Composer_dropZone'),[await createFile({content:'hello, world',contentType:'text/plain',name:'text3.txt',})]));assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`).length,3,"should have 3 attachments in the box after files dropped");});QUnit.test('composer: paste attachments',async function(assert){assert.expect(2);await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const files=[await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',})];assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`).length,0,"should not have any attachment in the composer before paste");await afterNextRender(()=>pasteFiles(document.querySelector('.o_ComposerTextInput'),files));assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`).length,1,"should have 1 attachment in the composer after paste");});QUnit.test('send message when enter is pressed while holding ctrl key (this shortcut is available)',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{textInputSendShortcuts:['ctrl-enter'],});document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"test message");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"test message","should have inserted text content in editable");await afterNextRender(()=>{const enterEvent=new window.KeyboardEvent('keydown',{key:'Enter'});document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(enterEvent);});assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"test message","should have inserted text content in editable as message has not been posted");await afterNextRender(()=>document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{ctrlKey:true,key:'Enter'})));assert.verifySteps(['message_post']);assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","should have no content in composer input as message has been posted");});QUnit.test('send message when enter is pressed while holding meta key (this shortcut is available)',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{textInputSendShortcuts:['meta-enter'],});document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"test message");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"test message","should have inserted text content in editable");await afterNextRender(()=>{const enterEvent=new window.KeyboardEvent('keydown',{key:'Enter'});document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(enterEvent);});assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"test message","should have inserted text content in editable as message has not been posted");await afterNextRender(()=>document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{key:'Enter',metaKey:true})));assert.verifySteps(['message_post']);assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","should have no content in composer input as message has been posted");});QUnit.test('composer text input cleared on message post',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"test message");});assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"test message","should have inserted text content in editable");await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.verifySteps(['message_post']);assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","should have no content in composer input after posting message");});QUnit.test('composer inputs cleared on message post in composer of a mailing channel',async function(assert){assert.expect(10);this.data['mail.channel'].records.push({id:20,mass_mailing:true});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');assert.ok('body'in args.kwargs,"body should be posted with the message");assert.strictEqual(args.kwargs.body,"test message","posted body should be the one typed in text input");assert.ok('subject'in args.kwargs,"subject should be posted with the message");assert.strictEqual(args.kwargs.subject,"test subject","posted subject should be the one typed in subject input");}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"test message");});assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"test message","should have inserted text content in editable");await afterNextRender(()=>{document.querySelector(`.o_Composer_subjectInput`).focus();document.execCommand('insertText',false,"test subject");});assert.strictEqual(document.querySelector(`.o_Composer_subjectInput`).value,"test subject","should have inserted text content in input");await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.verifySteps(['message_post']);assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","should have no content in composer input after posting message");assert.strictEqual(document.querySelector(`.o_Composer_subjectInput`).value,"","should have no content in composer subject input after posting message");});QUnit.test('composer with thread typing notification status',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{hasThreadTyping:true});assert.containsOnce(document.body,'.o_Composer_threadTextualTypingStatus',"Composer should have a thread textual typing status bar");assert.strictEqual(document.body.querySelector('.o_Composer_threadTextualTypingStatus').textContent,"","By default, thread textual typing status bar should be empty");});QUnit.test('current partner notify is typing to other thread members',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start({async mockRPC(route,args){if(args.method==='notify_typing'){assert.step(`notify_typing:${args.kwargs.is_typing}`);}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{hasThreadTyping:true});document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"a");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{key:'a'}));assert.verifySteps(['notify_typing:true'],"should have notified current partner typing status");});QUnit.test('current partner is typing should not translate on textual typing status',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:20});await this.start({hasTimeControl:true,async mockRPC(route,args){if(args.method==='notify_typing'){assert.step(`notify_typing:${args.kwargs.is_typing}`);}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{hasThreadTyping:true});document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"a");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{key:'a'}));assert.verifySteps(['notify_typing:true'],"should have notified current partner typing status");await nextAnimationFrame();assert.strictEqual(document.body.querySelector('.o_Composer_threadTextualTypingStatus').textContent,"","Thread textual typing status bar should not display current partner is typing");});QUnit.test('current partner notify no longer is typing to thread members after 5 seconds inactivity',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20});await this.start({hasTimeControl:true,async mockRPC(route,args){if(args.method==='notify_typing'){assert.step(`notify_typing:${args.kwargs.is_typing}`);}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{hasThreadTyping:true});document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"a");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{key:'a'}));assert.verifySteps(['notify_typing:true'],"should have notified current partner is typing");await this.env.testUtils.advanceTime(5*1000);assert.verifySteps(['notify_typing:false'],"should have notified current partner no longer is typing (inactive for 5 seconds)");});QUnit.test('current partner notify is typing again to other members every 50s of long continuous typing',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20});await this.start({hasTimeControl:true,async mockRPC(route,args){if(args.method==='notify_typing'){assert.step(`notify_typing:${args.kwargs.is_typing}`);}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{hasThreadTyping:true});document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"a");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{key:'a'}));assert.verifySteps(['notify_typing:true'],"should have notified current partner is typing");let totalTimeElapsed=0;const elapseTickTime=2.5*1000;while(totalTimeElapsed<50*1000){document.execCommand('insertText',false,"a");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{key:'a'}));totalTimeElapsed+=elapseTickTime;await this.env.testUtils.advanceTime(elapseTickTime);}
assert.verifySteps(['notify_typing:true'],"should have notified current partner is still typing after 50s of straight typing");});QUnit.test('composer: send button is disabled if attachment upload is not finished',async function(assert){assert.expect(8);const attachmentUploadedPromise=makeTestPromise();await this.start({async mockFetch(resource,init){const res=this._super(...arguments);if(resource==='/web/binary/upload_attachment'){await attachmentUploadedPromise;}
return res;}});const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const file=await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',});await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),[file]));assert.containsOnce(document.body,'.o_Attachment',"should have an attachment after a file has been input");assert.containsOnce(document.body,'.o_Attachment.o-temporary',"attachment displayed is being uploaded");assert.containsOnce(document.body,'.o_Composer_buttonSend',"composer send button should be displayed");assert.ok(!!document.querySelector('.o_Composer_buttonSend').attributes.disabled,"composer send button should be disabled as attachment is not yet uploaded");await afterNextRender(()=>attachmentUploadedPromise.resolve());assert.containsOnce(document.body,'.o_Attachment',"should have only one attachment");assert.containsNone(document.body,'.o_Attachment.o-temporary',"attachment displayed should be uploaded");assert.containsOnce(document.body,'.o_Composer_buttonSend',"composer send button should still be present");assert.ok(!document.querySelector('.o_Composer_buttonSend').attributes.disabled,"composer send button should be enabled as attachment is now uploaded");});QUnit.test('warning on send with shortcut when attempting to post message with still-uploading attachments',async function(assert){assert.expect(7);await this.start({async mockFetch(resource,init){const res=this._super(...arguments);if(resource==='/web/binary/upload_attachment'){await new Promise(()=>{});}
return res;},services:{notification:{notify(params){assert.strictEqual(params.message,"Please wait while the file is uploading.","notification content should be about the uploading file");assert.strictEqual(params.type,'warning',"notification should be a warning");assert.step('notification');}}},});const thread=this.env.models['mail.thread'].create({composer:[['create',{isLog:false}]],id:20,model:'res.partner',});await this.createComposerComponent(thread.composer,{textInputSendShortcuts:['enter'],});const file=await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',});await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),[file]));assert.containsOnce(document.body,'.o_Attachment',"should have only one attachment");assert.containsOnce(document.body,'.o_Attachment.o-temporary',"attachment displayed is being uploaded");assert.containsOnce(document.body,'.o_Composer_buttonSend',"composer send button should be displayed");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown',{key:'Enter'}));assert.verifySteps(['notification'],"should have triggered a notification for inability to post message at the moment (some attachments are still being uploaded)");});QUnit.test('remove an attachment from composer does not need any confirmation',async function(assert){assert.expect(3);await this.start();const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const file=await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',});await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),[file]));assert.containsOnce(document.body,'.o_Composer_attachmentList',"should have an attachment list");assert.containsOnce(document.body,'.o_Composer .o_Attachment',"should have only one attachment");await afterNextRender(()=>document.querySelector('.o_Attachment_asideItemUnlink').click());assert.containsNone(document.body,'.o_Composer .o_Attachment',"should not have any attachment left after unlinking the only one");});QUnit.test('remove an uploading attachment',async function(assert){assert.expect(4);await this.start({async mockFetch(resource,init){const res=this._super(...arguments);if(resource==='/web/binary/upload_attachment'){await new Promise(()=>{});}
return res;}});const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const file=await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',});await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),[file]));assert.containsOnce(document.body,'.o_Composer_attachmentList',"should have an attachment list");assert.containsOnce(document.body,'.o_Composer .o_Attachment',"should have only one attachment");assert.containsOnce(document.body,'.o_Composer .o_Attachment.o-temporary',"should have an uploading attachment");await afterNextRender(()=>document.querySelector('.o_Attachment_asideItemUnlink').click());assert.containsNone(document.body,'.o_Composer .o_Attachment',"should not have any attachment left after unlinking temporary one");});QUnit.test('remove an uploading attachment aborts upload',async function(assert){assert.expect(1);await this.start({async mockFetch(resource,init){const res=this._super(...arguments);if(resource==='/web/binary/upload_attachment'){await new Promise(()=>{});}
return res;}});const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const file=await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',});await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),[file]));assert.containsOnce(document.body,'.o_Attachment',"should contain an attachment");const attachmentLocalId=document.querySelector('.o_Attachment').dataset.attachmentLocalId;await this.afterEvent({eventName:'o-attachment-upload-abort',func:()=>{document.querySelector('.o_Attachment_asideItemUnlink').click();},message:"attachment upload request should have been aborted",predicate:({attachment})=>{return attachment.localId===attachmentLocalId;},});});QUnit.test("basic rendering when sending a message to the followers and thread doesn't have a name",async function(assert){assert.expect(1);await this.start();const thread=this.env.models['mail.thread'].create({composer:[['create',{isLog:false}]],id:20,model:'res.partner',});await this.createComposerComponent(thread.composer,{hasFollowers:true});assert.strictEqual(document.querySelector('.o_Composer_followers').textContent.replace(/\s+/g,''),"To:Followersofthisdocument","Composer should display \"To: Followers of this document\" if the thread as no name.");});QUnit.test('send message only once when button send is clicked twice quickly',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer);await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"test message");});await afterNextRender(()=>{document.querySelector(`.o_Composer_buttonSend`).click();document.querySelector(`.o_Composer_buttonSend`).click();});assert.verifySteps(['message_post'],"The message has been posted only once");});QUnit.test('send message only once when enter is pressed twice quickly',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createComposerComponent(thread.composer,{textInputSendShortcuts:['enter'],});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"test message");});await afterNextRender(()=>{const enterEvent=new window.KeyboardEvent('keydown',{key:'Enter'});document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(enterEvent);document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(enterEvent);});assert.verifySteps(['message_post'],"The message has been posted only once");});QUnit.test("mentioned partners should not be notified if they are not member of current channel",async function(assert){assert.expect(4);this.data['res.partner'].records.push({email:"testpartner@example.com",name:"TestPartner",});this.data['mail.channel'].records.push({id:10,members:[this.data.currentPartnerId],});await this.start({async mockRPC(route,args){if(args.model==='mail.channel'&&args.method==='message_post'){assert.step('message_post');assert.strictEqual(args.kwargs.partner_ids.length,0,"message_post should not contain mentioned partners that are not members of channel");}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:10,model:'mail.channel',});await this.createComposerComponent(thread.composer);await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"@");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value.replace(/\s/," "),"@TestPartner ","text content of composer should have mentioned partner + additional whitespace afterwards");await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.verifySteps(['message_post'],"the message should be posted");});QUnit.test('[technical] does not crash when an attachment is removed before its upload starts',async function(assert){assert.expect(1);const uploadPromise=makeTestPromise();await this.start({async mockFetch(resource){const _super=this._super.bind(this,...arguments);if(resource==='/web/binary/upload_attachment'){await uploadPromise;}
return _super();},});const composer=this.env.models['mail.composer'].create();await this.createComposerComponent(composer);const file1=await createFile({name:'text1.txt',content:'hello, world',contentType:'text/plain',});const file2=await createFile({name:'text2.txt',content:'hello, world',contentType:'text/plain',});await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),[file1,file2]));await afterNextRender(()=>{Array.from(document.querySelectorAll('div')).find(el=>el.textContent==='text2.txt').closest('.o_Attachment').querySelector('.o_Attachment_asideItemUnlink').click();});uploadPromise.resolve();assert.containsOnce(document.body,'.o_Attachment:contains("text1.txt")',"should only have the first attachment after cancelling the second attachment");});});});});});;

/* /mail/static/src/components/composer_suggestion/composer_suggestion_canned_response_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/composer_suggestion/composer_suggestion_canned_response_tests.js',function(require){'use strict';const components={ComposerSuggestion:require('mail/static/src/components/composer_suggestion/composer_suggestion.js'),};const{afterEach,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('composer_suggestion',{},function(){QUnit.module('composer_suggestion_canned_response_tests.js',{beforeEach(){beforeEach(this);this.createComposerSuggestion=async props=>{await createRootComponent(this,components.ComposerSuggestion,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('canned response suggestion displayed',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const cannedResponse=this.env.models['mail.canned_response'].create({id:7,source:'hello',substitution:"Hello, how are you?",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.canned_response',recordLocalId:cannedResponse.localId,});assert.containsOnce(document.body,`.o_ComposerSuggestion`,"Canned response suggestion should be present");});QUnit.test('canned response suggestion correct data',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const cannedResponse=this.env.models['mail.canned_response'].create({id:7,source:'hello',substitution:"Hello, how are you?",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.canned_response',recordLocalId:cannedResponse.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Canned response suggestion should be present");assert.containsOnce(document.body,'.o_ComposerSuggestion_part1',"Canned response source should be present");assert.strictEqual(document.querySelector(`.o_ComposerSuggestion_part1`).textContent,"hello","Canned response source should be displayed");assert.containsOnce(document.body,'.o_ComposerSuggestion_part2',"Canned response substitution should be present");assert.strictEqual(document.querySelector(`.o_ComposerSuggestion_part2`).textContent,"Hello, how are you?","Canned response substitution should be displayed");});QUnit.test('canned response suggestion active',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const cannedResponse=this.env.models['mail.canned_response'].create({id:7,source:'hello',substitution:"Hello, how are you?",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.canned_response',recordLocalId:cannedResponse.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Canned response suggestion should be displayed");assert.hasClass(document.querySelector('.o_ComposerSuggestion'),'active',"should be active initially");});});});});});;

/* /mail/static/src/components/composer_suggestion/composer_suggestion_channel_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/composer_suggestion/composer_suggestion_channel_tests.js',function(require){'use strict';const components={ComposerSuggestion:require('mail/static/src/components/composer_suggestion/composer_suggestion.js'),};const{afterEach,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('composer_suggestion',{},function(){QUnit.module('composer_suggestion_channel_tests.js',{beforeEach(){beforeEach(this);this.createComposerSuggestion=async props=>{await createRootComponent(this,components.ComposerSuggestion,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('channel mention suggestion displayed',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const channel=this.env.models['mail.thread'].create({id:7,name:"General",model:'mail.channel',});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.thread',recordLocalId:channel.localId,});assert.containsOnce(document.body,`.o_ComposerSuggestion`,"Channel mention suggestion should be present");});QUnit.test('channel mention suggestion correct data',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const channel=this.env.models['mail.thread'].create({id:7,name:"General",model:'mail.channel',});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.thread',recordLocalId:channel.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Channel mention suggestion should be present");assert.containsOnce(document.body,'.o_ComposerSuggestion_part1',"Channel name should be present");assert.strictEqual(document.querySelector(`.o_ComposerSuggestion_part1`).textContent,"General","Channel name should be displayed");});QUnit.test('channel mention suggestion active',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const channel=this.env.models['mail.thread'].create({id:7,name:"General",model:'mail.channel',});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.thread',recordLocalId:channel.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Channel mention suggestion should be displayed");assert.hasClass(document.querySelector('.o_ComposerSuggestion'),'active',"should be active initially");});});});});});;

/* /mail/static/src/components/composer_suggestion/composer_suggestion_command_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/composer_suggestion/composer_suggestion_command_tests.js',function(require){'use strict';const components={ComposerSuggestion:require('mail/static/src/components/composer_suggestion/composer_suggestion.js'),};const{afterEach,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('composer_suggestion',{},function(){QUnit.module('composer_suggestion_command_tests.js',{beforeEach(){beforeEach(this);this.createComposerSuggestion=async props=>{await createRootComponent(this,components.ComposerSuggestion,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('command suggestion displayed',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const command=this.env.models['mail.channel_command'].create({name:'whois',help:"Displays who it is",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.channel_command',recordLocalId:command.localId,});assert.containsOnce(document.body,`.o_ComposerSuggestion`,"Command suggestion should be present");});QUnit.test('command suggestion correct data',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const command=this.env.models['mail.channel_command'].create({name:'whois',help:"Displays who it is",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.channel_command',recordLocalId:command.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Command suggestion should be present");assert.containsOnce(document.body,'.o_ComposerSuggestion_part1',"Command name should be present");assert.strictEqual(document.querySelector(`.o_ComposerSuggestion_part1`).textContent,"whois","Command name should be displayed");assert.containsOnce(document.body,'.o_ComposerSuggestion_part2',"Command help should be present");assert.strictEqual(document.querySelector(`.o_ComposerSuggestion_part2`).textContent,"Displays who it is","Command help should be displayed");});QUnit.test('command suggestion active',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const command=this.env.models['mail.channel_command'].create({name:'whois',help:"Displays who it is",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.channel_command',recordLocalId:command.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Command suggestion should be displayed");assert.hasClass(document.querySelector('.o_ComposerSuggestion'),'active',"should be active initially");});});});});});;

/* /mail/static/src/components/composer_suggestion/composer_suggestion_partner_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/composer_suggestion/composer_suggestion_partner_tests.js',function(require){'use strict';const components={ComposerSuggestion:require('mail/static/src/components/composer_suggestion/composer_suggestion.js'),};const{afterEach,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('composer_suggestion',{},function(){QUnit.module('composer_suggestion_partner_tests.js',{beforeEach(){beforeEach(this);this.createComposerSuggestion=async props=>{await createRootComponent(this,components.ComposerSuggestion,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('partner mention suggestion displayed',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const partner=this.env.models['mail.partner'].create({id:7,im_status:'online',name:"Demo User",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.partner',recordLocalId:partner.localId,});assert.containsOnce(document.body,`.o_ComposerSuggestion`,"Partner mention suggestion should be present");});QUnit.test('partner mention suggestion correct data',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const partner=this.env.models['mail.partner'].create({email:"demo_user@odoo.com",id:7,im_status:'online',name:"Demo User",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.partner',recordLocalId:partner.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Partner mention suggestion should be present");assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon`).length,1,"Partner's im_status should be displayed");assert.containsOnce(document.body,'.o_ComposerSuggestion_part1',"Partner's name should be present");assert.strictEqual(document.querySelector(`.o_ComposerSuggestion_part1`).textContent,"Demo User","Partner's name should be displayed");assert.containsOnce(document.body,'.o_ComposerSuggestion_part2',"Partner's email should be present");assert.strictEqual(document.querySelector(`.o_ComposerSuggestion_part2`).textContent,"(demo_user@odoo.com)","Partner's email should be displayed");});QUnit.test('partner mention suggestion active',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const partner=this.env.models['mail.partner'].create({id:7,im_status:'online',name:"Demo User",});await this.createComposerSuggestion({composerLocalId:thread.composer.localId,isActive:true,modelName:'mail.partner',recordLocalId:partner.localId,});assert.containsOnce(document.body,'.o_ComposerSuggestion',"Partner mention suggestion should be displayed");assert.hasClass(document.querySelector('.o_ComposerSuggestion'),'active',"should be active initially");});});});});});;

/* /mail/static/src/components/dialog_manager/dialog_manager_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/dialog_manager/dialog_manager_tests.js',function(require){'use strict';const{makeDeferred}=require('mail/static/src/utils/deferred/deferred.js');const{afterEach,beforeEach,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('dialog_manager',{},function(){QUnit.module('dialog_manager_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({hasDialog:true},params,{data:this.data}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('[technical] messaging not created',async function(assert){assert.expect(2);const messagingBeforeCreationDeferred=makeDeferred();await this.start({messagingBeforeCreationDeferred,waitUntilMessagingCondition:'none',});assert.containsOnce(document.body,'.o_DialogManager',"should have dialog manager even when messaging is not yet created");messagingBeforeCreationDeferred.resolve();await nextAnimationFrame();assert.containsOnce(document.body,'.o_DialogManager',"should still contain dialog manager after messaging has been created");});QUnit.test('initial mount',async function(assert){assert.expect(1);await this.start();assert.containsOnce(document.body,'.o_DialogManager',"should have dialog manager");});});});});});;

/* /mail/static/src/components/discuss/tests/discuss_domain_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/discuss/tests/discuss_domain_tests.js',function(require){'use strict';const{afterEach,afterNextRender,beforeEach,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('discuss',{},function(){QUnit.module('discuss_domain_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{afterEvent,env,widget}=await start(Object.assign({},params,{autoOpenDiscuss:true,data:this.data,hasDiscuss:true,}));this.afterEvent=afterEvent;this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('discuss should filter messages based on given domain',async function(assert){assert.expect(2);this.data['mail.message'].records.push({body:"test",needaction:true,needaction_partner_ids:[this.data.currentPartnerId],},{body:"not empty",needaction:true,needaction_partner_ids:[this.data.currentPartnerId],});await this.start();assert.containsN(document.body,'.o_Message',2,"should have 2 messages in Inbox initially");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.env.messaging.discuss.update({stringifiedDomain:JSON.stringify([['body','ilike','test']]),});},message:"should wait until search filter is applied",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&hint.data.fetchedMessages.length===1&&threadViewer.thread.model==='mail.box'&&threadViewer.thread.id==='inbox');},});assert.containsOnce(document.body,'.o_Message',"should only have the 1 message containing 'test' remaining after doing a search");});QUnit.test('discuss should keep filter domain on changing thread',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:20});this.data['mail.message'].records.push({body:"test",channel_ids:[20],},{body:"not empty",channel_ids:[20],});await this.start();const channel=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});assert.containsNone(document.body,'.o_Message',"should have no message in Inbox initially");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.env.messaging.discuss.update({stringifiedDomain:JSON.stringify([['body','ilike','test']]),});},message:"should wait until search filter is applied",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.box'&&threadViewer.thread.id==='inbox');},});assert.containsNone(document.body,'.o_Message',"should have still no message in Inbox after doing a search");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${channel.localId}"]
            `).click();},message:"should wait until channel 20 is loaded after clicking on it",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20);},});assert.containsOnce(document.body,'.o_Message',"should only have the 1 message containing 'test' in channel 20 (due to the domain still applied on changing thread)");});QUnit.test('discuss should refresh filtered thread on receiving new message',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start();const channel=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${channel.localId}"]
            `).click();},message:"should wait until channel 20 is loaded after clicking on it",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20);},});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.env.messaging.discuss.update({stringifiedDomain:JSON.stringify([['body','ilike','test']]),});},message:"should wait until search filter is applied",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20);},});assert.containsNone(document.body,'.o_Message',"should have initially no message in channel 20 matching the search 'test'");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>this.env.services.rpc({route:'/mail/chat_post',params:{message_content:"test",uuid:channel.uuid,},}),message:"should wait until channel 20 refreshed its filtered message list",predicate:data=>{return(data.threadViewer.thread.model==='mail.channel'&&data.threadViewer.thread.id===20&&data.hint.type==='messages-loaded');},});assert.containsOnce(document.body,'.o_Message',"should only have the 1 message containing 'test' in channel 20 after just receiving it");});QUnit.test('discuss should refresh filtered thread on changing thread',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20},{id:21});await this.start();const channel20=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});const channel21=this.env.models['mail.thread'].findFromIdentifyingData({id:21,model:'mail.channel',});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${channel20.localId}"]
            `).click();},message:"should wait until channel 20 is loaded after clicking on it",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20);},});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.env.messaging.discuss.update({stringifiedDomain:JSON.stringify([['body','ilike','test']]),});},message:"should wait until search filter is applied",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20);},});assert.containsNone(document.body,'.o_Message',"should have initially no message in channel 20 matching the search 'test'");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${channel21.localId}"]
            `).click();},message:"should wait until channel 21 is loaded after clicking on it",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===21);},});assert.containsNone(document.body,'.o_Message',"should have no message in channel 21 matching the search 'test'");await this.env.services.rpc({route:'/mail/chat_post',params:{message_content:"test",uuid:channel20.uuid,},});assert.containsNone(document.body,'.o_Message',"should still have no message in channel 21 matching the search 'test' after receiving a message on channel 20");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${channel20.localId}"]
            `).click();},message:"should wait until channel 20 is loaded with the new message after clicking on it",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20&&threadViewer.threadCache.fetchedMessages.length===1);},});assert.containsOnce(document.body,'.o_Message',"should now have the 1 message containing 'test' in channel 20 when displaying it, after having received the message while the channel was not visible");});QUnit.test('select all and unselect all buttons should work on filtered thread',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,name:"general",});this.data['mail.message'].records.push({body:"<p>test</p>",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start();await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${this.env.messaging.moderation.localId}"]
            `).click();},message:"should wait until moderation box is loaded after clicking on it",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.box'&&threadViewer.thread.id==='moderation');},});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.env.messaging.discuss.update({stringifiedDomain:JSON.stringify([['body','ilike','test']]),});},message:"should wait until search filter is applied",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.box'&&threadViewer.thread.id==='moderation');},});assert.containsOnce(document.body,'.o_Message',"should only have the 1 message containing 'test' in moderation box");assert.notOk(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should not be checked initially");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonSelectAll').click());assert.ok(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should be checked after clicking on 'select all'");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonUnselectAll').click());assert.notOk(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should be unchecked after clicking on 'unselect all'");});});});});});;

/* /mail/static/src/components/discuss/tests/discuss_inbox_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/discuss/tests/discuss_inbox_tests.js',function(require){'use strict';const{afterEach,afterNextRender,beforeEach,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('discuss',{},function(){QUnit.module('discuss_inbox_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{autoOpenDiscuss:true,data:this.data,hasDiscuss:true,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('reply: discard on pressing escape',async function(assert){assert.expect(9);this.data['res.partner'].records.push({email:"testpartnert@odoo.com",id:11,name:"TestPartner",});this.data['mail.message'].records.push({body:"not empty",model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});await this.start();assert.containsOnce(document.body,'.o_Message',"should display a single message");await afterNextRender(()=>document.querySelector('.o_Message_commandReply').click());assert.containsOnce(document.body,'.o_Composer',"should have composer after clicking on reply to message");await afterNextRender(()=>document.querySelector(`.o_Composer_buttonEmojis`).click());assert.containsOnce(document.body,'.o_EmojisPopover',"emojis popover should be opened after click on emojis button");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:"Escape"});document.querySelector(`.o_Composer_buttonEmojis`).dispatchEvent(ev);});assert.containsNone(document.body,'.o_EmojisPopover',"emojis popover should be closed after pressing escape on emojis button");assert.containsOnce(document.body,'.o_Composer',"reply composer should still be opened after pressing escape on emojis button");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"@");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"T");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));document.execCommand('insertText',false,"e");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});assert.containsOnce(document.body,'.o_ComposerSuggestion',"mention suggestion should be opened after typing @");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:"Escape"});document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(ev);});assert.containsNone(document.body,'.o_ComposerSuggestion',"mention suggestion should be closed after pressing escape on mention suggestion");assert.containsOnce(document.body,'.o_Composer',"reply composer should still be opened after pressing escape on mention suggestion");await afterNextRender(()=>{const ev=new window.KeyboardEvent('keydown',{bubbles:true,key:"Escape"});document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(ev);});assert.containsNone(document.body,'.o_Composer',"reply composer should be closed after pressing escape if there was no other priority escape handler");});QUnit.test('reply: discard on discard button click',async function(assert){assert.expect(4);this.data['mail.message'].records.push({body:"not empty",model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});await this.start();assert.containsOnce(document.body,'.o_Message',"should display a single message");await afterNextRender(()=>document.querySelector('.o_Message_commandReply').click());assert.containsOnce(document.body,'.o_Composer',"should have composer after clicking on reply to message");assert.containsOnce(document.body,'.o_Composer_buttonDiscard',"composer should have a discard button");await afterNextRender(()=>document.querySelector(`.o_Composer_buttonDiscard`).click());assert.containsNone(document.body,'.o_Composer',"reply composer should be closed after clicking on discard");});QUnit.test('reply: discard on reply button toggle',async function(assert){assert.expect(3);this.data['mail.message'].records.push({body:"not empty",model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});await this.start();assert.containsOnce(document.body,'.o_Message',"should display a single message");await afterNextRender(()=>document.querySelector('.o_Message_commandReply').click());assert.containsOnce(document.body,'.o_Composer',"should have composer after clicking on reply to message");await afterNextRender(()=>document.querySelector(`.o_Message_commandReply`).click());assert.containsNone(document.body,'.o_Composer',"reply composer should be closed after clicking on reply button again");});QUnit.test('reply: discard on click away',async function(assert){assert.expect(7);this.data['mail.message'].records.push({body:"not empty",model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});await this.start();assert.containsOnce(document.body,'.o_Message',"should display a single message");await afterNextRender(()=>document.querySelector('.o_Message_commandReply').click());assert.containsOnce(document.body,'.o_Composer',"should have composer after clicking on reply to message");document.querySelector(`.o_ComposerTextInput_textarea`).click();await nextAnimationFrame();assert.containsOnce(document.body,'.o_Composer',"reply composer should still be there after clicking inside itself");await afterNextRender(()=>document.querySelector(`.o_Composer_buttonEmojis`).click());assert.containsOnce(document.body,'.o_EmojisPopover',"emojis popover should be opened after clicking on emojis button");await afterNextRender(()=>{document.querySelector(`.o_EmojisPopover_emoji`).click();});assert.containsNone(document.body,'.o_EmojisPopover',"emojis popover should be closed after selecting an emoji");assert.containsOnce(document.body,'.o_Composer',"reply composer should still be there after selecting an emoji (even though it is technically a click away, it should be considered inside)");await afterNextRender(()=>document.querySelector(`.o_Message`).click());assert.containsNone(document.body,'.o_Composer',"reply composer should be closed after clicking away");});QUnit.test('"reply to" composer should log note if message replied to is a note',async function(assert){assert.expect(6);this.data['mail.message'].records.push({body:"not empty",is_discussion:false,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');assert.strictEqual(args.kwargs.message_type,"comment","should set message type as 'comment'");assert.strictEqual(args.kwargs.subtype_xmlid,"mail.mt_note","should set subtype_xmlid as 'note'");}
return this._super(...arguments);},});assert.containsOnce(document.body,'.o_Message',"should display a single message");await afterNextRender(()=>document.querySelector('.o_Message_commandReply').click());assert.strictEqual(document.querySelector('.o_Composer_buttonSend').textContent.trim(),"Log","Send button text should be 'Log'");await afterNextRender(()=>document.execCommand('insertText',false,"Test"));await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.verifySteps(['message_post']);});QUnit.test('"reply to" composer should send message if message replied to is not a note',async function(assert){assert.expect(6);this.data['mail.message'].records.push({body:"not empty",is_discussion:true,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');assert.strictEqual(args.kwargs.message_type,"comment","should set message type as 'comment'");assert.strictEqual(args.kwargs.subtype_xmlid,"mail.mt_comment","should set subtype_xmlid as 'comment'");}
return this._super(...arguments);},});assert.containsOnce(document.body,'.o_Message',"should display a single message");await afterNextRender(()=>document.querySelector('.o_Message_commandReply').click());assert.strictEqual(document.querySelector('.o_Composer_buttonSend').textContent.trim(),"Send","Send button text should be 'Send'");await afterNextRender(()=>document.execCommand('insertText',false,"Test"));await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.verifySteps(['message_post']);});QUnit.test('error notifications should not be shown in Inbox',async function(assert){assert.expect(3);this.data['mail.message'].records.push({body:"not empty",id:100,model:'mail.channel',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});this.data['mail.notification'].records.push({mail_message_id:100,res_partner_id:this.data.currentPartnerId,notification_status:'exception',notification_type:'email',});await this.start();assert.containsOnce(document.body,'.o_Message',"should display a single message");assert.containsOnce(document.body,'.o_Message_originThreadLink',"should display origin thread link");assert.containsNone(document.body,'.o_Message_notificationIcon',"should not display any notification icon in Inbox");});QUnit.test('show subject of message in Inbox',async function(assert){assert.expect(3);this.data['mail.message'].records.push({body:"not empty",model:'mail.channel',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],subject:"Salutations, voyageur",});await this.start();assert.containsOnce(document.body,'.o_Message',"should display a single message");assert.containsOnce(document.body,'.o_Message_subject',"should display subject of the message");assert.strictEqual(document.querySelector('.o_Message_subject').textContent,"Subject: Salutations, voyageur","Subject of the message should be 'Salutations, voyageur'");});QUnit.test('show subject of message in history',async function(assert){assert.expect(3);this.data['mail.message'].records.push({body:"not empty",history_partner_ids:[3],model:'mail.channel',subject:"Salutations, voyageur",});await this.start({discuss:{params:{default_active_id:'mail.box_history',},},});assert.containsOnce(document.body,'.o_Message',"should display a single message");assert.containsOnce(document.body,'.o_Message_subject',"should display subject of the message");assert.strictEqual(document.querySelector('.o_Message_subject').textContent,"Subject: Salutations, voyageur","Subject of the message should be 'Salutations, voyageur'");});QUnit.test('click on (non-channel/non-partner) origin thread link should redirect to form view',async function(assert){assert.expect(9);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do-action');assert.strictEqual(payload.action.type,'ir.actions.act_window',"action should open a view");assert.deepEqual(payload.action.views,[[false,'form']],"action should open form view");assert.strictEqual(payload.action.res_model,'some.model',"action should open view with model 'some.model' (model of message origin thread)");assert.strictEqual(payload.action.res_id,10,"action should open view with id 10 (id of message origin thread)");});this.data['some.model']={fields:{},records:[{id:10}]};this.data['mail.message'].records.push({body:"not empty",model:'some.model',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],record_name:"Some record",res_id:10,});await this.start({env:{bus,},});assert.containsOnce(document.body,'.o_Message',"should display a single message");assert.containsOnce(document.body,'.o_Message_originThreadLink',"should display origin thread link");assert.strictEqual(document.querySelector('.o_Message_originThreadLink').textContent,"Some record","origin thread link should display record name");document.querySelector('.o_Message_originThreadLink').click();assert.verifySteps(['do-action'],"should have made an action on click on origin thread (to open form view)");});});});});});;

/* /mail/static/src/components/discuss/tests/discuss_moderation_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/discuss/tests/discuss_moderation_tests.js',function(require){'use strict';const{afterEach,afterNextRender,beforeEach,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('discuss',{},function(){QUnit.module('discuss_moderation_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{autoOpenDiscuss:true,data:this.data,hasDiscuss:true,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('as moderator, moderated channel with pending moderation message',async function(assert){assert.expect(37);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,name:"general",});this.data['mail.message'].records.push({body:"<p>test</p>",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start();assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.moderation.localId
            }"]
        `),"should display the moderation box in the sidebar");const mailboxCounter=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.messaging.moderation.localId
        }"]
        .o_DiscussSidebarItem_counter
    `);assert.ok(mailboxCounter,"there should be a counter next to the moderation mailbox in the sidebar");assert.strictEqual(mailboxCounter.textContent.trim(),"1","the mailbox counter of the moderation mailbox should display '1'");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.moderation.localId
            }"]
        `).click());assert.containsOnce(document.body,'.o_Message',"should be only one message in moderation box");assert.strictEqual(document.querySelector('.o_Message_content').textContent,"test","this message pending moderation should have the correct content");assert.containsOnce(document.body,'.o_Message_originThreadLink',"thee message should have one origin");assert.strictEqual(document.querySelector('.o_Message_originThreadLink').textContent,"#general","the message pending moderation should have correct origin as its linked document");assert.containsOnce(document.body,'.o_Message_checkbox',"there should be a moderation checkbox next to the message");assert.notOk(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should be unchecked by default");assert.containsOnce(document.body,'.o_widget_Discuss_controlPanelButtonSelectAll',"there should be a 'Select All' button in the control panel");assert.doesNotHaveClass(document.querySelector('.o_widget_Discuss_controlPanelButtonSelectAll'),'disabled',"the 'Select All' button should not be disabled");assert.containsOnce(document.body,'.o_widget_Discuss_controlPanelButtonUnselectAll',"there should be a 'Unselect All' button in the control panel");assert.hasClass(document.querySelector('.o_widget_Discuss_controlPanelButtonUnselectAll'),'disabled',"the 'Unselect All' button should be disabled");assert.containsN(document.body,'.o_widget_Discuss_controlPanelButtonModeration',3,"there should be 3 buttons to moderate selected messages in the control panel");assert.containsOnce(document.body,'.o_widget_Discuss_controlPanelButtonModeration.o-accept',"there should one moderate button to accept messages pending moderation");assert.isNotVisible(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept'),"the moderate button 'Accept' should be invisible by default");assert.containsOnce(document.body,'.o_widget_Discuss_controlPanelButtonModeration.o-reject',"there should one moderate button to reject messages pending moderation");assert.isNotVisible(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-reject'),"the moderate button 'Reject' should be invisible by default");assert.containsOnce(document.body,'.o_widget_Discuss_controlPanelButtonModeration.o-discard',"there should one moderate button to discard messages pending moderation");assert.isNotVisible(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-discard'),"the moderate button 'Discard' should be invisible by default");await afterNextRender(()=>document.querySelector('.o_Message_checkbox').click());assert.ok(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should become checked after click");assert.hasClass(document.querySelector('.o_widget_Discuss_controlPanelButtonSelectAll'),'disabled',"the 'Select All' button should be disabled");assert.doesNotHaveClass(document.querySelector('.o_widget_Discuss_controlPanelButtonUnselectAll'),'disabled',"the 'Unselect All' button should not be disabled");assert.isVisible(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept'),"the moderate button 'Accept' should be visible");assert.isVisible(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-reject'),"the moderate button 'Reject' should be visible");assert.isVisible(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-discard'),"the moderate button 'Discard' should be visible");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonUnselectAll').click());assert.notOk(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should become unchecked after click");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonSelectAll').click());assert.ok(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should become checked again after click");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.containsOnce(document.body,'.o_Message',"should be only one message in general channel");assert.containsOnce(document.body,'.o_Message_checkbox',"there should be a moderation checkbox next to the message");assert.notOk(document.querySelector('.o_Message_checkbox').checked,"the moderation checkbox should not be checked here");await afterNextRender(()=>document.querySelector('.o_Message_checkbox').click());await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-discard').click());assert.containsOnce(document.body,'.o_ModerationDiscardDialog',"discard dialog should be open");await afterNextRender(()=>document.querySelector('.o_ModerationDiscardDialog .o-cancel').click());assert.containsNone(document.body,'.o_ModerationDiscardDialog',"discard dialog should be closed");await afterNextRender(()=>document.querySelector(`
            .o_widget_Discuss_controlPanelButtonModeration.o-reject
        `).click());assert.containsOnce(document.body,'.o_ModerationRejectDialog',"reject dialog should be open");await afterNextRender(()=>document.querySelector('.o_ModerationRejectDialog .o-cancel').click());assert.containsNone(document.body,'.o_ModerationRejectDialog',"reject dialog should be closed");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept').click());assert.containsOnce(document.body,'.o_Message',"should still be only one message in general channel");assert.containsNone(document.body,'.o_Message_checkbox',"there should not be a moderation checkbox next to the message");});QUnit.test('as moderator, accept pending moderation message',async function(assert){assert.expect(12);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,name:"general",});this.data['mail.message'].records.push({body:"<p>test</p>",id:100,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start({async mockRPC(route,args){if(args.method==='moderate'){assert.step('moderate');const messageIDs=args.args[0];const decision=args.args[1];assert.strictEqual(messageIDs.length,1,"should moderate one message");assert.strictEqual(messageIDs[0],100,"should moderate message with ID 100");assert.strictEqual(decision,'accept',"should accept the message");}
return this._super(...arguments);},});const moderationBox=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.messaging.moderation.localId
        }"]
    `);assert.ok(moderationBox,"should display the moderation box");await afterNextRender(()=>moderationBox.click());assert.ok(document.querySelector(`
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
        `),"should display the message to moderate");const acceptButton=document.querySelector(`
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
        .o_Message_moderationAction.o-accept
    `);assert.ok(acceptButton,"should display the accept button");await afterNextRender(()=>acceptButton.click());assert.verifySteps(['moderate']);assert.containsOnce(document.body,'.o_MessageList_emptyTitle',"should now have no message displayed in moderation box");const channel=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 20,
                model: 'mail.channel',
            }).localId
        }"]
    `);assert.ok(channel,"should display the general channel");await afterNextRender(()=>channel.click());const message=document.querySelector(`
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);assert.ok(message,"should display the accepted message");assert.containsNone(message,'.o_Message_moderationPending',"the message should not be pending moderation");});QUnit.test('as moderator, reject pending moderation message (reject with explanation)',async function(assert){assert.expect(23);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,name:"general",});this.data['mail.message'].records.push({body:"<p>test</p>",id:100,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start({async mockRPC(route,args){if(args.method==='moderate'){assert.step('moderate');const messageIDs=args.args[0];const decision=args.args[1];const kwargs=args.kwargs;assert.strictEqual(messageIDs.length,1,"should moderate one message");assert.strictEqual(messageIDs[0],100,"should moderate message with ID 100");assert.strictEqual(decision,'reject',"should reject the message");assert.strictEqual(kwargs.title,"Message Rejected","should have correct reject message title");assert.strictEqual(kwargs.comment,"Your message was rejected by moderator.","should have correct reject message body / comment");}
return this._super(...arguments);},});const moderationBox=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.messaging.moderation.localId
        }"]
    `);assert.ok(moderationBox,"should display the moderation box");await afterNextRender(()=>moderationBox.click());const pendingMessage=document.querySelector(`
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);assert.ok(pendingMessage,"should display the message to moderate");const rejectButton=pendingMessage.querySelector(':scope .o_Message_moderationAction.o-reject');assert.ok(rejectButton,"should display the reject button");await afterNextRender(()=>rejectButton.click());const dialog=document.querySelector('.o_ModerationRejectDialog');assert.ok(dialog,"a dialog should be prompt to the moderator on click reject");assert.strictEqual(dialog.querySelector('.modal-title').textContent,"Send explanation to author","dialog should have correct title");const messageTitle=dialog.querySelector(':scope .o_ModerationRejectDialog_title');assert.ok(messageTitle,"should have a title for rejecting");assert.hasAttrValue(messageTitle,'placeholder',"Subject","title for reject reason should have correct placeholder");assert.strictEqual(messageTitle.value,"Message Rejected","title for reject reason should have correct default value");const messageComment=dialog.querySelector(':scope .o_ModerationRejectDialog_comment');assert.ok(messageComment,"should have a comment for rejecting");assert.hasAttrValue(messageComment,'placeholder',"Mail Body","comment for reject reason should have correct placeholder");assert.strictEqual(messageComment.value,"Your message was rejected by moderator.","comment for reject reason should have correct default text content");const confirmReject=dialog.querySelector(':scope .o-reject');assert.ok(confirmReject,"should have reject button");assert.strictEqual(confirmReject.textContent,"Reject");await afterNextRender(()=>confirmReject.click());assert.verifySteps(['moderate']);assert.containsOnce(document.body,'.o_MessageList_emptyTitle',"should now have no message displayed in moderation box");const channel=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 20,
                model: 'mail.channel',
            }).localId
        }"]
    `);assert.ok(channel,'should display the general channel');await afterNextRender(()=>channel.click());assert.containsNone(document.body,'.o_Message',"should now have no message in channel");});QUnit.test('as moderator, discard pending moderation message (reject without explanation)',async function(assert){assert.expect(16);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,name:"general",});this.data['mail.message'].records.push({body:"<p>test</p>",id:100,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start({async mockRPC(route,args){if(args.method==='moderate'){assert.step('moderate');const messageIDs=args.args[0];const decision=args.args[1];assert.strictEqual(messageIDs.length,1,"should moderate one message");assert.strictEqual(messageIDs[0],100,"should moderate message with ID 100");assert.strictEqual(decision,'discard',"should discard the message");}
return this._super(...arguments);},});const moderationBox=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.messaging.moderation.localId
        }"]
    `);assert.ok(moderationBox,"should display the moderation box");await afterNextRender(()=>moderationBox.click());const pendingMessage=document.querySelector(`
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);assert.ok(pendingMessage,"should display the message to moderate");const discardButton=pendingMessage.querySelector(`
        :scope .o_Message_moderationAction.o-discard
    `);assert.ok(discardButton,"should display the discard button");await afterNextRender(()=>discardButton.click());const dialog=document.querySelector('.o_ModerationDiscardDialog');assert.ok(dialog,"a dialog should be prompt to the moderator on click discard");assert.strictEqual(dialog.querySelector('.modal-title').textContent,"Confirmation","dialog should have correct title");assert.strictEqual(dialog.textContent,"Confirmation×You are going to discard 1 message.Do you confirm the action?DiscardCancel","should warn the user on discard action");const confirmDiscard=dialog.querySelector(':scope .o-discard');assert.ok(confirmDiscard,"should have discard button");assert.strictEqual(confirmDiscard.textContent,"Discard");await afterNextRender(()=>confirmDiscard.click());assert.verifySteps(['moderate']);assert.containsOnce(document.body,'.o_MessageList_emptyTitle',"should now have no message displayed in moderation box");const channel=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 20,
                model: 'mail.channel',
            }).localId
        }"]
    `);assert.ok(channel,"should display the general channel");await afterNextRender(()=>channel.click());assert.containsNone(document.body,'.o_Message',"should now have no message in channel");});QUnit.test('as author, send message in moderated channel',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20,moderation:true,name:"general",});await this.start();const channel=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 20,
                model: 'mail.channel',
            }).localId
        }"]
    `);assert.ok(channel,"should display the general channel");await afterNextRender(()=>channel.click());assert.containsNone(document.body,'.o_Message',"should have no message in channel");await afterNextRender(()=>{const textInput=document.querySelector('.o_ComposerTextInput_textarea');textInput.focus();document.execCommand('insertText',false,"Some Text");});await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());const messagePending=document.querySelector('.o_Message_moderationPending');assert.ok(messagePending,"should display the pending message with pending info");assert.hasClass(messagePending,'o-author',"the message should be pending moderation as author");});QUnit.test('as author, sent message accepted in moderated channel',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20,moderation:true,name:"general",});this.data['mail.message'].records.push({body:"not empty",id:100,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start();const channel=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 20,
                model: 'mail.channel',
            }).localId
        }"]
    `);assert.ok(channel,"should display the general channel");await afterNextRender(()=>channel.click());const messagePending=document.querySelector(`
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
        .o_Message_moderationPending
    `);assert.ok(messagePending,"should display the pending message with pending info");assert.hasClass(messagePending,'o-author',"the message should be pending moderation as author");await afterNextRender(()=>{const messageData={id:100,moderation_status:'accepted',};const notification=[[false,'mail.channel',20],messageData];this.widget.call('bus_service','trigger','notification',[notification]);});const message=document.querySelector(`
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);assert.ok(message,"should still display the message");assert.containsNone(message,'.o_Message_moderationPending',"the message should not be in pending moderation anymore");});QUnit.test('as author, sent message rejected in moderated channel',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20,moderation:true,name:"general",});this.data['mail.message'].records.push({body:"not empty",id:100,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start();const channel=document.querySelector(`
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 20,
                model: 'mail.channel',
            }).localId
        }"]
    `);assert.ok(channel,"should display the general channel");await afterNextRender(()=>channel.click());const messagePending=document.querySelector(`
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
        .o_Message_moderationPending
    `);assert.ok(messagePending,"should display the pending message with pending info");assert.hasClass(messagePending,'o-author',"the message should be pending moderation as author");await afterNextRender(()=>{const notifData={type:'deletion',message_ids:[100],};const notification=[[false,'res.partner',this.env.messaging.currentPartner.id],notifData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.containsNone(document.body,'.o_Message',"message should be removed from channel after reject");});QUnit.test('as moderator, pending moderation message accessibility',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,});this.data['mail.message'].records.push({body:"not empty",id:100,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.moderation.localId
            }"]
        `),"should display the moderation box in the sidebar");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${thread.localId}"]
        `).click());const message=this.env.models['mail.message'].findFromIdentifyingData({id:100});assert.containsOnce(document.body,`.o_Message[data-message-local-id="${message.localId}"]`,"the pending moderation message should be in the channel");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.moderation.localId
            }"]
        `).click());assert.containsOnce(document.body,`.o_Message[data-message-local-id="${message.localId}"]`,"the pending moderation message should be in moderation box");});QUnit.test('as author, pending moderation message should appear in origin thread',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20,moderation:true,});this.data['mail.message'].records.push({author_id:this.data.currentPartnerId,body:"not empty",id:100,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${thread.localId}"]
        `).click());const message=this.env.models['mail.message'].findFromIdentifyingData({id:100});assert.containsOnce(document.body,`.o_Message[data-message-local-id="${message.localId}"]`,"the pending moderation message should be in the channel");});QUnit.test('as moderator, new pending moderation message posted by someone else',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${thread.localId}"]
        `).click());assert.containsNone(document.body,`.o_Message`,"should have no message in the channel initially");const messageData={author_id:[10,'john doe'],body:"not empty",channel_ids:[],id:1,model:'mail.channel',moderation_status:'pending_moderation',res_id:20,};await afterNextRender(()=>{const notifications=[[['my-db','res.partner',this.env.messaging.currentPartner.id],{type:'moderator',message:messageData},]];this.widget.call('bus_service','trigger','notification',notifications);});const message=this.env.models['mail.message'].findFromIdentifyingData({id:1});assert.containsOnce(document.body,`.o_Message[data-message-local-id="${message.localId}"]`,"the pending moderation message should be in the channel");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.moderation.localId
            }"]
        `).click());assert.containsOnce(document.body,`.o_Message[data-message-local-id="${message.localId}"]`,"the pending moderation message should be in moderation box");});QUnit.test('accept multiple moderation messages',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,});this.data['mail.message'].records.push({body:"not empty",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,},{body:"not empty",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,},{body:"not empty",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start({discuss:{params:{default_active_id:'mail.box_moderation',},},});assert.containsN(document.body,'.o_Message',3,"should initially display 3 messages");await afterNextRender(()=>{document.querySelectorAll('.o_Message_checkbox')[0].click();document.querySelectorAll('.o_Message_checkbox')[1].click();});assert.containsN(document.body,'.o_Message_checkbox:checked',2,"2 messages should have been checked after clicking on their respective checkbox");assert.doesNotHaveClass(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept'),'o_hidden',"global accept button should be displayed as two messages are selected");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept').click());assert.containsN(document.body,'.o_Message',1,"should display 1 message as the 2 others have been accepted");assert.hasClass(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept'),'o_hidden',"global accept button should no longer be displayed as messages have been unselected");});QUnit.test('accept multiple moderation messages after having accepted other messages',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20,is_moderator:true,moderation:true,});this.data['mail.message'].records.push({body:"not empty",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,},{body:"not empty",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,},{body:"not empty",model:'mail.channel',moderation_status:'pending_moderation',res_id:20,});await this.start({discuss:{params:{default_active_id:'mail.box_moderation',},},});assert.containsN(document.body,'.o_Message',3,"should initially display 3 messages");await afterNextRender(()=>{document.querySelectorAll('.o_Message_checkbox')[0].click();});await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept').click());await afterNextRender(()=>document.querySelectorAll('.o_Message_checkbox')[0].click());assert.containsOnce(document.body,'.o_Message_checkbox:checked',"a message should have been checked after clicking on its checkbox");assert.doesNotHaveClass(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept'),'o_hidden',"global accept button should be displayed as a message is selected");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept').click());assert.containsOnce(document.body,'.o_Message',"should display only one message left after the two others has been accepted");assert.hasClass(document.querySelector('.o_widget_Discuss_controlPanelButtonModeration.o-accept'),'o_hidden',"global accept button should no longer be displayed as message has been unselected");});});});});});;

/* /mail/static/src/components/discuss/tests/discuss_pinned_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/discuss/tests/discuss_pinned_tests.js',function(require){'use strict';const{afterEach,afterNextRender,beforeEach,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('discuss',{},function(){QUnit.module('discuss_pinned_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{autoOpenDiscuss:true,data:this.data,hasDiscuss:true,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('sidebar: pinned channel 1: init with one pinned channel',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});await this.start();assert.containsOnce(document.body,`.o_Discuss_thread[data-thread-local-id="${this.env.messaging.inbox.localId}"]`,"The Inbox is opened in discuss");assert.containsOnce(document.body,`.o_DiscussSidebarItem[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 20,
                model: 'mail.channel',
            }).localId
        }"]`,"should have the only channel of which user is member in discuss sidebar");});QUnit.test('sidebar: pinned channel 2: open pinned channel',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20});await this.start();const threadGeneral=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await afterNextRender(()=>document.querySelector(`.o_DiscussSidebarItem[data-thread-local-id="${
            threadGeneral.localId
        }"]`).click());assert.containsOnce(document.body,`.o_Discuss_thread[data-thread-local-id="${threadGeneral.localId}"]`,"The channel #General is displayed in discuss");});QUnit.test('sidebar: pinned channel 3: open pinned channel and unpin it',async function(assert){assert.expect(8);this.data['mail.channel'].records.push({id:20,is_minimized:true,state:'open',});await this.start({async mockRPC(route,args){if(args.method==='execute_command'){assert.step('execute_command');assert.deepEqual(args.args[0],[20],"The right id is sent to the server to remove");assert.strictEqual(args.kwargs.command,'leave',"The right command is sent to the server");}
if(args.method==='channel_fold'){assert.step('channel_fold');}
return this._super(...arguments);},});const threadGeneral=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await afterNextRender(()=>document.querySelector(`.o_DiscussSidebarItem[data-thread-local-id="${
            threadGeneral.localId
        }"]`).click());assert.verifySteps([],"neither channel_fold nor execute_command are called yet");await afterNextRender(()=>document.querySelector('.o_DiscussSidebarItem_commandLeave').click());assert.verifySteps(['channel_fold','execute_command'],"both channel_fold and execute_command have been called when unpinning a channel");assert.containsNone(document.body,`.o_DiscussSidebarItem[data-thread-local-id="${threadGeneral.localId}"]`,"The channel must have been removed from discuss sidebar");assert.containsOnce(document.body,'.o_Discuss_noThread',"should have no thread opened in discuss");});QUnit.test('sidebar: unpin channel from bus',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20});await this.start();const threadGeneral=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});assert.containsOnce(document.body,`.o_Discuss_thread[data-thread-local-id="${this.env.messaging.inbox.localId}"]`,"The Inbox is opened in discuss");assert.containsOnce(document.body,`.o_DiscussSidebarItem[data-thread-local-id="${threadGeneral.localId}"]`,"1 channel is present in discuss sidebar and it is 'general'");await afterNextRender(()=>document.querySelector(`.o_DiscussSidebarItem[data-thread-local-id="${
            threadGeneral.localId
        }"]`).click());assert.containsOnce(document.body,`.o_Discuss_thread[data-thread-local-id="${threadGeneral.localId}"]`,"The channel #General is opened in discuss");await afterNextRender(()=>{const notif=[["dbName",'res.partner',this.env.messaging.currentPartner.id],{channel_type:'channel',id:20,info:'unsubscribe',name:"General",public:'public',state:'open',}];this.env.services.bus_service.trigger('notification',[notif]);});assert.containsOnce(document.body,'.o_Discuss_noThread',"should have no thread opened in discuss");assert.containsNone(document.body,`.o_DiscussSidebarItem[data-thread-local-id="${threadGeneral.localId}"]`,"The channel must have been removed from discuss sidebar");});QUnit.test('[technical] sidebar: channel group_based_subscription: mandatorily pinned',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({group_based_subscription:true,id:20,is_pinned:false,});await this.start();const threadGeneral=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});assert.containsOnce(document.body,`.o_DiscussSidebarItem[data-thread-local-id="${threadGeneral.localId}"]`,"The channel #General is in discuss sidebar");assert.containsNone(document.body,'o_DiscussSidebarItem_commandLeave',"The group_based_subscription channel is not unpinnable");});});});});});;

/* /mail/static/src/components/discuss/tests/discuss_sidebar_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/discuss/tests/discuss_sidebar_tests.js',function(require){'use strict';const{makeDeferred}=require('mail/static/src/utils/deferred/deferred.js');const{afterEach,afterNextRender,beforeEach,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('discuss',{},function(){QUnit.module('discuss_sidebar_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{autoOpenDiscuss:true,data:this.data,hasDiscuss:true,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('sidebar find shows channels matching search term',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({channel_partner_ids:[],channel_type:'channel',id:20,members:[],name:'test',public:'public',});const searchReadDef=makeDeferred();await this.start({async mockRPC(route,args){const res=await this._super(...arguments);if(args.method==='search_read'){searchReadDef.resolve();}
return res;},});await afterNextRender(()=>document.querySelector(`.o_DiscussSidebar_groupHeaderItemAdd`).click());document.querySelector(`.o_DiscussSidebar_itemNew`).focus();document.execCommand('insertText',false,"test");document.querySelector(`.o_DiscussSidebar_itemNew`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_DiscussSidebar_itemNew`).dispatchEvent(new window.KeyboardEvent('keyup'));await searchReadDef;await nextAnimationFrame();const results=document.querySelectorAll('.ui-autocomplete .ui-menu-item a');assert.ok(results,"should have autocomplete suggestion after typing on 'find or create channel' input");assert.strictEqual(results.length,3);assert.strictEqual(results[0].textContent,"test","autocomplete suggestion should target the channel matching search term");});QUnit.test('sidebar find shows channels matching search term even when user is member',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({channel_partner_ids:[this.data.currentPartnerId],channel_type:'channel',id:20,members:[this.data.currentPartnerId],name:'test',public:'public',});const searchReadDef=makeDeferred();await this.start({async mockRPC(route,args){const res=await this._super(...arguments);if(args.method==='search_read'){searchReadDef.resolve();}
return res;},});await afterNextRender(()=>document.querySelector(`.o_DiscussSidebar_groupHeaderItemAdd`).click());document.querySelector(`.o_DiscussSidebar_itemNew`).focus();document.execCommand('insertText',false,"test");document.querySelector(`.o_DiscussSidebar_itemNew`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_DiscussSidebar_itemNew`).dispatchEvent(new window.KeyboardEvent('keyup'));await searchReadDef;await nextAnimationFrame();const results=document.querySelectorAll('.ui-autocomplete .ui-menu-item a');assert.ok(results,"should have autocomplete suggestion after typing on 'find or create channel' input");assert.strictEqual(results.length,3);assert.strictEqual(results[0].textContent,"test","autocomplete suggestion should target the channel matching search term even if user is member");});});});});});;

/* /mail/static/src/components/discuss/tests/discuss_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/discuss/tests/discuss_tests.js',function(require){'use strict';const BusService=require('bus.BusService');const{afterEach,afterNextRender,beforeEach,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');const{makeTestPromise,file:{createFile,inputFiles}}=require('web.test_utils');const{applyFilter,toggleAddCustomFilter,toggleFilterMenu,}=require('web.test_utils_control_panel');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('discuss',{},function(){QUnit.module('discuss_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{afterEvent,env,widget}=await start(Object.assign({},params,{autoOpenDiscuss:true,data:this.data,hasDiscuss:true,}));this.afterEvent=afterEvent;this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('messaging not initialized',async function(assert){assert.expect(1);await this.start({async mockRPC(route){const _super=this._super.bind(this,...arguments);if(route==='/mail/init_messaging'){await makeTestPromise();}
return _super();},waitUntilMessagingCondition:'created',});assert.strictEqual(document.querySelectorAll('.o_Discuss_messagingNotInitialized').length,1,"should display messaging not initialized");});QUnit.test('messaging becomes initialized',async function(assert){assert.expect(2);const messagingInitializedProm=makeTestPromise();await this.start({async mockRPC(route){const _super=this._super.bind(this,...arguments);if(route==='/mail/init_messaging'){await messagingInitializedProm;}
return _super();},waitUntilMessagingCondition:'created',});assert.strictEqual(document.querySelectorAll('.o_Discuss_messagingNotInitialized').length,1,"should display messaging not initialized");await afterNextRender(()=>messagingInitializedProm.resolve());assert.strictEqual(document.querySelectorAll('.o_Discuss_messagingNotInitialized').length,0,"should no longer display messaging not initialized");});QUnit.test('basic rendering',async function(assert){assert.expect(4);await this.start();assert.strictEqual(document.querySelectorAll('.o_Discuss_sidebar').length,1,"should have a sidebar section");assert.strictEqual(document.querySelectorAll('.o_Discuss_content').length,1,"should have content section");assert.strictEqual(document.querySelectorAll('.o_Discuss_thread').length,1,"should have thread section inside content");assert.ok(document.querySelector('.o_Discuss_thread').classList.contains('o_ThreadView'),"thread section should use ThreadView component");});QUnit.test('basic rendering: sidebar',async function(assert){assert.expect(20);await this.start();assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_group`).length,3,"should have 3 groups in sidebar");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupMailbox`).length,1,"should have group 'Mailbox' in sidebar");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupMailbox .o_DiscussSidebar_groupHeader
        `).length,0,"mailbox category should not have any header");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupMailbox .o_DiscussSidebar_item
        `).length,3,"should have 3 mailbox items");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupMailbox
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).length,1,"should have inbox mailbox item");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupMailbox
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
        `).length,1,"should have starred mailbox item");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupMailbox
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).length,1,"should have history mailbox item");assert.strictEqual(document.querySelectorAll(`.o_Discuss_sidebar .o_DiscussSidebar_separator`).length,1,"should have separator (between mailboxes and channels, but that's not tested)");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel`).length,1,"should have group 'Channel' in sidebar");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChannel .o_DiscussSidebar_groupHeader
        `).length,1,"channel category should have a header");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChannel .o_DiscussSidebar_groupTitle
        `).length,1,"should have title in channel header");assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_groupChannel .o_DiscussSidebar_groupTitle
        `).textContent.trim(),"Channels");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_list`).length,1,"channel category should list items");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).length,0,"channel category should have no item by default");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChat`).length,1,"should have group 'Chat' in sidebar");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_groupHeader`).length,1,"channel category should have a header");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_groupTitle`).length,1,"should have title in chat header");assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_groupChat .o_DiscussSidebar_groupTitle
        `).textContent.trim(),"Direct Messages");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_list`).length,1,"chat category should list items");assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_item`).length,0,"chat category should have no item by default");});QUnit.test('sidebar: basic mailbox rendering',async function(assert){assert.expect(6);await this.start();const inbox=document.querySelector(`
        .o_DiscussSidebar_groupMailbox
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.messaging.inbox.localId
        }"]
    `);assert.strictEqual(inbox.querySelectorAll(`:scope .o_DiscussSidebarItem_activeIndicator`).length,1,"mailbox should have active indicator");assert.strictEqual(inbox.querySelectorAll(`:scope .o_ThreadIcon`).length,1,"mailbox should have an icon");assert.strictEqual(inbox.querySelectorAll(`:scope .o_ThreadIcon_mailboxInbox`).length,1,"inbox should have 'inbox' icon");assert.strictEqual(inbox.querySelectorAll(`:scope .o_DiscussSidebarItem_name`).length,1,"mailbox should have a name");assert.strictEqual(inbox.querySelector(`:scope .o_DiscussSidebarItem_name`).textContent,"Inbox","inbox should have name 'Inbox'");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).length,0,"should have no counter when equal to 0 (default value)");});QUnit.test('sidebar: default active inbox',async function(assert){assert.expect(1);await this.start();const inbox=document.querySelector(`
        .o_DiscussSidebar_groupMailbox
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.messaging.inbox.localId
        }"]
    `);assert.ok(inbox.querySelector(`
            :scope .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"inbox should be active by default");});QUnit.test('sidebar: change item',async function(assert){assert.expect(4);await this.start();assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"inbox should be active by default");assert.notOk(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"starred should be inactive by default");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
        `).click());assert.notOk(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"inbox mailbox should become inactive");assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"starred mailbox should become active");});QUnit.test('sidebar: inbox with counter',async function(assert){assert.expect(2);this.data['mail.notification'].records.push({res_partner_id:this.data.currentPartnerId});await this.start();assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).length,1,"should display a counter (= have a counter when different from 0)");assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).textContent,"1","should have counter value");});QUnit.test('sidebar: add channel',async function(assert){assert.expect(3);await this.start();assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChannel
            .o_DiscussSidebar_groupHeaderItemAdd
        `).length,1,"should be able to add channel from header");assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_groupChannel
            .o_DiscussSidebar_groupHeaderItemAdd
        `).title,"Add or join a channel");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_groupChannel .o_DiscussSidebar_groupHeaderItemAdd
        `).click());assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_itemNew`).length,1,"should have item to add a new channel");});QUnit.test('sidebar: basic channel rendering',async function(assert){assert.expect(14);this.data['mail.channel'].records.push({id:20,name:"General"});await this.start();assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).length,1,"should have one channel item");let channel=document.querySelector(`
        .o_DiscussSidebar_groupChannel
        .o_DiscussSidebar_item
    `);assert.strictEqual(channel.dataset.threadLocalId,this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',}).localId,"should have channel with Id 20");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_activeIndicator`).length,1,"should have active indicator");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_activeIndicator.o-item-active`).length,0,"should not be active by default");assert.strictEqual(channel.querySelectorAll(`:scope .o_ThreadIcon`).length,1,"should have an icon");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_name`).length,1,"should have a name");assert.strictEqual(channel.querySelector(`:scope .o_DiscussSidebarItem_name`).textContent,"General","should have name value");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_commands`).length,1,"should have commands");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_command`).length,2,"should have 2 commands");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_commandSettings`).length,1,"should have 'settings' command");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_commandLeave`).length,1,"should have 'leave' command");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_counter`).length,0,"should have a counter when equals 0 (default value)");await afterNextRender(()=>document.querySelector(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).click());channel=document.querySelector(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`);assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_activeIndicator.o-item-active`).length,1,"channel should become active");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_ThreadView_composer`).length,1,"should have composer section inside thread content (can post message in channel)");});QUnit.test('sidebar: channel rendering with needaction counter',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20});this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],id:100,});this.data['mail.notification'].records.push({mail_message_id:100,res_partner_id:this.data.currentPartnerId,});await this.start();const channel=document.querySelector(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`);assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_counter`).length,1,"should have a counter when different from 0");assert.strictEqual(channel.querySelector(`:scope .o_DiscussSidebarItem_counter`).textContent,"1","should have counter value");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_command`).length,1,"should have single command");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_commandSettings`).length,1,"should have 'settings' command");assert.strictEqual(channel.querySelectorAll(`:scope .o_DiscussSidebarItem_commandLeave`).length,0,"should not have 'leave' command");});QUnit.test('sidebar: mailing channel',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({mass_mailing:true});await this.start();assert.containsOnce(document.querySelector(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`),'.fa.fa-envelope-o',"should have an icon to indicate that the channel is a mailing channel");});QUnit.test('sidebar: public/private channel rendering',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:100,name:"channel1",public:'public',},{id:101,name:"channel2",public:'private'});await this.start();assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).length,2,"should have 2 channel items");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChannel
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 100,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have channel1 (Id 100)");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChannel
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 101,
                    model: 'mail.channel'
                }).localId
            }"]
        `).length,1,"should have channel2 (Id 101)");const channel1=document.querySelector(`
        .o_DiscussSidebar_groupChannel
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 100,
                model: 'mail.channel'
            }).localId
        }"]
    `);const channel2=document.querySelector(`
        .o_DiscussSidebar_groupChannel
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 101,
                model: 'mail.channel'
            }).localId
        }"]
    `);assert.strictEqual(channel1.querySelectorAll(`:scope .o_ThreadIcon_channelPublic`).length,1,"channel1 (public) has hashtag icon");assert.strictEqual(channel2.querySelectorAll(`:scope .o_ThreadIcon_channelPrivate`).length,1,"channel2 (private) has lock icon");});QUnit.test('sidebar: basic chat rendering',async function(assert){assert.expect(11);this.data['res.partner'].records.push({id:17,name:"Demo"});this.data['mail.channel'].records.push({channel_type:'chat',id:10,members:[this.data.currentPartnerId,17],public:'private',});await this.start();assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_item`).length,1,"should have one chat item");const chat=document.querySelector(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_item`);assert.strictEqual(chat.dataset.threadLocalId,this.env.models['mail.thread'].findFromIdentifyingData({id:10,model:'mail.channel'}).localId,"should have chat with Id 10");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_activeIndicator`).length,1,"should have active indicator");assert.strictEqual(chat.querySelectorAll(`:scope .o_ThreadIcon`).length,1,"should have an icon");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_name`).length,1,"should have a name");assert.strictEqual(chat.querySelector(`:scope .o_DiscussSidebarItem_name`).textContent,"Demo","should have correspondent name as name");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_commands`).length,1,"should have commands");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_command`).length,2,"should have 2 commands");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_commandRename`).length,1,"should have 'rename' command");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_commandUnpin`).length,1,"should have 'unpin' command");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_counter`).length,0,"should have a counter when equals 0 (default value)");});QUnit.test('sidebar: chat rendering with unread counter',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({channel_type:'chat',id:10,message_unread_counter:100,public:'private',});await this.start();const chat=document.querySelector(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_item`);assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_counter`).length,1,"should have a counter when different from 0");assert.strictEqual(chat.querySelector(`:scope .o_DiscussSidebarItem_counter`).textContent,"100","should have counter value");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_command`).length,1,"should have single command");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_commandRename`).length,1,"should have 'rename' command");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_commandUnpin`).length,0,"should not have 'unpin' command");});QUnit.test('sidebar: chat im_status rendering',async function(assert){assert.expect(7);this.data['res.partner'].records.push({id:101,im_status:'offline',name:"Partner1"},{id:102,im_status:'online',name:"Partner2"},{id:103,im_status:'away',name:"Partner3"});this.data['mail.channel'].records.push({channel_type:'chat',id:11,members:[this.data.currentPartnerId,101],public:'private',},{channel_type:'chat',id:12,members:[this.data.currentPartnerId,102],public:'private',},{channel_type:'chat',id:13,members:[this.data.currentPartnerId,103],public:'private',});await this.start();assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_item`).length,3,"should have 3 chat items");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChat
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 11,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have Partner1 (Id 11)");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChat
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 12,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have Partner2 (Id 12)");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_groupChat
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 13,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have Partner3 (Id 13)");const chat1=document.querySelector(`
        .o_DiscussSidebar_groupChat
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 11,
                model: 'mail.channel',
            }).localId
        }"]
    `);const chat2=document.querySelector(`
        .o_DiscussSidebar_groupChat
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 12,
                model: 'mail.channel',
            }).localId
        }"]
    `);const chat3=document.querySelector(`
        .o_DiscussSidebar_groupChat
        .o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 13,
                model: 'mail.channel',
            }).localId
        }"]
    `);assert.strictEqual(chat1.querySelectorAll(`:scope .o_ThreadIcon_offline`).length,1,"chat1 should have offline icon");assert.strictEqual(chat2.querySelectorAll(`:scope .o_ThreadIcon_online`).length,1,"chat2 should have online icon");assert.strictEqual(chat3.querySelectorAll(`:scope .o_ThreadIcon_away`).length,1,"chat3 should have away icon");});QUnit.test('sidebar: chat custom name',async function(assert){assert.expect(1);this.data['res.partner'].records.push({id:101,name:"Marc Demo"});this.data['mail.channel'].records.push({channel_type:'chat',custom_channel_name:"Marc",members:[this.data.currentPartnerId,101],public:'private',});await this.start();const chat=document.querySelector(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_item`);assert.strictEqual(chat.querySelector(`:scope .o_DiscussSidebarItem_name`).textContent,"Marc","chat should have custom name as name");});QUnit.test('sidebar: rename chat',async function(assert){assert.expect(8);this.data['res.partner'].records.push({id:101,name:"Marc Demo"});this.data['mail.channel'].records.push({channel_type:'chat',custom_channel_name:"Marc",members:[this.data.currentPartnerId,101],public:'private',});await this.start();const chat=document.querySelector(`.o_DiscussSidebar_groupChat .o_DiscussSidebar_item`);assert.strictEqual(chat.querySelector(`:scope .o_DiscussSidebarItem_name`).textContent,"Marc","chat should have custom name as name");assert.notOk(chat.querySelector(`:scope .o_DiscussSidebarItem_name`).classList.contains('o-editable'),"chat name should not be editable");await afterNextRender(()=>chat.querySelector(`:scope .o_DiscussSidebarItem_commandRename`).click());assert.ok(chat.querySelector(`:scope .o_DiscussSidebarItem_name`).classList.contains('o-editable'),"chat should have editable name");assert.strictEqual(chat.querySelectorAll(`:scope .o_DiscussSidebarItem_nameInput`).length,1,"chat should have editable name input");assert.strictEqual(chat.querySelector(`:scope .o_DiscussSidebarItem_nameInput`).value,"Marc","editable name input should have custom chat name as value by default");assert.strictEqual(chat.querySelector(`:scope .o_DiscussSidebarItem_nameInput`).placeholder,"Marc Demo","editable name input should have partner name as placeholder");await afterNextRender(()=>{chat.querySelector(`:scope .o_DiscussSidebarItem_nameInput`).value="Demo";const kevt=new window.KeyboardEvent('keydown',{key:"Enter"});chat.querySelector(`:scope .o_DiscussSidebarItem_nameInput`).dispatchEvent(kevt);});assert.notOk(chat.querySelector(`:scope .o_DiscussSidebarItem_name`).classList.contains('o-editable'),"chat should no longer show editable name");assert.strictEqual(chat.querySelector(`:scope .o_DiscussSidebarItem_name`).textContent,"Demo","chat should have renamed name as name");});QUnit.test('default thread rendering',async function(assert){assert.expect(16);this.data['mail.channel'].records.push({id:20});await this.start();assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).length,1,"should have inbox mailbox in the sidebar");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
        `).length,1,"should have starred mailbox in the sidebar");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).length,1,"should have history mailbox in the sidebar");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have channel 20 in the sidebar");assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).classList.contains('o-active'),"inbox mailbox should be active thread");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_empty
        `).length,1,"should have empty thread in inbox");assert.strictEqual(document.querySelector(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_empty
        `).textContent.trim(),"Congratulations, your inbox is empty  New messages appear here.");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
        `).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
        `).classList.contains('o-active'),"starred mailbox should be active thread");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_empty
        `).length,1,"should have empty thread in starred");assert.strictEqual(document.querySelector(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_empty
        `).textContent.trim(),"No starred messages  You can mark any message as 'starred', and it shows up in this mailbox.");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).classList.contains('o-active'),"history mailbox should be active thread");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_empty
        `).length,1,"should have empty thread in starred");assert.strictEqual(document.querySelector(`.o_Discuss_thread .o_MessageList_empty`).textContent.trim(),"No history messages  Messages marked as read will appear in the history.");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).classList.contains('o-active'),"channel 20 should be active thread");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_empty
        `).length,1,"should have empty thread in starred");assert.strictEqual(document.querySelector(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_empty
        `).textContent.trim(),"There are no messages in this conversation.");});QUnit.test('initially load messages from inbox',async function(assert){assert.expect(4);await this.start({async mockRPC(route,args){if(args.method==='message_fetch'){assert.step('message_fetch');assert.strictEqual(args.kwargs.limit,30,"should fetch up to 30 messages");assert.deepEqual(args.kwargs.domain,[["needaction","=",true]],"should fetch needaction messages");}
return this._super(...arguments);},});assert.verifySteps(['message_fetch']);});QUnit.test('default select thread in discuss params',async function(assert){assert.expect(1);await this.start({discuss:{params:{default_active_id:'mail.box_starred',},}});assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"starred mailbox should become active");});QUnit.test('auto-select thread in discuss context',async function(assert){assert.expect(1);await this.start({discuss:{context:{active_id:'mail.box_starred',},},});assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"starred mailbox should become active");});QUnit.test('load single message from channel initially',async function(assert){assert.expect(7);this.data['mail.channel'].records.push({id:20});this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],date:"2019-04-20 10:00:00",id:100,model:'mail.channel',res_id:20,});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},async mockRPC(route,args){if(args.method==='message_fetch'){assert.strictEqual(args.kwargs.limit,30,"should fetch up to 30 messages");assert.deepEqual(args.kwargs.domain,[["channel_ids","in",[20]]],"should fetch messages from channel");}
return this._super(...arguments);},});assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_ThreadView_messageList`).length,1,"should have list of messages");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_separatorDate`).length,1,"should have a single date separator");assert.strictEqual(document.querySelector(`.o_Discuss_thread .o_MessageList_separatorLabelDate`).textContent,"April 20, 2019","should display date day of messages");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_message`).length,1,"should have a single message");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_MessageList_message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
        `).length,1,"should have message with Id 100");});QUnit.test('open channel from active_id as channel id',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20});await this.start({discuss:{context:{active_id:20,},}});assert.containsOnce(document.body,`
            .o_Discuss_thread[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({ id: 20, model: 'mail.channel' }).localId
            }"]
        `,"should have channel with ID 20 open in Discuss when providing active_id 20");});QUnit.test('basic rendering of message',async function(assert){assert.expect(13);this.data['mail.channel'].records.push({id:20});this.data['res.partner'].records.push({id:11,name:"Demo"});this.data['mail.message'].records.push({author_id:11,body:"<p>body</p>",channel_ids:[20],date:"2019-04-20 10:00:00",id:100,model:'mail.channel',res_id:20,});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});const message=document.querySelector(`
        .o_Discuss_thread
        .o_ThreadView_messageList
        .o_MessageList_message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);assert.strictEqual(message.querySelectorAll(`:scope .o_Message_sidebar`).length,1,"should have message sidebar of message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_authorAvatar`).length,1,"should have author avatar in sidebar of message");assert.strictEqual(message.querySelector(`:scope .o_Message_authorAvatar`).dataset.src,"/web/image/res.partner/11/image_128","should have url of message in author avatar sidebar");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_core`).length,1,"should have core part of message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_header`).length,1,"should have header in core part of message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_authorName`).length,1,"should have author name in header of message");assert.strictEqual(message.querySelector(`:scope .o_Message_authorName`).textContent,"Demo","should have textually author name in header of message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_header .o_Message_date`).length,1,"should have date in header of message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_header .o_Message_commands`).length,1,"should have commands in header of message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_header .o_Message_command`).length,1,"should have a single command in header of message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_commandStar`).length,1,"should have command to star message");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_content`).length,1,"should have content in core part of message");assert.strictEqual(message.querySelector(`:scope .o_Message_content`).textContent.trim(),"body","should have body of message in content part of message");});QUnit.test('basic rendering of squashed message',async function(assert){assert.expect(12);this.data['mail.channel'].records.push({id:20});this.data['res.partner'].records.push({id:11});this.data['mail.message'].records.push({author_id:11,body:"<p>body1</p>",channel_ids:[20],date:"2019-04-20 10:00:00",id:100,message_type:'comment',model:'mail.channel',res_id:20,},{author_id:11,body:"<p>body2</p>",channel_ids:[20],date:"2019-04-20 10:00:30",id:101,message_type:'comment',model:'mail.channel',res_id:20,});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,2,"should have 2 messages");const message1=document.querySelector(`
        .o_Discuss_thread
        .o_ThreadView_messageList
        .o_MessageList_message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);const message2=document.querySelector(`
        .o_Discuss_thread
        .o_ThreadView_messageList
        .o_MessageList_message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
        }"]
    `);assert.notOk(message1.classList.contains('o-squashed'),"message 1 should not be squashed");assert.notOk(message1.querySelector(`:scope .o_Message_sidebar`).classList.contains('o-message-squashed'),"message 1 should not have squashed sidebar");assert.ok(message2.classList.contains('o-squashed'),"message 2 should be squashed");assert.ok(message2.querySelector(`:scope .o_Message_sidebar`).classList.contains('o-message-squashed'),"message 2 should have squashed sidebar");assert.strictEqual(message2.querySelectorAll(`:scope .o_Message_sidebar .o_Message_date`).length,1,"message 2 should have date in sidebar");assert.strictEqual(message2.querySelectorAll(`:scope .o_Message_sidebar .o_Message_commands`).length,1,"message 2 should have some commands in sidebar");assert.strictEqual(message2.querySelectorAll(`:scope .o_Message_sidebar .o_Message_commandStar`).length,1,"message 2 should have star command in sidebar");assert.strictEqual(message2.querySelectorAll(`:scope .o_Message_core`).length,1,"message 2 should have core part");assert.strictEqual(message2.querySelectorAll(`:scope .o_Message_header`).length,0,"message 2 should have a header in core part");assert.strictEqual(message2.querySelectorAll(`:scope .o_Message_content`).length,1,"message 2 should have some content in core part");assert.strictEqual(message2.querySelector(`:scope .o_Message_content`).textContent.trim(),"body2","message 2 should have body in content part");});QUnit.test('inbox messages are never squashed',async function(assert){assert.expect(3);this.data['res.partner'].records.push({id:11});this.data['mail.message'].records.push({author_id:11,body:"<p>body1</p>",channel_ids:[20],date:"2019-04-20 10:00:00",id:100,message_type:'comment',model:'mail.channel',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,},{author_id:11,body:"<p>body2</p>",channel_ids:[20],date:"2019-04-20 10:00:30",id:101,message_type:'comment',model:'mail.channel',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:20,});await this.start();assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,2,"should have 2 messages");const message1=document.querySelector(`
        .o_Discuss_thread
        .o_ThreadView_messageList
        .o_MessageList_message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);const message2=document.querySelector(`
        .o_Discuss_thread
        .o_ThreadView_messageList
        .o_MessageList_message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
        }"]
    `);assert.notOk(message1.classList.contains('o-squashed'),"message 1 should not be squashed");assert.notOk(message2.classList.contains('o-squashed'),"message 2 should not be squashed");});QUnit.test('load all messages from channel initially, less than fetch limit (29 < 30)',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:20});this.data['res.partner'].records.push({id:11});for(let i=28;i>=0;i--){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],date:"2019-04-20 10:00:00",model:'mail.channel',res_id:20,});}
await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},async mockRPC(route,args){if(args.method==='message_fetch'){assert.strictEqual(args.kwargs.limit,30,"should fetch up to 30 messages");}
return this._super(...arguments);},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_separatorDate
        `).length,1,"should have a single date separator");assert.strictEqual(document.querySelector(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_separatorLabelDate
        `).textContent,"April 20, 2019","should display date day of messages");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,29,"should have 29 messages");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_loadMore
        `).length,0,"should not have load more link");});QUnit.test('load more messages from channel',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({id:20});this.data['res.partner'].records.push({id:11});for(let i=0;i<40;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],date:"2019-04-20 10:00:00",model:'mail.channel',res_id:20,});}
await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_separatorDate
        `).length,1,"should have a single date separator");assert.strictEqual(document.querySelector(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_separatorLabelDate
        `).textContent,"April 20, 2019","should display date day of messages");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,30,"should have 30 messages");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_loadMore
        `).length,1,"should have load more link");await afterNextRender(()=>document.querySelector(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_loadMore
        `).click());assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,40,"should have 40 messages");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_loadMore
        `).length,0,"should not longer have load more link (all messages loaded)");});QUnit.test('auto-scroll to bottom of thread',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20});for(let i=1;i<=25;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],model:'mail.channel',res_id:20,});}
await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},waitUntilEvent:{eventName:'o-component-message-list-scrolled',message:"should wait until channel 20 scrolled to its last message initially",predicate:({scrollTop,thread})=>{const messageList=document.querySelector('.o_ThreadView_messageList');return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,25,"should have 25 messages");const messageList=document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`);assert.strictEqual(messageList.scrollTop,messageList.scrollHeight-messageList.clientHeight,"should have scrolled to bottom of thread");});QUnit.test('load more messages from channel (auto-load on scroll)',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:20});for(let i=0;i<40;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],model:'mail.channel',res_id:20,});}
await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},waitUntilEvent:{eventName:'o-component-message-list-scrolled',message:"should wait until channel 20 scrolled to its last message initially",predicate:({scrollTop,thread})=>{const messageList=document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`);return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,30,"should have 30 messages");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>document.querySelector('.o_ThreadView_messageList').scrollTop=0,message:"should wait until channel 20 loaded more messages after scrolling to top",predicate:({hint,threadViewer})=>{return(hint.type==='more-messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20);},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,40,"should have 40 messages");assert.strictEqual(document.querySelectorAll(`
            .o_Dsiscuss_thread .o_ThreadView_messageList .o_MessageList_loadMore
        `).length,0,"should not longer have load more link (all messages loaded)");});QUnit.test('new messages separator [REQUIRE FOCUS]',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:11,name:"Foreigner partner",});this.data['res.users'].records.push({id:42,name:"Foreigner user",partner_id:11,});this.data['mail.channel'].records.push({id:20,seen_message_id:125,uuid:'randomuuid',});for(let i=1;i<=25;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],id:100+i,model:'mail.channel',res_id:20,});}
await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},waitUntilEvent:{eventName:'o-component-message-list-scrolled',message:"should wait until channel 20 scrolled to its last message initially",predicate:({scrollTop,thread})=>{const messageList=document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`);return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},},});assert.containsN(document.body,'.o_MessageList_message',25,"should have 25 messages");assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"should not display 'new messages' separator");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`).scrollTop=0;},message:"should wait until channel scrolled to top",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===0);},});document.querySelector('.o_ComposerTextInput_textarea').blur();await afterNextRender(async()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:42,},message_content:"hu",uuid:'randomuuid',},}));assert.containsN(document.body,'.o_MessageList_message',26,"should have 26 messages");assert.containsOnce(document.body,'.o_MessageList_separatorNewMessages',"should display 'new messages' separator");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{const messageList=document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`);messageList.scrollTop=messageList.scrollHeight-messageList.clientHeight;},message:"should wait until channel scrolled to bottom",predicate:({scrollTop,thread})=>{const messageList=document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`);return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});assert.containsOnce(document.body,'.o_MessageList_separatorNewMessages',"should still display 'new messages' separator as composer is not focused");await afterNextRender(()=>document.querySelector('.o_ComposerTextInput_textarea').focus());assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"should no longer display 'new messages' separator (message seen)");});QUnit.test('restore thread scroll position',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({id:11,},{id:12,},);for(let i=1;i<=25;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[11],model:'mail.channel',res_id:11,});}
for(let i=1;i<=24;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[12],model:'mail.channel',res_id:12,});}
await this.start({discuss:{params:{default_active_id:'mail.channel_11',},},waitUntilEvent:{eventName:'o-component-message-list-scrolled',message:"should wait until channel 11 scrolled to its last message",predicate:({thread})=>{return thread&&thread.model==='mail.channel'&&thread.id===11;},},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,25,"should have 25 messages in channel 11");const initialMessageList=document.querySelector(`
        .o_Discuss_thread
        .o_ThreadView_messageList
    `);assert.strictEqual(initialMessageList.scrollTop,initialMessageList.scrollHeight-initialMessageList.clientHeight,"should have scrolled to bottom of channel 11 initially");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`).scrollTop=0,message:"should wait until channel 11 changed its scroll position to top",predicate:({thread})=>{return thread&&thread.model==='mail.channel'&&thread.id===11;},});assert.strictEqual(document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`).scrollTop,0,"should have scrolled to top of channel 11",);await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`
                .o_DiscussSidebar_groupChannel
                .o_DiscussSidebar_item[data-thread-local-id="${
                    this.env.models['mail.thread'].findFromIdentifyingData({
                        id: 12,
                        model: 'mail.channel',
                    }).localId
                }"]
            `).click();},message:"should wait until channel 12 scrolled to its last message",predicate:({scrollTop,thread})=>{const messageList=document.querySelector('.o_ThreadView_messageList');return(thread&&thread.model==='mail.channel'&&thread.id===12&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread .o_ThreadView_messageList .o_MessageList_message
        `).length,24,"should have 24 messages in channel 12");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`
                .o_DiscussSidebar_groupChannel
                .o_DiscussSidebar_item[data-thread-local-id="${
                    this.env.models['mail.thread'].findFromIdentifyingData({
                        id: 11,
                        model: 'mail.channel',
                    }).localId
                }"]
            `).click();},message:"should wait until channel 11 restored its scroll position",predicate:({scrollTop,thread})=>{return(thread&&thread.model==='mail.channel'&&thread.id===11&&scrollTop===0);},});assert.strictEqual(document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`).scrollTop,0,"should have recovered scroll position of channel 11 (scroll to top)");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`
                .o_DiscussSidebar_groupChannel
                .o_DiscussSidebar_item[data-thread-local-id="${
                    this.env.models['mail.thread'].findFromIdentifyingData({
                        id: 12,
                        model: 'mail.channel',
                    }).localId
                }"]
            `).click();},message:"should wait until channel 12 recovered its scroll position (to bottom)",predicate:({scrollTop,thread})=>{const messageList=document.querySelector('.o_ThreadView_messageList');return(thread&&thread.model==='mail.channel'&&thread.id===12&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});const messageList=document.querySelector('.o_ThreadView_messageList');assert.strictEqual(messageList.scrollTop,messageList.scrollHeight-messageList.clientHeight,"should have recovered scroll position of channel 12 (scroll to bottom)");});QUnit.test('message origin redirect to channel',async function(assert){assert.expect(15);this.data['mail.channel'].records.push({id:11},{id:12});this.data['mail.message'].records.push({body:"not empty",channel_ids:[11,12],id:100,model:'mail.channel',record_name:"channel11",res_id:11,},{body:"not empty",channel_ids:[11,12],id:101,model:'mail.channel',record_name:"channel12",res_id:12,});await this.start({discuss:{params:{default_active_id:'mail.channel_11',},},});assert.strictEqual(document.querySelectorAll('.o_Discuss_thread .o_Message').length,2,"should have 2 messages");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
        `).length,1,"should have message1 (Id 100)");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
        `).length,1,"should have message2 (Id 101)");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
            .o_Message_originThread
        `).length,0,"message1 should not have origin part in channel11 (same origin as channel)");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
            .o_Message_originThread
        `).length,1,"message2 should have origin part (origin is channel12 !== channel11)");assert.strictEqual(document.querySelector(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
            .o_Message_originThread
        `).textContent.trim(),"(from #channel12)","message2 should display name of origin channel");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
            .o_Message_originThreadLink
        `).length,1,"message2 should have link to redirect to origin");await afterNextRender(()=>document.querySelector(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
            .o_Message_originThreadLink
        `).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_groupChannel
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 12,
                    model: 'mail.channel',
                }).localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"channel12 should be active channel on redirect from discuss app");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_Message`).length,2,"should have 2 messages");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
        `).length,1,"should have message1 (Id 100)");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
        `).length,1,"should have message2 (Id 101)");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
            .o_Message_originThread
        `).length,1,"message1 should have origin thread part (= channel11 !== channel12)");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
            .o_Message_originThread
        `).length,0,"message2 should not have origin thread part in channel12 (same as current channel)");assert.strictEqual(document.querySelector(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
            .o_Message_originThread
        `).textContent.trim(),"(from #channel11)","message1 should display name of origin channel");assert.strictEqual(document.querySelectorAll(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
            .o_Message_originThreadLink
        `).length,1,"message1 should have link to redirect to origin channel");});QUnit.test('redirect to author (open chat)',async function(assert){assert.expect(7);this.data['res.partner'].records.push({id:7,name:"Demo"});this.data['res.users'].records.push({partner_id:7});this.data['mail.channel'].records.push({id:1,name:"General",},{channel_type:'chat',id:10,members:[this.data.currentPartnerId,7],public:'private',});this.data['mail.message'].records.push({author_id:7,body:"not empty",channel_ids:[1],id:100,model:'mail.channel',res_id:1,});await this.start({discuss:{params:{default_active_id:'mail.channel_1',},},});assert.ok(document.querySelector(`
            .o_DiscussSidebar_groupChannel
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 1,
                    model: 'mail.channel',
                }).localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"channel 'General' should be active");assert.notOk(document.querySelector(`
            .o_DiscussSidebar_groupChat
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"Chat 'Demo' should not be active");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_Message`).length,1,"should have 1 message");const msg1=document.querySelector(`
        .o_Discuss_thread
        .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
        }"]
    `);assert.strictEqual(msg1.querySelectorAll(`:scope .o_Message_authorAvatar`).length,1,"message1 should have author image");assert.ok(msg1.querySelector(`:scope .o_Message_authorAvatar`).classList.contains('o_redirect'),"message1 should have redirect to author");await afterNextRender(()=>msg1.querySelector(`:scope .o_Message_authorAvatar`).click());assert.notOk(document.querySelector(`
            .o_DiscussSidebar_groupChannel
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 1,
                    model: 'mail.channel',
                }).localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"channel 'General' should become inactive after author redirection");assert.ok(document.querySelector(`
            .o_DiscussSidebar_groupChat
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
            .o_DiscussSidebarItem_activeIndicator
        `).classList.contains('o-item-active'),"chat 'Demo' should become active after author redirection");});QUnit.test('sidebar quick search',async function(assert){assert.expect(6);for(let id=1;id<=20;id++){this.data['mail.channel'].records.push({id,name:`channel${id}`});}
await this.start();assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).length,20,"should have 20 channel items");assert.strictEqual(document.querySelectorAll(`.o_Discuss_sidebar input.o_DiscussSidebar_quickSearch`).length,1,"should have quick search in sidebar");const quickSearch=document.querySelector(`
        .o_Discuss_sidebar input.o_DiscussSidebar_quickSearch
    `);await afterNextRender(()=>{quickSearch.value="1";const kevt1=new window.KeyboardEvent('input');quickSearch.dispatchEvent(kevt1);});assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).length,11,"should have filtered to 11 channel items");await afterNextRender(()=>{quickSearch.value="12";const kevt2=new window.KeyboardEvent('input');quickSearch.dispatchEvent(kevt2);});assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).length,1,"should have filtered to a single channel item");assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_groupChannel .o_DiscussSidebar_item
        `).dataset.threadLocalId,this.env.models['mail.thread'].findFromIdentifyingData({id:12,model:'mail.channel',}).localId,"should have filtered to a single channel item with Id 12");await afterNextRender(()=>{quickSearch.value="123";const kevt3=new window.KeyboardEvent('input');quickSearch.dispatchEvent(kevt3);});assert.strictEqual(document.querySelectorAll(`.o_DiscussSidebar_groupChannel .o_DiscussSidebar_item`).length,0,"should have filtered to no channel item");});QUnit.test('basic control panel rendering',async function(assert){assert.expect(8);this.data['mail.channel'].records.push({id:20,name:"General"});await this.start();assert.strictEqual(document.querySelector(`
            .o_widget_Discuss .o_control_panel .breadcrumb
        `).textContent,"Inbox","display inbox in the breadcrumb");const markAllReadButton=document.querySelector(`.o_widget_Discuss_controlPanelButtonMarkAllRead`);assert.isVisible(markAllReadButton,"should have visible button 'Mark all read' in the control panel of inbox");assert.ok(markAllReadButton.disabled,"should have disabled button 'Mark all read' in the control panel of inbox (no messages)");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
        `).click());assert.strictEqual(document.querySelector(`
            .o_widget_Discuss .o_control_panel .breadcrumb
        `).textContent,"Starred","display starred in the breadcrumb");const unstarAllButton=document.querySelector(`.o_widget_Discuss_controlPanelButtonUnstarAll`);assert.isVisible(unstarAllButton,"should have visible button 'Unstar all' in the control panel of starred");assert.ok(unstarAllButton.disabled,"should have disabled button 'Unstar all' in the control panel of starred (no messages)");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).click());assert.strictEqual(document.querySelector(`
            .o_widget_Discuss .o_control_panel .breadcrumb
        `).textContent,"#General","display general in the breadcrumb");const inviteButton=document.querySelector(`.o_widget_Discuss_controlPanelButtonInvite`);assert.isVisible(inviteButton,"should have visible button 'Invite' in the control panel of channel");});QUnit.test('inbox: mark all messages as read',async function(assert){assert.expect(8);this.data['mail.channel'].records.push({id:20});this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],id:100,needaction:true,},{body:"not empty",channel_ids:[20],id:101,needaction:true,});this.data['mail.notification'].records.push({mail_message_id:100,res_partner_id:this.data.currentPartnerId,},{mail_message_id:101,res_partner_id:this.data.currentPartnerId,});await this.start();assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).textContent,"2","inbox should have counter of 2");assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
            .o_DiscussSidebarItem_counter
        `).textContent,"2","channel should have counter of 2");assert.strictEqual(document.querySelectorAll(`.o_Discuss .o_Message`).length,2,"should have 2 messages in inbox");let markAllReadButton=document.querySelector(`.o_widget_Discuss_controlPanelButtonMarkAllRead`);assert.notOk(markAllReadButton.disabled,"should have enabled button 'Mark all read' in the control panel of inbox (has messages)");await afterNextRender(()=>markAllReadButton.click());assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).length,0,"inbox should display no counter (= 0)");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
            .o_DiscussSidebarItem_counter
        `).length,0,"channel should display no counter (= 0)");assert.strictEqual(document.querySelectorAll(`.o_Discuss .o_Message`).length,0,"should have no message in inbox");markAllReadButton=document.querySelector(`.o_widget_Discuss_controlPanelButtonMarkAllRead`);assert.ok(markAllReadButton.disabled,"should have disabled button 'Mark all read' in the control panel of inbox (no messages)");});QUnit.test('starred: unstar all',async function(assert){assert.expect(6);this.data['mail.message'].records.push({body:"not empty",starred_partner_ids:[this.data.currentPartnerId]},{body:"not empty",starred_partner_ids:[this.data.currentPartnerId]});await this.start({discuss:{params:{default_active_id:'mail.box_starred',},},});assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).textContent,"2","starred should have counter of 2");assert.strictEqual(document.querySelectorAll(`.o_Discuss .o_Message`).length,2,"should have 2 messages in starred");let unstarAllButton=document.querySelector(`.o_widget_Discuss_controlPanelButtonUnstarAll`);assert.notOk(unstarAllButton.disabled,"should have enabled button 'Unstar all' in the control panel of starred (has messages)");await afterNextRender(()=>unstarAllButton.click());assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).length,0,"starred should display no counter (= 0)");assert.strictEqual(document.querySelectorAll(`.o_Discuss .o_Message`).length,0,"should have no message in starred");unstarAllButton=document.querySelector(`.o_widget_Discuss_controlPanelButtonUnstarAll`);assert.ok(unstarAllButton.disabled,"should have disabled button 'Unstar all' in the control panel of starred (no messages)");});QUnit.test('toggle_star message',async function(assert){assert.expect(16);this.data['mail.channel'].records.push({id:20});this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],id:100,model:'mail.channel',res_id:20,});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},async mockRPC(route,args){if(args.method==='toggle_message_starred'){assert.step('rpc:toggle_message_starred');assert.strictEqual(args.args[0][0],100,"should have message Id in args");}
return this._super(...arguments);},});assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).length,0,"starred should display no counter (= 0)");assert.strictEqual(document.querySelectorAll(`.o_Discuss .o_Message`).length,1,"should have 1 message in channel");let message=document.querySelector(`.o_Discuss .o_Message`);assert.notOk(message.classList.contains('o-starred'),"message should not be starred");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_commandStar`).length,1,"message should have star command");await afterNextRender(()=>message.querySelector(`:scope .o_Message_commandStar`).click());assert.verifySteps(['rpc:toggle_message_starred']);assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).textContent,"1","starred should display a counter of 1");assert.strictEqual(document.querySelectorAll(`.o_Discuss .o_Message`).length,1,"should have kept 1 message in channel");message=document.querySelector(`.o_Discuss .o_Message`);assert.ok(message.classList.contains('o-starred'),"message should be starred");await afterNextRender(()=>message.querySelector(`:scope .o_Message_commandStar`).click());assert.verifySteps(['rpc:toggle_message_starred']);assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.starred.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).length,0,"starred should no longer display a counter (= 0)");assert.strictEqual(document.querySelectorAll(`.o_Discuss .o_Message`).length,1,"should still have 1 message in channel");message=document.querySelector(`.o_Discuss .o_Message`);assert.notOk(message.classList.contains('o-starred'),"message should no longer be starred");});QUnit.test('composer state: text save and restore',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20,name:"General"},{id:21,name:"Special"});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"A message");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('input'));});await afterNextRender(()=>document.querySelector(`.o_DiscussSidebarItem[data-thread-name="Special"]`).click());await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"An other message");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('input'));});await afterNextRender(()=>document.querySelector(`.o_DiscussSidebarItem[data-thread-name="General"]`).click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"A message","should restore the input text");await afterNextRender(()=>document.querySelector(`.o_DiscussSidebarItem[data-thread-name="Special"]`).click());assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"An other message","should restore the input text");});QUnit.test('composer state: attachments save and restore',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({id:20,name:"General"},{id:21,name:"Special"});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});const channels=document.querySelectorAll(`
        .o_DiscussSidebar_groupChannel .o_DiscussSidebar_item
    `);await afterNextRender(async()=>{const file=await createFile({content:'hello, world',contentType:'text/plain',name:'text.txt',});inputFiles(document.querySelector('.o_FileUploader_input'),[file]);});await afterNextRender(()=>channels[1].click());const files=[await createFile({content:'hello2, world',contentType:'text/plain',name:'text2.txt',}),await createFile({content:'hello3, world',contentType:'text/plain',name:'text3.txt',}),await createFile({content:'hello4, world',contentType:'text/plain',name:'text4.txt',}),];await afterNextRender(()=>inputFiles(document.querySelector('.o_FileUploader_input'),files));await afterNextRender(()=>channels[0].click());assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`).length,1,"should have 1 attachment in the composer");assert.strictEqual(document.querySelector(`.o_Composer .o_Attachment`).dataset.attachmentLocalId,this.env.models['mail.attachment'].findFromIdentifyingData({id:1}).localId,"should have correct 1st attachment in the composer");await afterNextRender(()=>channels[1].click());assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`).length,3,"should have 3 attachments in the composer");assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`)[0].dataset.attachmentLocalId,this.env.models['mail.attachment'].findFromIdentifyingData({id:2}).localId,"should have attachment with id 2 as 1st attachment");assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`)[1].dataset.attachmentLocalId,this.env.models['mail.attachment'].findFromIdentifyingData({id:3}).localId,"should have attachment with id 3 as 2nd attachment");assert.strictEqual(document.querySelectorAll(`.o_Composer .o_Attachment`)[2].dataset.attachmentLocalId,this.env.models['mail.attachment'].findFromIdentifyingData({id:4}).localId,"should have attachment with id 4 as 3rd attachment");});QUnit.test('post a simple message',async function(assert){assert.expect(15);this.data['mail.channel'].records.push({id:20});let postedMessageId;await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},async mockRPC(route,args){const res=await this._super(...arguments);if(args.method==='message_post'){assert.step('message_post');assert.strictEqual(args.args[0],20,"should post message to channel Id 20");assert.strictEqual(args.kwargs.body,"Test","should post with provided content in composer input");assert.strictEqual(args.kwargs.message_type,"comment","should set message type as 'comment'");assert.strictEqual(args.kwargs.subtype_xmlid,"mail.mt_comment","should set subtype_xmlid as 'comment'");postedMessageId=res;}
return res;},});assert.strictEqual(document.querySelectorAll(`.o_MessageList_empty`).length,1,"should display thread with no message initially");assert.strictEqual(document.querySelectorAll(`.o_Message`).length,0,"should display no message initially");assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","should have empty content initially");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"Test","should have inserted text in editable");await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.verifySteps(['message_post']);assert.strictEqual(document.querySelector(`.o_ComposerTextInput_textarea`).value,"","should have no content in composer input after posting message");assert.strictEqual(document.querySelectorAll(`.o_Message`).length,1,"should display a message after posting message");const message=document.querySelector(`.o_Message`);assert.strictEqual(message.dataset.messageLocalId,this.env.models['mail.message'].findFromIdentifyingData({id:postedMessageId}).localId,"new message in thread should be linked to newly created message from message post");assert.strictEqual(message.querySelector(`:scope .o_Message_authorName`).textContent,"Mitchell Admin","new message in thread should be from current partner name");assert.strictEqual(message.querySelector(`:scope .o_Message_content`).textContent,"Test","new message in thread should have content typed from composer text input");});QUnit.test('post message on non-mailing channel with "Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20,mass_mailing:false});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});assert.containsNone(document.body,'.o_Message',"should not have any message initially in channel");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});await afterNextRender(()=>{const kevt=new window.KeyboardEvent('keydown',{key:"Enter"});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);});assert.containsOnce(document.body,'.o_Message',"should now have single message in channel after posting message from pressing 'Enter' in text input of composer");});QUnit.test('do not post message on non-mailing channel with "SHIFT-Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20,mass_mailing:true});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});assert.containsNone(document.body,'.o_Message',"should not have any message initially in channel");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});const kevt=new window.KeyboardEvent('keydown',{key:"Enter",shiftKey:true});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);await nextAnimationFrame();assert.containsNone(document.body,'.o_Message',"should still not have any message in channel after pressing 'Shift-Enter' in text input of composer");});QUnit.test('post message on mailing channel with "CTRL-Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20,mass_mailing:true});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});assert.containsNone(document.body,'.o_Message',"should not have any message initially in channel");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});await afterNextRender(()=>{const kevt=new window.KeyboardEvent('keydown',{ctrlKey:true,key:"Enter"});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);});assert.containsOnce(document.body,'.o_Message',"should now have single message in channel after posting message from pressing 'CTRL-Enter' in text input of composer");});QUnit.test('post message on mailing channel with "META-Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20,mass_mailing:true});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});assert.containsNone(document.body,'.o_Message',"should not have any message initially in channel");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});await afterNextRender(()=>{const kevt=new window.KeyboardEvent('keydown',{key:"Enter",metaKey:true});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);});assert.containsOnce(document.body,'.o_Message',"should now have single message in channel after posting message from pressing 'META-Enter' in text input of composer");});QUnit.test('do not post message on mailing channel with "Enter" keyboard shortcut',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:20,mass_mailing:true});await this.start({discuss:{params:{default_active_id:'mail.channel_20',},},});assert.containsNone(document.body,'.o_Message',"should not have any message initially in mailing channel");await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"Test");});const kevt=new window.KeyboardEvent('keydown',{key:"Enter"});document.querySelector('.o_ComposerTextInput_textarea').dispatchEvent(kevt);await nextAnimationFrame();assert.containsNone(document.body,'.o_Message',"should still not have any message in mailing channel after pressing 'Enter' in text input of composer");});QUnit.test('rendering of inbox message',async function(assert){assert.expect(7);this.data['mail.message'].records.push({body:"not empty",model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],record_name:'Refactoring',res_id:20,});await this.start();assert.strictEqual(document.querySelectorAll('.o_Message').length,1,"should display a message");const message=document.querySelector('.o_Message');assert.strictEqual(message.querySelectorAll(`:scope .o_Message_originThread`).length,1,"should display origin thread of message");assert.strictEqual(message.querySelector(`:scope .o_Message_originThread`).textContent," on Refactoring","should display origin thread name");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_command`).length,3,"should display 3 commands");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_commandStar`).length,1,"should display star command");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_commandReply`).length,1,"should display reply command");assert.strictEqual(message.querySelectorAll(`:scope .o_Message_commandMarkAsRead`).length,1,"should display mark as read command");});QUnit.test('mark channel as seen on last message visible [REQUIRE FOCUS]',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:10,message_unread_counter:1});this.data['mail.message'].records.push({id:12,body:"not empty",channel_ids:[10],model:'mail.channel',res_id:10,});await this.start();assert.containsOnce(document.body,`.o_DiscussSidebar_item[data-thread-local-id="${
            this.env.models['mail.thread'].findFromIdentifyingData({
                id: 10,
                model: 'mail.channel',
            }).localId
        }"]`,"should have discuss sidebar item with the channel");assert.hasClass(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `),'o-unread',"sidebar item of channel ID 10 should be unread");await afterNextRender(()=>this.afterEvent({eventName:'o-thread-last-seen-by-current-partner-message-id-changed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${
                    this.env.models['mail.thread'].findFromIdentifyingData({
                        id: 10,
                        model: 'mail.channel',
                    }).localId
                }"]
            `).click();},message:"should wait until last seen by current partner message id changed",predicate:({thread})=>{return(thread.id===10&&thread.model==='mail.channel'&&thread.lastSeenByCurrentPartnerMessageId===12);},}));assert.doesNotHaveClass(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `),'o-unread',"sidebar item of channel ID 10 should not longer be unread");});QUnit.test('receive new needaction messages',async function(assert){assert.expect(12);await this.start();assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `),"should have inbox in sidebar");assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).classList.contains('o-active'),"inbox should be current discuss thread");assert.notOk(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `),"inbox item in sidebar should not have any counter");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_Message`).length,0,"should have no messages in inbox initially");await afterNextRender(()=>{const data={body:"not empty",id:100,needaction_partner_ids:[3],model:'res.partner',res_id:20,};const notifications=[[['my-db','ir.needaction',3],data]];this.widget.call('bus_service','trigger','notification',notifications);});assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `),"inbox item in sidebar should now have counter");assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).textContent,'1',"inbox item in sidebar should have counter of '1'");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_Message`).length,1,"should have one message in inbox");assert.strictEqual(document.querySelector(`.o_Discuss_thread .o_Message`).dataset.messageLocalId,this.env.models['mail.message'].findFromIdentifyingData({id:100}).localId,"should display newly received needaction message");await afterNextRender(()=>{const data2={body:"not empty",id:101,needaction_partner_ids:[3],model:'res.partner',res_id:20,};const notifications2=[[['my-db','ir.needaction',3],data2]];this.widget.call('bus_service','trigger','notification',notifications2);});assert.strictEqual(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
            .o_DiscussSidebarItem_counter
        `).textContent,'2',"inbox item in sidebar should have counter of '2'");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_Message`).length,2,"should have 2 messages in inbox");assert.ok(document.querySelector(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
        `),"should still display 1st needaction message");assert.ok(document.querySelector(`
            .o_Discuss_thread
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 101 }).localId
            }"]
        `),"should display 2nd needaction message");});QUnit.test('reply to message from inbox (message linked to document)',async function(assert){assert.expect(19);this.data['mail.message'].records.push({body:"<p>Test</p>",date:"2019-04-20 11:00:00",id:100,message_type:'comment',needaction:true,model:'res.partner',record_name:'Refactoring',res_id:20,});this.data['mail.notification'].records.push({mail_message_id:100,res_partner_id:this.data.currentPartnerId,});await this.start({async mockRPC(route,args){if(args.method==='message_post'){assert.step('message_post');assert.strictEqual(args.model,'res.partner',"should post message to record with model 'res.partner'");assert.strictEqual(args.args[0],20,"should post message to record with Id 20");assert.strictEqual(args.kwargs.body,"Test","should post with provided content in composer input");assert.strictEqual(args.kwargs.message_type,"comment","should set message type as 'comment'");}
return this._super(...arguments);},});assert.strictEqual(document.querySelectorAll('.o_Message').length,1,"should display a single message");assert.strictEqual(document.querySelector('.o_Message').dataset.messageLocalId,this.env.models['mail.message'].findFromIdentifyingData({id:100}).localId,"should display message with ID 100");assert.strictEqual(document.querySelector('.o_Message_originThread').textContent," on Refactoring","should display message originates from record 'Refactoring'");await afterNextRender(()=>document.querySelector('.o_Message_commandReply').click());assert.ok(document.querySelector('.o_Message').classList.contains('o-selected'),"message should be selected after clicking on reply icon");assert.ok(document.querySelector('.o_Composer'),"should have composer after clicking on reply to message");assert.strictEqual(document.querySelector(`.o_Composer_threadName`).textContent," on: Refactoring","composer should display origin thread name of message");assert.strictEqual(document.activeElement,document.querySelector(`.o_ComposerTextInput_textarea`),"composer text input should be auto-focus");await afterNextRender(()=>document.execCommand('insertText',false,"Test"));await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.verifySteps(['message_post']);assert.notOk(document.querySelector('.o_Composer'),"should no longer have composer after posting reply to message");assert.strictEqual(document.querySelectorAll('.o_Message').length,1,"should still display a single message after posting reply");assert.strictEqual(document.querySelector('.o_Message').dataset.messageLocalId,this.env.models['mail.message'].findFromIdentifyingData({id:100}).localId,"should still display message with ID 100 after posting reply");assert.notOk(document.querySelector('.o_Message').classList.contains('o-selected'),"message should not longer be selected after posting reply");assert.ok(document.querySelector('.o_notification'),"should display a notification after posting reply");assert.strictEqual(document.querySelector('.o_notification_content').textContent,"Message posted on \"Refactoring\"","notification should tell that message has been posted to the record 'Refactoring'");});QUnit.test('load recent messages from thread (already loaded some old messages)',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({id:20});for(let i=0;i<50;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],id:100+i,model:'mail.channel',needaction:i===0,needaction_partner_ids:i===0?[this.data.currentPartnerId]:[],res_id:20,});}
await this.start();assert.strictEqual(document.querySelectorAll('.o_Message').length,1,"Inbox should have a single message initially");assert.strictEqual(document.querySelector('.o_Message').dataset.messageLocalId,this.env.models['mail.message'].findFromIdentifyingData({id:100}).localId,"the only message initially should be the one marked as 'needaction'");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${
                    this.env.models['mail.thread'].findFromIdentifyingData({
                        id: 20,
                        model: 'mail.channel',
                    }).localId
                }"]
            `).click();},message:"should wait until channel scrolled to bottom after opening it from the discuss sidebar",predicate:({scrollTop,thread})=>{const messageList=document.querySelector('.o_ThreadView_messageList');return(thread&&thread.model==='mail.channel'&&thread.id===20&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});assert.strictEqual(document.querySelectorAll('.o_Message').length,31,`should display 31 messages inside the channel after clicking on it (the previously known
        message from Inbox and the 30 most recent messages that have been fetched)`);assert.strictEqual(document.querySelectorAll(`
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
        `).length,1,"should display the message from Inbox inside the channel too");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>document.querySelector('.o_Discuss_thread .o_ThreadView_messageList').scrollTop=0,message:"should wait until channel 20 loaded more messages after scrolling to top",predicate:({hint,threadViewer})=>{return(hint.type==='more-messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===20);},});assert.strictEqual(document.querySelectorAll('.o_Message').length,50,"should display 50 messages inside the channel after scrolling to load more (all messages fetched)");assert.strictEqual(document.querySelectorAll(`
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 100 }).localId
            }"]
        `).length,1,"should still display the message from Inbox inside the channel too");});QUnit.test('messages marked as read move to "History" mailbox',async function(assert){assert.expect(10);this.data['mail.channel'].records.push({id:20});this.data['mail.message'].records.push({body:"not empty",id:100,model:'mail.channel',needaction:true,res_id:20,},{body:"not empty",id:101,model:'mail.channel',needaction:true,res_id:20,});this.data['mail.notification'].records.push({mail_message_id:100,res_partner_id:this.data.currentPartnerId,},{mail_message_id:101,res_partner_id:this.data.currentPartnerId,});await this.start({discuss:{params:{default_active_id:'mail.box_history',},},});assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).classList.contains('o-active'),"history mailbox should be active thread");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_empty`).length,1,"should have empty thread in history");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).classList.contains('o-active'),"inbox mailbox should be active thread");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_empty`).length,0,"inbox mailbox should not be empty");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_message`).length,2,"inbox mailbox should have 2 messages");await afterNextRender(()=>document.querySelector('.o_widget_Discuss_controlPanelButtonMarkAllRead').click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).classList.contains('o-active'),"inbox mailbox should still be active after mark as read");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_empty`).length,1,"inbox mailbox should now be empty after mark as read");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).classList.contains('o-active'),"history mailbox should be active");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_empty`).length,0,"history mailbox should not be empty after mark as read");assert.strictEqual(document.querySelectorAll(`.o_Discuss_thread .o_MessageList_message`).length,2,"history mailbox should have 2 messages");});QUnit.test('mark a single message as read should only move this message to "History" mailbox',async function(assert){assert.expect(9);this.data['mail.message'].records.push({body:"not empty",id:1,needaction:true,needaction_partner_ids:[this.data.currentPartnerId],},{body:"not empty",id:2,needaction:true,needaction_partner_ids:[this.data.currentPartnerId],});this.data['mail.notification'].records.push({mail_message_id:1,res_partner_id:this.data.currentPartnerId,},{mail_message_id:2,res_partner_id:this.data.currentPartnerId,});await this.start({discuss:{params:{default_active_id:'mail.box_history',},},});assert.hasClass(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `),'o-active',"history mailbox should initially be the active thread");assert.containsOnce(document.body,'.o_MessageList_empty',"history mailbox should initially be empty");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `).click());assert.hasClass(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.inbox.localId
            }"]
        `),'o-active',"inbox mailbox should be active thread after clicking on it");assert.containsN(document.body,'.o_Message',2,"inbox mailbox should have 2 messages");await afterNextRender(()=>document.querySelector(`
            .o_Message[data-message-local-id="${
                this.env.models['mail.message'].findFromIdentifyingData({ id: 1 }).localId
            }"] .o_Message_commandMarkAsRead
        `).click());assert.containsOnce(document.body,'.o_Message',"inbox mailbox should have one less message after clicking mark as read");assert.containsOnce(document.body,`.o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 2 }).localId
        }"]`,"message still in inbox should be the one not marked as read");await afterNextRender(()=>document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `).click());assert.hasClass(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.messaging.history.localId
            }"]
        `),'o-active',"history mailbox should be active after clicking on it");assert.containsOnce(document.body,'.o_Message',"history mailbox should have only 1 message after mark as read");assert.containsOnce(document.body,`.o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 1 }).localId
        }"]`,"message moved in history should be the one marked as read");});QUnit.test('all messages in "Inbox" in "History" after marked all as read',async function(assert){assert.expect(2);const messageOffset=200;for(let id=messageOffset;id<messageOffset+40;id++){this.data['mail.message'].records.push({body:"not empty",id,needaction:true,});this.data['mail.notification'].records.push({mail_message_id:id,res_partner_id:this.data.currentPartnerId,});}
await this.start({waitUntilEvent:{eventName:'o-component-message-list-scrolled',message:"should wait until inbox scrolled to its last message initially",predicate:({orderedMessages,scrollTop,thread})=>{const messageList=document.querySelector(`.o_Discuss_thread .o_ThreadView_messageList`);return(thread&&thread.model==='mail.box'&&thread.id==='inbox'&&orderedMessages.length===30&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},},});await afterNextRender(async()=>{const markAllReadButton=document.querySelector('.o_widget_Discuss_controlPanelButtonMarkAllRead');markAllReadButton.click();});assert.containsNone(document.body,'.o_Message',"there should no message in Inbox anymore");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>{document.querySelector(`
                .o_DiscussSidebarItem[data-thread-local-id="${
                    this.env.messaging.history.localId
                }"]
            `).click();},message:"should wait until history scrolled to its last message after opening it from the discuss sidebar",predicate:({orderedMessages,scrollTop,thread})=>{const messageList=document.querySelector('.o_MessageList');return(thread&&thread.model==='mail.box'&&thread.id==='history'&&orderedMessages.length===30&&scrollTop===messageList.scrollHeight-messageList.clientHeight);},});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>document.querySelector('.o_MessageList').scrollTop=0,message:"should wait until mailbox history loaded more messages after scrolling to top",predicate:({hint,threadViewer})=>{return(hint.type==='more-messages-loaded'&&threadViewer.thread.model==='mail.box'&&threadViewer.thread.id==='history');},});assert.containsN(document.body,'.o_Message',40,"there should be 40 messages in History");});QUnit.test('receive new chat message: out of odoo focus (notification, channel)',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20,channel_type:'chat'});const bus=new Bus();bus.on('set_title_part',null,payload=>{assert.step('set_title_part');assert.strictEqual(payload.part,'_chat');assert.strictEqual(payload.title,"1 Message");});await this.start({env:{bus},services:{bus_service:BusService.extend({_beep(){},_poll(){},_registerWindowUnload(){},isOdooFocused:()=>false,updateOption(){},}),},});await afterNextRender(()=>{const messageData={channel_ids:[20],id:126,model:'mail.channel',res_id:20,};const notifications=[[['my-db','mail.channel',20],messageData]];this.widget.call('bus_service','trigger','notification',notifications);});assert.verifySteps(['set_title_part']);});QUnit.test('receive new chat message: out of odoo focus (notification, chat)',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({channel_type:"chat",id:10});const bus=new Bus();bus.on('set_title_part',null,payload=>{assert.step('set_title_part');assert.strictEqual(payload.part,'_chat');assert.strictEqual(payload.title,"1 Message");});await this.start({env:{bus},services:{bus_service:BusService.extend({_beep(){},_poll(){},_registerWindowUnload(){},isOdooFocused:()=>false,updateOption(){},}),},});await afterNextRender(()=>{const messageData={channel_ids:[10],id:126,model:'mail.channel',res_id:10,};const notifications=[[['my-db','mail.channel',10],messageData]];this.widget.call('bus_service','trigger','notification',notifications);});assert.verifySteps(['set_title_part']);});QUnit.test('receive new chat messages: out of odoo focus (tab title)',async function(assert){assert.expect(12);let step=0;this.data['mail.channel'].records.push({channel_type:'chat',id:20,public:'private'},{channel_type:'chat',id:10,public:'private'},);const bus=new Bus();bus.on('set_title_part',null,payload=>{step++;assert.step('set_title_part');assert.strictEqual(payload.part,'_chat');if(step===1){assert.strictEqual(payload.title,"1 Message");}
if(step===2){assert.strictEqual(payload.title,"2 Messages");}
if(step===3){assert.strictEqual(payload.title,"3 Messages");}});await this.start({env:{bus},services:{bus_service:BusService.extend({_beep(){},_poll(){},_registerWindowUnload(){},isOdooFocused:()=>false,updateOption(){},}),},});await afterNextRender(()=>{const messageData1={channel_ids:[20],id:126,model:'mail.channel',res_id:20,};const notifications1=[[['my-db','mail.channel',20],messageData1]];this.widget.call('bus_service','trigger','notification',notifications1);});assert.verifySteps(['set_title_part']);await afterNextRender(()=>{const messageData2={channel_ids:[10],id:127,model:'mail.channel',res_id:10,};const notifications2=[[['my-db','mail.channel',10],messageData2]];this.widget.call('bus_service','trigger','notification',notifications2);});assert.verifySteps(['set_title_part']);await afterNextRender(()=>{const messageData3={channel_ids:[10],id:128,model:'mail.channel',res_id:10,};const notifications3=[[['my-db','mail.channel',10],messageData3]];this.widget.call('bus_service','trigger','notification',notifications3);});assert.verifySteps(['set_title_part']);});QUnit.test('auto-focus composer on opening thread',async function(assert){assert.expect(14);this.data['res.partner'].records.push({id:7,name:"Demo User"});this.data['mail.channel'].records.push({id:20,name:"General",},{channel_type:'chat',id:10,members:[this.data.currentPartnerId,7],public:'private',});await this.start();assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-name="Inbox"]
        `).length,1,"should have mailbox 'Inbox' in the sidebar");assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-name="Inbox"]
        `).classList.contains('o-active'),"mailbox 'Inbox' should be active initially");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-name="General"]
        `).length,1,"should have channel 'General' in the sidebar");assert.notOk(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-name="General"]
        `).classList.contains('o-active'),"channel 'General' should not be active initially");assert.strictEqual(document.querySelectorAll(`
            .o_DiscussSidebar_item[data-thread-name="Demo User"]
        `).length,1,"should have chat 'Demo User' in the sidebar");assert.notOk(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-name="Demo User"]
        `).classList.contains('o-active'),"chat 'Demo User' should not be active initially");assert.strictEqual(document.querySelectorAll(`.o_Composer`).length,0,"there should be no composer when active thread of discuss is mailbox 'Inbox'");await afterNextRender(()=>document.querySelector(`.o_DiscussSidebar_item[data-thread-name="General"]`).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-name="General"]
        `).classList.contains('o-active'),"channel 'General' should become active after selecting it from the sidebar");assert.strictEqual(document.querySelectorAll(`.o_Composer`).length,1,"there should be a composer when active thread of discuss is channel 'General'");assert.strictEqual(document.activeElement,document.querySelector(`.o_ComposerTextInput_textarea`),"composer of channel 'General' should be automatically focused on opening");document.querySelector(`.o_ComposerTextInput_textarea`).blur();assert.notOk(document.activeElement===document.querySelector(`.o_ComposerTextInput_textarea`),"composer of channel 'General' should no longer focused on click away");await afterNextRender(()=>document.querySelector(`.o_DiscussSidebar_item[data-thread-name="Demo User"]`).click());assert.ok(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-name="Demo User"]
        `).classList.contains('o-active'),"chat 'Demo User' should become active after selecting it from the sidebar");assert.strictEqual(document.querySelectorAll(`.o_Composer`).length,1,"there should be a composer when active thread of discuss is chat 'Demo User'");assert.strictEqual(document.activeElement,document.querySelector(`.o_ComposerTextInput_textarea`),"composer of chat 'Demo User' should be automatically focused on opening");});QUnit.test('mark channel as seen if last message is visible when switching channels when the previous channel had a more recent last message than the current channel [REQUIRE FOCUS]',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:10,message_unread_counter:1,name:'Bla'},{id:11,message_unread_counter:1,name:'Blu'},);this.data['mail.message'].records.push({body:'oldest message',channel_ids:[10],id:10,},{body:'newest message',channel_ids:[11],id:11,});await this.start({discuss:{context:{active_id:'mail.channel_11',},},waitUntilEvent:{eventName:'o-thread-view-hint-processed',message:"should wait until channel 11 loaded its messages initially",predicate:({hint,threadViewer})=>{return(threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11&&hint.type==='messages-loaded');},},});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-last-seen-by-current-partner-message-id-changed',func:()=>{document.querySelector(`
                .o_DiscussSidebar_item[data-thread-local-id="${
                    this.env.models['mail.thread'].findFromIdentifyingData({
                        id: 10,
                        model: 'mail.channel',
                    }).localId
                }"]
            `).click();},message:"should wait until last seen by current partner message id changed",predicate:({thread})=>{return(thread.id===10&&thread.model==='mail.channel'&&thread.lastSeenByCurrentPartnerMessageId===10);},}));assert.doesNotHaveClass(document.querySelector(`
            .o_DiscussSidebar_item[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `),'o-unread',"sidebar item of channel ID 10 should no longer be unread");});QUnit.test('add custom filter should filter messages accordingly to selected filter',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:20,name:"General"});await this.start({async mockRPC(route,args){if(args.method==='message_fetch'){const domainsAsStr=args.kwargs.domain.map(domain=>domain.join(''));assert.step(`message_fetch:${domainsAsStr.join(',')}`);}
return this._super(...arguments);},});assert.verifySteps(['message_fetch:needaction=true'],"A message_fetch request should have been done for needaction messages as inbox is selected by default");await toggleFilterMenu(document.body);await toggleAddCustomFilter(document.body);await applyFilter(document.body);assert.verifySteps(['message_fetch:id=0,needaction=true'],"A message_fetch request should have been done for selected filter & domain of current thread (inbox)");});});});});});;

/* /mail/static/src/components/file_uploader/file_uploader_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/file_uploader/file_uploader_tests.js',function(require){"use strict";const components={FileUploader:require('mail/static/src/components/file_uploader/file_uploader.js'),};const{afterEach,beforeEach,createRootComponent,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');const{file:{createFile,inputFiles,},}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('file_uploader',{},function(){QUnit.module('file_uploader_tests.js',{beforeEach(){beforeEach(this);this.components=[];this.createFileUploaderComponent=async otherProps=>{const props=Object.assign({attachmentLocalIds:[]},otherProps);return createRootComponent(this,components.FileUploader,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('no conflicts between file uploaders',async function(assert){assert.expect(2);await this.start();const fileUploader1=await this.createFileUploaderComponent();const fileUploader2=await this.createFileUploaderComponent();const file1=await createFile({name:'text1.txt',content:'hello, world',contentType:'text/plain',});inputFiles(fileUploader1.el.querySelector('.o_FileUploader_input'),[file1]);await nextAnimationFrame();assert.strictEqual(this.env.models['mail.attachment'].all().length,1,'Uploaded file should be the only attachment created');const file2=await createFile({name:'text2.txt',content:'hello, world',contentType:'text/plain',});inputFiles(fileUploader2.el.querySelector('.o_FileUploader_input'),[file2]);await nextAnimationFrame();assert.strictEqual(this.env.models['mail.attachment'].all().length,2,'Uploaded file should be the only attachment added');});});});});});;

/* /mail/static/src/components/follow_button/follow_button_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/follow_button/follow_button_tests.js',function(require){'use strict';const components={FollowButton:require('mail/static/src/components/follow_button/follow_button.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('follow_button',{},function(){QUnit.module('follow_button_tests.js',{beforeEach(){beforeEach(this);this.createFollowButtonComponent=async(thread,otherProps={})=>{const props=Object.assign({threadLocalId:thread.localId},otherProps);await createRootComponent(this,components.FollowButton,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('base rendering not editable',async function(assert){assert.expect(3);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createFollowButtonComponent(thread,{isDisabled:true});assert.containsOnce(document.body,'.o_FollowButton',"should have follow button component");assert.containsOnce(document.body,'.o_FollowButton_follow',"should have 'Follow' button");assert.ok(document.querySelector('.o_FollowButton_follow').disabled,"'Follow' button should be disabled");});QUnit.test('base rendering editable',async function(assert){assert.expect(3);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createFollowButtonComponent(thread);assert.containsOnce(document.body,'.o_FollowButton',"should have follow button component");assert.containsOnce(document.body,'.o_FollowButton_follow',"should have 'Follow' button");assert.notOk(document.querySelector('.o_FollowButton_follow').disabled,"'Follow' button should be disabled");});QUnit.test('hover following button',async function(assert){assert.expect(8);this.data['res.partner'].records.push({id:100,message_follower_ids:[1]});this.data['mail.followers'].records.push({id:1,is_active:true,is_editable:true,partner_id:this.data.currentPartnerId,res_id:100,res_model:'res.partner',});await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});thread.follow();await this.createFollowButtonComponent(thread);assert.containsOnce(document.body,'.o_FollowButton',"should have follow button component");assert.containsOnce(document.body,'.o_FollowButton_unfollow',"should have 'Unfollow' button");assert.strictEqual(document.querySelector('.o_FollowButton_unfollow').textContent.trim(),'Following',"'unfollow' button should display 'Following' as text when not hovered");assert.containsNone(document.querySelector('.o_FollowButton_unfollow'),'.fa-times',"'unfollow' button should not contain a cross icon when not hovered");assert.containsOnce(document.querySelector('.o_FollowButton_unfollow'),'.fa-check',"'unfollow' button should contain a check icon when not hovered");await afterNextRender(()=>{document.querySelector('.o_FollowButton_unfollow').dispatchEvent(new window.MouseEvent('mouseenter'));});assert.strictEqual(document.querySelector('.o_FollowButton_unfollow').textContent.trim(),'Unfollow',"'unfollow' button should display 'Unfollow' as text when hovered");assert.containsOnce(document.querySelector('.o_FollowButton_unfollow'),'.fa-times',"'unfollow' button should contain a cross icon when hovered");assert.containsNone(document.querySelector('.o_FollowButton_unfollow'),'.fa-check',"'unfollow' button should not contain a check icon when hovered");});QUnit.test('click on "follow" button',async function(assert){assert.expect(7);this.data['res.partner'].records.push({id:100,message_follower_ids:[1]});this.data['mail.followers'].records.push({id:1,is_active:true,is_editable:true,partner_id:this.data.currentPartnerId,res_id:100,res_model:'res.partner',});await this.start({async mockRPC(route,args){if(route.includes('message_subscribe')){assert.step('rpc:message_subscribe');}else if(route.includes('mail/read_followers')){assert.step('rpc:mail/read_followers');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createFollowButtonComponent(thread);assert.containsOnce(document.body,'.o_FollowButton',"should have follow button component");assert.containsOnce(document.body,'.o_FollowButton_follow',"should have button follow");await afterNextRender(()=>{document.querySelector('.o_FollowButton_follow').click();});assert.verifySteps(['rpc:message_subscribe','rpc:mail/read_followers',]);assert.containsNone(document.body,'.o_FollowButton_follow',"should not have follow button after clicked on follow");assert.containsOnce(document.body,'.o_FollowButton_unfollow',"should have unfollow button after clicked on follow");});QUnit.test('click on "unfollow" button',async function(assert){assert.expect(7);this.data['res.partner'].records.push({id:100,message_follower_ids:[1]});this.data['mail.followers'].records.push({id:1,is_active:true,is_editable:true,partner_id:this.data.currentPartnerId,res_id:100,res_model:'res.partner',});await this.start({async mockRPC(route,args){if(route.includes('message_unsubscribe')){assert.step('rpc:message_unsubscribe');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});thread.follow();await this.createFollowButtonComponent(thread);assert.containsOnce(document.body,'.o_FollowButton',"should have follow button component");assert.containsNone(document.body,'.o_FollowButton_follow',"should not have button follow");assert.containsOnce(document.body,'.o_FollowButton_unfollow',"should have button unfollow");await afterNextRender(()=>document.querySelector('.o_FollowButton_unfollow').click());assert.verifySteps(['rpc:message_unsubscribe']);assert.containsOnce(document.body,'.o_FollowButton_follow',"should have follow button after clicked on unfollow");assert.containsNone(document.body,'.o_FollowButton_unfollow',"should not have unfollow button after clicked on unfollow");});});});});});;

/* /mail/static/src/components/follower/follower_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/follower/follower_tests.js',function(require){'use strict';const components={Follower:require('mail/static/src/components/follower/follower.js'),};const{makeDeferred}=require('mail/static/src/utils/deferred/deferred.js');const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('follower',{},function(){QUnit.module('follower_tests.js',{beforeEach(){beforeEach(this);this.createFollowerComponent=async(follower)=>{await createRootComponent(this,components.Follower,{props:{followerLocalId:follower.localId},target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('base rendering not editable',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=await this.env.models['mail.follower'].create({channel:[['insert',{id:1,model:'mail.channel',name:"François Perusse"}]],followedThread:[['link',thread]],id:2,isActive:true,isEditable:false,});await this.createFollowerComponent(follower);assert.containsOnce(document.body,'.o_Follower',"should have follower component");assert.containsOnce(document.body,'.o_Follower_details',"should display a details part");assert.containsOnce(document.body,'.o_Follower_avatar',"should display the avatar of the follower");assert.containsOnce(document.body,'.o_Follower_name',"should display the name of the follower");assert.containsNone(document.body,'.o_Follower_button',"should have no button as follower is not editable");});QUnit.test('base rendering editable',async function(assert){assert.expect(6);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=await this.env.models['mail.follower'].create({channel:[['insert',{id:1,model:'mail.channel',name:"François Perusse"}]],followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,});await this.createFollowerComponent(follower);assert.containsOnce(document.body,'.o_Follower',"should have follower component");assert.containsOnce(document.body,'.o_Follower_details',"should display a details part");assert.containsOnce(document.body,'.o_Follower_avatar',"should display the avatar of the follower");assert.containsOnce(document.body,'.o_Follower_name',"should display the name of the follower");assert.containsOnce(document.body,'.o_Follower_editButton',"should have an edit button");assert.containsOnce(document.body,'.o_Follower_removeButton',"should have a remove button");});QUnit.test('click on channel follower details',async function(assert){assert.expect(7);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action.res_id,10,"The redirect action should redirect to the right res id (10)");assert.strictEqual(payload.action.res_model,'mail.channel',"The redirect action should redirect to the right res model (mail.channel)");assert.strictEqual(payload.action.type,"ir.actions.act_window","The redirect action should be of type 'ir.actions.act_window'");});this.data['res.partner'].records.push({id:100});this.data['mail.channel'].records.push({id:10});await this.start({env:{bus},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=await this.env.models['mail.follower'].create({channel:[['insert',{id:10,model:'mail.channel',name:"channel"}]],followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,});await this.createFollowerComponent(follower);assert.containsOnce(document.body,'.o_Follower',"should have follower component");assert.containsOnce(document.body,'.o_Follower_details',"should display a details part");document.querySelector('.o_Follower_details').click();assert.verifySteps(['do_action'],"clicking on channel should redirect to channel form view");});QUnit.test('click on partner follower details',async function(assert){assert.expect(7);const openFormDef=makeDeferred();const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action.res_id,3,"The redirect action should redirect to the right res id (3)");assert.strictEqual(payload.action.res_model,'res.partner',"The redirect action should redirect to the right res model (res.partner)");assert.strictEqual(payload.action.type,"ir.actions.act_window","The redirect action should be of type 'ir.actions.act_window'");openFormDef.resolve();});this.data['res.partner'].records.push({id:100});await this.start({env:{bus},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=await this.env.models['mail.follower'].create({followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,partner:[['insert',{email:"bla@bla.bla",id:this.env.messaging.currentPartner.id,name:"François Perusse",}]],});await this.createFollowerComponent(follower);assert.containsOnce(document.body,'.o_Follower',"should have follower component");assert.containsOnce(document.body,'.o_Follower_details',"should display a details part");document.querySelector('.o_Follower_details').click();await openFormDef;assert.verifySteps(['do_action'],"clicking on follower should redirect to partner form view");});QUnit.test('click on edit follower',async function(assert){assert.expect(5);this.data['res.partner'].records.push({id:100,message_follower_ids:[2]});this.data['mail.followers'].records.push({id:2,is_active:true,is_editable:true,partner_id:this.data.currentPartnerId,res_id:100,res_model:'res.partner',});await this.start({hasDialog:true,async mockRPC(route,args){if(route.includes('/mail/read_subscription_data')){assert.step('fetch_subtypes');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await thread.refreshFollowers();await this.createFollowerComponent(thread.followers[0]);assert.containsOnce(document.body,'.o_Follower',"should have follower component");assert.containsOnce(document.body,'.o_Follower_editButton',"should display an edit button");await afterNextRender(()=>document.querySelector('.o_Follower_editButton').click());assert.verifySteps(['fetch_subtypes'],"clicking on edit follower should fetch subtypes");assert.containsOnce(document.body,'.o_FollowerSubtypeList',"A dialog allowing to edit follower subtypes should have been created");});QUnit.test('edit follower and close subtype dialog',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:100});await this.start({hasDialog:true,async mockRPC(route,args){if(route.includes('/mail/read_subscription_data')){assert.step('fetch_subtypes');return[{default:true,followed:true,internal:false,id:1,name:"Dummy test",res_model:'res.partner'}];}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=await this.env.models['mail.follower'].create({followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,partner:[['insert',{email:"bla@bla.bla",id:this.env.messaging.currentPartner.id,name:"François Perusse",}]],});await this.createFollowerComponent(follower);assert.containsOnce(document.body,'.o_Follower',"should have follower component");assert.containsOnce(document.body,'.o_Follower_editButton',"should display an edit button");await afterNextRender(()=>document.querySelector('.o_Follower_editButton').click());assert.verifySteps(['fetch_subtypes'],"clicking on edit follower should fetch subtypes");assert.containsOnce(document.body,'.o_FollowerSubtypeList',"dialog allowing to edit follower subtypes should have been created");await afterNextRender(()=>document.querySelector('.o_FollowerSubtypeList_closeButton').click());assert.containsNone(document.body,'.o_DialogManager_dialog',"follower subtype dialog should be closed after clicking on close button");});});});});});;

/* /mail/static/src/components/follower_list_menu/follower_list_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/follower_list_menu/follower_list_menu_tests.js',function(require){'use strict';const components={FollowerListMenu:require('mail/static/src/components/follower_list_menu/follower_list_menu.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('follower_list_menu',{},function(){QUnit.module('follower_list_menu_tests.js',{beforeEach(){beforeEach(this);this.createFollowerListMenuComponent=async(thread,otherProps={})=>{const props=Object.assign({threadLocalId:thread.localId},otherProps);await createRootComponent(this,components.FollowerListMenu,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('base rendering not editable',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createFollowerListMenuComponent(thread,{isDisabled:true});assert.containsOnce(document.body,'.o_FollowerListMenu',"should have followers menu component");assert.containsOnce(document.body,'.o_FollowerListMenu_buttonFollowers',"should have followers button");assert.ok(document.querySelector('.o_FollowerListMenu_buttonFollowers').disabled,"followers button should be disabled");assert.containsNone(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should not be opened");document.querySelector('.o_FollowerListMenu_buttonFollowers').click();assert.containsNone(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should still be closed as button is disabled");});QUnit.test('base rendering editable',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createFollowerListMenuComponent(thread);assert.containsOnce(document.body,'.o_FollowerListMenu',"should have followers menu component");assert.containsOnce(document.body,'.o_FollowerListMenu_buttonFollowers',"should have followers button");assert.notOk(document.querySelector('.o_FollowerListMenu_buttonFollowers').disabled,"followers button should not be disabled");assert.containsNone(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should not be opened");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should be opened");});QUnit.test('click on "add followers" button',async function(assert){assert.expect(16);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('action:open_view');assert.strictEqual(payload.action.context.default_res_model,'res.partner',"'The 'add followers' action should contain thread model in context'");assert.notOk(payload.action.context.mail_invite_follower_channel_only,"The 'add followers' action should not be restricted to channels only");assert.strictEqual(payload.action.context.default_res_id,100,"The 'add followers' action should contain thread id in context");assert.strictEqual(payload.action.res_model,'mail.wizard.invite',"The 'add followers' action should be a wizard invite of mail module");assert.strictEqual(payload.action.type,"ir.actions.act_window","The 'add followers' action should be of type 'ir.actions.act_window'");const partner=this.data['res.partner'].records.find(partner=>partner.id===payload.action.context.default_res_id);partner.message_follower_ids.push(1);payload.options.on_close();});this.data['res.partner'].records.push({id:100});this.data['mail.followers'].records.push({partner_id:42,email:"bla@bla.bla",id:1,is_active:true,is_editable:true,name:"François Perusse",res_id:100,res_model:'res.partner',});await this.start({env:{bus},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createFollowerListMenuComponent(thread);assert.containsOnce(document.body,'.o_FollowerListMenu',"should have followers menu component");assert.containsOnce(document.body,'.o_FollowerListMenu_buttonFollowers',"should have followers button");assert.strictEqual(document.querySelector('.o_FollowerListMenu_buttonFollowersCount').textContent,"0","Followers counter should be equal to 0");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should be opened");assert.containsOnce(document.body,'.o_FollowerListMenu_addFollowersButton',"followers dropdown should contain a 'Add followers' button");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_addFollowersButton').click();});assert.containsNone(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should be closed after click on 'Add followers'");assert.verifySteps(['action:open_view',]);assert.strictEqual(document.querySelector('.o_FollowerListMenu_buttonFollowersCount').textContent,"1","Followers counter should now be equal to 1");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_FollowerMenu_follower',"Follower list should be refreshed and contain a follower");assert.strictEqual(document.querySelector('.o_Follower_name').textContent,"François Perusse","Follower added in follower list should be the one added");});QUnit.test('click on "add channels" button',async function(assert){assert.expect(16);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('action:open_view');assert.strictEqual(payload.action.context.default_res_model,'res.partner',"'The 'add channels' action should contain thread model in context'");assert.ok(payload.action.context.mail_invite_follower_channel_only,"The 'add channels' action should be restricted to channels only");assert.strictEqual(payload.action.context.default_res_id,100,"The 'add channels' action should contain thread id in context");assert.strictEqual(payload.action.res_model,'mail.wizard.invite',"The 'add channels' action should be a wizard invite of mail module");assert.strictEqual(payload.action.type,"ir.actions.act_window","The 'add channels' action should be of type 'ir.actions.act_window'");const partner=this.data['res.partner'].records.find(partner=>partner.id===payload.action.context.default_res_id);partner.message_follower_ids.push(1);payload.options.on_close();});this.data['res.partner'].records.push({id:100});this.data['mail.followers'].records.push({channel_id:42,email:"bla@bla.bla",id:1,is_active:true,is_editable:true,name:"Supa channel",res_id:100,res_model:'res.partner',});await this.start({env:{bus},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.createFollowerListMenuComponent(thread);assert.containsOnce(document.body,'.o_FollowerListMenu',"should have followers menu component");assert.strictEqual(document.querySelector('.o_FollowerListMenu_buttonFollowersCount').textContent,"0","Followers counter should be equal to 0");assert.containsOnce(document.body,'.o_FollowerListMenu_buttonFollowers',"should have followers button");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should be opened");assert.containsOnce(document.body,'.o_FollowerListMenu_addChannelsButton',"followers dropdown should contain a 'Add channels' button");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_addChannelsButton').click();});assert.containsNone(document.body,'.o_FollowerListMenu_dropdown',"followers dropdown should be closed after click on 'add channels'");assert.verifySteps(['action:open_view',]);assert.strictEqual(document.querySelector('.o_FollowerListMenu_buttonFollowersCount').textContent,"1","Followers counter should now be equal to 1");await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_FollowerMenu_follower',"Follower list should be refreshed and contain a follower");assert.strictEqual(document.querySelector('.o_Follower_name').textContent,"Supa channel","Follower added in follower list should be the one added");});QUnit.test('click on remove follower',async function(assert){assert.expect(6);const self=this;await this.start({async mockRPC(route,args){if(route.includes('message_unsubscribe')){assert.step('message_unsubscribe');assert.deepEqual(args.args,[[100],[self.env.messaging.currentPartner.id],[]],"message_unsubscribe should be called with right argument");}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});await this.env.models['mail.follower'].create({followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,partner:[['insert',{email:"bla@bla.bla",id:this.env.messaging.currentPartner.id,name:"François Perusse",}]],});await this.createFollowerListMenuComponent(thread);await afterNextRender(()=>{document.querySelector('.o_FollowerListMenu_buttonFollowers').click();});assert.containsOnce(document.body,'.o_Follower',"should have follower component");assert.containsOnce(document.body,'.o_Follower_removeButton',"should display a remove button");await afterNextRender(()=>{document.querySelector('.o_Follower_removeButton').click();});assert.verifySteps(['message_unsubscribe'],"clicking on remove button should call 'message_unsubscribe' route");assert.containsNone(document.body,'.o_Follower',"should no longer have follower component");});});});});});;

/* /mail/static/src/components/follower_subtype/follower_subtype_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/follower_subtype/follower_subtype_tests.js',function(require){'use strict';const components={FollowerSubtype:require('mail/static/src/components/follower_subtype/follower_subtype.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('follower_subtype',{},function(){QUnit.module('follower_subtype_tests.js',{beforeEach(){beforeEach(this);this.createFollowerSubtypeComponent=async({follower,followerSubtype})=>{const props={followerLocalId:follower.localId,followerSubtypeLocalId:followerSubtype.localId,};await createRootComponent(this,components.FollowerSubtype,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('simplest layout of a followed subtype',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=this.env.models['mail.follower'].create({channel:[['insert',{id:1,model:'mail.channel',name:"François Perusse",}]],followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,});const followerSubtype=this.env.models['mail.follower_subtype'].create({id:1,isDefault:true,isInternal:false,name:"Dummy test",resModel:'res.partner'});follower.update({selectedSubtypes:[['link',followerSubtype]],subtypes:[['link',followerSubtype]],});await this.createFollowerSubtypeComponent({follower,followerSubtype,});assert.containsOnce(document.body,'.o_FollowerSubtype',"should have follower subtype component");assert.containsOnce(document.body,'.o_FollowerSubtype_label',"should have a label");assert.containsOnce(document.body,'.o_FollowerSubtype_checkbox',"should have a checkbox");assert.strictEqual(document.querySelector('.o_FollowerSubtype_label').textContent,"Dummy test","should have the name of the subtype as label");assert.ok(document.querySelector('.o_FollowerSubtype_checkbox').checked,"checkbox should be checked as follower subtype is followed");});QUnit.test('simplest layout of a not followed subtype',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=this.env.models['mail.follower'].create({channel:[['insert',{id:1,model:'mail.channel',name:"François Perusse",}]],followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,});const followerSubtype=this.env.models['mail.follower_subtype'].create({id:1,isDefault:true,isInternal:false,name:"Dummy test",resModel:'res.partner'});follower.update({subtypes:[['link',followerSubtype]]});await this.createFollowerSubtypeComponent({follower,followerSubtype,});assert.containsOnce(document.body,'.o_FollowerSubtype',"should have follower subtype component");assert.containsOnce(document.body,'.o_FollowerSubtype_label',"should have a label");assert.containsOnce(document.body,'.o_FollowerSubtype_checkbox',"should have a checkbox");assert.strictEqual(document.querySelector('.o_FollowerSubtype_label').textContent,"Dummy test","should have the name of the subtype as label");assert.notOk(document.querySelector('.o_FollowerSubtype_checkbox').checked,"checkbox should not be checked as follower subtype is not followed");});QUnit.test('toggle follower subtype checkbox',async function(assert){assert.expect(5);await this.start();const thread=this.env.models['mail.thread'].create({id:100,model:'res.partner',});const follower=this.env.models['mail.follower'].create({channel:[['insert',{id:1,model:'mail.channel',name:"François Perusse",}]],followedThread:[['link',thread]],id:2,isActive:true,isEditable:true,});const followerSubtype=this.env.models['mail.follower_subtype'].create({id:1,isDefault:true,isInternal:false,name:"Dummy test",resModel:'res.partner'});follower.update({subtypes:[['link',followerSubtype]]});await this.createFollowerSubtypeComponent({follower,followerSubtype,});assert.containsOnce(document.body,'.o_FollowerSubtype',"should have follower subtype component");assert.containsOnce(document.body,'.o_FollowerSubtype_checkbox',"should have a checkbox");assert.notOk(document.querySelector('.o_FollowerSubtype_checkbox').checked,"checkbox should not be checked as follower subtype is not followed");await afterNextRender(()=>document.querySelector('.o_FollowerSubtype_checkbox').click());assert.ok(document.querySelector('.o_FollowerSubtype_checkbox').checked,"checkbox should now be checked");await afterNextRender(()=>document.querySelector('.o_FollowerSubtype_checkbox').click());assert.notOk(document.querySelector('.o_FollowerSubtype_checkbox').checked,"checkbox should be no more checked");});});});});});;

/* /mail/static/src/components/message/message_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/message/message_tests.js',function(require){'use strict';const components={Message:require('mail/static/src/components/message/message.js'),};const{makeDeferred}=require('mail/static/src/utils/deferred/deferred.js');const{afterEach,afterNextRender,beforeEach,createRootComponent,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('message',{},function(){QUnit.module('message_tests.js',{beforeEach(){beforeEach(this);this.createMessageComponent=async(message,otherProps)=>{const props=Object.assign({messageLocalId:message.localId},otherProps);await createRootComponent(this,components.Message,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('basic rendering',async function(assert){assert.expect(12);await this.start();const message=this.env.models['mail.message'].create({author:[['insert',{id:7,display_name:"Demo User"}]],body:"<p>Test</p>",id:100,});await this.createMessageComponent(message);assert.strictEqual(document.querySelectorAll('.o_Message').length,1,"should display a message component");const messageEl=document.querySelector('.o_Message');assert.strictEqual(messageEl.dataset.messageLocalId,this.env.models['mail.message'].findFromIdentifyingData({id:100}).localId,"message component should be linked to message store model");assert.strictEqual(messageEl.querySelectorAll(`:scope .o_Message_sidebar`).length,1,"message should have a sidebar");assert.strictEqual(messageEl.querySelectorAll(`:scope .o_Message_sidebar .o_Message_authorAvatar`).length,1,"message should have author avatar in the sidebar");assert.strictEqual(messageEl.querySelector(`:scope .o_Message_authorAvatar`).tagName,'IMG',"message author avatar should be an image");assert.strictEqual(messageEl.querySelector(`:scope .o_Message_authorAvatar`).dataset.src,'/web/image/res.partner/7/image_128',"message author avatar should GET image of the related partner");assert.strictEqual(messageEl.querySelectorAll(`:scope .o_Message_authorName`).length,1,"message should display author name");assert.strictEqual(messageEl.querySelector(`:scope .o_Message_authorName`).textContent,"Demo User","message should display correct author name");assert.strictEqual(messageEl.querySelectorAll(`:scope .o_Message_date`).length,1,"message should display date");assert.strictEqual(messageEl.querySelectorAll(`:scope .o_Message_commands`).length,1,"message should display list of commands");assert.strictEqual(messageEl.querySelectorAll(`:scope .o_Message_content`).length,1,"message should display the content");assert.strictEqual(messageEl.querySelector(`:scope .o_Message_prettyBody`).innerHTML,"<p>Test</p>","message should display the correct content");});QUnit.test('moderation: as author, moderated channel with pending moderation message',async function(assert){assert.expect(1);await this.start();const thread=this.env.models['mail.thread'].create({id:20,model:'mail.channel',});const message=this.env.models['mail.message'].create({author:[['insert',{id:1,display_name:"Admin"}]],body:"<p>Test</p>",id:100,moderation_status:'pending_moderation',originThread:[['link',thread]],});await this.createMessageComponent(message);assert.strictEqual(document.querySelectorAll(`.o_Message_moderationPending.o-author`).length,1,"should have the message pending moderation");});QUnit.test('moderation: as moderator, moderated channel with pending moderation message',async function(assert){assert.expect(9);await this.start();const thread=this.env.models['mail.thread'].create({id:20,model:'mail.channel',moderators:[['link',this.env.messaging.currentPartner]],});const message=this.env.models['mail.message'].create({author:[['insert',{id:7,display_name:"Demo User"}]],body:"<p>Test</p>",id:100,moderation_status:'pending_moderation',originThread:[['link',thread]],});await this.createMessageComponent(message);const messageEl=document.querySelector('.o_Message');assert.ok(messageEl,"should display a message");assert.containsOnce(messageEl,`.o_Message_moderationSubHeader`,"should have the message pending moderation");assert.containsNone(messageEl,`.o_Message_checkbox`,"should not have the moderation checkbox by default");assert.containsN(messageEl,'.o_Message_moderationAction',5,"there should be 5 contextual moderation decisions next to the message");assert.containsOnce(messageEl,'.o_Message_moderationAction.o-accept',"there should be a contextual moderation decision to accept the message");assert.containsOnce(messageEl,'.o_Message_moderationAction.o-reject',"there should be a contextual moderation decision to reject the message");assert.containsOnce(messageEl,'.o_Message_moderationAction.o-discard',"there should be a contextual moderation decision to discard the message");assert.containsOnce(messageEl,'.o_Message_moderationAction.o-allow',"there should be a contextual moderation decision to allow the user of the message)");assert.containsOnce(messageEl,'.o_Message_moderationAction.o-ban',"there should be a contextual moderation decision to ban the user of the message");});QUnit.test('Notification Sent',async function(assert){assert.expect(9);await this.start();const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['create',{id:11,model:'mail.channel',}]],});const message=this.env.models['mail.message'].create({id:10,message_type:'email',notifications:[['insert',{id:11,notification_status:'sent',notification_type:'email',partner:[['insert',{id:12,name:"Someone"}]],}]],originThread:[['link',threadViewer.thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsOnce(document.body,'.o_Message_notificationIconClickable',"should display the notification icon container");assert.containsOnce(document.body,'.o_Message_notificationIcon',"should display the notification icon");assert.hasClass(document.querySelector('.o_Message_notificationIcon'),'fa-envelope-o',"icon should represent email success");await afterNextRender(()=>{document.querySelector('.o_Message_notificationIconClickable').click();});assert.containsOnce(document.body,'.o_NotificationPopover',"notification popover should be open");assert.containsOnce(document.body,'.o_NotificationPopover_notificationIcon',"popover should have one icon");assert.hasClass(document.querySelector('.o_NotificationPopover_notificationIcon'),'fa-check',"popover should have the sent icon");assert.containsOnce(document.body,'.o_NotificationPopover_notificationPartnerName',"popover should have the partner name");assert.strictEqual(document.querySelector('.o_NotificationPopover_notificationPartnerName').textContent.trim(),"Someone","partner name should be correct");});QUnit.test('Notification Error',async function(assert){assert.expect(8);const openResendActionDef=makeDeferred();const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action,'mail.mail_resend_message_action',"action should be the one to resend email");assert.strictEqual(payload.options.additional_context.mail_message_to_resend,10,"action should have correct message id");openResendActionDef.resolve();});await this.start({env:{bus}});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['create',{id:11,model:'mail.channel',}]],});const message=this.env.models['mail.message'].create({id:10,message_type:'email',notifications:[['insert',{id:11,notification_status:'exception',notification_type:'email',}]],originThread:[['link',threadViewer.thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsOnce(document.body,'.o_Message_notificationIconClickable',"should display the notification icon container");assert.containsOnce(document.body,'.o_Message_notificationIcon',"should display the notification icon");assert.hasClass(document.querySelector('.o_Message_notificationIcon'),'fa-envelope',"icon should represent email error");document.querySelector('.o_Message_notificationIconClickable').click();await openResendActionDef;assert.verifySteps(['do_action'],"should do an action to display the resend email dialog");});QUnit.test("'channel_fetch' notification received is correctly handled",async function(assert){assert.expect(3);await this.start();const currentPartner=this.env.models['mail.partner'].insert({id:this.env.messaging.currentPartner.id,display_name:"Demo User",});const thread=this.env.models['mail.thread'].create({channel_type:'chat',id:11,members:[[['link',currentPartner]],[['insert',{id:11,display_name:"Recipient"}]]],model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});const message=this.env.models['mail.message'].create({author:[['link',currentPartner]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId,});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsNone(document.body,'.o_MessageSeenIndicator_icon',"message component should not have any check (V) as message is not yet received");const notifications=[[['myDB','mail.channel',11],{info:'channel_fetched',last_message_id:100,partner_id:11,}],];await afterNextRender(()=>{this.widget.call('bus_service','trigger','notification',notifications);});assert.containsOnce(document.body,'.o_MessageSeenIndicator_icon',"message seen indicator component should only contain one check (V) as message is just received");});QUnit.test("'channel_seen' notification received is correctly handled",async function(assert){assert.expect(3);await this.start();const currentPartner=this.env.models['mail.partner'].insert({id:this.env.messaging.currentPartner.id,display_name:"Demo User",});const thread=this.env.models['mail.thread'].create({channel_type:'chat',id:11,members:[[['link',currentPartner]],[['insert',{id:11,display_name:"Recipient"}]]],model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});const message=this.env.models['mail.message'].create({author:[['link',currentPartner]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId,});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsNone(document.body,'.o_MessageSeenIndicator_icon',"message component should not have any check (V) as message is not yet received");const notifications=[[['myDB','mail.channel',11],{info:'channel_seen',last_message_id:100,partner_id:11,}],];await afterNextRender(()=>{this.widget.call('bus_service','trigger','notification',notifications);});assert.containsN(document.body,'.o_MessageSeenIndicator_icon',2,"message seen indicator component should contain two checks (V) as message is seen");});QUnit.test("'channel_fetch' notification then 'channel_seen' received  are correctly handled",async function(assert){assert.expect(4);await this.start();const currentPartner=this.env.models['mail.partner'].insert({id:this.env.messaging.currentPartner.id,display_name:"Demo User",});const thread=this.env.models['mail.thread'].create({channel_type:'chat',id:11,members:[[['link',currentPartner]],[['insert',{id:11,display_name:"Recipient"}]]],model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});const message=this.env.models['mail.message'].create({author:[['link',currentPartner]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId,});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsNone(document.body,'.o_MessageSeenIndicator_icon',"message component should not have any check (V) as message is not yet received");let notifications=[[['myDB','mail.channel',11],{info:'channel_fetched',last_message_id:100,partner_id:11,}],];await afterNextRender(()=>{this.widget.call('bus_service','trigger','notification',notifications);});assert.containsOnce(document.body,'.o_MessageSeenIndicator_icon',"message seen indicator component should only contain one check (V) as message is just received");notifications=[[['myDB','mail.channel',11],{info:'channel_seen',last_message_id:100,partner_id:11,}],];await afterNextRender(()=>{this.widget.call('bus_service','trigger','notification',notifications);});assert.containsN(document.body,'.o_MessageSeenIndicator_icon',2,"message seen indicator component should contain two checks (V) as message is now seen");});QUnit.test('do not show messaging seen indicator if not authored by me',async function(assert){assert.expect(2);await this.start();const author=this.env.models['mail.partner'].create({id:100,display_name:"Demo User"});const thread=this.env.models['mail.thread'].create({channel_type:'chat',id:11,partnerSeenInfos:[['create',[{channelId:11,lastFetchedMessage:[['insert',{id:100}]],partnerId:this.env.messaging.currentPartner.id,},{channelId:11,lastFetchedMessage:[['insert',{id:100}]],partnerId:author.id,},]]],model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});const message=this.env.models['mail.message'].insert({author:[['link',author]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsNone(document.body,'.o_Message_seenIndicator',"message component should not have any message seen indicator");});QUnit.test('do not show messaging seen indicator if before last seen by all message',async function(assert){assert.expect(3);await this.start();const currentPartner=this.env.models['mail.partner'].insert({id:this.env.messaging.currentPartner.id,display_name:"Demo User",});const thread=this.env.models['mail.thread'].create({channel_type:'chat',id:11,messageSeenIndicators:[['insert',{channelId:11,messageId:99,}]],model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});const lastSeenMessage=this.env.models['mail.message'].create({author:[['link',currentPartner]],body:"<p>You already saw me</p>",id:100,originThread:[['link',thread]],});const message=this.env.models['mail.message'].insert({author:[['link',currentPartner]],body:"<p>Test</p>",id:99,originThread:[['link',thread]],});thread.update({partnerSeenInfos:[['create',[{channelId:11,lastSeenMessage:[['link',lastSeenMessage]],partnerId:this.env.messaging.currentPartner.id,},{channelId:11,lastSeenMessage:[['link',lastSeenMessage]],partnerId:100,},]]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId,});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsOnce(document.body,'.o_Message_seenIndicator',"message component should have a message seen indicator");assert.containsNone(document.body,'.o_MessageSeenIndicator_icon',"message component should not have any check (V)");});QUnit.test('only show messaging seen indicator if authored by me, after last seen by all message',async function(assert){assert.expect(3);await this.start();const currentPartner=this.env.models['mail.partner'].insert({id:this.env.messaging.currentPartner.id,display_name:"Demo User"});const thread=this.env.models['mail.thread'].create({channel_type:'chat',id:11,partnerSeenInfos:[['create',[{channelId:11,lastSeenMessage:[['insert',{id:100}]],partnerId:this.env.messaging.currentPartner.id,},{channelId:11,lastFetchedMessage:[['insert',{id:100}]],lastSeenMessage:[['insert',{id:99}]],partnerId:100,},]]],messageSeenIndicators:[['insert',{channelId:11,messageId:100,}]],model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});const message=this.env.models['mail.message'].insert({author:[['link',currentPartner]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId,});assert.containsOnce(document.body,'.o_Message',"should display a message component");assert.containsOnce(document.body,'.o_Message_seenIndicator',"message component should have a message seen indicator");assert.containsN(document.body,'.o_MessageSeenIndicator_icon',1,"message component should have one check (V) because the message was fetched by everyone but no other member than author has seen the message");});QUnit.test('allow attachment delete on authored message',async function(assert){assert.expect(5);await this.start();const message=this.env.models['mail.message'].create({attachments:[['insert-and-replace',{filename:"BLAH.jpg",id:10,name:"BLAH",}]],author:[['link',this.env.messaging.currentPartner]],body:"<p>Test</p>",id:100,});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Attachment',"should have an attachment",);assert.containsOnce(document.body,'.o_Attachment_asideItemUnlink',"should have delete attachment button");await afterNextRender(()=>document.querySelector('.o_Attachment_asideItemUnlink').click());assert.containsOnce(document.body,'.o_AttachmentDeleteConfirmDialog',"An attachment delete confirmation dialog should have been opened");assert.strictEqual(document.querySelector('.o_AttachmentDeleteConfirmDialog_mainText').textContent,`Do you really want to delete "BLAH"?`,"Confirmation dialog should contain the attachment delete confirmation text");await afterNextRender(()=>document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click());assert.containsNone(document.body,'.o_Attachment',"should no longer have an attachment",);});QUnit.test('prevent attachment delete on non-authored message',async function(assert){assert.expect(2);await this.start();const message=this.env.models['mail.message'].create({attachments:[['insert-and-replace',{filename:"BLAH.jpg",id:10,name:"BLAH",}]],author:[['insert',{id:11,display_name:"Guy"}]],body:"<p>Test</p>",id:100,});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Attachment',"should have an attachment",);assert.containsNone(document.body,'.o_Attachment_asideItemUnlink',"delete attachment button should not be printed");});QUnit.test('subtype description should be displayed if it is different than body',async function(assert){assert.expect(2);await this.start();const message=this.env.models['mail.message'].create({body:"<p>Hello</p>",id:100,subtype_description:'Bonjour',});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Message_content',"message should have content");assert.strictEqual(document.querySelector(`.o_Message_content`).textContent,"HelloBonjour","message content should display both body and subtype description when they are different");});QUnit.test('subtype description should not be displayed if it is similar to body',async function(assert){assert.expect(2);await this.start();const message=this.env.models['mail.message'].create({body:"<p>Hello</p>",id:100,subtype_description:'hello',});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Message_content',"message should have content");assert.strictEqual(document.querySelector(`.o_Message_content`).textContent,"Hello","message content should display only body when subtype description is similar");});QUnit.test('data-oe-id & data-oe-model link redirection on click',async function(assert){assert.expect(7);const bus=new Bus();bus.on('do-action',null,payload=>{assert.strictEqual(payload.action.type,'ir.actions.act_window',"action should open view");assert.strictEqual(payload.action.res_model,'some.model',"action should open view on 'some.model' model");assert.strictEqual(payload.action.res_id,250,"action should open view on 250");assert.step('do-action:openFormView_some.model_250');});await this.start({env:{bus}});const message=this.env.models['mail.message'].create({body:`<p><a href="#" data-oe-id="250" data-oe-model="some.model">some.model_250</a></p>`,id:100,});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Message_content',"message should have content");assert.containsOnce(document.querySelector('.o_Message_content'),'a',"message content should have a link");document.querySelector(`.o_Message_content a`).click();assert.verifySteps(['do-action:openFormView_some.model_250'],"should have open form view on related record after click on link");});QUnit.test('chat with author should be opened after clicking on his avatar',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:10});this.data['res.users'].records.push({partner_id:10});await this.start({hasChatWindow:true,});const message=this.env.models['mail.message'].create({author:[['insert',{id:10}]],id:10,});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Message_authorAvatar',"message should have the author avatar");assert.hasClass(document.querySelector('.o_Message_authorAvatar'),'o_redirect',"author avatar should have the redirect style");await afterNextRender(()=>document.querySelector('.o_Message_authorAvatar').click());assert.containsOnce(document.body,'.o_ChatWindow_thread',"chat window with thread should be opened after clicking on author avatar");assert.strictEqual(document.querySelector('.o_ChatWindow_thread').dataset.correspondentId,message.author.id.toString(),"chat with author should be opened after clicking on his avatar");});QUnit.test('chat with author should be opened after clicking on his im status icon',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:10});this.data['res.users'].records.push({partner_id:10});await this.start({hasChatWindow:true,});const message=this.env.models['mail.message'].create({author:[['insert',{id:10,im_status:'online'}]],id:10,});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Message_partnerImStatusIcon',"message should have the author im status icon");assert.hasClass(document.querySelector('.o_Message_partnerImStatusIcon'),'o-has-open-chat',"author im status icon should have the open chat style");await afterNextRender(()=>document.querySelector('.o_Message_partnerImStatusIcon').click());assert.containsOnce(document.body,'.o_ChatWindow_thread',"chat window with thread should be opened after clicking on author im status icon");assert.strictEqual(document.querySelector('.o_ChatWindow_thread').dataset.correspondentId,message.author.id.toString(),"chat with author should be opened after clicking on his im status icon");});QUnit.test('open chat with author on avatar click should be disabled when currently chatting with the author',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({channel_type:'chat',members:[this.data.currentPartnerId,10],public:'private',});this.data['res.partner'].records.push({id:10});this.data['res.users'].records.push({partner_id:10});await this.start({hasChatWindow:true,});const correspondent=this.env.models['mail.partner'].insert({id:10});const message=this.env.models['mail.message'].create({author:[['link',correspondent]],id:10,});const thread=await correspondent.getChat();const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createMessageComponent(message,{threadViewLocalId:threadViewer.threadView.localId,});assert.containsOnce(document.body,'.o_Message_authorAvatar',"message should have the author avatar");assert.doesNotHaveClass(document.querySelector('.o_Message_authorAvatar'),'o_redirect',"author avatar should not have the redirect style");document.querySelector('.o_Message_authorAvatar').click();await nextAnimationFrame();assert.containsNone(document.body,'.o_ChatWindow',"should have no thread opened after clicking on author avatar when currently chatting with the author");});QUnit.test('basic rendering of tracking value (float type)',async function(assert){assert.expect(8);await this.start();const message=this.env.models['mail.message'].create({id:11,tracking_value_ids:[{changed_field:"Total",field_type:"float",id:6,new_value:45.67,old_value:12.3,}],});await this.createMessageComponent(message);assert.containsOnce(document.body,'.o_Message_trackingValue',"should display a tracking value");assert.containsOnce(document.body,'.o_Message_trackingValueFieldName',"should display the name of the tracked field");assert.strictEqual(document.querySelector('.o_Message_trackingValueFieldName').textContent,"Total:","should display the correct tracked field name (Total)",);assert.containsOnce(document.body,'.o_Message_trackingValueOldValue',"should display the old value");assert.strictEqual(document.querySelector('.o_Message_trackingValueOldValue').textContent,"12.3","should display the correct old value (12.3)",);assert.containsOnce(document.body,'.o_Message_trackingValueSeparator',"should display the separator");assert.containsOnce(document.body,'.o_Message_trackingValueNewValue',"should display the new value");assert.strictEqual(document.querySelector('.o_Message_trackingValueNewValue').textContent,"45.67","should display the correct new value (45.67)",);});QUnit.test('rendering of tracked field with change of value from non-0 to 0',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({id:11,tracking_value_ids:[{changed_field:"Total",field_type:"float",id:6,new_value:0,old_value:1,}],});await this.createMessageComponent(message);assert.strictEqual(document.querySelector('.o_Message_trackingValue').textContent,"Total:10","should display the correct content of tracked field with change of value from non-0 to 0 (Total: 1 -> 0)");});QUnit.test('rendering of tracked field with change of value from 0 to non-0',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({id:11,tracking_value_ids:[{changed_field:"Total",field_type:"float",id:6,new_value:1,old_value:0,}],});await this.createMessageComponent(message);assert.strictEqual(document.querySelector('.o_Message_trackingValue').textContent,"Total:01","should display the correct content of tracked field with change of value from 0 to non-0 (Total: 0 -> 1)");});QUnit.test('rendering of tracked field with change of value from true to false',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({id:11,tracking_value_ids:[{changed_field:"Is Ready",field_type:"boolean",id:6,new_value:false,old_value:true,}],});await this.createMessageComponent(message);assert.strictEqual(document.querySelector('.o_Message_trackingValue').textContent,"Is Ready:truefalse","should display the correct content of tracked field with change of value from true to false (Is Ready: true -> false)");});QUnit.test('rendering of tracked field with change of value from false to true',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({id:11,tracking_value_ids:[{changed_field:"Is Ready",field_type:"boolean",id:6,new_value:true,old_value:false,}],});await this.createMessageComponent(message);assert.strictEqual(document.querySelector('.o_Message_trackingValue').textContent,"Is Ready:falsetrue","should display the correct content of tracked field with change of value from false to true (Is Ready: false -> true)");});QUnit.test('rendering of tracked field with change of value from string to empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({id:11,tracking_value_ids:[{changed_field:"Name",field_type:"char",id:6,new_value:"",old_value:"Marc",}],});await this.createMessageComponent(message);assert.strictEqual(document.querySelector('.o_Message_trackingValue').textContent,"Name:Marc","should display the correct content of tracked field with change of value from string to empty (Total: Marc ->)");});QUnit.test('rendering of tracked field with change of value from empty to string',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({id:11,tracking_value_ids:[{changed_field:"Name",field_type:"char",id:6,new_value:"Marc",old_value:"",}],});await this.createMessageComponent(message);assert.strictEqual(document.querySelector('.o_Message_trackingValue').textContent,"Name:Marc","should display the correct content of tracked field with change of value from empty to string (Total: -> Marc)");});});});});});;

/* /mail/static/src/components/message_seen_indicator/message_seen_indicator_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/message_seen_indicator/message_seen_indicator_tests',function(require){'use strict';const components={MessageSendIndicator:require('mail/static/src/components/message_seen_indicator/message_seen_indicator.js'),};const{afterEach,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('message_seen_indicator',{},function(){QUnit.module('message_seen_indicator_tests.js',{beforeEach(){beforeEach(this);this.createMessageSeenIndicatorComponent=async({message,thread},otherProps)=>{const props=Object.assign({messageLocalId:message.localId,threadLocalId:thread.localId},otherProps);await createRootComponent(this,components.MessageSendIndicator,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('rendering when just one has received the message',async function(assert){assert.expect(3);await this.start();const thread=this.env.models['mail.thread'].create({id:1000,model:'mail.channel',partnerSeenInfos:[['create',[{channelId:1000,lastFetchedMessage:[['insert',{id:100}]],partnerId:10,},{channelId:1000,partnerId:100,},]]],messageSeenIndicators:[['insert',{channelId:1000,messageId:100,}]],});const message=this.env.models['mail.message'].insert({author:[['insert',{id:this.env.messaging.currentPartner.id,display_name:"Demo User"}]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageSeenIndicatorComponent({message,thread});assert.containsOnce(document.body,'.o_MessageSeenIndicator',"should display a message seen indicator component");assert.doesNotHaveClass(document.querySelector('.o_MessageSeenIndicator'),'o-all-seen',"indicator component should not be considered as all seen");assert.containsOnce(document.body,'.o_MessageSeenIndicator_icon',"should display only one seen indicator icon");});QUnit.test('rendering when everyone have received the message',async function(assert){assert.expect(3);await this.start();const thread=this.env.models['mail.thread'].create({id:1000,model:'mail.channel',partnerSeenInfos:[['create',[{channelId:1000,lastFetchedMessage:[['insert',{id:100}]],partnerId:10,},{channelId:1000,lastFetchedMessage:[['insert',{id:99}]],partnerId:100,},]]],messageSeenIndicators:[['insert',{channelId:1000,messageId:100,}]],});const message=this.env.models['mail.message'].insert({author:[['insert',{id:this.env.messaging.currentPartner.id,display_name:"Demo User"}]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageSeenIndicatorComponent({message,thread});assert.containsOnce(document.body,'.o_MessageSeenIndicator',"should display a message seen indicator component");assert.doesNotHaveClass(document.querySelector('.o_MessageSeenIndicator'),'o-all-seen',"indicator component should not be considered as all seen");assert.containsOnce(document.body,'.o_MessageSeenIndicator_icon',"should display only one seen indicator icon");});QUnit.test('rendering when just one has seen the message',async function(assert){assert.expect(3);await this.start();const thread=this.env.models['mail.thread'].create({id:1000,model:'mail.channel',partnerSeenInfos:[['create',[{channelId:1000,lastFetchedMessage:[['insert',{id:100}]],lastSeenMessage:[['insert',{id:100}]],partnerId:10,},{channelId:1000,lastFetchedMessage:[['insert',{id:99}]],partnerId:100,},]]],messageSeenIndicators:[['insert',{channelId:1000,messageId:100,}]],});const message=this.env.models['mail.message'].insert({author:[['insert',{id:this.env.messaging.currentPartner.id,display_name:"Demo User"}]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageSeenIndicatorComponent({message,thread});assert.containsOnce(document.body,'.o_MessageSeenIndicator',"should display a message seen indicator component");assert.doesNotHaveClass(document.querySelector('.o_MessageSeenIndicator'),'o-all-seen',"indicator component should not be considered as all seen");assert.containsN(document.body,'.o_MessageSeenIndicator_icon',2,"should display two seen indicator icon");});QUnit.test('rendering when just one has seen & received the message',async function(assert){assert.expect(3);await this.start();const thread=this.env.models['mail.thread'].create({id:1000,model:'mail.channel',partnerSeenInfos:[['create',[{channelId:1000,lastFetchedMessage:[['insert',{id:100}]],lastSeenMessage:[['insert',{id:100}]],partnerId:10,},{channelId:1000,partnerId:100,},]]],messageSeenIndicators:[['insert',{channelId:1000,messageId:100,}]],});const message=this.env.models['mail.message'].insert({author:[['insert',{id:this.env.messaging.currentPartner.id,display_name:"Demo User"}]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageSeenIndicatorComponent({message,thread});assert.containsOnce(document.body,'.o_MessageSeenIndicator',"should display a message seen indicator component");assert.doesNotHaveClass(document.querySelector('.o_MessageSeenIndicator'),'o-all-seen',"indicator component should not be considered as all seen");assert.containsN(document.body,'.o_MessageSeenIndicator_icon',2,"should display two seen indicator icon");});QUnit.test('rendering when just everyone has seen the message',async function(assert){assert.expect(3);await this.start();const thread=this.env.models['mail.thread'].create({id:1000,model:'mail.channel',partnerSeenInfos:[['create',[{channelId:1000,lastFetchedMessage:[['insert',{id:100}]],lastSeenMessage:[['insert',{id:100}]],partnerId:10,},{channelId:1000,lastFetchedMessage:[['insert',{id:100}]],lastSeenMessage:[['insert',{id:100}]],partnerId:100,},]]],messageSeenIndicators:[['insert',{channelId:1000,messageId:100,}]],});const message=this.env.models['mail.message'].insert({author:[['insert',{id:this.env.messaging.currentPartner.id,display_name:"Demo User"}]],body:"<p>Test</p>",id:100,originThread:[['link',thread]],});await this.createMessageSeenIndicatorComponent({message,thread});assert.containsOnce(document.body,'.o_MessageSeenIndicator',"should display a message seen indicator component");assert.hasClass(document.querySelector('.o_MessageSeenIndicator'),'o-all-seen',"indicator component should not considered as all seen");assert.containsN(document.body,'.o_MessageSeenIndicator_icon',2,"should display two seen indicator icon");});});});});});;

/* /mail/static/src/components/messaging_menu/messaging_menu_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/messaging_menu/messaging_menu_tests.js',function(require){'use strict';const{afterEach,afterNextRender,beforeEach,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');const{makeTestPromise}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('messaging_menu',{},function(){QUnit.module('messaging_menu_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{let{discussWidget,env,widget}=await start(Object.assign({},params,{data:this.data,hasMessagingMenu:true,}));this.discussWidget=discussWidget;this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('[technical] messaging not created then becomes created',async function(assert){assert.expect(2);const messagingBeforeCreationDeferred=makeTestPromise();await this.start({messagingBeforeCreationDeferred,waitUntilMessagingCondition:'none',});assert.containsOnce(document.body,'.o_MessagingMenu',"should have messaging menu even when messaging is not yet created");messagingBeforeCreationDeferred.resolve();await nextAnimationFrame();assert.containsOnce(document.body,'.o_MessagingMenu',"should still contain messaging menu after messaging has been created");});QUnit.test('[technical] no crash on attempting opening messaging menu when messaging not created',async function(assert){assert.expect(2);await this.start({messagingBeforeCreationDeferred:new Promise(()=>{}),waitUntilMessagingCondition:'none',});assert.containsOnce(document.body,'.o_MessagingMenu',"should have messaging menu even when messaging is not yet created");let error;try{document.querySelector('.o_MessagingMenu_toggler').click();await nextAnimationFrame();}catch(err){error=err;}
assert.notOk(!!error,"Should not crash on attempt to open messaging menu when messaging not created");if(error){throw error;}});QUnit.test('messaging not initialized',async function(assert){assert.expect(2);await this.start({async mockRPC(route){if(route==='/mail/init_messaging'){return new Promise(resolve=>{});}
return this._super(...arguments);},waitUntilMessagingCondition:'created',});assert.strictEqual(document.querySelectorAll('.o_MessagingMenu_loading').length,1,"should display loading icon on messaging menu when messaging not yet initialized");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.strictEqual(document.querySelector('.o_MessagingMenu_dropdownMenu').textContent,"Please wait...","should prompt loading when opening messaging menu");});QUnit.test('messaging becomes initialized',async function(assert){assert.expect(2);const messagingInitializedProm=makeTestPromise();await this.start({async mockRPC(route){const _super=this._super.bind(this,...arguments);if(route==='/mail/init_messaging'){await messagingInitializedProm;}
return _super();},waitUntilMessagingCondition:'created',});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>messagingInitializedProm.resolve());assert.strictEqual(document.querySelectorAll('.o_MessagingMenu_loading').length,0,"should no longer display loading icon on messaging menu when messaging becomes initialized");assert.notOk(document.querySelector('.o_MessagingMenu_dropdownMenu').textContent.includes("Please wait..."),"should no longer prompt loading when opening messaging menu when messaging becomes initialized");});QUnit.test('basic rendering',async function(assert){assert.expect(21);await this.start();assert.strictEqual(document.querySelectorAll('.o_MessagingMenu').length,1,"should have messaging menu");assert.notOk(document.querySelector('.o_MessagingMenu').classList.contains('show'),"should not mark messaging menu item as shown by default");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_toggler`).length,1,"should have clickable element on messaging menu");assert.notOk(document.querySelector(`.o_MessagingMenu_toggler`).classList.contains('show'),"should not mark messaging menu clickable item as shown by default");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_icon`).length,1,"should have icon on clickable element in messaging menu");assert.ok(document.querySelector(`.o_MessagingMenu_icon`).classList.contains('fa-comments'),"should have 'comments' icon on clickable element in messaging menu");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu`).length,0,"should not display any messaging menu dropdown by default");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.hasClass(document.querySelector('.o_MessagingMenu'),"o-is-open","should mark messaging menu as opened");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu`).length,1,"should display messaging menu dropdown after click");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenuHeader`).length,1,"should have dropdown menu header");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenuHeader
            .o_MessagingMenu_tabButton
        `).length,3,"should have 3 tab buttons to filter items in the header");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_tabButton[data-tab-id="all"]`).length,1,"1 tab button should be 'All'");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_tabButton[data-tab-id="chat"]`).length,1,"1 tab button should be 'Chat'");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_tabButton[data-tab-id="channel"]`).length,1,"1 tab button should be 'Channels'");assert.ok(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="all"]
        `).classList.contains('o-active'),"'all' tab button should be active");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="chat"]
        `).classList.contains('o-active'),"'chat' tab button should not be active");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="channel"]
        `).classList.contains('o-active'),"'channel' tab button should not be active");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_newMessageButton`).length,1,"should have button to make a new message");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList
        `).length,1,"should display thread preview list");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_NotificationList_noConversation
        `).length,1,"should display no conversation in thread preview list");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.doesNotHaveClass(document.querySelector('.o_MessagingMenu'),"o-is-open","should mark messaging menu as closed");});QUnit.test('counter is taking into account failure notification',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:31,seen_message_id:11,});this.data['mail.message'].records.push({id:11,model:'mail.channel',res_id:31,});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'exception',});await this.start();assert.containsOnce(document.body,'.o_MessagingMenu_counter',"should display a notification counter next to the messaging menu for one notification");assert.strictEqual(document.querySelector('.o_MessagingMenu_counter').textContent,"1","should display a counter of '1' next to the messaging menu");});QUnit.test('switch tab',async function(assert){assert.expect(15);await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_tabButton[data-tab-id="all"]`).length,1,"1 tab button should be 'All'");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_tabButton[data-tab-id="chat"]`).length,1,"1 tab button should be 'Chat'");assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_tabButton[data-tab-id="channel"]`).length,1,"1 tab button should be 'Channels'");assert.ok(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="all"]
        `).classList.contains('o-active'),"'all' tab button should be active");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="chat"]
        `).classList.contains('o-active'),"'chat' tab button should not be active");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="channel"]
        `).classList.contains('o-active'),"'channel' tab button should not be active");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_tabButton[data-tab-id="chat"]`).click());assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="all"]
        `).classList.contains('o-active'),"'all' tab button should become inactive");assert.ok(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="chat"]
        `).classList.contains('o-active'),"'chat' tab button should not become active");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="channel"]
        `).classList.contains('o-active'),"'channel' tab button should stay inactive");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_tabButton[data-tab-id="channel"]`).click());assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="all"]
        `).classList.contains('o-active'),"'all' tab button should stay active");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="chat"]
        `).classList.contains('o-active'),"'chat' tab button should become inactive");assert.ok(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="channel"]
        `).classList.contains('o-active'),"'channel' tab button should become active");await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_tabButton[data-tab-id="all"]`).click());assert.ok(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="all"]
        `).classList.contains('o-active'),"'all' tab button should become active");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="chat"]
        `).classList.contains('o-active'),"'chat' tab button should stay inactive");assert.notOk(document.querySelector(`
            .o_MessagingMenu_tabButton[data-tab-id="channel"]
        `).classList.contains('o-active'),"'channel' tab button should become inactive");});QUnit.test('new message',async function(assert){assert.expect(3);await this.start({hasChatWindow:true,});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_newMessageButton`).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,1,"should have open a chat window");assert.ok(document.querySelector(`.o_ChatWindow`).classList.contains('o-new-message'),"chat window should be for new message");assert.ok(document.querySelector(`.o_ChatWindow`).classList.contains('o-focused'),"chat window should be focused");});QUnit.test('no new message when discuss is open',async function(assert){assert.expect(3);await this.start({autoOpenDiscuss:true,hasDiscuss:true,});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_newMessageButton`).length,0,"should not have 'new message' when discuss is open");await afterNextRender(()=>this.discussWidget.on_detach_callback());assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_newMessageButton`).length,1,"should have 'new message' when discuss is closed");await afterNextRender(()=>this.discussWidget.on_attach_callback());assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_newMessageButton`).length,0,"should not have 'new message' when discuss is open again");});QUnit.test('channel preview: basic rendering',async function(assert){assert.expect(9);this.data['res.partner'].records.push({id:7,name:"Demo",});this.data['mail.channel'].records.push({id:20,name:"General",});this.data['mail.message'].records.push({author_id:7,body:"<p>test</p>",channel_ids:[20],model:'mail.channel',res_id:20,});await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu .o_ThreadPreview
        `).length,1,"should have one preview");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_sidebar
        `).length,1,"preview should have a sidebar");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_content
        `).length,1,"preview should have some content");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_header
        `).length,1,"preview should have header in content");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_header
            .o_ThreadPreview_name
        `).length,1,"preview should have name in header of content");assert.strictEqual(document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_name
        `).textContent,"General","preview should have name of channel");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_content
            .o_ThreadPreview_core
        `).length,1,"preview should have core in content");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_core
            .o_ThreadPreview_inlineText
        `).length,1,"preview should have inline text in core of content");assert.strictEqual(document.querySelector(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview_core
            .o_ThreadPreview_inlineText
        `).textContent.trim(),"Demo: test","preview should have message content as inline text of core content");});QUnit.test('filtered previews',async function(assert){assert.expect(12);this.data['mail.channel'].records.push({channel_type:"chat",id:10},{id:20},);this.data['mail.message'].records.push({channel_ids:[10],model:'mail.channel',res_id:10,},{channel_ids:[20],model:'mail.channel',res_id:20,},);await this.start();await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu .o_ThreadPreview`).length,2,"should have 2 previews");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have preview of chat");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have preview of channel");await afterNextRender(()=>document.querySelector('.o_MessagingMenu_tabButton[data-tab-id="chat"]').click());assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu .o_ThreadPreview`).length,1,"should have one preview");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have preview of chat");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,0,"should not have preview of channel");await afterNextRender(()=>document.querySelector('.o_MessagingMenu_tabButton[data-tab-id="channel"]').click());assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview
        `).length,1,"should have one preview");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,0,"should not have preview of chat");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have preview of channel");await afterNextRender(()=>document.querySelector('.o_MessagingMenu_tabButton[data-tab-id="all"]').click());assert.strictEqual(document.querySelectorAll(`.o_MessagingMenu_dropdownMenu .o_ThreadPreview`).length,2,"should have 2 previews");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 10,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have preview of chat");assert.strictEqual(document.querySelectorAll(`
            .o_MessagingMenu_dropdownMenu
            .o_ThreadPreview[data-thread-local-id="${
                this.env.models['mail.thread'].findFromIdentifyingData({
                    id: 20,
                    model: 'mail.channel',
                }).localId
            }"]
        `).length,1,"should have preview of channel");});QUnit.test('open chat window from preview',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({});await this.start({hasChatWindow:true,});await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_toggler`).click());await afterNextRender(()=>document.querySelector(`.o_MessagingMenu_dropdownMenu .o_ThreadPreview`).click());assert.strictEqual(document.querySelectorAll(`.o_ChatWindow`).length,1,"should have open a chat window");});QUnit.test('no code injection in message body preview',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:11});this.data['mail.message'].records.push({body:"<p><em>&shoulnotberaised</em><script>throw new Error('CodeInjectionError');</script></p>",channel_ids:[11],});await this.start();await afterNextRender(()=>{document.querySelector(`.o_MessagingMenu_toggler`).click();});assert.containsOnce(document.body,'.o_MessagingMenu_dropdownMenu .o_ThreadPreview',"should display a preview",);assert.containsOnce(document.body,'.o_ThreadPreview_core',"preview should have core in content",);assert.containsOnce(document.body,'.o_ThreadPreview_inlineText',"preview should have inline text in core of content",);assert.strictEqual(document.querySelector('.o_ThreadPreview_inlineText').textContent.replace(/\s/g,""),"You:&shoulnotberaisedthrownewError('CodeInjectionError');","should display correct uninjected last message inline content");assert.containsNone(document.querySelector('.o_ThreadPreview_inlineText'),'script',"last message inline content should not have any code injection");});QUnit.test('no code injection in message body preview from sanitized message',async function(assert){assert.expect(5);this.data['mail.channel'].records.push({id:11});this.data['mail.message'].records.push({body:"<p>&lt;em&gt;&shoulnotberaised&lt;/em&gt;&lt;script&gt;throw new Error('CodeInjectionError');&lt;/script&gt;</p>",channel_ids:[11],});await this.start();await afterNextRender(()=>{document.querySelector(`.o_MessagingMenu_toggler`).click();});assert.containsOnce(document.body,'.o_MessagingMenu_dropdownMenu .o_ThreadPreview',"should display a preview",);assert.containsOnce(document.body,'.o_ThreadPreview_core',"preview should have core in content",);assert.containsOnce(document.body,'.o_ThreadPreview_inlineText',"preview should have inline text in core of content",);assert.strictEqual(document.querySelector('.o_ThreadPreview_inlineText').textContent.replace(/\s/g,""),"You:<em>&shoulnotberaised</em><script>thrownewError('CodeInjectionError');</script>","should display correct uninjected last message inline content");assert.containsNone(document.querySelector('.o_ThreadPreview_inlineText'),'script',"last message inline content should not have any code injection");});QUnit.test('<br/> tags in message body preview are transformed in spaces',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:11});this.data['mail.message'].records.push({body:"<p>a<br/>b<br>c<br   />d<br     ></p>",channel_ids:[11],});await this.start();await afterNextRender(()=>{document.querySelector(`.o_MessagingMenu_toggler`).click();});assert.containsOnce(document.body,'.o_MessagingMenu_dropdownMenu .o_ThreadPreview',"should display a preview",);assert.containsOnce(document.body,'.o_ThreadPreview_core',"preview should have core in content",);assert.containsOnce(document.body,'.o_ThreadPreview_inlineText',"preview should have inline text in core of content",);assert.strictEqual(document.querySelector('.o_ThreadPreview_inlineText').textContent,"You: a b c d","should display correct last message inline content with brs replaced by spaces");});QUnit.test('rendering with OdooBot has a request (default)',async function(assert){assert.expect(4);await this.start({env:{browser:{Notification:{permission:'default',},},},});assert.ok(document.querySelector('.o_MessagingMenu_counter'),"should display a notification counter next to the messaging menu for OdooBot request");assert.strictEqual(document.querySelector('.o_MessagingMenu_counter').textContent,"1","should display a counter of '1' next to the messaging menu");await afterNextRender(()=>document.querySelector('.o_MessagingMenu_toggler').click());assert.containsOnce(document.body,'.o_NotificationRequest',"should display a notification in the messaging menu");assert.strictEqual(document.querySelector('.o_NotificationRequest_name').textContent.trim(),'OdooBot has a request',"notification should display that OdooBot has a request");});QUnit.test('rendering without OdooBot has a request (denied)',async function(assert){assert.expect(2);await this.start({env:{browser:{Notification:{permission:'denied',},},},});assert.containsNone(document.body,'.o_MessagingMenu_counter',"should not display a notification counter next to the messaging menu");await afterNextRender(()=>document.querySelector('.o_MessagingMenu_toggler').click());assert.containsNone(document.body,'.o_NotificationRequest',"should display no notification in the messaging menu");});QUnit.test('rendering without OdooBot has a request (accepted)',async function(assert){assert.expect(2);await this.start({env:{browser:{Notification:{permission:'granted',},},},});assert.containsNone(document.body,'.o_MessagingMenu_counter',"should not display a notification counter next to the messaging menu");await afterNextRender(()=>document.querySelector('.o_MessagingMenu_toggler').click());assert.containsNone(document.body,'.o_NotificationRequest',"should display no notification in the messaging menu");});QUnit.test('respond to notification prompt (denied)',async function(assert){assert.expect(3);await this.start({env:{browser:{Notification:{permission:'default',async requestPermission(){this.permission='denied';return this.permission;},},},},});await afterNextRender(()=>document.querySelector('.o_MessagingMenu_toggler').click());await afterNextRender(()=>document.querySelector('.o_NotificationRequest').click());assert.containsOnce(document.body,'.toast .o_notification_content',"should display a toast notification with the deny confirmation");assert.containsNone(document.body,'.o_MessagingMenu_counter',"should not display a notification counter next to the messaging menu");await afterNextRender(()=>document.querySelector('.o_MessagingMenu_toggler').click());assert.containsNone(document.body,'.o_NotificationRequest',"should display no notification in the messaging menu");});});});});});;

/* /mail/static/src/components/notification_list/notification_list_notification_group_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/notification_list/notification_list_notification_group_tests.js',function(require){'use strict';const components={NotificationList:require('mail/static/src/components/notification_list/notification_list.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('notification_list',{},function(){QUnit.module('notification_list_notification_group_tests.js',{beforeEach(){beforeEach(this);this.createNotificationListComponent=async({filter='all'}={})=>{await createRootComponent(this,components.NotificationList,{props:{filter},target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('notification group basic layout',async function(assert){assert.expect(10);this.data['mail.message'].records.push({id:11,message_type:'email',model:'mail.channel',res_id:31,res_model_name:"Channel",});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'exception',notification_type:'email',});await this.start();await this.createNotificationListComponent();assert.containsOnce(document.body,'.o_NotificationGroup',"should have 1 notification group");assert.containsOnce(document.body,'.o_NotificationGroup_name',"should have 1 group name");assert.strictEqual(document.querySelector('.o_NotificationGroup_name').textContent,"Channel","should have model name as group name");assert.containsOnce(document.body,'.o_NotificationGroup_counter',"should have 1 group counter");assert.strictEqual(document.querySelector('.o_NotificationGroup_counter').textContent.trim(),"(1)","should have only 1 notification in the group");assert.containsOnce(document.body,'.o_NotificationGroup_date',"should have 1 group date");assert.strictEqual(document.querySelector('.o_NotificationGroup_date').textContent,"a few seconds ago","should have the group date corresponding to now");assert.containsOnce(document.body,'.o_NotificationGroup_inlineText',"should have 1 group text");assert.strictEqual(document.querySelector('.o_NotificationGroup_inlineText').textContent.trim(),"An error occurred when sending an email.","should have the group text corresponding to email");assert.containsOnce(document.body,'.o_NotificationGroup_markAsRead',"should have 1 mark as read button");});QUnit.test('mark as read',async function(assert){assert.expect(6);this.data['mail.message'].records.push({id:11,message_type:'email',model:'mail.channel',res_id:31,res_model_name:"Channel",});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'exception',notification_type:'email',});const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action,'mail.mail_resend_cancel_action',"action should be the one to cancel email");assert.strictEqual(payload.options.additional_context.default_model,'mail.channel',"action should have the group model as default_model");assert.strictEqual(payload.options.additional_context.unread_counter,1,"action should have the group notification length as unread_counter");});await this.start({env:{bus}});await this.createNotificationListComponent();assert.containsOnce(document.body,'.o_NotificationGroup_markAsRead',"should have 1 mark as read button");document.querySelector('.o_NotificationGroup_markAsRead').click();assert.verifySteps(['do_action'],"should do an action to display the cancel email dialog");});QUnit.test('grouped notifications by document',async function(assert){assert.expect(5);this.data['mail.message'].records.push({id:11,message_type:'email',model:'res.partner',res_id:31,res_model_name:"Partner",},{id:12,message_type:'email',model:'res.partner',res_id:31,res_model_name:"Partner",});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'exception',notification_type:'email',},{mail_message_id:12,notification_status:'bounce',notification_type:'email',});await this.start({hasChatWindow:true});await this.createNotificationListComponent();assert.containsOnce(document.body,'.o_NotificationGroup',"should have 1 notification group");assert.containsOnce(document.body,'.o_NotificationGroup_counter',"should have 1 group counter");assert.strictEqual(document.querySelector('.o_NotificationGroup_counter').textContent.trim(),"(2)","should have 2 notifications in the group");assert.containsNone(document.body,'.o_ChatWindow',"should have no chat window initially");await afterNextRender(()=>document.querySelector('.o_NotificationGroup').click());assert.containsOnce(document.body,'.o_ChatWindow',"should have opened the thread in a chat window after clicking on it");});QUnit.test('grouped notifications by document model',async function(assert){assert.expect(12);this.data['mail.message'].records.push({id:11,message_type:'email',model:'res.partner',res_id:31,res_model_name:"Partner",},{id:12,message_type:'email',model:'res.partner',res_id:32,res_model_name:"Partner",});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'exception',notification_type:'email',},{mail_message_id:12,notification_status:'bounce',notification_type:'email',});const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action.name,"Mail Failures","action should have 'Mail Failures' as name",);assert.strictEqual(payload.action.type,'ir.actions.act_window',"action should have the type act_window");assert.strictEqual(payload.action.view_mode,'kanban,list,form',"action should have 'kanban,list,form' as view_mode");assert.strictEqual(JSON.stringify(payload.action.views),JSON.stringify([[false,'kanban'],[false,'list'],[false,'form']]),"action should have correct views");assert.strictEqual(payload.action.target,'current',"action should have 'current' as target");assert.strictEqual(payload.action.res_model,'res.partner',"action should have the group model as res_model");assert.strictEqual(JSON.stringify(payload.action.domain),JSON.stringify([['message_has_error','=',true]]),"action should have 'message_has_error' as domain");});await this.start({env:{bus}});await this.createNotificationListComponent();assert.containsOnce(document.body,'.o_NotificationGroup',"should have 1 notification group");assert.containsOnce(document.body,'.o_NotificationGroup_counter',"should have 1 group counter");assert.strictEqual(document.querySelector('.o_NotificationGroup_counter').textContent.trim(),"(2)","should have 2 notifications in the group");document.querySelector('.o_NotificationGroup').click();assert.verifySteps(['do_action'],"should do an action to display the related records");});QUnit.test('different mail.channel are not grouped',async function(assert){assert.expect(6);this.data['mail.channel'].records.push({id:31},{id:32});this.data['mail.message'].records.push({id:11,message_type:'email',model:'mail.channel',res_id:31,res_model_name:"Channel",},{id:12,message_type:'email',model:'mail.channel',res_id:32,res_model_name:"Channel",});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'exception',notification_type:'email',},{mail_message_id:12,notification_status:'bounce',notification_type:'email',});await this.start({hasChatWindow:true,});await this.createNotificationListComponent();assert.containsN(document.body,'.o_NotificationGroup',2,"should have 2 notifications group");const groups=document.querySelectorAll('.o_NotificationGroup');assert.containsOnce(groups[0],'.o_NotificationGroup_counter',"should have 1 group counter in first group");assert.strictEqual(groups[0].querySelector('.o_NotificationGroup_counter').textContent.trim(),"(1)","should have 1 notification in first group");assert.containsOnce(groups[1],'.o_NotificationGroup_counter',"should have 1 group counter in second group");assert.strictEqual(groups[1].querySelector('.o_NotificationGroup_counter').textContent.trim(),"(1)","should have 1 notification in second group");await afterNextRender(()=>groups[0].click());assert.containsOnce(document.body,'.o_ChatWindow',"should have opened the channel related to the first group in a chat window");});QUnit.test('multiple grouped notifications by document model, sorted by date desc',async function(assert){assert.expect(9);this.data['mail.message'].records.push({date:moment.utc().format("YYYY-MM-DD HH:mm:ss"),id:11,message_type:'email',model:'res.partner',res_id:31,res_model_name:"Partner",},{date:moment.utc().add(1,'days').format("YYYY-MM-DD HH:mm:ss"),id:12,message_type:'email',model:'res.company',res_id:32,res_model_name:"Company",});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'exception',notification_type:'email',},{mail_message_id:12,notification_status:'bounce',notification_type:'email',});await this.start();await this.createNotificationListComponent();assert.containsN(document.body,'.o_NotificationGroup',2,"should have 2 notifications group");const groups=document.querySelectorAll('.o_NotificationGroup');assert.containsOnce(groups[0],'.o_NotificationGroup_name',"should have 1 group name in first group");assert.strictEqual(groups[0].querySelector('.o_NotificationGroup_name').textContent,"Company","should have first model name as group name");assert.containsOnce(groups[0],'.o_NotificationGroup_counter',"should have 1 group counter in first group");assert.strictEqual(groups[0].querySelector('.o_NotificationGroup_counter').textContent.trim(),"(1)","should have 1 notification in first group");assert.containsOnce(groups[1],'.o_NotificationGroup_name',"should have 1 group name in second group");assert.strictEqual(groups[1].querySelector('.o_NotificationGroup_name').textContent,"Partner","should have second model name as group name");assert.containsOnce(groups[1],'.o_NotificationGroup_counter',"should have 1 group counter in second group");assert.strictEqual(groups[1].querySelector('.o_NotificationGroup_counter').textContent.trim(),"(1)","should have 1 notification in second group");});QUnit.test('non-failure notifications are ignored',async function(assert){assert.expect(1);this.data['mail.message'].records.push({id:11,message_type:'email',model:'res.partner',res_id:31,});this.data['mail.notification'].records.push({mail_message_id:11,notification_status:'ready',notification_type:'email',},);await this.start();await this.createNotificationListComponent();assert.containsNone(document.body,'.o_NotificationGroup',"should have 0 notification group");});});});});});;

/* /mail/static/src/components/notification_list/notification_list_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/notification_list/notification_list_tests.js',function(require){'use strict';const components={NotificationList:require('mail/static/src/components/notification_list/notification_list.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('notification_list',{},function(){QUnit.module('notification_list_tests.js',{beforeEach(){beforeEach(this);this.createNotificationListComponent=async({filter='all'})=>{await createRootComponent(this,components.NotificationList,{props:{filter},target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('marked as read thread notifications are ordered by last message date',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:100,name:"Channel 2019"},{id:200,name:"Channel 2020"});this.data['mail.message'].records.push({channel_ids:[100],date:"2019-01-01 00:00:00",id:42,model:'mail.channel',res_id:100,},{channel_ids:[200],date:"2020-01-01 00:00:00",id:43,model:'mail.channel',res_id:200,});await this.start();await this.createNotificationListComponent({filter:'all'});assert.containsN(document.body,'.o_ThreadPreview',2,"there should be two thread previews");const threadPreviewElList=document.querySelectorAll('.o_ThreadPreview');assert.strictEqual(threadPreviewElList[0].querySelector(':scope .o_ThreadPreview_name').textContent,'Channel 2020',"First channel in the list should be the channel of 2020 (more recent last message)");assert.strictEqual(threadPreviewElList[1].querySelector(':scope .o_ThreadPreview_name').textContent,'Channel 2019',"Second channel in the list should be the channel of 2019 (least recent last message)");});QUnit.test('thread notifications are re-ordered on receiving a new message',async function(assert){assert.expect(4);this.data['mail.channel'].records.push({id:100,name:"Channel 2019"},{id:200,name:"Channel 2020"});this.data['mail.message'].records.push({channel_ids:[100],date:"2019-01-01 00:00:00",id:42,model:'mail.channel',res_id:100,},{channel_ids:[200],date:"2020-01-01 00:00:00",id:43,model:'mail.channel',res_id:200,});await this.start();await this.createNotificationListComponent({filter:'all'});assert.containsN(document.body,'.o_ThreadPreview',2,"there should be two thread previews");await afterNextRender(()=>{const messageData={author_id:[7,"Demo User"],body:"<p>New message !</p>",channel_ids:[100],date:"2020-03-23 10:00:00",id:44,message_type:'comment',model:'mail.channel',record_name:'Channel 2019',res_id:100,};this.widget.call('bus_service','trigger','notification',[[['my-db','mail.channel',100],messageData]]);});assert.containsN(document.body,'.o_ThreadPreview',2,"there should still be two thread previews");const threadPreviewElList=document.querySelectorAll('.o_ThreadPreview');assert.strictEqual(threadPreviewElList[0].querySelector(':scope .o_ThreadPreview_name').textContent,'Channel 2019',"First channel in the list should now be 'Channel 2019'");assert.strictEqual(threadPreviewElList[1].querySelector(':scope .o_ThreadPreview_name').textContent,'Channel 2020',"Second channel in the list should now be 'Channel 2020'");});});});});});;

/* /mail/static/src/components/partner_im_status_icon/partner_im_status_icon_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/partner_im_status_icon/partner_im_status_icon_tests.js',function(require){'use strict';const components={PartnerImStatusIcon:require('mail/static/src/components/partner_im_status_icon/partner_im_status_icon.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('partner_im_status_icon',{},function(){QUnit.module('partner_im_status_icon_tests.js',{beforeEach(){beforeEach(this);this.createPartnerImStatusIcon=async partner=>{await createRootComponent(this,components.PartnerImStatusIcon,{props:{partnerLocalId:partner.localId},target:this.widget.el});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('initially online',async function(assert){assert.expect(3);await this.start();const partner=this.env.models['mail.partner'].create({id:7,name:"Demo User",im_status:'online',});await this.createPartnerImStatusIcon(partner);assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon`).length,1,"should have partner IM status icon");assert.strictEqual(document.querySelector(`.o_PartnerImStatusIcon`).dataset.partnerLocalId,partner.localId,"partner IM status icon should be linked to partner with ID 7");assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon.o-online`).length,1,"partner IM status icon should have online status rendering");});QUnit.test('initially offline',async function(assert){assert.expect(1);await this.start();const partner=this.env.models['mail.partner'].create({id:7,name:"Demo User",im_status:'offline',});await this.createPartnerImStatusIcon(partner);assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon.o-offline`).length,1,"partner IM status icon should have offline status rendering");});QUnit.test('initially away',async function(assert){assert.expect(1);await this.start();const partner=this.env.models['mail.partner'].create({id:7,name:"Demo User",im_status:'away',});await this.createPartnerImStatusIcon(partner);assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon.o-away`).length,1,"partner IM status icon should have away status rendering");});QUnit.test('change icon on change partner im_status',async function(assert){assert.expect(4);await this.start();const partner=this.env.models['mail.partner'].create({id:7,name:"Demo User",im_status:'online',});await this.createPartnerImStatusIcon(partner);assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon.o-online`).length,1,"partner IM status icon should have online status rendering");await afterNextRender(()=>partner.update({im_status:'offline'}));assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon.o-offline`).length,1,"partner IM status icon should have offline status rendering");await afterNextRender(()=>partner.update({im_status:'away'}));assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon.o-away`).length,1,"partner IM status icon should have away status rendering");await afterNextRender(()=>partner.update({im_status:'online'}));assert.strictEqual(document.querySelectorAll(`.o_PartnerImStatusIcon.o-online`).length,1,"partner IM status icon should have online status rendering in the end");});});});});});;

/* /mail/static/src/components/thread_icon/thread_icon_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/thread_icon/thread_icon_tests.js',function(require){'use strict';const components={ThreadIcon:require('mail/static/src/components/thread_icon/thread_icon.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('thread_icon',{},function(){QUnit.module('thread_icon_tests.js',{beforeEach(){beforeEach(this);this.createThreadIcon=async thread=>{await createRootComponent(this,components.ThreadIcon,{props:{threadLocalId:thread.localId},target:this.widget.el});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('chat: correspondent is typing',async function(assert){assert.expect(5);this.data['res.partner'].records.push({id:17,im_status:'online',name:'Demo',});this.data['mail.channel'].records.push({channel_type:'chat',id:20,members:[this.data.currentPartnerId,17],});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createThreadIcon(thread);assert.containsOnce(document.body,'.o_ThreadIcon',"should have thread icon");assert.containsOnce(document.body,'.o_ThreadIcon_online',"should have thread icon with partner im status icon 'online'");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.containsOnce(document.body,'.o_ThreadIcon_typing',"should have thread icon with partner currently typing");assert.strictEqual(document.querySelector('.o_ThreadIcon_typing').title,"Demo is typing...","title of icon should tell demo is currently typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:false,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.containsOnce(document.body,'.o_ThreadIcon_online',"should have thread icon with partner im status icon 'online' (no longer typing)");});});});});});;

/* /mail/static/src/components/thread_needaction_preview/thread_needaction_preview_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/thread_needaction_preview/thread_needaction_preview_tests.js',function(require){'use strict';const components={ThreadNeedactionPreview:require('mail/static/src/components/thread_needaction_preview/thread_needaction_preview.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');const Bus=require('web.Bus');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('thread_needaction_preview',{},function(){QUnit.module('thread_needaction_preview_tests.js',{beforeEach(){beforeEach(this);this.createThreadNeedactionPreviewComponent=async props=>{await createRootComponent(this,components.ThreadNeedactionPreview,{props,target:this.widget.el});};this.start=async params=>{const{afterEvent,env,widget}=await start(Object.assign({},params,{data:this.data,}));this.afterEvent=afterEvent;this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('mark as read',async function(assert){assert.expect(5);this.data['mail.message'].records.push({id:21,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:11,});this.data['mail.notification'].records.push({mail_message_id:21,notification_status:'sent',notification_type:'inbox',res_partner_id:this.data.currentPartnerId,});await this.start({hasChatWindow:true,hasMessagingMenu:true,async mockRPC(route,args){if(route.includes('mark_all_as_read')){assert.step('mark_all_as_read');assert.deepEqual(args.kwargs.domain,[['model','=','res.partner'],['res_id','=',11],],"should mark all as read the correct thread");}
return this._super(...arguments);},});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-cache-loaded-messages',func:()=>document.querySelector('.o_MessagingMenu_toggler').click(),message:"should wait until inbox loaded initial needaction messages",predicate:({threadCache})=>{return threadCache.thread.model==='mail.box'&&threadCache.thread.id==='inbox';},}));assert.containsOnce(document.body,'.o_ThreadNeedactionPreview_markAsRead',"should have 1 mark as read button");await afterNextRender(()=>document.querySelector('.o_ThreadNeedactionPreview_markAsRead').click());assert.verifySteps(['mark_all_as_read'],"should have marked the thread as read");assert.containsNone(document.body,'.o_ChatWindow',"should not have opened the thread");});QUnit.test('click on preview should mark as read and open the thread',async function(assert){assert.expect(6);this.data['mail.message'].records.push({id:21,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:11,});this.data['mail.notification'].records.push({mail_message_id:21,notification_status:'sent',notification_type:'inbox',res_partner_id:this.data.currentPartnerId,});await this.start({hasChatWindow:true,hasMessagingMenu:true,async mockRPC(route,args){if(route.includes('mark_all_as_read')){assert.step('mark_all_as_read');assert.deepEqual(args.kwargs.domain,[['model','=','res.partner'],['res_id','=',11],],"should mark all as read the correct thread");}
return this._super(...arguments);},});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-cache-loaded-messages',func:()=>document.querySelector('.o_MessagingMenu_toggler').click(),message:"should wait until inbox loaded initial needaction messages",predicate:({threadCache})=>{return threadCache.thread.model==='mail.box'&&threadCache.thread.id==='inbox';},}));assert.containsOnce(document.body,'.o_ThreadNeedactionPreview',"should have a preview initially");assert.containsNone(document.body,'.o_ChatWindow',"should have no chat window initially");await afterNextRender(()=>document.querySelector('.o_ThreadNeedactionPreview').click());assert.verifySteps(['mark_all_as_read'],"should have marked the message as read on clicking on the preview");assert.containsOnce(document.body,'.o_ChatWindow',"should have opened the thread on clicking on the preview");});QUnit.test('click on expand from chat window should close the chat window and open the form view',async function(assert){assert.expect(8);const bus=new Bus();bus.on('do-action',null,payload=>{assert.step('do_action');assert.strictEqual(payload.action.res_id,11,"should redirect to the id of the thread");assert.strictEqual(payload.action.res_model,'res.partner',"should redirect to the model of the thread");});this.data['mail.message'].records.push({id:21,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:11,});this.data['mail.notification'].records.push({mail_message_id:21,notification_status:'sent',notification_type:'inbox',res_partner_id:this.data.currentPartnerId,});await this.start({env:{bus},hasChatWindow:true,hasMessagingMenu:true,});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-cache-loaded-messages',func:()=>document.querySelector('.o_MessagingMenu_toggler').click(),message:"should wait until inbox loaded initial needaction messages",predicate:({threadCache})=>{return threadCache.thread.model==='mail.box'&&threadCache.thread.id==='inbox';},}));assert.containsOnce(document.body,'.o_ThreadNeedactionPreview',"should have a preview initially");await afterNextRender(()=>document.querySelector('.o_ThreadNeedactionPreview').click());assert.containsOnce(document.body,'.o_ChatWindow',"should have opened the thread on clicking on the preview");assert.containsOnce(document.body,'.o_ChatWindowHeader_commandExpand',"should have an expand button");await afterNextRender(()=>document.querySelector('.o_ChatWindowHeader_commandExpand').click());assert.containsNone(document.body,'.o_ChatWindow',"should have closed the chat window on clicking expand");assert.verifySteps(['do_action'],"should have done an action to open the form view");});QUnit.test('[technical] opening a non-channel chat window should not call channel_fold',async function(assert){assert.expect(3);this.data['mail.message'].records.push({id:21,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:11,});this.data['mail.notification'].records.push({mail_message_id:21,notification_status:'sent',notification_type:'inbox',res_partner_id:this.data.currentPartnerId,});await this.start({hasChatWindow:true,hasMessagingMenu:true,async mockRPC(route,args){if(route.includes('channel_fold')){const message="should not call channel_fold when opening a non-channel chat window";assert.step(message);console.error(message);throw Error(message);}
return this._super(...arguments);},});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-cache-loaded-messages',func:()=>document.querySelector('.o_MessagingMenu_toggler').click(),message:"should wait until inbox loaded initial needaction messages",predicate:({threadCache})=>{return threadCache.thread.model==='mail.box'&&threadCache.thread.id==='inbox';},}));assert.containsOnce(document.body,'.o_ThreadNeedactionPreview',"should have a preview initially");assert.containsNone(document.body,'.o_ChatWindow',"should have no chat window initially");await afterNextRender(()=>document.querySelector('.o_ThreadNeedactionPreview').click());assert.containsOnce(document.body,'.o_ChatWindow',"should have opened the chat window on clicking on the preview");});QUnit.test('preview should display last needaction message preview even if there is a more recent message that is not needaction in the thread',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:11,name:"Stranger",});this.data['mail.message'].records.push({author_id:11,body:"I am the oldest but needaction",id:21,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:11,});this.data['mail.message'].records.push({author_id:this.data.currentPartnerId,body:"I am more recent",id:22,model:'res.partner',res_id:11,});this.data['mail.notification'].records.push({mail_message_id:21,notification_status:'sent',notification_type:'inbox',res_partner_id:this.data.currentPartnerId,});await this.start({hasChatWindow:true,hasMessagingMenu:true,});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-cache-loaded-messages',func:()=>document.querySelector('.o_MessagingMenu_toggler').click(),message:"should wait until inbox loaded initial needaction messages",predicate:({threadCache})=>{return threadCache.thread.model==='mail.box'&&threadCache.thread.id==='inbox';},}));assert.containsOnce(document.body,'.o_ThreadNeedactionPreview_inlineText',"should have a preview from the last message");assert.strictEqual(document.querySelector('.o_ThreadNeedactionPreview_inlineText').textContent,'Stranger: I am the oldest but needaction',"the displayed message should be the one that needs action even if there is a more recent message that is not needaction on the thread");});QUnit.test('needaction preview should only show on its origin thread',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:12});this.data['mail.message'].records.push({channel_ids:[12],id:21,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:11,});this.data['mail.notification'].records.push({mail_message_id:21,notification_status:'sent',notification_type:'inbox',res_partner_id:this.data.currentPartnerId,});await this.start({hasMessagingMenu:true});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-cache-loaded-messages',func:()=>document.querySelector('.o_MessagingMenu_toggler').click(),message:"should wait until inbox loaded initial needaction messages",predicate:({threadCache})=>{return threadCache.thread.model==='mail.box'&&threadCache.thread.id==='inbox';},}));assert.containsOnce(document.body,'.o_ThreadNeedactionPreview',"should have only one preview");const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:11,model:'res.partner',});assert.containsOnce(document.body,`.o_ThreadNeedactionPreview[data-thread-local-id="${thread.localId}"]`,"preview should be on the origin thread");});QUnit.test('chat window header should not have unread counter for non-channel thread',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:11});this.data['mail.message'].records.push({author_id:11,body:'not empty',id:21,model:'res.partner',needaction:true,needaction_partner_ids:[this.data.currentPartnerId],res_id:11,});this.data['mail.notification'].records.push({mail_message_id:21,notification_status:'sent',notification_type:'inbox',res_partner_id:this.data.currentPartnerId,});await this.start({hasChatWindow:true,hasMessagingMenu:true,});await afterNextRender(()=>this.afterEvent({eventName:'o-thread-cache-loaded-messages',func:()=>document.querySelector('.o_MessagingMenu_toggler').click(),message:"should wait until inbox loaded initial needaction messages",predicate:({threadCache})=>{return threadCache.thread.model==='mail.box'&&threadCache.thread.id==='inbox';},}));await afterNextRender(()=>document.querySelector('.o_ThreadNeedactionPreview').click());assert.containsOnce(document.body,'.o_ChatWindow',"should have opened the chat window on clicking on the preview");assert.containsNone(document.body,'.o_ChatWindowHeader_counter',"chat window header should not have unread counter for non-channel thread");});});});});});;

/* /mail/static/src/components/thread_preview/thread_preview_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/thread_preview/thread_preview_tests.js',function(require){'use strict';const components={ThreadPreview:require('mail/static/src/components/thread_preview/thread_preview.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('thread_preview',{},function(){QUnit.module('thread_preview_tests.js',{beforeEach(){beforeEach(this);this.createThreadPreviewComponent=async props=>{await createRootComponent(this,components.ThreadPreview,{props,target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('mark as read',async function(assert){assert.expect(8);this.data['mail.channel'].records.push({id:11,message_unread_counter:1,});this.data['mail.message'].records.push({channel_ids:[11],id:100,model:'mail.channel',res_id:11,});await this.start({hasChatWindow:true,async mockRPC(route,args){if(route.includes('channel_seen')){assert.step('channel_seen');}
return this._super(...arguments);},});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:11,model:'mail.channel',});await this.createThreadPreviewComponent({threadLocalId:thread.localId});assert.containsOnce(document.body,'.o_ThreadPreview_markAsRead',"should have the mark as read button");assert.containsOnce(document.body,'.o_ThreadPreview_counter',"should have an unread counter");await afterNextRender(()=>document.querySelector('.o_ThreadPreview_markAsRead').click());assert.verifySteps(['channel_seen'],"should have marked the thread as seen");assert.hasClass(document.querySelector('.o_ThreadPreview'),'o-muted',"should be muted once marked as read");assert.containsNone(document.body,'.o_ThreadPreview_markAsRead',"should no longer have the mark as read button");assert.containsNone(document.body,'.o_ThreadPreview_counter',"should no longer have an unread counter");assert.containsNone(document.body,'.o_ChatWindow',"should not have opened the thread");});});});});});;

/* /mail/static/src/components/thread_textual_typing_status/thread_textual_typing_status_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/thread_textual_typing_status/thread_textual_typing_status_tests.js',function(require){'use strict';const components={ThreadTextualTypingStatus:require('mail/static/src/components/thread_textual_typing_status/thread_textual_typing_status.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('thread_textual_typing_status',{},function(){QUnit.module('thread_textual_typing_status_tests.js',{beforeEach(){beforeEach(this);this.createThreadTextualTypingStatusComponent=async thread=>{await createRootComponent(this,components.ThreadTextualTypingStatus,{props:{threadLocalId:thread.localId},target:this.widget.el,});};this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},async afterEach(){afterEach(this);},});QUnit.test('receive other member typing status "is typing"',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:17,name:'Demo'});this.data['mail.channel'].records.push({id:20,members:[this.data.currentPartnerId,17],});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createThreadTextualTypingStatusComponent(thread);assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should display no one is currently typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Demo is typing...","Should display that demo user is typing");});QUnit.test('receive other member typing status "is typing" then "no longer is typing"',async function(assert){assert.expect(3);this.data['res.partner'].records.push({id:17,name:'Demo'});this.data['mail.channel'].records.push({id:20,members:[this.data.currentPartnerId,17],});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createThreadTextualTypingStatusComponent(thread);assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should display no one is currently typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Demo is typing...","Should display that demo user is typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:false,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should no longer display that demo user is typing");});QUnit.test('assume other member typing status becomes "no longer is typing" after 60 seconds without any updated typing status',async function(assert){assert.expect(3);this.data['res.partner'].records.push({id:17,name:'Demo'});this.data['mail.channel'].records.push({id:20,members:[this.data.currentPartnerId,17],});await this.start({hasTimeControl:true,});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createThreadTextualTypingStatusComponent(thread);assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should display no one is currently typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Demo is typing...","Should display that demo user is typing");await afterNextRender(()=>this.env.testUtils.advanceTime(60*1000));assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should no longer display that demo user is typing");});QUnit.test('other member typing status "is typing" refreshes 60 seconds timer of assuming no longer typing',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:17,name:'Demo'});this.data['mail.channel'].records.push({id:20,members:[this.data.currentPartnerId,17],});await this.start({hasTimeControl:true,});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createThreadTextualTypingStatusComponent(thread);assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should display no one is currently typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Demo is typing...","Should display that demo user is typing");await this.env.testUtils.advanceTime(50*1000);const typingData={info:'typing_status',is_typing:true,partner_id:17,partner_name:"Demo",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);await this.env.testUtils.advanceTime(50*1000);await nextAnimationFrame();assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Demo is typing...","Should still display that demo user is typing after 100 seconds (refreshed is typing status at 50s => (100 - 50) = 50s < 60s after assuming no-longer typing)");await afterNextRender(()=>this.env.testUtils.advanceTime(11*1000));assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should no longer display that demo user is typing after 111 seconds (refreshed is typing status at 50s => (111 - 50) = 61s > 60s after assuming no-longer typing)");});QUnit.test('receive several other members typing status "is typing"',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:10,name:'Other10'},{id:11,name:'Other11'},{id:12,name:'Other12'});this.data['mail.channel'].records.push({id:20,members:[this.data.currentPartnerId,10,11,12],});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel',});await this.createThreadTextualTypingStatusComponent(thread);assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"","Should display no one is currently typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:10,partner_name:"Other10",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Other10 is typing...","Should display that 'Other10' member is typing");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:11,partner_name:"Other11",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Other10 and Other11 are typing...","Should display that members 'Other10' and 'Other11' are typing (order: longer typer named first)");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:12,partner_name:"Other12",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Other10, Other11 and more are typing...","Should display that members 'Other10', 'Other11' and more (at least 1 extra member) are typing (order: longer typer named first)");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:false,partner_id:10,partner_name:"Other10",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Other11 and Other12 are typing...","Should display that members 'Other11' and 'Other12' are typing ('Other10' stopped typing)");await afterNextRender(()=>{const typingData={info:'typing_status',is_typing:true,partner_id:10,partner_name:"Other10",};const notification=[[false,'mail.channel',20],typingData];this.widget.call('bus_service','trigger','notification',[notification]);});assert.strictEqual(document.querySelector('.o_ThreadTextualTypingStatus').textContent,"Other11, Other12 and more are typing...","Should display that members 'Other11' and 'Other12' and more (at least 1 extra member) are typing (order by longer typer, 'Other10' just recently restarted typing)");});});});});});;

/* /mail/static/src/components/thread_view/thread_view_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/components/thread_view/thread_view_tests.js',function(require){'use strict';const components={ThreadView:require('mail/static/src/components/thread_view/thread_view.js'),};const{afterEach,afterNextRender,beforeEach,createRootComponent,dragenterFiles,start,}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('components',{},function(){QUnit.module('thread_view',{},function(){QUnit.module('thread_view_tests.js',{beforeEach(){beforeEach(this);this.createThreadViewComponent=async(threadView,otherProps={},{isFixedSize=false}={})=>{let target;if(isFixedSize){const div=document.createElement('div');Object.assign(div.style,{display:'flex','flex-flow':'column',height:'300px',});this.widget.el.append(div);target=div;}else{target=this.widget.el;}
const props=Object.assign({threadViewLocalId:threadView.localId},otherProps);await createRootComponent(this,components.ThreadView,{props,target});};this.start=async params=>{const{afterEvent,env,widget}=await start(Object.assign({},params,{data:this.data,}));this.afterEvent=afterEvent;this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('dragover files on thread with composer',async function(assert){assert.expect(1);await this.start();const thread=this.env.models['mail.thread'].create({channel_type:'channel',id:100,members:[['insert',[{email:"john@example.com",id:9,name:"John",},{email:"fred@example.com",id:10,name:"Fred",},]]],model:'mail.channel',name:"General",public:'public',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});await afterNextRender(()=>dragenterFiles(document.querySelector('.o_ThreadView')));assert.ok(document.querySelector('.o_Composer_dropZone'),"should have dropzone when dragging file over the thread");});QUnit.test('message list desc order',async function(assert){assert.expect(5);for(let i=0;i<=60;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[100],model:'mail.channel',res_id:100,});}
await this.start();const thread=this.env.models['mail.thread'].create({channel_type:'channel',id:100,members:[['insert',[{email:"john@example.com",id:9,name:"John",},{email:"fred@example.com",id:10,name:"Fred",},]]],model:'mail.channel',name:"General",public:'public',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>this.createThreadViewComponent(threadViewer.threadView,{order:'desc'},{isFixedSize:true}),message:"should wait until channel 100 loaded initial messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===100);},});const messageItems=document.querySelectorAll(`.o_MessageList_item`);assert.notOk(messageItems[0].classList.contains("o_MessageList_loadMore"),"load more link should NOT be before messages");assert.ok(messageItems[messageItems.length-1].classList.contains("o_MessageList_loadMore"),"load more link should be after messages");assert.strictEqual(document.querySelectorAll(`.o_Message`).length,30,"should have 30 messages at the beginning");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{const messageList=document.querySelector('.o_ThreadView_messageList');messageList.scrollTop=messageList.scrollHeight-messageList.clientHeight;},message:"should wait until channel 100 loaded more messages after scrolling to bottom",predicate:({hint,threadViewer})=>{return(hint.type==='more-messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===100);},});assert.strictEqual(document.querySelectorAll(`.o_Message`).length,60,"should have 60 messages after scrolled to bottom");await afterNextRender(()=>{document.querySelector(`.o_ThreadView_messageList`).scrollTop=0;});assert.strictEqual(document.querySelectorAll(`.o_Message`).length,60,"scrolling to top should not trigger any message fetching");});QUnit.test('message list asc order',async function(assert){assert.expect(5);for(let i=0;i<=60;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[100],model:'mail.channel',res_id:100,});}
await this.start();const thread=this.env.models['mail.thread'].create({channel_type:'channel',id:100,members:[['insert',[{email:"john@example.com",id:9,name:"John",},{email:"fred@example.com",id:10,name:"Fred",},]]],model:'mail.channel',name:"General",public:'public',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>this.createThreadViewComponent(threadViewer.threadView,{order:'asc'},{isFixedSize:true}),message:"should wait until channel 100 loaded initial messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===100);},});const messageItems=document.querySelectorAll(`.o_MessageList_item`);assert.notOk(messageItems[messageItems.length-1].classList.contains("o_MessageList_loadMore"),"load more link should be before messages");assert.ok(messageItems[0].classList.contains("o_MessageList_loadMore"),"load more link should NOT be after messages");assert.strictEqual(document.querySelectorAll(`.o_Message`).length,30,"should have 30 messages at the beginning");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>document.querySelector(`.o_ThreadView_messageList`).scrollTop=0,message:"should wait until channel 100 loaded more messages after scrolling to top",predicate:({hint,threadViewer})=>{return(hint.type==='more-messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===100);},});assert.strictEqual(document.querySelectorAll(`.o_Message`).length,60,"should have 60 messages after scrolled to top");await afterNextRender(()=>{document.querySelector(`.o_ThreadView_messageList`).scrollTop=document.querySelector(`.o_ThreadView_messageList`).scrollHeight;});assert.strictEqual(document.querySelectorAll(`.o_Message`).length,60,"scrolling to bottom should not trigger any message fetching");});QUnit.test('mark channel as fetched when a new message is loaded and as seen when focusing composer [REQUIRE FOCUS]',async function(assert){assert.expect(8);this.data['res.partner'].records.push({email:"fred@example.com",id:10,name:"Fred",});this.data['res.users'].records.push({id:10,partner_id:10,});this.data['mail.channel'].records.push({channel_type:'chat',id:100,is_pinned:true,members:[this.data.currentPartnerId,10],});await this.start({mockRPC(route,args){if(args.method==='channel_fetched'){assert.strictEqual(args.args[0][0],100,'channel_fetched is called on the right channel id');assert.strictEqual(args.model,'mail.channel','channel_fetched is called on the right channel model');assert.step('rpc:channel_fetch');}else if(args.method==='channel_seen'){assert.strictEqual(args.args[0][0],100,'channel_seen is called on the right channel id');assert.strictEqual(args.model,'mail.channel','channel_seeb is called on the right channel model');assert.step('rpc:channel_seen');}
return this._super(...arguments);}});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});await afterNextRender(async()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:10,},message_content:"new message",uuid:thread.uuid,},}));assert.verifySteps(['rpc:channel_fetch'],"Channel should have been fetched but not seen yet");await afterNextRender(()=>this.afterEvent({eventName:'o-thread-last-seen-by-current-partner-message-id-changed',func:()=>document.querySelector('.o_ComposerTextInput_textarea').focus(),message:"should wait until last seen by current partner message id changed after focusing the thread",predicate:({thread})=>{return(thread.id===100&&thread.model==='mail.channel');},}));assert.verifySteps(['rpc:channel_seen'],"Channel should have been marked as seen after threadView got the focus");});QUnit.test('mark channel as fetched and seen when a new message is loaded if composer is focused [REQUIRE FOCUS]',async function(assert){assert.expect(4);this.data['res.partner'].records.push({id:10,});this.data['res.users'].records.push({id:10,partner_id:10,});this.data['mail.channel'].records.push({id:100,});await this.start({mockRPC(route,args){if(args.method==='channel_fetched'&&args.args[0]===100){throw new Error("'channel_fetched' RPC must not be called for created channel as message is directly seen");}else if(args.method==='channel_seen'){assert.strictEqual(args.args[0][0],100,'channel_seen is called on the right channel id');assert.strictEqual(args.model,'mail.channel','channel_seen is called on the right channel model');assert.step('rpc:channel_seen');}
return this._super(...arguments);}});const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});document.querySelector('.o_ComposerTextInput_textarea').focus();await this.afterEvent({eventName:'o-thread-last-seen-by-current-partner-message-id-changed',func:()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:10,},message_content:"<p>fdsfsd</p>",uuid:thread.uuid,},}),message:"should wait until last seen by current partner message id changed after receiving a message while thread is focused",predicate:({thread})=>{return(thread.id===100&&thread.model==='mail.channel');},});assert.verifySteps(['rpc:channel_seen'],"Channel should have been mark as seen directly");});QUnit.test('show message subject if thread is mailing channel',async function(assert){assert.expect(3);this.data['mail.message'].records.push({body:"not empty",channel_ids:[100],model:'mail.channel',res_id:100,subject:"Salutations, voyageur",});await this.start();const thread=this.env.models['mail.thread'].create({channel_type:'channel',id:100,mass_mailing:true,model:'mail.channel',name:"General",public:'public',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView);assert.containsOnce(document.body,'.o_Message',"should display a single message");assert.containsOnce(document.body,'.o_Message_subject',"should display subject of the message");assert.strictEqual(document.querySelector('.o_Message_subject').textContent,"Subject: Salutations, voyageur","Subject of the message should be 'Salutations, voyageur'");});QUnit.test('[technical] new messages separator on posting message',async function(assert){assert.expect(4);this.data['mail.channel'].records=[{channel_type:'channel',id:20,is_pinned:true,message_unread_counter:0,seen_message_id:10,name:"General",}];this.data['mail.message'].records.push({body:"first message",channel_ids:[20],id:10,});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});assert.containsOnce(document.body,'.o_Message',"should display one message in thread initially");assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"should not display 'new messages' separator");document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>document.execCommand('insertText',false,"hey !"));await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').focus();document.querySelector('.o_Composer_buttonSend').click();});assert.containsN(document.body,'.o_Message',2,"should display 2 messages (initial & newly posted), after posting a message");assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"still no separator shown when current partner posted a message");});QUnit.test('new messages separator on receiving new message [REQUIRE FOCUS]',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:11,name:"Foreigner partner",});this.data['res.users'].records.push({id:42,name:"Foreigner user",partner_id:11,});this.data['mail.channel'].records.push({channel_type:'channel',id:20,is_pinned:true,message_unread_counter:0,name:"General",seen_message_id:1,uuid:'randomuuid',});this.data['mail.message'].records.push({body:"blah",channel_ids:[20],id:1,});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});assert.containsOnce(document.body,'.o_MessageList_message',"should have an initial message");assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"should not display 'new messages' separator");document.querySelector('.o_ComposerTextInput_textarea').blur();await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:42,},message_content:"hu",uuid:thread.uuid,},}),message:"should wait until new message is received",predicate:({hint,threadViewer})=>{return(threadViewer.thread.id===20&&threadViewer.thread.model==='mail.channel'&&hint.type==='message-received');},});assert.containsN(document.body,'.o_Message',2,"should now have 2 messages after receiving a new message");assert.containsOnce(document.body,'.o_MessageList_separatorNewMessages',"'new messages' separator should be shown");assert.containsOnce(document.body,`.o_MessageList_separatorNewMessages ~ .o_Message[data-message-local-id="${
            this.env.models['mail.message'].findFromIdentifyingData({ id: 2 }).localId
        }"]`,"'new messages' separator should be shown above new message received");await afterNextRender(()=>this.afterEvent({eventName:'o-thread-last-seen-by-current-partner-message-id-changed',func:()=>document.querySelector('.o_ComposerTextInput_textarea').focus(),message:"should wait until last seen by current partner message id changed after focusing the thread",predicate:({thread})=>{return(thread.id===20&&thread.model==='mail.channel');},}));assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"'new messages' separator should no longer be shown as last message has been seen");});QUnit.test('new messages separator on posting message',async function(assert){assert.expect(4);this.data['mail.channel'].records=[{channel_type:'channel',id:20,is_pinned:true,message_unread_counter:0,name:"General",}];await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});assert.containsNone(document.body,'.o_MessageList_message',"should have no messages");assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"should not display 'new messages' separator");document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>document.execCommand('insertText',false,"hey !"));await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.containsOnce(document.body,'.o_Message',"should have the message current partner just posted");assert.containsNone(document.body,'.o_MessageList_separatorNewMessages',"still no separator shown when current partner posted a message");});QUnit.test('basic rendering of canceled notification',async function(assert){assert.expect(8);this.data['mail.channel'].records.push({id:11});this.data['res.partner'].records.push({id:12,name:"Someone"});this.data['mail.message'].records.push({body:"not empty",channel_ids:[11],id:10,message_type:'email',model:'mail.channel',notification_ids:[11],res_id:11,});this.data['mail.notification'].records.push({failure_type:'SMTP',id:11,mail_message_id:10,notification_status:'canceled',notification_type:'email',res_partner_id:12,});await this.start();const threadViewer=await this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel',}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView);},message:"thread become loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsOnce(document.body,'.o_Message_notificationIconClickable',"should display the notification icon container on the message");assert.containsOnce(document.body,'.o_Message_notificationIcon',"should display the notification icon on the message");assert.hasClass(document.querySelector('.o_Message_notificationIcon'),'fa-envelope-o',"notification icon shown on the message should represent email");await afterNextRender(()=>{document.querySelector('.o_Message_notificationIconClickable').click();});assert.containsOnce(document.body,'.o_NotificationPopover',"notification popover should be opened after notification has been clicked");assert.containsOnce(document.body,'.o_NotificationPopover_notificationIcon',"an icon should be shown in notification popover");assert.containsOnce(document.body,'.o_NotificationPopover_notificationIcon.fa.fa-trash-o',"the icon shown in notification popover should be the canceled icon");assert.containsOnce(document.body,'.o_NotificationPopover_notificationPartnerName',"partner name should be shown in notification popover");assert.strictEqual(document.querySelector('.o_NotificationPopover_notificationPartnerName').textContent.trim(),"Someone","partner name shown in notification popover should be the one concerned by the notification");});QUnit.test('should scroll to bottom on receiving new message if the list is initially scrolled to bottom (asc order)',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:11,name:"Foreigner partner",});this.data['res.users'].records.push({id:42,name:"Foreigner user",partner_id:11,});this.data['mail.channel'].records.push({id:20});for(let i=0;i<=10;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],});}
await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>this.createThreadViewComponent(threadViewer.threadView,{order:'asc'},{isFixedSize:true},),message:"should wait until channel 20 scrolled initially",predicate:data=>threadViewer===data.threadViewer,});const initialMessageList=document.querySelector('.o_ThreadView_messageList');assert.strictEqual(initialMessageList.scrollTop,initialMessageList.scrollHeight-initialMessageList.clientHeight,"should have scrolled to bottom of channel 20 initially");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:42,},message_content:"hello",uuid:thread.uuid,},}),message:"should wait until channel 20 scrolled after receiving a message",predicate:data=>threadViewer===data.threadViewer,});const messageList=document.querySelector('.o_ThreadView_messageList');assert.strictEqual(messageList.scrollTop,messageList.scrollHeight-messageList.clientHeight,"should scroll to bottom on receiving new message because the list is initially scrolled to bottom");});QUnit.test('should not scroll on receiving new message if the list is initially scrolled anywhere else than bottom (asc order)',async function(assert){assert.expect(3);this.data['res.partner'].records.push({id:11,name:"Foreigner partner",});this.data['res.users'].records.push({id:42,name:"Foreigner user",partner_id:11,});this.data['mail.channel'].records.push({id:20});for(let i=0;i<=10;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[20],});}
await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>this.createThreadViewComponent(threadViewer.threadView,{order:'asc'},{isFixedSize:true},),message:"should wait until channel 20 scrolled initially",predicate:data=>threadViewer===data.threadViewer,});const initialMessageList=document.querySelector('.o_ThreadView_messageList');assert.strictEqual(initialMessageList.scrollTop,initialMessageList.scrollHeight-initialMessageList.clientHeight,"should have scrolled to bottom of channel 20 initially");await this.afterEvent({eventName:'o-component-message-list-scrolled',func:()=>initialMessageList.scrollTop=0,message:"should wait until channel 20 processed manual scroll",predicate:data=>threadViewer===data.threadViewer,});assert.strictEqual(initialMessageList.scrollTop,0,"should have scrolled to the top of channel 20 manually");await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:42,},message_content:"hello",uuid:thread.uuid,},}),message:"should wait until channel 20 processed new message hint",predicate:data=>threadViewer===data.threadViewer&&data.hint.type==='message-received',});assert.strictEqual(document.querySelector('.o_ThreadView_messageList').scrollTop,0,"should not scroll on receiving new message because the list is initially scrolled anywhere else than bottom");});QUnit.test("delete all attachments of message without content should no longer display the message",async function(assert){assert.expect(2);this.data['ir.attachment'].records.push({id:143,mimetype:'text/plain',name:"Blah.txt",});this.data['mail.channel'].records.push({id:11});this.data['mail.message'].records.push({attachment_ids:[143],channel_ids:[11],id:101,});await this.start();const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel'}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView);},message:"thread become loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsOnce(document.body,'.o_Message',"there should be 1 message displayed initially");await afterNextRender(()=>{document.querySelector(`.o_Attachment[data-attachment-local-id="${
            this.env.models['mail.attachment'].findFromIdentifyingData({ id: 143 }).localId
        }"] .o_Attachment_asideItemUnlink`).click();});await afterNextRender(()=>document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click());assert.containsNone(document.body,'.o_Message',"message should no longer be displayed after removing all its attachments (empty content)");});QUnit.test('delete all attachments of a message with some text content should still keep it displayed',async function(assert){assert.expect(2);this.data['ir.attachment'].records.push({id:143,mimetype:'text/plain',name:"Blah.txt",});this.data['mail.channel'].records.push({id:11});this.data['mail.message'].records.push({attachment_ids:[143],body:"Some content",channel_ids:[11],id:101,},);await this.start();const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel'}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView);},message:"thread become loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsOnce(document.body,'.o_Message',"there should be 1 message displayed initially");await afterNextRender(()=>{document.querySelector(`.o_Attachment[data-attachment-local-id="${
            this.env.models['mail.attachment'].findFromIdentifyingData({ id: 143 }).localId
        }"] .o_Attachment_asideItemUnlink`).click();});await afterNextRender(()=>document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click());assert.containsOnce(document.body,'.o_Message',"message should still be displayed after removing its attachments (non-empty content)");});QUnit.test('delete all attachments of a message with tracking fields should still keep it displayed',async function(assert){assert.expect(2);this.data['ir.attachment'].records.push({id:143,mimetype:'text/plain',name:"Blah.txt",});this.data['mail.channel'].records.push({id:11});this.data['mail.message'].records.push({attachment_ids:[143],channel_ids:[11],id:101,tracking_value_ids:[6]},);this.data['mail.tracking.value'].records.push({changed_field:"Name",field_type:"char",id:6,new_value:"New name",old_value:"Old name",});await this.start();const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel'}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView);},message:"thread become loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsOnce(document.body,'.o_Message',"there should be 1 message displayed initially");await afterNextRender(()=>{document.querySelector(`.o_Attachment[data-attachment-local-id="${
            this.env.models['mail.attachment'].findFromIdentifyingData({ id: 143 }).localId
        }"] .o_Attachment_asideItemUnlink`).click();});await afterNextRender(()=>document.querySelector('.o_AttachmentDeleteConfirmDialog_confirmButton').click());assert.containsOnce(document.body,'.o_Message',"message should still be displayed after removing its attachments (non-empty content)");});QUnit.test('Post a message containing an email address followed by a mention on another line',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:11});this.data['res.partner'].records.push({id:25,email:"testpartner@odoo.com",name:"TestPartner",});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:11,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>document.execCommand('insertText',false,"email@odoo.com\n"));await afterNextRender(()=>{["@","T","e"].forEach((char)=>{document.execCommand('insertText',false,char);document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});});await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});assert.containsOnce(document.querySelector(`.o_Message_content`),`.o_mail_redirect[data-oe-id="25"][data-oe-model="res.partner"]:contains("@TestPartner")`,"Conversation should have a message that has been posted, which contains partner mention");});QUnit.test(`Mention a partner with special character (e.g. apostrophe ')`,async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:11});this.data['res.partner'].records.push({id:1952,email:"usatyi@example.com",name:"Pynya's spokesman",});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:11,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>{["@","P","y","n"].forEach((char)=>{document.execCommand('insertText',false,char);document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});});await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});assert.containsOnce(document.querySelector(`.o_Message_content`),`.o_mail_redirect[data-oe-id="1952"][data-oe-model="res.partner"]:contains("@Pynya's spokesman")`,"Conversation should have a message that has been posted, which contains partner mention");});QUnit.test('mention 2 different partners that have the same name',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:11});this.data['res.partner'].records.push({id:25,email:"partner1@example.com",name:"TestPartner",},{id:26,email:"partner2@example.com",name:"TestPartner",},);await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:11,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>{["@","T","e"].forEach((char)=>{document.execCommand('insertText',false,char);document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});});await afterNextRender(()=>document.querySelectorAll('.o_ComposerSuggestion')[0].click());await afterNextRender(()=>{["@","T","e"].forEach((char)=>{document.execCommand('insertText',false,char);document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});});await afterNextRender(()=>document.querySelectorAll('.o_ComposerSuggestion')[1].click());await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.containsOnce(document.body,'.o_Message_content','should have one message after posting it');assert.containsOnce(document.querySelector(`.o_Message_content`),`.o_mail_redirect[data-oe-id="25"][data-oe-model="res.partner"]:contains("@TestPartner")`,"message should contain the first partner mention");assert.containsOnce(document.querySelector(`.o_Message_content`),`.o_mail_redirect[data-oe-id="26"][data-oe-model="res.partner"]:contains("@TestPartner")`,"message should also contain the second partner mention");});QUnit.test('mention a channel with space in the name',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:7,name:"General good boy",});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:7,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"#");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});assert.containsOnce(document.querySelector('.o_Message_content'),'.o_channel_redirect',"message must contain a link to the mentioned channel");assert.strictEqual(document.querySelector('.o_channel_redirect').textContent,'#General good boy',"link to the channel must contains # + the channel name");});QUnit.test('mention a channel with "&" in the name',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:7,name:"General & good",});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:7,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"#");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});await afterNextRender(()=>document.querySelector('.o_ComposerSuggestion').click());await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});assert.containsOnce(document.querySelector('.o_Message_content'),'.o_channel_redirect',"message should contain a link to the mentioned channel");assert.strictEqual(document.querySelector('.o_channel_redirect').textContent,'#General & good',"link to the channel must contains # + the channel name");});QUnit.test('mention a channel on a second line when the first line contains #',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:7,name:"General good",});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:7,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"#blabla\n#");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});await afterNextRender(()=>{document.querySelector('.o_ComposerSuggestion').click();});await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});assert.containsOnce(document.querySelector('.o_Message_content'),'.o_channel_redirect',"message should contain a link to the mentioned channel");assert.strictEqual(document.querySelector('.o_channel_redirect').textContent,'#General good',"link to the channel must contains # + the channel name");});QUnit.test('mention a channel when replacing the space after the mention by another char',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:7,name:"General good",});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:7,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});await afterNextRender(()=>{document.querySelector(`.o_ComposerTextInput_textarea`).focus();document.execCommand('insertText',false,"#");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});await afterNextRender(()=>{document.querySelector('.o_ComposerSuggestion').click();});await afterNextRender(()=>{const text=document.querySelector(`.o_ComposerTextInput_textarea`).value;document.querySelector(`.o_ComposerTextInput_textarea`).value=text.slice(0,-1);document.execCommand('insertText',false,", test");document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});assert.containsOnce(document.querySelector('.o_Message_content'),'.o_channel_redirect',"message should contain a link to the mentioned channel");assert.strictEqual(document.querySelector('.o_channel_redirect').textContent,'#General good',"link to the channel must contains # + the channel name");});QUnit.test('mention 2 different channels that have the same name',async function(assert){assert.expect(3);this.data['mail.channel'].records.push({id:11,name:"my channel",},{id:12,name:"my channel",},);await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:11,model:'mail.channel',});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>{["#","m","y"].forEach((char)=>{document.execCommand('insertText',false,char);document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});});await afterNextRender(()=>document.querySelectorAll('.o_ComposerSuggestion')[0].click());await afterNextRender(()=>{["#","m","y"].forEach((char)=>{document.execCommand('insertText',false,char);document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keydown'));document.querySelector(`.o_ComposerTextInput_textarea`).dispatchEvent(new window.KeyboardEvent('keyup'));});});await afterNextRender(()=>document.querySelectorAll('.o_ComposerSuggestion')[1].click());await afterNextRender(()=>document.querySelector('.o_Composer_buttonSend').click());assert.containsOnce(document.body,'.o_Message_content','should have one message after posting it');assert.containsOnce(document.querySelector(`.o_Message_content`),`.o_channel_redirect[data-oe-id="11"][data-oe-model="mail.channel"]:contains("#my channel")`,"message should contain the first channel mention");assert.containsOnce(document.querySelector(`.o_Message_content`),`.o_channel_redirect[data-oe-id="12"][data-oe-model="mail.channel"]:contains("#my channel")`,"message should also contain the second channel mention");});QUnit.test('show empty placeholder when thread contains no message',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:11});await this.start();const threadViewer=await this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel',}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView);},message:"should wait until thread becomes loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsOnce(document.body,'.o_MessageList_empty',"message list empty placeholder should be shown as thread does not contain any messages");assert.containsNone(document.body,'.o_Message',"no message should be shown as thread does not contain any");});QUnit.test('show empty placeholder when thread contains only empty messages',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:11});this.data['mail.message'].records.push({channel_ids:[11],id:101,},);await this.start();const threadViewer=await this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel',}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView);},message:"thread become loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsOnce(document.body,'.o_MessageList_empty',"message list empty placeholder should be shown as thread contain only empty messages");assert.containsNone(document.body,'.o_Message',"no message should be shown as thread contains only empty ones");});QUnit.test('message with subtype should be displayed (and not considered as empty)',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:11});this.data['mail.message.subtype'].records.push({description:"Task created",id:10,});this.data['mail.message'].records.push({channel_ids:[11],id:101,subtype_id:10,},);await this.start();const threadViewer=await this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel',}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView);},message:"should wait until thread becomes loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsOnce(document.body,'.o_Message',"should display 1 message (message with subtype description 'task created')");assert.strictEqual(document.body.querySelector('.o_Message_content').textContent,"Task created","message should have 'Task created' (from its subtype description)");});QUnit.test('[technical] message list with a full page of empty messages should show load more if there are other messages',async function(assert){assert.expect(2);this.data['mail.channel'].records.push({id:11,});for(let i=0;i<=30;i++){this.data['mail.message'].records.push({body:"not empty",channel_ids:[11],});}
for(let i=0;i<=30;i++){this.data['mail.message'].records.push({channel_ids:[11],});}
await this.start();const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['insert',{id:11,model:'mail.channel',}]],});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>{this.createThreadViewComponent(threadViewer.threadView,{order:'asc'},{isFixedSize:true});},message:"should wait until thread becomes loaded with messages",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='mail.channel'&&threadViewer.thread.id===11);},});assert.containsNone(document.body,'.o_Message',"No message should be shown as all 30 first messages are empty");assert.containsOnce(document.body,'.o_MessageList_loadMore',"Load more button should be shown as there are more messages to show");});QUnit.test('first unseen message should be directly preceded by the new message separator if there is a transient message just before it while composer is not focused [REQUIRE FOCUS]',async function(assert){assert.expect(3);this.data['mail.channel_command'].records.push({name:'who'});this.data['res.partner'].records.push({id:11,name:"Foreigner partner",});this.data['res.users'].records.push({id:42,name:"Foreigner user",partner_id:11,});this.data['mail.channel'].records=[{channel_type:'channel',id:20,is_pinned:true,name:"General",uuid:'channel20uuid',}];await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>document.execCommand('insertText',false,"/who"));await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});document.querySelector('.o_ComposerTextInput_textarea').blur();await afterNextRender(()=>this.env.services.rpc({route:'/mail/chat_post',params:{context:{mockedUserId:42,},message_content:"test",uuid:'channel20uuid',},}));assert.containsN(document.body,'.o_Message',2,"should display 2 messages (the transient & the received message), after posting a command");assert.containsOnce(document.body,'.o_MessageList_separatorNewMessages',"separator should be shown as a message has been received");assert.containsOnce(document.body,`.o_Message[data-message-local-id="${
            this.env.models['mail.message'].find(m => m.isTransient).localId
        }"] + .o_MessageList_separatorNewMessages`,"separator should be shown just after transient message");});QUnit.test('composer should be focused automatically after clicking on the send button [REQUIRE FOCUS]',async function(assert){assert.expect(1);this.data['mail.channel'].records.push({id:20,});await this.start();const thread=this.env.models['mail.thread'].findFromIdentifyingData({id:20,model:'mail.channel'});const threadViewer=this.env.models['mail.thread_viewer'].create({hasThreadView:true,thread:[['link',thread]],});await this.createThreadViewComponent(threadViewer.threadView,{hasComposer:true});document.querySelector('.o_ComposerTextInput_textarea').focus();await afterNextRender(()=>document.execCommand('insertText',false,"Dummy Message"));await afterNextRender(()=>{document.querySelector('.o_Composer_buttonSend').click();});assert.hasClass(document.querySelector('.o_Composer'),'o-focused',"composer should be focused automatically after clicking on the send button");});});});});});;

/* /mail/static/src/models/attachment/attachment_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/models/attachment/attachment_tests.js',function(require){'use strict';const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('models',{},function(){QUnit.module('attachment',{},function(){QUnit.module('attachment_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('create (txt)',async function(assert){assert.expect(9);await this.start();assert.notOk(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});assert.ok(attachment);assert.ok(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}),attachment);assert.strictEqual(attachment.filename,"test.txt");assert.strictEqual(attachment.id,750);assert.notOk(attachment.isTemporary);assert.strictEqual(attachment.mimetype,'text/plain');assert.strictEqual(attachment.name,"test.txt");});QUnit.test('displayName',async function(assert){assert.expect(5);await this.start();assert.notOk(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});assert.ok(attachment);assert.ok(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(attachment,this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(attachment.displayName,"test.txt");});QUnit.test('extension',async function(assert){assert.expect(5);await this.start();assert.notOk(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});assert.ok(attachment);assert.ok(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(attachment,this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(attachment.extension,'txt');});QUnit.test('fileType',async function(assert){assert.expect(5);await this.start();assert.notOk(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});assert.ok(attachment);assert.ok(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(attachment,this.env.models['mail.attachment'].findFromIdentifyingData({id:750,}));assert.strictEqual(attachment.fileType,'text');});QUnit.test('isTextFile',async function(assert){assert.expect(5);await this.start();assert.notOk(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});assert.ok(attachment);assert.ok(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(attachment,this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.ok(attachment.isTextFile);});QUnit.test('isViewable',async function(assert){assert.expect(5);await this.start();assert.notOk(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));const attachment=this.env.models['mail.attachment'].create({filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",});assert.ok(attachment);assert.ok(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.strictEqual(attachment,this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.ok(attachment.isViewable);});});});});});;

/* /mail/static/src/models/message/message_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/models/message/message_tests.js',function(require){'use strict';const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');const{str_to_datetime}=require('web.time');QUnit.module('mail',{},function(){QUnit.module('models',{},function(){QUnit.module('message',{},function(){QUnit.module('message_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('create',async function(assert){assert.expect(31);await this.start();assert.notOk(this.env.models['mail.partner'].findFromIdentifyingData({id:5}));assert.notOk(this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',}));assert.notOk(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.notOk(this.env.models['mail.message'].findFromIdentifyingData({id:4000}));const thread=this.env.models['mail.thread'].create({id:100,model:'mail.channel',name:"General",});const message=this.env.models['mail.message'].create({attachments:[['insert-and-replace',{filename:"test.txt",id:750,mimetype:'text/plain',name:"test.txt",}]],author:[['insert',{id:5,display_name:"Demo"}]],body:"<p>Test</p>",date:moment(str_to_datetime("2019-05-05 10:00:00")),id:4000,isNeedaction:true,isStarred:true,originThread:[['link',thread]],});assert.ok(this.env.models['mail.partner'].findFromIdentifyingData({id:5}));assert.ok(this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',}));assert.ok(this.env.models['mail.attachment'].findFromIdentifyingData({id:750}));assert.ok(this.env.models['mail.message'].findFromIdentifyingData({id:4000}));assert.ok(message);assert.strictEqual(this.env.models['mail.message'].findFromIdentifyingData({id:4000}),message);assert.strictEqual(message.body,"<p>Test</p>");assert.ok(message.date instanceof moment);assert.strictEqual(moment(message.date).utc().format('YYYY-MM-DD hh:mm:ss'),"2019-05-05 10:00:00");assert.strictEqual(message.id,4000);assert.strictEqual(message.originThread,this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',}));assert.ok(message.threads.includes(this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',})));assert.ok(message.threads.includes(this.env.messaging.inbox));assert.ok(message.threads.includes(this.env.messaging.starred));const attachment=this.env.models['mail.attachment'].findFromIdentifyingData({id:750});assert.ok(attachment);assert.strictEqual(attachment.filename,"test.txt");assert.strictEqual(attachment.id,750);assert.notOk(attachment.isTemporary);assert.strictEqual(attachment.mimetype,'text/plain');assert.strictEqual(attachment.name,"test.txt");const channel=this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',});assert.ok(channel);assert.strictEqual(channel.model,'mail.channel');assert.strictEqual(channel.id,100);assert.strictEqual(channel.name,"General");const partner=this.env.models['mail.partner'].findFromIdentifyingData({id:5});assert.ok(partner);assert.strictEqual(partner.display_name,"Demo");assert.strictEqual(partner.id,5);});QUnit.test('message without body should be considered empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({id:11});assert.ok(message.isEmpty);});QUnit.test('message with body "" should be considered empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"",id:11});assert.ok(message.isEmpty);});QUnit.test('message with body "<p></p>" should be considered empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"<p></p>",id:11});assert.ok(message.isEmpty);});QUnit.test('message with body "<p><br></p>" should be considered empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"<p><br></p>",id:11});assert.ok(message.isEmpty);});QUnit.test('message with body "<p><br/></p>" should be considered empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"<p><br/></p>",id:11});assert.ok(message.isEmpty);});QUnit.test(String.raw`message with body "<p>\n</p>" should be considered empty`,async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"<p>\n</p>",id:11});assert.ok(message.isEmpty);});QUnit.test(String.raw`message with body "<p>\r\n\r\n</p>" should be considered empty`,async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"<p>\r\n\r\n</p>",id:11});assert.ok(message.isEmpty);});QUnit.test('message with body "<p>   </p>  " should be considered empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"<p>   </p>  ",id:11});assert.ok(message.isEmpty);});QUnit.test(`message with body "<img src=''>" should not be considered empty`,async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"<img src=''>",id:11});assert.notOk(message.isEmpty);});QUnit.test('message with body "test" should not be considered empty',async function(assert){assert.expect(1);await this.start();const message=this.env.models['mail.message'].create({body:"test",id:11});assert.notOk(message.isEmpty);});});});});});;

/* /mail/static/src/models/messaging/messaging_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/models/messaging/messaging_tests.js',function(require){'use strict';const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('models',{},function(){QUnit.module('messaging',{},function(){QUnit.module('messaging_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},},function(){QUnit.test('openChat: display notification for partner without user',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:14});await this.start();await this.env.messaging.openChat({partnerId:14});assert.containsOnce(document.body,'.toast .o_notification_content',"should display a toast notification after failing to open chat");assert.strictEqual(document.querySelector('.o_notification_content').textContent,"You can only chat with partners that have a dedicated user.","should display the correct information in the notification");});QUnit.test('openChat: display notification for wrong user',async function(assert){assert.expect(2);await this.start();await this.env.messaging.openChat({userId:14});assert.containsOnce(document.body,'.toast .o_notification_content',"should display a toast notification after failing to open chat");assert.strictEqual(document.querySelector('.o_notification_content').textContent,"You can only chat with existing users.","should display the correct information in the notification");});QUnit.test('openChat: open new chat for user',async function(assert){assert.expect(3);this.data['res.partner'].records.push({id:14});this.data['res.users'].records.push({id:11,partner_id:14});await this.start();const existingChat=this.env.models['mail.thread'].find(thread=>thread.channel_type==='chat'&&thread.correspondent&&thread.correspondent.id===14&&thread.model==='mail.channel'&&thread.public==='private');assert.notOk(existingChat,'a chat should not exist with the target partner initially');await this.env.messaging.openChat({partnerId:14});const chat=this.env.models['mail.thread'].find(thread=>thread.channel_type==='chat'&&thread.correspondent&&thread.correspondent.id===14&&thread.model==='mail.channel'&&thread.public==='private');assert.ok(chat,'a chat should exist with the target partner');assert.strictEqual(chat.threadViews.length,1,'the chat should be displayed in a `mail.thread_view`');});QUnit.test('openChat: open existing chat for user',async function(assert){assert.expect(5);this.data['res.partner'].records.push({id:14});this.data['res.users'].records.push({id:11,partner_id:14});this.data['mail.channel'].records.push({channel_type:"chat",id:10,members:[this.data.currentPartnerId,14],public:'private',});await this.start();const existingChat=this.env.models['mail.thread'].find(thread=>thread.channel_type==='chat'&&thread.correspondent&&thread.correspondent.id===14&&thread.model==='mail.channel'&&thread.public==='private');assert.ok(existingChat,'a chat should initially exist with the target partner');assert.strictEqual(existingChat.threadViews.length,0,'the chat should not be displayed in a `mail.thread_view`');await this.env.messaging.openChat({partnerId:14});assert.ok(existingChat,'a chat should still exist with the target partner');assert.strictEqual(existingChat.id,10,'the chat should be the existing chat');assert.strictEqual(existingChat.threadViews.length,1,'the chat should now be displayed in a `mail.thread_view`');});});});});});});;

/* /mail/static/src/models/thread/thread_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/models/thread/thread_tests.js',function(require){'use strict';const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail',{},function(){QUnit.module('models',{},function(){QUnit.module('thread',{},function(){QUnit.module('thread_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('inbox & starred mailboxes',async function(assert){assert.expect(10);await this.start();const mailboxInbox=this.env.messaging.inbox;const mailboxStarred=this.env.messaging.starred;assert.ok(mailboxInbox,"should have mailbox inbox");assert.ok(mailboxStarred,"should have mailbox starred");assert.strictEqual(mailboxInbox.model,'mail.box');assert.strictEqual(mailboxInbox.counter,0);assert.strictEqual(mailboxInbox.id,'inbox');assert.strictEqual(mailboxInbox.name,"Inbox");assert.strictEqual(mailboxStarred.model,'mail.box');assert.strictEqual(mailboxStarred.counter,0);assert.strictEqual(mailboxStarred.id,'starred');assert.strictEqual(mailboxStarred.name,"Starred");});QUnit.test('create (channel)',async function(assert){assert.expect(23);await this.start();assert.notOk(this.env.models['mail.partner'].findFromIdentifyingData({id:9}));assert.notOk(this.env.models['mail.partner'].findFromIdentifyingData({id:10}));assert.notOk(this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',}));const thread=this.env.models['mail.thread'].create({channel_type:'channel',id:100,members:[['insert',[{email:"john@example.com",id:9,name:"John",},{email:"fred@example.com",id:10,name:"Fred",}]]],message_needaction_counter:6,model:'mail.channel',name:"General",public:'public',serverMessageUnreadCounter:5,});assert.ok(thread);assert.ok(this.env.models['mail.partner'].findFromIdentifyingData({id:9}));assert.ok(this.env.models['mail.partner'].findFromIdentifyingData({id:10}));assert.ok(this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',}));const partner9=this.env.models['mail.partner'].findFromIdentifyingData({id:9});const partner10=this.env.models['mail.partner'].findFromIdentifyingData({id:10});assert.strictEqual(thread,this.env.models['mail.thread'].findFromIdentifyingData({id:100,model:'mail.channel',}));assert.strictEqual(thread.model,'mail.channel');assert.strictEqual(thread.channel_type,'channel');assert.strictEqual(thread.id,100);assert.ok(thread.members.includes(partner9));assert.ok(thread.members.includes(partner10));assert.strictEqual(thread.message_needaction_counter,6);assert.strictEqual(thread.name,"General");assert.strictEqual(thread.public,'public');assert.strictEqual(thread.serverMessageUnreadCounter,5);assert.strictEqual(partner9.email,"john@example.com");assert.strictEqual(partner9.id,9);assert.strictEqual(partner9.name,"John");assert.strictEqual(partner10.email,"fred@example.com");assert.strictEqual(partner10.id,10);assert.strictEqual(partner10.name,"Fred");});QUnit.test('create (chat)',async function(assert){assert.expect(15);await this.start();assert.notOk(this.env.models['mail.partner'].findFromIdentifyingData({id:5}));assert.notOk(this.env.models['mail.thread'].findFromIdentifyingData({id:200,model:'mail.channel',}));const channel=this.env.models['mail.thread'].create({channel_type:'chat',id:200,members:[['insert',{email:"demo@example.com",id:5,im_status:'online',name:"Demo",}]],model:'mail.channel',});assert.ok(channel);assert.ok(this.env.models['mail.thread'].findFromIdentifyingData({id:200,model:'mail.channel',}));assert.ok(this.env.models['mail.partner'].findFromIdentifyingData({id:5}));const partner=this.env.models['mail.partner'].findFromIdentifyingData({id:5});assert.strictEqual(channel,this.env.models['mail.thread'].findFromIdentifyingData({id:200,model:'mail.channel',}));assert.strictEqual(channel.model,'mail.channel');assert.strictEqual(channel.channel_type,'chat');assert.strictEqual(channel.id,200);assert.ok(channel.correspondent);assert.strictEqual(partner,channel.correspondent);assert.strictEqual(partner.email,"demo@example.com");assert.strictEqual(partner.id,5);assert.strictEqual(partner.im_status,'online');assert.strictEqual(partner.name,"Demo");});});});});});;

/* /mail/static/src/utils/throttle/throttle_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/utils/throttle/throttle_tests.js',function(require){'use strict';const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');const throttle=require('mail/static/src/utils/throttle/throttle.js');const{nextTick}=require('mail/static/src/utils/utils.js');const{ThrottleReinvokedError,ThrottleCanceledError}=throttle;QUnit.module('mail',{},function(){QUnit.module('utils',{},function(){QUnit.module('throttle',{},function(){QUnit.module('throttle_tests.js',{beforeEach(){beforeEach(this);this.throttles=[];this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){for(const t of this.throttles){t.clear();}
afterEach(this);},});QUnit.test('single call',async function(assert){assert.expect(6);await this.start({hasTimeControl:true,});let hasInvokedFunc=false;const throttledFunc=throttle(this.env,()=>{hasInvokedFunc=true;return'func_result';},0);this.throttles.push(throttledFunc);assert.notOk(hasInvokedFunc,"func should not have been invoked on immediate throttle initialization");await this.env.testUtils.advanceTime(0);assert.notOk(hasInvokedFunc,"func should not have been invoked from throttle initialization after 0ms");throttledFunc().then(res=>{assert.step('throttle_observed_invoke');assert.strictEqual(res,'func_result',"throttle call return should forward result of inner func");});await nextTick();assert.ok(hasInvokedFunc,"func should have been immediately invoked on first throttle call");assert.verifySteps(['throttle_observed_invoke'],"throttle should have observed invoked on first throttle call");});QUnit.test('2nd (throttled) call',async function(assert){assert.expect(8);await this.start({hasTimeControl:true,});let funcCalledAmount=0;const throttledFunc=throttle(this.env,()=>{funcCalledAmount++;return`func_result_${funcCalledAmount}`;},1000);this.throttles.push(throttledFunc);throttledFunc().then(result=>{assert.step('throttle_observed_invoke_1');assert.strictEqual(result,'func_result_1',"throttle call return should forward result of inner func 1");});await nextTick();assert.verifySteps(['throttle_observed_invoke_1'],"inner function of throttle should have been invoked on 1st call (immediate return)");throttledFunc().then(res=>{assert.step('throttle_observed_invoke_2');assert.strictEqual(res,'func_result_2',"throttle call return should forward result of inner func 2");});await nextTick();assert.verifySteps([],"inner function of throttle should not have been immediately invoked after 2nd call immediately after 1st call (throttled with 1s internal clock)");await this.env.testUtils.advanceTime(999);assert.verifySteps([],"inner function of throttle should not have been invoked after 999ms of 2nd call (throttled with 1s internal clock)");await this.env.testUtils.advanceTime(1);assert.verifySteps(['throttle_observed_invoke_2'],"inner function of throttle should not have been invoked after 1s of 2nd call (throttled with 1s internal clock)");});QUnit.test('throttled call reinvocation',async function(assert){assert.expect(11);await this.start({hasTimeControl:true,});let funcCalledAmount=0;const throttledFunc=throttle(this.env,()=>{funcCalledAmount++;return`func_result_${funcCalledAmount}`;},1000,{silentCancelationErrors:false});this.throttles.push(throttledFunc);throttledFunc().then(result=>{assert.step('throttle_observed_invoke_1');assert.strictEqual(result,'func_result_1',"throttle call return should forward result of inner func 1");});await nextTick();assert.verifySteps(['throttle_observed_invoke_1'],"inner function of throttle should have been invoked on 1st call (immediate return)");throttledFunc().then(()=>{throw new Error("2nd throttle call should not be resolved (should have been canceled by reinvocation)");}).catch(error=>{assert.ok(error instanceof ThrottleReinvokedError,"Should generate a Throttle reinvoked error (from another throttle function call)");assert.step('throttle_reinvoked_1');});await nextTick();assert.verifySteps([],"inner function of throttle should not have been immediately invoked after 2nd call immediately after 1st call (throttled with 1s internal clock)");await this.env.testUtils.advanceTime(999);assert.verifySteps([],"inner function of throttle should not have been invoked after 999ms of 2nd call (throttled with 1s internal clock)");throttledFunc().then(result=>{assert.step('throttle_observed_invoke_2');assert.strictEqual(result,'func_result_2',"throttle call return should forward result of inner func 2");});await nextTick();assert.verifySteps(['throttle_reinvoked_1'],"2nd throttle call should have been canceled from 3rd throttle call (reinvoked before cooling down phase has ended)");await this.env.testUtils.advanceTime(1);assert.verifySteps(['throttle_observed_invoke_2'],"inner function of throttle should have been invoked after 1s of 1st call (throttled with 1s internal clock, 3rd throttle call re-use timer of 2nd throttle call)");});QUnit.test('flush throttled call',async function(assert){assert.expect(9);await this.start({hasTimeControl:true,});const throttledFunc=throttle(this.env,()=>{},1000,);this.throttles.push(throttledFunc);throttledFunc().then(()=>assert.step('throttle_observed_invoke_1'));await nextTick();assert.verifySteps(['throttle_observed_invoke_1'],"inner function of throttle should have been invoked on 1st call (immediate return)");throttledFunc().then(()=>assert.step('throttle_observed_invoke_2'));await nextTick();assert.verifySteps([],"inner function of throttle should not have been immediately invoked after 2nd call immediately after 1st call (throttled with 1s internal clock)");await this.env.testUtils.advanceTime(10);assert.verifySteps([],"inner function of throttle should not have been invoked after 10ms of 2nd call (throttled with 1s internal clock)");throttledFunc.flush();await nextTick();assert.verifySteps(['throttle_observed_invoke_2'],"inner function of throttle should have been invoked from 2nd call after flush");throttledFunc().then(()=>assert.step('throttle_observed_invoke_3'));await nextTick();await this.env.testUtils.advanceTime(999);assert.verifySteps([],"inner function of throttle should not have been invoked after 999ms of 3rd call (throttled with 1s internal clock)");await this.env.testUtils.advanceTime(1);assert.verifySteps(['throttle_observed_invoke_3'],"inner function of throttle should not have been invoked after 999ms of 3rd call (throttled with 1s internal clock)");});QUnit.test('cancel throttled call',async function(assert){assert.expect(10);await this.start({hasTimeControl:true,});const throttledFunc=throttle(this.env,()=>{},1000,{silentCancelationErrors:false});this.throttles.push(throttledFunc);throttledFunc().then(()=>assert.step('throttle_observed_invoke_1'));await nextTick();assert.verifySteps(['throttle_observed_invoke_1'],"inner function of throttle should have been invoked on 1st call (immediate return)");throttledFunc().then(()=>{throw new Error("2nd throttle call should not be resolved (should have been canceled)");}).catch(error=>{assert.ok(error instanceof ThrottleCanceledError,"Should generate a Throttle canceled error (from `.cancel()`)");assert.step('throttle_canceled');});await nextTick();assert.verifySteps([],"inner function of throttle should not have been immediately invoked after 2nd call immediately after 1st call (throttled with 1s internal clock)");await this.env.testUtils.advanceTime(500);assert.verifySteps([],"inner function of throttle should not have been invoked after 500ms of 2nd call (throttled with 1s internal clock)");throttledFunc.cancel();await nextTick();assert.verifySteps(['throttle_canceled'],"2nd throttle function call should have been canceled");throttledFunc().then(()=>assert.step('throttle_observed_invoke_3'));await nextTick();assert.verifySteps([],"3rd throttle function call should not have invoked inner function yet (cancel reuses inner clock of throttle)");await this.env.testUtils.advanceTime(500);assert.verifySteps(['throttle_observed_invoke_3'],"3rd throttle function call should have invoke inner function after 500ms (cancel reuses inner clock of throttle which was at 500ms in, throttle set at 1ms)");});QUnit.test('clear throttled call',async function(assert){assert.expect(9);await this.start({hasTimeControl:true,});const throttledFunc=throttle(this.env,()=>{},1000,{silentCancelationErrors:false});this.throttles.push(throttledFunc);throttledFunc().then(()=>assert.step('throttle_observed_invoke_1'));await nextTick();assert.verifySteps(['throttle_observed_invoke_1'],"inner function of throttle should have been invoked on 1st call (immediate return)");throttledFunc().then(()=>{throw new Error("2nd throttle call should not be resolved (should have been canceled from clear)");}).catch(error=>{assert.ok(error instanceof ThrottleCanceledError,"Should generate a Throttle canceled error (from `.clear()`)");assert.step('throttle_canceled');});await nextTick();assert.verifySteps([],"inner function of throttle should not have been immediately invoked after 2nd call immediately after 1st call (throttled with 1s internal clock)");await this.env.testUtils.advanceTime(500);assert.verifySteps([],"inner function of throttle should not have been invoked after 500ms of 2nd call (throttled with 1s internal clock)");throttledFunc.clear();await nextTick();assert.verifySteps(['throttle_canceled'],"2nd throttle function call should have been canceled (from `.clear()`)");throttledFunc().then(()=>assert.step('throttle_observed_invoke_3'));await nextTick();assert.verifySteps(['throttle_observed_invoke_3'],"3rd throttle function call should have invoke inner function immediately (`.clear()` flushes throttle)");});});});});});;

/* /mail/static/src/utils/timer/timer_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/utils/timer/timer_tests.js',function(require){'use strict';const{afterEach,beforeEach,nextTick,start}=require('mail/static/src/utils/test_utils.js');const Timer=require('mail/static/src/utils/timer/timer.js');const{TimerClearedError}=Timer;QUnit.module('mail',{},function(){QUnit.module('utils',{},function(){QUnit.module('timer',{},function(){QUnit.module('timer_tests.js',{beforeEach(){beforeEach(this);this.timers=[];this.start=async(params)=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){for(const timer of this.timers){timer.clear();}
afterEach(this);},});QUnit.test('timer does not timeout on initialization',async function(assert){assert.expect(3);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,0));assert.notOk(hasTimedOut,"timer should not have timed out on immediate initialization");await this.env.testUtils.advanceTime(0);assert.notOk(hasTimedOut,"timer should not have timed out from initialization after 0ms");await this.env.testUtils.advanceTime(1000*1000);assert.notOk(hasTimedOut,"timer should not have timed out from initialization after 1000s");});QUnit.test('timer start (duration: 0ms)',async function(assert){assert.expect(2);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,0));this.timers[0].start();assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");await this.env.testUtils.advanceTime(0);assert.ok(hasTimedOut,"timer should have timed out on start after 0ms");});QUnit.test('timer start observe termination (duration: 0ms)',async function(assert){assert.expect(6);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>{hasTimedOut=true;return'timeout_result';},0));this.timers[0].start().then(result=>{assert.strictEqual(result,'timeout_result',"value returned by start should be value returned by function on timeout");assert.step('timeout');});await nextTick();assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");assert.verifySteps([],"timer.start() should not have yet observed timeout");await this.env.testUtils.advanceTime(0);assert.ok(hasTimedOut,"timer should have timed out on start after 0ms");assert.verifySteps(['timeout'],"timer.start() should have observed timeout after 0ms");});QUnit.test('timer start (duration: 1000s)',async function(assert){assert.expect(5);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,1000*1000));this.timers[0].start();assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");await this.env.testUtils.advanceTime(0);assert.notOk(hasTimedOut,"timer should not have timed out on start after 0ms");await this.env.testUtils.advanceTime(1000);assert.notOk(hasTimedOut,"timer should not have timed out on start after 1000ms");await this.env.testUtils.advanceTime(998*1000+999);assert.notOk(hasTimedOut,"timer should not have timed out on start after 9999ms");await this.env.testUtils.advanceTime(1);assert.ok(hasTimedOut,"timer should have timed out on start after 10s");});QUnit.test('[no cancelation intercept] timer start then immediate clear (duration: 0ms)',async function(assert){assert.expect(4);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,0));this.timers[0].start();assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");this.timers[0].clear();assert.notOk(hasTimedOut,"timer should not have timed out immediately after start and clear");await this.env.testUtils.advanceTime(0);assert.notOk(hasTimedOut,"timer should not have timed out after 0ms of clear");await this.env.testUtils.advanceTime(1000);assert.notOk(hasTimedOut,"timer should not have timed out after 1s of clear");});QUnit.test('[no cancelation intercept] timer start then clear before timeout (duration: 1000ms)',async function(assert){assert.expect(4);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,1000));this.timers[0].start();assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");await this.env.testUtils.advanceTime(999);assert.notOk(hasTimedOut,"timer should not have timed out immediately after 999ms of start");this.timers[0].clear();await this.env.testUtils.advanceTime(1);assert.notOk(hasTimedOut,"timer should not have timed out after 1ms of clear that happens 999ms after start (globally 1s await)");await this.env.testUtils.advanceTime(1000);assert.notOk(hasTimedOut,"timer should not have timed out after 1001ms after clear (timer fully cleared)");});QUnit.test('[no cancelation intercept] timer start then reset before timeout (duration: 1000ms)',async function(assert){assert.expect(5);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,1000));this.timers[0].start();assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");await this.env.testUtils.advanceTime(999);assert.notOk(hasTimedOut,"timer should not have timed out after 999ms of start");this.timers[0].reset();await this.env.testUtils.advanceTime(1);assert.notOk(hasTimedOut,"timer should not have timed out after 1ms of reset which happens 999ms after start");await this.env.testUtils.advanceTime(998);assert.notOk(hasTimedOut,"timer should not have timed out after 999ms of reset");await this.env.testUtils.advanceTime(1);assert.ok(hasTimedOut,"timer should not have timed out after 1s of reset");});QUnit.test('[with cancelation intercept] timer start then immediate clear (duration: 0ms)',async function(assert){assert.expect(5);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,0,{silentCancelationErrors:false}));this.timers[0].start().then(()=>{throw new Error("timer.start() should not be resolved (should have been canceled by clear)");}).catch(error=>{assert.ok(error instanceof TimerClearedError,"Should generate a Timer cleared error (from `.clear()`)");assert.step('timer_cleared');});assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");await nextTick();assert.verifySteps([],"should not have observed cleared timer (timer not yet cleared)");this.timers[0].clear();await nextTick();assert.verifySteps(['timer_cleared'],"timer.start() should have observed it has been cleared");});QUnit.test('[with cancelation intercept] timer start then immediate reset (duration: 0ms)',async function(assert){assert.expect(9);await this.start({hasTimeControl:true,});let hasTimedOut=false;this.timers.push(new Timer(this.env,()=>hasTimedOut=true,0,{silentCancelationErrors:false}));this.timers[0].start().then(()=>{throw new Error("timer.start() should not observe a timeout");}).catch(error=>{assert.ok(error instanceof TimerClearedError,"Should generate a Timer cleared error (from `.reset()`)");assert.step('timer_cleared');});assert.notOk(hasTimedOut,"timer should not have timed out immediately after start");await nextTick();assert.verifySteps([],"should not have observed cleared timer (timer not yet cleared)");this.timers[0].reset().then(()=>assert.step('timer_reset_timeout'));await nextTick();assert.verifySteps(['timer_cleared'],"timer.start() should have observed it has been cleared");assert.notOk(hasTimedOut,"timer should not have timed out immediately after reset");await this.env.testUtils.advanceTime(0);assert.ok(hasTimedOut,"timer should have timed out after reset timeout");assert.verifySteps(['timer_reset_timeout'],"timer.reset() should have observed it has timed out");});});});});});;

/* /mail/static/src/widgets/form_renderer/form_renderer_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/widgets/form_renderer/form_renderer_tests.js',function(require){"use strict";const{makeDeferred}=require('mail/static/src/utils/deferred/deferred.js');const{afterEach,afterNextRender,beforeEach,nextAnimationFrame,start,}=require('mail/static/src/utils/test_utils.js');const config=require('web.config');const FormView=require('web.FormView');const{dom:{triggerEvent},}=require('web.test_utils');QUnit.module('mail',{},function(){QUnit.module('widgets',{},function(){QUnit.module('form_renderer',{},function(){QUnit.module('form_renderer_tests.js',{beforeEach(){beforeEach(this);this.createView=async(viewParams,...args)=>{await afterNextRender(async()=>{const viewArgs=Object.assign({archs:{'mail.activity,false,list':'<tree/>','mail.followers,false,list':'<tree/>','mail.message,false,list':'<tree/>',},},viewParams,);const{afterEvent,env,widget}=await start(viewArgs,...args);this.afterEvent=afterEvent;this.env=env;this.widget=widget;});};},afterEach(){afterEach(this);},});QUnit.test('[technical] spinner when messaging is not created',async function(assert){assert.expect(3);this.data['res.partner'].records.push({display_name:"second partner",id:12,});await this.createView({data:this.data,hasView:true,messagingBeforeCreationDeferred:makeDeferred(),waitUntilMessagingCondition:'none',View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter"></div>
            </form>
        `,res_id:12,});assert.containsOnce(document.body,'.o_ChatterContainer',"should display chatter container even when messaging is not created yet");assert.containsOnce(document.body,'.o_ChatterContainer_noChatter',"chatter container should not display any chatter when messaging not created");assert.strictEqual(document.querySelector('.o_ChatterContainer').textContent,"Please wait...","chatter container should display spinner when messaging not yet created");});QUnit.test('[technical] keep spinner on transition from messaging non-created to messaging created (and non-initialized)',async function(assert){assert.expect(4);const messagingBeforeCreationDeferred=makeDeferred();this.data['res.partner'].records.push({display_name:"second partner",id:12,});await this.createView({data:this.data,hasView:true,messagingBeforeCreationDeferred,async mockRPC(route,args){const _super=this._super.bind(this,...arguments);if(route==='/mail/init_messaging'){await new Promise(()=>{});}
return _super();},waitUntilMessagingCondition:'none',View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter"></div>
            </form>
        `,res_id:12,});assert.strictEqual(document.querySelector('.o_ChatterContainer').textContent,"Please wait...","chatter container should display spinner when messaging not yet created");assert.containsOnce(document.body,'.o_ChatterContainer_noChatter',"chatter container should not display any chatter when messaging not created");messagingBeforeCreationDeferred.resolve();await nextAnimationFrame();assert.strictEqual(document.querySelector('.o_ChatterContainer').textContent,"Please wait...","chatter container should still display spinner when messaging is created but not initialized");assert.containsOnce(document.body,'.o_ChatterContainer_noChatter',"chatter container should still not display any chatter when messaging not initialized");});QUnit.test('spinner when messaging is created but not initialized',async function(assert){assert.expect(3);this.data['res.partner'].records.push({display_name:"second partner",id:12,});await this.createView({data:this.data,hasView:true,async mockRPC(route,args){const _super=this._super.bind(this,...arguments);if(route==='/mail/init_messaging'){await new Promise(()=>{});}
return _super();},waitUntilMessagingCondition:'created',View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter"></div>
            </form>
        `,res_id:12,});assert.containsOnce(document.body,'.o_ChatterContainer',"should display chatter container even when messaging is not fully initialized");assert.containsOnce(document.body,'.o_ChatterContainer_noChatter',"chatter container should not display any chatter when messaging not initialized");assert.strictEqual(document.querySelector('.o_ChatterContainer').textContent,"Please wait...","chatter container should display spinner when messaging not yet initialized");});QUnit.test('transition non-initialized messaging to initialized messaging: display spinner then chatter',async function(assert){assert.expect(3);const messagingBeforeInitializationDeferred=makeDeferred();this.data['res.partner'].records.push({display_name:"second partner",id:12,});await this.createView({data:this.data,hasView:true,async mockRPC(route,args){const _super=this._super.bind(this,...arguments);if(route==='/mail/init_messaging'){await messagingBeforeInitializationDeferred;}
return _super();},waitUntilMessagingCondition:'created',View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter"></div>
            </form>
        `,res_id:12,});assert.strictEqual(document.querySelector('.o_ChatterContainer').textContent,"Please wait...","chatter container should display spinner when messaging not yet initialized");assert.containsOnce(document.body,'.o_ChatterContainer_noChatter',"chatter container should not display any chatter when messaging not initialized");await afterNextRender(()=>messagingBeforeInitializationDeferred.resolve());assert.containsNone(document.body,'.o_ChatterContainer_noChatter',"chatter container should now display chatter when messaging becomes initialized");});QUnit.test('basic chatter rendering',async function(assert){assert.expect(1);this.data['res.partner'].records.push({display_name:"second partner",id:12,});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter"></div>
            </form>
        `,res_id:12,});assert.strictEqual(document.querySelectorAll(`.o_Chatter`).length,1,"there should be a chatter");});QUnit.test('basic chatter rendering without followers',async function(assert){assert.expect(6);this.data['res.partner'].records.push({display_name:"second partner",id:12});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        `,res_id:12,});assert.containsOnce(document.body,'.o_Chatter',"there should be a chatter");assert.containsOnce(document.body,'.o_ChatterTopbar',"there should be a chatter topbar");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonAttachments',"there should be an attachment button");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonScheduleActivity',"there should be a schedule activity button");assert.containsNone(document.body,'.o_FollowerListMenu',"there should be no followers menu");assert.containsOnce(document.body,'.o_Chatter_thread',"there should be a thread");});QUnit.test('basic chatter rendering without activities',async function(assert){assert.expect(6);this.data['res.partner'].records.push({display_name:"second partner",id:12});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        `,res_id:12,});assert.containsOnce(document.body,'.o_Chatter',"there should be a chatter");assert.containsOnce(document.body,'.o_ChatterTopbar',"there should be a chatter topbar");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonAttachments',"there should be an attachment button");assert.containsNone(document.body,'.o_ChatterTopbar_buttonScheduleActivity',"there should be a schedule activity button");assert.containsOnce(document.body,'.o_FollowerListMenu',"there should be a followers menu");assert.containsOnce(document.body,'.o_Chatter_thread',"there should be a thread");});QUnit.test('basic chatter rendering without messages',async function(assert){assert.expect(6);this.data['res.partner'].records.push({display_name:"second partner",id:12});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                </div>
            </form>
        `,res_id:12,});assert.containsOnce(document.body,'.o_Chatter',"there should be a chatter");assert.containsOnce(document.body,'.o_ChatterTopbar',"there should be a chatter topbar");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonAttachments',"there should be an attachment button");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonScheduleActivity',"there should be a schedule activity button");assert.containsOnce(document.body,'.o_FollowerListMenu',"there should be a followers menu");assert.containsNone(document.body,'.o_Chatter_thread',"there should be a thread");});QUnit.test('chatter updating',async function(assert){assert.expect(1);this.data['mail.message'].records.push({body:"not empty",model:'res.partner',res_id:12});this.data['res.partner'].records.push({display_name:"first partner",id:11},{display_name:"second partner",id:12});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',res_id:11,viewOptions:{ids:[11,12],index:0,},arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form>
        `,waitUntilEvent:{eventName:'o-thread-view-hint-processed',message:"should wait until partner 11 thread loaded messages initially",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='res.partner'&&threadViewer.thread.id===11);},}});await this.afterEvent({eventName:'o-thread-view-hint-processed',func:()=>document.querySelector('.o_pager_next').click(),message:"should wait until partner 12 thread loaded messages after clicking on next",predicate:({hint,threadViewer})=>{return(hint.type==='messages-loaded'&&threadViewer.thread.model==='res.partner'&&threadViewer.thread.id===12);},});assert.containsOnce(document.body,'.o_Message',"there should be a message in partner 12 thread");});QUnit.test('chatter should become enabled when creation done',async function(assert){assert.expect(10);await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form>
        `,viewOptions:{mode:'edit',},});assert.containsOnce(document.body,'.o_Chatter',"there should be a chatter");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonSendMessage',"there should be a send message button");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonLogNote',"there should be a log note button");assert.containsOnce(document.body,'.o_ChatterTopbar_buttonLogNote',"there should be an attachments button");assert.ok(document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).disabled,"send message button should be disabled");assert.ok(document.querySelector(`.o_ChatterTopbar_buttonLogNote`).disabled,"log note button should be disabled");assert.ok(document.querySelector(`.o_ChatterTopbar_buttonAttachments`).disabled,"attachments button should be disabled");document.querySelectorAll('.o_field_char')[0].focus();document.execCommand('insertText',false,"hello");await afterNextRender(()=>{document.querySelector('.o_form_button_save').click();});assert.notOk(document.querySelector(`.o_ChatterTopbar_buttonSendMessage`).disabled,"send message button should now be enabled");assert.notOk(document.querySelector(`.o_ChatterTopbar_buttonLogNote`).disabled,"log note button should now be enabled");assert.notOk(document.querySelector(`.o_ChatterTopbar_buttonAttachments`).disabled,"attachments button should now be enabled");});QUnit.test('read more/less links are not duplicated when switching from read to edit mode',async function(assert){assert.expect(5);this.data['mail.message'].records.push({author_id:100,body:`
            <div>
                Dear Joel Willis,<br>
                Thank you for your enquiry.<br>
                If you have any questions, please let us know.
                <br><br>
                Thank you,<br>
                <span data-o-mail-quote="1">-- <br data-o-mail-quote="1">
                    System
                </span>
            </div>
        `,id:1000,model:'res.partner',res_id:2,});this.data['res.partner'].records.push({display_name:"Someone",id:100,});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',res_id:2,arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form>
        `,waitUntilEvent:{eventName:'o-component-message-read-more-less-inserted',message:"should wait until read more/less is inserted initially",predicate:({message})=>message.id===1000,},});assert.containsOnce(document.body,'.o_Chatter',"there should be a chatter");assert.containsOnce(document.body,'.o_Message',"there should be a message");assert.containsOnce(document.body,'.o_Message_readMoreLess',"there should be only one read more");await afterNextRender(()=>this.afterEvent({eventName:'o-component-message-read-more-less-inserted',func:()=>document.querySelector('.o_form_button_edit').click(),message:"should wait until read more/less is inserted after clicking on edit",predicate:({message})=>message.id===1000,}));assert.containsOnce(document.body,'.o_Message_readMoreLess',"there should still be only one read more after switching to edit mode");await afterNextRender(()=>this.afterEvent({eventName:'o-component-message-read-more-less-inserted',func:()=>document.querySelector('.o_form_button_cancel').click(),message:"should wait until read more/less is inserted after canceling edit",predicate:({message})=>message.id===1000,}));assert.containsOnce(document.body,'.o_Message_readMoreLess',"there should still be only one read more after switching back to read mode");});QUnit.test('read more links becomes read less after being clicked',async function(assert){assert.expect(6);this.data['mail.message'].records=[{author_id:100,body:`
            <div>
                Dear Joel Willis,<br>
                Thank you for your enquiry.<br>
                If you have any questions, please let us know.
                <br><br>
                Thank you,<br>
                <span data-o-mail-quote="1">-- <br data-o-mail-quote="1">
                    System
                </span>
            </div>
        `,id:1000,model:'res.partner',res_id:2,}];this.data['res.partner'].records.push({display_name:"Someone",id:100,});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',res_id:2,arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form>
        `,waitUntilEvent:{eventName:'o-component-message-read-more-less-inserted',message:"should wait until read more/less is inserted initially",predicate:({message})=>message.id===1000,},});assert.containsOnce(document.body,'.o_Chatter',"there should be a chatter");assert.containsOnce(document.body,'.o_Message',"there should be a message");assert.containsOnce(document.body,'.o_Message_readMoreLess',"there should be a read more");assert.strictEqual(document.querySelector('.o_Message_readMoreLess').textContent,'read more',"read more/less link should contain 'read more' as text");await afterNextRender(()=>this.afterEvent({eventName:'o-component-message-read-more-less-inserted',func:()=>document.querySelector('.o_form_button_edit').click(),message:"should wait until read more/less is inserted after clicking on edit",predicate:({message})=>message.id===1000,}));assert.strictEqual(document.querySelector('.o_Message_readMoreLess').textContent,'read more',"read more/less link should contain 'read more' as text");document.querySelector('.o_Message_readMoreLess').click();assert.strictEqual(document.querySelector('.o_Message_readMoreLess').textContent,'read less',"read more/less link should contain 'read less' as text after it has been clicked");});QUnit.test('Form view not scrolled when switching record',async function(assert){assert.expect(6);this.data['res.partner'].records.push({id:11,display_name:"Partner 1",description:[...Array(60).keys()].join('\n'),},{id:12,display_name:"Partner 2",});const messages=[...Array(60).keys()].map(id=>{return{model:'res.partner',res_id:id%2?11:12,};});this.data['mail.message'].records=messages;await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                    <field name="description"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form>
        `,viewOptions:{currentId:11,ids:[11,12],},config:{device:{size_class:config.device.SIZES.LG},},env:{device:{size_class:config.device.SIZES.LG},},});const controllerContentEl=document.querySelector('.o_content');assert.strictEqual(document.querySelector('.breadcrumb-item.active').textContent,'Partner 1',"Form view should display partner 'Partner 1'");assert.strictEqual(controllerContentEl.scrollTop,0,"The top of the form view is visible");await afterNextRender(async()=>{controllerContentEl.scrollTop=controllerContentEl.scrollHeight-controllerContentEl.clientHeight;await triggerEvent(document.querySelector('.o_ThreadView_messageList'),'scroll');});assert.strictEqual(controllerContentEl.scrollTop,controllerContentEl.scrollHeight-controllerContentEl.clientHeight,"The controller container should be scrolled to its bottom");await afterNextRender(()=>document.querySelector('.o_pager_next').click());assert.strictEqual(document.querySelector('.breadcrumb-item.active').textContent,'Partner 2',"The form view should display partner 'Partner 2'");assert.strictEqual(controllerContentEl.scrollTop,0,"The top of the form view should be visible when switching record from pager");await afterNextRender(()=>document.querySelector('.o_pager_previous').click());assert.strictEqual(controllerContentEl.scrollTop,0,"Form view's scroll position should have been reset when switching back to first record");});QUnit.test('Attachments that have been unlinked from server should be visually unlinked from record',async function(assert){assert.expect(2);this.data['res.partner'].records.push({display_name:"Partner1",id:11},{display_name:"Partner2",id:12});this.data['ir.attachment'].records.push({id:11,mimetype:'text.txt',res_id:11,res_model:'res.partner',},{id:12,mimetype:'text.txt',res_id:11,res_model:'res.partner',});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',res_id:11,viewOptions:{ids:[11,12],index:0,},arch:`
            <form string="Partners">
                <sheet>
                    <field name="name"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form>
        `,});assert.strictEqual(document.querySelector('.o_ChatterTopbar_buttonCount').textContent,'2',"Partner1 should have 2 attachments initially");await afterNextRender(()=>document.querySelector('.o_pager_next').click());this.data['ir.attachment'].records.find(a=>a.id===11).res_id=0;await afterNextRender(()=>document.querySelector('.o_pager_previous').click());assert.strictEqual(document.querySelector('.o_ChatterTopbar_buttonCount').textContent,'1',"Partner1 should now have 1 attachment after it has been unlinked from server");});QUnit.test('chatter just contains "creating a new record" message during the creation of a new record after having displayed a chatter for an existing record',async function(assert){assert.expect(2);this.data['res.partner'].records.push({id:12});await this.createView({data:this.data,hasView:true,View:FormView,model:'res.partner',res_id:12,arch:`
            <form>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form>
        `,});await afterNextRender(()=>{document.querySelector('.o_form_button_create').click();});assert.containsOnce(document.body,'.o_Message',"Should have a single message when creating a new record");assert.strictEqual(document.querySelector('.o_Message_content').textContent,'Creating a new record...',"the message content should be in accord to the creation of this record");});});});});});;

/* /mail/static/src/widgets/notification_alert/notification_alert_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail/static/src/widgets/notification_alert/notification_alert_tests.js',function(require){'use strict';const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');const FormView=require('web.FormView');QUnit.module('mail',{},function(){QUnit.module('widgets',{},function(){QUnit.module('notification_alert',{},function(){QUnit.module('notification_alert_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{let{widget}=await start(Object.assign({data:this.data,hasView:true,View:FormView,model:'mail.message',arch:`
                    <form>
                        <widget name="notification_alert"/>
                    </form>
                `,},params));this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.skip('notification_alert widget: display blocked notification alert',async function(assert){assert.expect(1);await this.start({env:{browser:{Notification:{permission:'denied',},},},});assert.containsOnce(document.body,'.o_notification_alert',"Blocked notification alert should be displayed");});QUnit.test('notification_alert widget: no notification alert when granted',async function(assert){assert.expect(1);await this.start({env:{browser:{Notification:{permission:'granted',},},},});assert.containsNone(document.body,'.o_notification_alert',"Blocked notification alert should not be displayed");});QUnit.test('notification_alert widget: no notification alert when default',async function(assert){assert.expect(1);await this.start({env:{browser:{Notification:{permission:'default',},},},});assert.containsNone(document.body,'.o_notification_alert',"Blocked notification alert should not be displayed");});});});});});;

/* /hr/static/src/bugfix/bugfix_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('hr/static/src/bugfix/bugfix_tests.js',function(require){'use strict';QUnit.module('hr',{},function(){QUnit.module('bugfix',{},function(){QUnit.module('bugfix_tests.js',{});});});});;

/* /hr/static/tests/helpers/mock_models.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('hr/static/tests/helpers/mock_models.js',function(require){'use strict';const MockModels=require('mail/static/tests/helpers/mock_models.js');MockModels.patch('hr/static/tests/helpers/mock_models.js',T=>class extends T{static generateData(){const data=super.generateData(...arguments);Object.assign(data,{'hr.employee.public':{fields:{display_name:{string:"Name",type:"char"},user_id:{string:"User",type:"many2one",relation:'res.users'},user_partner_id:{string:"Partner",type:"many2one",relation:'res.partner'},},records:[],},});return data;}});});;

/* /hr/static/tests/many2one_avatar_employee_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('hr.Many2OneAvatarEmployeeTests',function(require){"use strict";const{afterEach,afterNextRender,beforeEach,start,}=require('mail/static/src/utils/test_utils.js');const FormView=require('web.FormView');const KanbanView=require('web.KanbanView');const ListView=require('web.ListView');const{Many2OneAvatarEmployee}=require('hr.Many2OneAvatarEmployee');const{dom,mock}=require('web.test_utils');QUnit.module('hr',{},function(){QUnit.module('Many2OneAvatarEmployee',{beforeEach(){beforeEach(this);Many2OneAvatarEmployee.prototype.partnerIds={};Object.assign(this.data,{'foo':{fields:{employee_id:{string:"Employee",type:'many2one',relation:'hr.employee.public'},},records:[{id:1,employee_id:11},{id:2,employee_id:7},{id:3,employee_id:11},{id:4,employee_id:23},],},});this.data['hr.employee.public'].records.push({id:11,name:"Mario",user_id:11,user_partner_id:11},{id:7,name:"Luigi",user_id:12,user_partner_id:12},{id:23,name:"Yoshi",user_id:13,user_partner_id:13});this.data['res.users'].records.push({id:11,partner_id:11},{id:12,partner_id:12},{id:13,partner_id:13});this.data['res.partner'].records.push({id:11,display_name:"Mario"},{id:12,display_name:"Luigi"},{id:13,display_name:"Yoshi"});},afterEach(){afterEach(this);},});QUnit.test('many2one_avatar_employee widget in list view',async function(assert){assert.expect(11);const{widget:list}=await start({hasChatWindow:true,hasView:true,View:ListView,model:'foo',data:this.data,arch:'<tree><field name="employee_id" widget="many2one_avatar_employee"/></tree>',mockRPC(route,args){if(args.method==='read'){assert.step(`read ${args.model} ${args.args[0]}`);}
return this._super(...arguments);},});assert.strictEqual(list.$('.o_data_cell span').text(),'MarioLuigiMarioYoshi');await afterNextRender(()=>dom.click(list.$('.o_data_cell:nth(0) .o_m2o_avatar')));assert.verifySteps(['read hr.employee.public 11'],"first employee should have been read to find its partner");assert.containsOnce(document.body,'.o_ChatWindowHeader_name','should have opened chat window');assert.strictEqual(document.querySelector('.o_ChatWindowHeader_name').textContent,"Mario",'chat window should be with clicked employee');await afterNextRender(()=>dom.click(list.$('.o_data_cell:nth(1) .o_m2o_avatar')));assert.verifySteps(['read hr.employee.public 7'],"second employee should have been read to find its partner");assert.containsN(document.body,'.o_ChatWindowHeader_name',2,'should have opened second chat window');assert.strictEqual(document.querySelectorAll('.o_ChatWindowHeader_name')[1].textContent,"Luigi",'chat window should be with clicked employee');await afterNextRender(()=>dom.click(list.$('.o_data_cell:nth(2) .o_m2o_avatar')));assert.verifySteps([],"employee should not have been read again because we already know its partner");assert.containsN(document.body,'.o_ChatWindowHeader_name',2,"should still have only 2 chat windows because third is the same partner as first");list.destroy();});QUnit.test('many2one_avatar_employee widget in kanban view',async function(assert){assert.expect(6);const{widget:kanban}=await start({hasView:true,View:KanbanView,model:'foo',data:this.data,arch:`
                <kanban>
                    <templates>
                        <t t-name="kanban-box">
                            <div>
                                <field name="employee_id" widget="many2one_avatar_employee"/>
                            </div>
                        </t>
                    </templates>
                </kanban>`,});assert.strictEqual(kanban.$('.o_kanban_record').text().trim(),'');assert.containsN(kanban,'.o_m2o_avatar',4);assert.strictEqual(kanban.$('.o_m2o_avatar:nth(0)').data('src'),'/web/image/hr.employee.public/11/image_128');assert.strictEqual(kanban.$('.o_m2o_avatar:nth(1)').data('src'),'/web/image/hr.employee.public/7/image_128');assert.strictEqual(kanban.$('.o_m2o_avatar:nth(2)').data('src'),'/web/image/hr.employee.public/11/image_128');assert.strictEqual(kanban.$('.o_m2o_avatar:nth(3)').data('src'),'/web/image/hr.employee.public/23/image_128');kanban.destroy();});QUnit.test('many2one_avatar_employee: click on an employee not associated with a user',async function(assert){assert.expect(6);this.data['hr.employee.public'].records[0].user_id=false;this.data['hr.employee.public'].records[0].user_partner_id=false;const{widget:form}=await start({hasView:true,View:FormView,model:'foo',data:this.data,arch:'<form><field name="employee_id" widget="many2one_avatar_employee"/></form>',mockRPC(route,args){if(args.method==='read'){assert.step(`read ${args.model} ${args.args[0]}`);}
return this._super(...arguments);},res_id:1,});mock.intercept(form,'call_service',(ev)=>{if(ev.data.service==='notification'){assert.step(`display notification "${ev.data.args[0].message}"`);}},true);assert.strictEqual(form.$('.o_field_widget[name=employee_id]').text().trim(),'Mario');await dom.click(form.$('.o_m2o_avatar'));assert.verifySteps(['read foo 1','read hr.employee.public 11',]);assert.containsOnce(document.body,'.toast .o_notification_content',"should display a toast notification after failing to open chat");assert.strictEqual(document.querySelector('.o_notification_content').textContent,"You can only chat with employees that have a dedicated user.","should display the correct information in the notification");form.destroy();});});});;

/* /hr/static/tests/standalone_m2o_avatar_employee_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('hr.StandaloneM2OEmployeeTests',function(require){"use strict";const{xml}=owl.tags;const AbstractRendererOwl=require('web.AbstractRendererOwl');const BasicView=require("web.BasicView");const BasicRenderer=require("web.BasicRenderer");const RendererWrapper=require('web.RendererWrapper');const{createView}=require('web.test_utils');const StandaloneM2OAvatarEmployee=require('hr.StandaloneM2OAvatarEmployee');function getHtmlRenderer(html){return BasicRenderer.extend({start:function(){this.$el.html(html);return this._super.apply(this,arguments);}});}
function getOwlView(owlRenderer,viewType){viewType=viewType||"test";return BasicView.extend({viewType:viewType,config:Object.assign({},BasicView.prototype.config,{Renderer:owlRenderer,}),getRenderer(){return new RendererWrapper(null,this.config.Renderer,{});}});}
function getHtmlView(html,viewType){viewType=viewType||"test";return BasicView.extend({viewType:viewType,config:Object.assign({},BasicView.prototype.config,{Renderer:getHtmlRenderer(html)})});}
QUnit.module('hr',{},function(){QUnit.module('StandaloneM2OEmployeeTests',{beforeEach:function(){this.data={'foo':{fields:{employee_id:{string:"Employee",type:'many2one',relation:'hr.employee'},},records:[],},'hr.employee':{fields:{},records:[{id:10,name:"Mario"},{id:20,name:"Luigi"},{id:30,name:"Yoshi"}],},};},});QUnit.test('standalone_m2o_avatar_employee: legacy view',async function(assert){assert.expect(1);const html="<div class='coucou_test'></div>";const view=await createView({View:getHtmlView(html,"test"),data:this.data,model:"foo",arch:"<test/>"});const avatar10=new StandaloneM2OAvatarEmployee(view,10);const avatar20=new StandaloneM2OAvatarEmployee(view,20);const avatar30=new StandaloneM2OAvatarEmployee(view,[30,'Bowser']);await avatar10.appendTo(view.el.querySelector('.coucou_test'));await avatar20.appendTo(view.el.querySelector('.coucou_test'));await avatar30.appendTo(view.el.querySelector('.coucou_test'));assert.deepEqual([...view.el.querySelectorAll('.o_field_many2one_avatar span')].map(el=>el.innerText),["Mario","Luigi","Bowser"]);view.destroy();});QUnit.test('standalone_m2o_avatar_employee: Owl view',async function(assert){assert.expect(1);class Renderer extends AbstractRendererOwl{}
Renderer.template=xml`<div class='coucou_test'></div>`;const view=await createView({View:getOwlView(Renderer,"test"),data:this.data,model:"foo",arch:"<test/>"});const avatar10=new StandaloneM2OAvatarEmployee(view,10);const avatar20=new StandaloneM2OAvatarEmployee(view,20);const avatar30=new StandaloneM2OAvatarEmployee(view,[30,'Bowser']);await avatar10.appendTo(view.el.querySelector('.coucou_test'));await avatar20.appendTo(view.el.querySelector('.coucou_test'));await avatar30.appendTo(view.el.querySelector('.coucou_test'));assert.deepEqual([...view.el.querySelectorAll('.o_field_many2one_avatar span')].map(el=>el.innerText),["Mario","Luigi","Bowser"]);view.destroy();});});});;

/* /mail_bot/static/src/bugfix/bugfix_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail_bot/static/src/bugfix/bugfix_tests.js',function(require){'use strict';QUnit.module('mail_bot',{},function(){QUnit.module('bugfix',{},function(){QUnit.module('bugfix_tests.js',{});});});});;

/* /mail_bot/static/src/models/messaging_initializer/messaging_initializer_tests.js defined in bundle 'web.qunit_suite_tests' */
odoo.define('mail_bot/static/src/models/messaging_initializer/messaging_initializer_tests.js',function(require){"use strict";const{afterEach,beforeEach,start}=require('mail/static/src/utils/test_utils.js');QUnit.module('mail_bot',{},function(){QUnit.module('models',{},function(){QUnit.module('messaging_initializer',{},function(){QUnit.module('messaging_initializer_tests.js',{beforeEach(){beforeEach(this);this.start=async params=>{const{env,widget}=await start(Object.assign({},params,{data:this.data,}));this.env=env;this.widget=widget;};},afterEach(){afterEach(this);},});QUnit.test('OdooBot initialized at init',async function(assert){assert.expect(2);await this.start({env:{session:{odoobot_initialized:false,},},async mockRPC(route,args){if(args.method==='init_odoobot'){assert.step('init_odoobot');}
return this._super(...arguments);},});assert.verifySteps(['init_odoobot'],"should have initialized OdooBot at init");});});});});});